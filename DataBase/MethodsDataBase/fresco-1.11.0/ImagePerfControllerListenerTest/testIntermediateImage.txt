@Test public void testIntermediateImage(){
  final long startTime=10L;
  final long intermediateImageTime=123L;
  final long imageLoadTime=200L;
  final long imageReleaseTime=345L;
  int expectedNumOfTimestamps=0;
  when(mMonotonicClock.now()).thenReturn(startTime);
  mListener.onSubmit(CONTROLLER_ID,CALLER_CONTEXT);
  expectedNumOfTimestamps++;
  when(mImagePerfState.getImageLoadStatus()).thenReturn(ImageLoadStatus.REQUESTED);
  when(mMonotonicClock.now()).thenReturn(intermediateImageTime);
  mListener.onIntermediateImageSet(CONTROLLER_ID,null);
  expectedNumOfTimestamps++;
  when(mImagePerfState.getImageLoadStatus()).thenReturn(ImageLoadStatus.INTERMEDIATE_AVAILABLE);
  when(mMonotonicClock.now()).thenReturn(imageLoadTime);
  mListener.onFinalImageSet(CONTROLLER_ID,null,null);
  expectedNumOfTimestamps++;
  when(mImagePerfState.getImageLoadStatus()).thenReturn(ImageLoadStatus.SUCCESS);
  when(mMonotonicClock.now()).thenReturn(imageReleaseTime);
  mListener.onRelease(CONTROLLER_ID);
  expectedNumOfTimestamps++;
  verify(mMonotonicClock,times(expectedNumOfTimestamps)).now();
  verify(mImagePerfMonitor).notifyStatusUpdated(eq(mImagePerfState),eq(ImageLoadStatus.REQUESTED));
  verify(mImagePerfMonitor).notifyStatusUpdated(eq(mImagePerfState),eq(ImageLoadStatus.INTERMEDIATE_AVAILABLE));
  verify(mImagePerfMonitor).notifyStatusUpdated(eq(mImagePerfState),eq(ImageLoadStatus.SUCCESS));
  verify(mListener).reportViewVisible(anyLong());
  verify(mImagePerfMonitor).notifyListenersOfVisibilityStateUpdate(eq(mImagePerfState),eq(VisibilityState.VISIBLE));
  verify(mImagePerfMonitor).notifyListenersOfVisibilityStateUpdate(eq(mImagePerfState),eq(VisibilityState.INVISIBLE));
  verify(mImagePerfState).setControllerSubmitTimeMs(startTime);
  verify(mImagePerfState).setControllerIntermediateImageSetTimeMs(intermediateImageTime);
  verify(mImagePerfState).setControllerFinalImageSetTimeMs(imageLoadTime);
  verifyNoMoreInteractions(mImagePerfMonitor);
}
