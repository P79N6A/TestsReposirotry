@Test(timeout=5000) public void testDownloadHandler() throws Exception {
  long currentTime=86400l;
  when(SystemClock.uptimeMillis()).thenReturn(currentTime);
  NetworkFetcher.Callback callback=performFetch();
  when(mNetworkFetcher.shouldPropagate(any(FetchState.class))).thenReturn(true);
  final BlockingInputStream inputStream=new BlockingInputStream();
  final Future requestHandlerFuture=performResponse(inputStream,-1,callback);
  inputStream.waitUntilReadingThreadBlocked();
  verify(mPooledByteBufferFactory).newOutputStream();
  verify(mConsumer,never()).onNewResult(any(CloseableReference.class),anyInt());
  verifyPooledByteBufferUsed(0);
  inputStream.increaseBytesToRead(1024);
  inputStream.waitUntilReadingThreadBlocked();
  verify(mProducerListener,times(1)).onProducerEvent(mRequestId,NetworkFetchProducer.PRODUCER_NAME,NetworkFetchProducer.INTERMEDIATE_RESULT_PRODUCER_EVENT);
  verify(mConsumer,times(1)).onNewResult(any(CloseableReference.class),eq(Consumer.NO_FLAGS));
  verifyPooledByteBufferUsed(1);
  inputStream.increaseBytesToRead(1024);
  inputStream.waitUntilReadingThreadBlocked();
  verify(mProducerListener,times(1)).onProducerEvent(mRequestId,NetworkFetchProducer.PRODUCER_NAME,NetworkFetchProducer.INTERMEDIATE_RESULT_PRODUCER_EVENT);
  verify(mConsumer,times(1)).onNewResult(any(CloseableReference.class),eq(Consumer.NO_FLAGS));
  verifyPooledByteBufferUsed(1);
  currentTime+=NetworkFetchProducer.TIME_BETWEEN_PARTIAL_RESULTS_MS;
  when(SystemClock.uptimeMillis()).thenReturn(currentTime);
  inputStream.increaseBytesToRead(1024);
  inputStream.waitUntilReadingThreadBlocked();
  verify(mProducerListener,times(2)).onProducerEvent(mRequestId,NetworkFetchProducer.PRODUCER_NAME,NetworkFetchProducer.INTERMEDIATE_RESULT_PRODUCER_EVENT);
  verify(mConsumer,times(2)).onNewResult(any(CloseableReference.class),eq(Consumer.NO_FLAGS));
  verifyPooledByteBufferUsed(2);
  verify(mConsumer,times(0)).onNewResult(any(CloseableReference.class),eq(Consumer.IS_LAST));
  inputStream.signalEof();
  requestHandlerFuture.get();
  verify(mProducerListener,times(2)).onProducerEvent(mRequestId,NetworkFetchProducer.PRODUCER_NAME,NetworkFetchProducer.INTERMEDIATE_RESULT_PRODUCER_EVENT);
  verify(mProducerListener).onProducerFinishWithSuccess(eq(mRequestId),eq(NetworkFetchProducer.PRODUCER_NAME),eq(mExtrasMap));
  verify(mProducerListener).onUltimateProducerReached(mRequestId,NetworkFetchProducer.PRODUCER_NAME,true);
  verify(mConsumer,times(1)).onNewResult(any(CloseableReference.class),eq(Consumer.IS_LAST));
  verifyPooledByteBufferUsed(3);
  verify(mPooledByteBufferOutputStream).close();
}
