@Test public void testDecode_Failure() throws Exception {
  setupNetworkUri();
  produceResults();
  JobScheduler.JobRunnable jobRunnable=getJobRunnable();
  Exception exception=new RuntimeException();
  when(mImageDecoder.decode(mEncodedImage,IMAGE_SIZE,ImmutableQualityInfo.FULL_QUALITY,IMAGE_DECODE_OPTIONS)).thenThrow(exception);
  jobRunnable.run(mEncodedImage,Consumer.IS_LAST);
  InOrder inOrder=inOrder(mProducerListener,mImageDecoder);
  inOrder.verify(mProducerListener).onProducerStart(mRequestId,DecodeProducer.PRODUCER_NAME);
  inOrder.verify(mImageDecoder).decode(mEncodedImage,IMAGE_SIZE,ImmutableQualityInfo.FULL_QUALITY,IMAGE_DECODE_OPTIONS);
  inOrder.verify(mProducerListener).onProducerFinishWithFailure(eq(mRequestId),eq(DecodeProducer.PRODUCER_NAME),eq(exception),any(Map.class));
  verify(mProducerListener,never()).onUltimateProducerReached(anyString(),anyString(),anyBoolean());
}
