@Test public void shouldRemoveViaConcurrentIndexUpdatesWhilePopulating() throws Exception {
  String value1="Mattias";
  String value2="Jacob";
  String value3="Stefan";
  long node1=createNode(map(name,value1),FIRST);
  long node2=createNode(map(name,value2),FIRST);
  long node3=createNode(map(name,value3),FIRST);
  int propertyKeyId=getPropertyKeyForName(name);
  NodeDeletingWriter populator=new NodeDeletingWriter(node2,propertyKeyId,value2,labelId);
  IndexPopulationJob job=newIndexPopulationJob(populator,new FlippableIndexProxy(),EntityType.NODE,indexDescriptor(FIRST,name,false));
  populator.setJob(job);
  job.run();
  Map<Long,Object> expectedAdded=genericMap(node1,value1,node2,value2,node3,value3);
  assertEquals(expectedAdded,populator.added);
  Map<Long,Object> expectedRemoved=genericMap(node2,value2);
  assertEquals(expectedRemoved,populator.removed);
}
