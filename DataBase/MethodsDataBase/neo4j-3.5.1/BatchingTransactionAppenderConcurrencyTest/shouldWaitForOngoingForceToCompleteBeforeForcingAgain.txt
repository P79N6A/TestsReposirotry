@Test public void shouldWaitForOngoingForceToCompleteBeforeForcingAgain() throws Throwable {
  channelCommandQueue.put(ChannelCommand.dummy);
  final BatchingTransactionAppender appender=life.add(createTransactionAppender());
  life.start();
  Runnable runnable=createForceAfterAppendRunnable(appender);
  Future<?> future=executor.submit(runnable);
  forceSemaphore.acquire();
  Thread otherThread=fork(runnable);
  awaitThreadState(otherThread,MILLISECONDS_TO_WAIT,Thread.State.TIMED_WAITING);
  assertThat(channelCommandQueue.take(),is(ChannelCommand.dummy));
  assertThat(channelCommandQueue.take(),is(ChannelCommand.emptyBufferIntoChannelAndClearIt));
  assertThat(channelCommandQueue.take(),is(ChannelCommand.force));
  assertThat(channelCommandQueue.take(),is(ChannelCommand.emptyBufferIntoChannelAndClearIt));
  assertThat(channelCommandQueue.take(),is(ChannelCommand.force));
  future.get();
  otherThread.join();
  assertTrue(channelCommandQueue.isEmpty());
}
