@Test public void processNextBatchShouldReturnWhenConnectionIsStopped() throws Exception {
  BoltConnection connection=newConnection(1);
  connection.enqueue(Jobs.noop());
  connection.enqueue(Jobs.noop());
  when(stateMachine.shouldStickOnThread()).thenReturn(true);
  Future<Boolean> future=otherThread.execute(state -> connection.processNextBatch());
  connection.stop();
  otherThread.get().awaitFuture(future);
  verify(stateMachine).close();
}
