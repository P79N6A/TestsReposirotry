@Test public void processNextBatchShouldCloseConnectionAndLogOnUnexpectedException(){
  RuntimeException exception=new RuntimeException("unexpected exception");
  BoltConnection connection=newConnection();
  connection.enqueue(machine -> {
    throw exception;
  }
);
  connection.processNextBatch();
  verify(stateMachine).close();
  logProvider.assertExactly(AssertableLogProvider.inLog(containsString(BoltServer.class.getPackage().getName())).error(containsString("Unexpected error detected in bolt session"),is(exception)));
}
