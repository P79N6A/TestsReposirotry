@Test(timeout=TEST_TIMEOUT_MILLIS) public void testDeadlockDetection() throws InterruptedException {
  RagManager ragManager=new RagManager();
  LockResource node1=new LockResource(ResourceTypes.NODE,1L);
  LockResource node2=new LockResource(ResourceTypes.NODE,2L);
  LockResource node3=new LockResource(ResourceTypes.NODE,3L);
  final RWLock lockNode1=createRWLock(ragManager,node1);
  final RWLock lockNode2=createRWLock(ragManager,node2);
  final RWLock lockNode3=createRWLock(ragManager,node3);
  final LockTransaction client1Transaction=new LockTransaction();
  final LockTransaction client2Transaction=new LockTransaction();
  final LockTransaction client3Transaction=new LockTransaction();
  final CountDownLatch deadLockDetector=new CountDownLatch(1);
  lockNode1.mark();
  lockNode1.acquireWriteLock(LockTracer.NONE,client1Transaction);
  lockNode2.mark();
  lockNode2.acquireWriteLock(LockTracer.NONE,client2Transaction);
  lockNode3.mark();
  lockNode3.acquireWriteLock(LockTracer.NONE,client3Transaction);
  Runnable readerLockNode2=createReaderForDeadlock(lockNode3,client1Transaction,deadLockDetector);
  Runnable readerLockNode3=createReaderForDeadlock(lockNode1,client2Transaction,deadLockDetector);
  Runnable readerLockNode1=createReaderForDeadlock(lockNode2,client3Transaction,deadLockDetector);
  executor.execute(readerLockNode2);
  executor.execute(readerLockNode3);
  executor.execute(readerLockNode1);
  assertTrue("Deadlock was detected as expected.",deadLockDetector.await(TEST_TIMEOUT_MILLIS,TimeUnit.MILLISECONDS));
  lockNode3.releaseWriteLock(client3Transaction);
  lockNode2.releaseWriteLock(client2Transaction);
  lockNode1.releaseWriteLock(client1Transaction);
}
