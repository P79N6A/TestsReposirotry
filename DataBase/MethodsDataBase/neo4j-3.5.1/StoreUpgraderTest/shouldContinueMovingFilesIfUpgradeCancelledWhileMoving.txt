@Test public void shouldContinueMovingFilesIfUpgradeCancelledWhileMoving() throws Exception {
  PageCache pageCache=pageCacheRule.getPageCache(fileSystem);
  UpgradableDatabase upgradableDatabase=getUpgradableDatabase(pageCache);
  String versionToMigrateTo=upgradableDatabase.currentVersion();
  String versionToMigrateFrom=upgradableDatabase.checkUpgradable(databaseLayout).storeVersion();
{
    StoreUpgrader upgrader=newUpgrader(upgradableDatabase,allowMigrateConfig,pageCache);
    String failureMessage="Just failing";
    upgrader.addParticipant(participantThatWillFailWhenMoving(failureMessage));
    try {
      upgrader.migrateIfNeeded(databaseLayout);
      fail("should have thrown");
    }
 catch (    UnableToUpgradeException e) {
      assertTrue(e.getCause() instanceof IOException);
      assertEquals(failureMessage,e.getCause().getMessage());
    }
  }
{
    StoreUpgrader upgrader=newUpgrader(upgradableDatabase,pageCache);
    StoreMigrationParticipant observingParticipant=Mockito.mock(StoreMigrationParticipant.class);
    upgrader.addParticipant(observingParticipant);
    upgrader.migrateIfNeeded(databaseLayout);
    verify(observingParticipant,Mockito.never()).migrate(any(DatabaseLayout.class),any(DatabaseLayout.class),any(ProgressReporter.class),eq(versionToMigrateFrom),eq(versionToMigrateTo));
    verify(observingParticipant,Mockito.times(1)).moveMigratedFiles(any(DatabaseLayout.class),any(DatabaseLayout.class),eq(versionToMigrateFrom),eq(versionToMigrateTo));
    verify(observingParticipant,Mockito.times(1)).cleanup(any(DatabaseLayout.class));
  }
}
