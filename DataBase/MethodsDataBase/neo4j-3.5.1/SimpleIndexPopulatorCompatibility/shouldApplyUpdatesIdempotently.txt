@Test public void shouldApplyUpdatesIdempotently() throws Exception {
  IndexSamplingConfig indexSamplingConfig=new IndexSamplingConfig(Config.defaults());
  final Value propertyValue=Values.of("value1");
  withPopulator(indexProvider.getPopulator(descriptor,indexSamplingConfig),p -> {
    long nodeId=1;
    IndexEntryUpdate<SchemaDescriptor> update=add(nodeId,descriptor.schema(),propertyValue);
    p.add(singletonList(update));
    try (IndexUpdater updater=p.newPopulatingUpdater((node,propertyId) -> propertyValue)){
      updater.process(update);
    }
   }
);
  try (IndexAccessor accessor=indexProvider.getOnlineAccessor(descriptor,indexSamplingConfig)){
    try (IndexReader reader=new QueryResultComparingIndexReader(accessor.newReader())){
      int propertyKeyId=descriptor.schema().getPropertyId();
      LongIterator nodes=reader.query(IndexQuery.exact(propertyKeyId,propertyValue));
      assertEquals(asSet(1L),PrimitiveLongCollections.toSet(nodes));
    }
   }
 }
