@Test public void shouldHandleFailureDuringResultPublishing() throws Throwable {
  BoltStateMachine machine=env.newMachine(BOLT_CHANNEL);
  machine.process(new InitMessage(USER_AGENT,emptyMap()),nullResponseHandler());
  final CountDownLatch pullAllCallbackCalled=new CountDownLatch(1);
  final AtomicReference<Neo4jError> error=new AtomicReference<>();
  machine.process(new RunMessage("RETURN 1",EMPTY_PARAMS),nullResponseHandler());
  machine.process(PullAllMessage.INSTANCE,new BoltResponseHandler(){
    @Override public void onRecords(    BoltResult result,    boolean pull){
      throw new RuntimeException("Ooopsies!");
    }
    @Override public void onMetadata(    String key,    AnyValue value){
    }
    @Override public void markFailed(    Neo4jError err){
      error.set(err);
      pullAllCallbackCalled.countDown();
    }
    @Override public void markIgnored(){
    }
    @Override public void onFinish(){
    }
  }
);
  assertTrue(pullAllCallbackCalled.await(30,TimeUnit.SECONDS));
  final Neo4jError err=error.get();
  assertThat(err.status(),equalTo(Status.General.UnknownError));
  assertThat(err.message(),CoreMatchers.containsString("Ooopsies!"));
}
