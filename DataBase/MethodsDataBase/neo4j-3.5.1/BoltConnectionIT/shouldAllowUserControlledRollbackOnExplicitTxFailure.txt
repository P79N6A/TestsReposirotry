@Test public void shouldAllowUserControlledRollbackOnExplicitTxFailure() throws Throwable {
  BoltStateMachine machine=env.newMachine(BOLT_CHANNEL);
  machine.process(new InitMessage(USER_AGENT,emptyMap()),nullResponseHandler());
  machine.process(new RunMessage("BEGIN",EMPTY_PARAMS),nullResponseHandler());
  machine.process(DiscardAllMessage.INSTANCE,nullResponseHandler());
  machine.process(new RunMessage("CREATE (n:Victim)-[:REL]->()",EMPTY_PARAMS),nullResponseHandler());
  machine.process(DiscardAllMessage.INSTANCE,nullResponseHandler());
  BoltResponseRecorder recorder=new BoltResponseRecorder();
  machine.process(new RunMessage("this is not valid syntax",EMPTY_PARAMS),recorder);
  assertThat(recorder.nextResponse(),failedWithStatus(Status.Statement.SyntaxError));
  recorder.reset();
  machine.process(AckFailureMessage.INSTANCE,recorder);
  machine.process(new RunMessage("ROLLBACK",EMPTY_PARAMS),recorder);
  assertThat(recorder.nextResponse(),succeeded());
  assertThat(recorder.nextResponse(),succeeded());
}
