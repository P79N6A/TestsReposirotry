@Test public void shouldCloseAutoCommitTransactionAndRespondToNextStatementWhenStreamingFails() throws Throwable {
  final BoltStateMachine machine=env.newMachine(BOLT_CHANNEL);
  machine.process(new InitMessage(USER_AGENT,emptyMap()),nullResponseHandler());
  BoltResponseRecorder recorder=new BoltResponseRecorder();
  machine.process(new RunMessage("UNWIND [1, 0] AS x RETURN 1 / x",EMPTY_MAP),recorder);
  machine.process(PullAllMessage.INSTANCE,recorder);
  machine.process(AckFailureMessage.INSTANCE,recorder);
  machine.process(new RunMessage("RETURN 2",EMPTY_MAP),recorder);
  machine.process(PullAllMessage.INSTANCE,recorder);
  assertThat(recorder.nextResponse(),succeeded());
  assertThat(recorder.nextResponse(),allOf(containsRecord(1L),failedWithStatus(Status.Statement.ArithmeticError)));
  assertThat(recorder.nextResponse(),succeeded());
  assertThat(recorder.nextResponse(),succeeded());
  assertThat(recorder.nextResponse(),succeededWithRecord(2L));
  assertEquals(0,recorder.responseCount());
}
