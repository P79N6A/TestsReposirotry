@Test public void begin_and_execute_periodic_commit_and_commit() throws Exception {
  int nodes=11;
  int batch=2;
  ServerTestUtils.withCSVFile(nodes,url -> {
    Response response;
    long nodesInDatabaseBeforeTransaction;
    long txIdBefore;
    int times=0;
    do {
      nodesInDatabaseBeforeTransaction=countNodes();
      txIdBefore=resolveDependency(TransactionIdStore.class).getLastClosedTransactionId();
      response=http.POST("db/data/transaction/commit",quotedJson("{ 'statements': [ { 'statement': 'USING PERIODIC COMMIT " + batch + " LOAD CSV FROM "+ "\\\""+ url+ "\\\" AS line CREATE ()' } ] }"));
      times++;
    }
 while (response.get("errors").iterator().hasNext() && (times < 5));
    long txIdAfter=resolveDependency(TransactionIdStore.class).getLastClosedTransactionId();
    assertThat("Last response is: " + response,response,containsNoErrors());
    assertThat(response.status(),equalTo(200));
    assertThat(countNodes(),equalTo(nodesInDatabaseBeforeTransaction + nodes));
    assertThat(txIdAfter,equalTo(txIdBefore + ((nodes / batch) + 1)));
  }
);
}
