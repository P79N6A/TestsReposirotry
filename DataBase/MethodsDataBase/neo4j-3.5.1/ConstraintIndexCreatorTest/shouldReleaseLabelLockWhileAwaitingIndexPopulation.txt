@Test public void shouldReleaseLabelLockWhileAwaitingIndexPopulation() throws Exception {
  StubKernel kernel=new StubKernel();
  IndexingService indexingService=mock(IndexingService.class);
  NodePropertyAccessor nodePropertyAccessor=mock(NodePropertyAccessor.class);
  when(schemaRead.indexGetCommittedId(indexReference)).thenReturn(INDEX_ID);
  IndexProxy indexProxy=mock(IndexProxy.class);
  when(indexingService.getIndexProxy(anyLong())).thenReturn(indexProxy);
  when(indexingService.getIndexProxy(descriptor)).thenReturn(indexProxy);
  when(schemaRead.index(LABEL_ID,PROPERTY_KEY_ID)).thenReturn(IndexReference.NO_INDEX);
  ConstraintIndexCreator creator=new ConstraintIndexCreator(() -> kernel,indexingService,nodePropertyAccessor,logProvider);
  KernelTransactionImplementation transaction=createTransaction();
  creator.createUniquenessConstraintIndex(transaction,descriptor,getDefaultProvider());
  verify(transaction.statementLocks().pessimistic()).releaseExclusive(ResourceTypes.LABEL,descriptor.getLabelId());
  verify(transaction.statementLocks().pessimistic()).acquireExclusive(transaction.lockTracer(),ResourceTypes.LABEL,descriptor.getLabelId());
}
