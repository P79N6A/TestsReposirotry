@Test public void correctLastAppliedToPreviousLogTransactionInHeaderOnLogFileRotation() throws IOException {
  LogFiles logFiles=getLogFiles(logVersionRepository,transactionIdStore);
  life.add(logFiles);
  DatabaseHealth databaseHealth=getDatabaseHealth();
  LogRotationImpl logRotation=new LogRotationImpl(monitors.newMonitor(LogRotation.Monitor.class),logFiles,databaseHealth);
  TransactionMetadataCache transactionMetadataCache=new TransactionMetadataCache();
  SynchronizedArrayIdOrderingQueue idOrderingQueue=new SynchronizedArrayIdOrderingQueue();
  BatchingTransactionAppender transactionAppender=new BatchingTransactionAppender(logFiles,logRotation,transactionMetadataCache,transactionIdStore,idOrderingQueue,databaseHealth);
  life.add(transactionAppender);
  LogAppendEvent logAppendEvent=new RotationLogAppendEvent(logRotation);
  TransactionToApply transactionToApply=prepareTransaction();
  transactionAppender.append(transactionToApply,logAppendEvent);
  assertEquals(1,logFiles.getHighestLogVersion());
  File highestLogFile=logFiles.getHighestLogFile();
  LogHeader logHeader=LogHeaderReader.readLogHeader(fileSystem,highestLogFile);
  assertEquals(2,logHeader.lastCommittedTxId);
}
