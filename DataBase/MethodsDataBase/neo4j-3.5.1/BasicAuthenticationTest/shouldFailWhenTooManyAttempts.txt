@Test public void shouldFailWhenTooManyAttempts() throws Exception {
  int maxFailedAttempts=ThreadLocalRandom.current().nextInt(1,10);
  Authentication auth=createAuthentication(maxFailedAttempts);
  for (int i=0; i < maxFailedAttempts; ++i) {
    try {
      auth.authenticate(map("scheme","basic","principal","bob","credentials",UTF8.encode("gelato")));
    }
 catch (    AuthenticationException e) {
      assertThat(e.status(),equalTo(Status.Security.Unauthorized));
    }
  }
  exception.expect(AuthenticationException.class);
  exception.expect(hasStatus(Status.Security.AuthenticationRateLimit));
  exception.expectMessage("The client has provided incorrect authentication details too many times in a row.");
  auth.authenticate(map("scheme","basic","principal","bob","credentials",UTF8.encode("gelato")));
}
