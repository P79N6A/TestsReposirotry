@Test public void incrementAndGetVersionMustBeAtomic() throws Throwable {
  try (MetaDataStore store=newMetaDataStore()){
    long initialVersion=store.incrementAndGetVersion();
    int threads=Runtime.getRuntime().availableProcessors();
    int iterations=500;
    Race race=new Race();
    race.addContestants(threads,() -> {
      for (int i=0; i < iterations; i++) {
        store.incrementAndGetVersion();
      }
    }
);
    race.go();
    assertThat(store.incrementAndGetVersion(),is(initialVersion + (threads * iterations) + 1));
  }
 }
