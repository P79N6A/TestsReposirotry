@Test public void shutdownWhileFinishingTransactionWithIndexUpdates(){
  createConstraint(database);
  waitIndexesOnline(database);
  try (Transaction transaction=database.beginTx()){
    Node node=database.createNode(constraintIndexLabel);
    node.setProperty(UNIQUE_PROPERTY_NAME,indexProvider.getAndIncrement());
    DependencyResolver dependencyResolver=database.getDependencyResolver();
    NeoStoreDataSource dataSource=dependencyResolver.resolveDependency(NeoStoreDataSource.class);
    LifeSupport dataSourceLife=dataSource.getLife();
    TransactionCloseListener closeListener=new TransactionCloseListener(transaction);
    dataSourceLife.addLifecycleListener(closeListener);
    dataSource.stop();
    assertTrue("Transaction should be closed and no exception should be thrown.",closeListener.isTransactionClosed());
  }
 }
