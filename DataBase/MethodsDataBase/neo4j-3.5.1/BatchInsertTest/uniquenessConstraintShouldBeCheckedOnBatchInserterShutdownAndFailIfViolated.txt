@Test public void uniquenessConstraintShouldBeCheckedOnBatchInserterShutdownAndFailIfViolated() throws Exception {
  Label label=label("Foo");
  String property="Bar";
  String value="Baz";
  BatchInserter inserter=newBatchInserter();
  inserter.createDeferredConstraint(label).assertPropertyIsUnique(property).create();
  inserter.createNode(Collections.singletonMap(property,value),label);
  inserter.createNode(Collections.singletonMap(property,value),label);
  GraphDatabaseService db=switchToEmbeddedGraphDatabaseService(inserter);
  try (Transaction tx=db.beginTx()){
    IndexDefinition index=db.schema().getIndexes(label).iterator().next();
    String indexFailure=db.schema().getIndexFailure(index);
    assertThat(indexFailure,containsString("IndexEntryConflictException"));
    assertThat(indexFailure,containsString(value));
    tx.success();
  }
  finally {
    db.shutdown();
  }
}
