/** 
 * Test checks that during node property set we will cleanup not used property records During initial node creation properties will occupy 5 property records. Last property record will have only empty array for email. During first update email property will be migrated to dynamic property and last property record will become empty. That record should be deleted form property chain or otherwise on next node load user will get an property record not in use exception.
 */
@Test public void testCleanupEmptyPropertyRecords() throws Exception {
  BatchInserter inserter=globalInserter;
  Map<String,Object> properties=new HashMap<>();
  properties.put("id",1099511659993L);
  properties.put("firstName","Edward");
  properties.put("lastName","Shevchenko");
  properties.put("gender","male");
  properties.put("birthday",new SimpleDateFormat("yyyy-MM-dd").parse("1987-11-08").getTime());
  properties.put("birthday_month",11);
  properties.put("birthday_day",8);
  long time=new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss.SSSZ").parse("2010-04-22T18:05:40.912+0000").getTime();
  properties.put("creationDate",time);
  properties.put("locationIP","46.151.255.205");
  properties.put("browserUsed","Firefox");
  properties.put("email",new String[0]);
  properties.put("languages",new String[0]);
  long personNodeId=inserter.createNode(properties);
  assertEquals("Shevchenko",getNodeProperties(inserter,personNodeId).get("lastName"));
  assertThat((String[])getNodeProperties(inserter,personNodeId).get("email"),is(emptyArray()));
  inserter.setNodeProperty(personNodeId,"email",new String[]{"Edward1099511659993@gmail.com"});
  assertThat((String[])getNodeProperties(inserter,personNodeId).get("email"),arrayContaining("Edward1099511659993@gmail.com"));
  inserter.setNodeProperty(personNodeId,"email",new String[]{"Edward1099511659993@gmail.com","backup@gmail.com"});
  assertThat((String[])getNodeProperties(inserter,personNodeId).get("email"),arrayContaining("Edward1099511659993@gmail.com","backup@gmail.com"));
}
