@Test public void shouldInvokeResponseHandlerOnNextAckFailureMessageOnMarkFailedIfAlreadyFailedAndNoHandler() throws Exception {
  BoltStateMachine machine=newMachine();
  machine.markFailed(Neo4jError.from(new RuntimeException()));
  BoltResponseHandler responseHandler=mock(BoltResponseHandler.class);
  Neo4jError error=Neo4jError.from(Status.Request.NoThreadsAvailable,"no threads");
  machine.markFailed(error);
  machine.process(AckFailureMessage.INSTANCE,responseHandler);
  assertNull(pendingError(machine));
  assertFalse(pendingIgnore(machine));
  assertThat(machine,inState(ReadyState.class));
  verify(responseHandler,never()).markIgnored();
  verify(responseHandler,never()).markFailed(any());
}
