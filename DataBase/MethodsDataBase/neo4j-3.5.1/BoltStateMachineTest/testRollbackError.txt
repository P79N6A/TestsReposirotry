@Test public void testRollbackError() throws Throwable {
  BoltStateMachine machine=init(newMachine());
  machine.process(new RunMessage("BEGIN",EMPTY_PARAMS),nullResponseHandler());
  machine.process(DiscardAllMessage.INSTANCE,nullResponseHandler());
  TransactionStateMachine txMachine=txStateMachine(machine);
  when(txMachine.ctx.currentTransaction.isOpen()).thenReturn(true);
  doThrow(new TransactionFailureException("No Mr. Bond, I expect you to die.")).when(txMachine.ctx.currentTransaction).close();
  machine.process(new RunMessage("ROLLBACK",EMPTY_PARAMS),nullResponseHandler());
  machine.process(DiscardAllMessage.INSTANCE,nullResponseHandler());
  assertThat(machine,inState(FailedState.class));
}
