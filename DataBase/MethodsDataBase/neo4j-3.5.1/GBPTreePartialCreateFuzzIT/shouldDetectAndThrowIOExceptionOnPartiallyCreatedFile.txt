@Test public void shouldDetectAndThrowIOExceptionOnPartiallyCreatedFile() throws Exception {
  File file=storage.directory().file("index");
  Process process=new ProcessBuilder(asList("java","-cp",System.getProperty("java.class.path"),getClass().getName(),file.getAbsolutePath())).redirectError(INHERIT).redirectOutput(INHERIT).start();
  Thread.sleep(ThreadLocalRandom.current().nextInt(1_000));
  int exitCode=process.destroyForcibly().waitFor();
  try (PageCache pageCache=storage.pageCache()){
    SimpleLongLayout layout=longLayout().build();
    try {
      GBPTree.readHeader(pageCache,file,NO_HEADER_READER);
    }
 catch (    MetadataMismatchException|IOException e) {
      assertNotEquals(0,exitCode);
    }
    try {
      new GBPTreeBuilder<>(pageCache,file,layout).build().close();
    }
 catch (    MetadataMismatchException|IOException e) {
      assertNotEquals(0,exitCode);
    }
  }
 }
