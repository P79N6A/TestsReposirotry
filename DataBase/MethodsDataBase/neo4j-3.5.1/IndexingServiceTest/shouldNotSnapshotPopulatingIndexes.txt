@Test public void shouldNotSnapshotPopulatingIndexes() throws Exception {
  CountDownLatch populatorLatch=new CountDownLatch(1);
  IndexAccessor indexAccessor=mock(IndexAccessor.class);
  int indexId=1;
  int indexId2=2;
  StoreIndexDescriptor rule1=storeIndex(indexId,2,3,PROVIDER_DESCRIPTOR);
  StoreIndexDescriptor rule2=storeIndex(indexId2,4,5,PROVIDER_DESCRIPTOR);
  IndexingService indexing=newIndexingServiceWithMockedDependencies(populator,indexAccessor,new DataUpdates(),rule1,rule2);
  File theFile=new File("Blah");
  doAnswer(waitForLatch(populatorLatch)).when(populator).create();
  when(indexAccessor.snapshotFiles()).thenAnswer(newResourceIterator(theFile));
  when(indexProvider.getInitialState(rule1)).thenReturn(POPULATING);
  when(indexProvider.getInitialState(rule2)).thenReturn(ONLINE);
  when(storeView.indexSample(anyLong(),any(DoubleLongRegister.class))).thenReturn(newDoubleLongRegister(32L,32L));
  life.start();
  ResourceIterator<File> files=indexing.snapshotIndexFiles();
  populatorLatch.countDown();
  waitForIndexesToComeOnline(indexing,indexId,indexId2);
  assertThat(asCollection(files),equalTo(asCollection(iterator(theFile))));
}
