@Test public void shouldWaitForRecoveredUniquenessConstraintIndexesToBeFullyPopulated() throws Exception {
  final DoubleLatch latch=new DoubleLatch();
  ControlledIndexPopulator populator=new ControlledIndexPopulator(latch);
  final AtomicLong indexId=new AtomicLong(-1);
  IndexingService.Monitor monitor=new IndexingService.MonitorAdapter(){
    @Override public void awaitingPopulationOfRecoveredIndex(    StoreIndexDescriptor descriptor){
      indexId.set(descriptor.getId());
      latch.startAndWaitForAllToStart();
    }
  }
;
  IndexingService indexing=newIndexingServiceWithMockedDependencies(populator,accessor,withData(addNodeUpdate(0,"value",1)),monitor);
  life.init();
  long fakeOwningConstraintRuleId=1;
  indexing.createIndexes(constraintIndexRule(2,labelId,propertyKeyId,PROVIDER_DESCRIPTOR,fakeOwningConstraintRuleId));
  life.start();
  assertEquals(2,indexId.get());
  assertEquals(ONLINE,indexing.getIndexProxy(indexId.get()).getState());
}
