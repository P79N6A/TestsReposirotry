@Test public void shouldStoreIndexFailureWhenFailingToCreateOnlineAccessorAfterRecoveringPopulatingIndex() throws Exception {
  long indexId=1;
  StoreIndexDescriptor indexRule=index.withId(indexId);
  IndexingService indexing=newIndexingServiceWithMockedDependencies(populator,accessor,withData(),indexRule);
  IOException exception=new IOException("Expected failure");
  when(nameLookup.labelGetName(labelId)).thenReturn("TheLabel");
  when(nameLookup.propertyKeyGetName(propertyKeyId)).thenReturn("propertyKey");
  when(indexProvider.getInitialState(indexRule)).thenReturn(POPULATING);
  when(indexProvider.getOnlineAccessor(any(StoreIndexDescriptor.class),any(IndexSamplingConfig.class))).thenThrow(exception);
  life.start();
  ArgumentCaptor<Boolean> closeArgs=ArgumentCaptor.forClass(Boolean.class);
  waitForIndexesToGetIntoState(indexing,InternalIndexState.FAILED,indexId);
  verify(populator,timeout(10000).times(2)).close(closeArgs.capture());
  assertEquals(FAILED,indexing.getIndexProxy(1).getState());
  assertEquals(asList(true,false),closeArgs.getAllValues());
  assertThat(storedFailure(),containsString(format("java.io.IOException: Expected failure%n\tat ")));
  internalLogProvider.assertAtLeastOnce(inLog(IndexPopulationJob.class).error(equalTo("Failed to populate index: [:TheLabel(propertyKey) [provider: {key=quantum-dex, version=25.0}]]"),causedBy(exception)));
  internalLogProvider.assertNone(inLog(IndexPopulationJob.class).info("Index population completed. Index is now online: [%s]",":TheLabel(propertyKey) [provider: {key=quantum-dex, version=25.0}]"));
}
