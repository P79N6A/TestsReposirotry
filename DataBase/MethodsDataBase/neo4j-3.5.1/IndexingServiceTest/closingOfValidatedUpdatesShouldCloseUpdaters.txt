@Test public void closingOfValidatedUpdatesShouldCloseUpdaters() throws Exception {
  long indexId1=1;
  long indexId2=2;
  int labelId1=24;
  int labelId2=42;
  StoreIndexDescriptor index1=storeIndex(indexId1,labelId1,propertyKeyId,PROVIDER_DESCRIPTOR);
  StoreIndexDescriptor index2=storeIndex(indexId2,labelId2,propertyKeyId,PROVIDER_DESCRIPTOR);
  IndexingService indexing=newIndexingServiceWithMockedDependencies(populator,accessor,withData());
  IndexAccessor accessor1=mock(IndexAccessor.class);
  IndexUpdater updater1=mock(IndexUpdater.class);
  when(accessor1.newUpdater(any(IndexUpdateMode.class))).thenReturn(updater1);
  IndexAccessor accessor2=mock(IndexAccessor.class);
  IndexUpdater updater2=mock(IndexUpdater.class);
  when(accessor2.newUpdater(any(IndexUpdateMode.class))).thenReturn(updater2);
  when(indexProvider.getOnlineAccessor(eq(index1),any(IndexSamplingConfig.class))).thenReturn(accessor1);
  when(indexProvider.getOnlineAccessor(eq(index2),any(IndexSamplingConfig.class))).thenReturn(accessor2);
  life.start();
  indexing.createIndexes(index1);
  indexing.createIndexes(index2);
  waitForIndexesToComeOnline(indexing,indexId1,indexId2);
  verify(populator,timeout(10000).times(2)).close(true);
  indexing.apply(updates(asList(add(1,"foo",labelId1),add(2,"bar",labelId2))));
  verify(updater1).close();
  verify(updater2).close();
}
