@Test public void shouldThrowAnExceptionIfTheIndexHasFailed() throws SchemaRuleNotFoundException, IndexNotFoundKernelException {
  when(tokenRead.nodeLabel(anyString())).thenReturn(0);
  when(tokenRead.propertyKey(anyString())).thenReturn(0);
  when(schemaRead.index(anyInt(),any())).thenReturn(anyIndex);
  when(schemaRead.indexGetState(any(IndexReference.class))).thenReturn(FAILED);
  when(schemaRead.indexGetFailure(any(IndexReference.class))).thenReturn(Exceptions.stringify(new Exception("Kilroy was here")));
  try {
    procedure.awaitIndex(":Person(name)",TIMEOUT,TIME_UNIT);
    fail("Expected an exception");
  }
 catch (  ProcedureException e) {
    assertThat(e.status(),is(Status.Schema.IndexCreationFailed));
    assertThat(e.getMessage(),containsString("Kilroy was here"));
  }
}
