@Test public void shouldGetSpecifiedUsernameAndMetaDataInTXData(){
  final AtomicReference<String> usernameRef=new AtomicReference<>();
  final AtomicReference<Map<String,Object>> metaDataRef=new AtomicReference<>();
  db.registerTransactionEventHandler(getBeforeCommitHandler(txData -> {
    usernameRef.set(txData.username());
    metaDataRef.set(txData.metaData());
  }
));
  AuthSubject subject=mock(AuthSubject.class);
  when(subject.username()).thenReturn("Christof");
  LoginContext loginContext=new LoginContext(){
    @Override public AuthSubject subject(){
      return subject;
    }
    @Override public SecurityContext authorize(    ToIntFunction<String> propertyIdLookup,    String dbName){
      return new SecurityContext(subject,AccessMode.Static.WRITE);
    }
  }
;
  Map<String,Object> metadata=genericMap("username","joe");
  runTransaction(loginContext,metadata);
  assertThat("Should have specified username",usernameRef.get(),equalTo("Christof"));
  assertThat("Should have metadata with specified username",metaDataRef.get(),equalTo(metadata));
}
