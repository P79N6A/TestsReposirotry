@Test public void shouldSeeAddedPropertyFromExistingNodeWithPropertiesInTransaction() throws Exception {
  long nodeId;
  String propKey1="prop1";
  String propKey2="prop2";
  int propToken1;
  int propToken2;
  try (Transaction tx=beginTransaction()){
    nodeId=tx.dataWrite().nodeCreate();
    propToken1=tx.token().propertyKeyGetOrCreateForName(propKey1);
    assertEquals(tx.dataWrite().nodeSetProperty(nodeId,propToken1,stringValue("hello")),NO_VALUE);
    tx.success();
  }
   try (Transaction tx=beginTransaction()){
    propToken2=tx.token().propertyKeyGetOrCreateForName(propKey2);
    assertEquals(tx.dataWrite().nodeSetProperty(nodeId,propToken2,stringValue("world")),NO_VALUE);
    try (NodeCursor node=tx.cursors().allocateNodeCursor();PropertyCursor property=tx.cursors().allocatePropertyCursor()){
      tx.dataRead().singleNode(nodeId,node);
      assertTrue("should access node",node.next());
      node.properties(property);
      assertTrue(property.next());
      assertEquals(propToken2,property.propertyKey());
      assertEquals(property.propertyValue(),stringValue("world"));
      assertTrue(property.next());
      assertEquals(propToken1,property.propertyKey());
      assertEquals(property.propertyValue(),stringValue("hello"));
      assertFalse("should only find two properties",property.next());
      assertFalse("should only find one node",node.next());
    }
     tx.success();
  }
   try (org.neo4j.graphdb.Transaction ignored=graphDb.beginTx()){
    assertThat(graphDb.getNodeById(nodeId).getProperty(propKey1),equalTo("hello"));
    assertThat(graphDb.getNodeById(nodeId).getProperty(propKey2),equalTo("world"));
  }
 }
