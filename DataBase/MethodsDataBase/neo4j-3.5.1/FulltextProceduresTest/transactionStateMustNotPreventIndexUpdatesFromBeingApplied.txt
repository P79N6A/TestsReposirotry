@Test public void transactionStateMustNotPreventIndexUpdatesFromBeingApplied() throws Exception {
  db=createDatabase();
  try (Transaction tx=db.beginTx()){
    createSimpleNodesIndex();
    createSimpleRelationshipIndex();
    tx.success();
  }
   awaitIndexesOnline();
  try (Transaction tx=db.beginTx()){
    Node node=db.createNode(LABEL);
    node.setProperty(PROP,"value");
    Relationship rel=node.createRelationshipTo(node,REL);
    rel.setProperty(PROP,"value");
    LongHashSet nodeIds=new LongHashSet();
    LongHashSet relIds=new LongHashSet();
    nodeIds.add(node.getId());
    relIds.add(rel.getId());
    ExecutorService executor=cleanup.add(Executors.newSingleThreadExecutor());
    executor.submit(() -> {
      try (Transaction forkedTx=db.beginTx()){
        Node node2=db.createNode(LABEL);
        node2.setProperty(PROP,"value");
        Relationship rel2=node2.createRelationshipTo(node2,REL);
        rel2.setProperty(PROP,"value");
        nodeIds.add(node2.getId());
        relIds.add(rel2.getId());
        forkedTx.success();
      }
     }
).get();
    assertQueryFindsIds(db,true,"nodes","value",nodeIds);
    assertQueryFindsIds(db,false,"rels","value",relIds);
    tx.success();
  }
 }
