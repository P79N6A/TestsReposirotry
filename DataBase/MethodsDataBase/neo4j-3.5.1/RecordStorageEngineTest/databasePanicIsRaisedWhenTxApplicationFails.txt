@Test public void databasePanicIsRaisedWhenTxApplicationFails() throws Throwable {
  RecordStorageEngine engine=buildRecordStorageEngine();
  Exception applicationError=executeFailingTransaction(engine);
  ArgumentCaptor<Exception> captor=ArgumentCaptor.forClass(Exception.class);
  verify(databaseHealth).panic(captor.capture());
  Throwable exception=captor.getValue();
  if (exception instanceof KernelException) {
    assertThat(((KernelException)exception).status(),is(Status.General.UnknownError));
    exception=exception.getCause();
  }
  assertThat(exception,is(applicationError));
}
