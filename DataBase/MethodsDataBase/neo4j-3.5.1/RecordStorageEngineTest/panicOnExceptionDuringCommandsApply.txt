@Test public void panicOnExceptionDuringCommandsApply(){
  IllegalStateException failure=new IllegalStateException("Too many open files");
  RecordStorageEngine engine=storageEngineRule.getWith(fsRule.get(),pageCacheRule.getPageCache(fsRule.get()),testDirectory.databaseLayout()).databaseHealth(databaseHealth).transactionApplierTransformer(facade -> transactionApplierFacadeTransformer(facade,failure)).build();
  CommandsToApply commandsToApply=mock(CommandsToApply.class);
  try {
    engine.apply(commandsToApply,TransactionApplicationMode.INTERNAL);
    fail("Exception expected");
  }
 catch (  Exception exception) {
    assertSame(failure,Exceptions.rootCause(exception));
  }
  verify(databaseHealth).panic(any(Throwable.class));
}
