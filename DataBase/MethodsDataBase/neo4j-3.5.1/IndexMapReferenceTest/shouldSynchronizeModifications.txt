@Test public void shouldSynchronizeModifications() throws Throwable {
  IndexMapReference ref=new IndexMapReference();
  IndexProxy[] existing=mockedIndexProxies(5,0);
  ref.modify(indexMap -> {
    for (int i=0; i < existing.length; i++) {
      indexMap.putIndexProxy(existing[i]);
    }
    return indexMap;
  }
);
  Race race=new Race();
  for (int i=0; i < existing.length; i++) {
    race.addContestant(removeIndexProxy(ref,i),1);
  }
  IndexProxy[] created=mockedIndexProxies(3,existing.length);
  for (int i=0; i < existing.length; i++) {
    race.addContestant(putIndexProxy(ref,created[i]),1);
  }
  race.go();
  for (int i=0; i < existing.length; i++) {
    assertNull(ref.getIndexProxy(i));
  }
  for (int i=0; i < created.length; i++) {
    assertSame(created[i],ref.getIndexProxy(existing.length + i));
  }
}
