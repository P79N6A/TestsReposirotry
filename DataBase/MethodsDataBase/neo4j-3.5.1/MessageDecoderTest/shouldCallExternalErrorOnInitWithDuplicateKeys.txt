@Test public void shouldCallExternalErrorOnInitWithDuplicateKeys() throws Exception {
  BoltStateMachine stateMachine=mock(BoltStateMachine.class);
  SynchronousBoltConnection connection=new SynchronousBoltConnection(stateMachine);
  channel=new EmbeddedChannel(newDecoder(connection));
  PackedOutputArray out=new PackedOutputArray();
  Neo4jPack.Packer packer=packerUnderTest.newPacker(out);
  packer.packStructHeader(2,InitMessage.SIGNATURE);
  packer.pack("Test/User Agent 1.0");
  packer.packMapHeader(3);
  packer.pack("scheme");
  packer.pack("basic");
  packer.pack("principal");
  packer.pack("user");
  packer.pack("scheme");
  packer.pack("password");
  channel.writeInbound(Unpooled.wrappedBuffer(out.bytes()));
  channel.finishAndReleaseAll();
  verify(stateMachine).handleExternalFailure(eq(Neo4jError.from(Status.Request.Invalid,"Duplicate map key `scheme`.")),any());
}
