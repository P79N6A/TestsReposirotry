@Test public void shouldBeAbleToRecoverInTheMiddleOfPopulatingAnIndex() throws Exception {
  startDb();
  CountDownLatch latch=new CountDownLatch(1);
  when(mockedIndexProvider.getPopulator(any(StoreIndexDescriptor.class),any(IndexSamplingConfig.class))).thenReturn(indexPopulatorWithControlledCompletionTiming(latch));
  createIndex(myLabel);
  Future<Void> killFuture=killDbInSeparateThread();
  latch.countDown();
  killFuture.get();
  when(mockedIndexProvider.getInitialState(any(StoreIndexDescriptor.class))).thenReturn(InternalIndexState.POPULATING);
  latch=new CountDownLatch(1);
  when(mockedIndexProvider.getPopulator(any(StoreIndexDescriptor.class),any(IndexSamplingConfig.class))).thenReturn(indexPopulatorWithControlledCompletionTiming(latch));
  startDb();
  assertThat(getIndexes(db,myLabel),inTx(db,hasSize(1)));
  assertThat(getIndexes(db,myLabel),inTx(db,haveState(db,Schema.IndexState.POPULATING)));
  verify(mockedIndexProvider,times(2)).getPopulator(any(StoreIndexDescriptor.class),any(IndexSamplingConfig.class));
  verify(mockedIndexProvider,never()).getOnlineAccessor(any(StoreIndexDescriptor.class),any(IndexSamplingConfig.class));
  latch.countDown();
}
