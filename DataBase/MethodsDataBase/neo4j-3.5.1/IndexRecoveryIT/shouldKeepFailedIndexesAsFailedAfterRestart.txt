@Test public void shouldKeepFailedIndexesAsFailedAfterRestart() throws Exception {
  IndexPopulator indexPopulator=mock(IndexPopulator.class);
  when(mockedIndexProvider.getPopulator(any(StoreIndexDescriptor.class),any(IndexSamplingConfig.class))).thenReturn(indexPopulator);
  IndexAccessor indexAccessor=mock(IndexAccessor.class);
  when(mockedIndexProvider.getOnlineAccessor(any(StoreIndexDescriptor.class),any(IndexSamplingConfig.class))).thenReturn(indexAccessor);
  startDb();
  createIndex(myLabel);
  rotateLogsAndCheckPoint();
  killDb();
  when(mockedIndexProvider.getInitialState(any(StoreIndexDescriptor.class))).thenReturn(InternalIndexState.FAILED);
  startDb();
  assertThat(getIndexes(db,myLabel),inTx(db,hasSize(1)));
  assertThat(getIndexes(db,myLabel),inTx(db,haveState(db,Schema.IndexState.FAILED)));
  verify(mockedIndexProvider,times(2)).getPopulator(any(StoreIndexDescriptor.class),any(IndexSamplingConfig.class));
}
