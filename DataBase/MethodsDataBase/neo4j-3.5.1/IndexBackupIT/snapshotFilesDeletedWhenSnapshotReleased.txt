@Test public void snapshotFilesDeletedWhenSnapshotReleased() throws IOException {
  Label label=Label.label("testLabel");
  prepareDatabase(label);
  ResourceIterator<File> firstCheckpointSnapshot=indexingService.snapshotIndexFiles();
  generateData(label);
  ResourceIterator<File> secondCheckpointSnapshot=indexingService.snapshotIndexFiles();
  generateData(label);
  ResourceIterator<File> thirdCheckpointSnapshot=indexingService.snapshotIndexFiles();
  Set<String> firstSnapshotFileNames=getFileNames(firstCheckpointSnapshot);
  Set<String> secondSnapshotFileNames=getFileNames(secondCheckpointSnapshot);
  Set<String> thirdSnapshotFileNames=getFileNames(thirdCheckpointSnapshot);
  generateData(label);
  forceCheckpoint(checkPointer);
  assertTrue(firstSnapshotFileNames.stream().map(File::new).allMatch(fileSystem::fileExists));
  assertTrue(secondSnapshotFileNames.stream().map(File::new).allMatch(fileSystem::fileExists));
  assertTrue(thirdSnapshotFileNames.stream().map(File::new).allMatch(fileSystem::fileExists));
  firstCheckpointSnapshot.close();
  secondCheckpointSnapshot.close();
  thirdCheckpointSnapshot.close();
  generateData(label);
  forceCheckpoint(checkPointer);
  assertFalse(firstSnapshotFileNames.stream().map(File::new).anyMatch(fileSystem::fileExists));
  assertFalse(secondSnapshotFileNames.stream().map(File::new).anyMatch(fileSystem::fileExists));
  assertFalse(thirdSnapshotFileNames.stream().map(File::new).anyMatch(fileSystem::fileExists));
}
