@Test @Resources.Life(STARTED) public void shouldLeaveStoreInGoodStateAfterRotationFailure() throws Exception {
  final Store store=resourceManager.managed(createTestStore(0));
  long initialVersion=store.version(store.headers());
  String permanentKey="permakey";
  String permanentValue="here";
  try (EntryUpdater<String> updater=store.updater(initialVersion + 1).get()){
    updater.apply(permanentKey,value(permanentValue));
  }
   store.prepareRotation(initialVersion + 1).rotate();
  String key="mykey";
  String value="first";
  try (EntryUpdater<String> updater=store.updater(initialVersion + 2).get()){
    updater.apply(key,value("first"));
  }
   try {
    store.prepareRotation(initialVersion + 3).rotate();
    fail("Should've failed rotation, since that version doesn't exist yet");
  }
 catch (  RotationTimeoutException e) {
    assertEquals(permanentValue,store.get(permanentKey));
    assertEquals(value,store.get(key));
    try (EntryUpdater<String> updater=store.updater(initialVersion + 2).get()){
      updater.apply(key,value("second"));
    }
     store.prepareRotation(initialVersion + 3).rotate();
  }
}
