@Test @Resources.Life(STARTED) @SuppressWarnings("unchecked") public void retryLookupOnConcurrentStoreStateChange() throws IOException {
  Store store=resourceManager.managed(new Store());
  ProgressiveState<String> workingState=stateWithLookup(() -> true);
  ProgressiveState<String> staleState=stateWithLookup(() -> {
    setState(store,workingState);
    throw new FileIsNotMappedException(new File("/files/was/rotated/concurrently/during/lookup"));
  }
);
  setState(store,staleState);
  assertEquals("New state contains stored value","value",store.lookup("test",stringReader("value")));
  verify(staleState,times(1)).lookup(any(),any());
  verify(workingState,times(1)).lookup(any(),any());
}
