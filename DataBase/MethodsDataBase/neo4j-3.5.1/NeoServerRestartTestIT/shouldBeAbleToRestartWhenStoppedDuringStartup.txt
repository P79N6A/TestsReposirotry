/** 
 * This test makes sure that the database is able to start after having been stopped during initialization. In order to make sure that the server is stopped during startup we create a separate thread that calls stop. In order to make sure that this thread does not call stop before the startup procedure has started we use a custom implementation of a PageSwapperFactory, which communicates with the thread that calls stop. We do this via a static semaphore.
 * @throws IOException
 * @throws InterruptedException
 */
@Test public void shouldBeAbleToRestartWhenStoppedDuringStartup() throws IOException, InterruptedException {
  semaphore.drainPermits();
  NeoServer server=getNeoServer(CUSTOM_SWAPPER);
  try {
    AtomicBoolean failure=new AtomicBoolean();
    Thread serverStoppingThread=ThreadTestUtils.fork(stopServerAfterStartingHasStarted(server,failure));
    server.start();
    serverStoppingThread.join();
    if (failure.get()) {
      fail("Server failed to stop.");
    }
    server=getNeoServer(CUSTOM_SWAPPER);
    server.start();
  }
  finally {
    server.stop();
  }
}
