@Test public void shouldSucceedWithUpgradeAfterPreviousAttemptDiedDuringMigration() throws IOException, ConsistencyCheckIncompleteException {
  MigrationTestUtils.prepareSampleLegacyDatabase(version,fs,workingDatabaseLayout.databaseDirectory(),prepareDirectory);
  PageCache pageCache=pageCacheRule.getPageCache(fs);
  StoreVersionCheck check=new StoreVersionCheck(pageCache);
  UpgradableDatabase upgradableDatabase=getUpgradableDatabase(check);
  SilentMigrationProgressMonitor progressMonitor=new SilentMigrationProgressMonitor();
  LogService logService=NullLogService.getInstance();
  StoreMigrator failingStoreMigrator=new StoreMigrator(fs,pageCache,CONFIG,logService,jobScheduler){
    @Override public void migrate(    DatabaseLayout directoryLayout,    DatabaseLayout migrationLayout,    ProgressReporter progressReporter,    String versionToMigrateFrom,    String versionToMigrateTo) throws IOException {
      super.migrate(directoryLayout,migrationLayout,progressReporter,versionToMigrateFrom,versionToMigrateTo);
      throw new RuntimeException("This upgrade is failing");
    }
  }
;
  try {
    newUpgrader(upgradableDatabase,pageCache,progressMonitor,createIndexMigrator(),failingStoreMigrator).migrateIfNeeded(workingDatabaseLayout);
    fail("Should throw exception");
  }
 catch (  RuntimeException e) {
    assertEquals("This upgrade is failing",e.getMessage());
  }
  progressMonitor=new SilentMigrationProgressMonitor();
  StoreMigrator migrator=new StoreMigrator(fs,pageCache,CONFIG,logService,jobScheduler);
  SchemaIndexMigrator indexMigrator=createIndexMigrator();
  newUpgrader(upgradableDatabase,pageCache,progressMonitor,indexMigrator,migrator).migrateIfNeeded(workingDatabaseLayout);
  assertTrue(checkNeoStoreHasDefaultFormatVersion(check,workingDatabaseLayout));
  startStopDatabase(workingDatabaseLayout.databaseDirectory());
  assertConsistentStore(workingDatabaseLayout);
}
