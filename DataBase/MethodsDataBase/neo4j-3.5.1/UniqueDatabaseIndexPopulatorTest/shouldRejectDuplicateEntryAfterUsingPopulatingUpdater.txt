@Test public void shouldRejectDuplicateEntryAfterUsingPopulatingUpdater() throws Exception {
  populator=newPopulator();
  String valueString="value1";
  IndexUpdater updater=populator.newPopulatingUpdater(nodePropertyAccessor);
  updater.process(add(1,schemaDescriptor,valueString));
  addUpdate(populator,2,valueString);
  Value value=Values.of(valueString);
  when(nodePropertyAccessor.getNodePropertyValue(1,PROPERTY_KEY_ID)).thenReturn(value);
  when(nodePropertyAccessor.getNodePropertyValue(2,PROPERTY_KEY_ID)).thenReturn(value);
  try {
    populator.verifyDeferredConstraints(nodePropertyAccessor);
    fail("should have thrown exception");
  }
 catch (  IndexEntryConflictException conflict) {
    assertEquals(1,conflict.getExistingNodeId());
    assertEquals(value,conflict.getSinglePropertyValue());
    assertEquals(2,conflict.getAddedNodeId());
  }
}
