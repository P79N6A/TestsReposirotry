@Test public void mustFlipToFailedIfFailureToApplyLastBatchWhileFlipping() throws Exception {
  NullLogProvider logProvider=NullLogProvider.getInstance();
  IndexStoreView storeView=emptyIndexStoreViewThatProcessUpdates();
  IndexPopulator.Adapter populator=emptyPopulatorWithThrowingUpdater();
  FailedIndexProxy failedProxy=failedIndexProxy(storeView,populator);
  OnlineIndexProxy onlineProxy=onlineIndexProxy(storeView);
  FlippableIndexProxy flipper=new FlippableIndexProxy();
  flipper.setFlipTarget(() -> onlineProxy);
  MultipleIndexPopulator multipleIndexPopulator=new MultipleIndexPopulator(storeView,logProvider,EntityType.NODE,mock(SchemaState.class));
  MultipleIndexPopulator.IndexPopulation indexPopulation=multipleIndexPopulator.addPopulator(populator,dummyMeta(),flipper,t -> failedProxy,"userDescription");
  multipleIndexPopulator.queueUpdate(someUpdate());
  multipleIndexPopulator.indexAllEntities().run();
  indexPopulation.flip(false);
  assertSame("flipper should have flipped to failing proxy",flipper.getState(),InternalIndexState.FAILED);
}
