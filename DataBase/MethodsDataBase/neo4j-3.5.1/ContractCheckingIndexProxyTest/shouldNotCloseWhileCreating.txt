@Test(expected=IllegalStateException.class) public void shouldNotCloseWhileCreating() throws IOException {
  final DoubleLatch latch=new DoubleLatch();
  final IndexProxy inner=new IndexProxyAdapter(){
    @Override public void start(){
      latch.startAndWaitForAllToStartAndFinish();
    }
  }
;
  final IndexProxy outer=newContractCheckingIndexProxy(inner);
  runInSeparateThread(outer::start);
  try {
    latch.waitForAllToStart();
    outer.close();
  }
  finally {
    latch.finish();
  }
}
