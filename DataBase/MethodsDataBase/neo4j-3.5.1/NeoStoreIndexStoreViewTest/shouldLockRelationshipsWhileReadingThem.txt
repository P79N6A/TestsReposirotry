@Test public void shouldLockRelationshipsWhileReadingThem() throws Exception {
  @SuppressWarnings("unchecked") Visitor<EntityUpdates,Exception> visitor=mock(Visitor.class);
  StoreScan<Exception> storeScan=storeView.visitRelationships(new int[]{relTypeId},id -> id == relPropertyKeyId,visitor);
  storeScan.run();
  assertThat("allocated locks: " + lockMocks.keySet(),lockMocks.size(),greaterThanOrEqualTo(2));
  Lock lock0=lockMocks.get(0L);
  Lock lock1=lockMocks.get(1L);
  assertNotNull("Lock[relationship=0] never acquired",lock0);
  assertNotNull("Lock[relationship=1] never acquired",lock1);
  InOrder order=inOrder(locks,lock0,lock1);
  order.verify(locks).acquireRelationshipLock(0,LockService.LockType.READ_LOCK);
  order.verify(lock0).release();
  order.verify(locks).acquireRelationshipLock(1,LockService.LockType.READ_LOCK);
  order.verify(lock1).release();
}
