@Test public void shouldLockNodesWhileReadingThem() throws Exception {
  @SuppressWarnings("unchecked") Visitor<EntityUpdates,Exception> visitor=mock(Visitor.class);
  StoreScan<Exception> storeScan=storeView.visitNodes(new int[]{labelId},id -> id == propertyKeyId,visitor,null,false);
  storeScan.run();
  assertThat("allocated locks: " + lockMocks.keySet(),lockMocks.size(),greaterThanOrEqualTo(2));
  Lock lock0=lockMocks.get(0L);
  Lock lock1=lockMocks.get(1L);
  assertNotNull("Lock[node=0] never acquired",lock0);
  assertNotNull("Lock[node=1] never acquired",lock1);
  InOrder order=inOrder(locks,lock0,lock1);
  order.verify(locks).acquireNodeLock(0,LockService.LockType.READ_LOCK);
  order.verify(lock0).release();
  order.verify(locks).acquireNodeLock(1,LockService.LockType.READ_LOCK);
  order.verify(lock1).release();
}
