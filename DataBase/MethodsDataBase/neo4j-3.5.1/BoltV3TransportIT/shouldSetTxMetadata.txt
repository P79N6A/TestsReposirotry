@Test public void shouldSetTxMetadata() throws Throwable {
  negotiateBoltV3();
  Map<String,Object> txMetadata=map("who-is-your-boss","Molly-mostly-white");
  Map<String,Object> msgMetadata=map("tx_metadata",txMetadata);
  MapValue meta=asMapValue(msgMetadata);
  connection.send(util.chunk(new BeginMessage(meta),new RunMessage("RETURN 1"),PullAllMessage.INSTANCE));
  assertThat(connection,util.eventuallyReceives(msgSuccess(),msgSuccess(),msgRecord(eqRecord(equalTo(longValue(1L)))),msgSuccess()));
  GraphDatabaseAPI gdb=(GraphDatabaseAPI)server.graphDatabaseService();
  Set<KernelTransactionHandle> txHandles=gdb.getDependencyResolver().resolveDependency(KernelTransactions.class).activeTransactions();
  assertThat(txHandles.size(),equalTo(1));
  for (  KernelTransactionHandle txHandle : txHandles) {
    assertThat(txHandle.getMetaData(),equalTo(txMetadata));
  }
  connection.send(util.chunk(ROLLBACK_MESSAGE));
}
