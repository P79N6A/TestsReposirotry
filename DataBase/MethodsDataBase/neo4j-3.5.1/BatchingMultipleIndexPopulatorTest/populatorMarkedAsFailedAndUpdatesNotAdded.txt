@Test public void populatorMarkedAsFailedAndUpdatesNotAdded() throws Exception {
  setProperty(BATCH_SIZE_NAME,2);
  EntityUpdates update1=nodeUpdates(1,propertyId,"aaa",labelId);
  EntityUpdates update2=nodeUpdates(1,propertyId,"bbb",labelId);
  EntityUpdates update3=nodeUpdates(1,propertyId,"ccc",labelId);
  EntityUpdates update4=nodeUpdates(1,propertyId,"ddd",labelId);
  EntityUpdates update5=nodeUpdates(1,propertyId,"eee",labelId);
  IndexStoreView storeView=newStoreView(update1,update2,update3,update4,update5);
  RuntimeException batchFlushError=new RuntimeException("Batch failed");
  BatchingMultipleIndexPopulator batchingPopulator=new BatchingMultipleIndexPopulator(storeView,sameThreadExecutor(),NullLogProvider.getInstance(),mock(SchemaState.class));
  IndexPopulator populator=addPopulator(batchingPopulator,index1);
  doThrow(batchFlushError).when(populator).add(forUpdates(index1,update3,update4));
  batchingPopulator.indexAllEntities().run();
  verify(populator).add(forUpdates(index1,update1,update2));
  verify(populator).add(forUpdates(index1,update3,update4));
  verify(populator).markAsFailed(failure(batchFlushError).asString());
  verify(populator,never()).add(forUpdates(index1,update5));
}
