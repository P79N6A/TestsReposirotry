@Test public void populatorMarkedAsFailed() throws Exception {
  setProperty(BATCH_SIZE_NAME,2);
  EntityUpdates update1=nodeUpdates(1,propertyId,"aaa",labelId);
  EntityUpdates update2=nodeUpdates(1,propertyId,"bbb",labelId);
  IndexStoreView storeView=newStoreView(update1,update2);
  RuntimeException batchFlushError=new RuntimeException("Batch failed");
  IndexPopulator populator;
  ExecutorService executor=Executors.newSingleThreadExecutor();
  try {
    BatchingMultipleIndexPopulator batchingPopulator=new BatchingMultipleIndexPopulator(storeView,executor,NullLogProvider.getInstance(),mock(SchemaState.class));
    populator=addPopulator(batchingPopulator,index1);
    List<IndexEntryUpdate<IndexDescriptor>> expected=forUpdates(index1,update1,update2);
    doThrow(batchFlushError).when(populator).add(expected);
    batchingPopulator.indexAllEntities().run();
  }
  finally {
    executor.shutdown();
    executor.awaitTermination(1,TimeUnit.MINUTES);
  }
  verify(populator).markAsFailed(failure(batchFlushError).asString());
}
