@Test public void populateFromQueuePopulatesWhenThresholdReached() throws Exception {
  setProperty(QUEUE_THRESHOLD_NAME,2);
  NeoStores neoStores=mock(NeoStores.class);
  NodeStore nodeStore=mock(NodeStore.class);
  when(neoStores.getNodeStore()).thenReturn(nodeStore);
  NeoStoreIndexStoreView storeView=new NeoStoreIndexStoreView(LockService.NO_LOCK_SERVICE,neoStores);
  BatchingMultipleIndexPopulator batchingPopulator=new BatchingMultipleIndexPopulator(storeView,immediateExecutor(),NullLogProvider.getInstance(),mock(SchemaState.class));
  IndexPopulator populator1=addPopulator(batchingPopulator,index1);
  IndexUpdater updater1=mock(IndexUpdater.class);
  when(populator1.newPopulatingUpdater(any())).thenReturn(updater1);
  IndexPopulator populator2=addPopulator(batchingPopulator,index42);
  IndexUpdater updater2=mock(IndexUpdater.class);
  when(populator2.newPopulatingUpdater(any())).thenReturn(updater2);
  batchingPopulator.indexAllEntities();
  IndexEntryUpdate<?> update1=add(1,index1.schema(),"foo");
  IndexEntryUpdate<?> update2=add(2,index42.schema(),"bar");
  IndexEntryUpdate<?> update3=add(3,index1.schema(),"baz");
  batchingPopulator.queueUpdate(update1);
  batchingPopulator.queueUpdate(update2);
  batchingPopulator.queueUpdate(update3);
  batchingPopulator.populateFromQueueBatched(42);
  verify(updater1).process(update1);
  verify(updater1).process(update3);
  verify(updater2).process(update2);
}
