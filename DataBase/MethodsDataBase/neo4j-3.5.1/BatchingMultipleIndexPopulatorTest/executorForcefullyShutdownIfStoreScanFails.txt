@Test @SuppressWarnings("unchecked") public void executorForcefullyShutdownIfStoreScanFails() throws Exception {
  IndexStoreView storeView=mock(IndexStoreView.class);
  StoreScan<Exception> failingStoreScan=mock(StoreScan.class);
  RuntimeException scanError=new RuntimeException();
  doThrow(scanError).when(failingStoreScan).run();
  when(storeView.visitNodes(any(),any(),any(),any(),anyBoolean())).thenReturn(failingStoreScan);
  ExecutorService executor=immediateExecutor();
  when(executor.awaitTermination(anyLong(),any())).thenReturn(true);
  BatchingMultipleIndexPopulator batchingPopulator=new BatchingMultipleIndexPopulator(storeView,executor,NullLogProvider.getInstance(),mock(SchemaState.class));
  StoreScan<IndexPopulationFailedKernelException> storeScan=batchingPopulator.indexAllEntities();
  verify(executor,never()).shutdown();
  try {
    storeScan.run();
    fail("Exception expected");
  }
 catch (  Throwable t) {
    assertSame(scanError,t);
  }
  verify(executor,never()).shutdownNow();
  verify(executor,never()).awaitTermination(anyLong(),any());
  batchingPopulator.close(false);
  verify(executor).shutdownNow();
  verify(executor).awaitTermination(anyLong(),any());
}
