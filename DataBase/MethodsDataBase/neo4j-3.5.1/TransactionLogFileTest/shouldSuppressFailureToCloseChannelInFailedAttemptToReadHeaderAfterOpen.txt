@Test public void shouldSuppressFailureToCloseChannelInFailedAttemptToReadHeaderAfterOpen() throws Exception {
  FileSystemAbstraction fs=mock(FileSystemAbstraction.class);
  LogFiles logFiles=LogFilesBuilder.builder(directory.databaseLayout(),fs).withTransactionIdStore(transactionIdStore).withLogVersionRepository(logVersionRepository).build();
  int logVersion=0;
  File logFile=logFiles.getLogFileForVersion(logVersion);
  StoreChannel channel=mock(StoreChannel.class);
  when(channel.read(any(ByteBuffer.class))).thenReturn(LogHeader.LOG_HEADER_SIZE / 2);
  when(fs.fileExists(logFile)).thenReturn(true);
  when(fs.open(eq(logFile),any(OpenMode.class))).thenReturn(channel);
  doThrow(IOException.class).when(channel).close();
  try {
    logFiles.openForVersion(logVersion);
    fail("Should have failed");
  }
 catch (  IncompleteLogHeaderException e) {
    verify(channel).close();
    assertEquals(1,e.getSuppressed().length);
    assertTrue(e.getSuppressed()[0] instanceof IOException);
  }
}
