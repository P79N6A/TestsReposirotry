@Test public void shouldProcessAllSingleThreaded() throws Exception {
  StageControl control=mock(StageControl.class);
  int processors=10;
  int batches=10;
  BatchProcessor step=new BatchProcessor(control,processors);
  TrackingStep downstream=new TrackingStep();
  step.setDownstream(downstream);
  step.processors(processors - step.processors(0));
  step.start(0);
  for (int i=1; i <= batches; i++) {
    step.receive(i,new Batch(processors));
  }
  step.endOfUpstream();
  step.awaitCompleted();
  step.close();
  assertEquals(batches,downstream.received.get());
}
