@Test public void shouldPanicOnFailure() throws Exception {
  SimpleStageControl control=new SimpleStageControl();
  int availableProcessors=Runtime.getRuntime().availableProcessors();
  Exception testPanic=new RuntimeException();
  ForkedProcessorStep<Void> step=new ForkedProcessorStep<Void>(control,"Processor",config(availableProcessors)){
    @Override protected void forkedProcess(    int id,    int processors,    Void batch) throws Throwable {
      throw testPanic;
    }
  }
;
  step.start(0);
  step.receive(1,null);
  control.steps(step);
  step.awaitCompleted();
  try {
    control.assertHealthy();
  }
 catch (  Exception e) {
    assertSame(testPanic,e);
  }
}
