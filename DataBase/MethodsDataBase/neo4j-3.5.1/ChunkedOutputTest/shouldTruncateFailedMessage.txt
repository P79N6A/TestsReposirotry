@Test public void shouldTruncateFailedMessage() throws Exception {
  out.beginMessage();
  out.writeInt(1);
  out.writeInt(2);
  out.messageSucceeded();
  out.beginMessage();
  out.writeInt(3);
  out.writeInt(4);
  out.messageFailed();
  out.flush();
  ByteBuf outboundMessage=peekSingleOutboundMessage();
  assertByteBufEqual(outboundMessage,chunkContaining(1,2) + messageBoundary());
}
