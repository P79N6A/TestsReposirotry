@Test public void shouldFailToMarkMessageAsFailedAndThenAsSuccessful() throws Exception {
  out.beginMessage();
  out.writeInt(42);
  out.messageFailed();
  try {
    out.messageSucceeded();
    fail("Exception expected");
  }
 catch (  IllegalStateException ignore) {
  }
  out.flush();
  assertEquals(0,peekAllOutboundMessages().size());
}
