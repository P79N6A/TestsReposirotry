@Test public void shouldDelayFreeingOfAggressivelyReusedIdsConsideringTimeAsWell(){
  MockedIdGeneratorFactory actual=new MockedIdGeneratorFactory();
  final FakeClock clock=Clocks.fakeClock();
  final long safeZone=MINUTES.toMillis(1);
  ControllableSnapshotSupplier boundaries=new ControllableSnapshotSupplier();
  BufferingIdGeneratorFactory bufferingIdGeneratorFactory=new BufferingIdGeneratorFactory(actual,t -> clock.millis() - t.snapshotTime() >= safeZone,new CommunityIdTypeConfigurationProvider());
  bufferingIdGeneratorFactory.initialize(boundaries);
  IdGenerator idGenerator=bufferingIdGeneratorFactory.open(new File("doesnt-matter"),10,IdType.STRING_BLOCK,() -> 0L,Integer.MAX_VALUE);
  idGenerator.freeId(7);
  verifyNoMoreInteractions(actual.get(IdType.STRING_BLOCK));
  bufferingIdGeneratorFactory.maintenance();
  verifyNoMoreInteractions(actual.get(IdType.STRING_BLOCK));
  boundaries.setMostRecentlyReturnedSnapshotToAllClosed();
  bufferingIdGeneratorFactory.maintenance();
  verifyNoMoreInteractions(actual.get(IdType.STRING_BLOCK));
  clock.forward(70,SECONDS);
  bufferingIdGeneratorFactory.maintenance();
  verify(actual.get(IdType.STRING_BLOCK)).freeId(7);
}
