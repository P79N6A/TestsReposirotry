@Test public void shouldApplyIndexUpdatesInWorkSyncedBatches() throws Exception {
  long duration=parseTimeMillis.apply(System.getProperty(getClass().getName() + ".duration","2s"));
  int numThreads=Integer.getInteger(getClass().getName() + ".numThreads",Runtime.getRuntime().availableProcessors());
  DefaultFileSystemAbstraction fs=fileSystemRule.get();
  PageCache pageCache=pageCacheRule.getPageCache(fs);
  FusionIndexProvider indexProvider=NativeLuceneFusionIndexProviderFactory20.create(pageCache,directory.databaseDir(),fs,IndexProvider.Monitor.EMPTY,Config.defaults(),OperationalMode.single,RecoveryCleanupWorkCollector.immediate());
  RecordStorageEngine storageEngine=storageEngineRule.getWith(fs,pageCache,directory.databaseLayout()).indexProvider(indexProvider).build();
  storageEngine.apply(tx(singletonList(createIndexRule(DESCRIPTOR,1,descriptor))),TransactionApplicationMode.EXTERNAL);
  Dependencies dependencies=new Dependencies();
  storageEngine.satisfyDependencies(dependencies);
  IndexProxy index=dependencies.resolveDependency(IndexingService.class).getIndexProxy(descriptor);
  awaitOnline(index);
  Workers<Worker> workers=new Workers<>(getClass().getSimpleName());
  final AtomicBoolean end=new AtomicBoolean();
  for (int i=0; i < numThreads; i++) {
    workers.start(new Worker(i,end,storageEngine,10,index));
  }
  Thread.sleep(duration);
  end.set(true);
  workers.awaitAndThrowOnError();
}
