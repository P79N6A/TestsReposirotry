@Test public void shouldRecoverIfCrashedDuringMove() throws Throwable {
  final IOException exception=new IOException("simulated IO Exception on create");
  FileSystemAbstraction crashingFileSystem=new DelegatingFileSystemAbstraction(fs){
    @Override public void renameFile(    File oldLocation,    File newLocation,    CopyOption... copyOptions) throws IOException {
      if (authFile.getName().equals(newLocation.getName())) {
        throw exception;
      }
      super.renameFile(oldLocation,newLocation,copyOptions);
    }
  }
;
  FileUserRepository users=new FileUserRepository(crashingFileSystem,authFile,logProvider);
  users.start();
  User user=new User.Builder("jake",LegacyCredential.INACCESSIBLE).withRequiredPasswordChange(true).build();
  try {
    users.create(user);
    fail("Expected an IOException");
  }
 catch (  IOException e) {
    assertSame(exception,e);
  }
  assertFalse(crashingFileSystem.fileExists(authFile));
  assertThat(crashingFileSystem.listFiles(authFile.getParentFile()).length,equalTo(0));
}
