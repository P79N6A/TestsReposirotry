@Test public void shouldVerifyConstraintsBeforeFlippingIfToldTo() throws IndexEntryConflictException {
  IndexProxyFactory indexProxyFactory=mock(IndexProxyFactory.class);
  FailedIndexProxyFactory failedIndexProxyFactory=mock(FailedIndexProxyFactory.class);
  FlippableIndexProxy flipper=new FlippableIndexProxy();
  flipper.setFlipTarget(indexProxyFactory);
  IndexPopulator indexPopulator=createIndexPopulator();
  addPopulator(indexPopulator,1,flipper,failedIndexProxyFactory);
  when(indexPopulator.sampleResult()).thenReturn(new IndexSample());
  multipleIndexPopulator.indexAllEntities();
  multipleIndexPopulator.flipAfterPopulation(true);
  verify(indexPopulator).verifyDeferredConstraints(any(NodePropertyAccessor.class));
  verify(indexPopulator).close(true);
}
