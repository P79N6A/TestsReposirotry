@SuppressWarnings("unchecked") @Test public void applicationListenerFromApplicationIsCalledWhenContextFailsRefreshAfterListenerRegistration(){
  ApplicationListener<ApplicationEvent> listener=mock(ApplicationListener.class);
  SpringApplication application=new SpringApplication(BrokenPostConstructConfig.class);
  application.setWebApplicationType(WebApplicationType.NONE);
  application.addListeners(listener);
  try {
    application.run();
    fail("Run should have failed with a BeanCreationException");
  }
 catch (  BeanCreationException ex) {
    verifyListenerEvents(listener,ApplicationStartingEvent.class,ApplicationEnvironmentPreparedEvent.class,ApplicationContextInitializedEvent.class,ApplicationPreparedEvent.class,ApplicationFailedEvent.class);
  }
}
