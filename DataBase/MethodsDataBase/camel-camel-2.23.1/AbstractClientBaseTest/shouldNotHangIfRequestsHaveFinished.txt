@Test public void shouldNotHangIfRequestsHaveFinished() throws Exception {
  final Request request=mock(Request.class);
  final ArgumentCaptor<CompleteListener> listener=ArgumentCaptor.forClass(CompleteListener.class);
  doNothing().when(request).send(listener.capture());
  client.doHttpRequest(request,(response,headers,exception) -> {
  }
);
  final Result result=mock(Result.class);
  final Response response=mock(Response.class);
  when(result.getResponse()).thenReturn(response);
  when(response.getHeaders()).thenReturn(new HttpFields());
  final SalesforceHttpRequest salesforceRequest=mock(SalesforceHttpRequest.class);
  when(result.getRequest()).thenReturn(salesforceRequest);
  final HttpConversation conversation=mock(HttpConversation.class);
  when(salesforceRequest.getConversation()).thenReturn(conversation);
  when(conversation.getAttribute(SalesforceSecurityHandler.AUTHENTICATION_REQUEST_ATTRIBUTE)).thenReturn(salesforceRequest);
  listener.getValue().onComplete(result);
  final long stopStartTime=System.currentTimeMillis();
  client.stop();
  final long elapsed=System.currentTimeMillis() - stopStartTime;
  assertTrue(elapsed < 10);
}
