@Test(timeout=5000) public void testHandleDeliveryShouldNotHangForeverIfChanelWasClosed() throws Exception {
  Mockito.when(consumer.getEndpoint()).thenReturn(endpoint);
  Mockito.when(consumer.getConnection()).thenReturn(conn);
  Mockito.when(conn.createChannel()).thenReturn(channel);
  Mockito.when(channel.isOpen()).thenReturn(false).thenReturn(true);
  Mockito.when(consumer.getEndpoint()).thenReturn(endpoint);
  RabbitConsumer rabbitConsumer=new RabbitConsumer(consumer);
  rabbitConsumer.handleDelivery(null,null,null,null);
  try {
    rabbitConsumer.handleDelivery(null,null,null,null);
    fail("Should have thrown NPE");
  }
 catch (  NullPointerException e) {
  }
  rabbitConsumer.stop();
}
