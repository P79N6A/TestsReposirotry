@Test public void testRegistrationFromRoute() throws Exception {
  assertTrue(discovery.queryForInstances(SERVICE_NAME).isEmpty());
  context().startRoute(SERVICE_ID);
  Collection<ServiceInstance<ZooKeeperServiceRegistry.MetaData>> services=discovery.queryForInstances(SERVICE_NAME);
  assertEquals(1,services.size());
  ServiceInstance<ZooKeeperServiceRegistry.MetaData> instance=services.iterator().next();
  assertEquals(SERVICE_PORT,(int)instance.getPort());
  assertEquals("localhost",instance.getAddress());
  assertEquals("http",instance.getPayload().get(ServiceDefinition.SERVICE_META_PROTOCOL));
  assertEquals("/service/endpoint",instance.getPayload().get(ServiceDefinition.SERVICE_META_PATH));
  getMetadata().forEach((k,v) -> {
    assertEquals(v,instance.getPayload().get(k));
  }
);
  context().stopRoute(SERVICE_ID);
  assertTrue(discovery.queryForInstances(SERVICE_NAME).isEmpty());
}
