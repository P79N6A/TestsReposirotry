@Test public void uploadWithUpdatingTest() throws Exception {
  final String newName="newName";
  dummyImage.setName(newName);
  when(osImage.getName()).thenReturn(newName);
  msg.setHeader(OpenstackConstants.OPERATION,GlanceConstants.UPLOAD);
  final String id="id";
  msg.setHeader(OpenstackConstants.ID,id);
  msg.setHeader(OpenstackConstants.NAME,dummyImage.getName());
  msg.setHeader(GlanceConstants.OWNER,dummyImage.getOwner());
  msg.setHeader(GlanceConstants.MIN_DISK,dummyImage.getMinDisk());
  msg.setHeader(GlanceConstants.MIN_RAM,dummyImage.getMinRam());
  msg.setHeader(GlanceConstants.CHECKSUM,dummyImage.getChecksum());
  msg.setHeader(GlanceConstants.DISK_FORMAT,dummyImage.getDiskFormat());
  msg.setHeader(GlanceConstants.CONTAINER_FORMAT,dummyImage.getContainerFormat());
  final File file=File.createTempFile("image",".iso");
  msg.setBody(file);
  producer.process(exchange);
  verify(imageService).upload(imageIdCaptor.capture(),payloadCaptor.capture(),imageCaptor.capture());
  assertEquals(id,imageIdCaptor.getValue());
  assertEquals(file,payloadCaptor.getValue().getRaw());
  assertEquals(newName,imageCaptor.getValue().getName());
  final Image result=msg.getBody(Image.class);
  assertNotNull(result.getId());
  assertEqualsImages(dummyImage,result);
}
