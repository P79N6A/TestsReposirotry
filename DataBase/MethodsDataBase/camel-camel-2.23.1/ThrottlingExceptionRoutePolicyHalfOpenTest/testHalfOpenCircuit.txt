@Test public void testHalfOpenCircuit() throws Exception {
  result.reset();
  result.expectedMessageCount(2);
  List<String> bodies=Arrays.asList("Message One","Message Two");
  result.expectedBodiesReceivedInAnyOrder(bodies);
  result.whenAnyExchangeReceived(new Processor(){
    @Override public void process(    Exchange exchange) throws Exception {
      String msg=exchange.getIn().getBody(String.class);
      exchange.setException(new ThrottlingException(msg));
    }
  }
);
  sendMessage("Message One");
  sendMessage("Message Two");
  final ServiceSupport consumer=(ServiceSupport)context.getRoute("foo").getConsumer();
  await().atMost(2,TimeUnit.SECONDS).until(consumer::isSuspended);
  log.debug("sending message three");
  sendMessage("Message Three");
  assertMockEndpointsSatisfied();
  result.reset();
  result.expectedMessageCount(1);
  bodies=Arrays.asList("Message Four");
  result.expectedBodiesReceivedInAnyOrder(bodies);
  await().atMost(2,TimeUnit.SECONDS).until(consumer::isStarted);
  log.debug("sending message four");
  sendMessage("Message Four");
  assertMockEndpointsSatisfied();
}
