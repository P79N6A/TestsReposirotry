@Test public void testLoadProducer() throws Exception {
  CountDownLatch lock=new CountDownLatch(NUMBER_OF_MESSAGES);
  for (int i=0; i < NUMBER_OF_MESSAGES; i++) {
    template.sendBody("direct:send","test" + i);
  }
  AtomicInteger counter=new AtomicInteger(0);
  NSQLookup lookup=new DefaultNSQLookup();
  lookup.addLookupAddress("localhost",4161);
  NSQConsumer consumer=new NSQConsumer(lookup,"test","testconsumer",(message) -> {
    counter.incrementAndGet();
    message.finished();
    lock.countDown();
    assertTrue(message.getAttempts() == 1);
  }
);
  consumer.start();
  lock.await(30,TimeUnit.SECONDS);
  assertTrue(counter.get() == Long.valueOf(NUMBER_OF_MESSAGES));
  consumer.shutdown();
}
