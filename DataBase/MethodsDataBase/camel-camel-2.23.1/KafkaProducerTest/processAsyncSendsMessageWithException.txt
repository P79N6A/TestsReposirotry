@Test public void processAsyncSendsMessageWithException() throws Exception {
  endpoint.getConfiguration().setTopic("sometopic");
  Mockito.when(exchange.getIn()).thenReturn(in);
  Mockito.when(exchange.getOut()).thenReturn(out);
  org.apache.kafka.clients.producer.KafkaProducer kp=producer.getKafkaProducer();
  Mockito.when(kp.send(any(ProducerRecord.class),any(Callback.class))).thenThrow(new ApiException());
  in.setHeader(KafkaConstants.PARTITION_KEY,4);
  producer.process(exchange,callback);
  ArgumentCaptor<Callback> callBackCaptor=ArgumentCaptor.forClass(Callback.class);
  Mockito.verify(producer.getKafkaProducer()).send(any(ProducerRecord.class),callBackCaptor.capture());
  Mockito.verify(exchange).setException(isA(ApiException.class));
  Mockito.verify(callback).done(eq(true));
  Callback kafkaCallback=callBackCaptor.getValue();
  kafkaCallback.onCompletion(new RecordMetadata(null,0,0,0,new Long(0),0,0),null);
  assertRecordMetadataExists();
}
