@Test public void testGroupClose() throws Exception {
  int port=findFreePort();
  NIOServerCnxnFactory cnxnFactory=startZooKeeper(port);
  CuratorFrameworkFactory.Builder builder=CuratorFrameworkFactory.builder().connectString("localhost:" + port).connectionTimeoutMs(6000).sessionTimeoutMs(6000).retryPolicy(new RetryNTimes(10,100));
  CuratorFramework curator=builder.build();
  curator.start();
  curator.getZookeeperClient().blockUntilConnectedOrTimedOut();
  String groupNode="/singletons/test" + System.currentTimeMillis();
  curator.create().creatingParentsIfNeeded().forPath(groupNode);
  for (int i=0; i < 100; i++) {
    ZooKeeperGroup<NodeState> group=new ZooKeeperGroup<>(curator,groupNode,NodeState.class);
    group.add(listener);
    group.update(new NodeState("foo"));
    group.start();
    group.close();
    List<String> entries=curator.getChildren().forPath(groupNode);
    assertTrue(entries.isEmpty() || group.isUnstable());
    if (group.isUnstable()) {
      curator.close();
      curator=builder.build();
      curator.start();
      curator.getZookeeperClient().blockUntilConnectedOrTimedOut();
    }
  }
  curator.close();
  cnxnFactory.shutdown();
  cnxnFactory.join();
}
