@Test public void testChannelInitializerReentrance(){
  final AtomicInteger registeredCalled=new AtomicInteger(0);
  final ChannelInboundHandlerAdapter handler1=new ChannelInboundHandlerAdapter(){
    @Override public void channelRegistered(    ChannelHandlerContext ctx) throws Exception {
      registeredCalled.incrementAndGet();
    }
  }
;
  final AtomicInteger initChannelCalled=new AtomicInteger(0);
  client.handler(new ChannelInitializer<Channel>(){
    @Override protected void initChannel(    Channel ch) throws Exception {
      initChannelCalled.incrementAndGet();
      ch.pipeline().addLast(handler1);
      ch.pipeline().fireChannelRegistered();
    }
  }
).localAddress(LocalAddress.ANY);
  Channel channel=client.bind().syncUninterruptibly().channel();
  try {
    channel.eventLoop().submit(new Runnable(){
      @Override public void run(){
      }
    }
).syncUninterruptibly();
    assertEquals(1,initChannelCalled.get());
    assertEquals(2,registeredCalled.get());
  }
  finally {
    channel.close().syncUninterruptibly();
  }
}
