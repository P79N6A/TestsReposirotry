@Test public void testMultipleRecordsInOneBufferWithNonZeroPositionJDKCompatabilityModeOff() throws Exception {
  SelfSignedCertificate cert=new SelfSignedCertificate();
  clientSslCtx=SslContextBuilder.forClient().trustManager(cert.cert()).sslProvider(sslClientProvider()).protocols(protocols()).ciphers(ciphers()).build();
  SSLEngine client=wrapEngine(clientSslCtx.newHandler(UnpooledByteBufAllocator.DEFAULT).engine());
  serverSslCtx=SslContextBuilder.forServer(cert.certificate(),cert.privateKey()).sslProvider(sslServerProvider()).protocols(protocols()).ciphers(ciphers()).build();
  SSLEngine server=wrapEngine(serverSslCtx.newHandler(UnpooledByteBufAllocator.DEFAULT).engine());
  try {
    final int plainClientOutLen=1024;
    ByteBuffer plainClientOut=allocateBuffer(plainClientOutLen);
    ByteBuffer plainServerOut=allocateBuffer(server.getSession().getApplicationBufferSize());
    ByteBuffer encClientToServer=allocateBuffer(client.getSession().getPacketBufferSize());
    int positionOffset=1;
    ByteBuffer combinedEncClientToServer=allocateBuffer(encClientToServer.capacity() * 2 + positionOffset);
    combinedEncClientToServer.position(positionOffset);
    handshake(client,server);
    plainClientOut.limit(plainClientOut.capacity());
    SSLEngineResult result=client.wrap(plainClientOut,encClientToServer);
    assertEquals(plainClientOut.capacity(),result.bytesConsumed());
    assertTrue(result.bytesProduced() > 0);
    encClientToServer.flip();
    combinedEncClientToServer.put(encClientToServer);
    plainClientOut.clear();
    encClientToServer.clear();
    result=client.wrap(plainClientOut,encClientToServer);
    assertEquals(plainClientOut.capacity(),result.bytesConsumed());
    assertTrue(result.bytesProduced() > 0);
    encClientToServer.flip();
    combinedEncClientToServer.put(encClientToServer);
    encClientToServer.clear();
    combinedEncClientToServer.flip();
    combinedEncClientToServer.position(positionOffset);
    combinedEncClientToServer.limit(combinedEncClientToServer.limit() - positionOffset);
    final int combinedEncClientToServerLen=combinedEncClientToServer.remaining();
    result=server.unwrap(combinedEncClientToServer,plainServerOut);
    assertEquals(0,combinedEncClientToServer.remaining());
    assertEquals(combinedEncClientToServerLen,result.bytesConsumed());
    assertEquals(plainClientOutLen,result.bytesProduced());
  }
  finally {
    cert.delete();
    cleanupClientSslEngine(client);
    cleanupServerSslEngine(server);
  }
}
