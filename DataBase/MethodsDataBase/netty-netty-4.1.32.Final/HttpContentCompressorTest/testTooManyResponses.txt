@Test public void testTooManyResponses() throws Exception {
  FullHttpRequest request=newRequest();
  EmbeddedChannel ch=new EmbeddedChannel(new HttpContentCompressor());
  ch.writeInbound(request);
  ch.writeOutbound(new DefaultFullHttpResponse(HttpVersion.HTTP_1_1,HttpResponseStatus.OK,Unpooled.EMPTY_BUFFER));
  try {
    ch.writeOutbound(new DefaultFullHttpResponse(HttpVersion.HTTP_1_1,HttpResponseStatus.OK,Unpooled.EMPTY_BUFFER));
    fail();
  }
 catch (  EncoderException e) {
    assertTrue(e.getCause() instanceof IllegalStateException);
  }
  assertTrue(ch.finish());
  for (; ; ) {
    Object message=ch.readOutbound();
    if (message == null) {
      break;
    }
    ReferenceCountUtil.release(message);
  }
  for (; ; ) {
    Object message=ch.readInbound();
    if (message == null) {
      break;
    }
    ReferenceCountUtil.release(message);
  }
}
