@Test public void testChunkedContentWithTrailingHeader() throws Exception {
  EmbeddedChannel ch=new EmbeddedChannel(new HttpContentCompressor());
  ch.writeInbound(newRequest());
  HttpResponse res=new DefaultHttpResponse(HttpVersion.HTTP_1_1,HttpResponseStatus.OK);
  res.headers().set(HttpHeaderNames.TRANSFER_ENCODING,HttpHeaderValues.CHUNKED);
  ch.writeOutbound(res);
  assertEncodedResponse(ch);
  ch.writeOutbound(new DefaultHttpContent(Unpooled.copiedBuffer("Hell",CharsetUtil.US_ASCII)));
  ch.writeOutbound(new DefaultHttpContent(Unpooled.copiedBuffer("o, w",CharsetUtil.US_ASCII)));
  LastHttpContent content=new DefaultLastHttpContent(Unpooled.copiedBuffer("orld",CharsetUtil.US_ASCII));
  content.trailingHeaders().set(of("X-Test"),of("Netty"));
  ch.writeOutbound(content);
  HttpContent chunk;
  chunk=ch.readOutbound();
  assertThat(ByteBufUtil.hexDump(chunk.content()),is("1f8b0800000000000000f248cdc901000000ffff"));
  chunk.release();
  chunk=ch.readOutbound();
  assertThat(ByteBufUtil.hexDump(chunk.content()),is("cad7512807000000ffff"));
  chunk.release();
  chunk=ch.readOutbound();
  assertThat(ByteBufUtil.hexDump(chunk.content()),is("ca2fca4901000000ffff"));
  chunk.release();
  chunk=ch.readOutbound();
  assertThat(ByteBufUtil.hexDump(chunk.content()),is("0300c2a99ae70c000000"));
  assertThat(chunk,is(instanceOf(HttpContent.class)));
  chunk.release();
  chunk=ch.readOutbound();
  assertThat(chunk.content().isReadable(),is(false));
  assertThat(chunk,is(instanceOf(LastHttpContent.class)));
  assertEquals("Netty",((LastHttpContent)chunk).trailingHeaders().get(of("X-Test")));
  chunk.release();
  assertThat(ch.readOutbound(),is(nullValue()));
}
