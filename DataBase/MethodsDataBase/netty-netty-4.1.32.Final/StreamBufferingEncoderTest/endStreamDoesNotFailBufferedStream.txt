@Test public void endStreamDoesNotFailBufferedStream(){
  encoder.writeSettingsAck(ctx,newPromise());
  setMaxConcurrentStreams(0);
  encoderWriteHeaders(3,newPromise());
  assertEquals(1,encoder.numBufferedStreams());
  encoder.writeData(ctx,3,EMPTY_BUFFER,0,true,newPromise());
  assertEquals(0,connection.numActiveStreams());
  assertEquals(1,encoder.numBufferedStreams());
  setMaxConcurrentStreams(1);
  encoder.writeSettingsAck(ctx,newPromise());
  assertEquals(1,connection.numActiveStreams());
  assertEquals(0,encoder.numBufferedStreams());
  assertEquals(HALF_CLOSED_LOCAL,connection.stream(3).state());
}
