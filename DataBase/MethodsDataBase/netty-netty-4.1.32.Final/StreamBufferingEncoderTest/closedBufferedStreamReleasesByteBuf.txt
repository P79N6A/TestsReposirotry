@Test public void closedBufferedStreamReleasesByteBuf(){
  encoder.writeSettingsAck(ctx,newPromise());
  setMaxConcurrentStreams(0);
  ByteBuf data=mock(ByteBuf.class);
  ChannelFuture f1=encoderWriteHeaders(3,newPromise());
  assertEquals(1,encoder.numBufferedStreams());
  ChannelFuture f2=encoder.writeData(ctx,3,data,0,false,newPromise());
  ChannelPromise rstPromise=mock(ChannelPromise.class);
  encoder.writeRstStream(ctx,3,CANCEL.code(),rstPromise);
  assertEquals(0,encoder.numBufferedStreams());
  verify(rstPromise).setSuccess();
  assertTrue(f1.isSuccess());
  assertTrue(f2.isSuccess());
  verify(data).release();
}
