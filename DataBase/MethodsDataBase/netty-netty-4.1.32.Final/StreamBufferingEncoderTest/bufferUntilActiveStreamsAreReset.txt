@Test public void bufferUntilActiveStreamsAreReset() throws Exception {
  encoder.writeSettingsAck(ctx,newPromise());
  setMaxConcurrentStreams(1);
  encoderWriteHeaders(3,newPromise());
  assertEquals(0,encoder.numBufferedStreams());
  encoderWriteHeaders(5,newPromise());
  assertEquals(1,encoder.numBufferedStreams());
  encoderWriteHeaders(7,newPromise());
  assertEquals(2,encoder.numBufferedStreams());
  writeVerifyWriteHeaders(times(1),3);
  writeVerifyWriteHeaders(never(),5);
  writeVerifyWriteHeaders(never(),7);
  encoder.writeRstStream(ctx,3,CANCEL.code(),newPromise());
  connection.remote().flowController().writePendingBytes();
  writeVerifyWriteHeaders(times(1),5);
  writeVerifyWriteHeaders(never(),7);
  assertEquals(1,connection.numActiveStreams());
  assertEquals(1,encoder.numBufferedStreams());
  encoder.writeRstStream(ctx,5,CANCEL.code(),newPromise());
  connection.remote().flowController().writePendingBytes();
  writeVerifyWriteHeaders(times(1),7);
  assertEquals(1,connection.numActiveStreams());
  assertEquals(0,encoder.numBufferedStreams());
  encoder.writeRstStream(ctx,7,CANCEL.code(),newPromise());
  assertEquals(0,connection.numActiveStreams());
  assertEquals(0,encoder.numBufferedStreams());
}
