@Test public void channelClosedWhenCloseListenerCompletes(){
  LastInboundHandler inboundHandler=streamActiveAndWriteHeaders(inboundStream);
  Http2StreamChannel childChannel=(Http2StreamChannel)inboundHandler.channel();
  assertTrue(childChannel.isOpen());
  assertTrue(childChannel.isActive());
  final AtomicBoolean channelOpen=new AtomicBoolean(true);
  final AtomicBoolean channelActive=new AtomicBoolean(true);
  ChannelPromise p=childChannel.newPromise();
  p.addListener(new ChannelFutureListener(){
    @Override public void operationComplete(    ChannelFuture future){
      channelOpen.set(future.channel().isOpen());
      channelActive.set(future.channel().isActive());
    }
  }
);
  childChannel.close(p).syncUninterruptibly();
  assertFalse(channelOpen.get());
  assertFalse(channelActive.get());
  assertFalse(childChannel.isActive());
}
