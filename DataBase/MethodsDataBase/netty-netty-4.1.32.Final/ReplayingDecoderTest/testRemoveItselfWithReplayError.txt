@Test public void testRemoveItselfWithReplayError(){
  EmbeddedChannel channel=new EmbeddedChannel(new ReplayingDecoder(){
    private boolean removed;
    @Override protected void decode(    ChannelHandlerContext ctx,    ByteBuf in,    List<Object> out) throws Exception {
      assertFalse(removed);
      ctx.pipeline().remove(this);
      in.readBytes(1000);
      removed=true;
    }
  }
);
  ByteBuf buf=Unpooled.wrappedBuffer(new byte[]{'a','b','c'});
  channel.writeInbound(buf.copy());
  ByteBuf b=channel.readInbound();
  assertEquals("Expect to have still all bytes in the buffer",b,buf);
  b.release();
  buf.release();
}
