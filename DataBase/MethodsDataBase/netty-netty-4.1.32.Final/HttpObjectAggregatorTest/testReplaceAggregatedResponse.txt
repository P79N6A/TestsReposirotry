@Test public void testReplaceAggregatedResponse(){
  EmbeddedChannel embedder=new EmbeddedChannel(new HttpObjectAggregator(1024 * 1024));
  Exception boom=new Exception("boom");
  HttpResponse rep=new DefaultHttpResponse(HttpVersion.HTTP_1_1,HttpResponseStatus.OK);
  rep.setDecoderResult(DecoderResult.failure(boom));
  assertTrue(embedder.writeInbound(rep) && embedder.finish());
  FullHttpResponse aggregatedRep=embedder.readInbound();
  FullHttpResponse replacedRep=aggregatedRep.replace(Unpooled.EMPTY_BUFFER);
  assertEquals(replacedRep.decoderResult(),aggregatedRep.decoderResult());
  aggregatedRep.release();
  replacedRep.release();
}
