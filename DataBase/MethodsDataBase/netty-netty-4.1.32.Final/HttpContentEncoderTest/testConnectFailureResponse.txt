@Test public void testConnectFailureResponse() throws Exception {
  String content="Not allowed by configuration";
  EmbeddedChannel ch=new EmbeddedChannel(new TestEncoder());
  HttpRequest req=new DefaultFullHttpRequest(HttpVersion.HTTP_1_1,HttpMethod.CONNECT,"google.com:80");
  ch.writeInbound(req);
  HttpResponse res=new DefaultHttpResponse(HttpVersion.HTTP_1_1,HttpResponseStatus.METHOD_NOT_ALLOWED);
  res.headers().set(HttpHeaderNames.TRANSFER_ENCODING,HttpHeaderValues.CHUNKED);
  ch.writeOutbound(res);
  ch.writeOutbound(new DefaultHttpContent(Unpooled.wrappedBuffer(content.getBytes(CharsetUtil.UTF_8))));
  ch.writeOutbound(LastHttpContent.EMPTY_LAST_CONTENT);
  assertEncodedResponse(ch);
  Object o=ch.readOutbound();
  assertThat(o,is(instanceOf(HttpContent.class)));
  HttpContent chunk=(HttpContent)o;
  assertThat(chunk.content().toString(CharsetUtil.US_ASCII),is("28"));
  chunk.release();
  chunk=ch.readOutbound();
  assertThat(chunk.content().isReadable(),is(true));
  assertThat(chunk.content().toString(CharsetUtil.US_ASCII),is("0"));
  chunk.release();
  chunk=ch.readOutbound();
  assertThat(chunk,is(instanceOf(LastHttpContent.class)));
  chunk.release();
  assertThat(ch.readOutbound(),is(nullValue()));
}
