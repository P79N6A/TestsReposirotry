@Test public void testLargeFileRegionChunked() throws Exception {
  EmbeddedChannel channel=new EmbeddedChannel(new HttpResponseEncoder());
  HttpResponse response=new DefaultHttpResponse(HttpVersion.HTTP_1_1,HttpResponseStatus.OK);
  response.headers().set(HttpHeaderNames.TRANSFER_ENCODING,HttpHeaderValues.CHUNKED);
  assertTrue(channel.writeOutbound(response));
  ByteBuf buffer=channel.readOutbound();
  assertEquals("HTTP/1.1 200 OK\r\n" + HttpHeaderNames.TRANSFER_ENCODING + ": "+ HttpHeaderValues.CHUNKED+ "\r\n\r\n",buffer.toString(CharsetUtil.US_ASCII));
  buffer.release();
  assertTrue(channel.writeOutbound(FILE_REGION));
  buffer=channel.readOutbound();
  assertEquals("80000000\r\n",buffer.toString(CharsetUtil.US_ASCII));
  buffer.release();
  FileRegion region=channel.readOutbound();
  assertSame(FILE_REGION,region);
  region.release();
  buffer=channel.readOutbound();
  assertEquals("\r\n",buffer.toString(CharsetUtil.US_ASCII));
  buffer.release();
  assertTrue(channel.writeOutbound(LastHttpContent.EMPTY_LAST_CONTENT));
  buffer=channel.readOutbound();
  assertEquals("0\r\n\r\n",buffer.toString(CharsetUtil.US_ASCII));
  buffer.release();
  assertFalse(channel.finish());
}
