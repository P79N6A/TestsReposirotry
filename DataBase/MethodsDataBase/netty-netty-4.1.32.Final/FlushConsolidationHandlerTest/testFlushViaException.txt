@Test(expected=IllegalStateException.class) public void testFlushViaException(){
  final AtomicInteger flushCount=new AtomicInteger();
  EmbeddedChannel channel=newChannel(flushCount,false);
  channel.pipeline().fireChannelRead(1L);
  assertEquals(0,flushCount.get());
  assertNull(channel.readOutbound());
  channel.pipeline().fireExceptionCaught(new IllegalStateException());
  assertEquals(1,flushCount.get());
  assertEquals(1L,channel.readOutbound());
  assertNull(channel.readOutbound());
  channel.finish();
}
