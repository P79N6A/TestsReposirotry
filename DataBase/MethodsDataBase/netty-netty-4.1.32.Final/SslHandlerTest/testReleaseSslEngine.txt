@Test public void testReleaseSslEngine() throws Exception {
  assumeTrue(OpenSsl.isAvailable());
  SelfSignedCertificate cert=new SelfSignedCertificate();
  try {
    SslContext sslContext=SslContextBuilder.forServer(cert.certificate(),cert.privateKey()).sslProvider(SslProvider.OPENSSL).build();
    try {
      SSLEngine sslEngine=sslContext.newEngine(ByteBufAllocator.DEFAULT);
      EmbeddedChannel ch=new EmbeddedChannel(new SslHandler(sslEngine));
      assertEquals(1,((ReferenceCounted)sslContext).refCnt());
      assertEquals(1,((ReferenceCounted)sslEngine).refCnt());
      assertTrue(ch.finishAndReleaseAll());
      ch.close().syncUninterruptibly();
      assertEquals(1,((ReferenceCounted)sslContext).refCnt());
      assertEquals(0,((ReferenceCounted)sslEngine).refCnt());
    }
  finally {
      ReferenceCountUtil.release(sslContext);
    }
  }
  finally {
    cert.delete();
  }
}
