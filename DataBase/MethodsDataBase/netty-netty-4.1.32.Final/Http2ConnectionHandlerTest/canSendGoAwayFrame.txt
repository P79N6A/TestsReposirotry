@SuppressWarnings("unchecked") @Test public void canSendGoAwayFrame() throws Exception {
  ByteBuf data=dummyData();
  long errorCode=Http2Error.INTERNAL_ERROR.code();
  when(future.isDone()).thenReturn(true);
  when(future.isSuccess()).thenReturn(true);
  doAnswer(new Answer<Void>(){
    @Override public Void answer(    InvocationOnMock invocation) throws Throwable {
      ((GenericFutureListener)invocation.getArgument(0)).operationComplete(future);
      return null;
    }
  }
).when(future).addListener(any(GenericFutureListener.class));
  handler=newHandler();
  handler.goAway(ctx,STREAM_ID,errorCode,data,promise);
  verify(connection).goAwaySent(eq(STREAM_ID),eq(errorCode),eq(data));
  verify(frameWriter).writeGoAway(eq(ctx),eq(STREAM_ID),eq(errorCode),eq(data),eq(promise));
  verify(ctx).close();
  assertEquals(0,data.refCnt());
}
