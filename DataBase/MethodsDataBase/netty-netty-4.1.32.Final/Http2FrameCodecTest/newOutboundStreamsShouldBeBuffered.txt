@Test public void newOutboundStreamsShouldBeBuffered() throws Exception {
  setUp(Http2FrameCodecBuilder.forServer().encoderEnforceMaxConcurrentStreams(true),new Http2Settings().maxConcurrentStreams(1));
  Http2FrameStream stream1=frameCodec.newStream();
  Http2FrameStream stream2=frameCodec.newStream();
  ChannelPromise promise1=channel.newPromise();
  ChannelPromise promise2=channel.newPromise();
  channel.writeAndFlush(new DefaultHttp2HeadersFrame(new DefaultHttp2Headers()).stream(stream1),promise1);
  channel.writeAndFlush(new DefaultHttp2HeadersFrame(new DefaultHttp2Headers()).stream(stream2),promise2);
  assertTrue(isStreamIdValid(stream1.id()));
  channel.runPendingTasks();
  assertTrue(isStreamIdValid(stream2.id()));
  assertTrue(promise1.syncUninterruptibly().isSuccess());
  assertFalse(promise2.isDone());
  frameListener.onSettingsRead(http2HandlerCtx,new Http2Settings().maxConcurrentStreams(2));
  channel.flush();
  assertTrue(promise2.syncUninterruptibly().isSuccess());
}
