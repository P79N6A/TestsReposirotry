@Test public void dataFramesShouldMerge() throws Exception {
  createStream(STREAM_ID,false);
  final ByteBuf data=dummyData().retain();
  ChannelPromise promise1=newPromise();
  encoder.writeData(ctx,STREAM_ID,data,0,true,promise1);
  ChannelPromise promise2=newPromise();
  encoder.writeData(ctx,STREAM_ID,data,0,true,promise2);
  List<FlowControlled> capturedWrites=payloadCaptor.getAllValues();
  FlowControlled mergedPayload=capturedWrites.get(0);
  mergedPayload.merge(ctx,capturedWrites.get(1));
  assertEquals(16,mergedPayload.size());
  assertFalse(promise1.isDone());
  assertFalse(promise2.isDone());
  mergedPayload.write(ctx,16);
  assertEquals(0,mergedPayload.size());
  assertEquals("abcdefghabcdefgh",writtenData.get(0));
  assertEquals(0,data.refCnt());
  assertTrue(promise1.isSuccess());
  assertTrue(promise2.isSuccess());
}
