@Test public void connectionErrorForWriterException() throws Http2Exception {
  initState(STREAM_A,1,true);
  initState(STREAM_B,2,true);
  initState(STREAM_C,3,true);
  initState(STREAM_D,4,true);
  Exception fakeException=new RuntimeException("Fake exception");
  doThrow(fakeException).when(writer).write(same(stream(STREAM_C)),eq(3));
  try {
    write(10);
    fail("Expected an exception");
  }
 catch (  Http2Exception e) {
    assertFalse(Http2Exception.isStreamError(e));
    assertEquals(Http2Error.INTERNAL_ERROR,e.error());
    assertSame(fakeException,e.getCause());
  }
  verifyWrite(atMost(1),STREAM_A,1);
  verifyWrite(atMost(1),STREAM_B,2);
  verifyWrite(STREAM_C,3);
  verifyWrite(atMost(1),STREAM_D,4);
  doAnswer(writeAnswer(false)).when(writer).write(same(stream(STREAM_C)),eq(3));
  assertFalse(write(10));
  verifyWrite(STREAM_A,1);
  verifyWrite(STREAM_B,2);
  verifyWrite(times(2),STREAM_C,3);
  verifyWrite(STREAM_D,4);
}
