@Test(timeout=3000) public void testAddReplaceHandlerCalledOnceRegistered() throws Throwable {
  ChannelPipeline pipeline=new LocalChannel().pipeline();
  CallbackCheckHandler handler=new CallbackCheckHandler();
  CallbackCheckHandler handler2=new CallbackCheckHandler();
  pipeline.addFirst(handler);
  pipeline.replace(handler,null,handler2);
  assertNull(handler.addedHandler.getNow());
  assertNull(handler.removedHandler.getNow());
  assertNull(handler2.addedHandler.getNow());
  assertNull(handler2.removedHandler.getNow());
  group.register(pipeline.channel()).syncUninterruptibly();
  Throwable cause=handler.error.get();
  if (cause != null) {
    throw cause;
  }
  assertTrue(handler.addedHandler.get());
  assertTrue(handler.removedHandler.get());
  Throwable cause2=handler2.error.get();
  if (cause2 != null) {
    throw cause2;
  }
  assertTrue(handler2.addedHandler.get());
  assertNull(handler2.removedHandler.getNow());
  pipeline.remove(handler2);
  assertTrue(handler2.removedHandler.get());
}
