@Test public void testFlushFailure() throws Exception {
  LocalAddress addr=new LocalAddress("testFlushFailure");
  ServerBootstrap sb=getLocalServerBootstrap();
  sb.bind(addr).sync().channel();
  Bootstrap cb=getLocalClientBootstrap();
  setInterest(Event.WRITE,Event.FLUSH,Event.CLOSE,Event.EXCEPTION);
  Channel clientChannel=cb.connect(addr).sync().channel();
  clientChannel.pipeline().addLast(new ChannelOutboundHandlerAdapter(){
    @Override public void flush(    ChannelHandlerContext ctx) throws Exception {
      throw new Exception("intentional failure");
    }
    @Override public void exceptionCaught(    ChannelHandlerContext ctx,    Throwable cause) throws Exception {
      ctx.close();
    }
  }
);
  try {
    clientChannel.writeAndFlush(createTestBuf(2000)).sync();
    fail();
  }
 catch (  Throwable cce) {
    assertEquals(ClosedChannelException.class,cce.getClass());
  }
  clientChannel.closeFuture().sync();
  assertLog("WRITE\nCLOSE\n");
}
