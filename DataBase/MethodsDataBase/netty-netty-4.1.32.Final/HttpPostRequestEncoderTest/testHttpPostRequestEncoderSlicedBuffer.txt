@Test public void testHttpPostRequestEncoderSlicedBuffer() throws Exception {
  DefaultFullHttpRequest request=new DefaultFullHttpRequest(HttpVersion.HTTP_1_1,HttpMethod.POST,"http://localhost");
  HttpPostRequestEncoder encoder=new HttpPostRequestEncoder(request,true);
  encoder.addBodyAttribute("getform","POST");
  encoder.addBodyAttribute("info","first value");
  encoder.addBodyAttribute("secondinfo","secondvalue a&");
  encoder.addBodyAttribute("thirdinfo","short text");
  int length=100000;
  char[] array=new char[length];
  Arrays.fill(array,'a');
  String longText=new String(array);
  encoder.addBodyAttribute("fourthinfo",longText.substring(0,7470));
  File file1=new File(getClass().getResource("/file-01.txt").toURI());
  encoder.addBodyFileUpload("myfile",file1,"application/x-zip-compressed",false);
  encoder.finalizeRequest();
  while (!encoder.isEndOfInput()) {
    HttpContent httpContent=encoder.readChunk((ByteBufAllocator)null);
    ByteBuf content=httpContent.content();
    int refCnt=content.refCnt();
    assertTrue("content: " + content + " content.unwrap(): "+ content.unwrap()+ " refCnt: "+ refCnt,(content.unwrap() == content || content.unwrap() == null) && refCnt == 1 || content.unwrap() != content && refCnt == 2);
    httpContent.release();
  }
  encoder.cleanFiles();
  encoder.close();
}
