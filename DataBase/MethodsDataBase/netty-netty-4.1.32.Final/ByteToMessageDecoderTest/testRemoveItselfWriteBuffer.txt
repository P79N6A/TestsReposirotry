@Test public void testRemoveItselfWriteBuffer(){
  final ByteBuf buf=Unpooled.buffer().writeBytes(new byte[]{'a','b','c'});
  EmbeddedChannel channel=new EmbeddedChannel(new ByteToMessageDecoder(){
    private boolean removed;
    @Override protected void decode(    ChannelHandlerContext ctx,    ByteBuf in,    List<Object> out) throws Exception {
      assertFalse(removed);
      in.readByte();
      ctx.pipeline().remove(this);
      buf.writeByte('d');
      removed=true;
    }
  }
);
  channel.writeInbound(buf.copy());
  ByteBuf expected=Unpooled.wrappedBuffer(new byte[]{'b','c'});
  ByteBuf b=channel.readInbound();
  assertEquals(expected,b);
  expected.release();
  buf.release();
  b.release();
}
