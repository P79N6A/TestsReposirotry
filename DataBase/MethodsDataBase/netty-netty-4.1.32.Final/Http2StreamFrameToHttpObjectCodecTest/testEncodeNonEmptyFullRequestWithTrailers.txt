@Test public void testEncodeNonEmptyFullRequestWithTrailers() throws Exception {
  EmbeddedChannel ch=new EmbeddedChannel(new Http2StreamFrameToHttpObjectCodec(false));
  ByteBuf hello=Unpooled.copiedBuffer("hello world",CharsetUtil.UTF_8);
  FullHttpRequest request=new DefaultFullHttpRequest(HttpVersion.HTTP_1_1,HttpMethod.PUT,"/hello/world",hello);
  HttpHeaders trailers=request.trailingHeaders();
  trailers.set("key","value");
  assertTrue(ch.writeOutbound(request));
  Http2HeadersFrame headersFrame=ch.readOutbound();
  Http2Headers headers=headersFrame.headers();
  assertThat(headers.scheme().toString(),is("http"));
  assertThat(headers.method().toString(),is("PUT"));
  assertThat(headers.path().toString(),is("/hello/world"));
  assertFalse(headersFrame.isEndStream());
  Http2DataFrame dataFrame=ch.readOutbound();
  try {
    assertThat(dataFrame.content().toString(CharsetUtil.UTF_8),is("hello world"));
    assertFalse(dataFrame.isEndStream());
  }
  finally {
    dataFrame.release();
  }
  Http2HeadersFrame trailersFrame=ch.readOutbound();
  assertThat(trailersFrame.headers().get("key").toString(),is("value"));
  assertTrue(trailersFrame.isEndStream());
  assertThat(ch.readOutbound(),is(nullValue()));
  assertFalse(ch.finish());
}
