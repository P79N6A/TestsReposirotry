@Test public void testAllocatingAroundBlockSize(){
  int blockSize=100;
  Lz4FrameEncoder encoder=newEncoder(blockSize,Lz4FrameEncoder.DEFAULT_MAX_ENCODE_SIZE);
  EmbeddedChannel channel=new EmbeddedChannel(encoder);
  int size=blockSize - 1;
  ByteBuf buf=ByteBufAllocator.DEFAULT.buffer(size,size);
  buf.writerIndex(size);
  Assert.assertEquals(0,encoder.getBackingBuffer().readableBytes());
  channel.write(buf);
  Assert.assertEquals(size,encoder.getBackingBuffer().readableBytes());
  int nextSize=size - 1;
  buf=ByteBufAllocator.DEFAULT.buffer(nextSize,nextSize);
  buf.writerIndex(nextSize);
  channel.write(buf);
  Assert.assertEquals(size + nextSize - blockSize,encoder.getBackingBuffer().readableBytes());
  channel.flush();
  Assert.assertEquals(0,encoder.getBackingBuffer().readableBytes());
  Assert.assertTrue(channel.finish());
  Assert.assertTrue(channel.releaseOutbound());
  Assert.assertFalse(channel.releaseInbound());
}
