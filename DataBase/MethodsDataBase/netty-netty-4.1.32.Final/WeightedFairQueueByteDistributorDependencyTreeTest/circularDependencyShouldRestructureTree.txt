@Test public void circularDependencyShouldRestructureTree() throws Exception {
  Http2Stream streamA=connection.local().createStream(1,false);
  Http2Stream streamB=connection.local().createStream(3,false);
  Http2Stream streamC=connection.local().createStream(5,false);
  Http2Stream streamD=connection.local().createStream(7,false);
  Http2Stream streamE=connection.local().createStream(9,false);
  Http2Stream streamF=connection.local().createStream(11,false);
  assertEquals(6,distributor.numChildren(connection.connectionStream().id()));
  assertEquals(0,distributor.numChildren(streamA.id()));
  assertEquals(0,distributor.numChildren(streamB.id()));
  assertEquals(0,distributor.numChildren(streamC.id()));
  assertEquals(0,distributor.numChildren(streamD.id()));
  assertEquals(0,distributor.numChildren(streamE.id()));
  assertEquals(0,distributor.numChildren(streamF.id()));
  setPriority(streamB.id(),streamA.id(),DEFAULT_PRIORITY_WEIGHT,false);
  assertEquals(5,distributor.numChildren(connection.connectionStream().id()));
  assertTrue(distributor.isChild(streamB.id(),streamA.id(),DEFAULT_PRIORITY_WEIGHT));
  assertEquals(1,distributor.numChildren(streamA.id()));
  setPriority(streamC.id(),streamA.id(),DEFAULT_PRIORITY_WEIGHT,false);
  assertEquals(4,distributor.numChildren(connection.connectionStream().id()));
  assertTrue(distributor.isChild(streamC.id(),streamA.id(),DEFAULT_PRIORITY_WEIGHT));
  assertEquals(2,distributor.numChildren(streamA.id()));
  setPriority(streamD.id(),streamC.id(),DEFAULT_PRIORITY_WEIGHT,false);
  assertEquals(3,distributor.numChildren(connection.connectionStream().id()));
  assertTrue(distributor.isChild(streamD.id(),streamC.id(),DEFAULT_PRIORITY_WEIGHT));
  assertEquals(1,distributor.numChildren(streamC.id()));
  setPriority(streamE.id(),streamC.id(),DEFAULT_PRIORITY_WEIGHT,false);
  assertEquals(2,distributor.numChildren(connection.connectionStream().id()));
  assertTrue(distributor.isChild(streamE.id(),streamC.id(),DEFAULT_PRIORITY_WEIGHT));
  assertEquals(2,distributor.numChildren(streamC.id()));
  setPriority(streamF.id(),streamD.id(),DEFAULT_PRIORITY_WEIGHT,false);
  assertEquals(1,distributor.numChildren(connection.connectionStream().id()));
  assertTrue(distributor.isChild(streamF.id(),streamD.id(),DEFAULT_PRIORITY_WEIGHT));
  assertEquals(1,distributor.numChildren(streamD.id()));
  assertEquals(6,connection.numActiveStreams());
  setPriority(streamA.id(),streamD.id(),DEFAULT_PRIORITY_WEIGHT,false);
  assertEquals(1,distributor.numChildren(connection.connectionStream().id()));
  assertTrue(distributor.isChild(streamD.id(),connection.connectionStream().id(),DEFAULT_PRIORITY_WEIGHT));
  assertEquals(2,distributor.numChildren(streamD.id()));
  assertTrue(distributor.isChild(streamF.id(),streamD.id(),DEFAULT_PRIORITY_WEIGHT));
  assertEquals(0,distributor.numChildren(streamF.id()));
  assertTrue(distributor.isChild(streamA.id(),streamD.id(),DEFAULT_PRIORITY_WEIGHT));
  assertEquals(2,distributor.numChildren(streamA.id()));
  assertTrue(distributor.isChild(streamB.id(),streamA.id(),DEFAULT_PRIORITY_WEIGHT));
  assertEquals(0,distributor.numChildren(streamB.id()));
  assertTrue(distributor.isChild(streamC.id(),streamA.id(),DEFAULT_PRIORITY_WEIGHT));
  assertEquals(1,distributor.numChildren(streamC.id()));
  assertTrue(distributor.isChild(streamE.id(),streamC.id(),DEFAULT_PRIORITY_WEIGHT));
  assertEquals(0,distributor.numChildren(streamE.id()));
}
