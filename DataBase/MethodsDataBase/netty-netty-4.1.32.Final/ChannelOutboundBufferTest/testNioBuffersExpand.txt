@Test public void testNioBuffersExpand(){
  TestChannel channel=new TestChannel();
  ChannelOutboundBuffer buffer=new ChannelOutboundBuffer(channel);
  ByteBuf buf=directBuffer().writeBytes("buf1".getBytes(CharsetUtil.US_ASCII));
  for (int i=0; i < 64; i++) {
    buffer.addMessage(buf.copy(),buf.readableBytes(),channel.voidPromise());
  }
  assertEquals("Should still be 0 as not flushed yet",0,buffer.nioBufferCount());
  buffer.addFlush();
  ByteBuffer[] buffers=buffer.nioBuffers();
  assertEquals(64,buffer.nioBufferCount());
  for (int i=0; i < buffer.nioBufferCount(); i++) {
    assertEquals(buffers[i],buf.internalNioBuffer(buf.readerIndex(),buf.readableBytes()));
  }
  release(buffer);
  buf.release();
}
