@Test public void testWritability(){
  final StringBuilder buf=new StringBuilder();
  EmbeddedChannel ch=new EmbeddedChannel(new ChannelInboundHandlerAdapter(){
    @Override public void channelWritabilityChanged(    ChannelHandlerContext ctx) throws Exception {
      buf.append(ctx.channel().isWritable());
      buf.append(' ');
    }
  }
);
  ch.config().setWriteBufferLowWaterMark(128 + ChannelOutboundBuffer.CHANNEL_OUTBOUND_BUFFER_ENTRY_OVERHEAD);
  ch.config().setWriteBufferHighWaterMark(256 + ChannelOutboundBuffer.CHANNEL_OUTBOUND_BUFFER_ENTRY_OVERHEAD);
  ch.write(buffer().writeZero(128));
  ch.write(buffer().writeZero(2));
  assertThat(buf.toString(),is(""));
  ch.unsafe().outboundBuffer().addFlush();
  ch.write(buffer().writeZero(127));
  assertThat(buf.toString(),is("false "));
  assertThat(ch.unsafe().outboundBuffer().remove(),is(true));
  assertThat(ch.unsafe().outboundBuffer().remove(),is(true));
  assertThat(ch.unsafe().outboundBuffer().totalPendingWriteBytes(),is(127L + ChannelOutboundBuffer.CHANNEL_OUTBOUND_BUFFER_ENTRY_OVERHEAD));
  assertThat(buf.toString(),is("false true "));
  safeClose(ch);
}
