@Test public void testNioBuffersExpand2(){
  TestChannel channel=new TestChannel();
  ChannelOutboundBuffer buffer=new ChannelOutboundBuffer(channel);
  CompositeByteBuf comp=compositeBuffer(256);
  ByteBuf buf=directBuffer().writeBytes("buf1".getBytes(CharsetUtil.US_ASCII));
  for (int i=0; i < 65; i++) {
    comp.addComponent(true,buf.copy());
  }
  buffer.addMessage(comp,comp.readableBytes(),channel.voidPromise());
  assertEquals("Should still be 0 as not flushed yet",0,buffer.nioBufferCount());
  buffer.addFlush();
  ByteBuffer[] buffers=buffer.nioBuffers();
  assertEquals(65,buffer.nioBufferCount());
  for (int i=0; i < buffer.nioBufferCount(); i++) {
    if (i < 65) {
      assertEquals(buffers[i],buf.internalNioBuffer(buf.readerIndex(),buf.readableBytes()));
    }
 else {
      assertNull(buffers[i]);
    }
  }
  release(buffer);
  buf.release();
}
