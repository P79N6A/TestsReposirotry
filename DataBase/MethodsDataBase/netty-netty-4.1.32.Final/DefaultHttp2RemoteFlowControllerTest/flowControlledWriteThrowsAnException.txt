@Test public void flowControlledWriteThrowsAnException() throws Exception {
  final Http2RemoteFlowController.FlowControlled flowControlled=mockedFlowControlledThatThrowsOnWrite();
  final Http2Stream stream=stream(STREAM_A);
  doAnswer(new Answer<Void>(){
    @Override public Void answer(    InvocationOnMock invocationOnMock){
      stream.closeLocalSide();
      return null;
    }
  }
).when(flowControlled).error(any(ChannelHandlerContext.class),any(Throwable.class));
  int windowBefore=window(STREAM_A);
  controller.addFlowControlled(stream,flowControlled);
  controller.writePendingBytes();
  verify(flowControlled,atLeastOnce()).write(any(ChannelHandlerContext.class),anyInt());
  verify(flowControlled).error(any(ChannelHandlerContext.class),any(Throwable.class));
  verify(flowControlled,never()).writeComplete();
  assertEquals(90,windowBefore - window(STREAM_A));
  verify(listener,times(1)).writabilityChanged(stream(STREAM_A));
  verify(listener,never()).writabilityChanged(stream(STREAM_B));
  verify(listener,never()).writabilityChanged(stream(STREAM_C));
  verify(listener,never()).writabilityChanged(stream(STREAM_D));
  assertFalse(controller.isWritable(stream(STREAM_A)));
  assertTrue(controller.isWritable(stream(STREAM_B)));
  assertTrue(controller.isWritable(stream(STREAM_C)));
  assertTrue(controller.isWritable(stream(STREAM_D)));
}
