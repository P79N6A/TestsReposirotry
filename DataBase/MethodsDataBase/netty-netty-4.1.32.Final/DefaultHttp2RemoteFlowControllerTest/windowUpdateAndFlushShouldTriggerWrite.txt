@Test public void windowUpdateAndFlushShouldTriggerWrite() throws Http2Exception {
  controller.initialWindowSize(10);
  verify(listener,never()).writabilityChanged(stream(STREAM_A));
  assertTrue(controller.isWritable(stream(STREAM_A)));
  FakeFlowControlled data=new FakeFlowControlled(20);
  FakeFlowControlled moreData=new FakeFlowControlled(10);
  sendData(STREAM_A,data);
  sendData(STREAM_A,moreData);
  controller.writePendingBytes();
  data.assertPartiallyWritten(10);
  moreData.assertNotWritten();
  verify(listener,times(1)).writabilityChanged(stream(STREAM_A));
  assertFalse(controller.isWritable(stream(STREAM_A)));
  reset(listener);
  resetCtx();
  incrementWindowSize(STREAM_A,15);
  verify(listener,never()).writabilityChanged(stream(STREAM_A));
  assertFalse(controller.isWritable(stream(STREAM_A)));
  reset(listener);
  controller.writePendingBytes();
  data.assertFullyWritten();
  moreData.assertPartiallyWritten(5);
  verify(listener,never()).writabilityChanged(stream(STREAM_A));
  assertFalse(controller.isWritable(stream(STREAM_A)));
  assertEquals(DEFAULT_WINDOW_SIZE - 25,window(CONNECTION_STREAM_ID));
  assertEquals(0,window(STREAM_A));
  assertEquals(10,window(STREAM_B));
  assertEquals(10,window(STREAM_C));
  assertEquals(10,window(STREAM_D));
}
