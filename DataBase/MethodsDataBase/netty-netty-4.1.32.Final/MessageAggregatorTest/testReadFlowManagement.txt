@SuppressWarnings("unchecked") @Test public void testReadFlowManagement() throws Exception {
  ReadCounter counter=new ReadCounter();
  ByteBufHolder first=message("first");
  ByteBufHolder chunk=message("chunk");
  ByteBufHolder last=message("last");
  MockMessageAggregator agg=spy(MockMessageAggregator.class);
  when(agg.isStartMessage(first)).thenReturn(true);
  when(agg.isContentMessage(chunk)).thenReturn(true);
  when(agg.isContentMessage(last)).thenReturn(true);
  when(agg.isLastContentMessage(last)).thenReturn(true);
  EmbeddedChannel embedded=new EmbeddedChannel(counter,agg);
  embedded.config().setAutoRead(false);
  assertFalse(embedded.writeInbound(first));
  assertFalse(embedded.writeInbound(chunk));
  assertTrue(embedded.writeInbound(last));
  assertEquals(3,counter.value);
  ByteBufHolder all=new DefaultByteBufHolder(Unpooled.wrappedBuffer(first.content().retain(),chunk.content().retain(),last.content().retain()));
  ByteBufHolder out=embedded.readInbound();
  assertEquals(all,out);
  assertTrue(all.release() && out.release());
  assertFalse(embedded.finish());
}
