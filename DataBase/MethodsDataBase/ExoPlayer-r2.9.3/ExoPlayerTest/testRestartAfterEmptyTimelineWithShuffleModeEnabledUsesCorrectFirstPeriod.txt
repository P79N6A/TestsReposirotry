@Test public void testRestartAfterEmptyTimelineWithShuffleModeEnabledUsesCorrectFirstPeriod() throws Exception {
  Timeline timeline=new FakeTimeline(1);
  FakeMediaSource mediaSource=new FakeMediaSource(timeline,null);
  ConcatenatingMediaSource concatenatingMediaSource=new ConcatenatingMediaSource(false,new FakeShuffleOrder(0));
  AtomicInteger windowIndexAfterAddingSources=new AtomicInteger();
  ActionSchedule actionSchedule=new ActionSchedule.Builder("testRestartAfterEmptyTimelineUsesCorrectFirstPeriod").setShuffleModeEnabled(true).waitForPlaybackState(Player.STATE_ENDED).executeRunnable(() -> concatenatingMediaSource.addMediaSources(Arrays.asList(mediaSource,mediaSource))).waitForTimelineChanged().executeRunnable(new PlayerRunnable(){
    @Override public void run(    SimpleExoPlayer player){
      windowIndexAfterAddingSources.set(player.getCurrentWindowIndex());
    }
  }
).build();
  new ExoPlayerTestRunner.Builder().setMediaSource(concatenatingMediaSource).setActionSchedule(actionSchedule).build(context).start().blockUntilActionScheduleFinished(TIMEOUT_MS).blockUntilEnded(TIMEOUT_MS);
  assertThat(windowIndexAfterAddingSources.get()).isEqualTo(1);
}
