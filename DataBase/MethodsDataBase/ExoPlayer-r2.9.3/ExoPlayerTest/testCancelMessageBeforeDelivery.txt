@Test public void testCancelMessageBeforeDelivery() throws Exception {
  Timeline timeline=new FakeTimeline(1);
  final PositionGrabbingMessageTarget target=new PositionGrabbingMessageTarget();
  final AtomicReference<PlayerMessage> message=new AtomicReference<>();
  ActionSchedule actionSchedule=new ActionSchedule.Builder("testCancelMessage").pause().waitForPlaybackState(Player.STATE_BUFFERING).executeRunnable(new PlayerRunnable(){
    @Override public void run(    SimpleExoPlayer player){
      message.set(player.createMessage(target).setPosition(50).send());
    }
  }
).playUntilPosition(0,30).executeRunnable(() -> message.get().cancel()).play().build();
  new Builder().setTimeline(timeline).setActionSchedule(actionSchedule).build(context).start().blockUntilEnded(TIMEOUT_MS);
  assertThat(message.get().isCanceled()).isTrue();
  assertThat(target.messageCount).isEqualTo(0);
}
