@Test public void testSendMessagesAtStartAndEndOfPeriod() throws Exception {
  Timeline timeline=new FakeTimeline(2);
  PositionGrabbingMessageTarget targetStartFirstPeriod=new PositionGrabbingMessageTarget();
  PositionGrabbingMessageTarget targetEndMiddlePeriod=new PositionGrabbingMessageTarget();
  PositionGrabbingMessageTarget targetStartMiddlePeriod=new PositionGrabbingMessageTarget();
  PositionGrabbingMessageTarget targetEndLastPeriod=new PositionGrabbingMessageTarget();
  long duration1Ms=timeline.getWindow(0,new Window()).getDurationMs();
  long duration2Ms=timeline.getWindow(1,new Window()).getDurationMs();
  ActionSchedule actionSchedule=new ActionSchedule.Builder("testSendMessages").pause().waitForPlaybackState(Player.STATE_BUFFERING).sendMessage(targetStartFirstPeriod,0,0).sendMessage(targetEndMiddlePeriod,0,duration1Ms).sendMessage(targetStartMiddlePeriod,1,0).sendMessage(targetEndLastPeriod,1,duration2Ms).play().waitForPlaybackState(Player.STATE_ENDED).prepareSource(new FakeMediaSource(timeline,null),false,true).waitForPlaybackState(Player.STATE_BUFFERING).waitForPlaybackState(Player.STATE_ENDED).build();
  new Builder().setTimeline(timeline).setActionSchedule(actionSchedule).build(context).start().blockUntilActionScheduleFinished(TIMEOUT_MS).blockUntilEnded(TIMEOUT_MS);
  assertThat(targetStartFirstPeriod.windowIndex).isEqualTo(0);
  assertThat(targetStartFirstPeriod.positionMs).isAtLeast(0L);
  assertThat(targetEndMiddlePeriod.windowIndex).isEqualTo(0);
  assertThat(targetEndMiddlePeriod.positionMs).isAtLeast(duration1Ms);
  assertThat(targetStartMiddlePeriod.windowIndex).isEqualTo(1);
  assertThat(targetStartMiddlePeriod.positionMs).isAtLeast(0L);
  assertThat(targetEndLastPeriod.windowIndex).isEqualTo(1);
  assertThat(targetEndLastPeriod.positionMs).isAtLeast(duration2Ms);
}
