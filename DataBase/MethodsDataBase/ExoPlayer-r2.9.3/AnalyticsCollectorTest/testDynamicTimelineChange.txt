@Test public void testDynamicTimelineChange() throws Exception {
  MediaSource childMediaSource=new FakeMediaSource(SINGLE_PERIOD_TIMELINE,null,Builder.VIDEO_FORMAT);
  final ConcatenatingMediaSource concatenatedMediaSource=new ConcatenatingMediaSource(childMediaSource,childMediaSource);
  long periodDurationMs=SINGLE_PERIOD_TIMELINE.getWindow(0,new Window()).getDurationMs();
  ActionSchedule actionSchedule=new ActionSchedule.Builder("AnalyticsCollectorTest").pause().waitForPlaybackState(Player.STATE_READY).playUntilPosition(0,periodDurationMs).executeRunnable(() -> concatenatedMediaSource.moveMediaSource(0,1)).waitForTimelineChanged().play().build();
  TestAnalyticsListener listener=runAnalyticsTest(concatenatedMediaSource,actionSchedule);
  populateEventIds(listener.lastReportedTimeline);
  assertThat(listener.getEvents(EVENT_PLAYER_STATE_CHANGED)).containsExactly(WINDOW_0,WINDOW_0,WINDOW_0,window0Period1Seq0,window0Period1Seq0,window0Period1Seq0,period1Seq0,period1Seq0,period1Seq0);
  assertThat(listener.getEvents(EVENT_TIMELINE_CHANGED)).containsExactly(WINDOW_0,period1Seq0);
  assertThat(listener.getEvents(EVENT_LOADING_CHANGED)).containsExactly(window0Period1Seq0,window0Period1Seq0,window0Period1Seq0,window0Period1Seq0);
  assertThat(listener.getEvents(EVENT_TRACKS_CHANGED)).containsExactly(window0Period1Seq0);
  assertThat(listener.getEvents(EVENT_LOAD_STARTED)).containsExactly(WINDOW_0,window0Period1Seq0,window1Period0Seq1);
  assertThat(listener.getEvents(EVENT_LOAD_COMPLETED)).containsExactly(WINDOW_0,window0Period1Seq0,window1Period0Seq1);
  assertThat(listener.getEvents(EVENT_DOWNSTREAM_FORMAT_CHANGED)).containsExactly(window0Period1Seq0,window1Period0Seq1);
  assertThat(listener.getEvents(EVENT_MEDIA_PERIOD_CREATED)).containsExactly(window0Period1Seq0,window1Period0Seq1);
  assertThat(listener.getEvents(EVENT_MEDIA_PERIOD_RELEASED)).containsExactly(window1Period0Seq1);
  assertThat(listener.getEvents(EVENT_READING_STARTED)).containsExactly(window0Period1Seq0,window1Period0Seq1);
  assertThat(listener.getEvents(EVENT_DECODER_ENABLED)).containsExactly(window0Period1Seq0,window0Period1Seq0);
  assertThat(listener.getEvents(EVENT_DECODER_INIT)).containsExactly(window0Period1Seq0,window1Period0Seq1);
  assertThat(listener.getEvents(EVENT_DECODER_FORMAT_CHANGED)).containsExactly(window0Period1Seq0,window1Period0Seq1);
  assertThat(listener.getEvents(EVENT_DECODER_DISABLED)).containsExactly(window0Period1Seq0);
  assertThat(listener.getEvents(EVENT_DROPPED_VIDEO_FRAMES)).containsExactly(window0Period1Seq0);
  assertThat(listener.getEvents(EVENT_VIDEO_SIZE_CHANGED)).containsExactly(window0Period1Seq0);
  assertThat(listener.getEvents(EVENT_RENDERED_FIRST_FRAME)).containsExactly(window0Period1Seq0);
  listener.assertNoMoreEvents();
}
