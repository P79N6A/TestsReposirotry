@Test public void testSwitchToCacheSourceWithReadOnlyCacheDataSource() throws Exception {
  FakeDataSource upstream=new FakeDataSource();
  FakeData fakeData=upstream.getDataSet().newDefaultData().appendReadData(1024 * 1024 - 1);
  fakeData.appendReadAction(() -> fail("Read from upstream shouldn't reach to the end of the data.")).appendReadData(1);
  CacheDataSource cacheDataSource=new CacheDataSource(cache,upstream,new FileDataSource(),null,0,null);
  DataSpec dataSpec=new DataSpec(testDataUri,0,C.LENGTH_UNSET,fixedCacheKey);
  cacheDataSource.open(dataSpec);
  byte[] buffer=new byte[1024];
  cacheDataSource.read(buffer,0,buffer.length);
  FakeDataSource upstream2=new FakeDataSource(new FakeDataSource().getDataSet().newDefaultData().appendReadData(1024 * 1024).endData());
  CacheUtil.cache(dataSpec,cache,upstream2,null,null);
  TestUtil.readToEnd(cacheDataSource);
  cacheDataSource.close();
}
