@Test public void testUnknownLengthContentReadInOneConnectionAndLengthIsResolved() throws Exception {
  FakeDataSource upstream=new FakeDataSource();
  upstream.getDataSet().newData(testDataUri).appendReadData(TEST_DATA).setSimulateUnknownLength(true);
  CacheDataSource cacheDataSource=new CacheDataSource(cache,upstream,0);
  int flags=DataSpec.FLAG_ALLOW_CACHING_UNKNOWN_LENGTH;
  cacheDataSource.open(new DataSpec(testDataUri,0,C.LENGTH_UNSET,expectedCacheKey,flags));
  TestUtil.readToEnd(cacheDataSource);
  cacheDataSource.close();
  assertThat(upstream.getAndClearOpenedDataSpecs()).hasLength(1);
  assertThat(cache.getContentLength(expectedCacheKey)).isEqualTo(TEST_DATA.length);
}
