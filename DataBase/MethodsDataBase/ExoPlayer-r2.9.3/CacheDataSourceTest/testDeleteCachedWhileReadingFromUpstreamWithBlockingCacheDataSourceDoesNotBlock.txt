@Test public void testDeleteCachedWhileReadingFromUpstreamWithBlockingCacheDataSourceDoesNotBlock() throws Exception {
  FakeDataSource upstream=new FakeDataSource();
  int dataLength=1024;
  upstream.getDataSet().newDefaultData().appendReadData(dataLength).endData();
  int halfDataLength=512;
  DataSpec dataSpec=new DataSpec(testDataUri,halfDataLength,C.LENGTH_UNSET,fixedCacheKey);
  CacheUtil.cache(dataSpec,cache,upstream,null,null);
  CacheDataSource cacheDataSource=new CacheDataSource(cache,upstream,CacheDataSource.FLAG_BLOCK_ON_CACHE);
  dataSpec=new DataSpec(testDataUri,0,C.LENGTH_UNSET,fixedCacheKey);
  cacheDataSource.open(dataSpec);
  TestUtil.readExactly(cacheDataSource,halfDataLength);
  NavigableSet<CacheSpan> cachedSpans=cache.getCachedSpans(expectedCacheKey);
  for (  CacheSpan cachedSpan : cachedSpans) {
    if (cachedSpan.position >= halfDataLength) {
      cache.removeSpan(cachedSpan);
    }
  }
  TestUtil.readToEnd(cacheDataSource);
  cacheDataSource.close();
}
