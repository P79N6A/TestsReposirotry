@Test public void testDuplicateNestedMediaSources() throws IOException, InterruptedException {
  Timeline childTimeline=new FakeTimeline(1);
  FakeMediaSource childSource=new FakeMediaSource(childTimeline,null);
  ConcatenatingMediaSource nestedConcatenation=new ConcatenatingMediaSource();
  testRunner.prepareSource();
  mediaSource.addMediaSources(Arrays.asList(childSource,nestedConcatenation,nestedConcatenation));
  testRunner.assertTimelineChangeBlocking();
  nestedConcatenation.addMediaSource(childSource);
  testRunner.assertTimelineChangeBlocking();
  nestedConcatenation.addMediaSource(childSource);
  Timeline timeline=testRunner.assertTimelineChangeBlocking();
  TimelineAsserts.assertPeriodCounts(timeline,1,1,1,1,1);
  testRunner.assertPrepareAndReleaseAllPeriods();
  Object childPeriodUid=childTimeline.getUidOfPeriod(0);
  assertThat(childSource.getCreatedMediaPeriods()).containsAllOf(new MediaPeriodId(childPeriodUid,0),new MediaPeriodId(childPeriodUid,1),new MediaPeriodId(childPeriodUid,2),new MediaPeriodId(childPeriodUid,3),new MediaPeriodId(childPeriodUid,4));
  testRunner.assertCompletedManifestLoads(0);
  assertCompletedAllMediaPeriodLoads(timeline);
  testRunner.releaseSource();
  childSource.assertReleased();
}
