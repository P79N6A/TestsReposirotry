@Test public void testPlaylistChangesAfterPreparation() throws IOException, InterruptedException {
  Timeline timeline=testRunner.prepareSource();
  TimelineAsserts.assertEmpty(timeline);
  FakeMediaSource[] childSources=createMediaSources(7);
  mediaSource.addMediaSource(childSources[0]);
  timeline=testRunner.assertTimelineChangeBlocking();
  TimelineAsserts.assertPeriodCounts(timeline,1);
  TimelineAsserts.assertWindowTags(timeline,111);
  mediaSource.addMediaSource(0,childSources[1]);
  timeline=testRunner.assertTimelineChangeBlocking();
  TimelineAsserts.assertPeriodCounts(timeline,2,1);
  TimelineAsserts.assertWindowTags(timeline,222,111);
  mediaSource.addMediaSource(childSources[2]);
  timeline=testRunner.assertTimelineChangeBlocking();
  TimelineAsserts.assertPeriodCounts(timeline,2,1,3);
  TimelineAsserts.assertWindowTags(timeline,222,111,333);
  mediaSource.addMediaSource(1,childSources[3]);
  timeline=testRunner.assertTimelineChangeBlocking();
  TimelineAsserts.assertPeriodCounts(timeline,2,4,1,3);
  TimelineAsserts.assertWindowTags(timeline,222,444,111,333);
  mediaSource.addMediaSources(3,Arrays.asList(childSources[4],childSources[5],childSources[6]));
  timeline=testRunner.assertTimelineChangeBlocking();
  TimelineAsserts.assertPeriodCounts(timeline,2,4,1,5,6,7,3);
  TimelineAsserts.assertWindowTags(timeline,222,444,111,555,666,777,333);
  mediaSource.moveMediaSource(2,3);
  timeline=testRunner.assertTimelineChangeBlocking();
  TimelineAsserts.assertPeriodCounts(timeline,2,4,5,1,6,7,3);
  TimelineAsserts.assertWindowTags(timeline,222,444,555,111,666,777,333);
  mediaSource.moveMediaSource(3,2);
  timeline=testRunner.assertTimelineChangeBlocking();
  TimelineAsserts.assertPeriodCounts(timeline,2,4,1,5,6,7,3);
  TimelineAsserts.assertWindowTags(timeline,222,444,111,555,666,777,333);
  mediaSource.moveMediaSource(0,6);
  timeline=testRunner.assertTimelineChangeBlocking();
  TimelineAsserts.assertPeriodCounts(timeline,4,1,5,6,7,3,2);
  TimelineAsserts.assertWindowTags(timeline,444,111,555,666,777,333,222);
  mediaSource.moveMediaSource(6,0);
  timeline=testRunner.assertTimelineChangeBlocking();
  TimelineAsserts.assertPeriodCounts(timeline,2,4,1,5,6,7,3);
  TimelineAsserts.assertWindowTags(timeline,222,444,111,555,666,777,333);
  mediaSource.removeMediaSource(3);
  testRunner.assertTimelineChangeBlocking();
  mediaSource.removeMediaSource(3);
  testRunner.assertTimelineChangeBlocking();
  mediaSource.removeMediaSource(3);
  testRunner.assertTimelineChangeBlocking();
  mediaSource.removeMediaSource(1);
  timeline=testRunner.assertTimelineChangeBlocking();
  TimelineAsserts.assertPeriodCounts(timeline,2,1,3);
  TimelineAsserts.assertWindowTags(timeline,222,111,333);
  for (int i=3; i <= 6; i++) {
    childSources[i].assertReleased();
  }
  testRunner.assertCompletedManifestLoads(0,0,2,1,3,4,5);
  TimelineAsserts.assertNextWindowIndices(timeline,Player.REPEAT_MODE_OFF,false,1,2,C.INDEX_UNSET);
  TimelineAsserts.assertNextWindowIndices(timeline,Player.REPEAT_MODE_ONE,false,0,1,2);
  TimelineAsserts.assertNextWindowIndices(timeline,Player.REPEAT_MODE_ALL,false,1,2,0);
  TimelineAsserts.assertPreviousWindowIndices(timeline,Player.REPEAT_MODE_OFF,false,C.INDEX_UNSET,0,1);
  TimelineAsserts.assertPreviousWindowIndices(timeline,Player.REPEAT_MODE_ONE,false,0,1,2);
  TimelineAsserts.assertPreviousWindowIndices(timeline,Player.REPEAT_MODE_ALL,false,2,0,1);
  assertThat(timeline.getFirstWindowIndex(false)).isEqualTo(0);
  assertThat(timeline.getLastWindowIndex(false)).isEqualTo(timeline.getWindowCount() - 1);
  TimelineAsserts.assertNextWindowIndices(timeline,Player.REPEAT_MODE_OFF,true,C.INDEX_UNSET,0,1);
  TimelineAsserts.assertNextWindowIndices(timeline,Player.REPEAT_MODE_ONE,true,0,1,2);
  TimelineAsserts.assertNextWindowIndices(timeline,Player.REPEAT_MODE_ALL,true,2,0,1);
  TimelineAsserts.assertPreviousWindowIndices(timeline,Player.REPEAT_MODE_OFF,true,1,2,C.INDEX_UNSET);
  TimelineAsserts.assertPreviousWindowIndices(timeline,Player.REPEAT_MODE_ONE,true,0,1,2);
  TimelineAsserts.assertPreviousWindowIndices(timeline,Player.REPEAT_MODE_ALL,true,1,2,0);
  assertThat(timeline.getFirstWindowIndex(true)).isEqualTo(timeline.getWindowCount() - 1);
  assertThat(timeline.getLastWindowIndex(true)).isEqualTo(0);
  testRunner.assertPrepareAndReleaseAllPeriods();
  assertCompletedAllMediaPeriodLoads(timeline);
  mediaSource.removeMediaSource(0);
  timeline=testRunner.assertTimelineChangeBlocking();
  TimelineAsserts.assertPeriodCounts(timeline,1,3);
  TimelineAsserts.assertWindowTags(timeline,111,333);
  childSources[1].assertReleased();
  mediaSource.removeMediaSource(1);
  timeline=testRunner.assertTimelineChangeBlocking();
  TimelineAsserts.assertPeriodCounts(timeline,1);
  TimelineAsserts.assertWindowTags(timeline,111);
  childSources[2].assertReleased();
  mediaSource.removeMediaSource(0);
  timeline=testRunner.assertTimelineChangeBlocking();
  TimelineAsserts.assertEmpty(timeline);
  childSources[3].assertReleased();
}
