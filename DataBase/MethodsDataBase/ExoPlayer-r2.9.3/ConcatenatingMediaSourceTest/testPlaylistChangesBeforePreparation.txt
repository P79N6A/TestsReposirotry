@Test public void testPlaylistChangesBeforePreparation() throws IOException, InterruptedException {
  FakeMediaSource[] childSources=createMediaSources(4);
  mediaSource.addMediaSource(childSources[0]);
  mediaSource.addMediaSource(childSources[1]);
  mediaSource.addMediaSource(0,childSources[2]);
  mediaSource.moveMediaSource(0,2);
  mediaSource.removeMediaSource(0);
  mediaSource.moveMediaSource(1,0);
  mediaSource.addMediaSource(1,childSources[3]);
  testRunner.assertNoTimelineChange();
  Timeline timeline=testRunner.prepareSource();
  TimelineAsserts.assertPeriodCounts(timeline,3,4,2);
  TimelineAsserts.assertWindowTags(timeline,333,444,222);
  TimelineAsserts.assertNextWindowIndices(timeline,Player.REPEAT_MODE_OFF,false,1,2,C.INDEX_UNSET);
  TimelineAsserts.assertPreviousWindowIndices(timeline,Player.REPEAT_MODE_OFF,false,C.INDEX_UNSET,0,1);
  TimelineAsserts.assertNextWindowIndices(timeline,Player.REPEAT_MODE_OFF,true,C.INDEX_UNSET,0,1);
  TimelineAsserts.assertPreviousWindowIndices(timeline,Player.REPEAT_MODE_OFF,true,1,2,C.INDEX_UNSET);
  testRunner.assertPrepareAndReleaseAllPeriods();
  testRunner.assertCompletedManifestLoads(0,1,2);
  assertCompletedAllMediaPeriodLoads(timeline);
  testRunner.releaseSource();
  for (int i=1; i < 4; i++) {
    childSources[i].assertReleased();
  }
}
