@Test public void testPlaylistWithLazyMediaSource() throws IOException, InterruptedException {
  FakeMediaSource[] fastSources=createMediaSources(2);
  final FakeMediaSource[] lazySources=new FakeMediaSource[4];
  for (int i=0; i < 4; i++) {
    lazySources[i]=new FakeMediaSource(null,null);
  }
  mediaSource.addMediaSource(lazySources[0]);
  mediaSource.addMediaSource(0,fastSources[0]);
  mediaSource.removeMediaSource(1);
  mediaSource.addMediaSource(1,lazySources[1]);
  testRunner.assertNoTimelineChange();
  Timeline timeline=testRunner.prepareSource();
  TimelineAsserts.assertPeriodCounts(timeline,1,1);
  TimelineAsserts.assertWindowTags(timeline,111,null);
  TimelineAsserts.assertWindowIsDynamic(timeline,false,true);
  testRunner.runOnPlaybackThread(() -> lazySources[1].setNewSourceInfo(createFakeTimeline(8),null));
  timeline=testRunner.assertTimelineChangeBlocking();
  TimelineAsserts.assertPeriodCounts(timeline,1,9);
  TimelineAsserts.assertWindowTags(timeline,111,999);
  TimelineAsserts.assertWindowIsDynamic(timeline,false,false);
  testRunner.assertPrepareAndReleaseAllPeriods();
  testRunner.assertCompletedManifestLoads(0,1);
  assertCompletedAllMediaPeriodLoads(timeline);
  mediaSource.addMediaSource(1,lazySources[2]);
  testRunner.assertTimelineChangeBlocking();
  mediaSource.addMediaSource(2,fastSources[1]);
  testRunner.assertTimelineChangeBlocking();
  mediaSource.addMediaSource(0,lazySources[3]);
  testRunner.assertTimelineChangeBlocking();
  mediaSource.removeMediaSource(2);
  timeline=testRunner.assertTimelineChangeBlocking();
  TimelineAsserts.assertPeriodCounts(timeline,1,1,2,9);
  TimelineAsserts.assertWindowTags(timeline,null,111,222,999);
  TimelineAsserts.assertWindowIsDynamic(timeline,true,false,false,false);
  MediaPeriod lazyPeriod=testRunner.createPeriod(new MediaPeriodId(timeline.getUidOfPeriod(0),0));
  CountDownLatch preparedCondition=testRunner.preparePeriod(lazyPeriod,0);
  assertThat(preparedCondition.getCount()).isEqualTo(1);
  MediaPeriod secondLazyPeriod=testRunner.createPeriod(new MediaPeriodId(timeline.getUidOfPeriod(0),0));
  testRunner.releasePeriod(secondLazyPeriod);
  testRunner.runOnPlaybackThread(() -> lazySources[3].setNewSourceInfo(createFakeTimeline(7),null));
  timeline=testRunner.assertTimelineChangeBlocking();
  TimelineAsserts.assertPeriodCounts(timeline,8,1,2,9);
  TimelineAsserts.assertWindowTags(timeline,888,111,222,999);
  TimelineAsserts.assertWindowIsDynamic(timeline,false,false,false,false);
  assertThat(preparedCondition.getCount()).isEqualTo(0);
  testRunner.releasePeriod(lazyPeriod);
  testRunner.releaseSource();
  for (  FakeMediaSource fastSource : fastSources) {
    fastSource.assertReleased();
  }
  for (  FakeMediaSource lazySource : lazySources) {
    lazySource.assertReleased();
  }
}
