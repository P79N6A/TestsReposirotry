@Test @SuppressWarnings("unchecked") public void testCleanupOnSuccess() throws Exception {
  WrappedContainer wc=null;
  try {
    wc=new WrappedContainer(11,314159265358979L,4344,"yak");
    wc.initContainer();
    wc.localizeResources();
    int running=metrics.getRunningContainers();
    wc.launchContainer();
    assertEquals(running + 1,metrics.getRunningContainers());
    reset(wc.localizerBus);
    wc.containerSuccessful();
    assertEquals(ContainerState.EXITED_WITH_SUCCESS,wc.c.getContainerState());
    assertNull(wc.c.getLocalizedResources());
    verifyCleanupCall(wc);
    int completed=metrics.getCompletedContainers();
    wc.containerResourcesCleanup();
    assertEquals(ContainerState.DONE,wc.c.getContainerState());
    assertEquals(completed + 1,metrics.getCompletedContainers());
    assertEquals(running,metrics.getRunningContainers());
    ContainerEventType e1=wc.initStateToEvent.get(ContainerState.NEW);
    ContainerState s2=wc.eventToFinalState.get(e1);
    ContainerEventType e2=wc.initStateToEvent.get(s2);
    ContainerState s3=wc.eventToFinalState.get(e2);
    ContainerEventType e3=wc.initStateToEvent.get(s3);
    ContainerState s4=wc.eventToFinalState.get(e3);
    ContainerEventType e4=wc.initStateToEvent.get(s4);
    ContainerState s5=wc.eventToFinalState.get(e4);
    ContainerEventType e5=wc.initStateToEvent.get(s5);
    ContainerState s6=wc.eventToFinalState.get(e5);
    Assert.assertEquals(ContainerState.LOCALIZING,s2);
    Assert.assertEquals(ContainerState.SCHEDULED,s3);
    Assert.assertEquals(ContainerState.RUNNING,s4);
    Assert.assertEquals(ContainerState.EXITED_WITH_SUCCESS,s5);
    Assert.assertEquals(ContainerState.DONE,s6);
    Assert.assertEquals(ContainerEventType.INIT_CONTAINER,e1);
    Assert.assertEquals(ContainerEventType.RESOURCE_LOCALIZED,e2);
    Assert.assertEquals(ContainerEventType.CONTAINER_LAUNCHED,e3);
    Assert.assertEquals(ContainerEventType.CONTAINER_EXITED_WITH_SUCCESS,e4);
    Assert.assertEquals(ContainerEventType.CONTAINER_RESOURCES_CLEANEDUP,e5);
  }
  finally {
    if (wc != null) {
      wc.finished();
    }
  }
}
