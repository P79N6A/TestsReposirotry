/** 
 * Tests that the # of missing block replicas and expected replicas is correct.
 * @throws IOException
 */
@Test public void testFsckMissingReplicas() throws IOException {
  final short replFactor=2;
  final short numReplicas=1;
  final short numBlocks=3;
  final long blockSize=512;
  conf.setLong(DFSConfigKeys.DFS_BLOCK_SIZE_KEY,blockSize);
  DistributedFileSystem dfs=null;
  File builderBaseDir=new File(GenericTestUtils.getRandomizedTempPath());
  cluster=new MiniDFSCluster.Builder(conf,builderBaseDir).numDataNodes(numReplicas).build();
  assertNotNull("Failed Cluster Creation",cluster);
  cluster.waitClusterUp();
  dfs=cluster.getFileSystem();
  assertNotNull("Failed to get FileSystem",dfs);
  final String pathString=new String("/testfile");
  final Path path=new Path(pathString);
  long fileLen=blockSize * numBlocks;
  DFSTestUtil.createFile(dfs,path,fileLen,replFactor,1);
  NameNode namenode=cluster.getNameNode();
  NetworkTopology nettop=cluster.getNamesystem().getBlockManager().getDatanodeManager().getNetworkTopology();
  Map<String,String[]> pmap=new HashMap<String,String[]>();
  Writer result=new StringWriter();
  PrintWriter out=new PrintWriter(result,true);
  InetAddress remoteAddress=InetAddress.getLocalHost();
  NamenodeFsck fsck=new NamenodeFsck(conf,namenode,nettop,pmap,out,numReplicas,remoteAddress);
  final HdfsFileStatus file=namenode.getRpcServer().getFileInfo(pathString);
  assertNotNull(file);
  Result replRes=new ReplicationResult(conf);
  Result ecRes=new ErasureCodingResult(conf);
  fsck.check(pathString,file,replRes,ecRes);
  System.out.println(result.toString());
  assertEquals(replRes.missingReplicas,(numBlocks * replFactor) - (numBlocks * numReplicas));
  assertEquals(replRes.numExpectedReplicas,numBlocks * replFactor);
}
