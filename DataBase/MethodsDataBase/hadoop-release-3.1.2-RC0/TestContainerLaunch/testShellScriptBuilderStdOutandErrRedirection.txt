/** 
 * Test that script exists with non-zero exit code when command fails.
 * @throws IOException
 */
@Test public void testShellScriptBuilderStdOutandErrRedirection() throws IOException {
  ShellScriptBuilder builder=ShellScriptBuilder.create();
  Path logDir=new Path(localLogDir.getAbsolutePath());
  File stdout=new File(logDir.toString(),ContainerLaunch.CONTAINER_PRE_LAUNCH_STDOUT);
  File stderr=new File(logDir.toString(),ContainerLaunch.CONTAINER_PRE_LAUNCH_STDERR);
  builder.stdout(logDir,ContainerLaunch.CONTAINER_PRE_LAUNCH_STDOUT);
  builder.stderr(logDir,ContainerLaunch.CONTAINER_PRE_LAUNCH_STDERR);
  String TEST_STDOUT_ECHO="Test stdout redirection";
  builder.echo(TEST_STDOUT_ECHO);
  builder.mkdir(new Path("/invalidSrcDir"));
  builder.command(Arrays.asList(new String[]{"unknownCommand"}));
  File shellFile=Shell.appendScriptExtension(tmpDir,"testShellScriptBuilderStdOutandErrRedirection");
  PrintStream writer=new PrintStream(new FileOutputStream(shellFile));
  builder.write(writer);
  writer.close();
  try {
    FileUtil.setExecutable(shellFile,true);
    Shell.ShellCommandExecutor shexc=new Shell.ShellCommandExecutor(new String[]{shellFile.getAbsolutePath()},tmpDir);
    try {
      shexc.execute();
      fail("builder shell command was expected to throw");
    }
 catch (    IOException e) {
      System.out.println("Received an expected exception: " + e.getMessage());
      Assert.assertEquals(true,stdout.exists());
      BufferedReader stdoutReader=new BufferedReader(new FileReader(stdout));
      String line=stdoutReader.readLine().trim();
      Assert.assertEquals(TEST_STDOUT_ECHO,line);
      Assert.assertEquals(null,stdoutReader.readLine());
      stdoutReader.close();
      Assert.assertEquals(true,stderr.exists());
      Assert.assertTrue(stderr.length() > 0);
    }
  }
  finally {
    FileUtil.fullyDelete(shellFile);
    FileUtil.fullyDelete(stdout);
    FileUtil.fullyDelete(stderr);
  }
}
