@Test(timeout=120000) public void testCloseWhileDecommission() throws IOException, ExecutionException, InterruptedException {
  LOG.info("Starting test testCloseWhileDecommission");
  getConf().setInt(DFSConfigKeys.DFS_NAMENODE_REPLICATION_MIN_KEY,2);
  startCluster(1,3);
  FileSystem fileSys=getCluster().getFileSystem(0);
  FSNamesystem ns=getCluster().getNamesystem(0);
  String openFile="/testDecommissionWithOpenfile.dat";
  writeFile(fileSys,new Path(openFile),(short)3);
  FSDataOutputStream fdos=fileSys.append(new Path(openFile));
  byte[] bytes=new byte[1];
  fdos.write(bytes);
  fdos.hsync();
  LocatedBlocks lbs=NameNodeAdapter.getBlockLocations(getCluster().getNameNode(0),openFile,0,fileSize);
  DatanodeInfo[] dnInfos4LastBlock=lbs.getLastLocatedBlock().getLocations();
  ArrayList<String> nodes=new ArrayList<String>();
  ArrayList<DatanodeInfo> dnInfos=new ArrayList<DatanodeInfo>();
  DatanodeManager dm=ns.getBlockManager().getDatanodeManager();
  nodes.add(dnInfos4LastBlock[0].getXferAddr());
  dnInfos.add(dm.getDatanode(dnInfos4LastBlock[0]));
  nodes.add(dnInfos4LastBlock[1].getXferAddr());
  dnInfos.add(dm.getDatanode(dnInfos4LastBlock[1]));
  initExcludeHosts(nodes);
  refreshNodes(0);
  fdos.close();
  BlockManagerTestUtil.recheckDecommissionState(dm);
  assertTrackedAndPending(dm.getDatanodeAdminManager(),2,0);
}
