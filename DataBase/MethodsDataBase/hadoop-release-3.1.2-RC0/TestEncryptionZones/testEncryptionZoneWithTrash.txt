@Test public void testEncryptionZoneWithTrash() throws Exception {
  final HdfsAdmin dfsAdmin=new HdfsAdmin(FileSystem.getDefaultUri(conf),conf);
  final Path zone1=new Path("/zone1");
  fs.mkdirs(zone1);
  dfsAdmin.createEncryptionZone(zone1,TEST_KEY,NO_TRASH);
  final Path encFile1=new Path(zone1,"encFile1");
  final int len=8192;
  DFSTestUtil.createFile(fs,encFile1,len,(short)1,0xFEED);
  Configuration clientConf=new Configuration(conf);
  clientConf.setLong(FS_TRASH_INTERVAL_KEY,1);
  FsShell shell=new FsShell(clientConf);
  verifyShellDeleteWithTrash(shell,encFile1);
  verifyShellDeleteWithTrash(shell,zone1);
  final Path topEZ=new Path("/topEZ");
  fs.mkdirs(topEZ);
  dfsAdmin.createEncryptionZone(topEZ,TEST_KEY,NO_TRASH);
  final String NESTED_EZ_TEST_KEY="nested_ez_test_key";
  DFSTestUtil.createKey(NESTED_EZ_TEST_KEY,cluster,conf);
  final Path nestedEZ=new Path(topEZ,"nestedEZ");
  fs.mkdirs(nestedEZ);
  dfsAdmin.createEncryptionZone(nestedEZ,NESTED_EZ_TEST_KEY,NO_TRASH);
  final Path topEZFile=new Path(topEZ,"file");
  final Path nestedEZFile=new Path(nestedEZ,"file");
  DFSTestUtil.createFile(fs,topEZFile,len,(short)1,0xFEED);
  DFSTestUtil.createFile(fs,nestedEZFile,len,(short)1,0xFEED);
  verifyShellDeleteWithTrash(shell,topEZFile);
  verifyShellDeleteWithTrash(shell,nestedEZFile);
  final WebHdfsFileSystem webFS=WebHdfsTestUtil.getWebHdfsFileSystem(conf,WebHdfsConstants.WEBHDFS_SCHEME);
  final String currentUser=UserGroupInformation.getCurrentUser().getShortUserName();
  final Path expectedTopTrash=new Path(topEZ,new Path(FileSystem.TRASH_PREFIX,currentUser));
  final Path expectedNestedTrash=new Path(nestedEZ,new Path(FileSystem.TRASH_PREFIX,currentUser));
  final Path topTrash=webFS.getTrashRoot(topEZFile);
  final Path nestedTrash=webFS.getTrashRoot(nestedEZFile);
  assertEquals(expectedTopTrash.toUri().getPath(),topTrash.toUri().getPath());
  assertEquals(expectedNestedTrash.toUri().getPath(),nestedTrash.toUri().getPath());
  verifyShellDeleteWithTrash(shell,nestedEZ);
  verifyShellDeleteWithTrash(shell,topEZ);
}
