@Test public void testBalanceDataBetweenMultiplePairsOfVolumes() throws Exception {
  Configuration conf=new HdfsConfiguration();
  conf.setBoolean(DFSConfigKeys.DFS_DISK_BALANCER_ENABLED,true);
  final int blockCount=1000;
  final int blockSize=1024;
  final int diskCount=3;
  final int dataNodeCount=1;
  final int dataNodeIndex=0;
  final int sourceDiskIndex=0;
  final long cap=blockSize * 2L * blockCount;
  MiniDFSCluster cluster=new ClusterBuilder().setBlockCount(blockCount).setBlockSize(blockSize).setDiskCount(diskCount).setNumDatanodes(dataNodeCount).setConf(conf).setCapacities(new long[]{cap,cap,cap}).build();
  try {
    DataMover dataMover=new DataMover(cluster,dataNodeIndex,sourceDiskIndex,conf,blockSize,blockCount);
    dataMover.moveDataToSourceDisk();
    NodePlan plan=dataMover.generatePlan();
    assertEquals(plan.getVolumeSetPlans().size(),2);
    dataMover.executePlan(plan);
    dataMover.verifyPlanExectionDone();
    dataMover.verifyAllVolumesHaveData(true);
    dataMover.verifyTolerance(plan,0,sourceDiskIndex,10);
  }
  finally {
    cluster.shutdown();
  }
}
