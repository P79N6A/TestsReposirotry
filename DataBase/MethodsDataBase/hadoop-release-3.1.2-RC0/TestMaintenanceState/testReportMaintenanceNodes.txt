@Test(timeout=120000) public void testReportMaintenanceNodes() throws Exception {
  ByteArrayOutputStream out=new ByteArrayOutputStream();
  ByteArrayOutputStream err=new ByteArrayOutputStream();
  System.setOut(new PrintStream(out));
  System.setErr(new PrintStream(err));
  LOG.info("Starting testReportMaintenanceNodes");
  int expirationInMs=30 * 1000;
  int numNodes=2;
  setMinMaintenanceR(numNodes);
  startCluster(1,numNodes);
  getCluster().waitActive();
  FileSystem fileSys=getCluster().getFileSystem(0);
  getConf().set(CommonConfigurationKeys.FS_DEFAULT_NAME_KEY,fileSys.getUri().toString());
  DFSAdmin dfsAdmin=new DFSAdmin(getConf());
  FSNamesystem fsn=getCluster().getNameNode().getNamesystem();
  assertEquals(numNodes,fsn.getNumLiveDataNodes());
  int ret=ToolRunner.run(dfsAdmin,new String[]{"-report","-enteringmaintenance","-inmaintenance"});
  assertEquals(0,ret);
  assertThat(out.toString(),is(allOf(containsString("Entering maintenance datanodes (0):"),containsString("In maintenance datanodes (0):"),not(containsString(getCluster().getDataNodes().get(0).getDisplayName())),not(containsString(getCluster().getDataNodes().get(1).getDisplayName())))));
  final Path file=new Path("/testReportMaintenanceNodes.dat");
  writeFile(fileSys,file,numNodes,1);
  DatanodeInfo[] nodes=getFirstBlockReplicasDatanodeInfos(fileSys,file);
  DatanodeInfo maintenanceDN=takeNodeOutofService(0,nodes[0].getDatanodeUuid(),Time.now() + expirationInMs,null,null,AdminStates.ENTERING_MAINTENANCE);
  assertEquals(1,fsn.getNumEnteringMaintenanceDataNodes());
  out.reset();
  err.reset();
  ret=ToolRunner.run(dfsAdmin,new String[]{"-report","-enteringmaintenance"});
  assertEquals(0,ret);
  assertThat(out.toString(),is(allOf(containsString("Entering maintenance datanodes (1):"),containsString(nodes[0].getXferAddr()),not(containsString(nodes[1].getXferAddr())))));
  out.reset();
  err.reset();
  getCluster().startDataNodes(getConf(),1,true,null,null);
  getCluster().waitActive();
  waitNodeState(maintenanceDN,AdminStates.IN_MAINTENANCE);
  assertEquals(1,fsn.getNumInMaintenanceLiveDataNodes());
  ret=ToolRunner.run(dfsAdmin,new String[]{"-report","-inmaintenance"});
  assertEquals(0,ret);
  assertThat(out.toString(),is(allOf(containsString("In maintenance datanodes (1):"),containsString(nodes[0].getXferAddr()),not(containsString(nodes[1].getXferAddr())),not(containsString(getCluster().getDataNodes().get(2).getDisplayName())))));
  cleanupFile(getCluster().getFileSystem(),file);
}
