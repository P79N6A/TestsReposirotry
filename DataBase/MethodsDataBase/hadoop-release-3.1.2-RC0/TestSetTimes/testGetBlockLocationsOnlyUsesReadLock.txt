/** 
 * Test that when access time updates are not needed, the FSNamesystem write lock is not taken by getBlockLocations. Regression test for HDFS-3981.
 */
@Test(timeout=60000) public void testGetBlockLocationsOnlyUsesReadLock() throws IOException {
  Configuration conf=new HdfsConfiguration();
  conf.setInt(DFSConfigKeys.DFS_NAMENODE_ACCESSTIME_PRECISION_KEY,100 * 1000);
  MiniDFSCluster cluster=new MiniDFSCluster.Builder(conf).numDataNodes(0).build();
  ReentrantReadWriteLock spyLock=NameNodeAdapter.spyOnFsLock(cluster.getNamesystem());
  try {
    Path p=new Path("/empty-file");
    DFSTestUtil.createFile(cluster.getFileSystem(),p,0,(short)1,0L);
    MockitoUtil.doThrowWhenCallStackMatches(new AssertionError("Should not need write lock"),".*getBlockLocations.*").when(spyLock).writeLock();
    cluster.getFileSystem().getFileBlockLocations(p,0,100);
  }
  finally {
    cluster.shutdown();
  }
}
