/** 
 * Test to suppress FSNameSystem write lock report when it is held for long time.
 */
@Test(timeout=45000) public void testFSWriteLockReportSuppressed() throws Exception {
  final long writeLockReportingThreshold=1L;
  final long writeLockSuppressWarningInterval=10L;
  Configuration conf=new Configuration();
  conf.setLong(DFSConfigKeys.DFS_NAMENODE_WRITE_LOCK_REPORTING_THRESHOLD_MS_KEY,writeLockReportingThreshold);
  conf.setTimeDuration(DFSConfigKeys.DFS_LOCK_SUPPRESS_WARNING_INTERVAL_KEY,writeLockSuppressWarningInterval,TimeUnit.MILLISECONDS);
  final FakeTimer timer=new FakeTimer();
  final FSNamesystemLock fsnLock=new FSNamesystemLock(conf,null,timer);
  timer.advance(writeLockSuppressWarningInterval);
  LogCapturer logs=LogCapturer.captureLogs(FSNamesystem.LOG);
  GenericTestUtils.setLogLevel(LoggerFactory.getLogger(FSNamesystem.class.getName()),org.slf4j.event.Level.INFO);
  fsnLock.writeLock();
  timer.advance(writeLockReportingThreshold + 100);
  fsnLock.writeUnlock();
  assertTrue(logs.getOutput().contains("FSNamesystem write lock held for"));
  logs.clearOutput();
  fsnLock.writeLock();
  timer.advance(writeLockReportingThreshold + 100);
  fsnLock.writeUnlock("testFSWriteLockReportSuppressed",true);
  assertFalse(logs.getOutput().contains(GenericTestUtils.getMethodName()));
  assertFalse(logs.getOutput().contains("Number of suppressed write-lock reports:"));
  assertFalse(logs.getOutput().contains("FSNamesystem write lock held for"));
}
