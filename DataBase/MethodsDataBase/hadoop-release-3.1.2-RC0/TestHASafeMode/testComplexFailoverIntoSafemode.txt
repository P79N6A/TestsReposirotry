/** 
 * Set up a namesystem with several edits, both deletions and additions, and failover to a new NN while that NN is in safemode. Ensure that it will exit safemode.
 */
@Test public void testComplexFailoverIntoSafemode() throws Exception {
  banner("Starting with NN0 active and NN1 standby, creating some blocks");
  DFSTestUtil.createFile(fs,new Path("/test"),3 * BLOCK_SIZE,(short)3,1L);
  nn0.getRpcServer().rollEditLog();
  banner("Creating some blocks that won't be in the edit log");
  DFSTestUtil.createFile(fs,new Path("/test2"),5 * BLOCK_SIZE,(short)3,1L);
  banner("Deleting the original blocks");
  fs.delete(new Path("/test"),true);
  banner("Restarting standby");
  restartStandby();
  assertSafeMode(nn1,3,3,3,0);
  banner("Initiating a failover into NN1 in safemode");
  NameNodeAdapter.abortEditLogs(nn0);
  cluster.transitionToActive(1);
  assertSafeMode(nn1,5,5,3,0);
}
