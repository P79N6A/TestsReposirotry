@Test public void testOverrideExternalConfiguration() throws IOException {
  Service orig=ExampleAppJson.loadResource(EXTERNAL_JSON_1);
  Configuration global=orig.getConfiguration();
  assertEquals(0,global.getProperties().size());
  assertEquals(3,orig.getComponents().size());
  Configuration simple=orig.getComponent("simple").getConfiguration();
  assertEquals(0,simple.getProperties().size());
  Configuration master=orig.getComponent("master").getConfiguration();
  assertEquals(1,master.getProperties().size());
  assertEquals("is-overridden",master.getProperty("g3"));
  Configuration other=orig.getComponent("other").getConfiguration();
  assertEquals(0,other.getProperties().size());
  SliderFileSystem sfs=ServiceTestUtils.initMockFs();
  Service ext=ExampleAppJson.loadResource(APP_JSON);
  ServiceApiUtil.validateAndResolveService(ext,sfs,new YarnConfiguration());
  sfs=ServiceTestUtils.initMockFs(ext);
  ServiceApiUtil.validateAndResolveService(orig,sfs,new YarnConfiguration());
  global=orig.getConfiguration();
  assertEquals(0,global.getProperties().size());
  assertEquals(4,orig.getComponents().size());
  simple=orig.getComponent("simple").getConfiguration();
  assertEquals(3,simple.getProperties().size());
  assertEquals("a",simple.getProperty("g1"));
  assertEquals("b",simple.getProperty("g2"));
  assertEquals("60",simple.getProperty("yarn.service.failure-count-reset.window"));
  master=orig.getComponent("master").getConfiguration();
  assertEquals(5,master.getProperties().size());
  assertEquals("512M",master.getProperty("jvm.heapsize"));
  assertEquals("overridden",master.getProperty("g1"));
  assertEquals("b",master.getProperty("g2"));
  assertEquals("is-overridden",master.getProperty("g3"));
  assertEquals("60",simple.getProperty("yarn.service.failure-count-reset.window"));
  Configuration worker=orig.getComponent("worker").getConfiguration();
  LOG.info("worker = {}",worker);
  assertEquals(4,worker.getProperties().size());
  assertEquals("512M",worker.getProperty("jvm.heapsize"));
  assertEquals("overridden-by-worker",worker.getProperty("g1"));
  assertEquals("b",worker.getProperty("g2"));
  assertEquals("60",worker.getProperty("yarn.service.failure-count-reset.window"));
  Resource workerResource=orig.getComponent("worker").getResource();
  Assert.assertEquals(1,workerResource.getCpus().intValue());
  Assert.assertEquals(1024,workerResource.calcMemoryMB());
  Assert.assertNotNull(workerResource.getAdditional());
  Assert.assertEquals(2,workerResource.getAdditional().size());
  Assert.assertEquals(3333,workerResource.getAdditional().get("resource-1").getValue().longValue());
  Assert.assertEquals("Gi",workerResource.getAdditional().get("resource-1").getUnit());
  Assert.assertEquals(5,workerResource.getAdditional().get("yarn.io/gpu").getValue().longValue());
  Assert.assertEquals("",workerResource.getAdditional().get("yarn.io/gpu").getUnit());
  other=orig.getComponent("other").getConfiguration();
  assertEquals(0,other.getProperties().size());
}
