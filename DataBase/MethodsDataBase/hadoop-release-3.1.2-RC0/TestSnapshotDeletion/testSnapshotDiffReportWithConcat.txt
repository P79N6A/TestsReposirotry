@Test public void testSnapshotDiffReportWithConcat() throws Exception {
  final Path st=new Path("/st");
  hdfs.mkdirs(st);
  hdfs.allowSnapshot(st);
  Path[] files=new Path[3];
  for (int i=0; i < 3; i++) {
    files[i]=new Path(st,i + ".txt");
  }
  Path dest=new Path(st,"dest.txt");
  hdfs.createNewFile(dest);
  hdfs.createSnapshot(st,"ss");
  for (int i=0; i < 3; i++) {
    for (int j=0; j < 3; j++) {
      FileSystem fs=cluster.getFileSystem();
      DFSTestUtil.createFile(fs,files[j],false,1024,1024,512,(short)1,RandomUtils.nextLong(1,512),true);
    }
    hdfs.concat(dest,files);
    hdfs.createSnapshot(st,"s" + i);
    SnapshotDiffReport sdr=hdfs.getSnapshotDiffReport(st,"s" + i,"ss");
    LOG.info("Snapshot Diff s{} to ss : {}",i,sdr);
    Assert.assertEquals(sdr.getDiffList().size(),1);
    Assert.assertTrue(sdr.getDiffList().get(0).getType() == SnapshotDiffReport.DiffType.MODIFY);
    Assert.assertTrue(new Path(st,DFSUtilClient.bytes2String(sdr.getDiffList().get(0).getSourcePath())).equals(dest));
  }
  hdfs.deleteSnapshot(st,"s1");
  hdfs.setSafeMode(SafeModeAction.SAFEMODE_ENTER);
  hdfs.saveNamespace();
  hdfs.setSafeMode(SafeModeAction.SAFEMODE_LEAVE);
  cluster.restartNameNodes();
}
