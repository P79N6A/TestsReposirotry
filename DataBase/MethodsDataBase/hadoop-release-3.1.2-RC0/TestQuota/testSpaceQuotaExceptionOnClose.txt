@Test public void testSpaceQuotaExceptionOnClose() throws Exception {
  GenericTestUtils.setLogLevel(DFSOutputStream.LOG,Level.TRACE);
  GenericTestUtils.setLogLevel(DataStreamer.LOG,Level.TRACE);
  final DFSAdmin dfsAdmin=new DFSAdmin(conf);
  final Path dir=new Path(PathUtils.getTestDir(getClass()).getPath(),GenericTestUtils.getMethodName());
  assertTrue(dfs.mkdirs(dir));
  final String[] args=new String[]{"-setSpaceQuota","1",dir.toString()};
  assertEquals(0,ToolRunner.run(dfsAdmin,args));
  final Path testFile=new Path(dir,"file");
  final FSDataOutputStream stream=dfs.create(testFile);
  stream.write("whatever".getBytes());
  try {
    stream.close();
    fail("close should fail");
  }
 catch (  DSQuotaExceededException expected) {
  }
  assertEquals(0,cluster.getNamesystem().getNumFilesUnderConstruction());
}
