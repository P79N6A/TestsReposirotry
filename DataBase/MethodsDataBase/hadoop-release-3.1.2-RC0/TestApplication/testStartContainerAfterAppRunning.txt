@Test @SuppressWarnings("unchecked") public void testStartContainerAfterAppRunning(){
  WrappedApplication wa=null;
  try {
    wa=new WrappedApplication(5,314159265358979L,"yak",4);
    wa.initApplication();
    wa.initContainer(0);
    assertEquals(ApplicationState.INITING,wa.app.getApplicationState());
    wa.applicationInited();
    assertEquals(ApplicationState.RUNNING,wa.app.getApplicationState());
    assertEquals(ApplicationState.RUNNING,wa.app.getApplicationState());
    assertEquals(1,wa.app.getContainers().size());
    wa.appFinished();
    verify(wa.containerBus).handle(argThat(new ContainerKillMatcher(wa.containers.get(0).getContainerId())));
    assertEquals(ApplicationState.FINISHING_CONTAINERS_WAIT,wa.app.getApplicationState());
    wa.initContainer(1);
    verify(wa.containerBus).handle(argThat(new ContainerKillMatcher(wa.containers.get(1).getContainerId())));
    assertEquals(ApplicationState.FINISHING_CONTAINERS_WAIT,wa.app.getApplicationState());
    wa.containerFinished(1);
    assertEquals(ApplicationState.FINISHING_CONTAINERS_WAIT,wa.app.getApplicationState());
    wa.containerFinished(0);
    assertEquals(ApplicationState.APPLICATION_RESOURCES_CLEANINGUP,wa.app.getApplicationState());
    verify(wa.localizerBus).handle(refEq(new ApplicationLocalizationEvent(LocalizationEventType.DESTROY_APPLICATION_RESOURCES,wa.app),"timestamp"));
    wa.initContainer(2);
    verify(wa.containerBus).handle(argThat(new ContainerKillMatcher(wa.containers.get(2).getContainerId())));
    assertEquals(ApplicationState.APPLICATION_RESOURCES_CLEANINGUP,wa.app.getApplicationState());
    wa.containerFinished(2);
    assertEquals(ApplicationState.APPLICATION_RESOURCES_CLEANINGUP,wa.app.getApplicationState());
    wa.appResourcesCleanedup();
    assertEquals(ApplicationState.FINISHED,wa.app.getApplicationState());
    wa.initContainer(3);
    verify(wa.containerBus).handle(argThat(new ContainerKillMatcher(wa.containers.get(3).getContainerId())));
    assertEquals(ApplicationState.FINISHED,wa.app.getApplicationState());
    wa.containerFinished(3);
    assertEquals(ApplicationState.FINISHED,wa.app.getApplicationState());
  }
  finally {
    if (wa != null)     wa.finished();
  }
}
