@Test public void testNMTokenStorage() throws IOException {
  RecoveredNMTokensState state=stateStore.loadNMTokensState();
  Map<ApplicationAttemptId,MasterKey> loadedAppKeys=loadNMTokens(state.getIterator());
  assertNull(state.getCurrentMasterKey());
  assertNull(state.getPreviousMasterKey());
  assertTrue(loadedAppKeys.isEmpty());
  NMTokenSecretManagerForTest secretMgr=new NMTokenSecretManagerForTest();
  MasterKey currentKey=secretMgr.generateKey();
  stateStore.storeNMTokenCurrentMasterKey(currentKey);
  restartStateStore();
  state=stateStore.loadNMTokensState();
  loadedAppKeys=loadNMTokens(state.getIterator());
  assertEquals(currentKey,state.getCurrentMasterKey());
  assertNull(state.getPreviousMasterKey());
  assertTrue(loadedAppKeys.isEmpty());
  MasterKey prevKey=secretMgr.generateKey();
  stateStore.storeNMTokenPreviousMasterKey(prevKey);
  restartStateStore();
  state=stateStore.loadNMTokensState();
  loadedAppKeys=loadNMTokens(state.getIterator());
  assertEquals(currentKey,state.getCurrentMasterKey());
  assertEquals(prevKey,state.getPreviousMasterKey());
  assertTrue(loadedAppKeys.isEmpty());
  ApplicationAttemptId attempt1=ApplicationAttemptId.newInstance(ApplicationId.newInstance(1,1),1);
  MasterKey attemptKey1=secretMgr.generateKey();
  stateStore.storeNMTokenApplicationMasterKey(attempt1,attemptKey1);
  ApplicationAttemptId attempt2=ApplicationAttemptId.newInstance(ApplicationId.newInstance(2,3),4);
  MasterKey attemptKey2=secretMgr.generateKey();
  stateStore.storeNMTokenApplicationMasterKey(attempt2,attemptKey2);
  restartStateStore();
  state=stateStore.loadNMTokensState();
  loadedAppKeys=loadNMTokens(state.getIterator());
  assertEquals(currentKey,state.getCurrentMasterKey());
  assertEquals(prevKey,state.getPreviousMasterKey());
  assertEquals(2,loadedAppKeys.size());
  assertEquals(attemptKey1,loadedAppKeys.get(attempt1));
  assertEquals(attemptKey2,loadedAppKeys.get(attempt2));
  ApplicationAttemptId attempt3=ApplicationAttemptId.newInstance(ApplicationId.newInstance(5,6),7);
  MasterKey attemptKey3=secretMgr.generateKey();
  stateStore.storeNMTokenApplicationMasterKey(attempt3,attemptKey3);
  stateStore.removeNMTokenApplicationMasterKey(attempt1);
  attemptKey2=prevKey;
  stateStore.storeNMTokenApplicationMasterKey(attempt2,attemptKey2);
  prevKey=currentKey;
  stateStore.storeNMTokenPreviousMasterKey(prevKey);
  currentKey=secretMgr.generateKey();
  stateStore.storeNMTokenCurrentMasterKey(currentKey);
  restartStateStore();
  state=stateStore.loadNMTokensState();
  loadedAppKeys=loadNMTokens(state.getIterator());
  assertEquals(currentKey,state.getCurrentMasterKey());
  assertEquals(prevKey,state.getPreviousMasterKey());
  assertEquals(2,loadedAppKeys.size());
  assertNull(loadedAppKeys.get(attempt1));
  assertEquals(attemptKey2,loadedAppKeys.get(attempt2));
  assertEquals(attemptKey3,loadedAppKeys.get(attempt3));
}
