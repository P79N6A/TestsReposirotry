@Test public void testTempContainerAllocations() throws InvalidAllocationTagsQueryException {
  AllocationTagsManager atm=new AllocationTagsManager(rmContext);
  LocalAllocationTagsManager ephAtm=new LocalAllocationTagsManager(atm);
  ephAtm.addTempTags(NodeId.fromString("host1:123"),TestUtils.getMockApplicationId(1),ImmutableSet.of("mapper","reducer"));
  atm.addContainer(NodeId.fromString("host1:123"),TestUtils.getMockContainerId(1,2),ImmutableSet.of("service"));
  atm.addContainer(NodeId.fromString("host2:123"),TestUtils.getMockContainerId(1,3),ImmutableSet.of("reducer"));
  ephAtm.addTempTags(NodeId.fromString("host2:123"),TestUtils.getMockApplicationId(2),ImmutableSet.of("service"));
  Assert.assertEquals(1,atm.getNodeCardinalityByOp(NodeId.fromString("host1:123"),AllocationTags.createSingleAppAllocationTags(TestUtils.getMockApplicationId(1),ImmutableSet.of("mapper")),Long::sum));
  Assert.assertEquals(1,atm.getNodeCardinalityByOp(NodeId.fromString("host1:123"),AllocationTags.createSingleAppAllocationTags(TestUtils.getMockApplicationId(1),ImmutableSet.of("service")),Long::sum));
  Assert.assertEquals(1,atm.getNodeCardinalityByOp(NodeId.fromString("host2:123"),AllocationTags.createSingleAppAllocationTags(TestUtils.getMockApplicationId(2),ImmutableSet.of("service")),Long::sum));
  ephAtm.cleanTempContainers(TestUtils.getMockApplicationId(2));
  Assert.assertEquals(0,atm.getNodeCardinalityByOp(NodeId.fromString("host2:123"),AllocationTags.createSingleAppAllocationTags(TestUtils.getMockApplicationId(2),ImmutableSet.of("service")),Long::sum));
  Assert.assertEquals(1,atm.getNodeCardinalityByOp(NodeId.fromString("host1:123"),AllocationTags.createSingleAppAllocationTags(TestUtils.getMockApplicationId(1),ImmutableSet.of("mapper")),Long::sum));
  ephAtm.cleanTempContainers(TestUtils.getMockApplicationId(1));
  Assert.assertEquals(0,atm.getNodeCardinalityByOp(NodeId.fromString("host1:123"),AllocationTags.createSingleAppAllocationTags(TestUtils.getMockApplicationId(1),ImmutableSet.of("mapper")),Long::sum));
  Assert.assertEquals(1,atm.getNodeCardinalityByOp(NodeId.fromString("host1:123"),AllocationTags.createSingleAppAllocationTags(TestUtils.getMockApplicationId(1),ImmutableSet.of("service")),Long::sum));
  Assert.assertEquals(0,atm.getNodeCardinalityByOp(NodeId.fromString("host2:123"),AllocationTags.createSingleAppAllocationTags(TestUtils.getMockApplicationId(2),ImmutableSet.of("service")),Long::sum));
  Assert.assertEquals(2,atm.getPerAppNodeMappings().get(TestUtils.getMockApplicationId(1)).getTypeToTagsWithCount().size());
  Assert.assertNull(atm.getPerAppNodeMappings().get(TestUtils.getMockApplicationId(2)));
}
