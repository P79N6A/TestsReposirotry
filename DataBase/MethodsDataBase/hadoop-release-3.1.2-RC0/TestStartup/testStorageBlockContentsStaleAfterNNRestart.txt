/** 
 * Verify the following scenario. 1. NN restarts. 2. Heartbeat RPC will retry and succeed. NN asks DN to reregister. 3. After reregistration completes, DN will send Heartbeat, followed by Blockreport. 4. NN will mark DatanodeStorageInfo#blockContentsStale to false.
 * @throws Exception
 */
@Test(timeout=60000) public void testStorageBlockContentsStaleAfterNNRestart() throws Exception {
  MiniDFSCluster dfsCluster=null;
  try {
    Configuration config=new Configuration();
    dfsCluster=new MiniDFSCluster.Builder(config).numDataNodes(1).build();
    dfsCluster.waitActive();
    dfsCluster.restartNameNode(true);
    BlockManagerTestUtil.checkHeartbeat(dfsCluster.getNamesystem().getBlockManager());
    MBeanServer mbs=ManagementFactory.getPlatformMBeanServer();
    ObjectName mxbeanNameFsns=new ObjectName("Hadoop:service=NameNode,name=FSNamesystemState");
    Integer numStaleStorages=(Integer)(mbs.getAttribute(mxbeanNameFsns,"NumStaleStorages"));
    assertEquals(0,numStaleStorages.intValue());
  }
  finally {
    if (dfsCluster != null) {
      dfsCluster.shutdown();
    }
  }
  return;
}
