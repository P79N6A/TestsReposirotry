@Test public void testMetaSaveMissingReplicas() throws Exception {
  List<DatanodeStorageInfo> origStorages=getStorages(0,1);
  List<DatanodeDescriptor> origNodes=getNodes(origStorages);
  BlockInfo block=makeBlockReplicasMissing(0,origNodes);
  File file=new File("test.log");
  PrintWriter out=new PrintWriter(file);
  bm.metaSave(out);
  out.flush();
  FileInputStream fstream=new FileInputStream(file);
  DataInputStream in=new DataInputStream(fstream);
  BufferedReader reader=new BufferedReader(new InputStreamReader(in));
  StringBuffer buffer=new StringBuffer();
  String line;
  try {
    while ((line=reader.readLine()) != null) {
      buffer.append(line);
    }
    String output=buffer.toString();
    assertTrue("Metasave output should have reported missing blocks.",output.contains("Metasave: Blocks currently missing: 1"));
    assertTrue("There should be 0 blocks waiting for reconstruction",output.contains("Metasave: Blocks waiting for reconstruction: 0"));
    String blockNameGS=block.getBlockName() + "_" + block.getGenerationStamp();
    assertTrue("Block " + blockNameGS + " should be MISSING.",output.contains(blockNameGS + " MISSING"));
  }
  finally {
    reader.close();
    file.delete();
  }
}
