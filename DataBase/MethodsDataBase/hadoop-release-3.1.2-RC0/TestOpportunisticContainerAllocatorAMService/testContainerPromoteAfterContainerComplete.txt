@Test(timeout=600000) public void testContainerPromoteAfterContainerComplete() throws Exception {
  HashMap<NodeId,MockNM> nodes=new HashMap<>();
  MockNM nm1=new MockNM("h1:1234",4096,rm.getResourceTrackerService());
  nodes.put(nm1.getNodeId(),nm1);
  MockNM nm2=new MockNM("h2:1234",4096,rm.getResourceTrackerService());
  nodes.put(nm2.getNodeId(),nm2);
  nm1.registerNode();
  nm2.registerNode();
  OpportunisticContainerAllocatorAMService amservice=(OpportunisticContainerAllocatorAMService)rm.getApplicationMasterService();
  RMApp app1=rm.submitApp(1 * GB,"app","user",null,"default");
  ApplicationAttemptId attemptId=app1.getCurrentAppAttempt().getAppAttemptId();
  MockAM am1=MockRM.launchAndRegisterAM(app1,rm,nm2);
  ResourceScheduler scheduler=rm.getResourceScheduler();
  RMNode rmNode1=rm.getRMContext().getRMNodes().get(nm1.getNodeId());
  RMNode rmNode2=rm.getRMContext().getRMNodes().get(nm2.getNodeId());
  nm1.nodeHeartbeat(true);
  nm2.nodeHeartbeat(true);
  ((RMNodeImpl)rmNode1).setOpportunisticContainersStatus(getOppurtunisticStatus(-1,100));
  ((RMNodeImpl)rmNode2).setOpportunisticContainersStatus(getOppurtunisticStatus(-1,100));
  OpportunisticContainerContext ctxt=((CapacityScheduler)scheduler).getApplicationAttempt(attemptId).getOpportunisticContainerContext();
  amservice.handle(new NodeAddedSchedulerEvent(rmNode1));
  amservice.handle(new NodeAddedSchedulerEvent(rmNode2));
  amservice.handle(new NodeUpdateSchedulerEvent(rmNode1));
  amservice.handle(new NodeUpdateSchedulerEvent(rmNode2));
  nm1.nodeHeartbeat(true);
  nm2.nodeHeartbeat(true);
  Thread.sleep(1000);
  QueueMetrics metrics=((CapacityScheduler)scheduler).getRootQueue().getMetrics();
  verifyMetrics(metrics,7168,7,1024,1,1);
  AllocateResponse allocateResponse=am1.allocate(Arrays.asList(ResourceRequest.newInstance(Priority.newInstance(1),"*",Resources.createResource(1 * GB),2,true,null,ExecutionTypeRequest.newInstance(ExecutionType.OPPORTUNISTIC,true))),null);
  List<Container> allocatedContainers=allocateResponse.getAllocatedContainers();
  Assert.assertEquals(2,allocatedContainers.size());
  Container container=allocatedContainers.get(0);
  MockNM allocNode=nodes.get(container.getNodeId());
  allocNode.nodeHeartbeat(Arrays.asList(ContainerStatus.newInstance(container.getId(),ExecutionType.OPPORTUNISTIC,ContainerState.RUNNING,"",0)),true);
  rm.drainEvents();
  RMContainer rmContainer=((CapacityScheduler)scheduler).getApplicationAttempt(container.getId().getApplicationAttemptId()).getRMContainer(container.getId());
  Assert.assertEquals(RMContainerState.RUNNING,rmContainer.getState());
  allocNode.nodeHeartbeat(Arrays.asList(ContainerStatus.newInstance(container.getId(),ExecutionType.OPPORTUNISTIC,ContainerState.COMPLETE,"",0)),true);
  rm.drainEvents();
  rmContainer=((CapacityScheduler)scheduler).getApplicationAttempt(container.getId().getApplicationAttemptId()).getRMContainer(container.getId());
  Assert.assertNull(rmContainer);
  verifyMetrics(metrics,7168,7,1024,1,1);
  allocateResponse=am1.sendContainerUpdateRequest(Arrays.asList(UpdateContainerRequest.newInstance(0,container.getId(),ContainerUpdateType.PROMOTE_EXECUTION_TYPE,null,ExecutionType.GUARANTEED)));
  Assert.assertEquals(1,allocateResponse.getCompletedContainersStatuses().size());
  Assert.assertEquals(container.getId(),allocateResponse.getCompletedContainersStatuses().get(0).getContainerId());
  Assert.assertEquals(0,allocateResponse.getUpdatedContainers().size());
  Assert.assertEquals(1,allocateResponse.getUpdateErrors().size());
  Assert.assertEquals("INVALID_CONTAINER_ID",allocateResponse.getUpdateErrors().get(0).getReason());
  Assert.assertEquals(container.getId(),allocateResponse.getUpdateErrors().get(0).getUpdateContainerRequest().getContainerId());
  verifyMetrics(metrics,7168,7,1024,1,1);
}
