/** 
 * Regression test for HDFS-2742. The issue in this bug was: - DN does a block report while file is open. This BR contains the block in RBW state. - Standby queues the RBW state in PendingDatanodeMessages - Standby processes edit logs during failover. Before fixing this bug, it was mistakenly applying the RBW reported state after the block had been completed, causing the block to get marked corrupt. Instead, we should now be applying the RBW message on OP_ADD, and then the FINALIZED message on OP_CLOSE.
 */
@Test public void testBlockReportsWhileFileBeingWritten() throws Exception {
  FSDataOutputStream out=fs.create(TEST_FILE_PATH);
  try {
    AppendTestUtil.write(out,0,10);
    out.hflush();
    cluster.triggerBlockReports();
  }
  finally {
    IOUtils.closeStream(out);
  }
  cluster.transitionToStandby(0);
  cluster.transitionToActive(1);
  BlockManagerTestUtil.updateState(nn1.getNamesystem().getBlockManager());
  BlockManagerTestUtil.updateState(nn2.getNamesystem().getBlockManager());
  assertEquals(0,nn1.getNamesystem().getCorruptReplicaBlocks());
  assertEquals(0,nn2.getNamesystem().getCorruptReplicaBlocks());
  DFSTestUtil.readFile(fs,TEST_FILE_PATH);
}
