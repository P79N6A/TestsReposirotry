@Test(timeout=120000) public void testCopyCommandsWithRawXAttrs() throws Exception {
  FsShell shell=null;
  final String testdir="/tmp/TestDFSShell-testCopyCommandsWithRawXAttrs-" + counter.getAndIncrement();
  final Path hdfsTestDir=new Path(testdir);
  final Path rawHdfsTestDir=new Path("/.reserved/raw" + testdir);
  try {
    dfs.mkdirs(hdfsTestDir);
    final Path src=new Path(hdfsTestDir,"srcfile");
    final String rawSrcBase="/.reserved/raw" + testdir;
    final Path rawSrc=new Path(rawSrcBase,"srcfile");
    dfs.create(src).close();
    final Path srcDir=new Path(hdfsTestDir,"srcdir");
    final Path rawSrcDir=new Path("/.reserved/raw" + testdir,"srcdir");
    dfs.mkdirs(srcDir);
    final Path srcDirFile=new Path(srcDir,"srcfile");
    final Path rawSrcDirFile=new Path("/.reserved/raw" + srcDirFile);
    dfs.create(srcDirFile).close();
    final Path[] paths={rawSrc,rawSrcDir,rawSrcDirFile};
    final String[] xattrNames={USER_A1,RAW_A1};
    final byte[][] xattrVals={USER_A1_VALUE,RAW_A1_VALUE};
    for (int i=0; i < paths.length; i++) {
      for (int j=0; j < xattrNames.length; j++) {
        dfs.setXAttr(paths[i],xattrNames[j],xattrVals[j]);
      }
    }
    shell=new FsShell(dfs.getConf());
    doTestCopyCommandsWithRawXAttrs(shell,dfs,src,hdfsTestDir,false);
    doTestCopyCommandsWithRawXAttrs(shell,dfs,rawSrc,hdfsTestDir,false);
    doTestCopyCommandsWithRawXAttrs(shell,dfs,src,rawHdfsTestDir,false);
    doTestCopyCommandsWithRawXAttrs(shell,dfs,rawSrc,rawHdfsTestDir,true);
    final Path savedWd=dfs.getWorkingDirectory();
    try {
      dfs.setWorkingDirectory(new Path(rawSrcBase));
      final Path relRawSrc=new Path("../srcfile");
      final Path relRawHdfsTestDir=new Path("..");
      doTestCopyCommandsWithRawXAttrs(shell,dfs,relRawSrc,relRawHdfsTestDir,true);
    }
  finally {
      dfs.setWorkingDirectory(savedWd);
    }
    doTestCopyCommandsWithRawXAttrs(shell,dfs,srcDir,hdfsTestDir,false);
    doTestCopyCommandsWithRawXAttrs(shell,dfs,rawSrcDir,hdfsTestDir,false);
    doTestCopyCommandsWithRawXAttrs(shell,dfs,srcDir,rawHdfsTestDir,false);
    doTestCopyCommandsWithRawXAttrs(shell,dfs,rawSrcDir,rawHdfsTestDir,true);
    final String relRawSrcDir="./.reserved/../.reserved/raw/../raw" + testdir + "/srcdir";
    final String relRawDstDir="./.reserved/../.reserved/raw/../raw" + testdir;
    doTestCopyCommandsWithRawXAttrs(shell,dfs,new Path(relRawSrcDir),new Path(relRawDstDir),true);
  }
  finally {
    if (null != shell) {
      shell.close();
    }
    dfs.delete(hdfsTestDir,true);
  }
}
