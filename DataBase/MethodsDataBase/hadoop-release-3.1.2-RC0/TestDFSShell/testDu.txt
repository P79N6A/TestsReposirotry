@Test(timeout=30000) public void testDu() throws IOException {
  int replication=2;
  PrintStream psBackup=System.out;
  ByteArrayOutputStream out=new ByteArrayOutputStream();
  PrintStream psOut=new PrintStream(out);
  System.setOut(psOut);
  FsShell shell=new FsShell(dfs.getConf());
  try {
    final Path myPath=new Path("/testDu","dir");
    assertTrue(dfs.mkdirs(myPath));
    assertTrue(dfs.exists(myPath));
    final Path myFile=new Path(myPath,"file");
    writeFile(dfs,myFile);
    assertTrue(dfs.exists(myFile));
    final Path myFile2=new Path(myPath,"file2");
    writeFile(dfs,myFile2);
    assertTrue(dfs.exists(myFile2));
    Long myFileLength=dfs.getFileStatus(myFile).getLen();
    Long myFileDiskUsed=myFileLength * replication;
    Long myFile2Length=dfs.getFileStatus(myFile2).getLen();
    Long myFile2DiskUsed=myFile2Length * replication;
    String[] args=new String[2];
    args[0]="-du";
    args[1]=myPath.toString();
    int val=-1;
    try {
      val=shell.run(args);
    }
 catch (    Exception e) {
      System.err.println("Exception raised from DFSShell.run " + e.getLocalizedMessage());
    }
    assertTrue(val == 0);
    String returnString=out.toString();
    out.reset();
    assertThat(returnString,containsString(myFileLength.toString()));
    assertThat(returnString,containsString(myFileDiskUsed.toString()));
    assertThat(returnString,containsString(myFile2Length.toString()));
    assertThat(returnString,containsString(myFile2DiskUsed.toString()));
    String snapshotName="ss1";
    Path snapshotPath=new Path(myPath,".snapshot/" + snapshotName);
    dfs.allowSnapshot(myPath);
    assertThat(dfs.createSnapshot(myPath,snapshotName),is(snapshotPath));
    assertThat(dfs.delete(myFile,false),is(true));
    assertThat(dfs.exists(myFile),is(false));
    args=new String[3];
    args[0]="-du";
    args[1]="-s";
    args[2]=snapshotPath.toString();
    val=-1;
    try {
      val=shell.run(args);
    }
 catch (    Exception e) {
      System.err.println("Exception raised from DFSShell.run " + e.getLocalizedMessage());
    }
    assertThat(val,is(0));
    returnString=out.toString();
    out.reset();
    Long combinedLength=myFileLength + myFile2Length;
    Long combinedDiskUsed=myFileDiskUsed + myFile2DiskUsed;
    assertThat(returnString,containsString(combinedLength.toString()));
    assertThat(returnString,containsString(combinedDiskUsed.toString()));
    final Path myFile3=new Path(myPath,"file3");
    writeByte(dfs,myFile3);
    assertTrue(dfs.exists(myFile3));
    args=new String[3];
    args[0]="-du";
    args[1]=myFile3.toString();
    args[2]=myFile2.toString();
    val=-1;
    try {
      val=shell.run(args);
    }
 catch (    Exception e) {
      System.err.println("Exception raised from DFSShell.run " + e.getLocalizedMessage());
    }
    assertEquals("Return code should be 0.",0,val);
    returnString=out.toString();
    out.reset();
    assertTrue(returnString.contains("1   2   " + myFile3.toString()));
    assertTrue(returnString.contains("25  50  " + myFile2.toString()));
  }
  finally {
    System.setOut(psBackup);
  }
}
