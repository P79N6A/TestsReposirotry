/** 
 * Regression test for HDFS-3725. One of the journal nodes is down during the writing of one segment, then comes back up later to take part in a later segment. Thus, its local edits are not a contiguous sequence. This should be handled correctly.
 */
@Test public void testOneJNMissingSegments() throws Exception {
  writeSegment(cluster,qjm,1,3,true);
  waitForAllPendingCalls(qjm.getLoggerSetForTests());
  cluster.getJournalNode(0).stopAndJoin(0);
  writeSegment(cluster,qjm,4,3,true);
  waitForAllPendingCalls(qjm.getLoggerSetForTests());
  cluster.restartJournalNode(0);
  writeSegment(cluster,qjm,7,3,true);
  waitForAllPendingCalls(qjm.getLoggerSetForTests());
  cluster.getJournalNode(1).stopAndJoin(0);
  QuorumJournalManager readerQjm=createSpyingQJM();
  List<EditLogInputStream> streams=Lists.newArrayList();
  try {
    readerQjm.selectInputStreams(streams,1,false);
    verifyEdits(streams,1,9);
  }
  finally {
    IOUtils.cleanup(LOG,streams.toArray(new Closeable[0]));
    readerQjm.close();
  }
}
