/** 
 * Ensure that there is waiting (sleepDuration != 0) if the metrics have only been updated with both successful and failed requests.  Also ensure that the sleepDuration decreases over time.
 */
@Test public void testSuccessAndErrorsAndWaiting(){
  ClientThrottlingAnalyzer analyzer=new ClientThrottlingAnalyzer("test",ANALYSIS_PERIOD);
  validate(0,analyzer.getSleepDuration());
  analyzer.addBytesTransferred(8 * MEGABYTE,false);
  analyzer.addBytesTransferred(2 * MEGABYTE,true);
  sleep(ANALYSIS_PERIOD_PLUS_10_PERCENT);
  NanoTimer timer=new NanoTimer();
  analyzer.suspendIfNecessary();
  final int expectedElapsedTime=126;
  fuzzyValidate(expectedElapsedTime,timer.elapsedTimeMs(),MAX_ACCEPTABLE_PERCENT_DIFFERENCE);
  sleep(10 * ANALYSIS_PERIOD);
  final int expectedSleepDuration=110;
  validateLessThanOrEqual(expectedSleepDuration,analyzer.getSleepDuration());
}
