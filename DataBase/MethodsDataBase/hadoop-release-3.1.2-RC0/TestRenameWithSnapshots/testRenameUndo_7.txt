/** 
 * Test rename to an invalid name (xxx/.snapshot)
 */
@Test public void testRenameUndo_7() throws Exception {
  final Path root=new Path("/");
  final Path foo=new Path(root,"foo");
  final Path bar=new Path(foo,"bar");
  DFSTestUtil.createFile(hdfs,bar,BLOCKSIZE,REPL,SEED);
  SnapshotTestHelper.createSnapshot(hdfs,root,snap1);
  final Path invalid=new Path(foo,HdfsConstants.DOT_SNAPSHOT_DIR);
  try {
    hdfs.rename(bar,invalid);
    fail("expect exception since invalid name is used for rename");
  }
 catch (  Exception e) {
    GenericTestUtils.assertExceptionContains("\"" + HdfsConstants.DOT_SNAPSHOT_DIR + "\" is a reserved name",e);
  }
  INodeDirectory rootNode=fsdir.getINode4Write(root.toString()).asDirectory();
  INodeDirectory fooNode=fsdir.getINode4Write(foo.toString()).asDirectory();
  ReadOnlyList<INode> children=fooNode.getChildrenList(Snapshot.CURRENT_STATE_ID);
  assertEquals(1,children.size());
  DiffList<DirectoryDiff> diffList=fooNode.getDiffs().asList();
  assertEquals(1,diffList.size());
  DirectoryDiff diff=diffList.get(0);
  Snapshot s1=rootNode.getSnapshot(DFSUtil.string2Bytes(snap1));
  assertEquals(s1.getId(),diff.getSnapshotId());
  assertSizes(0,0,diff.getChildrenDiff());
  INodeFile barNode=fsdir.getINode4Write(bar.toString()).asFile();
  assertSame(barNode,children.get(0));
  assertSame(fooNode,barNode.getParent());
  DiffList<FileDiff> barDiffList=barNode.getDiffs().asList();
  assertEquals(1,barDiffList.size());
  FileDiff barDiff=barDiffList.get(0);
  assertEquals(s1.getId(),barDiff.getSnapshotId());
  hdfs.setSafeMode(SafeModeAction.SAFEMODE_ENTER);
  hdfs.saveNamespace();
  hdfs.setSafeMode(SafeModeAction.SAFEMODE_LEAVE);
  cluster.shutdown();
  cluster=new MiniDFSCluster.Builder(conf).format(false).numDataNodes(REPL).build();
  cluster.waitActive();
  restartClusterAndCheckImage(true);
}
