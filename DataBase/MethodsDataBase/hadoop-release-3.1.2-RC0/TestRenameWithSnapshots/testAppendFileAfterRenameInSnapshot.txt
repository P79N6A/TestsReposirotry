/** 
 * Similar with testRenameUCFileInSnapshot, but do renaming first and then  append file without closing it. Unit test for HDFS-5425.
 */
@Test public void testAppendFileAfterRenameInSnapshot() throws Exception {
  final Path test=new Path("/test");
  final Path foo=new Path(test,"foo");
  final Path bar=new Path(foo,"bar");
  DFSTestUtil.createFile(hdfs,bar,BLOCKSIZE,REPL,SEED);
  SnapshotTestHelper.createSnapshot(hdfs,test,"s0");
  final Path bar2=new Path(foo,"bar2");
  hdfs.rename(bar,bar2);
  FSDataOutputStream out=hdfs.append(bar2);
  out.writeByte(0);
  ((DFSOutputStream)out.getWrappedStream()).hsync(EnumSet.of(SyncFlag.UPDATE_LENGTH));
  restartClusterAndCheckImage(true);
}
