/** 
 * Verify that sub directory can restrict acl with acl inherited from parent. Create a parent dir and set default to allow foo and bar full access Create a sub dir and set default to restrict bar to empty access parent dir/file can be viewed by foo parent dir/child dir/file can be viewed by foo parent dir/child dir/file can not be viewed by bar
 * @throws IOException
 */
@Test public void testRestrictAtSubDir() throws Exception {
  Path parent=new Path("/testRestrictAtSubDir");
  hdfs.mkdirs(parent);
  List<AclEntry> aclsParent=Lists.newArrayList(aclEntry(DEFAULT,USER,"foo",ALL),aclEntry(DEFAULT,GROUP,"bar",ALL));
  hdfs.setAcl(parent,aclsParent);
  AclEntry[] parentDirExpectedAcl=new AclEntry[]{aclEntry(DEFAULT,USER,ALL),aclEntry(DEFAULT,USER,"foo",ALL),aclEntry(DEFAULT,GROUP,READ_EXECUTE),aclEntry(DEFAULT,GROUP,"bar",ALL),aclEntry(DEFAULT,MASK,ALL),aclEntry(DEFAULT,OTHER,READ_EXECUTE)};
  AclStatus parentAcl=hdfs.getAclStatus(parent);
  assertArrayEquals(parentDirExpectedAcl,parentAcl.getEntries().toArray());
  Path parentFile=new Path(parent,"parentFile");
  hdfs.create(parentFile).close();
  hdfs.setPermission(parentFile,new FsPermission((short)0640));
  AclEntry[] parentFileExpectedAcl=new AclEntry[]{aclEntry(ACCESS,USER,"foo",ALL),aclEntry(ACCESS,GROUP,READ_EXECUTE),aclEntry(ACCESS,GROUP,"bar",ALL)};
  AclStatus parentFileAcl=hdfs.getAclStatus(parentFile);
  assertArrayEquals(parentFileExpectedAcl,parentFileAcl.getEntries().toArray());
  Path childDir=new Path(parent,"childDir");
  hdfs.mkdirs(childDir);
  List<AclEntry> newAclsChild=Lists.newArrayList(aclEntry(DEFAULT,GROUP,"bar",NONE));
  hdfs.modifyAclEntries(childDir,newAclsChild);
  AclEntry[] childDirExpectedAcl=new AclEntry[]{aclEntry(ACCESS,USER,"foo",ALL),aclEntry(ACCESS,GROUP,READ_EXECUTE),aclEntry(ACCESS,GROUP,"bar",ALL),aclEntry(DEFAULT,USER,ALL),aclEntry(DEFAULT,USER,"foo",ALL),aclEntry(DEFAULT,GROUP,READ_EXECUTE),aclEntry(DEFAULT,GROUP,"bar",NONE),aclEntry(DEFAULT,MASK,ALL),aclEntry(DEFAULT,OTHER,READ_EXECUTE)};
  AclStatus childDirAcl=hdfs.getAclStatus(childDir);
  assertArrayEquals(childDirExpectedAcl,childDirAcl.getEntries().toArray());
  Path childFile=new Path(childDir,"childFile");
  hdfs.create(childFile).close();
  hdfs.setPermission(childFile,new FsPermission((short)0640));
  AclEntry[] childFileExpectedAcl=new AclEntry[]{aclEntry(ACCESS,USER,"foo",ALL),aclEntry(ACCESS,GROUP,READ_EXECUTE),aclEntry(ACCESS,GROUP,"bar",NONE)};
  AclStatus childFileAcl=hdfs.getAclStatus(childFile);
  assertArrayEquals(childFileExpectedAcl,childFileAcl.getEntries().toArray());
  assertFalse(tryAccess(childFile,"barUser",new String[]{"bar"},READ));
  assertTrue(tryAccess(childFile,"foo",new String[]{"fooGroup"},READ));
  assertTrue(tryAccess(parentFile,"barUser",new String[]{"bar"},READ));
  assertTrue(tryAccess(parentFile,"foo",new String[]{"fooGroup"},READ));
  hdfs.delete(parent,true);
}
