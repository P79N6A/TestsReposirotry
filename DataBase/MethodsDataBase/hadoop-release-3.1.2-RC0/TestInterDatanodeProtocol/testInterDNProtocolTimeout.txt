/** 
 * Test to verify that InterDatanode RPC timesout as expected when the server DN does not respond.
 */
@Test(expected=SocketTimeoutException.class) public void testInterDNProtocolTimeout() throws Throwable {
  final Server server=new TestServer(1,true);
  server.start();
  final InetSocketAddress addr=NetUtils.getConnectAddress(server);
  DatanodeID fakeDnId=DFSTestUtil.getLocalDatanodeID(addr.getPort());
  DatanodeInfo dInfo=new DatanodeInfoBuilder().setNodeID(fakeDnId).build();
  InterDatanodeProtocol proxy=null;
  try {
    proxy=DataNode.createInterDataNodeProtocolProxy(dInfo,conf,500,false);
    proxy.initReplicaRecovery(new RecoveringBlock(new ExtendedBlock("bpid",1),null,100));
    fail("Expected SocketTimeoutException exception, but did not get.");
  }
  finally {
    if (proxy != null) {
      RPC.stopProxy(proxy);
    }
    server.stop();
  }
}
