/** 
 * Simulate a secondary node failure to transfer image. Uses an unchecked error and fail transfer before even setting the length header. This used to cause image truncation. Regression test for HDFS-3330.
 */
@Test public void testSecondaryFailsWithErrorBeforeSettingHeaders() throws IOException {
  Mockito.doThrow(new Error("If this exception is not caught by the " + "name-node, fs image will be truncated.")).when(faultInjector).beforeGetImageSetsHeaders();
  doSecondaryFailsToReturnImage();
}
