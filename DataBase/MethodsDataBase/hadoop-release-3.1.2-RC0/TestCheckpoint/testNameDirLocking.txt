/** 
 * Test that the NN locks its storage and edits directories, and won't start up if the directories are already locked
 */
@Test public void testNameDirLocking() throws IOException {
  Configuration conf=new HdfsConfiguration();
  MiniDFSCluster cluster=null;
  StorageDirectory savedSd=null;
  try {
    cluster=new MiniDFSCluster.Builder(conf).numDataNodes(0).build();
    NNStorage storage=cluster.getNameNode().getFSImage().getStorage();
    for (    StorageDirectory sd : storage.dirIterable(null)) {
      assertLockFails(sd);
      savedSd=sd;
    }
  }
  finally {
    cleanup(cluster);
    cluster=null;
  }
  assertNotNull(savedSd);
  assertClusterStartFailsWhenDirLocked(conf,savedSd);
}
