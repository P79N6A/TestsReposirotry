/** 
 * Test case where the secondary does a checkpoint, then stops for a while. In the meantime, the NN saves its image several times, so that the logs that connect the 2NN's old checkpoint to the current txid get archived. Then, the 2NN tries to checkpoint again.
 */
@Test public void testSecondaryHasVeryOutOfDateImage() throws IOException {
  MiniDFSCluster cluster=null;
  SecondaryNameNode secondary=null;
  Configuration conf=new HdfsConfiguration();
  try {
    cluster=new MiniDFSCluster.Builder(conf).numDataNodes(numDatanodes).format(true).build();
    secondary=startSecondaryNameNode(conf);
    secondary.doCheckpoint();
    NamenodeProtocols nn=cluster.getNameNodeRpc();
    nn.setSafeMode(SafeModeAction.SAFEMODE_ENTER,false);
    for (int i=0; i < 3; i++) {
      nn.saveNamespace(0,0);
    }
    nn.setSafeMode(SafeModeAction.SAFEMODE_LEAVE,false);
    secondary.doCheckpoint();
  }
  finally {
    cleanup(secondary);
    secondary=null;
    cleanup(cluster);
    cluster=null;
  }
}
