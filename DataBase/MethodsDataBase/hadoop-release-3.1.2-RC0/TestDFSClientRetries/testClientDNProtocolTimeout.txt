/** 
 * Test that timeout occurs when DN does not respond to RPC. Start up a server and ask it to sleep for n seconds. Make an RPC to the server and set rpcTimeout to less than n and ensure that socketTimeoutException is obtained
 */
@Test public void testClientDNProtocolTimeout() throws IOException {
  final Server server=new TestServer(1,true);
  server.start();
  final InetSocketAddress addr=NetUtils.getConnectAddress(server);
  DatanodeID fakeDnId=DFSTestUtil.getLocalDatanodeID(addr.getPort());
  ExtendedBlock b=new ExtendedBlock("fake-pool",new Block(12345L));
  LocatedBlock fakeBlock=new LocatedBlock(b,new DatanodeInfo[0]);
  ClientDatanodeProtocol proxy=null;
  try {
    proxy=DFSUtilClient.createClientDatanodeProtocolProxy(fakeDnId,conf,500,false,fakeBlock);
    proxy.getReplicaVisibleLength(new ExtendedBlock("bpid",1));
    fail("Did not get expected exception: SocketTimeoutException");
  }
 catch (  SocketTimeoutException e) {
    LOG.info("Got the expected Exception: SocketTimeoutException");
  }
 finally {
    if (proxy != null) {
      RPC.stopProxy(proxy);
    }
    server.stop();
  }
}
