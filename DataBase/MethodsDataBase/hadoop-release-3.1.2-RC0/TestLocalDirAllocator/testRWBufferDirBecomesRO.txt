/** 
 * Two buffer dirs. Both exists and on a R/W disk. Later disk1 becomes read-only.
 * @throws Exception
 */
@Test(timeout=30000) public void testRWBufferDirBecomesRO() throws Exception {
  assumeNotWindows();
  String dir3=buildBufferDir(ROOT,3);
  String dir4=buildBufferDir(ROOT,4);
  try {
    conf.set(CONTEXT,dir3 + "," + dir4);
    assertTrue(localFs.mkdirs(new Path(dir3)));
    assertTrue(localFs.mkdirs(new Path(dir4)));
    createTempFile(SMALL_FILE_SIZE);
    int nextDirIdx=(dirAllocator.getCurrentDirectoryIndex() == 0) ? 3 : 4;
    validateTempDirCreation(buildBufferDir(ROOT,nextDirIdx));
    new File(new Path(dir4).toUri().getPath()).setReadOnly();
    validateTempDirCreation(dir3);
    validateTempDirCreation(dir3);
  }
  finally {
    rmBufferDirs();
  }
}
