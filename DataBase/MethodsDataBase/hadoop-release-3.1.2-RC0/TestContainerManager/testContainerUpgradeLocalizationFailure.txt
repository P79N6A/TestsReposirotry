@Test public void testContainerUpgradeLocalizationFailure() throws IOException, InterruptedException, YarnException {
  if (Shell.WINDOWS) {
    return;
  }
  containerManager.start();
  Listener listener=new Listener();
  ((NodeManager.DefaultContainerStateListener)containerManager.context.getContainerStateTransitionListener()).addListener(listener);
  ContainerId cId=createContainerId(0);
  File oldStartFile=new File(tmpDir,"start_file_o.txt").getAbsoluteFile();
  String pid=prepareInitialContainer(cId,oldStartFile);
  File newStartFile=new File(tmpDir,"start_file_n.txt").getAbsoluteFile();
  prepareContainerUpgrade(false,true,true,cId,newStartFile);
  Assert.assertTrue("Process is NOT alive!",DefaultContainerExecutor.containerIsAlive(pid));
  List<org.apache.hadoop.yarn.server.nodemanager.containermanager.container.ContainerState> containerStates=listener.states.get(createContainerId(0));
  Assert.assertEquals(Arrays.asList(org.apache.hadoop.yarn.server.nodemanager.containermanager.container.ContainerState.NEW,org.apache.hadoop.yarn.server.nodemanager.containermanager.container.ContainerState.LOCALIZING,org.apache.hadoop.yarn.server.nodemanager.containermanager.container.ContainerState.SCHEDULED,org.apache.hadoop.yarn.server.nodemanager.containermanager.container.ContainerState.RUNNING,org.apache.hadoop.yarn.server.nodemanager.containermanager.container.ContainerState.REINITIALIZING,org.apache.hadoop.yarn.server.nodemanager.containermanager.container.ContainerState.RUNNING),containerStates);
  List<ContainerEventType> containerEventTypes=listener.events.get(createContainerId(0));
  Assert.assertEquals(Arrays.asList(ContainerEventType.INIT_CONTAINER,ContainerEventType.RESOURCE_LOCALIZED,ContainerEventType.CONTAINER_LAUNCHED,ContainerEventType.REINITIALIZE_CONTAINER,ContainerEventType.RESOURCE_FAILED),containerEventTypes);
}
