@Test public void testReinitializeQueuesWithAutoCreatedLeafQueues() throws Exception {
  MockRM newMockRM=setupSchedulerInstance();
  try {
    CapacityScheduler newCS=(CapacityScheduler)newMockRM.getResourceScheduler();
    CapacitySchedulerConfiguration conf=newCS.getConfiguration();
    CSQueue parentQueue=newCS.getQueue(PARENT_QUEUE);
    submitApp(newMockRM,parentQueue,USER1,USER1,1,1);
    Map<String,Float> expectedChildQueueAbsCapacity=populateExpectedAbsCapacityByLabelForParentQueue(1);
    validateInitialQueueEntitlement(newCS,parentQueue,USER1,expectedChildQueueAbsCapacity,accessibleNodeLabelsOnC);
    ApplicationId user2AppId=submitApp(newMockRM,parentQueue,USER2,USER2,2,1);
    expectedChildQueueAbsCapacity=populateExpectedAbsCapacityByLabelForParentQueue(2);
    validateInitialQueueEntitlement(newCS,parentQueue,USER2,expectedChildQueueAbsCapacity,accessibleNodeLabelsOnC);
    conf.setCapacity(C,30f);
    conf.setCapacity(D,10f);
    conf.setMaximumCapacity(C,50f);
    newCS.reinitialize(conf,newMockRM.getRMContext());
    AutoCreatedLeafQueue user0Queue=(AutoCreatedLeafQueue)newCS.getQueue(USER1);
    validateCapacities(user0Queue,0.5f,0.15f,1.0f,0.5f);
    validateUserAndAppLimits(user0Queue,1500,1500);
    conf.setAutoCreatedLeafQueueConfigCapacity(C,30f);
    conf.setAutoCreatedLeafQueueConfigMaxCapacity(C,40f);
    newCS.reinitialize(conf,newMockRM.getRMContext());
    validateCapacities(user0Queue,0.3f,0.09f,0.4f,0.2f);
    validateUserAndAppLimits(user0Queue,900,900);
    submitApp(newMockRM,parentQueue,USER3,USER3,3,1);
    AutoCreatedLeafQueue user3Queue=(AutoCreatedLeafQueue)newCS.getQueue(USER1);
    validateCapacities(user3Queue,0.3f,0.09f,0.4f,0.2f);
    validateUserAndAppLimits(user3Queue,900,900);
    submitApp(newMockRM,parentQueue,USER3,USER3,4,2);
    validateCapacities(user3Queue,0.3f,0.09f,0.4f,0.2f);
    validateUserAndAppLimits(user3Queue,900,900);
    GuaranteedOrZeroCapacityOverTimePolicy autoCreatedQueueManagementPolicy=(GuaranteedOrZeroCapacityOverTimePolicy)((ManagedParentQueue)parentQueue).getAutoCreatedQueueManagementPolicy();
    assertEquals(0.27f,autoCreatedQueueManagementPolicy.getAbsoluteActivatedChildQueueCapacity(NO_LABEL),EPSILON);
  }
  finally {
    cleanupQueue(USER1);
    cleanupQueue(USER2);
    if (newMockRM != null) {
      ((CapacityScheduler)newMockRM.getResourceScheduler()).stop();
      newMockRM.stop();
    }
  }
}
