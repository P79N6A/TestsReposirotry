/** 
 * Tests that deleted files immediately stop manifesting in list operations even when the effect in S3 is delayed.
 * @throws Exception
 */
@Test public void testConsistentListAfterDelete() throws Exception {
  S3AFileSystem fs=getFileSystem();
  Assume.assumeTrue(fs.hasMetadataStore());
  Path inconsistentPath=path("a/b/dir3-" + DEFAULT_DELAY_KEY_SUBSTRING);
  Path[] testDirs={path("a/b/dir1"),path("a/b/dir2"),inconsistentPath};
  for (  Path path : testDirs) {
    assertTrue(fs.mkdirs(path));
  }
  clearInconsistency(fs);
  for (  Path path : testDirs) {
    assertTrue(fs.delete(path,false));
  }
  FileStatus[] paths=fs.listStatus(path("a/b/"));
  List<Path> list=new ArrayList<>();
  for (  FileStatus fileState : paths) {
    list.add(fileState.getPath());
  }
  assertFalse(list.contains(path("a/b/dir1")));
  assertFalse(list.contains(path("a/b/dir2")));
  assertFalse(list.contains(inconsistentPath));
}
