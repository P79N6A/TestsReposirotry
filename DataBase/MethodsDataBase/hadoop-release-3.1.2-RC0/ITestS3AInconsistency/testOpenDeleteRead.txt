/** 
 * Ensure that deleting a file with an open read stream does eventually cause readers to get a FNFE, even with S3Guard and its retries enabled. In real usage, S3Guard should be enabled for all clients that modify the file, so the delete would be immediately recorded in the MetadataStore. Here, however, we test deletion from under S3Guard to make sure it still eventually propagates the FNFE after any retry policies are exhausted.
 */
@Test public void testOpenDeleteRead() throws Exception {
  S3AFileSystem fs=getFileSystem();
  Path p=path("testOpenDeleteRead.txt");
  writeTextFile(fs,p,"1337c0d3z",true);
  try (InputStream s=fs.open(p)){
    MetadataStore metadataStore=fs.getMetadataStore();
    fs.setMetadataStore(new NullMetadataStore());
    fs.delete(p,false);
    fs.setMetadataStore(metadataStore);
    eventually(1000,200,() -> {
      intercept(FileNotFoundException.class,() -> s.read());
    }
);
  }
 }
