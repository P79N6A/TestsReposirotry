/** 
 * Submit two OPPORTUNISTIC and one GUARANTEED containers. The resources requests by each container as such that only one can run in parallel. Thus, the OPPORTUNISTIC container that started running, will be killed for the GUARANTEED container to start. Once the GUARANTEED container finishes its execution, the remaining OPPORTUNISTIC container will be executed.
 * @throws Exception
 */
@Test public void testKillOpportunisticForGuaranteedContainer() throws Exception {
  containerManager.start();
  List<StartContainerRequest> list=new ArrayList<>();
  list.add(StartContainerRequest.newInstance(recordFactory.newRecordInstance(ContainerLaunchContext.class),createContainerToken(createContainerId(0),DUMMY_RM_IDENTIFIER,context.getNodeId(),user,BuilderUtils.newResource(2048,1),context.getContainerTokenSecretManager(),null,ExecutionType.OPPORTUNISTIC)));
  list.add(StartContainerRequest.newInstance(recordFactory.newRecordInstance(ContainerLaunchContext.class),createContainerToken(createContainerId(1),DUMMY_RM_IDENTIFIER,context.getNodeId(),user,BuilderUtils.newResource(2048,1),context.getContainerTokenSecretManager(),null,ExecutionType.OPPORTUNISTIC)));
  list.add(StartContainerRequest.newInstance(recordFactory.newRecordInstance(ContainerLaunchContext.class),createContainerToken(createContainerId(2),DUMMY_RM_IDENTIFIER,context.getNodeId(),user,BuilderUtils.newResource(2048,1),context.getContainerTokenSecretManager(),null,ExecutionType.GUARANTEED)));
  StartContainersRequest allRequests=StartContainersRequest.newInstance(list);
  containerManager.startContainers(allRequests);
  BaseContainerManagerTest.waitForNMContainerState(containerManager,createContainerId(0),ContainerState.DONE,40);
  Thread.sleep(5000);
  List<ContainerId> statList=new ArrayList<ContainerId>();
  for (int i=0; i < 3; i++) {
    statList.add(createContainerId(i));
  }
  GetContainerStatusesRequest statRequest=GetContainerStatusesRequest.newInstance(statList);
  List<ContainerStatus> containerStatuses=containerManager.getContainerStatuses(statRequest).getContainerStatuses();
  for (  ContainerStatus status : containerStatuses) {
    if (status.getContainerId().equals(createContainerId(0))) {
      Assert.assertTrue(status.getDiagnostics().contains("Container Killed to make room for Guaranteed Container"));
    }
 else     if (status.getContainerId().equals(createContainerId(1))) {
      Assert.assertEquals(ContainerSubState.SCHEDULED,status.getContainerSubState());
    }
 else     if (status.getContainerId().equals(createContainerId(2))) {
      Assert.assertEquals(ContainerSubState.RUNNING,status.getContainerSubState());
    }
    System.out.println("\nStatus : [" + status + "]\n");
  }
  BaseContainerManagerTest.waitForNMContainerState(containerManager,createContainerId(2),ContainerState.DONE,40);
  Thread.sleep(5000);
  statRequest=GetContainerStatusesRequest.newInstance(Arrays.asList(createContainerId(1)));
  ContainerStatus contStatus1=containerManager.getContainerStatuses(statRequest).getContainerStatuses().get(0);
  Assert.assertEquals(org.apache.hadoop.yarn.api.records.ContainerState.RUNNING,contStatus1.getState());
}
