@Test public void testSecondAttempt() throws Exception {
  ApplicationUserInfo userInfo=getApplicationUserInfo(testAppId);
  userInfo.getUser().doAs(new PrivilegedExceptionAction<Object>(){
    @Override public Object run() throws Exception {
      RegisterApplicationMasterRequest registerReq=Records.newRecord(RegisterApplicationMasterRequest.class);
      registerReq.setHost(Integer.toString(testAppId));
      registerReq.setRpcPort(testAppId);
      registerReq.setTrackingUrl("");
      RegisterApplicationMasterResponse registerResponse=interceptor.registerApplicationMaster(registerReq);
      Assert.assertNotNull(registerResponse);
      Assert.assertEquals(0,interceptor.getUnmanagedAMPoolSize());
      registerSubCluster(SubClusterId.newInstance("SC-1"));
      registerSubCluster(SubClusterId.newInstance(HOME_SC_ID));
      int numberOfContainers=3;
      List<Container> containers=getContainersAndAssert(numberOfContainers,numberOfContainers * 2);
      for (      Container c : containers) {
        System.out.println(c.getId() + " ha");
      }
      Assert.assertEquals(1,interceptor.getUnmanagedAMPoolSize());
      ConcurrentHashMap<String,MockResourceManagerFacade> secondaries=interceptor.getSecondaryRMs();
      attemptId=ApplicationAttemptId.newInstance(attemptId.getApplicationId(),attemptId.getAttemptId() + 1);
      interceptor=new TestableFederationInterceptor(null,secondaries);
      interceptor.init(new AMRMProxyApplicationContextImpl(nmContext,getConf(),attemptId,"test-user",null,null,null,registry));
      registerResponse=interceptor.registerApplicationMaster(registerReq);
      Assert.assertEquals(1,interceptor.getUnmanagedAMPoolSize());
      Assert.assertEquals(numberOfContainers,registerResponse.getContainersFromPreviousAttempts().size());
      releaseContainersAndAssert(registerResponse.getContainersFromPreviousAttempts());
      FinishApplicationMasterRequest finishReq=Records.newRecord(FinishApplicationMasterRequest.class);
      finishReq.setDiagnostics("");
      finishReq.setTrackingUrl("");
      finishReq.setFinalApplicationStatus(FinalApplicationStatus.SUCCEEDED);
      FinishApplicationMasterResponse finshResponse=interceptor.finishApplicationMaster(finishReq);
      Assert.assertNotNull(finshResponse);
      Assert.assertEquals(true,finshResponse.getIsUnregistered());
      if (interceptor.getRegistryClient() != null) {
        Assert.assertEquals(0,interceptor.getRegistryClient().getAllApplications().size());
      }
      return null;
    }
  }
);
}
