@Test(timeout=600000) public void testAppReregisterOnRMWorkPreservingRestart() throws Exception {
  conf.setInt(YarnConfiguration.RM_AM_MAX_ATTEMPTS,1);
  rm1=new MockRM(conf);
  rm1.start();
  MockNM nm1=new MockNM("127.0.0.1:1234",15120,rm1.getResourceTrackerService());
  nm1.registerNode();
  RMApp app0=rm1.submitApp(200);
  MockAM am0=MockRM.launchAM(app0,rm1,nm1);
  am0.registerAppAttempt();
  rm2=new MockRM(conf,rm1.getRMStateStore());
  rm2.start();
  rm2.waitForState(app0.getApplicationId(),RMAppState.ACCEPTED);
  rm2.waitForState(am0.getApplicationAttemptId(),RMAppAttemptState.LAUNCHED);
  am0.setAMRMProtocol(rm2.getApplicationMasterService(),rm2.getRMContext());
  am0.registerAppAttempt(true);
  rm2.waitForState(app0.getApplicationId(),RMAppState.RUNNING);
  rm2.waitForState(am0.getApplicationAttemptId(),RMAppAttemptState.RUNNING);
}
