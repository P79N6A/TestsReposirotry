@Test(timeout=60000) public void testAddVolumesDuringWrite() throws IOException, InterruptedException, TimeoutException, ReconfigurationException {
  startDFSCluster(1,1);
  int numVolumes=cluster.getStoragesPerDatanode();
  String bpid=cluster.getNamesystem().getBlockPoolId();
  Path testFile=new Path("/test");
  int initialBlockCount=numVolumes * 2;
  createFile(testFile,initialBlockCount);
  int newVolumeCount=5;
  addVolumes(newVolumeCount);
  numVolumes+=newVolumeCount;
  int additionalBlockCount=9;
  int totalBlockCount=initialBlockCount + additionalBlockCount;
  DFSTestUtil.appendFile(cluster.getFileSystem(),testFile,BLOCK_SIZE * additionalBlockCount);
  verifyFileLength(cluster.getFileSystem(),testFile,totalBlockCount);
  List<Integer> expectedNumBlocks=Arrays.asList(1,1,1,1,1,4,4);
  List<Map<DatanodeStorage,BlockListAsLongs>> blockReports=cluster.getAllBlockReports(bpid);
  assertEquals(1,blockReports.size());
  assertEquals(numVolumes,blockReports.get(0).size());
  Map<DatanodeStorage,BlockListAsLongs> dnReport=blockReports.get(0);
  List<Integer> actualNumBlocks=new ArrayList<Integer>();
  for (  BlockListAsLongs blockList : dnReport.values()) {
    actualNumBlocks.add(blockList.getNumberOfBlocks());
  }
  Collections.sort(actualNumBlocks);
  assertEquals(expectedNumBlocks,actualNumBlocks);
}
