@Test public void testBasicSetECPolicy() throws IOException, InterruptedException {
  final Path testDir=new Path("/ec");
  fs.mkdir(testDir,FsPermission.getDirDefault());
  fs.setErasureCodingPolicy(testDir,ecPolicy.getName());
  final Path ECFilePath=new Path(testDir,"foo");
  fs.create(ECFilePath);
  INode inode=namesystem.getFSDirectory().getINode(ECFilePath.toString());
  assertTrue(inode.asFile().isStriped());
  final Path notEmpty=new Path("/nonEmpty");
  fs.mkdir(notEmpty,FsPermission.getDirDefault());
  final Path oldFile=new Path(notEmpty,"old");
  fs.create(oldFile);
  fs.setErasureCodingPolicy(notEmpty,ecPolicy.getName());
  final Path newFile=new Path(notEmpty,"new");
  fs.create(newFile);
  INode oldInode=namesystem.getFSDirectory().getINode(oldFile.toString());
  assertFalse(oldInode.asFile().isStriped());
  INode newInode=namesystem.getFSDirectory().getINode(newFile.toString());
  assertTrue(newInode.asFile().isStriped());
  final Path dir1=new Path("/dir1");
  final Path dir2=new Path(dir1,"dir2");
  fs.mkdir(dir1,FsPermission.getDirDefault());
  fs.setErasureCodingPolicy(dir1,ecPolicy.getName());
  fs.mkdir(dir2,FsPermission.getDirDefault());
  try {
    fs.setErasureCodingPolicy(dir2,ecPolicy.getName());
  }
 catch (  IOException e) {
    fail("Nested erasure coding policies are supported");
  }
  final Path fPath=new Path("/file");
  fs.create(fPath);
  try {
    fs.setErasureCodingPolicy(fPath,ecPolicy.getName());
    fail("Erasure coding policy on file");
  }
 catch (  IOException e) {
    assertExceptionContains("erasure coding policy for a file",e);
  }
  cluster.restartNameNodes();
  cluster.waitActive();
  Path disabledPolicy=new Path(dir1,"afterDisabled");
  Assert.assertEquals("Dir does not have policy set",ecPolicy,fs.getErasureCodingPolicy(dir1));
  fs.create(disabledPolicy).close();
  Assert.assertEquals("File did not inherit dir's policy",ecPolicy,fs.getErasureCodingPolicy(disabledPolicy));
  fs.setSafeMode(HdfsConstants.SafeModeAction.SAFEMODE_ENTER);
  fs.saveNamespace();
  fs.setSafeMode(HdfsConstants.SafeModeAction.SAFEMODE_LEAVE);
  cluster.restartNameNodes();
  Assert.assertEquals("Dir does not have policy set",ecPolicy,fs.getErasureCodingPolicy(dir1));
  Assert.assertEquals("File does not have policy set",ecPolicy,fs.getErasureCodingPolicy(disabledPolicy));
}
