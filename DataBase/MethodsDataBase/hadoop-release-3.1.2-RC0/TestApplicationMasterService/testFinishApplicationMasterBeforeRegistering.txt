@Test(timeout=1200000) public void testFinishApplicationMasterBeforeRegistering() throws Exception {
  MockRM rm=new MockRM(conf);
  try {
    rm.start();
    MockNM nm1=rm.registerNode("127.0.0.1:1234",6 * GB);
    RMApp app1=rm.submitApp(2048);
    MockAM am1=MockRM.launchAM(app1,rm,nm1);
    FinishApplicationMasterRequest req=FinishApplicationMasterRequest.newInstance(FinalApplicationStatus.FAILED,"","");
    try {
      am1.unregisterAppAttempt(req,false);
      fail("ApplicationMasterNotRegisteredException should be thrown");
    }
 catch (    ApplicationMasterNotRegisteredException e) {
      Assert.assertNotNull(e);
      Assert.assertNotNull(e.getMessage());
      Assert.assertTrue(e.getMessage().contains("Application Master is trying to unregister before registering for:"));
    }
catch (    Exception e) {
      fail("ApplicationMasterNotRegisteredException should be thrown");
    }
    am1.registerAppAttempt();
    am1.unregisterAppAttempt(req,false);
    rm.waitForState(am1.getApplicationAttemptId(),RMAppAttemptState.FINISHING);
  }
  finally {
    if (rm != null) {
      rm.stop();
    }
  }
}
