/** 
 * This UT covers some basic end-to-end inter-app anti-affinity constraint tests. For comprehensive tests over different namespace types, see more in TestPlacementConstraintsUtil.
 * @throws Exception
 */
@Test public void testInterAppAntiAffinity() throws Exception {
  Configuration csConf=TestUtils.getConfigurationWithMultipleQueues(new Configuration());
  csConf.set(YarnConfiguration.RM_PLACEMENT_CONSTRAINTS_HANDLER,YarnConfiguration.SCHEDULER_RM_PLACEMENT_CONSTRAINTS_HANDLER);
  MockRM rm1=new MockRM(csConf){
    @Override public RMNodeLabelsManager createNodeLabelManager(){
      return mgr;
    }
  }
;
  rm1.getRMContext().setNodeLabelManager(mgr);
  rm1.start();
  MockNM[] nms=new MockNM[4];
  RMNode[] rmNodes=new RMNode[4];
  for (int i=0; i < 4; i++) {
    nms[i]=rm1.registerNode("192.168.0." + i + ":1234",10 * GB);
    rmNodes[i]=rm1.getRMContext().getRMNodes().get(nms[i].getNodeId());
  }
  RMApp app1=rm1.submitApp(1 * GB,"app","user",null,"c");
  MockAM am1=MockRM.launchAndRegisterAM(app1,rm1,nms[0]);
  am1.allocateIntraAppAntiAffinity(ResourceSizing.newInstance(3,Resource.newInstance(1024,1)),Priority.newInstance(1),1L,ImmutableSet.of("mapper"),"mapper");
  CapacityScheduler cs=(CapacityScheduler)rm1.getResourceScheduler();
  for (int i=0; i < 3; i++) {
    for (int j=0; j < 4; j++) {
      cs.handle(new NodeUpdateSchedulerEvent(rmNodes[j]));
    }
  }
  System.out.println("Mappers on HOST0: " + rmNodes[0].getAllocationTagsWithCount().get("mapper"));
  System.out.println("Mappers on HOST1: " + rmNodes[1].getAllocationTagsWithCount().get("mapper"));
  System.out.println("Mappers on HOST2: " + rmNodes[2].getAllocationTagsWithCount().get("mapper"));
  FiCaSchedulerApp schedulerApp=cs.getApplicationAttempt(am1.getApplicationAttemptId());
  Assert.assertEquals(4,schedulerApp.getLiveContainers().size());
  RMApp app2=rm1.submitApp(1 * GB,"app","user",null,"c");
  MockAM am2=MockRM.launchAndRegisterAM(app2,rm1,nms[0]);
  TargetApplicationsNamespace.All allNs=new TargetApplicationsNamespace.All();
  am2.allocateAppAntiAffinity(ResourceSizing.newInstance(3,Resource.newInstance(1024,1)),Priority.newInstance(1),1L,allNs.toString(),ImmutableSet.of("foo"),"mapper");
  for (int i=0; i < 3; i++) {
    for (int j=0; j < 4; j++) {
      cs.handle(new NodeUpdateSchedulerEvent(rmNodes[j]));
    }
  }
  FiCaSchedulerApp schedulerApp2=cs.getApplicationAttempt(am2.getApplicationAttemptId());
  Assert.assertEquals(4,schedulerApp2.getLiveContainers().size());
  Assert.assertTrue(schedulerApp2.getLiveContainers().stream().allMatch(rmContainer -> {
    if (!rmContainer.getContainer().getNodeId().equals(rmNodes[0])) {
      return !rmContainer.getAllocationTags().contains("mapper");
    }
    return true;
  }
));
  RMApp app3=rm1.submitApp(1 * GB,"app","user",null,"c");
  MockAM am3=MockRM.launchAndRegisterAM(app3,rm1,nms[0]);
  am3.allocateAppAntiAffinity(ResourceSizing.newInstance(3,Resource.newInstance(1024,1)),Priority.newInstance(1),1L,allNs.toString(),ImmutableSet.of("mapper"),"mapper");
  for (int i=0; i < 3; i++) {
    for (int j=0; j < 4; j++) {
      cs.handle(new NodeUpdateSchedulerEvent(rmNodes[j]));
    }
  }
  FiCaSchedulerApp schedulerApp3=cs.getApplicationAttempt(am3.getApplicationAttemptId());
  Assert.assertEquals(2,schedulerApp3.getLiveContainers().size());
  rm1.close();
}
