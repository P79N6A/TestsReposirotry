/** 
 * Verify that the NameNode can learn about new storages from incremental block reports. This tests the fix for the error condition seen in HDFS-6904.
 * @throws IOException
 * @throws InterruptedException
 */
@Test(timeout=60000) public void testNnLearnsNewStorages() throws IOException, InterruptedException {
  final String newStorageUuid=UUID.randomUUID().toString();
  final DatanodeStorage newStorage=new DatanodeStorage(newStorageUuid);
  StorageReceivedDeletedBlocks[] reports=DFSTestUtil.makeReportForReceivedBlock(getDummyBlock(),BlockStatus.RECEIVED_BLOCK,newStorage);
  cluster.getNameNodeRpc().blockReceivedAndDeleted(dn0Reg,poolId,reports);
  cluster.getNamesystem().getBlockManager().flushBlockOps();
  DatanodeStorageInfo storageInfo=cluster.getNameNode().getNamesystem().getBlockManager().getDatanodeManager().getDatanode(dn0.getDatanodeId()).getStorageInfo(newStorageUuid);
  assertNotNull(storageInfo);
}
