@Test(timeout=50000) public void testDontSetTrackingURLIfHistoryWriteThrows() throws Exception {
  TestParams t=new TestParams(true);
  Configuration conf=new Configuration();
  JHEvenHandlerForTest realJheh=new JHEvenHandlerForTest(t.mockAppContext,0,false);
  JHEvenHandlerForTest jheh=spy(realJheh);
  jheh.init(conf);
  try {
    jheh.start();
    doThrow(new YarnRuntimeException(new IOException())).when(jheh).processDoneFiles(any(JobId.class));
    handleEvent(jheh,new JobHistoryEvent(t.jobId,new AMStartedEvent(t.appAttemptId,200,t.containerId,"nmhost",3000,4000,-1)));
    verify(jheh,times(0)).processDoneFiles(any(JobId.class));
    verify(t.mockAppContext,times(0)).setHistoryUrl(any(String.class));
    try {
      handleEvent(jheh,new JobHistoryEvent(t.jobId,new JobFinishedEvent(TypeConverter.fromYarn(t.jobId),0,0,0,0,0,0,0,new Counters(),new Counters(),new Counters())));
      throw new RuntimeException("processDoneFiles didn't throw, but should have");
    }
 catch (    YarnRuntimeException yre) {
    }
    verify(jheh,times(1)).processDoneFiles(any(JobId.class));
    verify(t.mockAppContext,times(0)).setHistoryUrl(any(String.class));
  }
  finally {
    jheh.stop();
  }
}
