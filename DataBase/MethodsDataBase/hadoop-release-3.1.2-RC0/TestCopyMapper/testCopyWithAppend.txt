@Test public void testCopyWithAppend() throws Exception {
  final FileSystem fs=cluster.getFileSystem();
  testCopy(false);
  appendSourceData();
  CopyMapper copyMapper=new CopyMapper();
  Configuration conf=getConfiguration();
  conf.setInt(DistCpOptionSwitch.COPY_BUFFER_SIZE.getConfigLabel(),DEFAULT_FILE_SIZE / 10);
  StubContext stubContext=new StubContext(conf,null,0);
  Mapper<Text,CopyListingFileStatus,Text,Text>.Context context=stubContext.getContext();
  context.getConfiguration().setBoolean(DistCpOptionSwitch.APPEND.getConfigLabel(),true);
  copyMapper.setup(context);
  int numFiles=0;
  MetricsRecordBuilder rb=getMetrics(cluster.getDataNodes().get(0).getMetrics().name());
  String readCounter="ReadsFromLocalClient";
  long readsFromClient=getLongCounter(readCounter,rb);
  for (  Path path : pathList) {
    if (fs.getFileStatus(path).isFile()) {
      numFiles++;
    }
    copyMapper.map(new Text(DistCpUtils.getRelativePath(new Path(SOURCE_PATH),path)),new CopyListingFileStatus(cluster.getFileSystem().getFileStatus(path)),context);
  }
  verifyCopy(fs,false,true);
  Assert.assertEquals(nFiles * DEFAULT_FILE_SIZE * 2,stubContext.getReporter().getCounter(CopyMapper.Counter.BYTESCOPIED).getValue());
  Assert.assertEquals(numFiles,stubContext.getReporter().getCounter(CopyMapper.Counter.COPY).getValue());
  rb=getMetrics(cluster.getDataNodes().get(0).getMetrics().name());
  assertCounter(readCounter,readsFromClient + numFiles,rb);
}
