@Test public void testAppendBlockOperations() throws Exception {
  CloudBlobContainer container=getTestAccount().getRealContainer();
  OperationContext context=new OperationContext();
  context.getResponseReceivedEventHandler().addListener(new ResponseReceivedEventHandler());
  context.getSendingRequestEventHandler().addListener(new SendingRequestEventHandler());
  CloudAppendBlob appendBlob=container.getAppendBlobReference("testAppendBlockOperations");
  assertNull(lastOperationTypeSent);
  assertNull(lastOperationTypeReceived);
  assertEquals(0,lastContentLengthReceived);
  try (BlobOutputStream output=appendBlob.openWriteNew(null,null,context)){
    assertEquals(BlobOperationDescriptor.OperationType.CreateBlob,lastOperationTypeReceived);
    assertEquals(0,lastContentLengthReceived);
    String message="this is a test";
    output.write(message.getBytes("UTF-8"));
    output.flush();
    assertEquals(BlobOperationDescriptor.OperationType.AppendBlock,lastOperationTypeSent);
    assertEquals(BlobOperationDescriptor.OperationType.AppendBlock,lastOperationTypeReceived);
    assertEquals(message.length(),lastContentLengthReceived);
  }
 }
