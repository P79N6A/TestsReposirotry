/** 
 * Test fsimage loading when 1) there is an empty file loaded from fsimage, and 2) there is later an append operation to be applied from edit log.
 */
@Test(timeout=60000) public void testLoadImageWithEmptyFile() throws Exception {
  Path file=new Path(dir,"file");
  FSDataOutputStream out=hdfs.create(file);
  out.close();
  hdfs.setSafeMode(SafeModeAction.SAFEMODE_ENTER);
  hdfs.saveNamespace();
  hdfs.setSafeMode(SafeModeAction.SAFEMODE_LEAVE);
  out=hdfs.append(file);
  out.write(1);
  out.close();
  cluster.shutdown();
  cluster=new MiniDFSCluster.Builder(conf).format(false).numDataNodes(NUM_DATANODES).build();
  cluster.waitActive();
  hdfs=cluster.getFileSystem();
  FileStatus status=hdfs.getFileStatus(file);
  assertEquals(1,status.getLen());
}
