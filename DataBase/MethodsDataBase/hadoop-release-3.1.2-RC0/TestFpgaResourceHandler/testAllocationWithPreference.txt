@Test public void testAllocationWithPreference() throws ResourceHandlerException, PrivilegedOperationException {
  configuration.set(YarnConfiguration.NM_FPGA_ALLOWED_DEVICES,"0,1,2");
  fpgaResourceHandler.bootstrap(configuration);
  fpgaResourceHandler.preStart(mockContainer(0,1,"GEMM"));
  Assert.assertEquals(1,fpgaResourceHandler.getFpgaAllocator().getUsedFpgaCount());
  verifyDeniedDevices(getContainerId(0),Arrays.asList(1,2));
  List<FpgaResourceAllocator.FpgaDevice> list=fpgaResourceHandler.getFpgaAllocator().getUsedFpga().get(getContainerId(0).toString());
  for (  FpgaResourceAllocator.FpgaDevice device : list) {
    Assert.assertEquals("IP should be updated to GEMM","GEMM",device.getIPID());
  }
  boolean flag=false;
  try {
    fpgaResourceHandler.preStart(mockContainer(1,3,"GZIP"));
  }
 catch (  ResourceHandlerException e) {
    flag=true;
  }
  Assert.assertTrue(flag);
  fpgaResourceHandler.postComplete(getContainerId(0));
  Assert.assertEquals(0,fpgaResourceHandler.getFpgaAllocator().getUsedFpgaCount());
  Assert.assertEquals(3,fpgaResourceHandler.getFpgaAllocator().getAvailableFpgaCount());
  fpgaResourceHandler.preStart(mockContainer(1,3,"GEMM"));
  verifyDeniedDevices(getContainerId(1),new ArrayList<>());
  Assert.assertEquals(3,fpgaResourceHandler.getFpgaAllocator().getUsedFpgaCount());
  Assert.assertEquals(0,fpgaResourceHandler.getFpgaAllocator().getAvailableFpgaCount());
  fpgaResourceHandler.postComplete(getContainerId(1));
  Assert.assertEquals(0,fpgaResourceHandler.getFpgaAllocator().getUsedFpgaCount());
  Assert.assertEquals(3,fpgaResourceHandler.getFpgaAllocator().getAvailableFpgaCount());
  fpgaResourceHandler.preStart(mockContainer(2,1,"GZIP"));
  fpgaResourceHandler.postComplete(getContainerId(2));
  fpgaResourceHandler.preStart(mockContainer(3,2,"GEMM"));
  list=fpgaResourceHandler.getFpgaAllocator().getUsedFpga().get(getContainerId(3).toString());
  for (  FpgaResourceAllocator.FpgaDevice device : list) {
    Assert.assertEquals("IPID should be GEMM","GEMM",device.getIPID());
  }
  Assert.assertEquals(2,fpgaResourceHandler.getFpgaAllocator().getUsedFpgaCount());
  Assert.assertEquals(1,fpgaResourceHandler.getFpgaAllocator().getAvailableFpgaCount());
  fpgaResourceHandler.postComplete(getContainerId(3));
  Assert.assertEquals(0,fpgaResourceHandler.getFpgaAllocator().getUsedFpgaCount());
  Assert.assertEquals(3,fpgaResourceHandler.getFpgaAllocator().getAvailableFpgaCount());
  fpgaResourceHandler.preStart(mockContainer(4,0,""));
  verifyDeniedDevices(getContainerId(4),Arrays.asList(0,1,2));
  Assert.assertEquals(0,fpgaResourceHandler.getFpgaAllocator().getUsedFpgaCount());
  Assert.assertEquals(3,fpgaResourceHandler.getFpgaAllocator().getAvailableFpgaCount());
  try {
    fpgaResourceHandler.preStart(mockContainer(5,-2,""));
  }
 catch (  ResourceHandlerException e) {
    Assert.assertTrue(true);
  }
}
