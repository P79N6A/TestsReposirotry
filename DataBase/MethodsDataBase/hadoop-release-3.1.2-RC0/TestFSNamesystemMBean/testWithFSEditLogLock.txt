@Test public void testWithFSEditLogLock() throws Exception {
  Configuration conf=new Configuration();
  int jmxCachePeriod=1;
  new ConfigBuilder().add("namenode.period",jmxCachePeriod).save(TestMetricsConfig.getTestFilename("hadoop-metrics2-namenode"));
  MiniDFSCluster cluster=null;
  try {
    cluster=new MiniDFSCluster.Builder(conf).build();
    cluster.waitActive();
synchronized (cluster.getNameNode().getFSImage().getEditLog()) {
      Thread.sleep(jmxCachePeriod * 1000);
      MBeanClient client=new MBeanClient();
      client.start();
      client.join(20000);
      assertTrue("JMX calls are blocked when FSEditLog" + " is synchronized by another thread",client.succeeded);
      client.interrupt();
    }
  }
  finally {
    if (cluster != null) {
      cluster.shutdown();
    }
  }
}
