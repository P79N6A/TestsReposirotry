@Test public void testMapNodeLocality() throws Exception {
  LOG.info("Running testMapNodeLocality");
  Configuration conf=new Configuration();
  MyResourceManager rm=new MyResourceManager(conf);
  rm.start();
  RMApp app=rm.submitApp(1024);
  rm.drainEvents();
  MockNM amNodeManager=rm.registerNode("amNM:1234",2048);
  amNodeManager.nodeHeartbeat(true);
  rm.drainEvents();
  ApplicationAttemptId appAttemptId=app.getCurrentAppAttempt().getAppAttemptId();
  rm.sendAMLaunched(appAttemptId);
  rm.drainEvents();
  JobId jobId=MRBuilderUtils.newJobId(appAttemptId.getApplicationId(),0);
  Job mockJob=mock(Job.class);
  when(mockJob.getReport()).thenReturn(MRBuilderUtils.newJobReport(jobId,"job","user",JobState.RUNNING,0,0,0,0,0,0,0,"jobfile",null,false,""));
  MyContainerAllocator allocator=new MyContainerAllocator(rm,conf,appAttemptId,mockJob);
  MockNM nodeManager1=rm.registerNode("h1:1234",3072);
  rm.registerNode("h2:1234",10240);
  MockNM nodeManager3=rm.registerNode("h3:1234",1536);
  rm.drainEvents();
  ContainerRequestEvent event1=ContainerRequestCreator.createRequest(jobId,1,Resource.newInstance(1024,1),new String[]{"h1"});
  allocator.sendRequest(event1);
  ContainerRequestEvent event2=ContainerRequestCreator.createRequest(jobId,2,Resource.newInstance(1024,1),new String[]{"h1"});
  allocator.sendRequest(event2);
  ContainerRequestEvent event3=ContainerRequestCreator.createRequest(jobId,3,Resource.newInstance(1024,1),new String[]{"h2"});
  allocator.sendRequest(event3);
  List<TaskAttemptContainerAssignedEvent> assigned=allocator.schedule();
  rm.drainEvents();
  Assert.assertEquals("No of assignments must be 0",0,assigned.size());
  nodeManager3.nodeHeartbeat(true);
  nodeManager1.nodeHeartbeat(true);
  rm.drainEvents();
  assigned=allocator.schedule();
  rm.drainEvents();
  checkAssignments(new ContainerRequestEvent[]{event1,event2,event3},assigned,false);
  for (  TaskAttemptContainerAssignedEvent event : assigned) {
    if (event.getTaskAttemptID().equals(event3.getAttemptID())) {
      assigned.remove(event);
      Assert.assertEquals("h3",event.getContainer().getNodeId().getHost());
      break;
    }
  }
  checkAssignments(new ContainerRequestEvent[]{event1,event2},assigned,true);
}
