@Test public void testExceptionOnBackgroundRefreshHandled() throws Exception {
  conf.setLong(CommonConfigurationKeys.HADOOP_SECURITY_GROUPS_CACHE_SECS,1);
  conf.setBoolean(CommonConfigurationKeys.HADOOP_SECURITY_GROUPS_CACHE_BACKGROUND_RELOAD,true);
  FakeTimer timer=new FakeTimer();
  final Groups groups=new Groups(conf,timer);
  groups.cacheGroupsAdd(Arrays.asList(myGroups));
  groups.refresh();
  FakeGroupMapping.clearBlackList();
  groups.getGroups("me");
  groups.cacheGroupsAdd(Arrays.asList("grp3"));
  int startingRequestCount=FakeGroupMapping.getRequestCount();
  FakeGroupMapping.setThrowException(true);
  timer.advance(4 * 1000);
  FakeGroupMapping.pause();
  assertEquals(groups.getGroups("me").size(),2);
  assertEquals(startingRequestCount,FakeGroupMapping.getRequestCount());
  FakeGroupMapping.resume();
  waitForGroupCounters(groups,0,0,0,1);
  FakeGroupMapping.setThrowException(false);
  assertEquals(startingRequestCount + 1,FakeGroupMapping.getRequestCount());
  assertEquals(groups.getGroups("me").size(),2);
  waitForGroupCounters(groups,0,0,1,1);
  assertEquals(startingRequestCount + 2,FakeGroupMapping.getRequestCount());
  assertEquals(groups.getGroups("me").size(),3);
}
