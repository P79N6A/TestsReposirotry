/** 
 * Tests DFSClient.close throws no ConcurrentModificationException if  multiple files are open. Also tests that any cached sockets are closed. (HDFS-3359)
 */
@Test public void testDFSClose() throws Exception {
  Configuration conf=getTestConfiguration();
  MiniDFSCluster cluster=null;
  try {
    cluster=new MiniDFSCluster.Builder(conf).numDataNodes(2).build();
    DistributedFileSystem fileSys=cluster.getFileSystem();
    fileSys.create(new Path("/test/dfsclose/file-0"));
    fileSys.create(new Path("/test/dfsclose/file-1"));
    Path p=new Path("/non-empty-file");
    DFSTestUtil.createFile(fileSys,p,1L,(short)1,0L);
    DFSTestUtil.readFile(fileSys,p);
    fileSys.close();
    DFSClient dfsClient=fileSys.getClient();
    verifyOpsUsingClosedClient(dfsClient);
  }
  finally {
    if (cluster != null) {
      cluster.shutdown();
    }
  }
}
