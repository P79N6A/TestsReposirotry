@Test public void testContainerCompletedWhenUpgrading() throws Exception {
  String serviceName="testContainerCompletedWhenUpgrading";
  MockRunningServiceContext context=createTestContext(rule,serviceName);
  Component comp=context.scheduler.getAllComponents().entrySet().iterator().next().getValue();
  comp.handle(new ComponentEvent(comp.getName(),ComponentEventType.UPGRADE).setTargetSpec(createSpecWithEnv(serviceName,comp.getName(),"key1","val1")).setUpgradeVersion("v2"));
  comp.getAllComponentInstances().forEach(instance -> instance.handle(new ComponentInstanceEvent(instance.getContainer().getId(),ComponentInstanceEventType.UPGRADE)));
  for (  ComponentInstance instance : comp.getAllComponentInstances()) {
    ComponentEvent stopEvent=new ComponentEvent(comp.getName(),ComponentEventType.CONTAINER_COMPLETED).setInstance(instance).setContainerId(instance.getContainer().getId());
    comp.handle(stopEvent);
    instance.handle(new ComponentInstanceEvent(instance.getContainer().getId(),STOP));
  }
  comp.handle(new ComponentEvent(comp.getName(),ComponentEventType.CHECK_STABLE));
  Assert.assertEquals("component not in needs upgrade state",ComponentState.NEEDS_UPGRADE,comp.getComponentSpec().getState());
}
