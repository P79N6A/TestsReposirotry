@Test public void testCancelUpgradeSuccessWhileUpgrading() throws Exception {
  String serviceName="testCancelUpgradeWhileUpgrading";
  MockRunningServiceContext context=createTestContext(rule,serviceName);
  Component comp=context.scheduler.getAllComponents().entrySet().iterator().next().getValue();
  cancelUpgradeWhileUpgrading(context,comp);
  for (  ComponentInstance instance : comp.getAllComponentInstances()) {
    instance.handle(new ComponentInstanceEvent(instance.getContainer().getId(),ComponentInstanceEventType.START));
    instance.handle(new ComponentInstanceEvent(instance.getContainer().getId(),ComponentInstanceEventType.BECOME_READY));
  }
  comp.handle(new ComponentEvent(comp.getName(),ComponentEventType.CHECK_STABLE));
  Assert.assertEquals("component not in stable state",ComponentState.STABLE,comp.getComponentSpec().getState());
  Assert.assertEquals("cancel upgrade failed","val0",comp.getComponentSpec().getConfiguration().getEnv("key1"));
}
