@Test(timeout=TIMEOUT) public void testAutoFinalize() throws Exception {
  ServiceContext context=createServiceContext("testCheckStateAutoFinalize");
  ServiceManager manager=context.getServiceManager();
  manager.getServiceSpec().setState(ServiceState.UPGRADING_AUTO_FINALIZE);
  initUpgrade(context,"v2",true,true,false);
  upgradeAndReadyAllInstances(context);
  GenericTestUtils.waitFor(() -> context.service.getState().equals(ServiceState.STABLE),CHECK_EVERY_MILLIS,TIMEOUT);
  Assert.assertEquals("service not stable",ServiceState.STABLE,manager.getServiceSpec().getState());
  validateUpgradeFinalization(manager.getName(),"v2");
}
