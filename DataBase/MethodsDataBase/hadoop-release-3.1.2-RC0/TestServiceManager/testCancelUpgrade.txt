@Test(timeout=TIMEOUT) public void testCancelUpgrade() throws Exception {
  ServiceContext context=createServiceContext("testCancelUpgrade");
  writeInitialDef(context.service);
  initUpgrade(context,"v2",true,false,false);
  ServiceManager manager=context.getServiceManager();
  Assert.assertEquals("service not upgrading",ServiceState.UPGRADING,manager.getServiceSpec().getState());
  List<String> comps=ServiceApiUtil.resolveCompsDependency(context.service);
  String compA=comps.get(0);
  upgradeInstances(context,compA);
  makeInstancesReadyAfterUpgrade(context,compA);
  context.scheduler.getDispatcher().getEventHandler().handle(new ServiceEvent(ServiceEventType.CANCEL_UPGRADE));
  makeInstancesReadyAfterUpgrade(context,compA);
  GenericTestUtils.waitFor(() -> context.service.getState().equals(ServiceState.STABLE),CHECK_EVERY_MILLIS,TIMEOUT);
  Assert.assertEquals("service upgrade not cancelled",ServiceState.STABLE,manager.getServiceSpec().getState());
  validateUpgradeFinalization(manager.getName(),"v1");
}
