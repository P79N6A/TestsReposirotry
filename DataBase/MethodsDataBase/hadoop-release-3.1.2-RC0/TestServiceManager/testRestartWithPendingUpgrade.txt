@Test(timeout=TIMEOUT) public void testRestartWithPendingUpgrade() throws Exception {
  ServiceContext context=createServiceContext("testRestart");
  initUpgrade(context,"v2",true,false,false);
  ServiceManager manager=context.getServiceManager();
  context.scheduler.getDispatcher().getEventHandler().handle(new ServiceEvent(ServiceEventType.START));
  context.scheduler.getDispatcher().stop();
  Assert.assertEquals("service should still be upgrading",ServiceState.UPGRADING,manager.getServiceSpec().getState());
}
