@Test(timeout=TIMEOUT) public void testFinalize() throws Exception {
  ServiceContext context=createServiceContext("testCheckState");
  initUpgrade(context,"v2",true,false,false);
  ServiceManager manager=context.getServiceManager();
  Assert.assertEquals("service not upgrading",ServiceState.UPGRADING,manager.getServiceSpec().getState());
  upgradeAndReadyAllInstances(context);
  context.scheduler.getDispatcher().getEventHandler().handle(new ServiceEvent(ServiceEventType.START));
  GenericTestUtils.waitFor(() -> context.service.getState().equals(ServiceState.STABLE),CHECK_EVERY_MILLIS,TIMEOUT);
  Assert.assertEquals("service not re-started",ServiceState.STABLE,manager.getServiceSpec().getState());
  validateUpgradeFinalization(manager.getName(),"v2");
}
