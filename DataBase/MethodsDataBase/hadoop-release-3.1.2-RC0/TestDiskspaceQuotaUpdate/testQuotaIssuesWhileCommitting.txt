/** 
 * Test that the cached quota stays correct between the COMMIT and COMPLETE block steps, even if the replication factor is changed during this time.
 */
@Test(timeout=60000) public void testQuotaIssuesWhileCommitting() throws Exception {
  List<MiniDFSCluster.DataNodeProperties> dnprops=new ArrayList<>();
  try {
    for (int i=REPLICATION - 1; i > 0; i--) {
      dnprops.add(cluster.stopDataNode(i));
    }
    DatanodeProtocolClientSideTranslatorPB nnSpy=InternalDataNodeTestUtils.spyOnBposToNN(cluster.getDataNodes().get(0),cluster.getNameNode());
    testQuotaIssuesWhileCommittingHelper(nnSpy,(short)1,(short)4);
    testQuotaIssuesWhileCommittingHelper(nnSpy,(short)4,(short)1);
    testQuotaIssuesWhileCommittingHelper(nnSpy,(short)1,(short)1);
  }
  finally {
    for (    MiniDFSCluster.DataNodeProperties dnprop : dnprops) {
      cluster.restartDataNode(dnprop);
    }
    cluster.waitActive();
  }
}
