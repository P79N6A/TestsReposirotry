@Test public void testReplaceWithDeleteFailure() throws Exception {
  FileSystem mockS3=getMockS3A();
  getJob().getConfiguration().set(FS_S3A_COMMITTER_STAGING_CONFLICT_MODE,CONFLICT_MODE_REPLACE);
  final PartitionedStagingCommitter committer=newJobCommitter();
  pathsExist(mockS3,"dateint=20161116/hour=14");
  when(mockS3.delete(new Path(OUTPUT_PATH,"dateint=20161116/hour=14"),true)).thenThrow(new PathCommitException("fake","Fake IOException for delete"));
  intercept(PathCommitException.class,"Fake IOException for delete","Should throw the fake IOException",() -> committer.commitJob(getJob()));
  verifyReplaceCommitActions(mockS3);
  verifyDeleted(mockS3,"dateint=20161116/hour=14");
  assertTrue("Should have aborted",((PartitionedStagingCommitterForTesting)committer).aborted);
  verifyCompletion(mockS3);
}
