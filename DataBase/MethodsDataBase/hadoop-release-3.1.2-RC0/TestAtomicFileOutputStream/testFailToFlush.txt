/** 
 * Test case where the flush() fails at close time - make sure that we clean up after ourselves and don't touch any existing file at the destination
 */
@Test public void testFailToFlush() throws IOException {
  FileOutputStream fos=new FileOutputStream(DST_FILE);
  fos.write(TEST_STRING_2.getBytes());
  fos.close();
  OutputStream failingStream=createFailingStream();
  failingStream.write(TEST_STRING.getBytes());
  try {
    failingStream.close();
    fail("Close didn't throw exception");
  }
 catch (  IOException ioe) {
  }
  assertEquals(TEST_STRING_2,DFSTestUtil.readFile(DST_FILE));
  assertEquals("Temporary file should have been cleaned up",DST_FILE.getName(),Joiner.on(",").join(TEST_DIR.list()));
}
