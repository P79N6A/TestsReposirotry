/** 
 * Add a received block entry and then replace it. Ensure that a single IBR is generated and that pending receive request state is cleared. This test case verifies the failure in HDFS-5922.
 * @throws InterruptedException
 * @throws IOException
 */
@Test(timeout=60000) public void testReplaceReceivedBlock() throws InterruptedException, IOException {
  try {
    DatanodeProtocolClientSideTranslatorPB nnSpy=spyOnDnCallsToNn();
    injectBlockReceived();
    injectBlockReceived();
    Thread.sleep(2000);
    Mockito.verify(nnSpy,atLeastOnce()).blockReceivedAndDeleted(any(DatanodeRegistration.class),anyString(),any(StorageReceivedDeletedBlocks[].class));
    assertFalse(actor.getIbrManager().sendImmediately());
  }
  finally {
    cluster.shutdown();
    cluster=null;
  }
}
