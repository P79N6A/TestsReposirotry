@Test public void envOverrideExpand() throws Exception {
  Assume.assumeFalse(Functions.isWindows());
  FreeStyleProject p=r.createFreeStyleProject();
  p.getBuildWrappersList().add(new WrapperWithEnvOverrideExpand());
  SpecialEnvSlave slave=new SpecialEnvSlave(tmp.getRoot(),r.createComputerLauncher(null));
  r.jenkins.addNode(slave);
  p.setAssignedNode(slave);
  JDK jdk=new JDK("test","/opt/jdk");
  r.jenkins.getJDKs().add(jdk);
  p.setJDK(jdk);
  CaptureEnvironmentBuilder captureEnvironment=new CaptureEnvironmentBuilder();
  p.getBuildersList().add(captureEnvironment);
  p.getBuildersList().add(new Shell("echo effective PATH=$PATH"));
  FreeStyleBuild b=r.buildAndAssertSuccess(p);
  String expected="/home/jenkins/extra/bin:/opt/jdk/bin:/usr/bin:/bin";
  assertEquals(expected,captureEnvironment.getEnvVars().get("PATH"));
  r.assertLogContains("effective PATH=/opt/jdk/bin:" + expected,b);
}
