@Test @Issue("SECURITY-904") public void symlink_outsideWorkspace_areNotAllowed() throws Exception {
  FreeStyleProject p=j.createFreeStyleProject();
  File secretsFolder=new File(j.jenkins.getRootDir(),"secrets");
  File secretTarget=new File(secretsFolder,"goal.txt");
  String secretContent="secret";
  FileUtils.write(secretTarget,secretContent);
  if (Functions.isWindows()) {
    String script=loadContentFromResource("outsideWorkspaceStructure.bat");
    p.getBuildersList().add(new BatchFile(script));
  }
 else {
    String script=loadContentFromResource("outsideWorkspaceStructure.sh");
    p.getBuildersList().add(new Shell(script));
  }
  assertEquals(Result.SUCCESS,p.scheduleBuild2(0).get().getResult());
  JenkinsRule.WebClient wc=j.createWebClient();
  wc.getOptions().setThrowExceptionOnFailingStatusCode(false);
{
    Page page=wc.goTo(p.getUrl() + "ws/",null);
    assertThat(page.getWebResponse().getStatusCode(),equalTo(HttpURLConnection.HTTP_OK));
    String workspaceContent=page.getWebResponse().getContentAsString();
    assertThat(workspaceContent,allOf(containsString("public1.key"),containsString("intermediateFolder"),containsString("to_secrets1"),containsString("to_secrets_goal1"),not(containsString("to_secrets2")),not(containsString("to_secrets_goal2"))));
  }
{
    Page page=wc.goTo(p.getUrl() + "ws/to_secrets1/",null);
    assertThat(page.getWebResponse().getStatusCode(),equalTo(HttpURLConnection.HTTP_FORBIDDEN));
  }
{
    Page page=wc.goTo(p.getUrl() + "ws/to_secrets_goal1/",null);
    assertThat(page.getWebResponse().getStatusCode(),equalTo(HttpURLConnection.HTTP_FORBIDDEN));
  }
{
    Page page=wc.goTo(p.getUrl() + "ws/intermediateFolder/",null);
    assertThat(page.getWebResponse().getStatusCode(),equalTo(HttpURLConnection.HTTP_OK));
    String workspaceContent=page.getWebResponse().getContentAsString();
    assertThat(workspaceContent,allOf(not(containsString("to_secrets1")),not(containsString("to_secrets_goal1")),containsString("to_secrets2"),containsString("to_secrets_goal2")));
  }
{
    Page page=wc.goTo(p.getUrl() + "ws/intermediateFolder/to_secrets2/",null);
    assertThat(page.getWebResponse().getStatusCode(),equalTo(HttpURLConnection.HTTP_FORBIDDEN));
  }
{
    Page page=wc.goTo(p.getUrl() + "ws/intermediateFolder/to_secrets2/master.key",null);
    assertThat(page.getWebResponse().getStatusCode(),equalTo(HttpURLConnection.HTTP_FORBIDDEN));
  }
{
    Page page=wc.goTo(p.getUrl() + "ws/intermediateFolder/to_secrets_goal2/",null);
    assertThat(page.getWebResponse().getStatusCode(),equalTo(HttpURLConnection.HTTP_FORBIDDEN));
  }
{
    Page page=wc.goTo(p.getUrl() + "ws/**/*.key",null);
    assertThat(page.getWebResponse().getStatusCode(),equalTo(HttpURLConnection.HTTP_OK));
    String workspaceContent=page.getWebResponse().getContentAsString();
    assertThat(workspaceContent,allOf(not(containsString("master.key")),containsString("public1.key"),containsString("public2.key")));
  }
{
    Page zipPage=wc.goTo(p.getUrl() + "ws/*zip*/ws.zip",null);
    assertThat(zipPage.getWebResponse().getStatusCode(),equalTo(HttpURLConnection.HTTP_OK));
    List<String> entryNames=getListOfEntriesInDownloadedZip((UnexpectedPage)zipPage);
    assertThat(entryNames,containsInAnyOrder(p.getName() + "/intermediateFolder/public2.key",p.getName() + "/public1.key"));
  }
{
    Page zipPage=wc.goTo(p.getUrl() + "ws/intermediateFolder/*zip*/intermediateFolder.zip",null);
    assertThat(zipPage.getWebResponse().getStatusCode(),equalTo(HttpURLConnection.HTTP_OK));
    List<String> entryNames=getListOfEntriesInDownloadedZip((UnexpectedPage)zipPage);
    assertThat(entryNames,contains("intermediateFolder/public2.key"));
  }
}
