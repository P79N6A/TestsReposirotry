/** 
 * Makes sure that the output flushing and  {@link RemoteProc#join()} is synced.
 */
@Test public void remoteProcOutputSync() throws Exception {
  assumeFalse("TODO: Implement this test for Windows",Functions.isWindows());
  VirtualChannel ch=createSlaveChannel();
  final Pipe p=Pipe.createRemoteToLocal();
  for (int i=0; i < 10; i++)   ch.callAsync(new ChannelFiller(p.getOut()));
  new Thread(){
    @Override public void run(){
      try {
        IOUtils.drain(p.getIn());
      }
 catch (      IOException e) {
      }
    }
  }
.start();
  RemoteLauncher launcher=new RemoteLauncher(StreamTaskListener.NULL,ch,true);
  String str="";
  for (int i=0; i < 256; i++)   str+="oxox";
  for (int i=0; i < 1000; i++) {
    ByteArrayOutputStream baos=new ByteArrayOutputStream();
    launcher.launch().cmds("echo",str).stdout(baos).join();
    assertEquals(str,baos.toString().trim());
  }
  ch.close();
}
