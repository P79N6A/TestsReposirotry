@Test public void testCliFailure() throws Exception {
  Items.XSTREAM2.addCriticalField(KeywordProperty.class,"criticalField");
{
    FreeStyleProject p=r.createFreeStyleProject();
    p.addProperty(new KeywordProperty(new AcceptOnlySpecificKeyword(AcceptOnlySpecificKeyword.ACCEPT_KEYWORD),new AcceptOnlySpecificKeyword(AcceptOnlySpecificKeyword.ACCEPT_KEYWORD)));
    p.save();
    r.jenkins.setSecurityRealm(r.createDummySecurityRealm());
    CLICommandInvoker.Result ret=new CLICommandInvoker(r,"update-job").withStdin(new ByteArrayInputStream(String.format(CONFIGURATION_TEMPLATE,"badvalue",AcceptOnlySpecificKeyword.ACCEPT_KEYWORD).getBytes())).withArgs(p.getFullName(),"--username","test","--password","test").invoke();
    assertEquals(0,ret.returnCode());
    assertNull(p.getProperty(KeywordProperty.class).getNonCriticalField());
    assertEquals(AcceptOnlySpecificKeyword.ACCEPT_KEYWORD,p.getProperty(KeywordProperty.class).getCriticalField().getKeyword());
    r.jenkins.reload();
    p=r.jenkins.getItemByFullName(p.getFullName(),FreeStyleProject.class);
    assertEquals("badvalue",p.getProperty(KeywordProperty.class).getNonCriticalField().getKeyword());
  }
{
    FreeStyleProject p=r.createFreeStyleProject();
    p.addProperty(new KeywordProperty(new AcceptOnlySpecificKeyword(AcceptOnlySpecificKeyword.ACCEPT_KEYWORD),new AcceptOnlySpecificKeyword(AcceptOnlySpecificKeyword.ACCEPT_KEYWORD)));
    p.save();
    r.jenkins.setSecurityRealm(r.createDummySecurityRealm());
    CLICommandInvoker.Result ret=new CLICommandInvoker(r,"update-job").withStdin(new ByteArrayInputStream(String.format(CONFIGURATION_TEMPLATE,AcceptOnlySpecificKeyword.ACCEPT_KEYWORD,"badvalue").getBytes())).withArgs(p.getFullName(),"--username","test","--password","test").invoke();
    assertNotEquals(0,ret.returnCode());
    assertNotEquals("badvalue",p.getProperty(KeywordProperty.class).getCriticalField().getKeyword());
    r.jenkins.reload();
    p=r.jenkins.getItemByFullName(p.getFullName(),FreeStyleProject.class);
    assertNotEquals("badvalue",p.getProperty(KeywordProperty.class).getCriticalField().getKeyword());
  }
}
