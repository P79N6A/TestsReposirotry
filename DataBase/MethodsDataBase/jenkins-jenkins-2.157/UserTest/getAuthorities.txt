@Test public void getAuthorities() throws Exception {
  JenkinsRule.DummySecurityRealm realm=j.createDummySecurityRealm();
  realm.addGroups("administrator","admins");
  realm.addGroups("alice","users");
  realm.addGroups("bob","users","lpadmin","bob");
  j.jenkins.setSecurityRealm(realm);
  GlobalMatrixAuthorizationStrategy auth=new GlobalMatrixAuthorizationStrategy();
  auth.add(Jenkins.ADMINISTER,"admins");
  auth.add(Permission.READ,"users");
  j.jenkins.setAuthorizationStrategy(auth);
  SecurityContext seccon=SecurityContextHolder.getContext();
  Authentication orig=seccon.getAuthentication();
  try {
    seccon.setAuthentication(User.get("administrator").impersonate());
    assertEquals("[admins]",User.get("administrator").getAuthorities().toString());
    assertEquals("[users]",User.get("alice").getAuthorities().toString());
    assertEquals("[lpadmin, users]",User.get("bob").getAuthorities().toString());
    assertEquals("[]",User.get("MasterOfXaos").getAuthorities().toString());
    seccon.setAuthentication(User.get("alice").impersonate());
    assertEquals("[]",User.get("alice").getAuthorities().toString());
    assertEquals("[]",User.get("bob").getAuthorities().toString());
  }
  finally {
    seccon.setAuthentication(orig);
  }
}
