/** 
 * Make sure that SCMTrigger doesn't trigger another build when a build has just started, but not yet completed its SCM update.
 */
@Test @Issue("JENKINS-2671") public void simultaneousPollAndBuild() throws Exception {
  FreeStyleProject p=j.createFreeStyleProject();
  final OneShotEvent checkoutStarted=new OneShotEvent();
  p.setScm(new TestSCM(checkoutStarted));
  Future<FreeStyleBuild> build=p.scheduleBuild2(0,new Cause.UserCause());
  checkoutStarted.block();
  assertFalse("SCM-poll after build has started should wait until that build finishes SCM-update",p.pollSCMChanges(StreamTaskListener.fromStdout()));
  build.get();
}
