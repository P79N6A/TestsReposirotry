/** 
 * Validate proper statuses are persisted and install status is cleared when invoking appropriate methods on  {@link InstallUtil}
 */
@Test public void testSaveAndRestoreInstallingPlugins() throws Exception {
  final List<UpdateCenterJob> updates=new ArrayList<>();
  final Map<String,String> nameMap=new HashMap<>();
  new UpdateCenter(){
{
      new UpdateSite("foo","http://omg.org"){
{
          for (          String name : Arrays.asList("pending-plug:Pending","installing-plug:Installing","failure-plug:Failure","success-plug:Success")) {
            String statusType=name.split(":")[1];
            name=name.split(":")[0];
            InstallationStatus status;
            if ("Success".equals(statusType)) {
              status=Mockito.mock(Success.class);
            }
 else             if ("Failure".equals(statusType)) {
              status=Mockito.mock(Failure.class);
            }
 else             if ("Installing".equals(statusType)) {
              status=Mockito.mock(Installing.class);
            }
 else {
              status=Mockito.mock(Pending.class);
            }
            nameMap.put(statusType,status.getClass().getSimpleName());
            JSONObject json=new JSONObject();
            json.put("name",name);
            json.put("version","1.1");
            json.put("url","http://google.com");
            json.put("dependencies",new JSONArray());
            Plugin p=new Plugin(getId(),json);
            InstallationJob job=new InstallationJob(p,null,null,false);
            job.status=status;
            job.setCorrelationId(UUID.randomUUID());
            updates.add(job);
          }
        }
      }
;
    }
  }
;
  InstallUtil.persistInstallStatus(updates);
  Map<String,String> persisted=InstallUtil.getPersistedInstallStatus();
  Assert.assertEquals(nameMap.get("Pending"),persisted.get("pending-plug"));
  Assert.assertEquals("Pending",persisted.get("installing-plug"));
  Assert.assertEquals(nameMap.get("Failure"),persisted.get("failure-plug"));
  Assert.assertEquals(nameMap.get("Success"),persisted.get("success-plug"));
  InstallUtil.clearInstallStatus();
  persisted=InstallUtil.getPersistedInstallStatus();
  Assert.assertNull(persisted);
}
