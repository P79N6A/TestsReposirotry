@Test @Issue("SECURITY-794") public void roundtrip() throws Exception {
  final String VALID_URL="https://www.google.com";
  final String INVALID_URL="only-crappy-letters";
  ZipExtractionInstaller installer=new ZipExtractionInstaller("",VALID_URL,"");
  j.jenkins.getJDKs().add(new JDK("test",tmp.getRoot().getAbsolutePath(),Arrays.asList(new InstallSourceProperty(Arrays.<ToolInstaller>asList(installer)))));
  JenkinsRule.WebClient wc=j.createWebClient();
  SpyingJavaScriptEngine jsEngine=new SpyingJavaScriptEngine(wc,"ZipExtractionInstaller/checkUrl",HttpMethod.POST);
  wc.setJavaScriptEngine(jsEngine);
  HtmlPage page=wc.goTo("configureTools");
  XMLHttpRequest lastRequest=jsEngine.getLastRequest();
  String body=URLDecoder.decode(getPrivateWebRequestField(lastRequest).getRequestBody(),"UTF-8");
  assertThat(body,containsString(VALID_URL));
  assertEquals(FormValidation.ok().renderHtml(),lastRequest.getResponseText());
  HtmlTextInput urlInput=page.getDocumentElement().getOneHtmlElementByAttribute("input","value",VALID_URL);
  urlInput.setAttribute("value",INVALID_URL);
  j.submit(page.getFormByName("config"));
  JDK jdk=j.jenkins.getJDK("test");
  InstallSourceProperty isp=jdk.getProperties().get(InstallSourceProperty.class);
  assertEquals(1,isp.installers.size());
  assertEquals(INVALID_URL,isp.installers.get(ZipExtractionInstaller.class).getUrl());
  wc.goTo("configureTools");
  lastRequest=jsEngine.getLastRequest();
  body=URLDecoder.decode(getPrivateWebRequestField(lastRequest).getRequestBody(),"UTF-8");
  assertThat(body,containsString(INVALID_URL));
  assertThat(lastRequest.getResponseText(),containsString(Messages.ZipExtractionInstaller_malformed_url()));
}
