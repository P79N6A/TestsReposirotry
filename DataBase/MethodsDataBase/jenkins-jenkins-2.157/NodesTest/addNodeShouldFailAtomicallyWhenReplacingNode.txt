@Test @Issue("JENKINS-50599") public void addNodeShouldFailAtomicallyWhenReplacingNode() throws Exception {
  Node oldNode=r.createSlave("foo","",null);
  r.jenkins.addNode(oldNode);
  InvalidNode newNode=new InvalidNode("foo","temp",r.createComputerLauncher(null));
  try {
    r.jenkins.addNode(newNode);
    fail("Adding the node should have thrown an exception during serialization");
  }
 catch (  IOException e) {
    String className=InvalidNode.class.getName();
    assertThat("The exception should be from failing to serialize the node",e.getMessage(),containsString("Failed to serialize " + className + "#cl for class "+ className));
  }
  assertThat("The old node should still exist since #addNode threw an exception",r.jenkins.getNode("foo"),sameInstance(oldNode));
}
