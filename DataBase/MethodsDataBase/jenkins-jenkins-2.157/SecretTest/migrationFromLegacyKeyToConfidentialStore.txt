/** 
 * Secret persisted with Jenkins.getSecretKey() should still decrypt OK.
 */
@Test public void migrationFromLegacyKeyToConfidentialStore() throws Exception {
  SecretKey legacy=HistoricalSecrets.getLegacyKey();
  for (  String str : new String[]{"Hello world","","\u0000unprintable"}) {
    Cipher cipher=Secret.getCipher("AES");
    cipher.init(Cipher.ENCRYPT_MODE,legacy);
    String old=new String(Base64.encode(cipher.doFinal((str + HistoricalSecrets.MAGIC).getBytes("UTF-8"))));
    Secret s=Secret.fromString(old);
    assertEquals("secret by the old key should decrypt",str,s.getPlainText());
    assertNotEquals("but when encrypting, ConfidentialKey should be in use",old,s.getEncryptedValue());
  }
}
