/** 
 * Tests various ways to send the Basic auth.
 */
@Test public void testVariousWaysToCall() throws Exception {
  ApiTokenTestHelper.enableLegacyBehavior();
  j.jenkins.setSecurityRealm(j.createDummySecurityRealm());
  User foo=User.getById("foo",true);
  User.getById("bar",true);
  wc=j.createWebClient();
  makeRequestAndVerify("anonymous");
  spySecurityListener.authenticatedCalls.assertNoNewEvents();
  spySecurityListener.failedToAuthenticateCalls.assertNoNewEvents();
  wc=j.createWebClient();
  wc.withBasicApiToken("foo");
  makeRequestAndVerify("foo");
  spySecurityListener.authenticatedCalls.assertLastEventIsAndThenRemoveIt(u -> u.getUsername().equals("foo"));
  wc=j.createWebClient();
  wc.withBasicCredentials("foo","abcd" + foo.getProperty(ApiTokenProperty.class).getApiToken());
  makeRequestAndFail();
  spySecurityListener.failedToAuthenticateCalls.assertLastEventIsAndThenRemoveIt("foo");
  wc=j.createWebClient();
  wc.withBasicCredentials("foo");
  makeRequestAndVerify("foo");
  spySecurityListener.authenticatedCalls.assertLastEventIsAndThenRemoveIt(u -> u.getUsername().equals("foo"));
  wc=j.createWebClient();
  wc.withBasicCredentials("foo","bar");
  makeRequestAndFail();
  spySecurityListener.failedToAuthenticateCalls.assertLastEventIsAndThenRemoveIt("foo");
  wc=j.createWebClient();
  wc.login("bar");
  spySecurityListener.authenticatedCalls.assertLastEventIsAndThenRemoveIt(u -> u.getUsername().equals("bar"));
  spySecurityListener.loggedInCalls.assertLastEventIsAndThenRemoveIt("bar");
  makeRequestAndVerify("bar");
  spySecurityListener.authenticatedCalls.assertNoNewEvents();
  spySecurityListener.failedToAuthenticateCalls.assertNoNewEvents();
  wc.withBasicCredentials("bar");
  makeRequestAndVerify("bar");
  spySecurityListener.authenticatedCalls.assertNoNewEvents();
  spySecurityListener.failedToAuthenticateCalls.assertNoNewEvents();
  wc.withBasicCredentials("foo","bar");
  makeRequestAndFail();
  spySecurityListener.failedToAuthenticateCalls.assertLastEventIsAndThenRemoveIt("foo");
}
