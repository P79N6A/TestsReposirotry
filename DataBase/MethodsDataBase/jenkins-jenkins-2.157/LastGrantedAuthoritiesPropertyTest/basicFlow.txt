@Test public void basicFlow() throws Exception {
  j.jenkins.setSecurityRealm(new TestSecurityRealm());
  JenkinsRule.WebClient wc=j.createWebClient();
  wc.login("alice","alice:development:us");
  hudson.model.User u=hudson.model.User.get("alice");
  LastGrantedAuthoritiesProperty p=u.getProperty(LastGrantedAuthoritiesProperty.class);
  assertAuthorities(p,"authenticated:alice:development:us");
  assertAuthorities(u.impersonate(),"authenticated:alice:development:us");
  HtmlPage pg=wc.goTo("user/alice/configure");
  j.submit(pg.getFormByName("config"));
  p=u.getProperty(LastGrantedAuthoritiesProperty.class);
  assertAuthorities(p,"authenticated:alice:development:us");
  assertAuthorities(u.impersonate(),"authenticated:alice:development:us");
  wc.login("alice","alice:development:uk");
  p=u.getProperty(LastGrantedAuthoritiesProperty.class);
  assertAuthorities(p,"authenticated:alice:development:uk");
  assertAuthorities(u.impersonate(),"authenticated:alice:development:uk");
  wc.login("alice","alice:authenticated:development:uk");
  p=u.getProperty(LastGrantedAuthoritiesProperty.class);
  assertAuthorities(p,"authenticated:alice:development:uk");
  assertAuthorities(u.impersonate(),"authenticated:alice:development:uk");
}
