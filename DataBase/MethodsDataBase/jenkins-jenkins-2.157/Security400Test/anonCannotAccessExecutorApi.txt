@Test @Issue("SECURITY-404") public void anonCannotAccessExecutorApi() throws Exception {
  j.jenkins.setSecurityRealm(j.createDummySecurityRealm());
  FullControlOnceLoggedInAuthorizationStrategy authorizationStrategy=new FullControlOnceLoggedInAuthorizationStrategy();
  authorizationStrategy.setAllowAnonymousRead(false);
  j.jenkins.setAuthorizationStrategy(authorizationStrategy);
  JenkinsRule.WebClient wc=j.createWebClient();
  wc.getOptions().setThrowExceptionOnFailingStatusCode(false);
  FreeStyleProject p=j.createFreeStyleProject();
  Semaphore semaphore=new Semaphore(0);
  p.getBuildersList().add(new SemaphoredBuilder(semaphore,new AtomicInteger(0)));
  j.jenkins.setNumExecutors(1);
{
    Page page=wc.goTo("computers/0/executors/0/api/xml",null);
    checkPageIsRedirectedToLogin(page);
    assertRequestWasNotBlocked();
  }
{
    QueueTaskFuture<FreeStyleBuild> futureBuild=p.scheduleBuild2(0);
    futureBuild.waitForStart();
    wc.login("foo");
    Page page=wc.goTo("computers/0/executors/0/api/xml",null);
    assertEquals(200,page.getWebResponse().getStatusCode());
    assertThat(page.getWebResponse().getContentAsString(),containsString(p.getUrl()));
    assertRequestWasNotBlocked();
    semaphore.release(1);
    j.assertBuildStatus(Result.SUCCESS,futureBuild);
    wc=j.createWebClient();
    wc.getOptions().setThrowExceptionOnFailingStatusCode(false);
  }
{
    QueueTaskFuture<FreeStyleBuild> futureBuild=p.scheduleBuild2(0);
    futureBuild.waitForStart();
    Page page=wc.goTo("computers/0/executors/0/api/xml",null);
    checkPageIsRedirectedToLogin(page);
    assertThat(page.getWebResponse().getContentAsString(),not(containsString(p.getUrl())));
    assertRequestWasNotBlocked();
    semaphore.release(1);
    j.assertBuildStatus(Result.SUCCESS,futureBuild);
  }
}
