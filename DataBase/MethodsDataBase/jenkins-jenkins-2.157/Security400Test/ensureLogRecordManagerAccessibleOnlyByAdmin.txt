@Test @Issue("SECURITY-471") public void ensureLogRecordManagerAccessibleOnlyByAdmin() throws Exception {
  j.jenkins.setCrumbIssuer(null);
  j.jenkins.setSecurityRealm(j.createDummySecurityRealm());
  j.jenkins.setAuthorizationStrategy(new MockAuthorizationStrategy().grant(Jenkins.ADMINISTER).everywhere().to("admin").grant(Jenkins.READ).everywhere().to("user"));
  String logNameForAdmin="testLoggerAdmin";
  String logNameForUser="testLoggerUser";
{
    JenkinsRule.WebClient wc=j.createWebClient();
    wc.login("admin");
    wc.getOptions().setThrowExceptionOnFailingStatusCode(false);
    assertEquals(404,wc.goTo("log/" + logNameForAdmin + "/autoCompleteLoggerName/?value=a",null).getWebResponse().getStatusCode());
    assertRequestWasNotBlocked();
    WebRequest request=new WebRequest(new URL(j.getURL() + "log/newLogRecorder/?name=" + logNameForAdmin),HttpMethod.POST);
    wc.getOptions().setRedirectEnabled(false);
    Page page=wc.getPage(request);
    assertEquals(302,page.getWebResponse().getStatusCode());
    assertRequestWasNotBlocked();
    j.assertGoodStatus(wc.goTo("log/" + logNameForAdmin + "/autoCompleteLoggerName/?value=a",null));
    assertRequestWasNotBlocked();
    assertEquals(404,wc.goTo("log/" + "nonExistingName" + "/autoCompleteLoggerName/?value=a",null).getWebResponse().getStatusCode());
    assertRequestWasNotBlocked();
  }
{
    JenkinsRule.WebClient wc=j.createWebClient();
    wc.login("user");
    wc.getOptions().setThrowExceptionOnFailingStatusCode(false);
    assertEquals(403,wc.goTo("log/" + logNameForUser + "/autoCompleteLoggerName/?value=a",null).getWebResponse().getStatusCode());
    assertRequestWasNotBlocked();
    WebRequest request=new WebRequest(new URL(j.getURL() + "log/newLogRecorder/?name=" + logNameForUser),HttpMethod.POST);
    wc.getOptions().setRedirectEnabled(false);
    Page page=wc.getPage(request);
    assertEquals(403,page.getWebResponse().getStatusCode());
    assertRequestWasNotBlocked();
    assertEquals(403,wc.goTo("log/" + logNameForUser + "/autoCompleteLoggerName/?value=a",null).getWebResponse().getStatusCode());
    assertRequestWasNotBlocked();
  }
{
    JenkinsRule.WebClient wc=j.createWebClient();
    wc.login("admin");
    wc.getOptions().setThrowExceptionOnFailingStatusCode(false);
    assertEquals(404,wc.goTo("log/" + logNameForUser + "/autoCompleteLoggerName/?value=a",null).getWebResponse().getStatusCode());
    assertRequestWasNotBlocked();
  }
}
