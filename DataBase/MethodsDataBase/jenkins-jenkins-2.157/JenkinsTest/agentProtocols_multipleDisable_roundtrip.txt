@Test @Issue("JENKINS-39465") public void agentProtocols_multipleDisable_roundtrip() throws Exception {
  final Set<String> defaultProtocols=Collections.unmodifiableSet(j.jenkins.getAgentProtocols());
  assertProtocolEnabled(MockOptOutProtocol1.NAME,"after startup");
  final Set<String> newProtocols=new HashSet<>(defaultProtocols);
  newProtocols.remove(MockOptOutProtocol1.NAME);
  j.jenkins.setAgentProtocols(newProtocols);
  j.jenkins.save();
  assertProtocolDisabled(MockOptOutProtocol1.NAME,"before the roundtrip");
  final Set<String> agentProtocolsBeforeReload=j.jenkins.getAgentProtocols();
  j.jenkins.reload();
  assertFalse("The protocol list must have been really refreshed",agentProtocolsBeforeReload == j.jenkins.getAgentProtocols());
  assertThat("We should have disabled one protocol",j.jenkins.getAgentProtocols().size(),equalTo(defaultProtocols.size() - 1));
  assertProtocolDisabled(MockOptOutProtocol1.NAME,"after the roundtrip");
}
