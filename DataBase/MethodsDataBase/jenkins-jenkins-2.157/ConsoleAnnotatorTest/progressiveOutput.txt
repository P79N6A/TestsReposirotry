/** 
 * Tests the progressive output by making sure that the state of  {@link ConsoleAnnotator}s are maintained across different progressiveLog calls.
 */
@Test public void progressiveOutput() throws Exception {
  final SequenceLock lock=new SequenceLock();
  JenkinsRule.WebClient wc=r.createWebClient();
  FreeStyleProject p=r.createFreeStyleProject();
  p.getBuildersList().add(new TestBuilder(){
    public boolean perform(    AbstractBuild<?,?> build,    Launcher launcher,    BuildListener listener) throws InterruptedException, IOException {
      lock.phase(0);
      lock.phase(2);
      listener.getLogger().println("line1");
      lock.phase(4);
      listener.getLogger().println("line2");
      lock.phase(6);
      return true;
    }
  }
);
  Future<FreeStyleBuild> f=p.scheduleBuild2(0);
  lock.phase(1);
  FreeStyleBuild b=p.getBuildByNumber(1);
  ProgressiveLogClient plc=new ProgressiveLogClient(wc,b);
  plc.next();
  lock.phase(3);
  assertEquals("<b tag=1>line1</b>\r\n",plc.next());
  lock.phase(5);
  assertEquals("<b tag=2>line2</b>\r\n",plc.next());
  lock.done();
  r.assertBuildStatusSuccess(f);
}
