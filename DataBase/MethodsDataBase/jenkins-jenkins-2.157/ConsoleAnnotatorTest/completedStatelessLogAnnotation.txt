/** 
 * Let the build complete, and see if stateless  {@link ConsoleAnnotator} annotations happen as expected.
 */
@Issue("JENKINS-6031") @Test public void completedStatelessLogAnnotation() throws Exception {
  FreeStyleProject p=r.createFreeStyleProject();
  p.getBuildersList().add(new TestBuilder(){
    public boolean perform(    AbstractBuild<?,?> build,    Launcher launcher,    BuildListener listener) throws InterruptedException, IOException {
      listener.getLogger().println("---");
      listener.getLogger().println("ooo");
      listener.getLogger().println("ooo");
      return true;
    }
  }
);
  FreeStyleBuild b=r.buildAndAssertSuccess(p);
  HtmlPage rsp=r.createWebClient().getPage(b,"console");
  assertEquals(1,DomNodeUtil.selectNodes(rsp,"//B[@class='demo']").size());
  TextPage raw=(TextPage)r.createWebClient().goTo(b.getUrl() + "consoleText","text/plain");
  System.out.println(raw.getContent());
  String nl=System.getProperty("line.separator");
  assertTrue(raw.getContent().contains(nl + "---" + nl+ "ooo"+ nl+ "ooo"+ nl));
  String xml=rsp.asXml();
  assertEquals(xml,3,xml.split("ooo").length);
}
