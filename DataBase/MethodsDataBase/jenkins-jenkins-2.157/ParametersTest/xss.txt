@Issue("SECURITY-353") @Test public void xss() throws Exception {
  j.jenkins.setMarkupFormatter(new MyMarkupFormatter());
  FreeStyleProject p=j.createFreeStyleProject("p");
  StringParameterDefinition param=new StringParameterDefinition("<param name>","<param default>","<param description>");
  assertEquals("<b>[</b>param description<b>]</b>",param.getFormattedDescription());
  p.addProperty(new ParametersDefinitionProperty(param));
  WebClient wc=j.createWebClient();
  wc.getOptions().setThrowExceptionOnFailingStatusCode(false);
  HtmlPage page=wc.getPage(p,"build?delay=0sec");
  collector.checkThat(page.getWebResponse().getStatusCode(),is(HttpStatus.SC_METHOD_NOT_ALLOWED));
  String text=page.getWebResponse().getContentAsString();
  collector.checkThat("build page should escape param name",text,containsString("&lt;param name&gt;"));
  collector.checkThat("build page should not leave param name unescaped",text,not(containsString("<param name>")));
  collector.checkThat("build page should escape param default",text,containsString("&lt;param default&gt;"));
  collector.checkThat("build page should not leave param default unescaped",text,not(containsString("<param default>")));
  collector.checkThat("build page should mark up param description",text,containsString("<b>[</b>param description<b>]</b>"));
  collector.checkThat("build page should not leave param description unescaped",text,not(containsString("<param description>")));
  HtmlForm form=page.getFormByName("parameters");
  HtmlTextInput value=form.getInputByValue("<param default>");
  value.setText("<param value>");
  j.submit(form);
  j.waitUntilNoActivity();
  FreeStyleBuild b=p.getBuildByNumber(1);
  page=j.createWebClient().getPage(b,"parameters/");
  text=page.getWebResponse().getContentAsString();
  collector.checkThat("parameters page should escape param name",text,containsString("&lt;param name&gt;"));
  collector.checkThat("parameters page should not leave param name unescaped",text,not(containsString("<param name>")));
  collector.checkThat("parameters page should escape param value",text,containsString("&lt;param value&gt;"));
  collector.checkThat("parameters page should not leave param value unescaped",text,not(containsString("<param value>")));
  collector.checkThat("parameters page should mark up param description",text,containsString("<b>[</b>param description<b>]</b>"));
  collector.checkThat("parameters page should not leave param description unescaped",text,not(containsString("<param description>")));
}
