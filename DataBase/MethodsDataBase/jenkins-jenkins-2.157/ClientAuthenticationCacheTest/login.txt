@Issue("SECURITY-466") @Test public void login() throws Exception {
  File jar=tmp.newFile("jenkins-cli.jar");
  FileUtils.copyURLToFile(r.jenkins.getJnlpJars("jenkins-cli.jar").getURL(),jar);
  r.jenkins.setSecurityRealm(r.createDummySecurityRealm());
  r.jenkins.setAuthorizationStrategy(new FullControlOnceLoggedInAuthorizationStrategy());
  assertCLI(0,"Authenticated as: anonymous",jar,"who-am-i");
  assertCLI(0,null,jar,"login","--username","dev","--password","dev");
  try {
    assertCLI(0,"Authenticated as: dev",jar,"who-am-i");
    ClientAuthenticationCache cache=new ClientAuthenticationCache(null);
    String val=cache.props.getProperty(cache.getPropertyKey());
    assertNotNull(val);
    System.err.println(val);
    Secret s=Secret.decrypt(val);
    if (s != null && s.getPlainText().equals("dev")) {
      val=Secret.fromString("admin").getEncryptedValue();
    }
    System.err.println(val);
    val=val.replace("dev","admin");
    System.err.println(val);
    cache.props.put(cache.getPropertyKey(),val);
    cache.save();
    assertCLI(0,"Authenticated as: anonymous",jar,"who-am-i");
  }
  finally {
    assertCLI(0,null,jar,"logout");
  }
}
