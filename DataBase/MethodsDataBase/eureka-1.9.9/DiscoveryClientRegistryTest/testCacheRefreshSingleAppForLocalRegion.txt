@Test public void testCacheRefreshSingleAppForLocalRegion() throws Exception {
  InstanceInfoGenerator instanceGen=InstanceInfoGenerator.newBuilder(2,"testApp").build();
  Applications initialApps=instanceGen.takeDelta(1);
  String vipAddress=initialApps.getRegisteredApplications().get(0).getInstances().get(0).getVIPAddress();
  DiscoveryClientResource vipClientResource=discoveryClientResource.fork().withVipFetch(vipAddress).build();
  when(requestHandler.getVip(vipAddress,TEST_REMOTE_REGION)).thenReturn(anEurekaHttpResponse(200,initialApps).type(MediaType.APPLICATION_JSON_TYPE).build());
  EurekaClient vipClient=vipClientResource.getClient();
  assertThat(countInstances(vipClient.getApplications()),is(equalTo(1)));
  when(requestHandler.getVip(vipAddress,TEST_REMOTE_REGION)).thenReturn(anEurekaHttpResponse(200,instanceGen.toApplications()).type(MediaType.APPLICATION_JSON_TYPE).build());
  assertThat(vipClientResource.awaitCacheUpdate(5,TimeUnit.SECONDS),is(true));
  assertThat(countInstances(vipClient.getApplications()),is(equalTo(2)));
}
