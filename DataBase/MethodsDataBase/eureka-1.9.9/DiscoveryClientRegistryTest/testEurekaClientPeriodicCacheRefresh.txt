@Test public void testEurekaClientPeriodicCacheRefresh() throws Exception {
  InstanceInfoGenerator instanceGen=InstanceInfoGenerator.newBuilder(3,1).build();
  Applications initialApps=instanceGen.takeDelta(1);
  when(requestHandler.getApplications(TEST_REMOTE_REGION)).thenReturn(anEurekaHttpResponse(200,initialApps).type(MediaType.APPLICATION_JSON_TYPE).build());
  EurekaClient client=discoveryClientResource.getClient();
  assertThat(countInstances(client.getApplications()),is(equalTo(1)));
  when(requestHandler.getDelta(TEST_REMOTE_REGION)).thenReturn(anEurekaHttpResponse(200,instanceGen.takeDelta(1)).type(MediaType.APPLICATION_JSON_TYPE).build());
  assertThat(discoveryClientResource.awaitCacheUpdate(5,TimeUnit.SECONDS),is(true));
  when(requestHandler.getDelta(TEST_REMOTE_REGION)).thenReturn(anEurekaHttpResponse(200,instanceGen.takeDelta(1)).type(MediaType.APPLICATION_JSON_TYPE).build());
  assertThat(discoveryClientResource.awaitCacheUpdate(5,TimeUnit.SECONDS),is(true));
  assertThat(countInstances(client.getApplications()),is(equalTo(3)));
}
