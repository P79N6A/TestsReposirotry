@Test public void testRedirectsAreFollowedAndClientIsPinnedToTheLastServer() throws Exception {
  setupRedirect();
  RedirectingEurekaHttpClient httpClient=new RedirectingEurekaHttpClient(SERVICE_URL,factory,dnsService);
  httpClient.getApplications();
  verify(factory,times(2)).newClient(Matchers.<EurekaEndpoint>anyVararg());
  verify(sourceClient,times(1)).getApplications();
  verify(dnsService,times(1)).resolveIp("another.discovery.test");
  verify(redirectedClient,times(1)).getApplications();
  httpClient.getApplications();
  verify(factory,times(2)).newClient(Matchers.<EurekaEndpoint>anyVararg());
  verify(sourceClient,times(1)).getApplications();
  verify(dnsService,times(1)).resolveIp("another.discovery.test");
  verify(redirectedClient,times(2)).getApplications();
}
