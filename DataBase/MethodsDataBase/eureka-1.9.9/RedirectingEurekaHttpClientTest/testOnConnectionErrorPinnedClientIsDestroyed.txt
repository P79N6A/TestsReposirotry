@Test public void testOnConnectionErrorPinnedClientIsDestroyed() throws Exception {
  setupRedirect();
  RedirectingEurekaHttpClient httpClient=new RedirectingEurekaHttpClient(SERVICE_URL,factory,dnsService);
  httpClient.getApplications();
  verify(redirectedClient,times(1)).getApplications();
  when(redirectedClient.getApplications()).thenThrow(new TransportException("simulated network error"));
  try {
    httpClient.getApplications();
    fail("Expected transport error");
  }
 catch (  Exception ignored) {
  }
  reset(factory,sourceClient,dnsService,redirectedClient);
  setupRedirect();
  httpClient.getApplications();
  verify(factory,times(2)).newClient(Matchers.<EurekaEndpoint>anyVararg());
  verify(sourceClient,times(1)).getApplications();
  verify(dnsService,times(1)).resolveIp("another.discovery.test");
  verify(redirectedClient,times(1)).getApplications();
}
