/** 
 * Tests AmazonHttpClient's behavior upon simulated RuntimeException (which should be handled as an unexpected failure and not retried).
 */
@Test public void testUnexpectedFailureHandling(){
  NullPointerException simulatedNPE=new NullPointerException("fake NullPointerException");
  injectMockHttpClient(testedClient,new ThrowingExceptionHttpClient(simulatedNPE));
  ExecutionContext context=new ExecutionContext(true);
  Request<?> testedRepeatableRequest=getSampleRequestWithRepeatableContent(originalRequest);
  try {
    testedClient.requestExecutionBuilder().request(testedRepeatableRequest).errorResponseHandler(errorResponseHandler).executionContext(context).execute();
    Assert.fail("AmazonClientException is expected.");
  }
 catch (  NullPointerException npe) {
    Assert.assertTrue(simulatedNPE == npe);
  }
  verifyExpectedContextData(retryCondition,null,null,0);
  verifyExpectedContextData(backoffStrategy,null,null,0);
  Assert.assertEquals(1,context.getAwsRequestMetrics().getTimingInfo().getCounter(AWSRequestMetrics.Field.RequestCount.toString()).intValue());
}
