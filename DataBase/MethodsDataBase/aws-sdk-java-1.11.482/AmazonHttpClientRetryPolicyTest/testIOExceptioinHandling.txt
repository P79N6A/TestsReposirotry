/** 
 * Tests AmazonHttpClient's behavior upon simulated IOException during executing the http request when the request payload is repeatable.
 */
@Test public void testIOExceptioinHandling(){
  IOException simulatedIOException=new IOException("fake IOException");
  injectMockHttpClient(testedClient,new ThrowingExceptionHttpClient(simulatedIOException));
  ExecutionContext context=new ExecutionContext(true);
  Request<?> testedRepeatableRequest=getSampleRequestWithRepeatableContent(originalRequest);
  AmazonClientException expectedClientException=null;
  try {
    testedClient.requestExecutionBuilder().request(testedRepeatableRequest).errorResponseHandler(errorResponseHandler).executionContext(context).execute();
    Assert.fail("AmazonClientException is expected.");
  }
 catch (  AmazonClientException ace) {
    Assert.assertTrue(simulatedIOException == ace.getCause());
    expectedClientException=ace;
  }
  verifyExpectedContextData(retryCondition,originalRequest,expectedClientException,EXPECTED_SHOULD_RETRY_CALL_COUNT);
  verifyExpectedContextData(backoffStrategy,originalRequest,expectedClientException,EXPECTED_RETRY_COUNT);
  Assert.assertEquals(EXPECTED_RETRY_COUNT + 1,context.getAwsRequestMetrics().getTimingInfo().getCounter(AWSRequestMetrics.Field.RequestCount.toString()).intValue());
}
