/** 
 * Tests AmazonHttpClient's behavior upon simulated service exceptions when the request payload is not repeatable.
 */
@Test public void testServiceExceptionHandlingWithNonRepeatableRequestContent(){
  int random500StatusCode=500 + random.nextInt(100);
  String randomErrorCode=UUID.randomUUID().toString();
  injectMockHttpClient(testedClient,new ReturnServiceErrorHttpClient(random500StatusCode,randomErrorCode));
  ExecutionContext context=new ExecutionContext(true);
  Request<?> testedNonRepeatableRequest=getSampleRequestWithNonRepeatableContent(originalRequest);
  try {
    testedClient.requestExecutionBuilder().request(testedNonRepeatableRequest).errorResponseHandler(errorResponseHandler).executionContext(context).execute();
    Assert.fail("AmazonServiceException is expected.");
  }
 catch (  AmazonServiceException ase) {
    Assert.assertEquals(random500StatusCode,ase.getStatusCode());
    Assert.assertEquals(randomErrorCode,ase.getErrorCode());
  }
  verifyExpectedContextData(retryCondition,null,null,EXPECTED_SHOULD_RETRY_CALL_COUNT);
  verifyExpectedContextData(backoffStrategy,null,null,EXPECTED_RETRY_COUNT);
  Assert.assertEquals(EXPECTED_RETRY_COUNT + 1,context.getAwsRequestMetrics().getTimingInfo().getCounter(AWSRequestMetrics.Field.RequestCount.toString()).intValue());
}
