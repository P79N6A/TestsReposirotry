@Test public void testIgnoresMarshallingException() throws IOException, InterruptedException {
  ObjectWriter marshaller=mock(ObjectWriter.class);
  ApiCallAttemptMonitoringEvent event1=new ApiCallAttemptMonitoringEvent();
  ApiCallAttemptMonitoringEvent event2=new ApiCallAttemptMonitoringEvent();
  when(marshaller.writeValueAsBytes(eq(event1))).thenThrow(new RuntimeException("bad event"));
  when(marshaller.writeValueAsBytes(eq(event2))).thenReturn(new byte[16]);
  AsynchronousAgentDispatcher dispatcher=new AsynchronousAgentDispatcher(marshaller);
  dispatcher.init();
  try {
    dispatcher.addWriteTask(event1,channel,8192);
    dispatcher.addWriteTask(event2,channel,8192);
    Thread.sleep(100);
    verify(marshaller).writeValueAsBytes(eq(event1));
    verify(marshaller).writeValueAsBytes(eq(event2));
    verify(channel,times(1)).write(any(ByteBuffer.class));
  }
  finally {
    dispatcher.release();
  }
}
