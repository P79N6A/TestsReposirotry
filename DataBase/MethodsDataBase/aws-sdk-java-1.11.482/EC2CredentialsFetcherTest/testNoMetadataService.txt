/** 
 * Tests how the credentials provider behaves when the server is not running.
 */
@Test public void testNoMetadataService() throws Exception {
  stubForErrorResponse();
  TestCredentialsProvider credentialsProvider=new TestCredentialsProvider();
  try {
    credentialsProvider.getCredentials();
    fail("Expected an AmazonClientException, but wasn't thrown");
  }
 catch (  AmazonClientException ace) {
    assertNotNull(ace.getMessage());
  }
  stubForSuccessResonseWithCustomExpirationDate(200,new Date(System.currentTimeMillis() + ONE_MINUTE * 4).toString());
  credentialsProvider.getCredentials();
  credentialsProvider.setLastInstanceProfileCheck(new Date(System.currentTimeMillis() - (ONE_MINUTE * 61)));
  stubForErrorResponse();
  try {
    credentialsProvider.getCredentials();
    fail("Expected an AmazonClientException, but wasn't thrown");
  }
 catch (  AmazonClientException ace) {
    assertNotNull(ace.getMessage());
  }
}
