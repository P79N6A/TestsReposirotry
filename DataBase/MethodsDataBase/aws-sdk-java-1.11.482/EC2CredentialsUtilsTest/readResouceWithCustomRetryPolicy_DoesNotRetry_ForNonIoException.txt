/** 
 * When readResource is called with custom retry policy and the exception is not an IOException, then the request is not retried.
 */
@Test @SuppressWarnings("unchecked") public void readResouceWithCustomRetryPolicy_DoesNotRetry_ForNonIoException() throws IOException {
  generateStub(500,"Non Json error body");
  Mockito.when(mockConnection.connectToEndpoint(eq(endpoint),any(Map.class))).thenCallRealMethod();
  try {
    new EC2CredentialsUtils(mockConnection).readResource(endpoint,customRetryPolicy,new HashMap<String,String>());
    fail("Expected an AmazonServiceException");
  }
 catch (  AmazonServiceException ase) {
    Mockito.verify(mockConnection,Mockito.times(1)).connectToEndpoint(eq(endpoint),any(Map.class));
  }
}
