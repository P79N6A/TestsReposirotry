/** 
 * When readResource is called with custom retry policy and additional headers, the SDK User-Agent should be added.
 */
@Test @SuppressWarnings("unchecked") public void readResouceWithCustomRetryPolicyAndHeaders_AddsSDKUserAgent() throws IOException {
  Mockito.when(mockConnection.connectToEndpoint(eq(endpoint),any(Map.class))).thenThrow(new IOException());
  try {
    Map<String,String> headers=new HashMap<String,String>();
    headers.put("Foo","Bar");
    new EC2CredentialsUtils(mockConnection).readResource(endpoint,customRetryPolicy,headers);
    fail("Expected an IOexception");
  }
 catch (  IOException exception) {
    Matcher<Map<? extends String,? extends String>> expectedHeaders=allOf(hasEntry("User-Agent",USER_AGENT),hasEntry("Foo","Bar"));
    Mockito.verify(mockConnection,Mockito.times(CustomRetryPolicy.MAX_RETRIES + 1)).connectToEndpoint(eq(endpoint),(Map<String,String>)argThat(expectedHeaders));
  }
}
