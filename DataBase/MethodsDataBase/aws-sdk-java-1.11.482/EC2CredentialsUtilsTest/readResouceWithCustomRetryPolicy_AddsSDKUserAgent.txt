/** 
 * When readResource is called with custom retry policy, the SDK User-Agent should be added.
 */
@Test @SuppressWarnings("unchecked") public void readResouceWithCustomRetryPolicy_AddsSDKUserAgent() throws IOException {
  Mockito.when(mockConnection.connectToEndpoint(eq(endpoint),any(Map.class))).thenThrow(new IOException());
  try {
    new EC2CredentialsUtils(mockConnection).readResource(endpoint,customRetryPolicy,null);
    fail("Expected an IOexception");
  }
 catch (  IOException exception) {
    Matcher<Map<? extends String,? extends String>> expectedHeaders=hasEntry("User-Agent",USER_AGENT);
    Mockito.verify(mockConnection,Mockito.times(CustomRetryPolicy.MAX_RETRIES + 1)).connectToEndpoint(eq(endpoint),(Map<String,String>)argThat(expectedHeaders));
  }
}
