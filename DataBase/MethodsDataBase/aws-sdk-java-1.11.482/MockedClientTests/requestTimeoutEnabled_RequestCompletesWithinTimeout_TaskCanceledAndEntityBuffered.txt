@Test public void requestTimeoutEnabled_RequestCompletesWithinTimeout_TaskCanceledAndEntityBuffered() throws Exception {
  ClientConfiguration config=new ClientConfiguration().withRequestTimeout(5 * 1000).withMaxErrorRetry(0);
  ConnectionManagerAwareHttpClient rawHttpClient=createRawHttpClientSpy(config);
  HttpResponseProxy responseProxy=createHttpResponseProxySpy();
  doReturn(responseProxy).when(rawHttpClient).execute(any(HttpRequestBase.class),any(HttpContext.class));
  httpClient=new AmazonHttpClient(config,rawHttpClient,null);
  try {
    execute(httpClient,createMockGetRequest());
    fail("Exception expected");
  }
 catch (  AmazonClientException e) {
    NullResponseHandler.assertIsUnmarshallingException(e);
  }
  assertResponseIsBuffered(responseProxy);
  ScheduledThreadPoolExecutor requestTimerExecutor=httpClient.getHttpRequestTimer().getExecutor();
  assertTimerNeverTriggered(requestTimerExecutor);
  assertCanceledTasksRemoved(requestTimerExecutor);
  assertEquals(1,requestTimerExecutor.getPoolSize());
  assertCoreThreadsShutDownAfterBeingIdle(requestTimerExecutor);
}
