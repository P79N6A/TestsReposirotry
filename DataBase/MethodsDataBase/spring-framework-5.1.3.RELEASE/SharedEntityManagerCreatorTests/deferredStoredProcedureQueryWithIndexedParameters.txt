@Test public void deferredStoredProcedureQueryWithIndexedParameters(){
  EntityManagerFactory emf=mock(EntityManagerFactory.class);
  EntityManager targetEm=mock(EntityManager.class);
  StoredProcedureQuery query=mock(StoredProcedureQuery.class);
  given(emf.createEntityManager()).willReturn(targetEm);
  given(targetEm.createStoredProcedureQuery("x")).willReturn(query);
  willReturn("y").given(query).getOutputParameterValue(0);
  willReturn("z").given(query).getOutputParameterValue(2);
  given(targetEm.isOpen()).willReturn(true);
  EntityManager em=SharedEntityManagerCreator.createSharedEntityManager(emf);
  StoredProcedureQuery spq=em.createStoredProcedureQuery("x");
  spq.registerStoredProcedureParameter(0,String.class,ParameterMode.OUT);
  spq.registerStoredProcedureParameter(1,Number.class,ParameterMode.IN);
  spq.registerStoredProcedureParameter(2,Object.class,ParameterMode.INOUT);
  spq.execute();
  assertEquals("y",spq.getOutputParameterValue(0));
  try {
    spq.getOutputParameterValue(1);
    fail("Should have thrown IllegalArgumentException");
  }
 catch (  IllegalArgumentException ex) {
  }
  assertEquals("z",spq.getOutputParameterValue(2));
  verify(query).registerStoredProcedureParameter(0,String.class,ParameterMode.OUT);
  verify(query).registerStoredProcedureParameter(1,Number.class,ParameterMode.IN);
  verify(query).registerStoredProcedureParameter(2,Object.class,ParameterMode.INOUT);
  verify(query).execute();
  verify(targetEm).close();
  verifyNoMoreInteractions(query);
  verifyNoMoreInteractions(targetEm);
}
