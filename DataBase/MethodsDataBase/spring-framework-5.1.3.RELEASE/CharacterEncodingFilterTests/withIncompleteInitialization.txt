@Test public void withIncompleteInitialization() throws Exception {
  HttpServletRequest request=mock(HttpServletRequest.class);
  given(request.getCharacterEncoding()).willReturn(null);
  given(request.getAttribute(WebUtils.ERROR_REQUEST_URI_ATTRIBUTE)).willReturn(null);
  given(request.getAttribute(filteredName(CharacterEncodingFilter.class.getName()))).willReturn(null);
  MockHttpServletResponse response=new MockHttpServletResponse();
  FilterChain filterChain=mock(FilterChain.class);
  CharacterEncodingFilter filter=new CharacterEncodingFilter(ENCODING);
  filter.doFilter(request,response,filterChain);
  verify(request).setCharacterEncoding(ENCODING);
  verify(request).setAttribute(filteredName(CharacterEncodingFilter.class.getName()),Boolean.TRUE);
  verify(request).removeAttribute(filteredName(CharacterEncodingFilter.class.getName()));
  verify(filterChain).doFilter(request,response);
}
