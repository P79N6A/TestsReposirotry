@Test public void forceEncodingAlwaysSetsEncoding() throws Exception {
  HttpServletRequest request=mock(HttpServletRequest.class);
  request.setCharacterEncoding(ENCODING);
  given(request.getAttribute(WebUtils.ERROR_REQUEST_URI_ATTRIBUTE)).willReturn(null);
  given(request.getAttribute(filteredName(FILTER_NAME))).willReturn(null);
  HttpServletResponse response=mock(HttpServletResponse.class);
  FilterChain filterChain=mock(FilterChain.class);
  CharacterEncodingFilter filter=new CharacterEncodingFilter(ENCODING,true);
  filter.init(new MockFilterConfig(FILTER_NAME));
  filter.doFilter(request,response,filterChain);
  verify(request).setAttribute(filteredName(FILTER_NAME),Boolean.TRUE);
  verify(request).removeAttribute(filteredName(FILTER_NAME));
  verify(response).setCharacterEncoding(ENCODING);
  verify(filterChain).doFilter(request,response);
}
