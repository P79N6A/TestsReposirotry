@Test public void closeStatusChangesToSessionNotReliable() throws Exception {
  BlockingSession session=new BlockingSession();
  session.setId("123");
  session.setOpen(true);
  CountDownLatch sentMessageLatch=session.getSentMessageLatch();
  int sendTimeLimit=100;
  int bufferSizeLimit=1024;
  final ConcurrentWebSocketSessionDecorator decorator=new ConcurrentWebSocketSessionDecorator(session,sendTimeLimit,bufferSizeLimit);
  Executors.newSingleThreadExecutor().submit((Runnable)() -> {
    TextMessage message=new TextMessage("slow message");
    try {
      decorator.sendMessage(message);
    }
 catch (    IOException e) {
      e.printStackTrace();
    }
  }
);
  assertTrue(sentMessageLatch.await(5,TimeUnit.SECONDS));
  Thread.sleep(sendTimeLimit + 100);
  decorator.close(CloseStatus.PROTOCOL_ERROR);
  assertEquals("CloseStatus should have changed to SESSION_NOT_RELIABLE",CloseStatus.SESSION_NOT_RELIABLE,session.getCloseStatus());
}
