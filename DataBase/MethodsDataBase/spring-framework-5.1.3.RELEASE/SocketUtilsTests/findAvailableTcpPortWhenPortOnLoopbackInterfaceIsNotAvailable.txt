@Test public void findAvailableTcpPortWhenPortOnLoopbackInterfaceIsNotAvailable() throws Exception {
  int port=SocketUtils.findAvailableTcpPort();
  ServerSocket socket=ServerSocketFactory.getDefault().createServerSocket(port,1,InetAddress.getByName("localhost"));
  try {
    exception.expect(IllegalStateException.class);
    exception.expectMessage(startsWith("Could not find an available TCP port"));
    exception.expectMessage(endsWith("after 1 attempts"));
    SocketUtils.findAvailableTcpPort(port,port);
  }
  finally {
    socket.close();
  }
}
