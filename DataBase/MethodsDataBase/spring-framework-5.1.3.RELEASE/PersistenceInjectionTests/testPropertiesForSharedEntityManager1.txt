/** 
 * Binds an EMF to the thread and tests if EM with different properties generate new EMs or not.
 */
@Test public void testPropertiesForSharedEntityManager1(){
  Properties props=new Properties();
  props.put("foo","bar");
  EntityManager em=mock(EntityManager.class);
  given(mockEmf.createEntityManager(props)).willReturn(em);
  given(em.getDelegate()).willReturn(new Object());
  given(em.isOpen()).willReturn(true);
  PersistenceAnnotationBeanPostProcessor pabpp=new MockPersistenceAnnotationBeanPostProcessor();
  DefaultPrivatePersistenceContextFieldWithProperties transactionalFieldWithProperties=new DefaultPrivatePersistenceContextFieldWithProperties();
  DefaultPrivatePersistenceContextField transactionalField=new DefaultPrivatePersistenceContextField();
  pabpp.postProcessProperties(null,transactionalFieldWithProperties,"bean1");
  pabpp.postProcessProperties(null,transactionalField,"bean2");
  assertNotNull(transactionalFieldWithProperties.em);
  assertNotNull(transactionalField.em);
  assertNotNull(transactionalFieldWithProperties.em.getDelegate());
  try {
    TransactionSynchronizationManager.bindResource(mockEmf,new EntityManagerHolder(em));
    assertNotNull(transactionalField.em.getDelegate());
    verify(em).close();
  }
  finally {
    TransactionSynchronizationManager.unbindResource(mockEmf);
  }
}
