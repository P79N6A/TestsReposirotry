@Test public void testBatchUpdateWithInClause() throws Exception {
  @SuppressWarnings("unchecked") Map<String,Object>[] parameters=new Map[2];
  parameters[0]=Collections.singletonMap("ids",Arrays.asList(1,2));
  parameters[1]=Collections.singletonMap("ids",Arrays.asList(3,4));
  final int[] rowsAffected=new int[]{1,2};
  given(preparedStatement.executeBatch()).willReturn(rowsAffected);
  given(connection.getMetaData()).willReturn(databaseMetaData);
  JdbcTemplate template=new JdbcTemplate(dataSource,false);
  namedParameterTemplate=new NamedParameterJdbcTemplate(template);
  int[] actualRowsAffected=namedParameterTemplate.batchUpdate("delete sometable where id in (:ids)",parameters);
  assertEquals("executed 2 updates",2,actualRowsAffected.length);
  InOrder inOrder=inOrder(preparedStatement);
  inOrder.verify(preparedStatement).setObject(1,1);
  inOrder.verify(preparedStatement).setObject(2,2);
  inOrder.verify(preparedStatement).addBatch();
  inOrder.verify(preparedStatement).setObject(1,3);
  inOrder.verify(preparedStatement).setObject(2,4);
  inOrder.verify(preparedStatement).addBatch();
  inOrder.verify(preparedStatement,atLeastOnce()).close();
  verify(connection,atLeastOnce()).close();
}
