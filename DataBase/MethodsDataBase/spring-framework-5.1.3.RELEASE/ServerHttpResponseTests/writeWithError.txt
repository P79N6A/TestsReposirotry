@Test public void writeWithError() throws Exception {
  TestServerHttpResponse response=new TestServerHttpResponse();
  response.getHeaders().setContentLength(12);
  IllegalStateException error=new IllegalStateException("boo");
  response.writeWith(Flux.error(error)).onErrorResume(ex -> Mono.empty()).block();
  assertFalse(response.statusCodeWritten);
  assertFalse(response.headersWritten);
  assertFalse(response.cookiesWritten);
  assertFalse(response.getHeaders().containsKey(HttpHeaders.CONTENT_LENGTH));
  assertTrue(response.body.isEmpty());
}
