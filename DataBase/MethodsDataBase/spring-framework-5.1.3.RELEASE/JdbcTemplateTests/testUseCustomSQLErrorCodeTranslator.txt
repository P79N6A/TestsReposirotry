/** 
 * Test that we see an SQLException translated using Error Code. If we provide the SQLExceptionTranslator, we shouldn't use a connection to get the metadata
 */
@Test public void testUseCustomSQLErrorCodeTranslator() throws Exception {
  final SQLException sqlException=new SQLException("I have a known problem","07000",1054);
  final String sql="SELECT ID FROM CUSTOMER";
  given(this.resultSet.next()).willReturn(true);
  given(this.connection.createStatement()).willReturn(this.preparedStatement);
  JdbcTemplate template=new JdbcTemplate();
  template.setDataSource(this.dataSource);
  template.setExceptionTranslator(new SQLStateSQLExceptionTranslator());
  template.afterPropertiesSet();
  this.thrown.expect(BadSqlGrammarException.class);
  this.thrown.expect(exceptionCause(sameInstance(sqlException)));
  try {
    template.query(sql,(RowCallbackHandler)rs -> {
      throw sqlException;
    }
);
  }
  finally {
    verify(this.resultSet).close();
    verify(this.preparedStatement).close();
    verify(this.connection).close();
  }
}
