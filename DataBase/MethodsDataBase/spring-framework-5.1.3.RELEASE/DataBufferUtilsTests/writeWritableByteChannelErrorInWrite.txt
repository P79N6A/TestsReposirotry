@Test public void writeWritableByteChannelErrorInWrite() throws Exception {
  DataBuffer foo=stringBuffer("foo");
  DataBuffer bar=stringBuffer("bar");
  Flux<DataBuffer> flux=Flux.just(foo,bar);
  WritableByteChannel channel=mock(WritableByteChannel.class);
  when(channel.write(any())).thenAnswer(invocation -> {
    ByteBuffer buffer=invocation.getArgument(0);
    int written=buffer.remaining();
    buffer.position(buffer.limit());
    return written;
  }
).thenThrow(new IOException());
  Flux<DataBuffer> writeResult=DataBufferUtils.write(flux,channel);
  StepVerifier.create(writeResult).consumeNextWith(stringConsumer("foo")).consumeNextWith(stringConsumer("bar")).expectError(IOException.class).verify(Duration.ofSeconds(3));
  channel.close();
}
