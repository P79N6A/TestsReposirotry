@Test public void testNestedWorkspaces2() throws Exception {
  Nd4j.getWorkspaceManager().setDefaultWorkspaceConfiguration(basicConfiguration);
  try (Nd4jWorkspace ws1=(Nd4jWorkspace)Nd4j.getWorkspaceManager().getWorkspaceForCurrentThread("WS1").notifyScopeEntered()){
    INDArray array1=Nd4j.create(100);
    assertEquals(100 * Nd4j.sizeOfDataType(),ws1.getHostOffset());
    for (int x=1; x <= 100; x++) {
      try (Nd4jWorkspace ws2=(Nd4jWorkspace)Nd4j.getWorkspaceManager().getWorkspaceForCurrentThread(loopConfiguration,"WS2").notifyScopeEntered()){
        INDArray array2=Nd4j.create(x);
      }
       Nd4jWorkspace ws2=(Nd4jWorkspace)Nd4j.getWorkspaceManager().getWorkspaceForCurrentThread("WS2");
      long reqMemory=x * Nd4j.sizeOfDataType();
      assertEquals(reqMemory + reqMemory % 8,ws2.getLastCycleAllocations());
    }
    Nd4j.getWorkspaceManager().getWorkspaceForCurrentThread("WS2").initializeWorkspace();
    assertEquals(100 * Nd4j.sizeOfDataType(),((Nd4jWorkspace)Nd4j.getWorkspaceManager().getWorkspaceForCurrentThread("WS2")).getCurrentSize());
  }
   assertNull(Nd4j.getMemoryManager().getCurrentWorkspace());
}
