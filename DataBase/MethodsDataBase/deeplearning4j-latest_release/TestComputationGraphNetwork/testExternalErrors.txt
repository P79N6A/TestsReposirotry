@Test public void testExternalErrors(){
  for (  WorkspaceMode ws : WorkspaceMode.values()) {
    log.info("Workspace mode: " + ws);
    Nd4j.getRandom().setSeed(12345);
    INDArray inData=Nd4j.rand(3,10);
    INDArray outData=Nd4j.rand(3,10);
    Nd4j.getRandom().setSeed(12345);
    ComputationGraphConfiguration standard=new NeuralNetConfiguration.Builder().updater(new Sgd(0.1)).trainingWorkspaceMode(ws).inferenceWorkspaceMode(ws).seed(12345).graphBuilder().addInputs("in").addLayer("l0",new DenseLayer.Builder().nIn(10).nOut(10).build(),"in").addLayer("out",new OutputLayer.Builder().lossFunction(LossFunctions.LossFunction.MSE).nIn(10).nOut(10).build(),"l0").setOutputs("out").build();
    ComputationGraph s=new ComputationGraph(standard);
    s.init();
    Nd4j.getRandom().setSeed(12345);
    ComputationGraphConfiguration external=new NeuralNetConfiguration.Builder().updater(new Sgd(0.1)).trainingWorkspaceMode(ws).inferenceWorkspaceMode(ws).seed(12345).graphBuilder().addInputs("in").addLayer("l0",new DenseLayer.Builder().nIn(10).nOut(10).build(),"in").setOutputs("l0").build();
    ComputationGraph e=new ComputationGraph(external);
    e.init();
    s.setInputs(inData);
    s.setLabels(outData);
    s.computeGradientAndScore();
    Gradient sGrad=s.gradient();
    s.feedForward(new INDArray[]{inData},true,false);
    org.deeplearning4j.nn.layers.OutputLayer ol=(org.deeplearning4j.nn.layers.OutputLayer)s.getLayer(1);
    ol.setLabels(outData);
    Pair<Gradient,INDArray> olPairStd=ol.backpropGradient(null,LayerWorkspaceMgr.noWorkspaces());
    INDArray olEpsilon=olPairStd.getSecond();
    e.feedForward(new INDArray[]{inData},true,false);
    Gradient extErrorGrad=e.backpropGradient(olEpsilon);
    int nParamsDense=10 * 10 + 10;
    assertEquals(sGrad.gradient().get(NDArrayIndex.point(0),NDArrayIndex.interval(0,nParamsDense)),extErrorGrad.gradient());
    Nd4j.getWorkspaceManager().destroyAllWorkspacesForCurrentThread();
  }
}
