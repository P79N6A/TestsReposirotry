@Test public void testSimplerMergeBackProp(){
  NeuralNetConfiguration.Builder overallConf=new NeuralNetConfiguration.Builder().updater(new Sgd(0.9)).activation(Activation.IDENTITY).optimizationAlgo(OptimizationAlgorithm.STOCHASTIC_GRADIENT_DESCENT);
  ComputationGraphConfiguration conf=overallConf.graphBuilder().addInputs("inCentre","inRight").addLayer("denseCentre0",new DenseLayer.Builder().nIn(2).nOut(2).build(),"inCentre").addLayer("denseRight0",new DenseLayer.Builder().nIn(2).nOut(2).build(),"inRight").addVertex("mergeRight",new MergeVertex(),"denseCentre0","denseRight0").addLayer("outRight",new OutputLayer.Builder(LossFunctions.LossFunction.MSE).nIn(4).nOut(2).build(),"mergeRight").setOutputs("outRight").build();
  ComputationGraph modelToTune=new ComputationGraph(conf);
  modelToTune.init();
  MultiDataSet randData=new MultiDataSet(new INDArray[]{Nd4j.rand(2,2),Nd4j.rand(2,2)},new INDArray[]{Nd4j.rand(2,2)});
  INDArray denseCentre0=modelToTune.feedForward(randData.getFeatures(),false).get("denseCentre0");
  MultiDataSet otherRandData=new MultiDataSet(new INDArray[]{denseCentre0,randData.getFeatures(1)},randData.getLabels());
  ComputationGraphConfiguration otherConf=overallConf.graphBuilder().addInputs("denseCentre0","inRight").addLayer("denseRight0",new DenseLayer.Builder().nIn(2).nOut(2).build(),"inRight").addVertex("mergeRight",new MergeVertex(),"denseCentre0","denseRight0").addLayer("outRight",new OutputLayer.Builder(LossFunctions.LossFunction.MSE).nIn(4).nOut(2).build(),"mergeRight").setOutputs("outRight").build();
  ComputationGraph modelOther=new ComputationGraph(otherConf);
  modelOther.init();
  modelOther.getLayer("denseRight0").setParams(modelToTune.getLayer("denseRight0").params());
  modelOther.getLayer("outRight").setParams(modelToTune.getLayer("outRight").params());
  modelToTune.getVertex("denseCentre0").setLayerAsFrozen();
  ComputationGraph modelNow=new TransferLearning.GraphBuilder(modelToTune).setFeatureExtractor("denseCentre0").build();
  int n=0;
  while (n < 5) {
    if (n == 0) {
      assertEquals(modelToTune.feedForward(randData.getFeatures(),false).get("mergeRight"),modelOther.feedForward(otherRandData.getFeatures(),false).get("mergeRight"));
      assertEquals(modelNow.feedForward(randData.getFeatures(),false).get("mergeRight"),modelOther.feedForward(otherRandData.getFeatures(),false).get("mergeRight"));
    }
    modelOther.fit(otherRandData);
    modelToTune.fit(randData);
    modelNow.fit(randData);
    assertEquals(otherRandData.getFeatures(0),modelNow.feedForward(randData.getFeatures(),false).get("denseCentre0"));
    assertEquals(otherRandData.getFeatures(0),modelToTune.feedForward(randData.getFeatures(),false).get("denseCentre0"));
    assertEquals(modelOther.getLayer("denseRight0").params(),modelNow.getLayer("denseRight0").params());
    assertEquals(modelOther.getLayer("denseRight0").params(),modelToTune.getLayer("denseRight0").params());
    assertEquals(modelOther.getLayer("outRight").params(),modelNow.getLayer("outRight").params());
    assertEquals(modelOther.getLayer("outRight").params(),modelToTune.getLayer("outRight").params());
    n++;
  }
}
