@Test public void testModelAndUpdaterParamsUpdate_2() throws Exception {
  Nd4j.create(1);
  val config=VoidConfiguration.builder().meshBuildMode(MeshBuildMode.MESH).build();
  val connector=new DummyTransport.Connector();
  val rootTransport=new DummyTransport(rootId,connector,rootId,config);
  val rootServer=new ModelParameterServer(config,rootTransport,true);
  val rootUpdatesCounter=new AtomicInteger(0);
  rootTransport.addRequestConsumer(ModelParametersRequest.class,new Consumer<ModelParametersRequest>(){
    @Override public void accept(    ModelParametersRequest modelParametersRequest) throws Exception {
      val msg=new ModelParametersMessage(java.util.UUID.randomUUID().toString(),Nd4j.create(10));
      msg.setRequestId(modelParametersRequest.getRequestId());
      rootTransport.sendMessage(msg,modelParametersRequest.getOriginatorId());
    }
  }
);
  rootTransport.addRequestConsumer(UpdaterParametersRequest.class,new Consumer<UpdaterParametersRequest>(){
    @Override public void accept(    UpdaterParametersRequest updatersParametersRequest) throws Exception {
      val msg=new UpdaterParametersMessage(java.util.UUID.randomUUID().toString(),Nd4j.create(10));
      msg.setRequestId(updatersParametersRequest.getRequestId());
      rootTransport.sendMessage(msg,updatersParametersRequest.getOriginatorId());
    }
  }
);
  rootServer.addUpdatesSubscriber(new AbstractUpdatesHandler(){
    @Override public INDArray getParametersArray(){
      return Nd4j.create(10,10);
    }
    @Override public void onNext(    INDArray array){
      assertNotNull(array);
      rootUpdatesCounter.incrementAndGet();
    }
  }
);
  connector.register(rootTransport);
  rootServer.launch();
  val updatedModel=new AtomicBoolean(false);
  val updatedUpdater=new AtomicBoolean(false);
  val gotGradients=new AtomicBoolean(false);
  val servers=new ArrayList<ModelParameterServer>();
  val transports=new ArrayList<DummyTransport>();
  for (int e=0; e < 32; e++) {
    val clientTransport=new DummyTransport(String.valueOf(e),connector,rootId,config);
    val clientServer=new ModelParameterServer(config,clientTransport,false);
    clientServer.configure(config,clientTransport,new UpdaterParametersProvider(){
      @Override public INDArray getUpdaterParameters(){
        return Nd4j.create(10,10);
      }
    }
);
    servers.add(clientServer);
    transports.add(clientTransport);
    connector.register(clientTransport);
    clientServer.launch();
    log.info("Client [{}] started",e);
  }
  Thread.sleep(100);
  val rootMesh=rootTransport.getMesh();
  val badServer=servers.get(23);
  val badTransport=transports.get(23);
  val badId=badTransport.id();
  val badNode=rootMesh.getNodeById(badId);
  val upstreamId=badNode.getUpstreamNode().getId();
  log.info("Upstream: [{}]; Number of downstreams: [{}]",upstreamId,badNode.numberOfDownstreams());
  connector.dropConnection(badId);
  val clientTransport=new DummyTransport(badId,connector,rootId);
  val clientServer=new ModelParameterServer(clientTransport,false);
  clientServer.addUpdaterParamsSubscriber(new AbstractSubscriber<INDArray>(){
    @Override public void onNext(    INDArray array){
      assertNotNull(array);
      updatedUpdater.set(true);
    }
  }
);
  clientServer.addModelParamsSubscriber(new AbstractSubscriber<INDArray>(){
    @Override public void onNext(    INDArray array){
      assertNotNull(array);
      updatedModel.set(true);
    }
  }
);
  clientServer.addUpdatesSubscriber(new AbstractUpdatesHandler(){
    @Override public INDArray getParametersArray(){
      return null;
    }
    @Override public void onNext(    INDArray array){
      assertNotNull(array);
      assertEquals(Nd4j.linspace(1,10,100).reshape(10,10),array);
      gotGradients.set(true);
    }
  }
);
  connector.register(clientTransport);
  clientServer.launch();
  connector.blockUntilFinished();
  log.info("New upstream: {}",clientTransport.getMesh().getRootNode().getId());
  val serv=servers.get(27);
  serv.sendUpdate(Nd4j.linspace(1,10,100).reshape(10,10));
  connector.blockUntilFinished();
  int failedCnt=0;
  for (int e=0; e < 32; e++) {
    if (e != 23 && e != 27)     if (servers.get(e).getUpdates().size() == 0)     failedCnt++;
  }
  assertEquals("Some nodes got no updates:",0,failedCnt);
  assertTrue(updatedModel.get());
  assertTrue(gotGradients.get());
  assertTrue(updatedUpdater.get());
}
