/** 
 * This test ensures, that memory amount assigned to buffer is enough for any number of updates
 * @throws Exception
 */
@Test public void testStore1() throws Exception {
  int numParams=100000;
  int workers[]=new int[]{2,4,8};
  for (  int numWorkers : workers) {
    EncodingHandler handler=new EncodingHandler(new FixedThresholdAlgorithm(1e-3),null,null,false);
    val bufferSize=EncodedGradientsAccumulator.getOptimalBufferSize(numParams,numWorkers,2);
    log.info("Workers: {}; Buffer size: {} bytes",numWorkers,bufferSize);
    EncodedGradientsAccumulator accumulator=new EncodedGradientsAccumulator(numWorkers,handler,bufferSize,2,null,false);
    for (int e=10; e < numParams / 10; e++) {
      INDArray encoded=handler.encodeUpdates(0,0,getGradients(numParams,e,2e-3));
      accumulator.receiveUpdate(encoded);
      for (int i=0; i < accumulator.messages.size(); i++) {
        accumulator.messages.get(i).clear();
      }
    }
  }
}
