@Test public void testCustomLayer() throws Exception {
  File f=new ClassPathResource("regression_testing/100a/CustomLayerExample_100a.bin").getTempFileFromArchive();
  try {
    MultiLayerNetwork.load(f,true);
    fail("Expected exception");
  }
 catch (  Exception e) {
    String msg=e.getMessage();
    assertTrue(msg,msg.contains("NeuralNetConfiguration.registerLegacyCustomClassesForJSON"));
  }
  NeuralNetConfiguration.registerLegacyCustomClassesForJSON(CustomLayer.class);
  MultiLayerNetwork net=MultiLayerNetwork.load(f,true);
  DenseLayer l0=(DenseLayer)net.getLayer(0).conf().getLayer();
  assertEquals(new ActivationTanH(),l0.getActivationFn());
  assertEquals(0.03,l0.getL2(),1e-6);
  assertEquals(new RmsProp(0.95),l0.getIUpdater());
  CustomLayer l1=(CustomLayer)net.getLayer(1).conf().getLayer();
  assertEquals(new ActivationTanH(),l1.getActivationFn());
  assertEquals(new ActivationSigmoid(),l1.getSecondActivationFunction());
  assertEquals(new RmsProp(0.95),l1.getIUpdater());
  INDArray outExp;
  File f2=new ClassPathResource("regression_testing/100a/CustomLayerExample_Output_100a.bin").getTempFileFromArchive();
  try (DataInputStream dis=new DataInputStream(new FileInputStream(f2))){
    outExp=Nd4j.read(dis);
  }
   INDArray in;
  File f3=new ClassPathResource("regression_testing/100a/CustomLayerExample_Input_100a.bin").getTempFileFromArchive();
  try (DataInputStream dis=new DataInputStream(new FileInputStream(f3))){
    in=Nd4j.read(dis);
  }
   INDArray outAct=net.output(in);
  assertEquals(outExp,outAct);
  f=new ClassPathResource("regression_testing/100a/CustomLayerExample_Graph_100a.bin").getTempFileFromArchive();
  new LegacyLayerDeserializer().getLegacyNamesMap().remove("CustomLayer");
  try {
    ComputationGraph.load(f,true);
    fail("Expected exception");
  }
 catch (  Exception e) {
    String msg=e.getMessage();
    assertTrue(msg,msg.contains("NeuralNetConfiguration.registerLegacyCustomClassesForJSON"));
  }
  NeuralNetConfiguration.registerLegacyCustomClassesForJSON(CustomLayer.class);
  ComputationGraph graph=ComputationGraph.load(f,true);
  f2=new ClassPathResource("regression_testing/100a/CustomLayerExample_Graph_Output_100a.bin").getTempFileFromArchive();
  try (DataInputStream dis=new DataInputStream(new FileInputStream(f2))){
    outExp=Nd4j.read(dis);
  }
   outAct=graph.outputSingle(in);
  assertEquals(outExp,outAct);
}
