@Test public void compareImplementationsCompGraph(){
  for (  WorkspaceMode wsm : new WorkspaceMode[]{WorkspaceMode.NONE,WorkspaceMode.ENABLED}) {
    log.info("*** Starting workspace mode: " + wsm);
    ComputationGraphConfiguration conf1=new NeuralNetConfiguration.Builder().activation(Activation.TANH).weightInit(WeightInit.XAVIER).updater(new Adam()).trainingWorkspaceMode(wsm).inferenceWorkspaceMode(wsm).graphBuilder().addInputs("in").layer("0",new Bidirectional(Bidirectional.Mode.ADD,new GravesLSTM.Builder().nIn(10).nOut(10).build()),"in").layer("1",new Bidirectional(Bidirectional.Mode.ADD,new GravesLSTM.Builder().nIn(10).nOut(10).build()),"0").layer("2",new RnnOutputLayer.Builder().lossFunction(LossFunctions.LossFunction.MSE).nIn(10).nOut(10).build(),"1").setOutputs("2").build();
    ComputationGraphConfiguration conf2=new NeuralNetConfiguration.Builder().activation(Activation.TANH).weightInit(WeightInit.XAVIER).updater(new Adam()).trainingWorkspaceMode(wsm).inferenceWorkspaceMode(wsm).graphBuilder().addInputs("in").layer("0",new GravesBidirectionalLSTM.Builder().nIn(10).nOut(10).build(),"in").layer("1",new GravesBidirectionalLSTM.Builder().nIn(10).nOut(10).build(),"0").layer("2",new RnnOutputLayer.Builder().lossFunction(LossFunctions.LossFunction.MSE).nIn(10).nOut(10).build(),"1").setOutputs("2").build();
    ComputationGraph net1=new ComputationGraph(conf1);
    net1.init();
    ComputationGraph net2=new ComputationGraph(conf2);
    net2.init();
    assertEquals(net1.numParams(),net2.numParams());
    for (int i=0; i < 3; i++) {
      int n1=(int)net1.getLayer(i).numParams();
      int n2=(int)net2.getLayer(i).numParams();
      assertEquals(n1,n2);
    }
    net2.setParams(net1.params());
    INDArray in=Nd4j.rand(new int[]{3,10,5});
    INDArray out1=net1.outputSingle(in);
    INDArray out2=net2.outputSingle(in);
    assertEquals(out1,out2);
    INDArray labels=Nd4j.rand(new int[]{3,10,5});
    net1.setInput(0,in);
    net1.setLabels(labels);
    net2.setInput(0,in);
    net2.setLabels(labels);
    net1.computeGradientAndScore();
    net2.computeGradientAndScore();
    assertEquals(net1.score(),net2.score(),1e-6);
    Gradient g1=net1.gradient();
    Gradient g2=net2.gradient();
    assertEquals(g1.gradient(),g2.gradient());
    ComputationGraphUpdater u1=(ComputationGraphUpdater)net1.getUpdater();
    ComputationGraphUpdater u2=(ComputationGraphUpdater)net2.getUpdater();
    assertEquals(u1.getUpdaterStateViewArray(),u2.getUpdaterStateViewArray());
    u1.update(g1,0,0,3,LayerWorkspaceMgr.noWorkspaces());
    u2.update(g2,0,0,3,LayerWorkspaceMgr.noWorkspaces());
    assertEquals(g1.gradient(),g2.gradient());
    assertEquals(u1.getUpdaterStateViewArray(),u2.getUpdaterStateViewArray());
    net1.fit(new DataSet(in,labels));
    net2.fit(new DataSet(in,labels));
    INDArray p1=net1.params();
    INDArray p2=net2.params();
    assertEquals(p1,p2);
  }
}
