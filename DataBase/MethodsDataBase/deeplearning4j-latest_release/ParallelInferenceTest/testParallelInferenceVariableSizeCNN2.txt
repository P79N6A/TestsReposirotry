@Test(timeout=30000L) public void testParallelInferenceVariableSizeCNN2() throws Exception {
  Nd4j.getRandom().setSeed(12345);
  int nIn=3;
  int[] defaultShape=new int[]{1,nIn,16,16};
  MultiLayerConfiguration conf=new NeuralNetConfiguration.Builder().activation(Activation.TANH).seed(12345).convolutionMode(ConvolutionMode.Same).list().layer(new ConvolutionLayer.Builder().nIn(nIn).nOut(5).build()).layer(new CnnLossLayer.Builder().activation(Activation.SOFTMAX).build()).build();
  MultiLayerNetwork net=new MultiLayerNetwork(conf);
  net.init();
  for (  InferenceMode m : InferenceMode.values()) {
    for (    int w : new int[]{1,2}) {
      final ParallelInference inf=new ParallelInference.Builder(net).inferenceMode(m).batchLimit(20).queueLimit(64).workers(w).build();
      List<INDArray> arrs=new ArrayList<>();
      List<INDArray> exp=new ArrayList<>();
      Random r=new Random();
      for (int i=0; i < 500; i++) {
        int[] shape=defaultShape;
        if (r.nextDouble() < 0.4) {
          shape=new int[]{r.nextInt(5) + 1,nIn,10,r.nextInt(10) + 1};
        }
        INDArray in=Nd4j.rand(shape);
        arrs.add(in);
        INDArray out=net.output(in);
        exp.add(out);
      }
      testParallelInference(inf,arrs,exp);
      inf.shutdown();
    }
  }
}
