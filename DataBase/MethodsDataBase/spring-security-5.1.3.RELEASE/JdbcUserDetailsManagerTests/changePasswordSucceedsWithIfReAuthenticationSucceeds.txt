@Test public void changePasswordSucceedsWithIfReAuthenticationSucceeds(){
  insertJoe();
  Authentication currentAuth=authenticateJoe();
  AuthenticationManager am=mock(AuthenticationManager.class);
  when(am.authenticate(currentAuth)).thenReturn(currentAuth);
  manager.setAuthenticationManager(am);
  manager.changePassword("password","newPassword");
  UserDetails newJoe=manager.loadUserByUsername("joe");
  assertThat(newJoe.getPassword()).isEqualTo("newPassword");
  Authentication newAuth=SecurityContextHolder.getContext().getAuthentication();
  assertThat(newAuth.getName()).isEqualTo("joe");
  assertThat(newAuth.getDetails()).isEqualTo(currentAuth.getDetails());
  assertThat(newAuth.getCredentials()).isNull();
  assertThat(cache.getUserMap().containsKey("joe")).isFalse();
}
