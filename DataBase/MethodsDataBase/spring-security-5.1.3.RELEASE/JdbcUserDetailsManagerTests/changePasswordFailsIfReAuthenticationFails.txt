@Test public void changePasswordFailsIfReAuthenticationFails(){
  insertJoe();
  authenticateJoe();
  AuthenticationManager am=mock(AuthenticationManager.class);
  when(am.authenticate(any(Authentication.class))).thenThrow(new BadCredentialsException(""));
  manager.setAuthenticationManager(am);
  try {
    manager.changePassword("password","newPassword");
    fail("Expected BadCredentialsException");
  }
 catch (  BadCredentialsException expected) {
  }
  UserDetails newJoe=manager.loadUserByUsername("joe");
  assertThat(newJoe.getPassword()).isEqualTo("password");
  assertThat(SecurityContextHolder.getContext().getAuthentication().getCredentials()).isEqualTo("password");
  assertThat(cache.getUserMap().containsKey("joe")).isTrue();
}
