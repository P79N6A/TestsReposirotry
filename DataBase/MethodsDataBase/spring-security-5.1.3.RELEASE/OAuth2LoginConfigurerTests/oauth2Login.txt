@Test public void oauth2Login() throws Exception {
  loadConfig(OAuth2LoginConfig.class);
  OAuth2AuthorizationRequest authorizationRequest=createOAuth2AuthorizationRequest();
  this.authorizationRequestRepository.saveAuthorizationRequest(authorizationRequest,this.request,this.response);
  this.request.setParameter("code","code123");
  this.request.setParameter("state",authorizationRequest.getState());
  this.springSecurityFilterChain.doFilter(this.request,this.response,this.filterChain);
  Authentication authentication=this.securityContextRepository.loadContext(new HttpRequestResponseHolder(this.request,this.response)).getAuthentication();
  assertThat(authentication.getAuthorities()).hasSize(1);
  assertThat(authentication.getAuthorities()).first().isInstanceOf(OAuth2UserAuthority.class).hasToString("ROLE_USER");
}
