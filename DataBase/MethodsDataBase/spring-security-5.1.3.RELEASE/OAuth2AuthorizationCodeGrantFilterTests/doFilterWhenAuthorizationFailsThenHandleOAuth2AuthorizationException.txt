@Test public void doFilterWhenAuthorizationFailsThenHandleOAuth2AuthorizationException() throws Exception {
  String requestUri="/callback/client-1";
  MockHttpServletRequest request=new MockHttpServletRequest("GET",requestUri);
  request.setServletPath(requestUri);
  request.addParameter(OAuth2ParameterNames.CODE,"code");
  request.addParameter(OAuth2ParameterNames.STATE,"state");
  MockHttpServletResponse response=new MockHttpServletResponse();
  FilterChain filterChain=mock(FilterChain.class);
  this.setUpAuthorizationRequest(request,response,this.registration1);
  OAuth2Error error=new OAuth2Error(OAuth2ErrorCodes.INVALID_GRANT);
  when(this.authenticationManager.authenticate(any(Authentication.class))).thenThrow(new OAuth2AuthorizationException(error));
  this.filter.doFilter(request,response,filterChain);
  assertThat(response.getRedirectedUrl()).isEqualTo("http://localhost/callback/client-1?error=invalid_grant");
}
