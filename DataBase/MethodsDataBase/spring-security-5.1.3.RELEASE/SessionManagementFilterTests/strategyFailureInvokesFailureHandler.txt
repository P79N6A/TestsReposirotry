@Test public void strategyFailureInvokesFailureHandler() throws Exception {
  SecurityContextRepository repo=mock(SecurityContextRepository.class);
  SessionAuthenticationStrategy strategy=mock(SessionAuthenticationStrategy.class);
  AuthenticationFailureHandler failureHandler=mock(AuthenticationFailureHandler.class);
  SessionManagementFilter filter=new SessionManagementFilter(repo,strategy);
  filter.setAuthenticationFailureHandler(failureHandler);
  HttpServletRequest request=new MockHttpServletRequest();
  HttpServletResponse response=new MockHttpServletResponse();
  FilterChain fc=mock(FilterChain.class);
  authenticateUser();
  SessionAuthenticationException exception=new SessionAuthenticationException("Failure");
  doThrow(exception).when(strategy).onAuthentication(SecurityContextHolder.getContext().getAuthentication(),request,response);
  filter.doFilter(request,response,fc);
  verifyZeroInteractions(fc);
  verify(failureHandler).onAuthenticationFailure(request,response,exception);
}
