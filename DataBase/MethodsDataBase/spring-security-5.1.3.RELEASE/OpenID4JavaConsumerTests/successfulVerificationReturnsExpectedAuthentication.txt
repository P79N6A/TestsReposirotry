@SuppressWarnings("serial") @Test public void successfulVerificationReturnsExpectedAuthentication() throws Exception {
  ConsumerManager mgr=mock(ConsumerManager.class);
  OpenID4JavaConsumer consumer=new OpenID4JavaConsumer(mgr,new NullAxFetchListFactory());
  VerificationResult vr=mock(VerificationResult.class);
  DiscoveryInformation di=mock(DiscoveryInformation.class);
  Identifier id=new Identifier(){
    public String getIdentifier(){
      return "id";
    }
  }
;
  Message msg=mock(Message.class);
  when(mgr.verify(any(),any(ParameterList.class),any(DiscoveryInformation.class))).thenReturn(vr);
  when(vr.getVerifiedId()).thenReturn(id);
  when(vr.getAuthResponse()).thenReturn(msg);
  MockHttpServletRequest request=new MockHttpServletRequest();
  request.getSession().setAttribute(DiscoveryInformation.class.getName(),di);
  request.getSession().setAttribute("SPRING_SECURITY_OPEN_ID_ATTRIBUTES_FETCH_LIST",attributes);
  OpenIDAuthenticationToken auth=consumer.endConsumption(request);
  assertThat(auth.getStatus()).isEqualTo(OpenIDAuthenticationStatus.SUCCESS);
}
