@SuppressWarnings("deprecation") @Test public void beginConsumptionCreatesExpectedSessionData() throws Exception {
  ConsumerManager mgr=mock(ConsumerManager.class);
  AuthRequest authReq=mock(AuthRequest.class);
  DiscoveryInformation di=mock(DiscoveryInformation.class);
  when(mgr.authenticate(any(DiscoveryInformation.class),any(),any())).thenReturn(authReq);
  when(mgr.associate(any())).thenReturn(di);
  OpenID4JavaConsumer consumer=new OpenID4JavaConsumer(mgr,new MockAttributesFactory());
  MockHttpServletRequest request=new MockHttpServletRequest();
  consumer.beginConsumption(request,"","","");
  assertThat(request.getSession().getAttribute("SPRING_SECURITY_OPEN_ID_ATTRIBUTES_FETCH_LIST")).isEqualTo(attributes);
  assertThat(request.getSession().getAttribute(DiscoveryInformation.class.getName())).isEqualTo(di);
  consumer=new OpenID4JavaConsumer(mgr,new NullAxFetchListFactory());
  request=new MockHttpServletRequest();
  consumer.beginConsumption(request,"","","");
}
