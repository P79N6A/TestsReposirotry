@Test public void authenticateWhenAuthoritiesMapperSetThenReturnMappedAuthorities(){
  OAuth2AccessTokenResponse accessTokenResponse=this.accessTokenSuccessResponse();
  when(this.accessTokenResponseClient.getTokenResponse(any())).thenReturn(accessTokenResponse);
  OAuth2User principal=mock(OAuth2User.class);
  List<GrantedAuthority> authorities=AuthorityUtils.createAuthorityList("ROLE_USER");
  when(principal.getAuthorities()).thenAnswer((Answer<List<GrantedAuthority>>)invocation -> authorities);
  when(this.userService.loadUser(any())).thenReturn(principal);
  List<GrantedAuthority> mappedAuthorities=AuthorityUtils.createAuthorityList("ROLE_OAUTH2_USER");
  GrantedAuthoritiesMapper authoritiesMapper=mock(GrantedAuthoritiesMapper.class);
  when(authoritiesMapper.mapAuthorities(anyCollection())).thenAnswer((Answer<List<GrantedAuthority>>)invocation -> mappedAuthorities);
  this.authenticationProvider.setAuthoritiesMapper(authoritiesMapper);
  OAuth2LoginAuthenticationToken authentication=(OAuth2LoginAuthenticationToken)this.authenticationProvider.authenticate(new OAuth2LoginAuthenticationToken(this.clientRegistration,this.authorizationExchange));
  assertThat(authentication.getAuthorities()).isEqualTo(mappedAuthorities);
}
