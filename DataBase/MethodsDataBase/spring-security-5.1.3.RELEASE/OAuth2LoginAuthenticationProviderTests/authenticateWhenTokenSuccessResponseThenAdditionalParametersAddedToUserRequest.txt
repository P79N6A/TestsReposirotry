@Test public void authenticateWhenTokenSuccessResponseThenAdditionalParametersAddedToUserRequest(){
  OAuth2AccessTokenResponse accessTokenResponse=this.accessTokenSuccessResponse();
  when(this.accessTokenResponseClient.getTokenResponse(any())).thenReturn(accessTokenResponse);
  OAuth2User principal=mock(OAuth2User.class);
  List<GrantedAuthority> authorities=AuthorityUtils.createAuthorityList("ROLE_USER");
  when(principal.getAuthorities()).thenAnswer((Answer<List<GrantedAuthority>>)invocation -> authorities);
  ArgumentCaptor<OAuth2UserRequest> userRequestArgCaptor=ArgumentCaptor.forClass(OAuth2UserRequest.class);
  when(this.userService.loadUser(userRequestArgCaptor.capture())).thenReturn(principal);
  this.authenticationProvider.authenticate(new OAuth2LoginAuthenticationToken(this.clientRegistration,this.authorizationExchange));
  assertThat(userRequestArgCaptor.getValue().getAdditionalParameters()).containsAllEntriesOf(accessTokenResponse.getAdditionalParameters());
}
