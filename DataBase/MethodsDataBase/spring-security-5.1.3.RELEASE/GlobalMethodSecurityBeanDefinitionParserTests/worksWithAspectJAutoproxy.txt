@Test(expected=AccessDeniedException.class) public void worksWithAspectJAutoproxy(){
  setContext("<global-method-security>" + "  <protect-pointcut expression='execution(* org.springframework.security.config.*Service.*(..))'" + "       access='ROLE_SOMETHING' />"+ "</global-method-security>"+ "<b:bean id='myUserService' class='org.springframework.security.config.PostProcessedMockUserDetailsService'/>"+ "<aop:aspectj-autoproxy />"+ "<authentication-manager>"+ "   <authentication-provider user-service-ref='myUserService'/>"+ "</authentication-manager>");
  UserDetailsService service=(UserDetailsService)appContext.getBean("myUserService");
  UsernamePasswordAuthenticationToken token=new UsernamePasswordAuthenticationToken("Test","Password",AuthorityUtils.createAuthorityList("ROLE_SOMEOTHERROLE"));
  SecurityContextHolder.getContext().setAuthentication(token);
  service.loadUserByUsername("notused");
}
