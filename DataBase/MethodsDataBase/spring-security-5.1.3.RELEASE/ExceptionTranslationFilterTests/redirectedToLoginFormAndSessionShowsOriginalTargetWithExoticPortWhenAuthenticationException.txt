@Test public void redirectedToLoginFormAndSessionShowsOriginalTargetWithExoticPortWhenAuthenticationException() throws Exception {
  MockHttpServletRequest request=new MockHttpServletRequest();
  request.setServletPath("/secure/page.html");
  request.setServerPort(8080);
  request.setScheme("http");
  request.setServerName("www.example.com");
  request.setContextPath("/mycontext");
  request.setRequestURI("/mycontext/secure/page.html");
  FilterChain fc=mock(FilterChain.class);
  doThrow(new BadCredentialsException("")).when(fc).doFilter(any(HttpServletRequest.class),any(HttpServletResponse.class));
  HttpSessionRequestCache requestCache=new HttpSessionRequestCache();
  ExceptionTranslationFilter filter=new ExceptionTranslationFilter(mockEntryPoint,requestCache);
  requestCache.setPortResolver(new MockPortResolver(8080,8443));
  filter.afterPropertiesSet();
  MockHttpServletResponse response=new MockHttpServletResponse();
  filter.doFilter(request,response,fc);
  assertThat(response.getRedirectedUrl()).isEqualTo("/mycontext/login.jsp");
  assertThat(getSavedRequestUrl(request)).isEqualTo("http://www.example.com:8080/mycontext/secure/page.html");
}
