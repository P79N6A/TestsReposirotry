@Test public void testAccessDeniedWhenNonAnonymous() throws Exception {
  MockHttpServletRequest request=new MockHttpServletRequest();
  request.setServletPath("/secure/page.html");
  FilterChain fc=mock(FilterChain.class);
  doThrow(new AccessDeniedException("")).when(fc).doFilter(any(HttpServletRequest.class),any(HttpServletResponse.class));
  SecurityContextHolder.clearContext();
  AccessDeniedHandlerImpl adh=new AccessDeniedHandlerImpl();
  adh.setErrorPage("/error.jsp");
  ExceptionTranslationFilter filter=new ExceptionTranslationFilter(mockEntryPoint);
  filter.setAccessDeniedHandler(adh);
  MockHttpServletResponse response=new MockHttpServletResponse();
  filter.doFilter(request,response,fc);
  assertThat(response.getStatus()).isEqualTo(403);
  assertThat(request.getAttribute(WebAttributes.ACCESS_DENIED_403)).isExactlyInstanceOf(AccessDeniedException.class);
}
