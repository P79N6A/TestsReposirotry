@Test public void authenticateWhenTokenSuccessResponseThenAdditionalParametersAddedToUserRequest(){
  Map<String,Object> additionalParameters=new HashMap<>();
  additionalParameters.put("param1","value1");
  additionalParameters.put("param2","value2");
  OAuth2AccessTokenResponse accessTokenResponse=OAuth2AccessTokenResponse.withToken("foo").tokenType(OAuth2AccessToken.TokenType.BEARER).additionalParameters(additionalParameters).build();
  when(this.accessTokenResponseClient.getTokenResponse(any())).thenReturn(Mono.just(accessTokenResponse));
  DefaultOAuth2User user=new DefaultOAuth2User(AuthorityUtils.createAuthorityList("ROLE_USER"),Collections.singletonMap("user","rob"),"user");
  ArgumentCaptor<OAuth2UserRequest> userRequestArgCaptor=ArgumentCaptor.forClass(OAuth2UserRequest.class);
  when(this.userService.loadUser(userRequestArgCaptor.capture())).thenReturn(Mono.just(user));
  this.manager.authenticate(loginToken()).block();
  assertThat(userRequestArgCaptor.getValue().getAdditionalParameters()).containsAllEntriesOf(accessTokenResponse.getAdditionalParameters());
}
