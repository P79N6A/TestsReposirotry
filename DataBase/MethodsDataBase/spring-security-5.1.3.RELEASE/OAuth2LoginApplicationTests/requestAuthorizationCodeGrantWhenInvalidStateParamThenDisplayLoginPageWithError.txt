@Test public void requestAuthorizationCodeGrantWhenInvalidStateParamThenDisplayLoginPageWithError() throws Exception {
  HtmlPage page=this.webClient.getPage("/");
  URL loginPageUrl=page.getBaseURL();
  URL loginErrorPageUrl=new URL(loginPageUrl.toString() + "?error");
  ClientRegistration clientRegistration=this.clientRegistrationRepository.findByRegistrationId("google");
  HtmlAnchor clientAnchorElement=this.getClientAnchorElement(page,clientRegistration);
  assertThat(clientAnchorElement).isNotNull();
  this.followLinkDisableRedirects(clientAnchorElement);
  String code="auth-code";
  String state="invalid-state";
  String redirectUri=AUTHORIZE_BASE_URL + "/" + clientRegistration.getRegistrationId();
  String authorizationResponseUri=UriComponentsBuilder.fromHttpUrl(redirectUri).queryParam(OAuth2ParameterNames.CODE,code).queryParam(OAuth2ParameterNames.STATE,state).build().encode().toUriString();
  page=this.webClient.getPage(new URL(authorizationResponseUri));
  assertThat(page.getBaseURL()).isEqualTo(loginErrorPageUrl);
  HtmlElement errorElement=page.getBody().getFirstByXPath("div");
  assertThat(errorElement).isNotNull();
  assertThat(errorElement.asText()).contains("authorization_request_not_found");
}
