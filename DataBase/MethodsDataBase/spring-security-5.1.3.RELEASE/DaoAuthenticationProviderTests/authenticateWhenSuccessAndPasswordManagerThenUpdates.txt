@Test public void authenticateWhenSuccessAndPasswordManagerThenUpdates(){
  String password="password";
  String encodedPassword="encoded";
  UsernamePasswordAuthenticationToken token=new UsernamePasswordAuthenticationToken("user",password);
  PasswordEncoder encoder=mock(PasswordEncoder.class);
  UserDetailsService userDetailsService=mock(UserDetailsService.class);
  UserDetailsPasswordService passwordManager=mock(UserDetailsPasswordService.class);
  DaoAuthenticationProvider provider=new DaoAuthenticationProvider();
  provider.setPasswordEncoder(encoder);
  provider.setUserDetailsService(userDetailsService);
  provider.setUserDetailsPasswordService(passwordManager);
  UserDetails user=PasswordEncodedUser.user();
  when(encoder.matches(any(),any())).thenReturn(true);
  when(encoder.upgradeEncoding(any())).thenReturn(true);
  when(encoder.encode(any())).thenReturn(encodedPassword);
  when(userDetailsService.loadUserByUsername(any())).thenReturn(user);
  when(passwordManager.updatePassword(any(),any())).thenReturn(user);
  Authentication result=provider.authenticate(token);
  verify(encoder).encode(password);
  verify(passwordManager).updatePassword(eq(user),eq(encodedPassword));
}
