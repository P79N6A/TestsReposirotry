@Test public void testAuthenticates(){
  UsernamePasswordAuthenticationToken token=new UsernamePasswordAuthenticationToken("rod","koala");
  token.setDetails("192.168.0.1");
  DaoAuthenticationProvider provider=createProvider();
  provider.setUserDetailsService(new MockUserDetailsServiceUserRod());
  provider.setUserCache(new MockUserCache());
  Authentication result=provider.authenticate(token);
  if (!(result instanceof UsernamePasswordAuthenticationToken)) {
    fail("Should have returned instance of UsernamePasswordAuthenticationToken");
  }
  UsernamePasswordAuthenticationToken castResult=(UsernamePasswordAuthenticationToken)result;
  assertThat(castResult.getPrincipal().getClass()).isEqualTo(User.class);
  assertThat(castResult.getCredentials()).isEqualTo("koala");
  assertThat(AuthorityUtils.authorityListToSet(castResult.getAuthorities())).contains("ROLE_ONE","ROLE_TWO");
  assertThat(castResult.getDetails()).isEqualTo("192.168.0.1");
}
