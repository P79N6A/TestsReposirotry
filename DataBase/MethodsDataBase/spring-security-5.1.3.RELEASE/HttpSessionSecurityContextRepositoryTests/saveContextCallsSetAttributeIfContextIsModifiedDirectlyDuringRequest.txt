@Test public void saveContextCallsSetAttributeIfContextIsModifiedDirectlyDuringRequest() throws Exception {
  HttpSessionSecurityContextRepository repo=new HttpSessionSecurityContextRepository();
  MockHttpServletRequest request=new MockHttpServletRequest();
  SecurityContext ctx=SecurityContextHolder.getContext();
  ctx.setAuthentication(testToken);
  HttpSession session=mock(HttpSession.class);
  when(session.getAttribute(SPRING_SECURITY_CONTEXT_KEY)).thenReturn(ctx);
  request.setSession(session);
  HttpRequestResponseHolder holder=new HttpRequestResponseHolder(request,new MockHttpServletResponse());
  assertThat(repo.loadContext(holder)).isSameAs(ctx);
  SecurityContextHolder.getContext().setAuthentication(new TestingAuthenticationToken("someone","passwd","ROLE_B"));
  repo.saveContext(ctx,holder.getRequest(),holder.getResponse());
  verify(session).setAttribute(SPRING_SECURITY_CONTEXT_KEY,ctx);
}
