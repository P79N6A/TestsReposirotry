@Test public void delegationToUserDetailsServiceReturnsCorrectRoles() throws Exception {
  UserDetailsService uds=mock(UserDetailsService.class);
  UserDetails user=mock(UserDetails.class);
  when(uds.loadUserByUsername("joe")).thenReturn(user);
  List authorities=AuthorityUtils.createAuthorityList("ROLE_USER");
  when(user.getAuthorities()).thenReturn(authorities);
  UserDetailsServiceLdapAuthoritiesPopulator populator=new UserDetailsServiceLdapAuthoritiesPopulator(uds);
  Collection<? extends GrantedAuthority> auths=populator.getGrantedAuthorities(new DirContextAdapter(),"joe");
  assertThat(auths).hasSize(1);
  assertThat(AuthorityUtils.authorityListToSet(auths).contains("ROLE_USER")).isTrue();
}
