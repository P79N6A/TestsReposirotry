@Test public void userIsReauthenticatedIfPrincipalChangesAndCheckForPrincipalChangesIsSet() throws Exception {
  MockHttpServletRequest request=new MockHttpServletRequest();
  MockHttpServletResponse response=new MockHttpServletResponse();
  RequestHeaderAuthenticationFilter filter=new RequestHeaderAuthenticationFilter();
  filter.setAuthenticationManager(createAuthenticationManager());
  filter.setCheckForPrincipalChanges(true);
  request.addHeader("SM_USER","cat");
  filter.doFilter(request,response,new MockFilterChain());
  request=new MockHttpServletRequest();
  request.addHeader("SM_USER","dog");
  filter.doFilter(request,response,new MockFilterChain());
  Authentication dog=SecurityContextHolder.getContext().getAuthentication();
  assertThat(dog).isNotNull();
  assertThat(dog.getName()).isEqualTo("dog");
  filter.setAuthenticationManager(mock(AuthenticationManager.class));
  filter.doFilter(request,response,new MockFilterChain());
  assertThat(SecurityContextHolder.getContext().getAuthentication()).isSameAs(dog);
}
