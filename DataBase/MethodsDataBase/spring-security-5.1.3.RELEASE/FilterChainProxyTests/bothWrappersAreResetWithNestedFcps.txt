@Test public void bothWrappersAreResetWithNestedFcps() throws Exception {
  HttpFirewall fw=mock(HttpFirewall.class);
  FilterChainProxy firstFcp=new FilterChainProxy(new DefaultSecurityFilterChain(matcher,fcp));
  firstFcp.setFirewall(fw);
  fcp.setFirewall(fw);
  FirewalledRequest firstFwr=mock(FirewalledRequest.class,"firstFwr");
  when(firstFwr.getRequestURI()).thenReturn("/");
  when(firstFwr.getContextPath()).thenReturn("");
  FirewalledRequest fwr=mock(FirewalledRequest.class,"fwr");
  when(fwr.getRequestURI()).thenReturn("/");
  when(fwr.getContextPath()).thenReturn("");
  when(fw.getFirewalledRequest(request)).thenReturn(firstFwr);
  when(fw.getFirewalledRequest(firstFwr)).thenReturn(fwr);
  when(fwr.getRequest()).thenReturn(firstFwr);
  when(firstFwr.getRequest()).thenReturn(request);
  when(matcher.matches(any())).thenReturn(true);
  firstFcp.doFilter(request,response,chain);
  verify(firstFwr).reset();
  verify(fwr).reset();
}
