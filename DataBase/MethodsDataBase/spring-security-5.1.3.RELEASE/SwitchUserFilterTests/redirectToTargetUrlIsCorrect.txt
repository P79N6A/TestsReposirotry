@Test public void redirectToTargetUrlIsCorrect() throws Exception {
  MockHttpServletRequest request=createMockSwitchRequest();
  request.setContextPath("/webapp");
  request.addParameter(SwitchUserFilter.SPRING_SECURITY_SWITCH_USERNAME_KEY,"jacklord");
  request.setRequestURI("/webapp/login/impersonate");
  SwitchUserFilter filter=new SwitchUserFilter();
  filter.setSwitchUserUrl("/login/impersonate");
  filter.setSuccessHandler(new SimpleUrlAuthenticationSuccessHandler("/someOtherUrl"));
  filter.setUserDetailsService(new MockUserDetailsService());
  FilterChain chain=mock(FilterChain.class);
  MockHttpServletResponse response=new MockHttpServletResponse();
  filter.doFilter(request,response,chain);
  verify(chain,never()).doFilter(request,response);
  assertThat(response.getRedirectedUrl()).isEqualTo("/webapp/someOtherUrl");
}
