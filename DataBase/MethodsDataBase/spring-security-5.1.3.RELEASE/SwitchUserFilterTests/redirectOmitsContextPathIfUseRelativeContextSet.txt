@Test public void redirectOmitsContextPathIfUseRelativeContextSet() throws Exception {
  UsernamePasswordAuthenticationToken auth=new UsernamePasswordAuthenticationToken("dano","hawaii50");
  SecurityContextHolder.getContext().setAuthentication(auth);
  MockHttpServletRequest request=createMockSwitchRequest();
  request.setContextPath("/webapp");
  request.addParameter(SwitchUserFilter.SPRING_SECURITY_SWITCH_USERNAME_KEY,"jacklord");
  request.setRequestURI("/webapp/login/impersonate");
  SwitchUserFilter filter=new SwitchUserFilter();
  filter.setSwitchUserUrl("/login/impersonate");
  SimpleUrlAuthenticationSuccessHandler switchSuccessHandler=new SimpleUrlAuthenticationSuccessHandler("/someOtherUrl");
  DefaultRedirectStrategy contextRelativeRedirector=new DefaultRedirectStrategy();
  contextRelativeRedirector.setContextRelative(true);
  switchSuccessHandler.setRedirectStrategy(contextRelativeRedirector);
  filter.setSuccessHandler(switchSuccessHandler);
  filter.setUserDetailsService(new MockUserDetailsService());
  FilterChain chain=mock(FilterChain.class);
  MockHttpServletResponse response=new MockHttpServletResponse();
  filter.doFilter(request,response,chain);
  verify(chain,never()).doFilter(request,response);
  assertThat(response.getRedirectedUrl()).isEqualTo("/someOtherUrl");
}
