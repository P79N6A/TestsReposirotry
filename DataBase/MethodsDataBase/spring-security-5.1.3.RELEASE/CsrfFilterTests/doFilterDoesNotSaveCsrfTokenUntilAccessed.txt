@Test public void doFilterDoesNotSaveCsrfTokenUntilAccessed() throws ServletException, IOException {
  this.filter=createCsrfFilter(new LazyCsrfTokenRepository(this.tokenRepository));
  when(this.requestMatcher.matches(this.request)).thenReturn(false);
  when(this.tokenRepository.generateToken(this.request)).thenReturn(this.token);
  this.filter.doFilter(this.request,this.response,this.filterChain);
  CsrfToken attrToken=(CsrfToken)this.request.getAttribute(this.token.getParameterName());
  verify(this.tokenRepository,times(0)).saveToken(any(CsrfToken.class),any(HttpServletRequest.class),any(HttpServletResponse.class));
  verify(this.filterChain).doFilter(this.request,this.response);
  attrToken.getToken();
  verify(this.tokenRepository).saveToken(eq(this.token),any(HttpServletRequest.class),any(HttpServletResponse.class));
}
