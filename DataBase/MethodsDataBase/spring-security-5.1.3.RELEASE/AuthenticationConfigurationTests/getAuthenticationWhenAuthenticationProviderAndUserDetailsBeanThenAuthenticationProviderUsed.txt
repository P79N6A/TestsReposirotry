@Test public void getAuthenticationWhenAuthenticationProviderAndUserDetailsBeanThenAuthenticationProviderUsed() throws Exception {
  this.spring.register(AuthenticationProviderBeanAndUserDetailsServiceConfig.class).autowire();
  AuthenticationProvider ap=this.spring.getContext().getBean(AuthenticationProvider.class);
  AuthenticationManager am=this.spring.getContext().getBean(AuthenticationConfiguration.class).getAuthenticationManager();
  when(ap.supports(any())).thenReturn(true);
  when(ap.authenticate(any())).thenReturn(TestAuthentication.authenticatedUser());
  am.authenticate(new UsernamePasswordAuthenticationToken("user","password"));
}
