@Test public void getAuthenticationWhenUserDetailsServiceAndPasswordManagerThenManagerUsed() throws Exception {
  UserDetails user=new User("user","{noop}password",AuthorityUtils.createAuthorityList("ROLE_USER"));
  this.spring.register(UserDetailsPasswordManagerBeanConfig.class).autowire();
  UserDetailsPasswordManagerBeanConfig.Manager manager=this.spring.getContext().getBean(UserDetailsPasswordManagerBeanConfig.Manager.class);
  AuthenticationManager am=this.spring.getContext().getBean(AuthenticationConfiguration.class).getAuthenticationManager();
  when(manager.loadUserByUsername("user")).thenReturn(User.withUserDetails(user).build(),User.withUserDetails(user).build());
  when(manager.updatePassword(any(),any())).thenReturn(user);
  am.authenticate(new UsernamePasswordAuthenticationToken("user","password"));
  verify(manager).updatePassword(eq(user),startsWith("{bcrypt}"));
}
