@Test public void getAuthenticationWhenUserDetailsServiceBeanThenAuthenticationManagerUsesUserDetailsServiceBean() throws Exception {
  this.spring.register(UserDetailsServiceBeanConfig.class).autowire();
  UserDetailsService uds=this.spring.getContext().getBean(UserDetailsService.class);
  AuthenticationManager am=this.spring.getContext().getBean(AuthenticationConfiguration.class).getAuthenticationManager();
  when(uds.loadUserByUsername("user")).thenReturn(PasswordEncodedUser.user(),PasswordEncodedUser.user());
  am.authenticate(new UsernamePasswordAuthenticationToken("user","password"));
  assertThatThrownBy(() -> am.authenticate(new UsernamePasswordAuthenticationToken("user","invalid"))).isInstanceOf(AuthenticationException.class);
}
