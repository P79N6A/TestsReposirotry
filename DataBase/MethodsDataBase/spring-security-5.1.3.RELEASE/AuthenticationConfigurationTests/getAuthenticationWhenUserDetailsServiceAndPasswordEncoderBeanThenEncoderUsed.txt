@Test public void getAuthenticationWhenUserDetailsServiceAndPasswordEncoderBeanThenEncoderUsed() throws Exception {
  UserDetails user=new User("user","$2a$10$FBAKClV1zBIOOC9XMXf3AO8RoGXYVYsfvUdoLxGkd/BnXEn4tqT3u",AuthorityUtils.createAuthorityList("ROLE_USER"));
  this.spring.register(UserDetailsServiceBeanWithPasswordEncoderConfig.class).autowire();
  UserDetailsService uds=this.spring.getContext().getBean(UserDetailsService.class);
  AuthenticationManager am=this.spring.getContext().getBean(AuthenticationConfiguration.class).getAuthenticationManager();
  when(uds.loadUserByUsername("user")).thenReturn(User.withUserDetails(user).build(),User.withUserDetails(user).build());
  am.authenticate(new UsernamePasswordAuthenticationToken("user","password"));
  assertThatThrownBy(() -> am.authenticate(new UsernamePasswordAuthenticationToken("user","invalid"))).isInstanceOf(AuthenticationException.class);
}
