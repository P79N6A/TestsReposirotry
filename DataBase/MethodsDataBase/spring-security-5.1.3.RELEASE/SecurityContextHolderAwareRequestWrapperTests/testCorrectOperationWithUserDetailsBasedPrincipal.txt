@Test public void testCorrectOperationWithUserDetailsBasedPrincipal() throws Exception {
  Authentication auth=new TestingAuthenticationToken(new User("rodAsUserDetails","koala",true,true,true,true,AuthorityUtils.NO_AUTHORITIES),"koala","ROLE_HELLO","ROLE_FOOBAR");
  SecurityContextHolder.getContext().setAuthentication(auth);
  MockHttpServletRequest request=new MockHttpServletRequest();
  request.setRequestURI("/");
  SecurityContextHolderAwareRequestWrapper wrapper=new SecurityContextHolderAwareRequestWrapper(request,"");
  assertThat(wrapper.getRemoteUser()).isEqualTo("rodAsUserDetails");
  assertThat(wrapper.isUserInRole("ROLE_FOO")).isFalse();
  assertThat(wrapper.isUserInRole("ROLE_NOT_GRANTED")).isFalse();
  assertThat(wrapper.isUserInRole("ROLE_FOOBAR")).isTrue();
  assertThat(wrapper.isUserInRole("ROLE_HELLO")).isTrue();
  assertThat(wrapper.getUserPrincipal()).isEqualTo(auth);
}
