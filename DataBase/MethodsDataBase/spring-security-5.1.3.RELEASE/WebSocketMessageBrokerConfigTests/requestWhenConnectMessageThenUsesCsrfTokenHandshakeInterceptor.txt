@Test public void requestWhenConnectMessageThenUsesCsrfTokenHandshakeInterceptor() throws Exception {
  this.spring.configLocations(xml("SyncConfig")).autowire();
  WebApplicationContext context=(WebApplicationContext)this.spring.getContext();
  MockMvc mvc=MockMvcBuilders.webAppContextSetup(context).build();
  String csrfAttributeName=CsrfToken.class.getName();
  String customAttributeName=this.getClass().getName();
  MvcResult result=mvc.perform(get("/app").requestAttr(csrfAttributeName,this.token).sessionAttr(customAttributeName,"attributeValue")).andReturn();
  CsrfToken handshakeToken=(CsrfToken)this.testHandshakeHandler.attributes.get(csrfAttributeName);
  String handshakeValue=(String)this.testHandshakeHandler.attributes.get(customAttributeName);
  String sessionValue=(String)result.getRequest().getSession().getAttribute(customAttributeName);
  assertThat(handshakeToken).isEqualTo(this.token).withFailMessage("CsrfToken is populated");
  assertThat(handshakeValue).isEqualTo(sessionValue).withFailMessage("Explicitly listed session variables are not overridden");
}
