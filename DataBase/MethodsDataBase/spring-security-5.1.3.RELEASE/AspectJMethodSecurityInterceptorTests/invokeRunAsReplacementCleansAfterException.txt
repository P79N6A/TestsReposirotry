@Test @SuppressWarnings("unchecked") public void invokeRunAsReplacementCleansAfterException() throws Throwable {
  SecurityContext ctx=SecurityContextHolder.getContext();
  ctx.setAuthentication(token);
  token.setAuthenticated(true);
  final RunAsManager runAs=mock(RunAsManager.class);
  final RunAsUserToken runAsToken=new RunAsUserToken("key","someone","creds",token.getAuthorities(),TestingAuthenticationToken.class);
  interceptor.setRunAsManager(runAs);
  when(runAs.buildRunAs(eq(token),any(MethodInvocation.class),any(List.class))).thenReturn(runAsToken);
  when(joinPoint.proceed()).thenThrow(new RuntimeException());
  try {
    interceptor.invoke(joinPoint);
    fail("Expected Exception");
  }
 catch (  RuntimeException success) {
  }
  assertThat(SecurityContextHolder.getContext()).isSameAs(ctx);
  assertThat(SecurityContextHolder.getContext().getAuthentication()).isSameAs(token);
}
