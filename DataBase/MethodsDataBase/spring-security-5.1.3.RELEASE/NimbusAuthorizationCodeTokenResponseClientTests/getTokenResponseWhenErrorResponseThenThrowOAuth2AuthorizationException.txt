@Test public void getTokenResponseWhenErrorResponseThenThrowOAuth2AuthorizationException() throws Exception {
  this.exception.expect(OAuth2AuthorizationException.class);
  this.exception.expectMessage(containsString("unauthorized_client"));
  MockWebServer server=new MockWebServer();
  String accessTokenErrorResponse="{\n" + "   \"error\": \"unauthorized_client\"\n" + "}\n";
  server.enqueue(new MockResponse().setHeader(HttpHeaders.CONTENT_TYPE,MediaType.APPLICATION_JSON_VALUE).setResponseCode(500).setBody(accessTokenErrorResponse));
  server.start();
  String tokenUri=server.url("/oauth2/token").toString();
  when(this.providerDetails.getTokenUri()).thenReturn(tokenUri);
  try {
    this.tokenResponseClient.getTokenResponse(new OAuth2AuthorizationCodeGrantRequest(this.clientRegistration,this.authorizationExchange));
  }
  finally {
    server.shutdown();
  }
}
