@Test public void testExpiredNonceReturnsForbiddenWithStaleHeader() throws Exception {
  String nonce=generateNonce(0);
  String responseDigest=DigestAuthUtils.generateDigest(false,USERNAME,REALM,PASSWORD,"GET",REQUEST_URI,QOP,nonce,NC,CNONCE);
  request.addHeader("Authorization",createAuthorizationHeader(USERNAME,REALM,nonce,REQUEST_URI,responseDigest,QOP,NC,CNONCE));
  Thread.sleep(1000);
  MockHttpServletResponse response=executeFilterInContainerSimulator(filter,request,false);
  assertThat(SecurityContextHolder.getContext().getAuthentication()).isNull();
  assertThat(response.getStatus()).isEqualTo(401);
  String header=response.getHeader("WWW-Authenticate").toString().substring(7);
  String[] headerEntries=StringUtils.commaDelimitedListToStringArray(header);
  Map<String,String> headerMap=DigestAuthUtils.splitEachArrayElementAndCreateMap(headerEntries,"=","\"");
  assertThat(headerMap.get("stale")).isEqualTo("true");
}
