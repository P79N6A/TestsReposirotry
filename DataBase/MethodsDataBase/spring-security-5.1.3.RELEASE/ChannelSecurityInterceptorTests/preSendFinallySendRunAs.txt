@SuppressWarnings("unchecked") @Test public void preSendFinallySendRunAs() throws Exception {
  when(source.getAttributes(message)).thenReturn(attrs);
  when(runAsManager.buildRunAs(any(Authentication.class),any(),any(Collection.class))).thenReturn(runAs);
  Message<?> preSend=interceptor.preSend(message,channel);
  assertThat(SecurityContextHolder.getContext().getAuthentication()).isSameAs(runAs);
  interceptor.afterSendCompletion(preSend,channel,true,new RuntimeException());
  assertThat(SecurityContextHolder.getContext().getAuthentication()).isSameAs(originalAuth);
}
