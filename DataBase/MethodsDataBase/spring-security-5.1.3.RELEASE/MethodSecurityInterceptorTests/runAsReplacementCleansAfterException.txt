@Test public void runAsReplacementCleansAfterException() throws Exception {
  createTarget(true);
  when(realTarget.makeUpperCase(anyString())).thenThrow(new RuntimeException());
  SecurityContext ctx=SecurityContextHolder.getContext();
  ctx.setAuthentication(token);
  token.setAuthenticated(true);
  final RunAsManager runAs=mock(RunAsManager.class);
  final RunAsUserToken runAsToken=new RunAsUserToken("key","someone","creds",token.getAuthorities(),TestingAuthenticationToken.class);
  interceptor.setRunAsManager(runAs);
  mdsReturnsUserRole();
  when(runAs.buildRunAs(eq(token),any(MethodInvocation.class),any(List.class))).thenReturn(runAsToken);
  try {
    advisedTarget.makeUpperCase("hello");
    fail("Expected Exception");
  }
 catch (  RuntimeException success) {
  }
  assertThat(SecurityContextHolder.getContext()).isSameAs(ctx);
  assertThat(SecurityContextHolder.getContext().getAuthentication()).isSameAs(token);
}
