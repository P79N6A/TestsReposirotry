@Test public void runAsReplacementIsCorrectlySet() throws Exception {
  SecurityContext ctx=SecurityContextHolder.getContext();
  ctx.setAuthentication(token);
  token.setAuthenticated(true);
  final RunAsManager runAs=mock(RunAsManager.class);
  final RunAsUserToken runAsToken=new RunAsUserToken("key","someone","creds",token.getAuthorities(),TestingAuthenticationToken.class);
  interceptor.setRunAsManager(runAs);
  mdsReturnsUserRole();
  when(runAs.buildRunAs(eq(token),any(MethodInvocation.class),any(List.class))).thenReturn(runAsToken);
  String result=advisedTarget.makeUpperCase("hello");
  assertThat(result).isEqualTo("HELLO org.springframework.security.access.intercept.RunAsUserToken true");
  assertThat(SecurityContextHolder.getContext()).isSameAs(ctx);
  assertThat(SecurityContextHolder.getContext().getAuthentication()).isSameAs(token);
}
