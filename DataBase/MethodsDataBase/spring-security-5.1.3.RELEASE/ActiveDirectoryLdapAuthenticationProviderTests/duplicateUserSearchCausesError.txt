@SuppressWarnings("unchecked") @Test(expected=IncorrectResultSizeDataAccessException.class) public void duplicateUserSearchCausesError() throws Exception {
  DirContext ctx=mock(DirContext.class);
  when(ctx.getNameInNamespace()).thenReturn("");
  NamingEnumeration<SearchResult> searchResults=mock(NamingEnumeration.class);
  when(searchResults.hasMore()).thenReturn(true,true,false);
  SearchResult searchResult=mock(SearchResult.class);
  when(searchResult.getObject()).thenReturn(new DirContextAdapter("ou=1"),new DirContextAdapter("ou=2"));
  when(searchResults.next()).thenReturn(searchResult);
  when(ctx.search(any(Name.class),any(String.class),any(Object[].class),any(SearchControls.class))).thenReturn(searchResults);
  provider.contextFactory=createContextFactoryReturning(ctx);
  provider.authenticate(joe);
}
