@Test public void customSearchFilterIsUsedForSuccessfulAuthentication() throws Exception {
  String customSearchFilter="(&(objectClass=user)(sAMAccountName={0}))";
  DirContext ctx=mock(DirContext.class);
  when(ctx.getNameInNamespace()).thenReturn("");
  DirContextAdapter dca=new DirContextAdapter();
  SearchResult sr=new SearchResult("CN=Joe Jannsen,CN=Users",dca,dca.getAttributes());
  when(ctx.search(any(Name.class),eq(customSearchFilter),any(Object[].class),any(SearchControls.class))).thenReturn(new MockNamingEnumeration(sr));
  ActiveDirectoryLdapAuthenticationProvider customProvider=new ActiveDirectoryLdapAuthenticationProvider("mydomain.eu","ldap://192.168.1.200/");
  customProvider.contextFactory=createContextFactoryReturning(ctx);
  customProvider.setSearchFilter(customSearchFilter);
  Authentication result=customProvider.authenticate(joe);
  assertThat(result.isAuthenticated()).isTrue();
}
