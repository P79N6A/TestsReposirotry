@Test public void bindPrincipalAndUsernameUsed() throws Exception {
  final String defaultSearchFilter="(&(objectClass=user)(userPrincipalName={0}))";
  ArgumentCaptor<Object[]> captor=ArgumentCaptor.forClass(Object[].class);
  DirContext ctx=mock(DirContext.class);
  when(ctx.getNameInNamespace()).thenReturn("");
  DirContextAdapter dca=new DirContextAdapter();
  SearchResult sr=new SearchResult("CN=Joe Jannsen,CN=Users",dca,dca.getAttributes());
  when(ctx.search(any(Name.class),eq(defaultSearchFilter),captor.capture(),any(SearchControls.class))).thenReturn(new MockNamingEnumeration(sr));
  ActiveDirectoryLdapAuthenticationProvider customProvider=new ActiveDirectoryLdapAuthenticationProvider("mydomain.eu","ldap://192.168.1.200/");
  customProvider.contextFactory=createContextFactoryReturning(ctx);
  Authentication result=customProvider.authenticate(joe);
  assertThat(captor.getValue()).containsExactly("joe@mydomain.eu","joe");
  assertThat(result.isAuthenticated()).isTrue();
}
