@Test public void testSuccessLoginThenFailureLoginResultsInSessionLosingToken() throws Exception {
  MockHttpServletRequest request=createMockAuthenticationRequest();
  MockFilterConfig config=new MockFilterConfig(null,null);
  MockFilterChain chain=new MockFilterChain(false);
  MockHttpServletResponse response=new MockHttpServletResponse();
  MockAuthenticationFilter filter=new MockAuthenticationFilter(true);
  filter.setFilterProcessesUrl("/j_mock_post");
  filter.setAuthenticationSuccessHandler(successHandler);
  filter.doFilter(request,response,chain);
  assertThat(response.getRedirectedUrl()).isEqualTo("/mycontext/logged_in.jsp");
  assertThat(SecurityContextHolder.getContext().getAuthentication()).isNotNull();
  assertThat(SecurityContextHolder.getContext().getAuthentication().getPrincipal().toString()).isEqualTo("test");
  chain=new MockFilterChain(false);
  response=new MockHttpServletResponse();
  filter=new MockAuthenticationFilter(false);
  filter.setFilterProcessesUrl("/j_mock_post");
  filter.setAuthenticationFailureHandler(failureHandler);
  filter.doFilter(request,response,chain);
  assertThat(SecurityContextHolder.getContext().getAuthentication()).isNull();
}
