@Test public void testFailedAuthenticationInvokesFailureHandler() throws Exception {
  MockHttpServletRequest request=createMockAuthenticationRequest();
  MockFilterConfig config=new MockFilterConfig(null,null);
  MockFilterChain chain=new MockFilterChain(false);
  MockHttpServletResponse response=new MockHttpServletResponse();
  MockAuthenticationFilter filter=new MockAuthenticationFilter(false);
  AuthenticationFailureHandler failureHandler=mock(AuthenticationFailureHandler.class);
  filter.setAuthenticationFailureHandler(failureHandler);
  filter.doFilter(request,response,chain);
  verify(failureHandler).onAuthenticationFailure(any(HttpServletRequest.class),any(HttpServletResponse.class),any(AuthenticationException.class));
  assertThat(SecurityContextHolder.getContext().getAuthentication()).isNull();
}
