@Test public void requestWhenAttributeExchangeConfiguredThenFetchAttributesPassedToIdp() throws Exception {
  this.spring.configLocations(this.xml("WithOpenIDAttributes")).autowire();
  OpenIDAuthenticationFilter openIDFilter=getFilter(OpenIDAuthenticationFilter.class);
  OpenID4JavaConsumer consumer=getFieldValue(openIDFilter,"consumer");
  ConsumerManager manager=getFieldValue(consumer,"consumerManager");
  manager.setMaxAssocAttempts(0);
  try (MockWebServer server=new MockWebServer()){
    String endpoint=server.url("/").toString();
    server.enqueue(new MockResponse().addHeader(YADIS_XRDS_LOCATION,endpoint));
    server.enqueue(new MockResponse().setBody(String.format("<XRDS><XRD><Service><URI>%s</URI></Service></XRD></XRDS>",endpoint)));
    this.mvc.perform(get("/login/openid").param(OpenIDAuthenticationFilter.DEFAULT_CLAIMED_IDENTITY_FIELD,endpoint)).andExpect(status().isFound()).andExpect(result -> result.getResponse().getRedirectedUrl().endsWith("openid.ext1.type.nickname=http%3A%2F%2Fschema.openid.net%2FnamePerson%2Ffriendly&" + "openid.ext1.if_available=nickname&" + "openid.ext1.type.email=http%3A%2F%2Fschema.openid.net%2Fcontact%2Femail&"+ "openid.ext1.required=email&"+ "openid.ext1.count.email=2"));
  }
 }
