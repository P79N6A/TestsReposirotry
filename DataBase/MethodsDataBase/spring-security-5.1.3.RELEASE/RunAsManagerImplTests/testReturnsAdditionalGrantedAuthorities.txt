@Test public void testReturnsAdditionalGrantedAuthorities() throws Exception {
  UsernamePasswordAuthenticationToken inputToken=new UsernamePasswordAuthenticationToken("Test","Password",AuthorityUtils.createAuthorityList("ROLE_ONE","ROLE_TWO"));
  RunAsManagerImpl runAs=new RunAsManagerImpl();
  runAs.setKey("my_password");
  Authentication result=runAs.buildRunAs(inputToken,new Object(),SecurityConfig.createList("RUN_AS_SOMETHING"));
  if (!(result instanceof RunAsUserToken)) {
    fail("Should have returned a RunAsUserToken");
  }
  assertThat(result.getPrincipal()).isEqualTo(inputToken.getPrincipal());
  assertThat(result.getCredentials()).isEqualTo(inputToken.getCredentials());
  Set<String> authorities=AuthorityUtils.authorityListToSet(result.getAuthorities());
  assertThat(authorities.contains("ROLE_RUN_AS_SOMETHING")).isTrue();
  assertThat(authorities.contains("ROLE_ONE")).isTrue();
  assertThat(authorities.contains("ROLE_TWO")).isTrue();
  RunAsUserToken resultCast=(RunAsUserToken)result;
  assertThat(resultCast.getKeyHash()).isEqualTo("my_password".hashCode());
}
