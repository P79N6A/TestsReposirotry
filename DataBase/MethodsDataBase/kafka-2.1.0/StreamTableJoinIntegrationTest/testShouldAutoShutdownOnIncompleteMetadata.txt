@Test public void testShouldAutoShutdownOnIncompleteMetadata() throws InterruptedException {
  STREAMS_CONFIG.put(StreamsConfig.APPLICATION_ID_CONFIG,appID + "-incomplete");
  final KStream<Long,String> notExistStream=builder.stream(INPUT_TOPIC_LEFT + "-not-existed");
  final KTable<Long,String> aggregatedTable=notExistStream.leftJoin(rightTable,valueJoiner).groupBy((key,value) -> key).reduce((value1,value2) -> value1 + value2);
  aggregatedTable.toStream().to(OUTPUT_TOPIC);
  final KafkaStreamsWrapper streams=new KafkaStreamsWrapper(builder.build(),STREAMS_CONFIG);
  final IntegrationTestUtils.StateListenerStub listener=new IntegrationTestUtils.StateListenerStub();
  streams.setStreamThreadStateListener(listener);
  streams.start();
  TestUtils.waitForCondition(listener::revokedToPendingShutdownSeen,"Did not seen thread state transited to PENDING_SHUTDOWN");
  streams.close();
  assertEquals(listener.runningToRevokedSeen(),true);
  assertEquals(listener.revokedToPendingShutdownSeen(),true);
}
