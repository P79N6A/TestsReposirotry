@Test public void testBatchCannotCompleteTwice() throws Exception {
  ProducerBatch batch=new ProducerBatch(new TopicPartition("topic",1),memoryRecordsBuilder,now);
  MockCallback callback=new MockCallback();
  FutureRecordMetadata future=batch.tryAppend(now,null,new byte[10],Record.EMPTY_HEADERS,callback,now);
  batch.done(500L,10L,null);
  assertEquals(1,callback.invocations);
  assertNull(callback.exception);
  assertNotNull(callback.metadata);
  try {
    batch.done(1000L,20L,null);
    fail("Expected exception from done");
  }
 catch (  IllegalStateException e) {
  }
  RecordMetadata recordMetadata=future.get();
  assertEquals(500L,recordMetadata.offset());
  assertEquals(10L,recordMetadata.timestamp());
}
