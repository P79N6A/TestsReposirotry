@Test public void testMetadataFetchOnStaleMetadata() throws Exception {
  Properties props=new Properties();
  props.setProperty(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG,"localhost:9999");
  ProducerConfig config=new ProducerConfig(ProducerConfig.addSerializerToConfig(props,new StringSerializer(),new StringSerializer()));
  String topic="topic";
  ProducerRecord<String,String> initialRecord=new ProducerRecord<>(topic,"value");
  ProducerRecord<String,String> extendedRecord=new ProducerRecord<>(topic,2,null,"value");
  Collection<Node> nodes=Collections.singletonList(new Node(0,"host1",1000));
  final Cluster emptyCluster=new Cluster(null,nodes,Collections.emptySet(),Collections.emptySet(),Collections.emptySet());
  final Cluster initialCluster=new Cluster("dummy",Collections.singletonList(new Node(0,"host1",1000)),Collections.singletonList(new PartitionInfo(topic,0,null,null,null)),Collections.emptySet(),Collections.emptySet());
  final Cluster extendedCluster=new Cluster("dummy",Collections.singletonList(new Node(0,"host1",1000)),Arrays.asList(new PartitionInfo(topic,0,null,null,null),new PartitionInfo(topic,1,null,null,null),new PartitionInfo(topic,2,null,null,null)),Collections.emptySet(),Collections.emptySet());
  Metadata metadata=mock(Metadata.class);
  AtomicInteger invocationCount=new AtomicInteger(0);
  when(metadata.fetch()).then(invocation -> {
    invocationCount.incrementAndGet();
    if (invocationCount.get() > 9)     return extendedCluster;
 else     if (invocationCount.get() > 4)     return initialCluster;
    return emptyCluster;
  }
);
  KafkaProducer<String,String> producer=new KafkaProducer<String,String>(config,null,null,metadata,new MockClient(Time.SYSTEM,metadata),null,Time.SYSTEM){
    @Override Sender newSender(    LogContext logContext,    KafkaClient kafkaClient,    Metadata metadata){
      return super.newSender(logContext,kafkaClient,new Metadata(0,100_000,true));
    }
  }
;
  producer.send(initialRecord);
  verify(metadata,times(4)).requestUpdate();
  verify(metadata,times(4)).awaitUpdate(anyInt(),anyLong());
  verify(metadata,times(5)).fetch();
  producer.send(initialRecord);
  verify(metadata,times(4)).requestUpdate();
  verify(metadata,times(4)).awaitUpdate(anyInt(),anyLong());
  verify(metadata,times(6)).fetch();
  try {
    producer.send(extendedRecord);
    fail("Expected KafkaException to be raised");
  }
 catch (  KafkaException e) {
  }
  verify(metadata,times(5)).requestUpdate();
  verify(metadata,times(5)).awaitUpdate(anyInt(),anyLong());
  verify(metadata,times(8)).fetch();
  producer.send(extendedRecord);
  verify(metadata,times(6)).requestUpdate();
  verify(metadata,times(6)).awaitUpdate(anyInt(),anyLong());
  verify(metadata,times(10)).fetch();
  producer.close(0,TimeUnit.MILLISECONDS);
}
