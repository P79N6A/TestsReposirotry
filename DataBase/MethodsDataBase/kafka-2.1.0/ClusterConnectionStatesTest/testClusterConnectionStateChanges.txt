@Test public void testClusterConnectionStateChanges() throws UnknownHostException {
  assertTrue(connectionStates.canConnect(nodeId1,time.milliseconds()));
  connectionStates.connecting(nodeId1,time.milliseconds(),"localhost",ClientDnsLookup.DEFAULT);
  assertEquals(connectionStates.connectionState(nodeId1),ConnectionState.CONNECTING);
  assertTrue(connectionStates.isConnecting(nodeId1));
  assertFalse(connectionStates.isReady(nodeId1,time.milliseconds()));
  assertFalse(connectionStates.isBlackedOut(nodeId1,time.milliseconds()));
  assertFalse(connectionStates.hasReadyNodes(time.milliseconds()));
  time.sleep(100);
  connectionStates.ready(nodeId1);
  assertEquals(connectionStates.connectionState(nodeId1),ConnectionState.READY);
  assertTrue(connectionStates.isReady(nodeId1,time.milliseconds()));
  assertTrue(connectionStates.hasReadyNodes(time.milliseconds()));
  assertFalse(connectionStates.isConnecting(nodeId1));
  assertFalse(connectionStates.isBlackedOut(nodeId1,time.milliseconds()));
  assertEquals(connectionStates.connectionDelay(nodeId1,time.milliseconds()),Long.MAX_VALUE);
  time.sleep(15000);
  connectionStates.disconnected(nodeId1,time.milliseconds());
  assertEquals(connectionStates.connectionState(nodeId1),ConnectionState.DISCONNECTED);
  assertTrue(connectionStates.isDisconnected(nodeId1));
  assertTrue(connectionStates.isBlackedOut(nodeId1,time.milliseconds()));
  assertFalse(connectionStates.isConnecting(nodeId1));
  assertFalse(connectionStates.hasReadyNodes(time.milliseconds()));
  assertFalse(connectionStates.canConnect(nodeId1,time.milliseconds()));
  double backoffTolerance=reconnectBackoffMs * reconnectBackoffJitter;
  long currentBackoff=connectionStates.connectionDelay(nodeId1,time.milliseconds());
  assertEquals(reconnectBackoffMs,currentBackoff,backoffTolerance);
  time.sleep(currentBackoff + 1);
  assertTrue(connectionStates.canConnect(nodeId1,time.milliseconds()));
}
