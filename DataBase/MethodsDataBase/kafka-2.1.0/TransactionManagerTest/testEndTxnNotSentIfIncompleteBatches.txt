@Test public void testEndTxnNotSentIfIncompleteBatches(){
  long pid=13131L;
  short epoch=1;
  doInitTransactions(pid,epoch);
  transactionManager.beginTransaction();
  transactionManager.maybeAddPartitionToTransaction(tp0);
  prepareAddPartitionsToTxn(tp0,Errors.NONE);
  sender.run(time.milliseconds());
  assertTrue(transactionManager.isPartitionAdded(tp0));
  transactionManager.beginCommit();
  assertNull(transactionManager.nextRequestHandler(true));
  assertTrue(transactionManager.nextRequestHandler(false).isEndTxn());
}
