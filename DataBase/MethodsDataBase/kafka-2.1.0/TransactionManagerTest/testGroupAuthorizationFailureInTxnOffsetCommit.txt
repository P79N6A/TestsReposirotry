@Test public void testGroupAuthorizationFailureInTxnOffsetCommit(){
  final String consumerGroupId="consumer";
  final long pid=13131L;
  final short epoch=1;
  final TopicPartition tp1=new TopicPartition("foo",0);
  doInitTransactions(pid,epoch);
  transactionManager.beginTransaction();
  TransactionalRequestResult sendOffsetsResult=transactionManager.sendOffsetsToTransaction(singletonMap(tp1,new OffsetAndMetadata(39L)),consumerGroupId);
  prepareAddOffsetsToTxnResponse(Errors.NONE,consumerGroupId,pid,epoch);
  sender.run(time.milliseconds());
  sender.run(time.milliseconds());
  prepareFindCoordinatorResponse(Errors.NONE,false,CoordinatorType.GROUP,consumerGroupId);
  sender.run(time.milliseconds());
  prepareTxnOffsetCommitResponse(consumerGroupId,pid,epoch,singletonMap(tp1,Errors.GROUP_AUTHORIZATION_FAILED));
  sender.run(time.milliseconds());
  assertTrue(transactionManager.hasError());
  assertTrue(transactionManager.lastError() instanceof GroupAuthorizationException);
  assertTrue(sendOffsetsResult.isCompleted());
  assertFalse(sendOffsetsResult.isSuccessful());
  assertTrue(sendOffsetsResult.error() instanceof GroupAuthorizationException);
  assertFalse(transactionManager.hasPendingOffsetCommits());
  GroupAuthorizationException exception=(GroupAuthorizationException)sendOffsetsResult.error();
  assertEquals(consumerGroupId,exception.groupId());
  assertAbortableError(GroupAuthorizationException.class);
}
