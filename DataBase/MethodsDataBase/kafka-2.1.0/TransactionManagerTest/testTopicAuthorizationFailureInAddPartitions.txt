@Test public void testTopicAuthorizationFailureInAddPartitions(){
  final long pid=13131L;
  final short epoch=1;
  final TopicPartition tp0=new TopicPartition("foo",0);
  final TopicPartition tp1=new TopicPartition("bar",0);
  doInitTransactions(pid,epoch);
  transactionManager.beginTransaction();
  transactionManager.maybeAddPartitionToTransaction(tp0);
  transactionManager.maybeAddPartitionToTransaction(tp1);
  Map<TopicPartition,Errors> errors=new HashMap<>();
  errors.put(tp0,Errors.TOPIC_AUTHORIZATION_FAILED);
  errors.put(tp1,Errors.OPERATION_NOT_ATTEMPTED);
  prepareAddPartitionsToTxn(errors);
  sender.run(time.milliseconds());
  assertTrue(transactionManager.hasError());
  assertTrue(transactionManager.lastError() instanceof TopicAuthorizationException);
  assertFalse(transactionManager.isPartitionPendingAdd(tp0));
  assertFalse(transactionManager.isPartitionPendingAdd(tp1));
  assertFalse(transactionManager.isPartitionAdded(tp0));
  assertFalse(transactionManager.isPartitionAdded(tp1));
  assertFalse(transactionManager.hasPartitionsToAdd());
  TopicAuthorizationException exception=(TopicAuthorizationException)transactionManager.lastError();
  assertEquals(singleton(tp0.topic()),exception.unauthorizedTopics());
  assertAbortableError(TopicAuthorizationException.class);
}
