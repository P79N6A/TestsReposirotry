@Test public void testIsSendToPartitionAllowedWithAddedPartitionAfterFatalError(){
  final long pid=13131L;
  final short epoch=1;
  doInitTransactions(pid,epoch);
  transactionManager.beginTransaction();
  transactionManager.maybeAddPartitionToTransaction(tp0);
  prepareAddPartitionsToTxnResponse(Errors.NONE,tp0,epoch,pid);
  sender.run(time.milliseconds());
  assertFalse(transactionManager.hasPartitionsToAdd());
  transactionManager.transitionToFatalError(new KafkaException());
  assertFalse(transactionManager.isSendToPartitionAllowed(tp0));
  assertTrue(transactionManager.hasFatalError());
}
