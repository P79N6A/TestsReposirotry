@Test public void shouldNotSendAbortTxnRequestWhenOnlyAddOffsetsRequestFailed() throws Exception {
  final long pid=13131L;
  final short epoch=1;
  doInitTransactions(pid,epoch);
  transactionManager.beginTransaction();
  Map<TopicPartition,OffsetAndMetadata> offsets=new HashMap<>();
  offsets.put(tp1,new OffsetAndMetadata(1));
  final String consumerGroupId="myconsumergroup";
  transactionManager.sendOffsetsToTransaction(offsets,consumerGroupId);
  TransactionalRequestResult abortResult=transactionManager.beginAbort();
  prepareAddOffsetsToTxnResponse(Errors.GROUP_AUTHORIZATION_FAILED,consumerGroupId,pid,epoch);
  sender.run(time.milliseconds());
  assertFalse(abortResult.isCompleted());
  sender.run(time.milliseconds());
  assertTrue(transactionManager.isReady());
  assertTrue(abortResult.isCompleted());
  assertTrue(abortResult.isSuccessful());
}
