@Test public void testLookupCoordinatorOnNotCoordinatorError(){
  final long pid=13131L;
  final short epoch=1;
  TransactionalRequestResult initPidResult=transactionManager.initializeTransactions();
  prepareFindCoordinatorResponse(Errors.NONE,false,CoordinatorType.TRANSACTION,transactionalId);
  sender.run(time.milliseconds());
  sender.run(time.milliseconds());
  assertEquals(brokerNode,transactionManager.coordinator(CoordinatorType.TRANSACTION));
  prepareInitPidResponse(Errors.NOT_COORDINATOR,false,pid,epoch);
  sender.run(time.milliseconds());
  assertEquals(null,transactionManager.coordinator(CoordinatorType.TRANSACTION));
  assertFalse(initPidResult.isCompleted());
  assertFalse(transactionManager.hasProducerId());
  prepareFindCoordinatorResponse(Errors.NONE,false,CoordinatorType.TRANSACTION,transactionalId);
  sender.run(time.milliseconds());
  assertEquals(brokerNode,transactionManager.coordinator(CoordinatorType.TRANSACTION));
  assertFalse(initPidResult.isCompleted());
  prepareInitPidResponse(Errors.NONE,false,pid,epoch);
  sender.run(time.milliseconds());
  assertTrue(initPidResult.isCompleted());
  assertTrue(transactionManager.hasProducerId());
  assertEquals(pid,transactionManager.producerIdAndEpoch().producerId);
  assertEquals(epoch,transactionManager.producerIdAndEpoch().epoch);
}
