@Test public void shouldFailAbortIfAddOffsetsFailsWithFatalError() throws Exception {
  final long pid=13131L;
  final short epoch=1;
  doInitTransactions(pid,epoch);
  transactionManager.beginTransaction();
  Map<TopicPartition,OffsetAndMetadata> offsets=new HashMap<>();
  offsets.put(tp1,new OffsetAndMetadata(1));
  final String consumerGroupId="myconsumergroup";
  transactionManager.sendOffsetsToTransaction(offsets,consumerGroupId);
  TransactionalRequestResult abortResult=transactionManager.beginAbort();
  prepareAddOffsetsToTxnResponse(Errors.UNKNOWN_SERVER_ERROR,consumerGroupId,pid,epoch);
  sender.run(time.milliseconds());
  assertFalse(abortResult.isCompleted());
  sender.run(time.milliseconds());
  assertTrue(abortResult.isCompleted());
  assertFalse(abortResult.isSuccessful());
  assertTrue(transactionManager.hasFatalError());
}
