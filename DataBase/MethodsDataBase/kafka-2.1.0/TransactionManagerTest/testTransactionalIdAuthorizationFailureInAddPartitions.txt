@Test public void testTransactionalIdAuthorizationFailureInAddPartitions(){
  final long pid=13131L;
  final short epoch=1;
  final TopicPartition tp=new TopicPartition("foo",0);
  doInitTransactions(pid,epoch);
  transactionManager.beginTransaction();
  transactionManager.maybeAddPartitionToTransaction(tp);
  prepareAddPartitionsToTxn(tp,Errors.TRANSACTIONAL_ID_AUTHORIZATION_FAILED);
  sender.run(time.milliseconds());
  assertTrue(transactionManager.hasError());
  assertTrue(transactionManager.lastError() instanceof TransactionalIdAuthorizationException);
  assertFatalError(TransactionalIdAuthorizationException.class);
}
