@Test public void testRegisterPersistentStore() throws IOException {
  final TaskId taskId=new TaskId(0,2);
  final MockKeyValueStore persistentStore=getPersistentStore();
  final ProcessorStateManager stateMgr=new ProcessorStateManager(taskId,noPartitions,false,stateDirectory,new HashMap<String,String>(){
{
      put(persistentStoreName,persistentStoreTopicName);
      put(nonPersistentStoreName,nonPersistentStoreName);
    }
  }
,changelogReader,false,logContext);
  try {
    stateMgr.register(persistentStore,persistentStore.stateRestoreCallback);
    assertTrue(changelogReader.wasRegistered(new TopicPartition(persistentStoreTopicName,2)));
  }
  finally {
    stateMgr.close(Collections.emptyMap());
  }
}
