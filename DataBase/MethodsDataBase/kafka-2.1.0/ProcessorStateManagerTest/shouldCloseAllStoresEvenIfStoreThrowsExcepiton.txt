@Test public void shouldCloseAllStoresEvenIfStoreThrowsExcepiton() throws IOException {
  final ProcessorStateManager stateManager=new ProcessorStateManager(taskId,Collections.singleton(changelogTopicPartition),false,stateDirectory,Collections.singletonMap(storeName,changelogTopic),changelogReader,false,logContext);
  final AtomicBoolean closedStore=new AtomicBoolean(false);
  final MockKeyValueStore stateStore1=new MockKeyValueStore(storeName,true){
    @Override public void close(){
      throw new RuntimeException("KABOOM!");
    }
  }
;
  final MockKeyValueStore stateStore2=new MockKeyValueStore(storeName + "2",true){
    @Override public void close(){
      closedStore.set(true);
    }
  }
;
  stateManager.register(stateStore1,stateStore1.stateRestoreCallback);
  stateManager.register(stateStore2,stateStore2.stateRestoreCallback);
  try {
    stateManager.close(Collections.emptyMap());
  }
 catch (  final ProcessorStateException expected) {
  }
  Assert.assertTrue(closedStore.get());
}
