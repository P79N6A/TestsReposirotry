@Test public void shouldThrowProcessorStateExceptionOnCloseIfStoreThrowsAnException() throws IOException {
  final ProcessorStateManager stateManager=new ProcessorStateManager(taskId,Collections.singleton(changelogTopicPartition),false,stateDirectory,Collections.singletonMap(storeName,changelogTopic),changelogReader,false,logContext);
  final MockKeyValueStore stateStore=new MockKeyValueStore(storeName,true){
    @Override public void close(){
      throw new RuntimeException("KABOOM!");
    }
  }
;
  stateManager.register(stateStore,stateStore.stateRestoreCallback);
  try {
    stateManager.close(Collections.emptyMap());
    fail("Should throw ProcessorStateException if store close throws exception");
  }
 catch (  final ProcessorStateException e) {
  }
}
