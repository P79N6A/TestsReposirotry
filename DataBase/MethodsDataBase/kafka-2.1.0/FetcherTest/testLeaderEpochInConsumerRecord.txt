@Test public void testLeaderEpochInConsumerRecord(){
  subscriptions.assignFromUser(singleton(tp0));
  subscriptions.seek(tp0,0);
  Integer partitionLeaderEpoch=1;
  ByteBuffer buffer=ByteBuffer.allocate(1024);
  MemoryRecordsBuilder builder=MemoryRecords.builder(buffer,RecordBatch.CURRENT_MAGIC_VALUE,CompressionType.NONE,TimestampType.CREATE_TIME,0L,System.currentTimeMillis(),partitionLeaderEpoch);
  builder.append(0L,"key".getBytes(),partitionLeaderEpoch.toString().getBytes());
  builder.append(0L,"key".getBytes(),partitionLeaderEpoch.toString().getBytes());
  builder.close();
  partitionLeaderEpoch+=7;
  builder=MemoryRecords.builder(buffer,RecordBatch.CURRENT_MAGIC_VALUE,CompressionType.NONE,TimestampType.CREATE_TIME,2L,System.currentTimeMillis(),partitionLeaderEpoch);
  builder.append(0L,"key".getBytes(),partitionLeaderEpoch.toString().getBytes());
  builder.close();
  partitionLeaderEpoch+=5;
  builder=MemoryRecords.builder(buffer,RecordBatch.CURRENT_MAGIC_VALUE,CompressionType.NONE,TimestampType.CREATE_TIME,3L,System.currentTimeMillis(),partitionLeaderEpoch);
  builder.append(0L,"key".getBytes(),partitionLeaderEpoch.toString().getBytes());
  builder.append(0L,"key".getBytes(),partitionLeaderEpoch.toString().getBytes());
  builder.append(0L,"key".getBytes(),partitionLeaderEpoch.toString().getBytes());
  builder.close();
  buffer.flip();
  MemoryRecords records=MemoryRecords.readableRecords(buffer);
  assertEquals(1,fetcher.sendFetches());
  assertFalse(fetcher.hasCompletedFetches());
  client.prepareResponse(fullFetchResponse(tp0,records,Errors.NONE,100L,0));
  consumerClient.poll(time.timer(0));
  assertTrue(fetcher.hasCompletedFetches());
  Map<TopicPartition,List<ConsumerRecord<byte[],byte[]>>> partitionRecords=fetcher.fetchedRecords();
  assertTrue(partitionRecords.containsKey(tp0));
  assertEquals(6,partitionRecords.get(tp0).size());
  for (  ConsumerRecord<byte[],byte[]> record : partitionRecords.get(tp0)) {
    int expectedLeaderEpoch=Integer.parseInt(Utils.utf8(record.value()));
    assertEquals(Optional.of(expectedLeaderEpoch),record.leaderEpoch());
  }
}
