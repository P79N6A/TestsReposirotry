/** 
 * Test the scenario where a partition with fetched but not consumed records (i.e. max.poll.records is less than the number of fetched records) is unassigned and a different partition is assigned. This is a pattern used by Streams state restoration and KAFKA-5097 would have been caught by this test.
 */
@Test public void testFetchAfterPartitionWithFetchedRecordsIsUnassigned(){
  Fetcher<byte[],byte[]> fetcher=createFetcher(subscriptions,new Metrics(time),2);
  List<ConsumerRecord<byte[],byte[]>> records;
  subscriptions.assignFromUser(singleton(tp0));
  subscriptions.seek(tp0,1);
  client.prepareResponse(matchesOffset(tp0,1),fullFetchResponse(tp0,this.records,Errors.NONE,100L,0));
  assertEquals(1,fetcher.sendFetches());
  consumerClient.poll(time.timer(0));
  records=fetcher.fetchedRecords().get(tp0);
  assertEquals(2,records.size());
  assertEquals(3L,subscriptions.position(tp0).longValue());
  assertEquals(1,records.get(0).offset());
  assertEquals(2,records.get(1).offset());
  subscriptions.assignFromUser(singleton(tp1));
  client.prepareResponse(matchesOffset(tp1,4),fullFetchResponse(tp1,this.nextRecords,Errors.NONE,100L,0));
  subscriptions.seek(tp1,4);
  assertEquals(1,fetcher.sendFetches());
  consumerClient.poll(time.timer(0));
  Map<TopicPartition,List<ConsumerRecord<byte[],byte[]>>> fetchedRecords=fetcher.fetchedRecords();
  assertNull(fetchedRecords.get(tp0));
  records=fetchedRecords.get(tp1);
  assertEquals(2,records.size());
  assertEquals(6L,subscriptions.position(tp1).longValue());
  assertEquals(4,records.get(0).offset());
  assertEquals(5,records.get(1).offset());
}
