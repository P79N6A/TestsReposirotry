@Test public void testRestOffsetsAuthorizationFailure(){
  subscriptions.assignFromUser(singleton(tp0));
  subscriptions.requestOffsetReset(tp0,OffsetResetStrategy.LATEST);
  client.prepareResponse(listOffsetRequestMatcher(ListOffsetRequest.LATEST_TIMESTAMP),listOffsetResponse(Errors.TOPIC_AUTHORIZATION_FAILED,-1,-1),false);
  fetcher.resetOffsetsIfNeeded();
  consumerClient.pollNoWakeup();
  assertFalse(subscriptions.hasValidPosition(tp0));
  try {
    fetcher.resetOffsetsIfNeeded();
    fail("Expected authorization error to be raised");
  }
 catch (  TopicAuthorizationException e) {
    assertEquals(singleton(tp0.topic()),e.unauthorizedTopics());
  }
  fetcher.resetOffsetsIfNeeded();
  consumerClient.pollNoWakeup();
  assertFalse(client.hasInFlightRequests());
  assertFalse(subscriptions.hasValidPosition(tp0));
  time.sleep(retryBackoffMs);
  client.prepareResponse(listOffsetRequestMatcher(ListOffsetRequest.LATEST_TIMESTAMP),listOffsetResponse(Errors.NONE,1L,5L));
  fetcher.resetOffsetsIfNeeded();
  consumerClient.pollNoWakeup();
  assertFalse(subscriptions.isOffsetResetNeeded(tp0));
  assertTrue(subscriptions.isFetchable(tp0));
  assertEquals(5,subscriptions.position(tp0).longValue());
}
