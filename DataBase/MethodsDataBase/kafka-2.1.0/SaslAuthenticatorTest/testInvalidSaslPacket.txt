/** 
 * Tests that any invalid data during Kafka SASL handshake request flow or the actual SASL authentication flow result in authentication failure and do not cause any failures in the server.
 */
@Test public void testInvalidSaslPacket() throws Exception {
  SecurityProtocol securityProtocol=SecurityProtocol.SASL_PLAINTEXT;
  configureMechanisms("PLAIN",Arrays.asList("PLAIN"));
  server=createEchoServer(securityProtocol);
  String node1="invalid1";
  createClientConnection(SecurityProtocol.PLAINTEXT,node1);
  sendHandshakeRequestReceiveResponse(node1,(short)1);
  Random random=new Random();
  byte[] bytes=new byte[1024];
  random.nextBytes(bytes);
  selector.send(new NetworkSend(node1,ByteBuffer.wrap(bytes)));
  NetworkTestUtils.waitForChannelClose(selector,node1,ChannelState.READY.state());
  selector.close();
  createAndCheckClientConnection(securityProtocol,"good1");
  String node2="invalid2";
  createClientConnection(SecurityProtocol.PLAINTEXT,node2);
  random.nextBytes(bytes);
  selector.send(new NetworkSend(node2,ByteBuffer.wrap(bytes)));
  NetworkTestUtils.waitForChannelClose(selector,node2,ChannelState.READY.state());
  selector.close();
  createAndCheckClientConnection(securityProtocol,"good2");
}
