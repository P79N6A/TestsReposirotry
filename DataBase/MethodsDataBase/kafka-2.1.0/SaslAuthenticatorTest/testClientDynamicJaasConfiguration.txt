/** 
 * Tests dynamic JAAS configuration property for SASL clients. Invalid client credentials are set in the static JVM-wide configuration instance to ensure that the dynamic property override is used during authentication.
 */
@Test public void testClientDynamicJaasConfiguration() throws Exception {
  SecurityProtocol securityProtocol=SecurityProtocol.SASL_SSL;
  saslClientConfigs.put(SaslConfigs.SASL_MECHANISM,"PLAIN");
  saslServerConfigs.put(BrokerSecurityConfigs.SASL_ENABLED_MECHANISMS_CONFIG,Arrays.asList("PLAIN"));
  Map<String,Object> serverOptions=new HashMap<>();
  serverOptions.put("user_user1","user1-secret");
  serverOptions.put("user_user2","user2-secret");
  TestJaasConfig staticJaasConfig=new TestJaasConfig();
  staticJaasConfig.createOrUpdateEntry(TestJaasConfig.LOGIN_CONTEXT_SERVER,PlainLoginModule.class.getName(),serverOptions);
  staticJaasConfig.setClientOptions("PLAIN","user1","invalidpassword");
  Configuration.setConfiguration(staticJaasConfig);
  server=createEchoServer(securityProtocol);
  createAndCheckClientConnectionFailure(securityProtocol,"1");
  saslClientConfigs.put(SaslConfigs.SASL_JAAS_CONFIG,TestJaasConfig.jaasConfigProperty("PLAIN","user1","user1-secret"));
  createAndCheckClientConnection(securityProtocol,"2");
  saslClientConfigs.put(SaslConfigs.SASL_JAAS_CONFIG,TestJaasConfig.jaasConfigProperty("PLAIN","user1","user2-secret"));
  createAndCheckClientConnectionFailure(securityProtocol,"3");
  saslClientConfigs.put(SaslConfigs.SASL_JAAS_CONFIG,TestJaasConfig.jaasConfigProperty("PLAIN","user2","user2-secret"));
  createAndCheckClientConnection(securityProtocol,"4");
  String module1=TestJaasConfig.jaasConfigProperty("PLAIN","user1","user1-secret").value();
  String module2=TestJaasConfig.jaasConfigProperty("PLAIN","user2","user2-secret").value();
  saslClientConfigs.put(SaslConfigs.SASL_JAAS_CONFIG,new Password(module1 + " " + module2));
  try {
    createClientConnection(securityProtocol,"1");
    fail("Connection created with multiple login modules in sasl.jaas.config");
  }
 catch (  IllegalArgumentException e) {
  }
}
