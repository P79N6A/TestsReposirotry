/** 
 * Tests that packets that are too big during Kafka SASL handshake request flow or the actual SASL authentication flow result in authentication failure and do not cause any failures in the server.
 */
@Test public void testPacketSizeTooBig() throws Exception {
  SecurityProtocol securityProtocol=SecurityProtocol.SASL_PLAINTEXT;
  configureMechanisms("PLAIN",Arrays.asList("PLAIN"));
  server=createEchoServer(securityProtocol);
  String node1="invalid1";
  createClientConnection(SecurityProtocol.PLAINTEXT,node1);
  sendHandshakeRequestReceiveResponse(node1,(short)1);
  ByteBuffer buffer=ByteBuffer.allocate(1024);
  buffer.putInt(Integer.MAX_VALUE);
  buffer.put(new byte[buffer.capacity() - 4]);
  buffer.rewind();
  selector.send(new NetworkSend(node1,buffer));
  NetworkTestUtils.waitForChannelClose(selector,node1,ChannelState.READY.state());
  selector.close();
  createAndCheckClientConnection(securityProtocol,"good1");
  String node2="invalid2";
  createClientConnection(SecurityProtocol.PLAINTEXT,node2);
  buffer.clear();
  buffer.putInt(Integer.MAX_VALUE);
  buffer.put(new byte[buffer.capacity() - 4]);
  buffer.rewind();
  selector.send(new NetworkSend(node2,buffer));
  NetworkTestUtils.waitForChannelClose(selector,node2,ChannelState.READY.state());
  selector.close();
  createAndCheckClientConnection(securityProtocol,"good2");
}
