/** 
 * Test that callback handlers are only applied to connections for the mechanisms configured for the handler. Test enables two mechanisms 'PLAIN` and `DIGEST-MD5` on the servers with different callback handlers for the two mechanisms. Verifies that clients using both mechanisms authenticate successfully.
 */
@Test public void testAuthenticateCallbackHandlerMechanisms() throws Exception {
  SecurityProtocol securityProtocol=SecurityProtocol.SASL_PLAINTEXT;
  TestJaasConfig jaasConfig=configureMechanisms("DIGEST-MD5",Arrays.asList("DIGEST-MD5","PLAIN"));
  saslServerConfigs.put("plain." + BrokerSecurityConfigs.SASL_SERVER_CALLBACK_HANDLER_CLASS,TestServerCallbackHandler.class);
  saslServerConfigs.put("digest-md5." + BrokerSecurityConfigs.SASL_SERVER_CALLBACK_HANDLER_CLASS,DigestServerCallbackHandler.class);
  server=createEchoServer(securityProtocol);
  createAndCheckClientConnectionFailure(securityProtocol,"invalid");
  ListenerName listener=ListenerName.forSecurityProtocol(securityProtocol);
  saslServerConfigs.remove("plain." + BrokerSecurityConfigs.SASL_SERVER_CALLBACK_HANDLER_CLASS);
  saslServerConfigs.remove("digest-md5." + BrokerSecurityConfigs.SASL_SERVER_CALLBACK_HANDLER_CLASS);
  saslServerConfigs.put(listener.saslMechanismConfigPrefix("plain") + BrokerSecurityConfigs.SASL_SERVER_CALLBACK_HANDLER_CLASS,TestServerCallbackHandler.class);
  saslServerConfigs.put(listener.saslMechanismConfigPrefix("digest-md5") + BrokerSecurityConfigs.SASL_SERVER_CALLBACK_HANDLER_CLASS,DigestServerCallbackHandler.class);
  server=createEchoServer(securityProtocol);
  createAndCheckClientConnection(securityProtocol,"good-digest-md5");
  jaasConfig.setClientOptions("PLAIN",TestServerCallbackHandler.USERNAME,TestServerCallbackHandler.PASSWORD);
  saslClientConfigs.put(SaslConfigs.SASL_MECHANISM,"PLAIN");
  createAndCheckClientConnection(securityProtocol,"good-plain");
}
