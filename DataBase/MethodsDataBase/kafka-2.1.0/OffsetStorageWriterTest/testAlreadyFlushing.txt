@Test(expected=ConnectException.class) public void testAlreadyFlushing() throws Exception {
  @SuppressWarnings("unchecked") final Callback<Void> callback=PowerMock.createMock(Callback.class);
  CountDownLatch allowStoreCompleteCountdown=new CountDownLatch(1);
  expectStore(OFFSET_KEY,OFFSET_KEY_SERIALIZED,OFFSET_VALUE,OFFSET_VALUE_SERIALIZED,null,false,allowStoreCompleteCountdown);
  PowerMock.replayAll();
  writer.offset(OFFSET_KEY,OFFSET_VALUE);
  assertTrue(writer.beginFlush());
  writer.doFlush(callback);
  assertTrue(writer.beginFlush());
  PowerMock.verifyAll();
}
