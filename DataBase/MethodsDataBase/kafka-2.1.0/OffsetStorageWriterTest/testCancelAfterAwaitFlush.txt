@Test public void testCancelAfterAwaitFlush() throws Exception {
  @SuppressWarnings("unchecked") Callback<Void> callback=PowerMock.createMock(Callback.class);
  CountDownLatch allowStoreCompleteCountdown=new CountDownLatch(1);
  expectStore(OFFSET_KEY,OFFSET_KEY_SERIALIZED,OFFSET_VALUE,OFFSET_VALUE_SERIALIZED,null,false,allowStoreCompleteCountdown);
  PowerMock.replayAll();
  writer.offset(OFFSET_KEY,OFFSET_VALUE);
  assertTrue(writer.beginFlush());
  Future<Void> flushFuture=writer.doFlush(callback);
  writer.cancelFlush();
  allowStoreCompleteCountdown.countDown();
  flushFuture.get(1000,TimeUnit.MILLISECONDS);
  PowerMock.verifyAll();
}
