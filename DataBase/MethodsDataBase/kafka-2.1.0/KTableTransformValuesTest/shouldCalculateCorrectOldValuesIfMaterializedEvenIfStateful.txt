@Test public void shouldCalculateCorrectOldValuesIfMaterializedEvenIfStateful(){
  builder.table(INPUT_TOPIC,CONSUMED).transformValues(new StatefulTransformerSupplier(),Materialized.<String,Integer,KeyValueStore<Bytes,byte[]>>as(QUERYABLE_NAME).withKeySerde(Serdes.String()).withValueSerde(Serdes.Integer())).groupBy(toForceSendingOfOldValues(),Serialized.with(Serdes.String(),Serdes.Integer())).reduce(MockReducer.INTEGER_ADDER,MockReducer.INTEGER_SUBTRACTOR).mapValues(mapBackToStrings()).toStream().process(capture);
  driver=new TopologyTestDriver(builder.build(),props());
  driver.pipeInput(recordFactory.create(INPUT_TOPIC,"A","ignore",0L));
  driver.pipeInput(recordFactory.create(INPUT_TOPIC,"A","ignored",0L));
  driver.pipeInput(recordFactory.create(INPUT_TOPIC,"A","ignored",0L));
  assertThat(output(),hasItems("A:1","A:0","A:2","A:0","A:3"));
  final KeyValueStore<String,Integer> keyValueStore=driver.getKeyValueStore(QUERYABLE_NAME);
  assertThat(keyValueStore.get("A"),is(3));
}
