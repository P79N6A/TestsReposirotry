@Test public void testThrottlingNotEnabledForConnectionToOlderBroker(){
  setExpectedApiVersionsResponse(createExpectedApiVersionsResponse(node,ApiKeys.PRODUCE,(short)5));
  while (!client.ready(node,time.milliseconds()))   client.poll(1,time.milliseconds());
  selector.clear();
  ProduceRequest.Builder builder=ProduceRequest.Builder.forCurrentMagic((short)1,1000,Collections.emptyMap());
  TestCallbackHandler handler=new TestCallbackHandler();
  ClientRequest request=client.newClientRequest(node.idString(),builder,time.milliseconds(),true,defaultRequestTimeoutMs,handler);
  client.send(request,time.milliseconds());
  client.poll(1,time.milliseconds());
  ResponseHeader respHeader=new ResponseHeader(request.correlationId());
  Struct resp=new Struct(ApiKeys.PRODUCE.responseSchema(ApiKeys.PRODUCE.latestVersion()));
  resp.set("responses",new Object[0]);
  resp.set(CommonFields.THROTTLE_TIME_MS,100);
  Struct responseHeaderStruct=respHeader.toStruct();
  int size=responseHeaderStruct.sizeOf() + resp.sizeOf();
  ByteBuffer buffer=ByteBuffer.allocate(size);
  responseHeaderStruct.writeTo(buffer);
  resp.writeTo(buffer);
  buffer.flip();
  selector.completeReceive(new NetworkReceive(node.idString(),buffer));
  client.poll(1,time.milliseconds());
  assertTrue(client.ready(node,time.milliseconds()));
  assertEquals(0,client.throttleDelayMs(node,time.milliseconds()));
}
