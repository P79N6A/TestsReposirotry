@Test public void testDisconnectDuringUserMetadataRequest(){
  awaitReady(client,node);
  MetadataRequest.Builder builder=new MetadataRequest.Builder(Collections.<String>emptyList(),true);
  long now=time.milliseconds();
  ClientRequest request=client.newClientRequest(node.idString(),builder,now,true);
  client.send(request,now);
  client.poll(defaultRequestTimeoutMs,now);
  assertEquals(1,client.inFlightRequestCount(node.idString()));
  assertTrue(client.hasInFlightRequests(node.idString()));
  assertTrue(client.hasInFlightRequests());
  selector.close(node.idString());
  List<ClientResponse> responses=client.poll(defaultRequestTimeoutMs,time.milliseconds());
  assertEquals(1,responses.size());
  assertTrue(responses.iterator().next().wasDisconnected());
}
