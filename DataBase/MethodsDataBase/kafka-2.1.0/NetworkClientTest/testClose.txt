@Test public void testClose(){
  client.ready(node,time.milliseconds());
  awaitReady(client,node);
  client.poll(1,time.milliseconds());
  assertTrue("The client should be ready",client.isReady(node,time.milliseconds()));
  ProduceRequest.Builder builder=ProduceRequest.Builder.forCurrentMagic((short)1,1000,Collections.<TopicPartition,MemoryRecords>emptyMap());
  ClientRequest request=client.newClientRequest(node.idString(),builder,time.milliseconds(),true);
  client.send(request,time.milliseconds());
  assertEquals("There should be 1 in-flight request after send",1,client.inFlightRequestCount(node.idString()));
  assertTrue(client.hasInFlightRequests(node.idString()));
  assertTrue(client.hasInFlightRequests());
  client.close(node.idString());
  assertEquals("There should be no in-flight request after close",0,client.inFlightRequestCount(node.idString()));
  assertFalse(client.hasInFlightRequests(node.idString()));
  assertFalse(client.hasInFlightRequests());
  assertFalse("Connection should not be ready after close",client.isReady(node,0));
}
