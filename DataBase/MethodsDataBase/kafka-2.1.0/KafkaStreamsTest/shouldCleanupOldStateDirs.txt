@Test public void shouldCleanupOldStateDirs() throws InterruptedException {
  props.setProperty(StreamsConfig.STATE_CLEANUP_DELAY_MS_CONFIG,"1");
  final String topic="topic";
  CLUSTER.createTopic(topic);
  final StreamsBuilder builder=new StreamsBuilder();
  final Consumed<String,String> consumed=Consumed.with(Serdes.String(),Serdes.String());
  builder.table(topic,consumed);
  final KafkaStreams streams=new KafkaStreams(builder.build(),props);
  try {
    final CountDownLatch latch=new CountDownLatch(1);
    streams.setStateListener((newState,oldState) -> {
      if (newState == KafkaStreams.State.RUNNING && oldState == KafkaStreams.State.REBALANCING) {
        latch.countDown();
      }
    }
);
    final String appDir=props.getProperty(StreamsConfig.STATE_DIR_CONFIG) + File.separator + props.getProperty(StreamsConfig.APPLICATION_ID_CONFIG);
    final File oldTaskDir=new File(appDir,"10_1");
    assertTrue(oldTaskDir.mkdirs());
    streams.start();
    latch.await(30,TimeUnit.SECONDS);
    verifyCleanupStateDir(appDir,oldTaskDir);
    assertTrue(oldTaskDir.mkdirs());
    verifyCleanupStateDir(appDir,oldTaskDir);
  }
  finally {
    streams.close();
  }
}
