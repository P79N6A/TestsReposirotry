@Test public void testStateGlobalThreadClose() throws Exception {
  builder.globalTable("anyTopic");
  final KafkaStreams streams=new KafkaStreams(builder.build(),props);
  try {
    streams.start();
    TestUtils.waitForCondition(() -> streams.state() == KafkaStreams.State.RUNNING,10 * 1000,"Streams never started.");
    final java.lang.reflect.Field globalThreadField=streams.getClass().getDeclaredField("globalStreamThread");
    globalThreadField.setAccessible(true);
    final GlobalStreamThread globalStreamThread=(GlobalStreamThread)globalThreadField.get(streams);
    globalStreamThread.shutdown();
    TestUtils.waitForCondition(() -> globalStreamThread.state() == GlobalStreamThread.State.DEAD,10 * 1000,"Thread never stopped.");
    globalStreamThread.join();
    assertEquals(streams.state(),KafkaStreams.State.ERROR);
  }
  finally {
    streams.close();
  }
  assertEquals(streams.state(),KafkaStreams.State.NOT_RUNNING);
}
