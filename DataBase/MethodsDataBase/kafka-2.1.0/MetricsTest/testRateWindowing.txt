@Test public void testRateWindowing() throws Exception {
  MetricConfig cfg=new MetricConfig().samples(3);
  Sensor s=metrics.sensor("test.sensor",cfg);
  MetricName rateMetricName=metrics.metricName("test.rate","grp1");
  MetricName totalMetricName=metrics.metricName("test.total","grp1");
  MetricName countRateMetricName=metrics.metricName("test.count.rate","grp1");
  MetricName countTotalMetricName=metrics.metricName("test.count.total","grp1");
  s.add(new Meter(TimeUnit.SECONDS,rateMetricName,totalMetricName));
  s.add(new Meter(TimeUnit.SECONDS,new Count(),countRateMetricName,countTotalMetricName));
  KafkaMetric totalMetric=metrics.metrics().get(totalMetricName);
  KafkaMetric countTotalMetric=metrics.metrics().get(countTotalMetricName);
  int sum=0;
  int count=cfg.samples() - 1;
  for (int i=0; i < count; i++) {
    s.record(100);
    sum+=100;
    time.sleep(cfg.timeWindowMs());
    assertEquals(sum,(Double)totalMetric.metricValue(),EPS);
  }
  time.sleep(cfg.timeWindowMs() / 2);
  double elapsedSecs=(cfg.timeWindowMs() * (cfg.samples() - 1) + cfg.timeWindowMs() / 2) / 1000.0;
  KafkaMetric rateMetric=metrics.metrics().get(rateMetricName);
  KafkaMetric countRateMetric=metrics.metrics().get(countRateMetricName);
  assertEquals("Rate(0...2) = 2.666",sum / elapsedSecs,(Double)rateMetric.metricValue(),EPS);
  assertEquals("Count rate(0...2) = 0.02666",count / elapsedSecs,(Double)countRateMetric.metricValue(),EPS);
  assertEquals("Elapsed Time = 75 seconds",elapsedSecs,((Rate)rateMetric.measurable()).windowSize(cfg,time.milliseconds()) / 1000,EPS);
  assertEquals(sum,(Double)totalMetric.metricValue(),EPS);
  assertEquals(count,(Double)countTotalMetric.metricValue(),EPS);
  time.sleep(cfg.timeWindowMs() * cfg.samples());
  assertEquals(0,(Double)rateMetric.metricValue(),EPS);
  assertEquals(0,(Double)countRateMetric.metricValue(),EPS);
  assertEquals(sum,(Double)totalMetric.metricValue(),EPS);
  assertEquals(count,(Double)countTotalMetric.metricValue(),EPS);
}
