@Test public void testBuildEndTxnMarker(){
  if (magic >= RecordBatch.MAGIC_VALUE_V2) {
    long producerId=73;
    short producerEpoch=13;
    long initialOffset=983L;
    int coordinatorEpoch=347;
    int partitionLeaderEpoch=29;
    EndTransactionMarker marker=new EndTransactionMarker(ControlRecordType.COMMIT,coordinatorEpoch);
    MemoryRecords records=MemoryRecords.withEndTransactionMarker(initialOffset,System.currentTimeMillis(),partitionLeaderEpoch,producerId,producerEpoch,marker);
    assertEquals(records.buffer().remaining(),records.buffer().capacity());
    List<MutableRecordBatch> batches=TestUtils.toList(records.batches());
    assertEquals(1,batches.size());
    RecordBatch batch=batches.get(0);
    assertTrue(batch.isControlBatch());
    assertEquals(producerId,batch.producerId());
    assertEquals(producerEpoch,batch.producerEpoch());
    assertEquals(initialOffset,batch.baseOffset());
    assertEquals(partitionLeaderEpoch,batch.partitionLeaderEpoch());
    assertTrue(batch.isValid());
    List<Record> createdRecords=TestUtils.toList(batch);
    assertEquals(1,createdRecords.size());
    Record record=createdRecords.get(0);
    assertTrue(record.isValid());
    EndTransactionMarker deserializedMarker=EndTransactionMarker.deserialize(record);
    assertEquals(ControlRecordType.COMMIT,deserializedMarker.controlType());
    assertEquals(coordinatorEpoch,deserializedMarker.coordinatorEpoch());
  }
}
