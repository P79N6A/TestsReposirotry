@Test public void shouldAllowIncrementalBuilds(){
  Map<Integer,Set<String>> oldNodeGroups, newNodeGroups;
  oldNodeGroups=builder.nodeGroups();
  builder.addSource(null,"source-1",null,null,null,"topic-1");
  builder.addSource(null,"source-2",null,null,null,"topic-2");
  newNodeGroups=builder.nodeGroups();
  assertNotEquals(oldNodeGroups,newNodeGroups);
  oldNodeGroups=newNodeGroups;
  builder.addSource(null,"source-3",null,null,null,Pattern.compile(""));
  builder.addSource(null,"source-4",null,null,null,Pattern.compile(""));
  newNodeGroups=builder.nodeGroups();
  assertNotEquals(oldNodeGroups,newNodeGroups);
  oldNodeGroups=newNodeGroups;
  builder.addProcessor("processor-1",new MockProcessorSupplier(),"source-1");
  builder.addProcessor("processor-2",new MockProcessorSupplier(),"source-2");
  builder.addProcessor("processor-3",new MockProcessorSupplier(),"source-3");
  newNodeGroups=builder.nodeGroups();
  assertNotEquals(oldNodeGroups,newNodeGroups);
  oldNodeGroups=newNodeGroups;
  builder.addSink("sink-1","sink-topic",null,null,null,"processor-1");
  newNodeGroups=builder.nodeGroups();
  assertNotEquals(oldNodeGroups,newNodeGroups);
  oldNodeGroups=newNodeGroups;
  builder.addSink("sink-2",(k,v,ctx) -> "sink-topic",null,null,null,"processor-2");
  newNodeGroups=builder.nodeGroups();
  assertNotEquals(oldNodeGroups,newNodeGroups);
  oldNodeGroups=newNodeGroups;
  builder.addStateStore(new MockKeyValueStoreBuilder("store-1",false),"processor-1","processor-2");
  newNodeGroups=builder.nodeGroups();
  assertNotEquals(oldNodeGroups,newNodeGroups);
  oldNodeGroups=newNodeGroups;
  builder.addStateStore(new MockKeyValueStoreBuilder("store-2",false));
  builder.connectProcessorAndStateStores("processor-2","store-2");
  builder.connectProcessorAndStateStores("processor-3","store-2");
  newNodeGroups=builder.nodeGroups();
  assertNotEquals(oldNodeGroups,newNodeGroups);
  oldNodeGroups=newNodeGroups;
  builder.addGlobalStore(new MockKeyValueStoreBuilder("global-store",false).withLoggingDisabled(),"globalSource",null,null,null,"globalTopic","global-processor",new MockProcessorSupplier());
  newNodeGroups=builder.nodeGroups();
  assertNotEquals(oldNodeGroups,newNodeGroups);
}
