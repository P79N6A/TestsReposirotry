@SuppressWarnings("unchecked") @Test public void shouldReduceAndMaterializeResults(){
  final KeyValueMapper<String,Number,KeyValue<String,Integer>> intProjection=new KeyValueMapper<String,Number,KeyValue<String,Integer>>(){
    @Override public KeyValue<String,Integer> apply(    final String key,    final Number value){
      return KeyValue.pair(key,value.intValue());
    }
  }
;
  final KTable<String,Integer> reduced=builder.table(topic,Consumed.with(Serdes.String(),Serdes.Double())).groupBy(intProjection).reduce(MockReducer.INTEGER_ADDER,MockReducer.INTEGER_SUBTRACTOR,Materialized.<String,Integer,KeyValueStore<Bytes,byte[]>>as("reduce").withKeySerde(Serdes.String()).withValueSerde(Serdes.Integer()));
  final Map<String,Integer> results=getReducedResults(reduced);
  try (final TopologyTestDriver driver=new TopologyTestDriver(builder.build(),props)){
    assertReduced(results,topic,driver);
    final KeyValueStore<String,Integer> reduce=driver.getKeyValueStore("reduce");
    assertThat(reduce.get("A"),equalTo(5));
    assertThat(reduce.get("B"),equalTo(6));
  }
 }
