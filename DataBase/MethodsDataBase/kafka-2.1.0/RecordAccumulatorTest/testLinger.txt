@Test public void testLinger() throws Exception {
  long lingerMs=10L;
  RecordAccumulator accum=createTestRecordAccumulator(1024 + DefaultRecordBatch.RECORD_BATCH_OVERHEAD,10 * 1024,CompressionType.NONE,lingerMs);
  accum.append(tp1,0L,key,value,Record.EMPTY_HEADERS,null,maxBlockTimeMs);
  assertEquals("No partitions should be ready",0,accum.ready(cluster,time.milliseconds()).readyNodes.size());
  time.sleep(10);
  assertEquals("Our partition's leader should be ready",Collections.singleton(node1),accum.ready(cluster,time.milliseconds()).readyNodes);
  List<ProducerBatch> batches=accum.drain(cluster,Collections.singleton(node1),Integer.MAX_VALUE,0).get(node1.id());
  assertEquals(1,batches.size());
  ProducerBatch batch=batches.get(0);
  Iterator<Record> iter=batch.records().records().iterator();
  Record record=iter.next();
  assertEquals("Keys should match",ByteBuffer.wrap(key),record.key());
  assertEquals("Values should match",ByteBuffer.wrap(value),record.value());
  assertFalse("No more records",iter.hasNext());
}
