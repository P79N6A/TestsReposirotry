@Test public void testCommitSuccessFollowedByFailure() throws Exception {
  expectInitializeTask();
  expectPollInitialAssignment();
  Capture<Collection<SinkRecord>> capturedRecords=expectPolls(WorkerConfig.OFFSET_COMMIT_INTERVAL_MS_DEFAULT);
  expectOffsetCommit(1L,null,null,0,true);
  expectOffsetCommit(2L,new RuntimeException(),null,0,true);
  consumer.seek(TOPIC_PARTITION,FIRST_OFFSET + 1);
  PowerMock.expectLastCall();
  consumer.seek(TOPIC_PARTITION2,FIRST_OFFSET);
  PowerMock.expectLastCall();
  consumer.seek(TOPIC_PARTITION3,FIRST_OFFSET);
  PowerMock.expectLastCall();
  expectStopTask();
  PowerMock.replayAll();
  workerTask.initialize(TASK_CONFIG);
  workerTask.initializeAndStart();
  workerTask.iteration();
  workerTask.iteration();
  workerTask.iteration();
  workerTask.iteration();
  assertEquals(1,workerTask.commitFailures());
  assertEquals(false,Whitebox.getInternalState(workerTask,"committing"));
  workerTask.stop();
  workerTask.close();
  PowerMock.verifyAll();
}
