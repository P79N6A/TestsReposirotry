@Test public void testBackgroundConnectorDeletion() throws Exception {
  expectConfigure();
  List<ConsumerRecord<String,byte[]>> existingRecords=Arrays.asList(new ConsumerRecord<>(TOPIC,0,0,0L,TimestampType.CREATE_TIME,0L,0,0,CONNECTOR_CONFIG_KEYS.get(0),CONFIGS_SERIALIZED.get(0)),new ConsumerRecord<>(TOPIC,0,1,0L,TimestampType.CREATE_TIME,0L,0,0,TASK_CONFIG_KEYS.get(0),CONFIGS_SERIALIZED.get(1)),new ConsumerRecord<>(TOPIC,0,2,0L,TimestampType.CREATE_TIME,0L,0,0,TASK_CONFIG_KEYS.get(1),CONFIGS_SERIALIZED.get(2)),new ConsumerRecord<>(TOPIC,0,3,0L,TimestampType.CREATE_TIME,0L,0,0,COMMIT_TASKS_CONFIG_KEYS.get(0),CONFIGS_SERIALIZED.get(3)));
  LinkedHashMap<byte[],Struct> deserialized=new LinkedHashMap<>();
  deserialized.put(CONFIGS_SERIALIZED.get(0),CONNECTOR_CONFIG_STRUCTS.get(0));
  deserialized.put(CONFIGS_SERIALIZED.get(1),TASK_CONFIG_STRUCTS.get(0));
  deserialized.put(CONFIGS_SERIALIZED.get(2),TASK_CONFIG_STRUCTS.get(0));
  deserialized.put(CONFIGS_SERIALIZED.get(3),TASKS_COMMIT_STRUCT_TWO_TASK_CONNECTOR);
  logOffset=5;
  expectStart(existingRecords,deserialized);
  LinkedHashMap<String,byte[]> serializedData=new LinkedHashMap<>();
  serializedData.put(CONNECTOR_CONFIG_KEYS.get(0),CONFIGS_SERIALIZED.get(0));
  serializedData.put(TARGET_STATE_KEYS.get(0),CONFIGS_SERIALIZED.get(1));
  Map<String,Struct> deserializedData=new HashMap<>();
  deserializedData.put(CONNECTOR_CONFIG_KEYS.get(0),null);
  deserializedData.put(TARGET_STATE_KEYS.get(0),null);
  expectRead(serializedData,deserializedData);
  configUpdateListener.onConnectorConfigRemove(CONNECTOR_IDS.get(0));
  EasyMock.expectLastCall();
  expectStop();
  PowerMock.replayAll();
  configStorage.setupAndCreateKafkaBasedLog(TOPIC,DEFAULT_DISTRIBUTED_CONFIG);
  configStorage.start();
  ClusterConfigState configState=configStorage.snapshot();
  assertEquals(TargetState.STARTED,configState.targetState(CONNECTOR_IDS.get(0)));
  configStorage.refresh(0,TimeUnit.SECONDS);
  configStorage.stop();
  PowerMock.verifyAll();
}
