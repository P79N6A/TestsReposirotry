@Test public void validClientFirstMessage() throws SaslException {
  String nonce=formatter.secureRandomString();
  ClientFirstMessage m=new ClientFirstMessage("someuser",nonce,Collections.emptyMap());
  checkClientFirstMessage(m,"someuser",nonce,"");
  String str=String.format("n,,n=testuser,r=%s",nonce);
  m=createScramMessage(ClientFirstMessage.class,str);
  checkClientFirstMessage(m,"testuser",nonce,"");
  m=new ClientFirstMessage(m.toBytes());
  checkClientFirstMessage(m,"testuser",nonce,"");
  str=String.format("n,,n=test=2Cuser,r=%s",nonce);
  m=createScramMessage(ClientFirstMessage.class,str);
  checkClientFirstMessage(m,"test=2Cuser",nonce,"");
  assertEquals("test,user",formatter.username(m.saslName()));
  str=String.format("n,,n=test=3Duser,r=%s",nonce);
  m=createScramMessage(ClientFirstMessage.class,str);
  checkClientFirstMessage(m,"test=3Duser",nonce,"");
  assertEquals("test=user",formatter.username(m.saslName()));
  str=String.format("n,a=testauthzid,n=testuser,r=%s",nonce);
  checkClientFirstMessage(createScramMessage(ClientFirstMessage.class,str),"testuser",nonce,"testauthzid");
  for (  String reserved : VALID_RESERVED) {
    str=String.format("n,,%s,n=testuser,r=%s",reserved,nonce);
    checkClientFirstMessage(createScramMessage(ClientFirstMessage.class,str),"testuser",nonce,"");
  }
  for (  String extension : VALID_EXTENSIONS) {
    str=String.format("n,,n=testuser,r=%s,%s",nonce,extension);
    checkClientFirstMessage(createScramMessage(ClientFirstMessage.class,str),"testuser",nonce,"");
  }
  str=String.format("n,,n=testuser,r=%s,%s",nonce,"tokenauth=true");
  m=createScramMessage(ClientFirstMessage.class,str);
  assertTrue("Token authentication not set from extensions",m.extensions().tokenAuthenticated());
}
