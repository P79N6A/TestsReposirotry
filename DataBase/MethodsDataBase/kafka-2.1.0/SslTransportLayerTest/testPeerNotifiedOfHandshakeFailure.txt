/** 
 * Tests that handshake failures are propagated only after writes complete, even when there are delays in writes to ensure that clients see an authentication exception rather than a connection failure.
 */
@Test public void testPeerNotifiedOfHandshakeFailure() throws Exception {
  sslServerConfigs=serverCertStores.getUntrustingConfig();
  sslServerConfigs.put(BrokerSecurityConfigs.SSL_CLIENT_AUTH_CONFIG,"required");
  for (int i=0; i < 3; i++) {
    String node="0";
    TestSslChannelBuilder serverChannelBuilder=new TestSslChannelBuilder(Mode.SERVER);
    serverChannelBuilder.configure(sslServerConfigs);
    serverChannelBuilder.flushDelayCount=i;
    server=new NioEchoServer(ListenerName.forSecurityProtocol(SecurityProtocol.SSL),SecurityProtocol.SSL,new TestSecurityConfig(sslServerConfigs),"localhost",serverChannelBuilder,null,time);
    server.start();
    createSelector(sslClientConfigs);
    InetSocketAddress addr=new InetSocketAddress("localhost",server.port());
    selector.connect(node,addr,BUFFER_SIZE,BUFFER_SIZE);
    NetworkTestUtils.waitForChannelClose(selector,node,ChannelState.State.AUTHENTICATION_FAILED);
    server.close();
    selector.close();
  }
}
