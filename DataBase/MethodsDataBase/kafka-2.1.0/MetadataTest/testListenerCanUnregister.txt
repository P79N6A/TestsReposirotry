@Test public void testListenerCanUnregister(){
  long time=0;
  final Set<String> topics=new HashSet<>();
  metadata.update(Cluster.empty(),Collections.<String>emptySet(),time);
  final Metadata.Listener listener=new Metadata.Listener(){
    @Override public void onMetadataUpdate(    Cluster cluster,    Set<String> unavailableTopics){
      topics.clear();
      topics.addAll(cluster.topics());
    }
  }
;
  metadata.addListener(listener);
  metadata.update(new Cluster("cluster",Collections.singletonList(new Node(0,"host1",1000)),Arrays.asList(new PartitionInfo("topic",0,null,null,null),new PartitionInfo("topic1",0,null,null,null)),Collections.<String>emptySet(),Collections.<String>emptySet()),Collections.<String>emptySet(),100);
  metadata.removeListener(listener);
  metadata.update(new Cluster("cluster",Arrays.asList(new Node(0,"host1",1000)),Arrays.asList(new PartitionInfo("topic2",0,null,null,null),new PartitionInfo("topic3",0,null,null,null)),Collections.<String>emptySet(),Collections.<String>emptySet()),Collections.<String>emptySet(),100);
  assertEquals("Listener did not update topics list correctly",new HashSet<>(Arrays.asList("topic","topic1")),topics);
}
