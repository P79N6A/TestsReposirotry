@Test public void testMetadataAwaitAfterClose() throws InterruptedException {
  long time=0;
  metadata.update(Cluster.empty(),Collections.<String>emptySet(),time);
  assertFalse("No update needed.",metadata.timeToNextUpdate(time) == 0);
  metadata.requestUpdate();
  assertFalse("Still no updated needed due to backoff",metadata.timeToNextUpdate(time) == 0);
  time+=refreshBackoffMs;
  assertTrue("Update needed now that backoff time expired",metadata.timeToNextUpdate(time) == 0);
  String topic="my-topic";
  metadata.close();
  Thread t1=asyncFetch(topic,500);
  t1.join();
  assertTrue(backgroundError.get().getClass() == KafkaException.class);
  assertTrue(backgroundError.get().toString().contains("Requested metadata update after close"));
  clearBackgroundError();
}
