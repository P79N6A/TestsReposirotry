@Test public void testTopicExpiry() throws Exception {
  metadata=new Metadata(refreshBackoffMs,metadataExpireMs,true,true,new ClusterResourceListeners());
  long time=0;
  metadata.add("topic1");
  metadata.update(Cluster.empty(),Collections.<String>emptySet(),time);
  time+=Metadata.TOPIC_EXPIRY_MS;
  metadata.update(Cluster.empty(),Collections.<String>emptySet(),time);
  assertFalse("Unused topic not expired",metadata.containsTopic("topic1"));
  metadata.add("topic2");
  metadata.update(Cluster.empty(),Collections.<String>emptySet(),time);
  for (int i=0; i < 3; i++) {
    time+=Metadata.TOPIC_EXPIRY_MS / 2;
    metadata.update(Cluster.empty(),Collections.<String>emptySet(),time);
    assertTrue("Topic expired even though in use",metadata.containsTopic("topic2"));
    metadata.add("topic2");
  }
  HashSet<String> topics=new HashSet<>();
  topics.add("topic4");
  metadata.setTopics(topics);
  metadata.update(Cluster.empty(),Collections.<String>emptySet(),time);
  time+=Metadata.TOPIC_EXPIRY_MS;
  metadata.update(Cluster.empty(),Collections.<String>emptySet(),time);
  assertFalse("Unused topic not expired",metadata.containsTopic("topic4"));
}
