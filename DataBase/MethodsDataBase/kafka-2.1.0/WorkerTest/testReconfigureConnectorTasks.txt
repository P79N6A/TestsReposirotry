@Test public void testReconfigureConnectorTasks() throws Exception {
  expectConverters();
  expectStartStorage();
  EasyMock.expect(plugins.currentThreadLoader()).andReturn(delegatingLoader).times(3);
  EasyMock.expect(plugins.newConnector(WorkerTestConnector.class.getName())).andReturn(connector);
  EasyMock.expect(connector.version()).andReturn("1.0");
  Map<String,String> props=new HashMap<>();
  props.put(SinkConnectorConfig.TOPICS_CONFIG,"foo,bar");
  props.put(ConnectorConfig.TASKS_MAX_CONFIG,"1");
  props.put(ConnectorConfig.NAME_CONFIG,CONNECTOR_ID);
  props.put(ConnectorConfig.CONNECTOR_CLASS_CONFIG,WorkerTestConnector.class.getName());
  EasyMock.expect(connector.version()).andReturn("1.0");
  EasyMock.expect(plugins.compareAndSwapLoaders(connector)).andReturn(delegatingLoader).times(3);
  connector.initialize(anyObject(ConnectorContext.class));
  EasyMock.expectLastCall();
  connector.start(props);
  EasyMock.expectLastCall();
  EasyMock.expect(Plugins.compareAndSwapLoaders(delegatingLoader)).andReturn(pluginLoader).times(3);
  connectorStatusListener.onStartup(CONNECTOR_ID);
  EasyMock.expectLastCall();
  EasyMock.<Class<? extends Task>>expect(connector.taskClass()).andReturn(TestSourceTask.class);
  Map<String,String> taskProps=new HashMap<>();
  taskProps.put("foo","bar");
  EasyMock.expect(connector.taskConfigs(2)).andReturn(Arrays.asList(taskProps,taskProps));
  connector.stop();
  EasyMock.expectLastCall();
  connectorStatusListener.onShutdown(CONNECTOR_ID);
  EasyMock.expectLastCall();
  expectStopStorage();
  PowerMock.replayAll();
  worker=new Worker(WORKER_ID,new MockTime(),plugins,config,offsetBackingStore);
  worker.start();
  assertStatistics(worker,0,0);
  assertEquals(Collections.emptySet(),worker.connectorNames());
  worker.startConnector(CONNECTOR_ID,props,ctx,connectorStatusListener,TargetState.STARTED);
  assertStatistics(worker,1,0);
  assertEquals(new HashSet<>(Arrays.asList(CONNECTOR_ID)),worker.connectorNames());
  try {
    worker.startConnector(CONNECTOR_ID,props,ctx,connectorStatusListener,TargetState.STARTED);
    fail("Should have thrown exception when trying to add connector with same name.");
  }
 catch (  ConnectException e) {
  }
  Map<String,String> connProps=new HashMap<>(props);
  connProps.put(ConnectorConfig.TASKS_MAX_CONFIG,"2");
  ConnectorConfig connConfig=new SinkConnectorConfig(plugins,connProps);
  List<Map<String,String>> taskConfigs=worker.connectorTaskConfigs(CONNECTOR_ID,connConfig);
  Map<String,String> expectedTaskProps=new HashMap<>();
  expectedTaskProps.put("foo","bar");
  expectedTaskProps.put(TaskConfig.TASK_CLASS_CONFIG,TestSourceTask.class.getName());
  expectedTaskProps.put(SinkTask.TOPICS_CONFIG,"foo,bar");
  assertEquals(2,taskConfigs.size());
  assertEquals(expectedTaskProps,taskConfigs.get(0));
  assertEquals(expectedTaskProps,taskConfigs.get(1));
  assertStatistics(worker,1,0);
  assertStartupStatistics(worker,1,0,0,0);
  worker.stopConnector(CONNECTOR_ID);
  assertStatistics(worker,0,0);
  assertStartupStatistics(worker,1,0,0,0);
  assertEquals(Collections.emptySet(),worker.connectorNames());
  worker.stop();
  assertStatistics(worker,0,0);
  PowerMock.verifyAll();
}
