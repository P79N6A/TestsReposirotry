@Test public void testStartAndStopConnector() throws Exception {
  expectConverters();
  expectStartStorage();
  EasyMock.expect(plugins.currentThreadLoader()).andReturn(delegatingLoader).times(2);
  EasyMock.expect(plugins.newConnector(WorkerTestConnector.class.getName())).andReturn(connector);
  EasyMock.expect(connector.version()).andReturn("1.0");
  Map<String,String> props=new HashMap<>();
  props.put(SinkConnectorConfig.TOPICS_CONFIG,"foo,bar");
  props.put(ConnectorConfig.TASKS_MAX_CONFIG,"1");
  props.put(ConnectorConfig.NAME_CONFIG,CONNECTOR_ID);
  props.put(ConnectorConfig.CONNECTOR_CLASS_CONFIG,WorkerTestConnector.class.getName());
  EasyMock.expect(connector.version()).andReturn("1.0");
  EasyMock.expect(plugins.compareAndSwapLoaders(connector)).andReturn(delegatingLoader).times(2);
  connector.initialize(anyObject(ConnectorContext.class));
  EasyMock.expectLastCall();
  connector.start(props);
  EasyMock.expectLastCall();
  EasyMock.expect(Plugins.compareAndSwapLoaders(delegatingLoader)).andReturn(pluginLoader).times(2);
  connectorStatusListener.onStartup(CONNECTOR_ID);
  EasyMock.expectLastCall();
  connector.stop();
  EasyMock.expectLastCall();
  connectorStatusListener.onShutdown(CONNECTOR_ID);
  EasyMock.expectLastCall();
  expectStopStorage();
  PowerMock.replayAll();
  worker=new Worker(WORKER_ID,new MockTime(),plugins,config,offsetBackingStore);
  worker.start();
  assertEquals(Collections.emptySet(),worker.connectorNames());
  worker.startConnector(CONNECTOR_ID,props,ctx,connectorStatusListener,TargetState.STARTED);
  assertEquals(new HashSet<>(Arrays.asList(CONNECTOR_ID)),worker.connectorNames());
  try {
    worker.startConnector(CONNECTOR_ID,props,ctx,connectorStatusListener,TargetState.STARTED);
    fail("Should have thrown exception when trying to add connector with same name.");
  }
 catch (  ConnectException e) {
  }
  assertStatistics(worker,1,0);
  assertStartupStatistics(worker,1,0,0,0);
  worker.stopConnector(CONNECTOR_ID);
  assertStatistics(worker,0,0);
  assertStartupStatistics(worker,1,0,0,0);
  assertEquals(Collections.emptySet(),worker.connectorNames());
  worker.stop();
  assertStatistics(worker,0,0);
  PowerMock.verifyAll();
}
