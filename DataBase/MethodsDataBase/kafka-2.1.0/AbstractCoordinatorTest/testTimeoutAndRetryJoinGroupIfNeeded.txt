@Test public void testTimeoutAndRetryJoinGroupIfNeeded() throws Exception {
  setupCoordinator();
  mockClient.prepareResponse(groupCoordinatorResponse(node,Errors.NONE));
  coordinator.ensureCoordinatorReady(mockTime.timer(0));
  ExecutorService executor=Executors.newFixedThreadPool(1);
  try {
    Timer firstAttemptTimer=mockTime.timer(REQUEST_TIMEOUT_MS);
    Future<Boolean> firstAttempt=executor.submit(() -> coordinator.joinGroupIfNeeded(firstAttemptTimer));
    mockTime.sleep(REQUEST_TIMEOUT_MS);
    assertFalse(firstAttempt.get());
    assertTrue(consumerClient.hasPendingRequests(coordinatorNode));
    mockClient.respond(joinGroupFollowerResponse(1,"memberId","leaderId",Errors.NONE));
    mockClient.prepareResponse(syncGroupResponse(Errors.NONE));
    Timer secondAttemptTimer=mockTime.timer(REQUEST_TIMEOUT_MS);
    Future<Boolean> secondAttempt=executor.submit(() -> coordinator.joinGroupIfNeeded(secondAttemptTimer));
    assertTrue(secondAttempt.get());
  }
  finally {
    executor.shutdownNow();
    executor.awaitTermination(1000,TimeUnit.MILLISECONDS);
  }
}
