@Test public void testWakeupAfterJoinGroupSent() throws Exception {
  setupCoordinator();
  mockClient.prepareResponse(groupCoordinatorResponse(node,Errors.NONE));
  mockClient.prepareResponse(new MockClient.RequestMatcher(){
    private int invocations=0;
    @Override public boolean matches(    AbstractRequest body){
      invocations++;
      boolean isJoinGroupRequest=body instanceof JoinGroupRequest;
      if (isJoinGroupRequest && invocations == 1)       throw new WakeupException();
      return isJoinGroupRequest;
    }
  }
,joinGroupFollowerResponse(1,"memberId","leaderId",Errors.NONE));
  mockClient.prepareResponse(syncGroupResponse(Errors.NONE));
  AtomicBoolean heartbeatReceived=prepareFirstHeartbeat();
  try {
    coordinator.ensureActiveGroup();
    fail("Should have woken up from ensureActiveGroup()");
  }
 catch (  WakeupException e) {
  }
  assertEquals(1,coordinator.onJoinPrepareInvokes);
  assertEquals(0,coordinator.onJoinCompleteInvokes);
  assertFalse(heartbeatReceived.get());
  coordinator.ensureActiveGroup();
  assertEquals(1,coordinator.onJoinPrepareInvokes);
  assertEquals(1,coordinator.onJoinCompleteInvokes);
  awaitFirstHeartbeat(heartbeatReceived);
}
