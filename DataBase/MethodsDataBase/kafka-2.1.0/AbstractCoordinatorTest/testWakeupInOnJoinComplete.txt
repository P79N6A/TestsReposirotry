@Test public void testWakeupInOnJoinComplete() throws Exception {
  setupCoordinator();
  coordinator.wakeupOnJoinComplete=true;
  mockClient.prepareResponse(groupCoordinatorResponse(node,Errors.NONE));
  mockClient.prepareResponse(joinGroupFollowerResponse(1,"memberId","leaderId",Errors.NONE));
  mockClient.prepareResponse(syncGroupResponse(Errors.NONE));
  AtomicBoolean heartbeatReceived=prepareFirstHeartbeat();
  try {
    coordinator.ensureActiveGroup();
    fail("Should have woken up from ensureActiveGroup()");
  }
 catch (  WakeupException e) {
  }
  assertEquals(1,coordinator.onJoinPrepareInvokes);
  assertEquals(0,coordinator.onJoinCompleteInvokes);
  assertFalse(heartbeatReceived.get());
  coordinator.wakeupOnJoinComplete=false;
  consumerClient.poll(mockTime.timer(0));
  coordinator.ensureActiveGroup();
  assertEquals(1,coordinator.onJoinPrepareInvokes);
  assertEquals(1,coordinator.onJoinCompleteInvokes);
  awaitFirstHeartbeat(heartbeatReceived);
}
