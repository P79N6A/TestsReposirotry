@Test public void shouldPublishConsumerGroupOffsetsOnlyAfterCommitIfTransactionsAreEnabled(){
  buildMockProducer(true);
  producer.initTransactions();
  producer.beginTransaction();
  String group1="g1";
  Map<TopicPartition,OffsetAndMetadata> group1Commit=new HashMap<TopicPartition,OffsetAndMetadata>(){
{
      put(new TopicPartition(topic,0),new OffsetAndMetadata(42L,null));
      put(new TopicPartition(topic,1),new OffsetAndMetadata(73L,null));
    }
  }
;
  String group2="g2";
  Map<TopicPartition,OffsetAndMetadata> group2Commit=new HashMap<TopicPartition,OffsetAndMetadata>(){
{
      put(new TopicPartition(topic,0),new OffsetAndMetadata(101L,null));
      put(new TopicPartition(topic,1),new OffsetAndMetadata(21L,null));
    }
  }
;
  producer.sendOffsetsToTransaction(group1Commit,group1);
  producer.sendOffsetsToTransaction(group2Commit,group2);
  assertTrue(producer.consumerGroupOffsetsHistory().isEmpty());
  Map<String,Map<TopicPartition,OffsetAndMetadata>> expectedResult=new HashMap<>();
  expectedResult.put(group1,group1Commit);
  expectedResult.put(group2,group2Commit);
  producer.commitTransaction();
  assertThat(producer.consumerGroupOffsetsHistory(),equalTo(Collections.singletonList(expectedResult)));
}
