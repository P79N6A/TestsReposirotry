@Test public void shouldPreserveCommittedConsumerGroupsOffsetsOnAbortIfTransactionsAreEnabled(){
  buildMockProducer(true);
  producer.initTransactions();
  producer.beginTransaction();
  String group="g";
  Map<TopicPartition,OffsetAndMetadata> groupCommit=new HashMap<TopicPartition,OffsetAndMetadata>(){
{
      put(new TopicPartition(topic,0),new OffsetAndMetadata(42L,null));
      put(new TopicPartition(topic,1),new OffsetAndMetadata(73L,null));
    }
  }
;
  producer.sendOffsetsToTransaction(groupCommit,group);
  producer.commitTransaction();
  producer.beginTransaction();
  producer.abortTransaction();
  Map<String,Map<TopicPartition,OffsetAndMetadata>> expectedResult=new HashMap<>();
  expectedResult.put(group,groupCommit);
  assertThat(producer.consumerGroupOffsetsHistory(),equalTo(Collections.singletonList(expectedResult)));
}
