@SuppressWarnings("unchecked") @Test public void shouldPunctuateOnceStreamTimeAfterGap(){
  task=createStatelessTask(createConfig(false));
  task.initializeStateStores();
  task.initializeTopology();
  task.addRecords(partition1,Arrays.asList(getConsumerRecord(partition1,20),getConsumerRecord(partition1,142),getConsumerRecord(partition1,155),getConsumerRecord(partition1,160)));
  task.addRecords(partition2,Arrays.asList(getConsumerRecord(partition2,25),getConsumerRecord(partition2,145),getConsumerRecord(partition2,159),getConsumerRecord(partition2,161)));
  assertFalse(task.maybePunctuateStreamTime());
  assertTrue(task.process());
  assertEquals(7,task.numBuffered());
  assertEquals(1,source1.numReceived);
  assertEquals(0,source2.numReceived);
  assertTrue(task.maybePunctuateStreamTime());
  assertTrue(task.process());
  assertEquals(6,task.numBuffered());
  assertEquals(1,source1.numReceived);
  assertEquals(1,source2.numReceived);
  assertFalse(task.maybePunctuateStreamTime());
  assertTrue(task.process());
  assertEquals(5,task.numBuffered());
  assertEquals(2,source1.numReceived);
  assertEquals(1,source2.numReceived);
  assertTrue(task.maybePunctuateStreamTime());
  assertTrue(task.process());
  assertEquals(4,task.numBuffered());
  assertEquals(2,source1.numReceived);
  assertEquals(2,source2.numReceived);
  assertFalse(task.maybePunctuateStreamTime());
  assertTrue(task.process());
  assertEquals(3,task.numBuffered());
  assertEquals(3,source1.numReceived);
  assertEquals(2,source2.numReceived);
  assertTrue(task.maybePunctuateStreamTime());
  assertTrue(task.process());
  assertEquals(2,task.numBuffered());
  assertEquals(3,source1.numReceived);
  assertEquals(3,source2.numReceived);
  assertFalse(task.maybePunctuateStreamTime());
  assertTrue(task.process());
  assertEquals(1,task.numBuffered());
  assertEquals(4,source1.numReceived);
  assertEquals(3,source2.numReceived);
  assertTrue(task.maybePunctuateStreamTime());
  assertTrue(task.process());
  assertEquals(0,task.numBuffered());
  assertEquals(4,source1.numReceived);
  assertEquals(4,source2.numReceived);
  assertFalse(task.maybePunctuateStreamTime());
  processorStreamTime.mockProcessor.checkAndClearPunctuateResult(PunctuationType.STREAM_TIME,20L,142L,155L,160L);
}
