/** 
 * Test the handling of SESSIONLESS responses. Pre-KIP-227 brokers always supply this kind of response.
 */
@Test public void testSessionless(){
  FetchSessionHandler handler=new FetchSessionHandler(LOG_CONTEXT,1);
  FetchSessionHandler.Builder builder=handler.newBuilder();
  builder.add(new TopicPartition("foo",0),new FetchRequest.PartitionData(0,100,200,Optional.empty()));
  builder.add(new TopicPartition("foo",1),new FetchRequest.PartitionData(10,110,210,Optional.empty()));
  FetchSessionHandler.FetchRequestData data=builder.build();
  assertMapsEqual(reqMap(new ReqEntry("foo",0,0,100,200),new ReqEntry("foo",1,10,110,210)),data.toSend(),data.sessionPartitions());
  assertEquals(INVALID_SESSION_ID,data.metadata().sessionId());
  assertEquals(INITIAL_EPOCH,data.metadata().epoch());
  FetchResponse<MemoryRecords> resp=new FetchResponse<>(Errors.NONE,respMap(new RespEntry("foo",0,0,0),new RespEntry("foo",1,0,0)),0,INVALID_SESSION_ID);
  handler.handleResponse(resp);
  FetchSessionHandler.Builder builder2=handler.newBuilder();
  builder2.add(new TopicPartition("foo",0),new FetchRequest.PartitionData(0,100,200,Optional.empty()));
  FetchSessionHandler.FetchRequestData data2=builder2.build();
  assertEquals(INVALID_SESSION_ID,data2.metadata().sessionId());
  assertEquals(INITIAL_EPOCH,data2.metadata().epoch());
  assertMapsEqual(reqMap(new ReqEntry("foo",0,0,100,200)),data.toSend(),data.sessionPartitions());
}
