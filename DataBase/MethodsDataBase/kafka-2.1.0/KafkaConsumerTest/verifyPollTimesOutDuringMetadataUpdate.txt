@Test public void verifyPollTimesOutDuringMetadataUpdate() throws Exception {
  final Time time=new MockTime();
  final Cluster cluster=TestUtils.singletonCluster(topic,1);
  final Node node=cluster.nodes().get(0);
  final Metadata metadata=createMetadata();
  metadata.update(cluster,Collections.<String>emptySet(),time.milliseconds());
  final MockClient client=new MockClient(time,metadata);
  client.setNode(node);
  final PartitionAssignor assignor=new RoundRobinAssignor();
  final KafkaConsumer<String,String> consumer=newConsumer(time,client,metadata,assignor,true);
  consumer.subscribe(singleton(topic),getConsumerRebalanceListener(consumer));
  prepareRebalance(client,node,assignor,singletonList(tp0),null);
  consumer.poll(Duration.ZERO);
  final Queue<ClientRequest> requests=client.requests();
  Assert.assertEquals(0,requests.size());
}
