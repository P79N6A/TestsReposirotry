@Test public void testPatternJoinGroupLeader(){
  final String consumerId="leader";
  subscriptions.subscribe(Pattern.compile("test.*"),rebalanceListener);
  metadata.setTopics(singletonList(topic1));
  metadata.update(TestUtils.singletonCluster(topic1,1),Collections.<String>emptySet(),time.milliseconds());
  client.prepareResponse(groupCoordinatorResponse(node,Errors.NONE));
  coordinator.ensureCoordinatorReady(time.timer(Long.MAX_VALUE));
  Map<String,List<String>> memberSubscriptions=singletonMap(consumerId,singletonList(topic1));
  partitionAssignor.prepare(singletonMap(consumerId,Arrays.asList(t1p,t2p)));
  client.prepareResponse(joinGroupLeaderResponse(1,consumerId,memberSubscriptions,Errors.NONE));
  client.prepareResponse(new MockClient.RequestMatcher(){
    @Override public boolean matches(    AbstractRequest body){
      SyncGroupRequest sync=(SyncGroupRequest)body;
      return sync.memberId().equals(consumerId) && sync.generationId() == 1 && sync.groupAssignment().containsKey(consumerId);
    }
  }
,syncGroupResponse(Arrays.asList(t1p,t2p),Errors.NONE));
  client.prepareMetadataUpdate(cluster,Collections.<String>emptySet());
  coordinator.poll(time.timer(Long.MAX_VALUE));
  assertFalse(coordinator.rejoinNeededOrPending());
  assertEquals(2,subscriptions.numAssignedPartitions());
  assertEquals(2,subscriptions.groupSubscription().size());
  assertEquals(2,subscriptions.subscription().size());
  assertEquals(1,rebalanceListener.revokedCount);
  assertEquals(Collections.emptySet(),rebalanceListener.revoked);
  assertEquals(1,rebalanceListener.assignedCount);
  assertEquals(2,rebalanceListener.assigned.size());
}
