@Test public void shouldCloseAfterErrorWithFlush(){
  try {
    cache=EasyMock.niceMock(ThreadCache.class);
    context=new InternalMockProcessorContext(null,null,null,(RecordCollector)null,cache);
    context.setRecordContext(new ProcessorRecordContext(10,0,0,topic,null));
    store.init(context,null);
    cache.flush("0_0-store");
    EasyMock.expectLastCall().andThrow(new NullPointerException("Simulating an error on flush"));
    EasyMock.replay(cache);
    store.close();
  }
 catch (  final NullPointerException npe) {
    assertFalse(underlyingStore.isOpen());
  }
}
