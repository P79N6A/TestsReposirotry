@Test public void testCorrectHandlingOfDuplicateSequenceError() throws Exception {
  final long producerId=343434L;
  TransactionManager transactionManager=new TransactionManager();
  setupWithTransactionState(transactionManager);
  prepareAndReceiveInitProducerId(producerId,Errors.NONE);
  assertTrue(transactionManager.hasProducerId());
  assertEquals(0,transactionManager.sequenceNumber(tp0).longValue());
  Future<RecordMetadata> request1=accumulator.append(tp0,time.milliseconds(),"key".getBytes(),"value".getBytes(),null,null,MAX_BLOCK_TIMEOUT).future;
  sender.run(time.milliseconds());
  String nodeId=client.requests().peek().destination();
  Node node=new Node(Integer.valueOf(nodeId),"localhost",0);
  assertEquals(1,client.inFlightRequestCount());
  assertEquals(1,transactionManager.sequenceNumber(tp0).longValue());
  assertEquals(-1,transactionManager.lastAckedSequence(tp0));
  Future<RecordMetadata> request2=accumulator.append(tp0,time.milliseconds(),"key".getBytes(),"value".getBytes(),null,null,MAX_BLOCK_TIMEOUT).future;
  sender.run(time.milliseconds());
  assertEquals(2,client.inFlightRequestCount());
  assertEquals(2,transactionManager.sequenceNumber(tp0).longValue());
  assertEquals(-1,transactionManager.lastAckedSequence(tp0));
  assertFalse(request1.isDone());
  assertFalse(request2.isDone());
  assertTrue(client.isReady(node,time.milliseconds()));
  ClientRequest firstClientRequest=client.requests().peek();
  ClientRequest secondClientRequest=(ClientRequest)client.requests().toArray()[1];
  client.respondToRequest(secondClientRequest,produceResponse(tp0,1000,Errors.NONE,0));
  sender.run(time.milliseconds());
  assertEquals(1000,transactionManager.lastAckedOffset(tp0));
  assertEquals(1,transactionManager.lastAckedSequence(tp0));
  client.respondToRequest(firstClientRequest,produceResponse(tp0,ProduceResponse.INVALID_OFFSET,Errors.DUPLICATE_SEQUENCE_NUMBER,0));
  sender.run(time.milliseconds());
  assertEquals(1,transactionManager.lastAckedSequence(tp0));
  assertEquals(1000,transactionManager.lastAckedOffset(tp0));
  assertFalse(client.hasInFlightRequests());
  RecordMetadata unknownMetadata=request1.get();
  assertFalse(unknownMetadata.hasOffset());
  assertEquals(-1L,unknownMetadata.offset());
}
