@Test public void testExpiredBatchDoesNotRetry() throws Exception {
  long deliverTimeoutMs=1500L;
  setupWithTransactionState(null,false,null);
  Future<RecordMetadata> request1=accumulator.append(tp0,time.milliseconds(),"key".getBytes(),"value".getBytes(),null,null,MAX_BLOCK_TIMEOUT).future;
  sender.run(time.milliseconds());
  assertEquals(1,client.inFlightRequestCount());
  time.sleep(deliverTimeoutMs);
  Map<TopicPartition,ProduceResponse.PartitionResponse> responseMap=new HashMap<>();
  responseMap.put(tp0,new ProduceResponse.PartitionResponse(Errors.NONE,0L,0L,0L));
  client.respond(produceResponse(tp0,-1,Errors.NOT_LEADER_FOR_PARTITION,-1));
  sender.run(time.milliseconds());
  assertTrue(request1.isDone());
  assertEquals(0,client.inFlightRequestCount());
  assertEquals(0,sender.inFlightBatches(tp0).size());
  sender.run(time.milliseconds());
  assertEquals(0,client.inFlightRequestCount());
  assertEquals(0,sender.inFlightBatches(tp0).size());
  sender.run(time.milliseconds());
  assertEquals(0,client.inFlightRequestCount());
  assertEquals(0,sender.inFlightBatches(tp0).size());
}
