@Test public void testResetNextBatchExpiry() throws Exception {
  client=spy(new MockClient(time));
  setupWithTransactionState(null);
  accumulator.append(tp0,0L,"key".getBytes(),"value".getBytes(),null,null,MAX_BLOCK_TIMEOUT);
  sender.run(time.milliseconds());
  sender.run(time.milliseconds());
  time.setCurrentTimeMs(time.milliseconds() + accumulator.getDeliveryTimeoutMs() + 1);
  sender.run(time.milliseconds());
  InOrder inOrder=inOrder(client);
  inOrder.verify(client,atLeastOnce()).ready(any(),anyLong());
  inOrder.verify(client,atLeastOnce()).newClientRequest(anyString(),any(),anyLong(),anyBoolean(),anyInt(),any());
  inOrder.verify(client,atLeastOnce()).send(any(),anyLong());
  inOrder.verify(client).poll(eq(0L),anyLong());
  inOrder.verify(client).poll(eq(accumulator.getDeliveryTimeoutMs()),anyLong());
  inOrder.verify(client).poll(geq(1L),anyLong());
}
