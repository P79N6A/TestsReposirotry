@Test public void testWhenFirstBatchExpireNoSendSecondBatchIfGuaranteeOrder() throws InterruptedException {
  long deliveryTimeoutMs=1500L;
  setupWithTransactionState(null,true,null);
  accumulator.append(tp0,time.milliseconds(),"key".getBytes(),"value".getBytes(),null,null,MAX_BLOCK_TIMEOUT);
  sender.run(time.milliseconds());
  assertEquals(1,client.inFlightRequestCount());
  assertEquals(1,sender.inFlightBatches(tp0).size());
  time.sleep(deliveryTimeoutMs / 2);
  accumulator.append(tp0,time.milliseconds(),"key".getBytes(),"value".getBytes(),null,null,MAX_BLOCK_TIMEOUT);
  sender.run(time.milliseconds());
  assertEquals(1,client.inFlightRequestCount());
  assertEquals(1,sender.inFlightBatches(tp0).size());
  time.sleep(deliveryTimeoutMs / 2);
  client.respond(produceResponse(tp0,0L,Errors.NONE,0,0L));
  sender.run(time.milliseconds());
  assertEquals(0,client.inFlightRequestCount());
  assertEquals(0,sender.inFlightBatches(tp0).size());
  sender.run(time.milliseconds());
  assertEquals(1,client.inFlightRequestCount());
  assertEquals(1,sender.inFlightBatches(tp0).size());
}
