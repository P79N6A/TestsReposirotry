@Test public void testMessageFormatDownConversion() throws Exception {
  long offset=0;
  apiVersions.update("0",NodeApiVersions.create());
  Future<RecordMetadata> future=accumulator.append(tp0,0L,"key".getBytes(),"value".getBytes(),null,null,MAX_BLOCK_TIMEOUT).future;
  apiVersions.update("0",NodeApiVersions.create(Collections.singleton(new ApiVersionsResponse.ApiVersion(ApiKeys.PRODUCE.id,(short)0,(short)2))));
  client.prepareResponse(new MockClient.RequestMatcher(){
    @Override public boolean matches(    AbstractRequest body){
      ProduceRequest request=(ProduceRequest)body;
      if (request.version() != 2)       return false;
      MemoryRecords records=request.partitionRecordsOrFail().get(tp0);
      return records != null && records.sizeInBytes() > 0 && records.hasMatchingMagic(RecordBatch.MAGIC_VALUE_V1);
    }
  }
,produceResponse(tp0,offset,Errors.NONE,0));
  sender.run(time.milliseconds());
  sender.run(time.milliseconds());
  assertTrue("Request should be completed",future.isDone());
  assertEquals(offset,future.get().offset());
}
