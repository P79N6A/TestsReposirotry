@Test public void testNoDoubleDeallocation() throws Exception {
  long deliverTimeoutMs=1500L;
  long totalSize=1024 * 1024;
  String metricGrpName="producer-custom-metrics";
  MatchingBufferPool pool=new MatchingBufferPool(totalSize,batchSize,metrics,time,metricGrpName);
  setupWithTransactionState(null,false,pool);
  Future<RecordMetadata> request1=accumulator.append(tp0,time.milliseconds(),"key".getBytes(),"value".getBytes(),null,null,MAX_BLOCK_TIMEOUT).future;
  sender.run(time.milliseconds());
  assertEquals(1,client.inFlightRequestCount());
  assertEquals(1,sender.inFlightBatches(tp0).size());
  time.sleep(deliverTimeoutMs);
  assertFalse(pool.allMatch());
  sender.run(time.milliseconds());
  assertTrue(request1.isDone());
  assertTrue("The batch should have been de-allocated",pool.allMatch());
  assertTrue(pool.allMatch());
  sender.run(time.milliseconds());
  assertTrue("The batch should have been de-allocated",pool.allMatch());
  assertEquals(0,client.inFlightRequestCount());
  assertEquals(0,sender.inFlightBatches(tp0).size());
}
