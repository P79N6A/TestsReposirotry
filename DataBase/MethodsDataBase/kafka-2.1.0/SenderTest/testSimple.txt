@Test public void testSimple() throws Exception {
  long offset=0;
  Future<RecordMetadata> future=accumulator.append(tp0,0L,"key".getBytes(),"value".getBytes(),null,null,MAX_BLOCK_TIMEOUT).future;
  sender.run(time.milliseconds());
  sender.run(time.milliseconds());
  assertEquals("We should have a single produce request in flight.",1,client.inFlightRequestCount());
  assertEquals(1,sender.inFlightBatches(tp0).size());
  assertTrue(client.hasInFlightRequests());
  client.respond(produceResponse(tp0,offset,Errors.NONE,0));
  sender.run(time.milliseconds());
  assertEquals("All requests completed.",0,client.inFlightRequestCount());
  assertEquals(0,sender.inFlightBatches(tp0).size());
  assertFalse(client.hasInFlightRequests());
  sender.run(time.milliseconds());
  assertTrue("Request should be completed",future.isDone());
  assertEquals(offset,future.get().offset());
}
