@Test public void testPause() throws Exception {
  createTask(initialState);
  expectInitializeTask();
  expectPollInitialAssignment();
  expectConsumerPoll(1);
  expectConversionAndTransformation(1);
  sinkTask.put(EasyMock.<Collection<SinkRecord>>anyObject());
  EasyMock.expectLastCall();
  Set<TopicPartition> partitions=new HashSet<>(asList(TOPIC_PARTITION,TOPIC_PARTITION2));
  statusListener.onPause(taskId);
  EasyMock.expectLastCall();
  expectConsumerWakeup();
  EasyMock.expect(consumer.assignment()).andReturn(partitions);
  consumer.pause(partitions);
  PowerMock.expectLastCall();
  sinkTask.preCommit(EasyMock.<Map<TopicPartition,OffsetAndMetadata>>anyObject());
  EasyMock.expectLastCall().andStubReturn(Collections.emptyMap());
  expectConsumerPoll(0);
  sinkTask.put(Collections.<SinkRecord>emptyList());
  EasyMock.expectLastCall();
  statusListener.onResume(taskId);
  EasyMock.expectLastCall();
  expectConsumerWakeup();
  EasyMock.expect(consumer.assignment()).andReturn(new HashSet<>(asList(TOPIC_PARTITION,TOPIC_PARTITION2)));
  consumer.resume(singleton(TOPIC_PARTITION));
  PowerMock.expectLastCall();
  consumer.resume(singleton(TOPIC_PARTITION2));
  PowerMock.expectLastCall();
  expectConsumerPoll(1);
  expectConversionAndTransformation(1);
  sinkTask.put(EasyMock.<Collection<SinkRecord>>anyObject());
  EasyMock.expectLastCall();
  PowerMock.replayAll();
  workerTask.initialize(TASK_CONFIG);
  workerTask.initializeAndStart();
  workerTask.iteration();
  workerTask.iteration();
  workerTask.transitionTo(TargetState.PAUSED);
  time.sleep(10000L);
  assertSinkMetricValue("partition-count",2);
  assertSinkMetricValue("sink-record-read-total",1.0);
  assertSinkMetricValue("sink-record-send-total",1.0);
  assertSinkMetricValue("sink-record-active-count",1.0);
  assertSinkMetricValue("sink-record-active-count-max",1.0);
  assertSinkMetricValue("sink-record-active-count-avg",0.333333);
  assertSinkMetricValue("offset-commit-seq-no",0.0);
  assertSinkMetricValue("offset-commit-completion-rate",0.0);
  assertSinkMetricValue("offset-commit-completion-total",0.0);
  assertSinkMetricValue("offset-commit-skip-rate",0.0);
  assertSinkMetricValue("offset-commit-skip-total",0.0);
  assertTaskMetricValue("status","running");
  assertTaskMetricValue("running-ratio",1.0);
  assertTaskMetricValue("pause-ratio",0.0);
  assertTaskMetricValue("batch-size-max",1.0);
  assertTaskMetricValue("batch-size-avg",0.5);
  assertTaskMetricValue("offset-commit-max-time-ms",Double.NEGATIVE_INFINITY);
  assertTaskMetricValue("offset-commit-failure-percentage",0.0);
  assertTaskMetricValue("offset-commit-success-percentage",0.0);
  workerTask.iteration();
  workerTask.iteration();
  time.sleep(30000L);
  assertSinkMetricValue("offset-commit-seq-no",1.0);
  assertSinkMetricValue("offset-commit-completion-rate",0.0333);
  assertSinkMetricValue("offset-commit-completion-total",1.0);
  assertSinkMetricValue("offset-commit-skip-rate",0.0);
  assertSinkMetricValue("offset-commit-skip-total",0.0);
  assertTaskMetricValue("status","paused");
  assertTaskMetricValue("running-ratio",0.25);
  assertTaskMetricValue("pause-ratio",0.75);
  workerTask.transitionTo(TargetState.STARTED);
  workerTask.iteration();
  workerTask.iteration();
  PowerMock.verifyAll();
}
