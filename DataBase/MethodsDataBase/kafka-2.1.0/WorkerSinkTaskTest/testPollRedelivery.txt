@Test public void testPollRedelivery() throws Exception {
  createTask(initialState);
  expectInitializeTask();
  expectPollInitialAssignment();
  expectConsumerPoll(1);
  expectConversionAndTransformation(1);
  Capture<Collection<SinkRecord>> records=EasyMock.newCapture(CaptureType.ALL);
  sinkTask.put(EasyMock.capture(records));
  EasyMock.expectLastCall().andThrow(new RetriableException("retry"));
  HashSet<TopicPartition> partitions=new HashSet<>(asList(TOPIC_PARTITION,TOPIC_PARTITION2));
  EasyMock.expect(consumer.assignment()).andReturn(partitions);
  consumer.pause(partitions);
  PowerMock.expectLastCall();
  expectConsumerPoll(0);
  sinkTask.put(EasyMock.capture(records));
  EasyMock.expectLastCall();
  EasyMock.expect(consumer.assignment()).andReturn(partitions);
  consumer.resume(singleton(TOPIC_PARTITION));
  PowerMock.expectLastCall();
  consumer.resume(singleton(TOPIC_PARTITION2));
  PowerMock.expectLastCall();
  PowerMock.replayAll();
  workerTask.initialize(TASK_CONFIG);
  workerTask.initializeAndStart();
  workerTask.iteration();
  time.sleep(10000L);
  assertSinkMetricValue("partition-count",2);
  assertSinkMetricValue("sink-record-read-total",0.0);
  assertSinkMetricValue("sink-record-send-total",0.0);
  assertSinkMetricValue("sink-record-active-count",0.0);
  assertSinkMetricValue("sink-record-active-count-max",0.0);
  assertSinkMetricValue("sink-record-active-count-avg",0.0);
  assertSinkMetricValue("offset-commit-seq-no",0.0);
  assertSinkMetricValue("offset-commit-completion-rate",0.0);
  assertSinkMetricValue("offset-commit-completion-total",0.0);
  assertSinkMetricValue("offset-commit-skip-rate",0.0);
  assertSinkMetricValue("offset-commit-skip-total",0.0);
  assertTaskMetricValue("status","running");
  assertTaskMetricValue("running-ratio",1.0);
  assertTaskMetricValue("pause-ratio",0.0);
  assertTaskMetricValue("batch-size-max",0.0);
  assertTaskMetricValue("batch-size-avg",0.0);
  assertTaskMetricValue("offset-commit-max-time-ms",Double.NEGATIVE_INFINITY);
  assertTaskMetricValue("offset-commit-failure-percentage",0.0);
  assertTaskMetricValue("offset-commit-success-percentage",0.0);
  workerTask.iteration();
  workerTask.iteration();
  time.sleep(30000L);
  assertSinkMetricValue("sink-record-read-total",1.0);
  assertSinkMetricValue("sink-record-send-total",1.0);
  assertSinkMetricValue("sink-record-active-count",1.0);
  assertSinkMetricValue("sink-record-active-count-max",1.0);
  assertSinkMetricValue("sink-record-active-count-avg",0.5);
  assertTaskMetricValue("status","running");
  assertTaskMetricValue("running-ratio",1.0);
  assertTaskMetricValue("batch-size-max",1.0);
  assertTaskMetricValue("batch-size-avg",0.5);
  PowerMock.verifyAll();
}
