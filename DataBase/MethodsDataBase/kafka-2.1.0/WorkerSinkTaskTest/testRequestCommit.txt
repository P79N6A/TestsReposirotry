@Test public void testRequestCommit() throws Exception {
  createTask(initialState);
  expectInitializeTask();
  expectPollInitialAssignment();
  expectConsumerPoll(1);
  expectConversionAndTransformation(1);
  sinkTask.put(EasyMock.<Collection<SinkRecord>>anyObject());
  EasyMock.expectLastCall();
  final Map<TopicPartition,OffsetAndMetadata> offsets=new HashMap<>();
  offsets.put(TOPIC_PARTITION,new OffsetAndMetadata(FIRST_OFFSET + 1));
  offsets.put(TOPIC_PARTITION2,new OffsetAndMetadata(FIRST_OFFSET));
  sinkTask.preCommit(offsets);
  EasyMock.expectLastCall().andReturn(offsets);
  final Capture<OffsetCommitCallback> callback=EasyMock.newCapture();
  consumer.commitAsync(EasyMock.eq(offsets),EasyMock.capture(callback));
  EasyMock.expectLastCall().andAnswer(new IAnswer<Void>(){
    @Override public Void answer() throws Throwable {
      callback.getValue().onComplete(offsets,null);
      return null;
    }
  }
);
  expectConsumerPoll(0);
  sinkTask.put(Collections.<SinkRecord>emptyList());
  EasyMock.expectLastCall();
  PowerMock.replayAll();
  workerTask.initialize(TASK_CONFIG);
  workerTask.initializeAndStart();
  time.sleep(30000L);
  workerTask.iteration();
  assertSinkMetricValue("partition-count",2);
  workerTask.iteration();
  assertSinkMetricValue("partition-count",2);
  assertSinkMetricValue("sink-record-read-total",1.0);
  assertSinkMetricValue("sink-record-send-total",1.0);
  assertSinkMetricValue("sink-record-active-count",1.0);
  assertSinkMetricValue("sink-record-active-count-max",1.0);
  assertSinkMetricValue("sink-record-active-count-avg",0.333333);
  assertSinkMetricValue("offset-commit-seq-no",0.0);
  assertSinkMetricValue("offset-commit-completion-total",0.0);
  assertSinkMetricValue("offset-commit-skip-total",0.0);
  assertTaskMetricValue("status","running");
  assertTaskMetricValue("running-ratio",1.0);
  assertTaskMetricValue("pause-ratio",0.0);
  assertTaskMetricValue("batch-size-max",1.0);
  assertTaskMetricValue("batch-size-avg",0.5);
  assertTaskMetricValue("offset-commit-failure-percentage",0.0);
  assertTaskMetricValue("offset-commit-success-percentage",0.0);
  sinkTaskContext.getValue().requestCommit();
  assertTrue(sinkTaskContext.getValue().isCommitRequested());
  assertNotEquals(offsets,Whitebox.<Map<TopicPartition,OffsetAndMetadata>>getInternalState(workerTask,"lastCommittedOffsets"));
  time.sleep(10000L);
  workerTask.iteration();
  time.sleep(10000L);
  assertFalse(sinkTaskContext.getValue().isCommitRequested());
  assertEquals(offsets,Whitebox.<Map<TopicPartition,OffsetAndMetadata>>getInternalState(workerTask,"lastCommittedOffsets"));
  assertEquals(0,workerTask.commitFailures());
  assertSinkMetricValue("partition-count",2);
  assertSinkMetricValue("sink-record-read-total",1.0);
  assertSinkMetricValue("sink-record-send-total",1.0);
  assertSinkMetricValue("sink-record-active-count",0.0);
  assertSinkMetricValue("sink-record-active-count-max",1.0);
  assertSinkMetricValue("sink-record-active-count-avg",0.2);
  assertSinkMetricValue("offset-commit-seq-no",1.0);
  assertSinkMetricValue("offset-commit-completion-total",1.0);
  assertSinkMetricValue("offset-commit-skip-total",0.0);
  assertTaskMetricValue("status","running");
  assertTaskMetricValue("running-ratio",1.0);
  assertTaskMetricValue("pause-ratio",0.0);
  assertTaskMetricValue("batch-size-max",1.0);
  assertTaskMetricValue("batch-size-avg",0.33333);
  assertTaskMetricValue("offset-commit-max-time-ms",0.0);
  assertTaskMetricValue("offset-commit-avg-time-ms",0.0);
  assertTaskMetricValue("offset-commit-failure-percentage",0.0);
  assertTaskMetricValue("offset-commit-success-percentage",1.0);
  PowerMock.verifyAll();
}
