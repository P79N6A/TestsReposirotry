/** 
 * Tests that  {@link HdfsUtils#setFullFileStatus(Configuration,HdfsUtils.HadoopFileStatus,FileSystem,Path,boolean)}does not thrown an exception when setting ACLs and with recursion.
 */
@Test public void testSetFullFileStatusFailInheritAclsRecursive() throws Exception {
  Configuration conf=new Configuration();
  conf.set("dfs.namenode.acls.enabled","true");
  Path fakeTarget=new Path("fakePath");
  HdfsUtils.HadoopFileStatus mockHadoopFileStatus=mock(HdfsUtils.HadoopFileStatus.class);
  FileStatus mockSourceStatus=mock(FileStatus.class);
  FsShell mockFsShell=mock(FsShell.class);
  AclStatus mockAclStatus=mock(AclStatus.class);
  when(mockSourceStatus.getPermission()).thenReturn(new FsPermission((short)777));
  when(mockAclStatus.toString()).thenReturn("");
  when(mockHadoopFileStatus.getFileStatus()).thenReturn(mockSourceStatus);
  when(mockHadoopFileStatus.getAclEntries()).thenReturn(new ArrayList<AclEntry>());
  when(mockHadoopFileStatus.getAclStatus()).thenReturn(mockAclStatus);
  doThrow(RuntimeException.class).when(mockFsShell).run(any(String[].class));
  HdfsUtils.setFullFileStatus(conf,mockHadoopFileStatus,"",mock(FileSystem.class),fakeTarget,true,mockFsShell);
  verify(mockFsShell).run(new String[]{"-setfacl","-R","--set",any(String.class),fakeTarget.toString()});
}
