/** 
 * Tests the creation of the 3 scratch dirs: hdfs, local, downloaded resources (which is also local). 1. Test with doAs=false: open a new JDBC session and verify the presence of directories/permissions 2. Test with doAs=true: open a new JDBC session and verify the presence of directories/permissions
 * @throws Exception
 */
@Test public void testSessionScratchDirs() throws Exception {
  stopMiniHS2();
  HiveConf conf=new HiveConf();
  String userName;
  Path scratchDirPath;
  conf.set("hive.exec.scratchdir",tmpDir + "/hs2");
  String fsPermissionStr="700";
  conf.set("hive.scratch.dir.permission",fsPermissionStr);
  startMiniHS2(conf);
  String sessionConf="hive.server2.enable.doAs=false";
  userName=System.getProperty("user.name");
  Connection conn=getConnection(miniHS2.getJdbcURL(testDbName,sessionConf),userName,"password");
  FileSystem fs=miniHS2.getLocalFS();
  FsPermission expectedFSPermission=new FsPermission(HiveConf.getVar(conf,HiveConf.ConfVars.SCRATCHDIRPERMISSION));
  scratchDirPath=new Path(HiveConf.getVar(conf,HiveConf.ConfVars.SCRATCHDIR) + "/" + userName);
  verifyScratchDir(conf,fs,scratchDirPath,expectedFSPermission,userName,false);
  scratchDirPath=new Path(HiveConf.getVar(conf,HiveConf.ConfVars.LOCALSCRATCHDIR));
  verifyScratchDir(conf,fs,scratchDirPath,expectedFSPermission,userName,true);
  scratchDirPath=new Path(HiveConf.getVar(conf,HiveConf.ConfVars.DOWNLOADED_RESOURCES_DIR));
  verifyScratchDir(conf,fs,scratchDirPath,expectedFSPermission,userName,true);
  conn.close();
  sessionConf="hive.server2.enable.doAs=true";
  userName="neo";
  conn=getConnection(miniHS2.getJdbcURL(testDbName,sessionConf),userName,"the-one");
  scratchDirPath=new Path(HiveConf.getVar(conf,HiveConf.ConfVars.SCRATCHDIR) + "/" + userName);
  verifyScratchDir(conf,fs,scratchDirPath,expectedFSPermission,userName,false);
  scratchDirPath=new Path(HiveConf.getVar(conf,HiveConf.ConfVars.LOCALSCRATCHDIR));
  verifyScratchDir(conf,fs,scratchDirPath,expectedFSPermission,userName,true);
  scratchDirPath=new Path(HiveConf.getVar(conf,HiveConf.ConfVars.DOWNLOADED_RESOURCES_DIR));
  verifyScratchDir(conf,fs,scratchDirPath,expectedFSPermission,userName,true);
  conn.close();
  restoreMiniHS2AndConnections();
}
