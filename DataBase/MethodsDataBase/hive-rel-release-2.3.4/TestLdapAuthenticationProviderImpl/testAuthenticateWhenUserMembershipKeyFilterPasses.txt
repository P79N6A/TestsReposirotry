@Test public void testAuthenticateWhenUserMembershipKeyFilterPasses() throws NamingException, AuthenticationException, IOException {
  conf.setVar(HiveConf.ConfVars.HIVE_SERVER2_PLAIN_LDAP_GROUPFILTER,"HIVE-USERS");
  conf.setVar(HiveConf.ConfVars.HIVE_SERVER2_PLAIN_LDAP_BASEDN,"dc=mycorp,dc=com");
  conf.setVar(HiveConf.ConfVars.HIVE_SERVER2_PLAIN_LDAP_USERMEMBERSHIP_KEY,"memberOf");
  when(search.findUserDn("user1")).thenReturn("cn=user1,ou=PowerUsers,dc=mycorp,dc=com");
  String groupDn="cn=HIVE-USERS,ou=Groups,dc=mycorp,dc=com";
  when(search.findGroupDn("HIVE-USERS")).thenReturn(groupDn);
  when(search.isUserMemberOfGroup("user1",groupDn)).thenReturn(true);
  auth=new LdapAuthenticationProviderImpl(conf,factory);
  auth.Authenticate("user1","Blah");
  verify(factory,times(1)).getInstance(isA(HiveConf.class),anyString(),eq("Blah"));
  verify(search,times(1)).findGroupDn(anyString());
  verify(search,times(1)).isUserMemberOfGroup(anyString(),anyString());
  verify(search,atLeastOnce()).close();
}
