/** 
 * https://www.linkedin.com/pulse/how-load-slowly-changing-dimension-type-2-using-oracle-padhy Same as testMergeType2SCD01 but with a more intuitive "source" expression
 */
@Test public void testMergeType2SCD02() throws Exception {
  runStatementOnDriver("drop table if exists target");
  runStatementOnDriver("drop table if exists source");
  runStatementOnDriver("create table source (key int, data int)");
  runStatementOnDriver("create table target (key int, data int, cur int) clustered by (key) into " + BUCKET_COUNT + " buckets stored as orc TBLPROPERTIES ('transactional'='true')");
  int[][] targetVals={{1,5,1},{2,6,1},{1,18,0}};
  runStatementOnDriver("insert into target " + makeValuesClause(targetVals));
  int[][] sourceVals={{1,7},{3,8}};
  runStatementOnDriver("insert into source " + makeValuesClause(sourceVals));
  String baseSrc="select source.*, 0 c from source " + "union all " + "select source.*, 1 c from source "+ "inner join target "+ "on source.key=target.key where target.cur=1";
  if (false) {
    List<String> r1=runStatementOnDriver(baseSrc);
    List<String> r2=runStatementOnDriver("select t.*, s.* from target t right outer join (" + baseSrc + ") s "+ "\non t.key=s.key and t.cur=s.c and t.cur=1");
  }
  String stmt="merge into target t using " + "(" + baseSrc + ") s "+ "on t.key=s.key and t.cur=s.c and t.cur=1 "+ "when matched then update set cur=0 "+ "when not matched then insert values(s.key,s.data,1)";
  runStatementOnDriver(stmt);
  int[][] resultVals={{1,5,0},{1,7,1},{1,18,0},{2,6,1},{3,8,1}};
  List<String> r=runStatementOnDriver("select * from target order by key,data,cur");
  Assert.assertEquals(stringifyValues(resultVals),r);
}
