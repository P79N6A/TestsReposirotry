/** 
 * txns overlap and update the same resource - can't commit 2nd txn
 */
@Test public void testWriteSetTracking3() throws Exception {
  dropTable(new String[]{"TAB_PART"});
  CommandProcessorResponse cpr=driver.run("create table if not exists TAB_PART (a int, b int) " + "partitioned by (p string) clustered by (a) into 2  buckets stored as orc TBLPROPERTIES ('transactional'='true')");
  checkCmdOnDriver(cpr);
  checkCmdOnDriver(driver.run("insert into TAB_PART partition(p='blah') values(1,2)"));
  HiveTxnManager txnMgr2=TxnManagerFactory.getTxnManagerFactory().getTxnManager(conf);
  long txnId=txnMgr.openTxn(ctx,"Known");
  long txnId2=txnMgr2.openTxn(ctx,"Unknown");
  checkCmdOnDriver(driver.compileAndRespond("update TAB_PART set b = 7 where p = 'blah'"));
  txnMgr.acquireLocks(driver.getPlan(),ctx,"Known");
  List<ShowLocksResponseElement> locks=getLocks(txnMgr);
  Assert.assertEquals("Unexpected lock count",1,locks.size());
  checkLock(LockType.SHARED_WRITE,LockState.ACQUIRED,"default","TAB_PART","p=blah",locks);
  checkCmdOnDriver(driver.compileAndRespond("update TAB_PART set b = 7 where p = 'blah'"));
  ((DbTxnManager)txnMgr2).acquireLocks(driver.getPlan(),ctx,"Unknown",false);
  locks=getLocks(txnMgr2);
  Assert.assertEquals("Unexpected lock count",2,locks.size());
  checkLock(LockType.SHARED_WRITE,LockState.ACQUIRED,"default","TAB_PART","p=blah",locks);
  checkLock(LockType.SHARED_WRITE,LockState.WAITING,"default","TAB_PART","p=blah",locks);
  AddDynamicPartitions adp=new AddDynamicPartitions(txnId,"default","TAB_PART",Collections.singletonList("p=blah"));
  adp.setOperationType(DataOperationType.UPDATE);
  txnHandler.addDynamicPartitions(adp);
  txnMgr.commitTxn();
  adp.setTxnid(txnId2);
  txnHandler.addDynamicPartitions(adp);
  LockException expectedException=null;
  try {
    txnMgr2.commitTxn();
  }
 catch (  LockException e) {
    expectedException=e;
  }
  Assert.assertTrue("Didn't get exception",expectedException != null);
  Assert.assertEquals("Got wrong message code",ErrorMsg.TXN_ABORTED,expectedException.getCanonicalErrorMsg());
  Assert.assertEquals("Exception msg didn't match","Aborting [txnid:3,3] due to a write conflict on default/TAB_PART/p=blah committed by [txnid:2,3] u/u",expectedException.getCause().getMessage());
}
