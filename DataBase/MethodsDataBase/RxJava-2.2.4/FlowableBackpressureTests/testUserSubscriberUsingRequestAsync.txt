@Test public void testUserSubscriberUsingRequestAsync() throws InterruptedException {
  AtomicInteger c=new AtomicInteger();
  final AtomicInteger totalReceived=new AtomicInteger();
  final AtomicInteger received=new AtomicInteger();
  final AtomicInteger batches=new AtomicInteger();
  final CountDownLatch latch=new CountDownLatch(1);
  incrementingIntegers(c).subscribeOn(Schedulers.newThread()).subscribe(new ResourceSubscriber<Integer>(){
    @Override public void onStart(){
      request(100);
    }
    @Override public void onComplete(){
      latch.countDown();
    }
    @Override public void onError(    Throwable e){
      latch.countDown();
    }
    @Override public void onNext(    Integer t){
      int total=totalReceived.incrementAndGet();
      received.incrementAndGet();
      boolean done=false;
      if (total >= 2000) {
        done=true;
        dispose();
      }
      if (received.get() == 100) {
        batches.incrementAndGet();
        received.set(0);
        if (!done) {
          request(100);
        }
      }
      if (done) {
        latch.countDown();
      }
    }
  }
);
  latch.await();
  System.out.println("testUserSubscriberUsingRequestAsync => Received: " + totalReceived.get() + "  Emitted: "+ c.get()+ " Request Batches: "+ batches.get());
  assertEquals(2000,c.get());
  assertEquals(2000,totalReceived.get());
  assertEquals(20,batches.get());
}
