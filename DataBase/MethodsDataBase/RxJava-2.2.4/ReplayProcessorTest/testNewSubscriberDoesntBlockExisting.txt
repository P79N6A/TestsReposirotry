@Test(timeout=2000) public void testNewSubscriberDoesntBlockExisting() throws InterruptedException {
  final AtomicReference<String> lastValueForSubscriber1=new AtomicReference<String>();
  Subscriber<String> subscriber1=new DefaultSubscriber<String>(){
    @Override public void onComplete(){
    }
    @Override public void onError(    Throwable e){
    }
    @Override public void onNext(    String v){
      System.out.println("observer1: " + v);
      lastValueForSubscriber1.set(v);
    }
  }
;
  final AtomicReference<String> lastValueForSubscriber2=new AtomicReference<String>();
  final CountDownLatch oneReceived=new CountDownLatch(1);
  final CountDownLatch makeSlow=new CountDownLatch(1);
  final CountDownLatch completed=new CountDownLatch(1);
  Subscriber<String> subscriber2=new DefaultSubscriber<String>(){
    @Override public void onComplete(){
      completed.countDown();
    }
    @Override public void onError(    Throwable e){
    }
    @Override public void onNext(    String v){
      System.out.println("observer2: " + v);
      if (v.equals("one")) {
        oneReceived.countDown();
      }
 else {
        try {
          makeSlow.await();
        }
 catch (        InterruptedException e) {
          e.printStackTrace();
        }
        lastValueForSubscriber2.set(v);
      }
    }
  }
;
  ReplayProcessor<String> processor=ReplayProcessor.create();
  processor.subscribe(subscriber1);
  processor.onNext("one");
  assertEquals("one",lastValueForSubscriber1.get());
  processor.onNext("two");
  assertEquals("two",lastValueForSubscriber1.get());
  processor.subscribeOn(Schedulers.newThread()).subscribe(subscriber2);
  System.out.println("before waiting for one");
  oneReceived.await();
  System.out.println("after waiting for one");
  processor.onNext("three");
  System.out.println("sent three");
  assertEquals("three",lastValueForSubscriber1.get());
  System.out.println("about to send onComplete");
  processor.onComplete();
  System.out.println("completed processor");
  makeSlow.countDown();
  System.out.println("makeSlow released");
  completed.await();
  assertEquals("three",lastValueForSubscriber2.get());
}
