/** 
 * Specifically test interaction with a Scheduler with subscribeOn.
 * @throws Exception functional interfaces declare throws Exception
 */
@SuppressWarnings("unchecked") @Test public void testIssue2191_SchedulerUnsubscribe() throws Exception {
  Consumer<Integer> sourceNext=mock(Consumer.class);
  Action sourceCompleted=mock(Action.class);
  Action sourceUnsubscribed=mock(Action.class);
  final Scheduler mockScheduler=mock(Scheduler.class);
  final Disposable mockSubscription=mock(Disposable.class);
  Worker spiedWorker=workerSpy(mockSubscription);
  Subscriber<Integer> mockObserverBeforeConnect=TestHelper.mockSubscriber();
  Subscriber<Integer> mockObserverAfterConnect=TestHelper.mockSubscriber();
  when(mockScheduler.createWorker()).thenReturn(spiedWorker);
  ConnectableFlowable<Integer> replay=Flowable.just(1,2,3).doOnNext(sourceNext).doOnCancel(sourceUnsubscribed).doOnComplete(sourceCompleted).subscribeOn(mockScheduler).replay();
  replay.subscribe(mockObserverBeforeConnect);
  replay.subscribe(mockObserverBeforeConnect);
  replay.connect();
  replay.subscribe(mockObserverAfterConnect);
  replay.subscribe(mockObserverAfterConnect);
  verify(mockObserverBeforeConnect,times(2)).onSubscribe((Subscription)any());
  verify(mockObserverAfterConnect,times(2)).onSubscribe((Subscription)any());
  verify(sourceNext,times(1)).accept(1);
  verify(sourceNext,times(1)).accept(2);
  verify(sourceNext,times(1)).accept(3);
  verify(sourceCompleted,times(1)).run();
  verify(mockScheduler,times(1)).createWorker();
  verify(spiedWorker,times(1)).schedule((Runnable)notNull());
  verifyObserverMock(mockObserverBeforeConnect,2,6);
  verifyObserverMock(mockObserverAfterConnect,2,6);
  verify(spiedWorker,times(1)).dispose();
  verify(sourceUnsubscribed,never()).run();
  verifyNoMoreInteractions(sourceNext);
  verifyNoMoreInteractions(sourceCompleted);
  verifyNoMoreInteractions(sourceUnsubscribed);
  verifyNoMoreInteractions(spiedWorker);
  verifyNoMoreInteractions(mockSubscription);
  verifyNoMoreInteractions(mockScheduler);
  verifyNoMoreInteractions(mockObserverBeforeConnect);
  verifyNoMoreInteractions(mockObserverAfterConnect);
}
