@Test public void testPublishLast() throws InterruptedException {
  final AtomicInteger count=new AtomicInteger();
  ConnectableFlowable<String> connectable=Flowable.<String>unsafeCreate(new Publisher<String>(){
    @Override public void subscribe(    final Subscriber<? super String> subscriber){
      subscriber.onSubscribe(new BooleanSubscription());
      count.incrementAndGet();
      new Thread(new Runnable(){
        @Override public void run(){
          subscriber.onNext("first");
          subscriber.onNext("last");
          subscriber.onComplete();
        }
      }
).start();
    }
  }
).takeLast(1).publish();
  final CountDownLatch latch=new CountDownLatch(1);
  connectable.subscribe(new Consumer<String>(){
    @Override public void accept(    String value){
      assertEquals("last",value);
      latch.countDown();
    }
  }
);
  connectable.subscribe();
  Disposable subscription=connectable.connect();
  assertTrue(latch.await(1000,TimeUnit.MILLISECONDS));
  assertEquals(1,count.get());
  subscription.dispose();
}
