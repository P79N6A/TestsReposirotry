/** 
 * Test that when a function throws an exception this is propagated through onError.
 */
@Test public void testFunctionThrowsError(){
  TestObservable f=new TestObservable("one");
  Observable<String> w=Observable.unsafeCreate(f);
  final AtomicReference<Throwable> capturedException=new AtomicReference<Throwable>();
  Observable<String> observable=w.onErrorReturn(new Function<Throwable,String>(){
    @Override public String apply(    Throwable e){
      capturedException.set(e);
      throw new RuntimeException("exception from function");
    }
  }
);
  Observer<String> observer=TestHelper.mockObserver();
  observable.subscribe(observer);
  try {
    f.t.join();
  }
 catch (  InterruptedException e) {
    fail(e.getMessage());
  }
  verify(observer,times(1)).onNext("one");
  verify(observer,times(1)).onError(any(Throwable.class));
  verify(observer,times(0)).onComplete();
  assertNotNull(capturedException.get());
}
