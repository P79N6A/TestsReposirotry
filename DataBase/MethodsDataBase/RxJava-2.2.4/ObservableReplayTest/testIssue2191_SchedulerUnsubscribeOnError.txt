/** 
 * Specifically test interaction with a Scheduler with subscribeOn.
 * @throws Exception functional interfaces are declared with throws Exception
 */
@SuppressWarnings("unchecked") @Test public void testIssue2191_SchedulerUnsubscribeOnError() throws Exception {
  Consumer<Integer> sourceNext=mock(Consumer.class);
  Action sourceCompleted=mock(Action.class);
  Consumer<Throwable> sourceError=mock(Consumer.class);
  Action sourceUnsubscribed=mock(Action.class);
  final TestScheduler mockScheduler=new TestScheduler();
  Observer<Integer> mockObserverBeforeConnect=TestHelper.mockObserver();
  Observer<Integer> mockObserverAfterConnect=TestHelper.mockObserver();
  Function<Integer,Integer> mockFunc=mock(Function.class);
  IllegalArgumentException illegalArgumentException=new IllegalArgumentException();
  when(mockFunc.apply(1)).thenReturn(1);
  when(mockFunc.apply(2)).thenThrow(illegalArgumentException);
  ConnectableObservable<Integer> replay=Observable.just(1,2,3).map(mockFunc).doOnNext(sourceNext).doOnDispose(sourceUnsubscribed).doOnComplete(sourceCompleted).doOnError(sourceError).subscribeOn(mockScheduler).replay();
  replay.subscribe(mockObserverBeforeConnect);
  replay.connect();
  replay.subscribe(mockObserverAfterConnect);
  verify(mockObserverBeforeConnect).onSubscribe((Disposable)any());
  verify(mockObserverAfterConnect).onSubscribe((Disposable)any());
  mockScheduler.advanceTimeBy(1,TimeUnit.SECONDS);
  verify(sourceNext,times(1)).accept(1);
  verify(sourceError,times(1)).accept(illegalArgumentException);
  verifyObserver(mockObserverBeforeConnect,1,1,illegalArgumentException);
  verifyObserver(mockObserverAfterConnect,1,1,illegalArgumentException);
  verifyNoMoreInteractions(sourceNext);
  verifyNoMoreInteractions(sourceCompleted);
  verifyNoMoreInteractions(sourceError);
  verifyNoMoreInteractions(sourceUnsubscribed);
  verifyNoMoreInteractions(mockObserverBeforeConnect);
  verifyNoMoreInteractions(mockObserverAfterConnect);
}
