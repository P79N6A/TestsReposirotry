/** 
 * Test that if the master fails, the load balancer maintains its state (running or not) when the next master takes over
 * @throws Exception
 */
@Test public void testMasterFailoverBalancerPersistence() throws Exception {
  final int NUM_MASTERS=3;
  final int NUM_RS=1;
  HBaseTestingUtility TEST_UTIL=new HBaseTestingUtility();
  TEST_UTIL.startMiniCluster(NUM_MASTERS,NUM_RS);
  MiniHBaseCluster cluster=TEST_UTIL.getHBaseCluster();
  assertTrue(cluster.waitForActiveAndReadyMaster());
  HMaster active=cluster.getMaster();
  ClusterMetrics clusterStatus=active.getClusterMetrics();
  assertTrue(clusterStatus.getBalancerOn());
  active=killActiveAndWaitForNewActive(cluster);
  clusterStatus=active.getClusterMetrics();
  assertTrue(clusterStatus.getBalancerOn());
  active.balanceSwitch(false);
  active=killActiveAndWaitForNewActive(cluster);
  clusterStatus=active.getClusterMetrics();
  assertFalse(clusterStatus.getBalancerOn());
  TEST_UTIL.shutdownMiniCluster();
}
