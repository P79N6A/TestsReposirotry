/** 
 * Test that the store files are archived when a column family is removed.
 * @throws Exception
 */
@Test public void testArchiveOnTableFamilyDelete() throws Exception {
  final TableName tableName=TableName.valueOf(name.getMethodName());
  UTIL.createTable(tableName,new byte[][]{TEST_FAM,Bytes.toBytes("fam2")});
  List<HRegion> servingRegions=UTIL.getHBaseCluster().getRegions(tableName);
  assertEquals(1,servingRegions.size());
  HRegion region=servingRegions.get(0);
  HRegionServer hrs=UTIL.getRSForFirstRegionInTable(tableName);
  FileSystem fs=hrs.getFileSystem();
  LOG.debug("-------Loading table");
  UTIL.loadRegion(region,TEST_FAM);
  List<HRegion> regions=hrs.getRegions(tableName);
  assertEquals("More that 1 region for test table.",1,regions.size());
  region=regions.get(0);
  region.waitForFlushesAndCompactions();
  UTIL.getAdmin().disableTable(tableName);
  LOG.debug("Disabled table");
  clearArchiveDirectory();
  byte[][] columns=region.getTableDescriptor().getColumnFamilyNames().toArray(new byte[0][]);
  List<String> storeFiles=region.getStoreFileList(columns);
  UTIL.getAdmin().deleteColumnFamily(tableName,TEST_FAM);
  assertArchiveFiles(fs,storeFiles,30000);
  UTIL.deleteTable(tableName);
}
