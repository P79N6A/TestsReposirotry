/** 
 * This tests retaining assignments on a cluster restart
 */
@Test public void testRetainAssignmentOnRestart() throws Exception {
  UTIL.startMiniCluster(2);
  UTIL.getMiniHBaseCluster().getMaster().getMasterRpcServices().synchronousBalanceSwitch(false);
  LOG.info("\n\nCreating tables");
  for (  TableName TABLE : TABLES) {
    UTIL.createTable(TABLE,FAMILY);
  }
  for (  TableName TABLE : TABLES) {
    UTIL.waitTableEnabled(TABLE);
  }
  HMaster master=UTIL.getMiniHBaseCluster().getMaster();
  UTIL.waitUntilNoRegionsInTransition(120000);
  SnapshotOfRegionAssignmentFromMeta snapshot=new SnapshotOfRegionAssignmentFromMeta(master.getConnection());
  snapshot.initialize();
  Map<RegionInfo,ServerName> regionToRegionServerMap=snapshot.getRegionToRegionServerMap();
  MiniHBaseCluster cluster=UTIL.getHBaseCluster();
  List<JVMClusterUtil.RegionServerThread> threads=cluster.getLiveRegionServerThreads();
  assertEquals(2,threads.size());
  int[] rsPorts=new int[3];
  for (int i=0; i < 2; i++) {
    rsPorts[i]=threads.get(i).getRegionServer().getServerName().getPort();
  }
  rsPorts[2]=cluster.getMaster().getServerName().getPort();
  for (  ServerName serverName : regionToRegionServerMap.values()) {
    boolean found=false;
    for (int k=0; k < 3 && !found; k++) {
      found=serverName.getPort() == rsPorts[k];
    }
    assertTrue(found);
  }
  LOG.info("\n\nShutting down HBase cluster");
  cluster.stopMaster(0);
  cluster.shutdown();
  cluster.waitUntilShutDown();
  LOG.info("\n\nSleeping a bit");
  Thread.sleep(2000);
  LOG.info("\n\nStarting cluster the second time with the same ports");
  try {
    cluster.getConf().setInt(ServerManager.WAIT_ON_REGIONSERVERS_MINTOSTART,3);
    master=cluster.startMaster().getMaster();
    for (int i=0; i < 3; i++) {
      cluster.getConf().setInt(HConstants.REGIONSERVER_PORT,rsPorts[i]);
      cluster.startRegionServer();
    }
  }
  finally {
    cluster.getConf().setInt(HConstants.REGIONSERVER_PORT,0);
    cluster.getConf().setInt(ServerManager.WAIT_ON_REGIONSERVERS_MINTOSTART,2);
  }
  List<ServerName> localServers=master.getServerManager().getOnlineServersList();
  assertEquals(3,localServers.size());
  for (int i=0; i < 3; i++) {
    boolean found=false;
    for (    ServerName serverName : localServers) {
      if (serverName.getPort() == rsPorts[i]) {
        found=true;
        break;
      }
    }
    assertTrue(found);
  }
  for (  TableName TABLE : TABLES) {
    UTIL.waitTableAvailable(TABLE);
  }
  snapshot=new SnapshotOfRegionAssignmentFromMeta(master.getConnection());
  snapshot.initialize();
  Map<RegionInfo,ServerName> newRegionToRegionServerMap=snapshot.getRegionToRegionServerMap();
  assertEquals(regionToRegionServerMap.size(),newRegionToRegionServerMap.size());
  for (  Map.Entry<RegionInfo,ServerName> entry : newRegionToRegionServerMap.entrySet()) {
    if (TableName.NAMESPACE_TABLE_NAME.equals(entry.getKey().getTable())) {
      continue;
    }
    ServerName oldServer=regionToRegionServerMap.get(entry.getKey());
    ServerName currentServer=entry.getValue();
    LOG.info("Key=" + entry.getKey() + " oldServer="+ oldServer+ ", currentServer="+ currentServer);
    assertEquals(entry.getKey().toString(),oldServer.getAddress(),currentServer.getAddress());
    assertNotEquals(oldServer.getStartcode(),currentServer.getStartcode());
  }
}
