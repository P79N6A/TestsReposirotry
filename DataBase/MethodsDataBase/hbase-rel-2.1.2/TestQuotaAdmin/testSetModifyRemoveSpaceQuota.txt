@Test public void testSetModifyRemoveSpaceQuota() throws Exception {
  Admin admin=TEST_UTIL.getAdmin();
  final TableName tn=TableName.valueOf("sq_table2");
  final long originalSizeLimit=1024L * 1024L * 1024L* 1024L* 5L;
  final SpaceViolationPolicy violationPolicy=SpaceViolationPolicy.NO_WRITES;
  QuotaSettings settings=QuotaSettingsFactory.limitTableSpace(tn,originalSizeLimit,violationPolicy);
  admin.setQuota(settings);
  try (Table quotaTable=TEST_UTIL.getConnection().getTable(QuotaTableUtil.QUOTA_TABLE_NAME)){
    ResultScanner scanner=quotaTable.getScanner(new Scan());
    try {
      Result r=Iterables.getOnlyElement(scanner);
      CellScanner cells=r.cellScanner();
      assertTrue("Expected to find a cell",cells.advance());
      assertSpaceQuota(originalSizeLimit,violationPolicy,cells.current());
    }
  finally {
      scanner.close();
    }
  }
   QuotaRetriever quotaScanner=QuotaRetriever.open(admin.getConfiguration());
  try {
    assertSpaceQuota(originalSizeLimit,violationPolicy,Iterables.getOnlyElement(quotaScanner));
  }
  finally {
    quotaScanner.close();
  }
  final long newSizeLimit=1024L * 1024L * 1024L* 1024L;
  final SpaceViolationPolicy newViolationPolicy=SpaceViolationPolicy.NO_WRITES_COMPACTIONS;
  QuotaSettings newSettings=QuotaSettingsFactory.limitTableSpace(tn,newSizeLimit,newViolationPolicy);
  admin.setQuota(newSettings);
  try (Table quotaTable=TEST_UTIL.getConnection().getTable(QuotaTableUtil.QUOTA_TABLE_NAME)){
    ResultScanner scanner=quotaTable.getScanner(new Scan());
    try {
      Result r=Iterables.getOnlyElement(scanner);
      CellScanner cells=r.cellScanner();
      assertTrue("Expected to find a cell",cells.advance());
      assertSpaceQuota(newSizeLimit,newViolationPolicy,cells.current());
    }
  finally {
      scanner.close();
    }
  }
   quotaScanner=QuotaRetriever.open(admin.getConfiguration());
  try {
    assertSpaceQuota(newSizeLimit,newViolationPolicy,Iterables.getOnlyElement(quotaScanner));
  }
  finally {
    quotaScanner.close();
  }
  QuotaSettings removeQuota=QuotaSettingsFactory.removeTableSpaceLimit(tn);
  admin.setQuota(removeQuota);
  try (Table quotaTable=TEST_UTIL.getConnection().getTable(QuotaTableUtil.QUOTA_TABLE_NAME)){
    ResultScanner scanner=quotaTable.getScanner(new Scan());
    try {
      assertNull("Did not expect to find a quota entry",scanner.next());
    }
  finally {
      scanner.close();
    }
  }
   quotaScanner=QuotaRetriever.open(admin.getConfiguration());
  try {
    assertNull("Did not expect to find a quota entry",quotaScanner.next());
  }
  finally {
    quotaScanner.close();
  }
}
