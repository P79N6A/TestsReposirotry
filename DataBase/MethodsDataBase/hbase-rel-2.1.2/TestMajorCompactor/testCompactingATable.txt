@Test public void testCompactingATable() throws Exception {
  TableName tableName=TableName.valueOf("TestMajorCompactor");
  utility.createMultiRegionTable(tableName,FAMILY,5);
  utility.waitTableAvailable(tableName);
  Connection connection=utility.getConnection();
  Table table=connection.getTable(tableName);
  for (int i=0; i < 5; i++) {
    utility.loadRandomRows(table,FAMILY,50,100);
    utility.flush(tableName);
  }
  table.close();
  int numberOfRegions=utility.getAdmin().getRegions(tableName).size();
  int numHFiles=utility.getNumHFiles(tableName,FAMILY);
  assertTrue(numberOfRegions < numHFiles);
  MajorCompactor compactor=new MajorCompactor(utility.getConfiguration(),tableName,Sets.newHashSet(Bytes.toString(FAMILY)),1,System.currentTimeMillis(),200);
  compactor.initializeWorkQueues();
  compactor.compactAllRegions();
  compactor.shutdown();
  numberOfRegions=utility.getAdmin().getRegions(tableName).size();
  numHFiles=utility.getNumHFiles(tableName,FAMILY);
  assertEquals(numHFiles,numberOfRegions);
}
