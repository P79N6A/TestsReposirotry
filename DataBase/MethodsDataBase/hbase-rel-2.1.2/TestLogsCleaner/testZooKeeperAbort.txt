/** 
 * ReplicationLogCleaner should be able to ride over ZooKeeper errors without aborting.
 */
@Test public void testZooKeeperAbort() throws Exception {
  Configuration conf=TEST_UTIL.getConfiguration();
  ReplicationLogCleaner cleaner=new ReplicationLogCleaner();
  List<FileStatus> dummyFiles=Lists.newArrayList(new FileStatus(100,false,3,100,System.currentTimeMillis(),new Path("log1")),new FileStatus(100,false,3,100,System.currentTimeMillis(),new Path("log2")));
  try (FaultyZooKeeperWatcher faultyZK=new FaultyZooKeeperWatcher(conf,"testZooKeeperAbort-faulty",null)){
    faultyZK.init();
    cleaner.setConf(conf,faultyZK);
    cleaner.preClean();
    Iterable<FileStatus> toDelete=cleaner.getDeletableFiles(dummyFiles);
    assertFalse(toDelete.iterator().hasNext());
    assertFalse(cleaner.isStopped());
  }
   cleaner=new ReplicationLogCleaner();
  try (ZKWatcher zkw=new ZKWatcher(conf,"testZooKeeperAbort-normal",null)){
    cleaner.setConf(conf,zkw);
    cleaner.preClean();
    Iterable<FileStatus> filesToDelete=cleaner.getDeletableFiles(dummyFiles);
    Iterator<FileStatus> iter=filesToDelete.iterator();
    assertTrue(iter.hasNext());
    assertEquals(new Path("log1"),iter.next().getPath());
    assertTrue(iter.hasNext());
    assertEquals(new Path("log2"),iter.next().getPath());
    assertFalse(iter.hasNext());
  }
 }
