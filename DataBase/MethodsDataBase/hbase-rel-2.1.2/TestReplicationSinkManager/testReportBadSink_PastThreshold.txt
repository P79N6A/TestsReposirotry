/** 
 * Once a SinkPeer has been reported as bad more than BAD_SINK_THRESHOLD times, it should not be replicated to anymore.
 */
@Test public void testReportBadSink_PastThreshold(){
  List<ServerName> serverNames=Lists.newArrayList();
  int totalServers=30;
  for (int i=0; i < totalServers; i++) {
    serverNames.add(mock(ServerName.class));
  }
  when(replicationEndpoint.getRegionServers()).thenReturn(serverNames);
  sinkManager.chooseSinks();
  int expected=(int)(totalServers * ReplicationSinkManager.DEFAULT_REPLICATION_SOURCE_RATIO);
  assertEquals(expected,sinkManager.getNumSinks());
  ServerName serverName=sinkManager.getSinksForTesting().get(0);
  SinkPeer sinkPeer=new SinkPeer(serverName,mock(AdminService.BlockingInterface.class));
  sinkManager.reportSinkSuccess(sinkPeer);
  for (int i=0; i <= ReplicationSinkManager.DEFAULT_BAD_SINK_THRESHOLD; i++) {
    sinkManager.reportBadSink(sinkPeer);
  }
  assertEquals(expected - 1,sinkManager.getNumSinks());
  serverName=sinkManager.getSinksForTesting().get(0);
  sinkPeer=new SinkPeer(serverName,mock(AdminService.BlockingInterface.class));
  for (int i=0; i <= ReplicationSinkManager.DEFAULT_BAD_SINK_THRESHOLD - 1; i++) {
    sinkManager.reportBadSink(sinkPeer);
  }
  sinkManager.reportSinkSuccess(sinkPeer);
  sinkManager.reportBadSink(sinkPeer);
  assertEquals(expected - 1,sinkManager.getNumSinks());
  for (int i=0; i <= ReplicationSinkManager.DEFAULT_BAD_SINK_THRESHOLD - 2; i++) {
    sinkManager.reportBadSink(sinkPeer);
  }
  assertEquals(expected - 1,sinkManager.getNumSinks());
  sinkManager.reportBadSink(sinkPeer);
  assertEquals(expected - 2,sinkManager.getNumSinks());
}
