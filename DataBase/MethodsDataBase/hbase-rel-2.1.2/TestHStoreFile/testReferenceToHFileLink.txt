/** 
 * This test creates an hfile and then the dir structures and files to verify that references to hfilelinks (created by snapshot clones) can be properly interpreted.
 */
@Test public void testReferenceToHFileLink() throws IOException {
  Configuration testConf=new Configuration(this.conf);
  FSUtils.setRootDir(testConf,testDir);
  HRegionInfo hri=new HRegionInfo(TableName.valueOf("_original-evil-name"));
  HRegionFileSystem regionFs=HRegionFileSystem.createRegionOnFileSystem(testConf,fs,FSUtils.getTableDir(testDir,hri.getTable()),hri);
  HFileContext meta=new HFileContextBuilder().withBlockSize(8 * 1024).build();
  StoreFileWriter writer=new StoreFileWriter.Builder(testConf,cacheConf,this.fs).withFilePath(regionFs.createTempName()).withFileContext(meta).build();
  writeStoreFile(writer);
  Path storeFilePath=regionFs.commitStoreFile(TEST_FAMILY,writer.getPath());
  HRegionInfo hriClone=new HRegionInfo(TableName.valueOf("clone"));
  HRegionFileSystem cloneRegionFs=HRegionFileSystem.createRegionOnFileSystem(testConf,fs,FSUtils.getTableDir(testDir,hri.getTable()),hriClone);
  Path dstPath=cloneRegionFs.getStoreDir(TEST_FAMILY);
  HFileLink.create(testConf,this.fs,dstPath,hri,storeFilePath.getName());
  Path linkFilePath=new Path(dstPath,HFileLink.createHFileLinkName(hri,storeFilePath.getName()));
  HRegionInfo splitHriA=new HRegionInfo(hri.getTable(),null,SPLITKEY);
  HRegionInfo splitHriB=new HRegionInfo(hri.getTable(),SPLITKEY,null);
  HStoreFile f=new HStoreFile(fs,linkFilePath,testConf,cacheConf,BloomType.NONE,true);
  f.initReader();
  Path pathA=splitStoreFile(cloneRegionFs,splitHriA,TEST_FAMILY,f,SPLITKEY,true);
  Path pathB=splitStoreFile(cloneRegionFs,splitHriB,TEST_FAMILY,f,SPLITKEY,false);
  f.closeStoreFile(true);
  FSUtils.logFileSystemState(fs,testDir,LOG);
  HStoreFile hsfA=new HStoreFile(this.fs,pathA,testConf,cacheConf,BloomType.NONE,true);
  hsfA.initReader();
  int count=1;
  HFileScanner s=hsfA.getReader().getScanner(false,false);
  s.seekTo();
  while (s.next()) {
    count++;
  }
  assertTrue(count > 0);
  HStoreFile hsfB=new HStoreFile(this.fs,pathB,testConf,cacheConf,BloomType.NONE,true);
  hsfB.initReader();
  HFileScanner sB=hsfB.getReader().getScanner(false,false);
  sB.seekTo();
  count++;
  while (sB.next()) {
    count++;
  }
  assertEquals((LAST_CHAR - FIRST_CHAR + 1) * (LAST_CHAR - FIRST_CHAR + 1),count);
}
