/** 
 * Test that our mechanism of writing store files in one region to reference store files in other regions works.
 * @throws IOException
 */
@Test public void testReference() throws IOException {
  final HRegionInfo hri=new HRegionInfo(TableName.valueOf("testReferenceTb"));
  HRegionFileSystem regionFs=HRegionFileSystem.createRegionOnFileSystem(conf,fs,new Path(testDir,hri.getTable().getNameAsString()),hri);
  HFileContext meta=new HFileContextBuilder().withBlockSize(8 * 1024).build();
  StoreFileWriter writer=new StoreFileWriter.Builder(conf,cacheConf,this.fs).withFilePath(regionFs.createTempName()).withFileContext(meta).build();
  writeStoreFile(writer);
  Path hsfPath=regionFs.commitStoreFile(TEST_FAMILY,writer.getPath());
  HStoreFile hsf=new HStoreFile(this.fs,hsfPath,conf,cacheConf,BloomType.NONE,true);
  hsf.initReader();
  StoreFileReader reader=hsf.getReader();
  byte[] midRow=CellUtil.cloneRow(reader.midKey().get());
  byte[] finalRow=CellUtil.cloneRow(reader.getLastKey().get());
  hsf.closeStoreFile(true);
  HRegionInfo splitHri=new HRegionInfo(hri.getTable(),null,midRow);
  Path refPath=splitStoreFile(regionFs,splitHri,TEST_FAMILY,hsf,midRow,true);
  HStoreFile refHsf=new HStoreFile(this.fs,refPath,conf,cacheConf,BloomType.NONE,true);
  refHsf.initReader();
  HFileScanner s=refHsf.getReader().getScanner(false,false);
  Cell kv=null;
  for (boolean first=true; (!s.isSeeked() && s.seekTo()) || s.next(); ) {
    ByteBuffer bb=ByteBuffer.wrap(((KeyValue)s.getKey()).getKey());
    kv=KeyValueUtil.createKeyValueFromKey(bb);
    if (first) {
      assertTrue(Bytes.equals(kv.getRowArray(),kv.getRowOffset(),kv.getRowLength(),midRow,0,midRow.length));
      first=false;
    }
  }
  assertTrue(Bytes.equals(kv.getRowArray(),kv.getRowOffset(),kv.getRowLength(),finalRow,0,finalRow.length));
}
