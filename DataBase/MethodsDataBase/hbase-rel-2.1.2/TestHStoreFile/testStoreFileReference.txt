@Test public void testStoreFileReference() throws Exception {
  final RegionInfo hri=RegionInfoBuilder.newBuilder(TableName.valueOf("testStoreFileReference")).build();
  HRegionFileSystem regionFs=HRegionFileSystem.createRegionOnFileSystem(conf,fs,new Path(testDir,hri.getTable().getNameAsString()),hri);
  HFileContext meta=new HFileContextBuilder().withBlockSize(8 * 1024).build();
  StoreFileWriter writer=new StoreFileWriter.Builder(conf,cacheConf,this.fs).withFilePath(regionFs.createTempName()).withFileContext(meta).build();
  writeStoreFile(writer);
  Path hsfPath=regionFs.commitStoreFile(TEST_FAMILY,writer.getPath());
  writer.close();
  HStoreFile file=new HStoreFile(this.fs,hsfPath,conf,cacheConf,BloomType.NONE,true);
  file.initReader();
  StoreFileReader r=file.getReader();
  assertNotNull(r);
  StoreFileScanner scanner=new StoreFileScanner(r,mock(HFileScanner.class),false,false,0,0,false);
  assertTrue("Verify file is being referenced",file.isReferencedInReads());
  scanner.close();
  assertFalse("Verify file is not being referenced",file.isReferencedInReads());
}
