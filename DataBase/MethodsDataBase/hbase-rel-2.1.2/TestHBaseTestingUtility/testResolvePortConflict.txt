@Test public void testResolvePortConflict() throws Exception {
  Random random=mock(Random.class);
  when(random.nextInt(anyInt())).thenAnswer(new Answer<Integer>(){
    int[] numbers={1,1,2};
    int count=0;
    @Override public Integer answer(    InvocationOnMock invocation){
      int ret=numbers[count];
      count++;
      return ret;
    }
  }
);
  HBaseTestingUtility.PortAllocator.AvailablePortChecker portChecker=mock(HBaseTestingUtility.PortAllocator.AvailablePortChecker.class);
  when(portChecker.available(anyInt())).thenReturn(true);
  HBaseTestingUtility.PortAllocator portAllocator=new HBaseTestingUtility.PortAllocator(random,portChecker);
  int port1=portAllocator.randomFreePort();
  int port2=portAllocator.randomFreePort();
  assertNotEquals(port1,port2);
  Mockito.verify(random,Mockito.times(3)).nextInt(anyInt());
}
