/** 
 * Tests the case where killing a secondary region with unflushed data recovers, and the replica becomes available to read again shortly.
 */
@Test public void testSecondaryRegionKill() throws Exception {
  try (Connection connection=ConnectionFactory.createConnection(HTU.getConfiguration());Table table=connection.getTable(htd.getTableName())){
    HTU.loadNumericRows(table,fam,0,1000);
    verifyNumericRowsWithTimeout(table,fam,0,1000,1,30000);
    verifyNumericRowsWithTimeout(table,fam,0,1000,2,30000);
    boolean aborted=false;
    for (    RegionServerThread rs : HTU.getMiniHBaseCluster().getRegionServerThreads()) {
      for (      Region r : rs.getRegionServer().getRegions(htd.getTableName())) {
        if (r.getRegionInfo().getReplicaId() == 1) {
          LOG.info("Aborting region server hosting secondary region replica");
          rs.getRegionServer().abort("for test");
          aborted=true;
          break;
        }
      }
    }
    assertTrue(aborted);
    Threads.sleep(5000);
    HTU.verifyNumericRows(table,fam,0,1000,1);
    HTU.verifyNumericRows(table,fam,0,1000,2);
  }
   HTU.getMiniHBaseCluster().startRegionServer();
}
