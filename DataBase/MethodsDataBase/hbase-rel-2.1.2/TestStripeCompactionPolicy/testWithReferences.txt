@Test public void testWithReferences() throws Exception {
  StripeCompactionPolicy policy=createPolicy(HBaseConfiguration.create());
  StripeCompactor sc=mock(StripeCompactor.class);
  HStoreFile ref=createFile();
  when(ref.isReference()).thenReturn(true);
  StripeInformationProvider si=mock(StripeInformationProvider.class);
  Collection<HStoreFile> sfs=al(ref,createFile());
  when(si.getStorefiles()).thenReturn(sfs);
  assertTrue(policy.needsCompactions(si,al()));
  StripeCompactionPolicy.StripeCompactionRequest scr=policy.selectCompaction(si,al(),false);
  assertEquals(si.getStorefiles(),new ArrayList<>(scr.getRequest().getFiles()));
  scr.execute(sc,NoLimitThroughputController.INSTANCE,null);
  verify(sc,only()).compact(eq(scr.getRequest()),anyInt(),anyLong(),aryEq(OPEN_KEY),aryEq(OPEN_KEY),aryEq(OPEN_KEY),aryEq(OPEN_KEY),any(),any());
}
