/** 
 * Make sure that we validate the snapshot name and the table name before we pass anything across the wire
 * @throws Exception on failure
 */
@Test public void testValidateSnapshotName() throws Exception {
  ConnectionImplementation mockConnection=Mockito.mock(ConnectionImplementation.class);
  Configuration conf=HBaseConfiguration.create();
  Mockito.when(mockConnection.getConfiguration()).thenReturn(conf);
  RpcRetryingCallerFactory callerFactory=new RpcRetryingCallerFactory(conf);
  RpcControllerFactory controllerFactory=Mockito.mock(RpcControllerFactory.class);
  Mockito.when(controllerFactory.newController()).thenReturn(Mockito.mock(HBaseRpcController.class));
  Mockito.when(mockConnection.getRpcRetryingCallerFactory()).thenReturn(callerFactory);
  Mockito.when(mockConnection.getRpcControllerFactory()).thenReturn(controllerFactory);
  Admin admin=new HBaseAdmin(mockConnection);
  failSnapshotStart(admin,new SnapshotDescription(HConstants.SNAPSHOT_DIR_NAME));
  failSnapshotStart(admin,new SnapshotDescription("-snapshot"));
  failSnapshotStart(admin,new SnapshotDescription("snapshot fails"));
  failSnapshotStart(admin,new SnapshotDescription("snap$hot"));
  failSnapshotStart(admin,new SnapshotDescription("snap:hot"));
  failSnapshotDescriptorCreation("snapshot",".table");
  failSnapshotDescriptorCreation("snapshot","-table");
  failSnapshotDescriptorCreation("snapshot","table fails");
  failSnapshotDescriptorCreation("snapshot","tab%le");
  MasterKeepAliveConnection master=Mockito.mock(MasterKeepAliveConnection.class);
  Mockito.when(mockConnection.getMaster()).thenReturn(master);
  SnapshotResponse response=SnapshotResponse.newBuilder().setExpectedTimeout(0).build();
  Mockito.when(master.snapshot((RpcController)Mockito.any(),Mockito.any())).thenReturn(response);
  IsSnapshotDoneResponse doneResponse=IsSnapshotDoneResponse.newBuilder().setDone(true).build();
  Mockito.when(master.isSnapshotDone((RpcController)Mockito.any(),Mockito.any())).thenReturn(doneResponse);
  admin.snapshot(new SnapshotDescription("snapshot",TableName.valueOf(name.getMethodName())));
}
