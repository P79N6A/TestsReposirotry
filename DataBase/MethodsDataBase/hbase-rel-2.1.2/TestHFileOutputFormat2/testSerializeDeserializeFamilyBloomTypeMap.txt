/** 
 * Test for  {@link HFileOutputFormat2#configureBloomType(HTableDescriptor,Configuration)} and{@link HFileOutputFormat2#createFamilyBloomTypeMap(Configuration)}. Tests that the compression map is correctly serialized into and deserialized from configuration
 * @throws IOException
 */
@Ignore("Goes zombie too frequently; needs work. See HBASE-14563") @Test public void testSerializeDeserializeFamilyBloomTypeMap() throws IOException {
  for (int numCfs=0; numCfs <= 2; numCfs++) {
    Configuration conf=new Configuration(this.util.getConfiguration());
    Map<String,BloomType> familyToBloomType=getMockColumnFamiliesForBloomType(numCfs);
    Table table=Mockito.mock(Table.class);
    setupMockColumnFamiliesForBloomType(table,familyToBloomType);
    conf.set(HFileOutputFormat2.BLOOM_TYPE_FAMILIES_CONF_KEY,HFileOutputFormat2.serializeColumnFamilyAttribute(HFileOutputFormat2.bloomTypeDetails,Arrays.asList(table.getTableDescriptor())));
    Map<byte[],BloomType> retrievedFamilyToBloomTypeMap=HFileOutputFormat2.createFamilyBloomTypeMap(conf);
    for (    Entry<String,BloomType> entry : familyToBloomType.entrySet()) {
      assertEquals("BloomType configuration incorrect for column family:" + entry.getKey(),entry.getValue(),retrievedFamilyToBloomTypeMap.get(entry.getKey().getBytes("UTF-8")));
    }
  }
}
