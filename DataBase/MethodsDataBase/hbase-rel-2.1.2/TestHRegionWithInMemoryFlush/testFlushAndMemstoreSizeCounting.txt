/** 
 * A test case of HBASE-21041
 * @throws Exception Exception
 */
@Override @Test public void testFlushAndMemstoreSizeCounting() throws Exception {
  byte[] family=Bytes.toBytes("family");
  this.region=initHRegion(tableName,method,CONF,family);
  final WALFactory wals=new WALFactory(CONF,method);
  int count=0;
  try {
    for (    byte[] row : HBaseTestingUtility.ROWS) {
      Put put=new Put(row);
      put.addColumn(family,family,row);
      region.put(put);
      if (count++ % 1000 == 0) {
        ((CompactingMemStore)(region.getStore(family).memstore)).flushInMemory();
      }
    }
    region.flush(true);
    Assert.assertEquals(0,region.getMemStoreDataSize());
    Assert.assertEquals(MutableSegment.DEEP_OVERHEAD,region.getMemStoreHeapSize());
    Assert.assertEquals(0,region.getMemStoreOffHeapSize());
  }
  finally {
    HBaseTestingUtility.closeRegionAndWAL(this.region);
    this.region=null;
    wals.close();
  }
}
