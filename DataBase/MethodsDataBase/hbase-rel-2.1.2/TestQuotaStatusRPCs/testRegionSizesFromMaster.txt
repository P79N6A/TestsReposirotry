@Test public void testRegionSizesFromMaster() throws Exception {
  final long tableSize=1024L * 10L;
  final int numRegions=10;
  final TableName tn=helper.createTableWithRegions(numRegions);
  helper.writeData(tn,tableSize);
  final HMaster master=TEST_UTIL.getMiniHBaseCluster().getMaster();
  final MasterQuotaManager quotaManager=master.getMasterQuotaManager();
  Waiter.waitFor(TEST_UTIL.getConfiguration(),30 * 1000,new Predicate<Exception>(){
    @Override public boolean evaluate() throws Exception {
      Map<RegionInfo,Long> regionSizes=quotaManager.snapshotRegionSizes();
      LOG.trace("Region sizes=" + regionSizes);
      return numRegions == countRegionsForTable(tn,regionSizes) && tableSize <= getTableSize(tn,regionSizes);
    }
  }
);
  Map<TableName,Long> sizes=QuotaTableUtil.getMasterReportedTableSizes(TEST_UTIL.getConnection());
  Long size=sizes.get(tn);
  assertNotNull("No reported size for " + tn,size);
  assertTrue("Reported table size was " + size,size.longValue() >= tableSize);
}
