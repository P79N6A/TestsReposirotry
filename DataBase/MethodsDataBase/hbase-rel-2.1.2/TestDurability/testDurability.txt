@Test public void testDurability() throws Exception {
  WALFactory wals=new WALFactory(CONF,ServerName.valueOf("TestDurability",16010,System.currentTimeMillis()).toString());
  HRegion region=createHRegion(wals,Durability.USE_DEFAULT);
  WAL wal=region.getWAL();
  HRegion deferredRegion=createHRegion(region.getTableDescriptor(),region.getRegionInfo(),"deferredRegion",wal,Durability.ASYNC_WAL);
  region.put(newPut(null));
  verifyWALCount(wals,wal,1);
  deferredRegion.put(newPut(null));
  wal.sync();
  verifyWALCount(wals,wal,2);
  deferredRegion.put(newPut(null));
  wal.sync();
  verifyWALCount(wals,wal,3);
  region.put(newPut(null));
  verifyWALCount(wals,wal,4);
  deferredRegion.put(newPut(Durability.USE_DEFAULT));
  wal.sync();
  verifyWALCount(wals,wal,5);
  region.put(newPut(Durability.USE_DEFAULT));
  verifyWALCount(wals,wal,6);
  region.put(newPut(Durability.SKIP_WAL));
  deferredRegion.put(newPut(Durability.SKIP_WAL));
  verifyWALCount(wals,wal,6);
  wal.sync();
  verifyWALCount(wals,wal,6);
  region.put(newPut(Durability.ASYNC_WAL));
  deferredRegion.put(newPut(Durability.ASYNC_WAL));
  wal.sync();
  verifyWALCount(wals,wal,8);
  region.put(newPut(Durability.SYNC_WAL));
  deferredRegion.put(newPut(Durability.SYNC_WAL));
  verifyWALCount(wals,wal,10);
  region.put(newPut(Durability.FSYNC_WAL));
  deferredRegion.put(newPut(Durability.FSYNC_WAL));
  verifyWALCount(wals,wal,12);
}
