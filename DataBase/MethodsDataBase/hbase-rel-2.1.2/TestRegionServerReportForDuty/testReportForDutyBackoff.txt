/** 
 * Tests region server should backoff to report for duty if master is not ready.
 */
@Test public void testReportForDutyBackoff() throws IOException, InterruptedException {
  cluster.getConfiguration().set(HConstants.MASTER_IMPL,NeverInitializedMaster.class.getName());
  master=cluster.addMaster();
  master.start();
  LogCapturer capturer=new LogCapturer(org.apache.log4j.Logger.getLogger(HRegionServer.class));
  int msginterval=100;
  cluster.getConfiguration().setInt("hbase.regionserver.msginterval",msginterval);
  rs=cluster.addRegionServer();
  rs.start();
  int interval=10_000;
  Thread.sleep(interval);
  capturer.stopCapturing();
  String output=capturer.getOutput();
  LOG.info("{}",output);
  String failMsg="reportForDuty failed;";
  int count=StringUtils.countMatches(output,failMsg);
  int expectedRetry=(int)Math.ceil(Math.log(interval - msginterval));
  assertTrue(String.format("reportForDuty retries %d times, less than expected min %d",count,expectedRetry / 2),count > expectedRetry / 2);
  assertTrue(String.format("reportForDuty retries %d times, more than expected max %d",count,expectedRetry * 2),count < expectedRetry * 2);
}
