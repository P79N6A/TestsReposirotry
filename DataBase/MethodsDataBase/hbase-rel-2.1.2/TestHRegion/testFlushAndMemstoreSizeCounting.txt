/** 
 * A test case of HBASE-21041
 * @throws Exception Exception
 */
@Test public void testFlushAndMemstoreSizeCounting() throws Exception {
  byte[] family=Bytes.toBytes("family");
  this.region=initHRegion(tableName,method,CONF,family);
  final WALFactory wals=new WALFactory(CONF,method);
  try {
    for (    byte[] row : HBaseTestingUtility.ROWS) {
      Put put=new Put(row);
      put.addColumn(family,family,row);
      region.put(put);
    }
    region.flush(true);
    assertEquals(0,region.getMemStoreDataSize());
    assertEquals(MutableSegment.DEEP_OVERHEAD,region.getMemStoreHeapSize());
    assertEquals(0,region.getMemStoreOffHeapSize());
  }
  finally {
    HBaseTestingUtility.closeRegionAndWAL(this.region);
    this.region=null;
    wals.close();
  }
}
