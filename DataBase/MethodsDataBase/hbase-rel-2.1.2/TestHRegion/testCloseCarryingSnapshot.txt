/** 
 * Test for Bug 2 of HBASE-10466. "Bug 2: Conditions for the first flush of region close (so-called pre-flush) If memstoreSize is smaller than a certain value, or when region close starts a flush is ongoing, the first flush is skipped and only the second flush takes place. However, two flushes are required in case previous flush fails and leaves some data in snapshot. The bug could cause loss of data in current memstore. The fix is removing all conditions except abort check so we ensure 2 flushes for region close."
 * @throws IOException
 */
@Test public void testCloseCarryingSnapshot() throws IOException {
  HRegion region=initHRegion(tableName,method,CONF,COLUMN_FAMILY_BYTES);
  HStore store=region.getStore(COLUMN_FAMILY_BYTES);
  byte[] value=Bytes.toBytes(method);
  Put put=new Put(value);
  put.addColumn(COLUMN_FAMILY_BYTES,null,value);
  region.put(put);
  StoreFlushContext storeFlushCtx=store.createFlushContext(12345,FlushLifeCycleTracker.DUMMY);
  storeFlushCtx.prepare();
  put.addColumn(COLUMN_FAMILY_BYTES,Bytes.toBytes("abc"),value);
  region.put(put);
  region.close();
  assertEquals(0,region.getMemStoreDataSize());
  HBaseTestingUtility.closeRegionAndWAL(region);
}
