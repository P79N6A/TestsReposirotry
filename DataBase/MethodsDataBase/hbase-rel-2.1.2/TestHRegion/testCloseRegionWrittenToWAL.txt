@Test public void testCloseRegionWrittenToWAL() throws Exception {
  Path rootDir=new Path(dir + name.getMethodName());
  FSUtils.setRootDir(TEST_UTIL.getConfiguration(),rootDir);
  final ServerName serverName=ServerName.valueOf("testCloseRegionWrittenToWAL",100,42);
  final RegionServerServices rss=spy(TEST_UTIL.createMockRegionServerService(serverName));
  HTableDescriptor htd=new HTableDescriptor(TableName.valueOf(name.getMethodName()));
  htd.addFamily(new HColumnDescriptor(fam1));
  htd.addFamily(new HColumnDescriptor(fam2));
  final HRegionInfo hri=new HRegionInfo(htd.getTableName(),HConstants.EMPTY_BYTE_ARRAY,HConstants.EMPTY_BYTE_ARRAY);
  ArgumentCaptor<WALEdit> editCaptor=ArgumentCaptor.forClass(WALEdit.class);
  WAL wal=mockWAL();
  when(rss.getWAL((HRegionInfo)any())).thenReturn(wal);
  region=HRegion.createHRegion(hri,rootDir,TEST_UTIL.getConfiguration(),htd,rss.getWAL(hri));
  region=HRegion.openHRegion(hri,htd,rss.getWAL(hri),TEST_UTIL.getConfiguration(),rss,null);
  region.close(false);
  verify(wal,times(2)).append((HRegionInfo)any(),(WALKeyImpl)any(),editCaptor.capture(),anyBoolean());
  WALEdit edit=editCaptor.getAllValues().get(1);
  assertNotNull(edit);
  assertNotNull(edit.getCells());
  assertEquals(1,edit.getCells().size());
  RegionEventDescriptor desc=WALEdit.getRegionEventDescriptor(edit.getCells().get(0));
  assertNotNull(desc);
  LOG.info("RegionEventDescriptor from WAL: " + desc);
  assertEquals(RegionEventDescriptor.EventType.REGION_CLOSE,desc.getEventType());
  assertTrue(Bytes.equals(desc.getTableName().toByteArray(),htd.getTableName().toBytes()));
  assertTrue(Bytes.equals(desc.getEncodedRegionName().toByteArray(),hri.getEncodedNameAsBytes()));
  assertTrue(desc.getLogSequenceNumber() > 0);
  assertEquals(serverName,ProtobufUtil.toServerName(desc.getServer()));
  assertEquals(2,desc.getStoresCount());
  StoreDescriptor store=desc.getStores(0);
  assertTrue(Bytes.equals(store.getFamilyName().toByteArray(),fam1));
  assertEquals(store.getStoreHomeDir(),Bytes.toString(fam1));
  assertEquals(0,store.getStoreFileCount());
  store=desc.getStores(1);
  assertTrue(Bytes.equals(store.getFamilyName().toByteArray(),fam2));
  assertEquals(store.getStoreHomeDir(),Bytes.toString(fam2));
  assertEquals(0,store.getStoreFileCount());
}
