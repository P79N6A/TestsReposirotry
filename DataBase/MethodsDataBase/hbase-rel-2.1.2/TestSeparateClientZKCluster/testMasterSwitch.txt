@Test public void testMasterSwitch() throws Exception {
  Connection conn=TEST_UTIL.getConnection();
  Admin admin=conn.getAdmin();
  LOG.debug("Tables: " + admin.listTableDescriptors());
  try {
    MiniHBaseCluster cluster=TEST_UTIL.getHBaseCluster();
    HMaster master=cluster.getMaster();
    master.stopMaster();
    while (!master.isShutDown()) {
      Thread.sleep(200);
    }
    while (cluster.getMaster() == null || !cluster.getMaster().isInitialized()) {
      Thread.sleep(200);
    }
    Assert.assertTrue(admin.balance(false));
  }
  finally {
    admin.close();
  }
}
