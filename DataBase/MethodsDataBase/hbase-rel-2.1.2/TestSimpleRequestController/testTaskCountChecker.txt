@Test public void testTaskCountChecker() throws InterruptedIOException {
  long heapSizeOfRow=12345;
  int maxTotalConcurrentTasks=100;
  int maxConcurrentTasksPerServer=2;
  int maxConcurrentTasksPerRegion=1;
  AtomicLong tasksInProgress=new AtomicLong(0);
  Map<ServerName,AtomicInteger> taskCounterPerServer=new HashMap<>();
  Map<byte[],AtomicInteger> taskCounterPerRegion=new HashMap<>();
  SimpleRequestController.TaskCountChecker checker=new SimpleRequestController.TaskCountChecker(maxTotalConcurrentTasks,maxConcurrentTasksPerServer,maxConcurrentTasksPerRegion,tasksInProgress,taskCounterPerServer,taskCounterPerRegion);
  for (int i=0; i != 10; ++i) {
    ReturnCode code=checker.canTakeOperation(LOC1,heapSizeOfRow);
    assertEquals(ReturnCode.INCLUDE,code);
  }
  ReturnCode code=checker.canTakeOperation(LOC1,heapSizeOfRow);
  assertEquals(ReturnCode.INCLUDE,code);
  checker.notifyFinal(code,LOC1,heapSizeOfRow);
  taskCounterPerRegion.put(LOC1.getRegionInfo().getRegionName(),new AtomicInteger(100));
  taskCounterPerServer.put(LOC1.getServerName(),new AtomicInteger(100));
  for (int i=0; i != maxConcurrentTasksPerRegion * 5; ++i) {
    ReturnCode includeCode=checker.canTakeOperation(LOC1,heapSizeOfRow);
    assertEquals(ReturnCode.INCLUDE,includeCode);
    checker.notifyFinal(includeCode,LOC1,heapSizeOfRow);
  }
  taskCounterPerRegion.put(LOC3.getRegionInfo().getRegionName(),new AtomicInteger(100));
  taskCounterPerServer.put(LOC3.getServerName(),new AtomicInteger(100));
  for (int i=0; i != maxConcurrentTasksPerRegion * 5; ++i) {
    ReturnCode excludeCode=checker.canTakeOperation(LOC3,heapSizeOfRow);
    assertNotEquals(ReturnCode.INCLUDE,excludeCode);
    checker.notifyFinal(excludeCode,LOC3,heapSizeOfRow);
  }
  taskCounterPerRegion.put(LOC3.getRegionInfo().getRegionName(),new AtomicInteger(0));
  taskCounterPerServer.put(LOC3.getServerName(),new AtomicInteger(0));
  ReturnCode code3=checker.canTakeOperation(LOC3,heapSizeOfRow);
  assertEquals(ReturnCode.INCLUDE,code3);
  checker.notifyFinal(code3,LOC3,heapSizeOfRow);
  for (int i=0; i != maxConcurrentTasksPerRegion * 5; ++i) {
    ReturnCode includeCode=checker.canTakeOperation(LOC3,heapSizeOfRow);
    assertEquals(ReturnCode.INCLUDE,includeCode);
    checker.notifyFinal(includeCode,LOC3,heapSizeOfRow);
  }
  checker.reset();
  for (int i=0; i != maxConcurrentTasksPerRegion * 5; ++i) {
    ReturnCode includeCode=checker.canTakeOperation(LOC1,heapSizeOfRow);
    assertNotEquals(ReturnCode.INCLUDE,includeCode);
    checker.notifyFinal(includeCode,LOC1,heapSizeOfRow);
  }
}
