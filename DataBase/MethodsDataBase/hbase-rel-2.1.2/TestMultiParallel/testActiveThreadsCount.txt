/** 
 * This is for testing the active number of threads that were used while doing a batch operation. It inserts one row per region via the batch operation, and then checks the number of active threads. <p/> For HBASE-3553
 */
@Test public void testActiveThreadsCount() throws Exception {
  UTIL.getConfiguration().setLong("hbase.htable.threads.coresize",slaves + 1);
  try (Connection connection=ConnectionFactory.createConnection(UTIL.getConfiguration())){
    ThreadPoolExecutor executor=HTable.getDefaultExecutor(UTIL.getConfiguration());
    try {
      try (Table t=connection.getTable(TEST_TABLE,executor)){
        List<Put> puts=constructPutRequests();
        t.batch(puts,null);
        HashSet<ServerName> regionservers=new HashSet<>();
        try (RegionLocator locator=connection.getRegionLocator(TEST_TABLE)){
          for (          Row r : puts) {
            HRegionLocation location=locator.getRegionLocation(r.getRow());
            regionservers.add(location.getServerName());
          }
        }
         assertEquals(regionservers.size(),executor.getLargestPoolSize());
      }
     }
  finally {
      executor.shutdownNow();
    }
  }
 }
