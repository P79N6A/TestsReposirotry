/** 
 * This simulates an remote exception which should cause LIHF to exit with an exception.
 */
@Test(expected=IOException.class) public void testGroupOrSplitFailure() throws Exception {
  final TableName tableName=TableName.valueOf(name.getMethodName());
  try (Connection connection=ConnectionFactory.createConnection(util.getConfiguration())){
    setupTable(connection,tableName,10);
    LoadIncrementalHFiles lih=new LoadIncrementalHFiles(util.getConfiguration()){
      int i=0;
      @Override protected Pair<List<LoadQueueItem>,String> groupOrSplit(      Multimap<ByteBuffer,LoadQueueItem> regionGroups,      final LoadQueueItem item,      final Table table,      final Pair<byte[][],byte[][]> startEndKeys) throws IOException {
        i++;
        if (i == 5) {
          throw new IOException("failure");
        }
        return super.groupOrSplit(regionGroups,item,table,startEndKeys);
      }
    }
;
    Path dir=buildBulkFiles(tableName,1);
    try (Table t=connection.getTable(tableName);RegionLocator locator=connection.getRegionLocator(tableName);Admin admin=connection.getAdmin()){
      lih.doBulkLoad(dir,admin,t,locator);
    }
   }
   fail("doBulkLoad should have thrown an exception");
}
