@Test public void testRollbackAndDoubleExecutionOffline() throws Exception {
  final TableName tableName=TableName.valueOf(name.getMethodName());
  final String familyName="cf2";
  final ProcedureExecutor<MasterProcedureEnv> procExec=getMasterProcedureExecutor();
  RegionInfo[] regions=MasterProcedureTestingUtility.createTable(procExec,tableName,null,"cf1");
  UTIL.getAdmin().disableTable(tableName);
  ProcedureTestingUtility.waitNoProcedureRunning(procExec);
  ProcedureTestingUtility.setKillAndToggleBeforeStoreUpdate(procExec,true);
  TableDescriptor td=UTIL.getAdmin().getDescriptor(tableName);
  TableDescriptor newTd=TableDescriptorBuilder.newBuilder(td).setCompactionEnabled(!td.isCompactionEnabled()).setColumnFamily(ColumnFamilyDescriptorBuilder.of(familyName)).setRegionReplication(3).build();
  long procId=procExec.submitProcedure(new ModifyTableProcedure(procExec.getEnvironment(),newTd));
  int lastStep=3;
  MasterProcedureTestingUtility.testRollbackAndDoubleExecution(procExec,procId,lastStep);
  MasterProcedureTestingUtility.validateTableCreation(UTIL.getHBaseCluster().getMaster(),tableName,regions,"cf1");
}
