/** 
 * Test that the contract from the master for checking on a snapshot are valid. <p> <ol> <li>If a snapshot fails with an error, we expect to get the source error.</li> <li>If there is no snapshot name supplied, we should get an error.</li> <li>If asking about a snapshot has hasn't occurred, you should get an error.</li> </ol>
 */
@Test public void testIsDoneContract() throws Exception {
  IsSnapshotDoneRequest.Builder builder=IsSnapshotDoneRequest.newBuilder();
  String snapshotName="asyncExpectedFailureTest";
  SnapshotTestingUtils.expectSnapshotDoneException(master,builder.build(),UnknownSnapshotException.class);
  SnapshotDescription desc=SnapshotDescription.newBuilder().setName(snapshotName).setTable(TABLE_NAME.getNameAsString()).build();
  builder.setSnapshot(desc);
  SnapshotTestingUtils.expectSnapshotDoneException(master,builder.build(),UnknownSnapshotException.class);
  DisabledTableSnapshotHandler mockHandler=Mockito.mock(DisabledTableSnapshotHandler.class);
  Mockito.when(mockHandler.getException()).thenReturn(null);
  Mockito.when(mockHandler.getSnapshot()).thenReturn(desc);
  Mockito.when(mockHandler.isFinished()).thenReturn(Boolean.TRUE);
  Mockito.when(mockHandler.getCompletionTimestamp()).thenReturn(EnvironmentEdgeManager.currentTime());
  master.getSnapshotManager().setSnapshotHandlerForTesting(TABLE_NAME,mockHandler);
  builder=IsSnapshotDoneRequest.newBuilder();
  SnapshotTestingUtils.expectSnapshotDoneException(master,builder.build(),UnknownSnapshotException.class);
  builder.setSnapshot(desc);
  IsSnapshotDoneResponse response=master.getMasterRpcServices().isSnapshotDone(null,builder.build());
  assertTrue("Snapshot didn't complete when it should have.",response.getDone());
  builder.setSnapshot(SnapshotDescription.newBuilder().setName("Not A Snapshot").build());
  SnapshotTestingUtils.expectSnapshotDoneException(master,builder.build(),UnknownSnapshotException.class);
  snapshotName="completed";
  desc=createSnapshot(snapshotName);
  builder.setSnapshot(desc);
  response=master.getMasterRpcServices().isSnapshotDone(null,builder.build());
  assertTrue("Completed, on-disk snapshot not found",response.getDone());
}
