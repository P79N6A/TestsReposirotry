/** 
 * When a new client with procedure support tries to ask an old-master without proc-support the procedure result we get a DoNotRetryIOException (which is an UnsupportedOperationException) The future should trap that and fallback to the waitOperationResult(). This happens when the operation calls happens on a "new master" but while we are waiting the operation to be completed, we failover on an "old master".
 */
@Test public void testOnServerWithNoProcedureSupport() throws Exception {
  HBaseAdmin admin=Mockito.mock(HBaseAdmin.class);
  TestFuture f=new TestFuture(admin,100L){
    @Override protected GetProcedureResultResponse getProcedureResult(    final GetProcedureResultRequest request) throws IOException {
      super.getProcedureResult(request);
      throw new DoNotRetryIOException(new UnsupportedOperationException("getProcedureResult"));
    }
  }
;
  f.get(1,TimeUnit.MINUTES);
  assertTrue("expected getProcedureResult() to be called",f.wasGetProcedureResultCalled());
  assertFalse("unexpected convertResult() called",f.wasConvertResultCalled());
  assertTrue("expected waitOperationResult() to be called",f.wasWaitOperationResultCalled());
  assertTrue("expected postOperationResult() to be called",f.wasPostOperationResultCalled());
}
