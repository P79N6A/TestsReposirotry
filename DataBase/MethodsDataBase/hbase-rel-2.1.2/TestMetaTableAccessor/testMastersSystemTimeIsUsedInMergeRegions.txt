@Test public void testMastersSystemTimeIsUsedInMergeRegions() throws IOException {
  long regionId=System.currentTimeMillis();
  RegionInfo regionInfoA=RegionInfoBuilder.newBuilder(TableName.valueOf(name.getMethodName())).setStartKey(HConstants.EMPTY_START_ROW).setEndKey(new byte[]{'a'}).setSplit(false).setRegionId(regionId).setReplicaId(0).build();
  RegionInfo regionInfoB=RegionInfoBuilder.newBuilder(TableName.valueOf(name.getMethodName())).setStartKey(new byte[]{'a'}).setEndKey(HConstants.EMPTY_END_ROW).setSplit(false).setRegionId(regionId).setReplicaId(0).build();
  RegionInfo mergedRegionInfo=RegionInfoBuilder.newBuilder(TableName.valueOf(name.getMethodName())).setStartKey(HConstants.EMPTY_START_ROW).setEndKey(HConstants.EMPTY_END_ROW).setSplit(false).setRegionId(regionId).setReplicaId(0).build();
  ServerName sn=ServerName.valueOf("bar",0,0);
  try (Table meta=MetaTableAccessor.getMetaHTable(connection)){
    List<RegionInfo> regionInfos=Lists.newArrayList(regionInfoA,regionInfoB);
    MetaTableAccessor.addRegionsToMeta(connection,regionInfos,1);
    long serverNameTime=EnvironmentEdgeManager.currentTime() + 100000000;
    long masterSystemTime=EnvironmentEdgeManager.currentTime() + 123456789;
    MetaTableAccessor.updateRegionLocation(connection,regionInfoA,sn,1,serverNameTime);
    Get get=new Get(mergedRegionInfo.getRegionName());
    Result result=meta.get(get);
    Cell serverCell=result.getColumnLatestCell(HConstants.CATALOG_FAMILY,MetaTableAccessor.getServerColumn(0));
    assertNotNull(serverCell);
    assertEquals(serverNameTime,serverCell.getTimestamp());
    ManualEnvironmentEdge edge=new ManualEnvironmentEdge();
    edge.setValue(masterSystemTime);
    EnvironmentEdgeManager.injectEdge(edge);
    try {
      MetaTableAccessor.mergeRegions(connection,mergedRegionInfo,regionInfoA,-1L,regionInfoB,-1L,sn,1);
    }
  finally {
      EnvironmentEdgeManager.reset();
    }
    result=meta.get(get);
    serverCell=result.getColumnLatestCell(HConstants.CATALOG_FAMILY,MetaTableAccessor.getServerColumn(0));
    Cell startCodeCell=result.getColumnLatestCell(HConstants.CATALOG_FAMILY,MetaTableAccessor.getStartCodeColumn(0));
    Cell seqNumCell=result.getColumnLatestCell(HConstants.CATALOG_FAMILY,MetaTableAccessor.getSeqNumColumn(0));
    assertNull(serverCell);
    assertNull(startCodeCell);
    assertNull(seqNumCell);
  }
 }
