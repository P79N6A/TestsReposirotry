@Test @SuppressWarnings("unchecked") public void testMoreResults() throws IOException {
  final Result[] results1=new Result[1];
  KeyValue kv1=new KeyValue(Bytes.toBytes("row"),Bytes.toBytes("cf"),Bytes.toBytes("cq"),1,Type.Maximum);
  results1[0]=Result.create(new Cell[]{kv1});
  final Result[] results2=new Result[1];
  KeyValue kv2=new KeyValue(Bytes.toBytes("row2"),Bytes.toBytes("cf"),Bytes.toBytes("cq"),1,Type.Maximum);
  results2[0]=Result.create(new Cell[]{kv2});
  RpcRetryingCaller<Result[]> caller=Mockito.mock(RpcRetryingCaller.class);
  Mockito.when(rpcFactory.<Result[]>newCaller()).thenReturn(caller);
  Mockito.when(caller.callWithoutRetries(Mockito.any(),Mockito.anyInt())).thenAnswer(new Answer<Result[]>(){
    private int count=0;
    @Override public Result[] answer(    InvocationOnMock invocation) throws Throwable {
      ScannerCallableWithReplicas callable=invocation.getArgument(0);
switch (count) {
case 0:
        count++;
      callable.currentScannerCallable.setMoreResultsInRegion(MoreResults.YES);
    return results1;
case 1:
  count++;
callable.currentScannerCallable.setMoreResultsInRegion(MoreResults.NO);
return results2;
case 2:
count++;
return null;
default :
throw new RuntimeException("Expected only 3 invocations");
}
}
}
);
scan.setCaching(100);
scan.setMaxResultSize(1000 * 1000);
try (MockClientScanner scanner=new MockClientScanner(conf,scan,TableName.valueOf(name.getMethodName()),clusterConn,rpcFactory,controllerFactory,pool,Integer.MAX_VALUE)){
InOrder inOrder=Mockito.inOrder(caller);
scanner.setRpcFinished(true);
scanner.loadCache();
inOrder.verify(caller,Mockito.times(2)).callWithoutRetries(Mockito.any(),Mockito.anyInt());
assertEquals(2,scanner.cache.size());
Result r=scanner.cache.poll();
assertNotNull(r);
CellScanner cs=r.cellScanner();
assertTrue(cs.advance());
assertEquals(kv1,cs.current());
assertFalse(cs.advance());
r=scanner.cache.poll();
assertNotNull(r);
cs=r.cellScanner();
assertTrue(cs.advance());
assertEquals(kv2,cs.current());
assertFalse(cs.advance());
}
 }
