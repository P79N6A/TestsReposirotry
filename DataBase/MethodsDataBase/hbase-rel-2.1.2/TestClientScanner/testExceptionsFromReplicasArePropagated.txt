/** 
 * Tests the case where all replicas of a region throw an exception. It should not cause a hang but the exception should propagate to the client
 */
@Test public void testExceptionsFromReplicasArePropagated() throws IOException {
  scan.setConsistency(Consistency.TIMELINE);
  rpcFactory=new MockRpcRetryingCallerFactory(conf);
  conf.set(RpcRetryingCallerFactory.CUSTOM_CALLER_CONF_KEY,MockRpcRetryingCallerFactory.class.getName());
  when(clusterConn.locateRegion((TableName)any(),(byte[])any(),anyBoolean(),anyBoolean(),anyInt())).thenReturn(new RegionLocations(null,null,null));
  try (MockClientScanner scanner=new MockClientScanner(conf,scan,TableName.valueOf(name.getMethodName()),clusterConn,rpcFactory,new RpcControllerFactory(conf),pool,Integer.MAX_VALUE)){
    Iterator<Result> iter=scanner.iterator();
    while (iter.hasNext()) {
      iter.next();
    }
    fail("Should have failed with RetriesExhaustedException");
  }
 catch (  RuntimeException expected) {
    assertThat(expected.getCause(),instanceOf(RetriesExhaustedException.class));
  }
}
