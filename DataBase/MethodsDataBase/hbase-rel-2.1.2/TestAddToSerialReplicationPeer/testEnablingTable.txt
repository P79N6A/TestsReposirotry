@Test public void testEnablingTable() throws Exception {
  TableName tableName=createTable();
  try (Table table=UTIL.getConnection().getTable(tableName)){
    for (int i=0; i < 100; i++) {
      table.put(new Put(Bytes.toBytes(i)).addColumn(CF,CQ,Bytes.toBytes(i)));
    }
  }
   RegionInfo region=UTIL.getAdmin().getRegions(tableName).get(0);
  HRegionServer rs=UTIL.getOtherRegionServer(UTIL.getRSForFirstRegionInTable(tableName));
  moveRegionAndArchiveOldWals(region,rs);
  TableStateManager tsm=UTIL.getMiniHBaseCluster().getMaster().getTableStateManager();
  tsm.setTableState(tableName,TableState.State.ENABLING);
  Thread t=new Thread(() -> {
    try {
      addPeer(true);
    }
 catch (    IOException e) {
      throw new RuntimeException(e);
    }
  }
);
  t.start();
  Thread.sleep(5000);
  assertTrue(t.isAlive());
  tsm.setTableState(tableName,TableState.State.ENABLED);
  t.join();
  try (Table table=UTIL.getConnection().getTable(tableName)){
    for (int i=0; i < 100; i++) {
      table.put(new Put(Bytes.toBytes(i)).addColumn(CF,CQ,Bytes.toBytes(i)));
    }
  }
   waitUntilReplicationDone(100);
  checkOrder(100);
}
