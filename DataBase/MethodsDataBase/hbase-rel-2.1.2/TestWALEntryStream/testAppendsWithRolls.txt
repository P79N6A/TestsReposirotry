/** 
 * Tests basic reading of log appends
 */
@Test public void testAppendsWithRolls() throws Exception {
  appendToLogAndSync();
  long oldPos;
  try (WALEntryStream entryStream=new WALEntryStream(walQueue,fs,CONF,0,log,null,new MetricsSource("1"))){
    assertTrue(entryStream.hasNext());
    WAL.Entry entry=entryStream.peek();
    assertSame(entry,entryStream.next());
    assertNotNull(entry);
    assertFalse(entryStream.hasNext());
    assertNull(entryStream.peek());
    assertNull(entryStream.next());
    oldPos=entryStream.getPosition();
  }
   appendToLogAndSync();
  try (WALEntryStream entryStream=new WALEntryStream(walQueue,fs,CONF,oldPos,log,null,new MetricsSource("1"))){
    WAL.Entry entry=entryStream.next();
    assertNotEquals(oldPos,entryStream.getPosition());
    assertNotNull(entry);
    oldPos=entryStream.getPosition();
  }
   appendToLogAndSync();
  log.rollWriter();
  appendToLogAndSync();
  try (WALEntryStream entryStream=new WALEntryStream(walQueue,fs,CONF,oldPos,log,null,new MetricsSource("1"))){
    WAL.Entry entry=entryStream.next();
    assertNotEquals(oldPos,entryStream.getPosition());
    assertNotNull(entry);
    entry=entryStream.next();
    assertNotEquals(oldPos,entryStream.getPosition());
    assertNotNull(entry);
    assertFalse(entryStream.hasNext());
    oldPos=entryStream.getPosition();
  }
 }
