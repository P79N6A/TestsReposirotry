/** 
 * Tests that if after a stream is opened, more entries come in and then the log is rolled, we don't mistakenly dequeue the current log thinking we're done with it
 */
@Test public void testLogrollWhileStreaming() throws Exception {
  appendToLog("1");
  appendToLog("2");
  try (WALEntryStream entryStream=new WALEntryStream(walQueue,fs,CONF,0,log,null,new MetricsSource("1"))){
    assertEquals("1",getRow(entryStream.next()));
    appendToLog("3");
    log.rollWriter();
    appendToLog("4");
    assertEquals("2",getRow(entryStream.next()));
    assertEquals(2,walQueue.size());
    assertEquals("3",getRow(entryStream.next()));
    assertEquals("4",getRow(entryStream.next()));
    assertEquals(1,walQueue.size());
    assertFalse(entryStream.hasNext());
  }
 }
