@Test public void testReplicationSourceWALReader() throws Exception {
  appendEntriesToLogAndSync(3);
  long position;
  try (WALEntryStream entryStream=new WALEntryStream(walQueue,fs,CONF,0,log,null,new MetricsSource("1"))){
    entryStream.next();
    entryStream.next();
    entryStream.next();
    position=entryStream.getPosition();
  }
   Path walPath=walQueue.peek();
  ReplicationSourceWALReader reader=createReader(false,CONF);
  WALEntryBatch entryBatch=reader.take();
  assertNotNull(entryBatch);
  assertEquals(3,entryBatch.getWalEntries().size());
  assertEquals(position,entryBatch.getLastWalPosition());
  assertEquals(walPath,entryBatch.getLastWalPath());
  assertEquals(3,entryBatch.getNbRowKeys());
  appendToLog("foo");
  entryBatch=reader.take();
  assertEquals(1,entryBatch.getNbEntries());
  assertEquals("foo",getRow(entryBatch.getWalEntries().get(0)));
}
