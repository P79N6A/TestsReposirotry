@Test public void testReplicationSourceWALReaderRecovered() throws Exception {
  appendEntriesToLogAndSync(10);
  Path walPath=walQueue.peek();
  log.rollWriter();
  appendEntriesToLogAndSync(5);
  log.shutdown();
  Configuration conf=new Configuration(CONF);
  conf.setInt("replication.source.nb.capacity",10);
  ReplicationSourceWALReader reader=createReader(true,conf);
  WALEntryBatch batch=reader.take();
  assertEquals(walPath,batch.getLastWalPath());
  assertEquals(10,batch.getNbEntries());
  assertFalse(batch.isEndOfFile());
  batch=reader.take();
  assertEquals(walPath,batch.getLastWalPath());
  assertEquals(0,batch.getNbEntries());
  assertTrue(batch.isEndOfFile());
  walPath=walQueue.peek();
  batch=reader.take();
  assertEquals(walPath,batch.getLastWalPath());
  assertEquals(5,batch.getNbEntries());
  assertFalse(batch.isEndOfFile());
  assertSame(WALEntryBatch.NO_MORE_DATA,reader.take());
}
