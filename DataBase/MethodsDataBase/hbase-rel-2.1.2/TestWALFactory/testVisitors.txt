/** 
 * Test that we can visit entries before they are appended
 * @throws Exception
 */
@Test public void testVisitors() throws Exception {
  final int COL_COUNT=10;
  final TableName tableName=TableName.valueOf(currentTest.getMethodName());
  final byte[] row=Bytes.toBytes("row");
  final DumbWALActionsListener visitor=new DumbWALActionsListener();
  final MultiVersionConcurrencyControl mvcc=new MultiVersionConcurrencyControl(1);
  long timestamp=System.currentTimeMillis();
  NavigableMap<byte[],Integer> scopes=new TreeMap<>(Bytes.BYTES_COMPARATOR);
  scopes.put(Bytes.toBytes("column"),0);
  RegionInfo hri=RegionInfoBuilder.newBuilder(tableName).build();
  final WAL log=wals.getWAL(hri);
  log.registerWALActionsListener(visitor);
  for (int i=0; i < COL_COUNT; i++) {
    WALEdit cols=new WALEdit();
    cols.add(new KeyValue(row,Bytes.toBytes("column"),Bytes.toBytes(Integer.toString(i)),timestamp,new byte[]{(byte)(i + '0')}));
    log.append(hri,new WALKeyImpl(hri.getEncodedNameAsBytes(),tableName,System.currentTimeMillis(),mvcc,scopes),cols,true);
  }
  log.sync();
  assertEquals(COL_COUNT,visitor.increments);
  log.unregisterWALActionsListener(visitor);
  WALEdit cols=new WALEdit();
  cols.add(new KeyValue(row,Bytes.toBytes("column"),Bytes.toBytes(Integer.toString(11)),timestamp,new byte[]{(byte)(11 + '0')}));
  log.append(hri,new WALKeyImpl(hri.getEncodedNameAsBytes(),tableName,System.currentTimeMillis(),mvcc,scopes),cols,true);
  log.sync();
  assertEquals(COL_COUNT,visitor.increments);
}
