@Test public void testReplicatorBatching() throws Exception {
  truncateTable(utility1,tableName);
  truncateTable(utility2,tableName);
  admin.addPeer("testReplicatorBatching",new ReplicationPeerConfig().setClusterKey(utility2.getClusterKey()).setReplicationEndpointImpl(ReplicationEndpointForTest.class.getName()),null);
  ReplicationEndpointForTest.setBatchCount(0);
  ReplicationEndpointForTest.setEntriesCount(0);
  try {
    ReplicationEndpointForTest.pause();
    try {
      final byte[] valueBytes=new byte[8 * 1024];
      for (int i=0; i < NUM_ROWS; i++) {
        htable1.put(new Put(Bytes.toBytes("row" + Integer.toString(i))).addColumn(famName,null,valueBytes));
      }
    }
  finally {
      ReplicationEndpointForTest.resume();
    }
    Waiter.waitFor(conf1,60000,new Waiter.ExplainingPredicate<Exception>(){
      @Override public boolean evaluate() throws Exception {
        LOG.info("Count=" + ReplicationEndpointForTest.getBatchCount());
        return ReplicationEndpointForTest.getBatchCount() >= NUM_ROWS;
      }
      @Override public String explainFailure() throws Exception {
        return "We waited too long for expected replication of " + NUM_ROWS + " entries";
      }
    }
);
    assertEquals("We sent an incorrect number of batches",NUM_ROWS,ReplicationEndpointForTest.getBatchCount());
    assertEquals("We did not replicate enough rows",NUM_ROWS,utility2.countRows(htable2));
  }
  finally {
    admin.removePeer("testReplicatorBatching");
  }
}
