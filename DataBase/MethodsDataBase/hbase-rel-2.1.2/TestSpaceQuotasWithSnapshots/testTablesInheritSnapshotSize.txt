@Test public void testTablesInheritSnapshotSize() throws Exception {
  TableName tn=helper.createTableWithRegions(1);
  LOG.info("Writing data");
  QuotaSettings settings=QuotaSettingsFactory.limitTableSpace(tn,SpaceQuotaHelperForTests.ONE_GIGABYTE,SpaceViolationPolicy.NO_INSERTS);
  admin.setQuota(settings);
  final long initialSize=2L * SpaceQuotaHelperForTests.ONE_MEGABYTE;
  helper.writeData(tn,initialSize);
  LOG.info("Waiting until table size reflects written data");
  TEST_UTIL.waitFor(30 * 1000,500,new SpaceQuotaSnapshotPredicate(conn,tn){
    @Override boolean evaluate(    SpaceQuotaSnapshot snapshot) throws Exception {
      return snapshot.getUsage() >= initialSize;
    }
  }
);
  waitForStableQuotaSize(conn,tn,null);
  final long actualInitialSize=QuotaTableUtil.getCurrentSnapshot(conn,tn).getUsage();
  LOG.info("Initial table size was " + actualInitialSize);
  LOG.info("Snapshot the table");
  final String snapshot1=tn.toString() + "_snapshot1";
  admin.snapshot(snapshot1,tn);
  LOG.info("Write more data");
  helper.writeData(tn,initialSize);
  LOG.info("Flush the table");
  admin.flush(tn);
  LOG.info("Synchronously compacting the table");
  TEST_UTIL.compact(tn,true);
  final long upperBound=initialSize + FUDGE_FOR_TABLE_SIZE;
  final long lowerBound=initialSize - FUDGE_FOR_TABLE_SIZE;
  LOG.info("Waiting for the region reports to reflect the correct size, between (" + lowerBound + ", "+ upperBound+ ")");
  TEST_UTIL.waitFor(30 * 1000,500,new Predicate<Exception>(){
    @Override public boolean evaluate() throws Exception {
      long size=getRegionSizeReportForTable(conn,tn);
      return size < upperBound && size > lowerBound;
    }
  }
);
  waitForStableRegionSizeReport(conn,tn);
  final long finalSize=getRegionSizeReportForTable(conn,tn);
  assertNotNull("Did not expect to see a null size",finalSize);
  LOG.info("Last seen size: " + finalSize);
  TEST_UTIL.waitFor(20 * 1000,500,new SpaceQuotaSnapshotPredicate(conn,tn){
    @Override public boolean evaluate(    SpaceQuotaSnapshot snapshot) throws Exception {
      return snapshot.getUsage() >= finalSize;
    }
  }
);
  long expectedFinalSize=actualInitialSize + finalSize;
  LOG.info("Expecting table usage to be " + actualInitialSize + " + "+ finalSize+ " = "+ expectedFinalSize);
  TEST_UTIL.waitFor(30 * 1000,1000,new SpaceQuotaSnapshotPredicate(conn,tn){
    @Override boolean evaluate(    SpaceQuotaSnapshot snapshot) throws Exception {
      LOG.debug("Checking for " + expectedFinalSize + " == "+ snapshot.getUsage());
      return expectedFinalSize == snapshot.getUsage();
    }
  }
);
  Map<String,Long> snapshotSizes=QuotaTableUtil.getObservedSnapshotSizes(conn);
  Long size=snapshotSizes.get(snapshot1);
  assertNotNull("Did not observe the size of the snapshot",size);
  assertEquals("The recorded size of the HBase snapshot was not the size we expected",actualInitialSize,size.longValue());
}
