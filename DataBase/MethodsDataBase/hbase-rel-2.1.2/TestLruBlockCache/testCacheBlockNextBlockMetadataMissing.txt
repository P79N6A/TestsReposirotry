@Test public void testCacheBlockNextBlockMetadataMissing(){
  long maxSize=100000;
  long blockSize=calculateBlockSize(maxSize,10);
  int size=100;
  int length=HConstants.HFILEBLOCK_HEADER_SIZE + size;
  byte[] byteArr=new byte[length];
  ByteBuffer buf=ByteBuffer.wrap(byteArr,0,size);
  HFileContext meta=new HFileContextBuilder().build();
  HFileBlock blockWithNextBlockMetadata=new HFileBlock(BlockType.DATA,size,size,-1,buf,HFileBlock.FILL_HEADER,-1,52,-1,meta);
  HFileBlock blockWithoutNextBlockMetadata=new HFileBlock(BlockType.DATA,size,size,-1,buf,HFileBlock.FILL_HEADER,-1,-1,-1,meta);
  LruBlockCache cache=new LruBlockCache(maxSize,blockSize,false,(int)Math.ceil(1.2 * maxSize / blockSize),LruBlockCache.DEFAULT_LOAD_FACTOR,LruBlockCache.DEFAULT_CONCURRENCY_LEVEL,0.66f,0.99f,0.33f,0.33f,0.34f,1.2f,false,1024);
  BlockCacheKey key=new BlockCacheKey("key1",0);
  ByteBuffer actualBuffer=ByteBuffer.allocate(length);
  ByteBuffer block1Buffer=ByteBuffer.allocate(length);
  ByteBuffer block2Buffer=ByteBuffer.allocate(length);
  blockWithNextBlockMetadata.serialize(block1Buffer,true);
  blockWithoutNextBlockMetadata.serialize(block2Buffer,true);
  CacheTestUtils.getBlockAndAssertEquals(cache,key,blockWithNextBlockMetadata,actualBuffer,block1Buffer);
  CacheTestUtils.getBlockAndAssertEquals(cache,key,blockWithoutNextBlockMetadata,actualBuffer,block1Buffer);
  cache.clearCache();
  assertNull(cache.getBlock(key,false,false,false));
  CacheTestUtils.getBlockAndAssertEquals(cache,key,blockWithoutNextBlockMetadata,actualBuffer,block2Buffer);
  CacheTestUtils.getBlockAndAssertEquals(cache,key,blockWithNextBlockMetadata,actualBuffer,block1Buffer);
}
