/** 
 * Test Case for HBASE-21551
 */
@Test public void testStreamReadersCleanup() throws IOException {
  Set<StoreFileReader> streamReaders=getStreamReaders();
  Assert.assertEquals(0,getStreamReaders().size());
  try (RegionScannerImpl scanner=REGION.getScanner(new Scan().setReadType(ReadType.STREAM))){
    StoreScanner storeScanner=(StoreScanner)(scanner).getStoreHeapForTesting().getCurrentForTesting();
    List<StoreFileScanner> sfScanners=storeScanner.getAllScannersForTesting().stream().filter(kvs -> kvs instanceof StoreFileScanner).map(kvs -> (StoreFileScanner)kvs).collect(Collectors.toList());
    Assert.assertEquals(1,sfScanners.size());
    StoreFileScanner sfScanner=sfScanners.get(0);
    Assert.assertFalse(sfScanner.getReader().shared);
    Assert.assertEquals(1,getStreamReaders().size());
  }
   Assert.assertEquals(0,getStreamReaders().size());
  RegionScannerImpl scanner=REGION.getScanner(new Scan().setReadType(ReadType.STREAM));
  Assert.assertNotNull(scanner);
  Assert.assertEquals(1,getStreamReaders().size());
  REGION.close();
  Assert.assertEquals(0,streamReaders.size());
}
