@Test public void test() throws IOException {
  try (RegionScannerImpl scanner=REGION.getScanner(new Scan())){
    StoreScanner storeScanner=(StoreScanner)(scanner).getStoreHeapForTesting().getCurrentForTesting();
    for (    KeyValueScanner kvs : storeScanner.getAllScannersForTesting()) {
      if (kvs instanceof StoreFileScanner) {
        StoreFileScanner sfScanner=(StoreFileScanner)kvs;
        assertTrue(sfScanner.getReader().shared);
      }
    }
    List<Cell> cells=new ArrayList<>();
    for (int i=0; i < 500; i++) {
      assertTrue(scanner.next(cells));
      Result result=Result.create(cells);
      assertEquals(VALUE_PREFIX + i,Bytes.toString(result.getValue(FAMILY,QUAL)));
      cells.clear();
      scanner.shipped();
    }
    for (    KeyValueScanner kvs : storeScanner.getAllScannersForTesting()) {
      if (kvs instanceof StoreFileScanner) {
        StoreFileScanner sfScanner=(StoreFileScanner)kvs;
        assertFalse(sfScanner.getReader().shared);
      }
    }
    for (int i=500; i < 1000; i++) {
      assertEquals(i != 999,scanner.next(cells));
      Result result=Result.create(cells);
      assertEquals(VALUE_PREFIX + i,Bytes.toString(result.getValue(FAMILY,QUAL)));
      cells.clear();
      scanner.shipped();
    }
  }
   for (  HStoreFile sf : REGION.getStore(FAMILY).getStorefiles()) {
    assertFalse(sf.isReferencedInReads());
  }
}
