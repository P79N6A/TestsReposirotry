/** 
 * Verify that compression and data block encoding are respected by the Store.createWriterInTmp() method, used on store flush.
 */
@Test public void testCreateWriter() throws Exception {
  Configuration conf=HBaseConfiguration.create();
  FileSystem fs=FileSystem.get(conf);
  ColumnFamilyDescriptor hcd=ColumnFamilyDescriptorBuilder.newBuilder(family).setCompressionType(Compression.Algorithm.GZ).setDataBlockEncoding(DataBlockEncoding.DIFF).build();
  init(name.getMethodName(),conf,hcd);
  StoreFileWriter writer=store.createWriterInTmp(4,hcd.getCompressionType(),false,true,false,false);
  Path path=writer.getPath();
  writer.append(new KeyValue(row,family,qf1,Bytes.toBytes(1)));
  writer.append(new KeyValue(row,family,qf2,Bytes.toBytes(2)));
  writer.append(new KeyValue(row2,family,qf1,Bytes.toBytes(3)));
  writer.append(new KeyValue(row2,family,qf2,Bytes.toBytes(4)));
  writer.close();
  HFile.Reader reader=HFile.createReader(fs,path,new CacheConfig(conf),true,conf);
  assertEquals(hcd.getCompressionType(),reader.getCompressionAlgorithm());
  assertEquals(hcd.getDataBlockEncoding(),reader.getDataBlockEncoding());
  reader.close();
}
