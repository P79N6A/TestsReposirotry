/** 
 * TestCase for HBASE-21355
 */
@Test public void testGetRegionInfo() throws Exception {
  final TableName tableName=TableName.valueOf(name.getMethodName());
  Table table=TEST_UTIL.createTable(tableName,Bytes.toBytes("f"));
  for (int i=0; i < 100; i++) {
    table.put(new Put(Bytes.toBytes(i)).addColumn(Bytes.toBytes("f"),Bytes.toBytes("q"),Bytes.toBytes(i)));
  }
  admin.flush(tableName);
  HRegionServer rs=TEST_UTIL.getRSForFirstRegionInTable(table.getName());
  List<HRegion> regions=rs.getRegions(tableName);
  Assert.assertEquals(1,regions.size());
  HRegion region=regions.get(0);
  byte[] regionName=region.getRegionInfo().getRegionName();
  HStore store=region.getStore(Bytes.toBytes("f"));
  long expectedStoreFilesSize=store.getStorefilesSize();
  Assert.assertNotNull(store);
  Assert.assertEquals(expectedStoreFilesSize,store.getSize());
  ClusterConnection conn=((ClusterConnection)admin.getConnection());
  HBaseRpcController controller=conn.getRpcControllerFactory().newController();
  for (int i=0; i < 10; i++) {
    RegionInfo ri=ProtobufUtil.getRegionInfo(controller,conn.getAdmin(rs.getServerName()),regionName);
    Assert.assertEquals(region.getRegionInfo(),ri);
    Assert.assertEquals(expectedStoreFilesSize,store.getSize());
  }
}
