@Test public void testBasicRegionSizeReports() throws Exception {
  final long bytesWritten=5L * 1024L * 1024L;
  final TableName tn=writeData(bytesWritten);
  LOG.debug("Data was written to HBase");
  final Admin admin=TEST_UTIL.getAdmin();
  admin.flush(tn);
  LOG.debug("Data flushed to disk");
  final List<RegionInfo> regions=TEST_UTIL.getAdmin().getRegions(tn);
  HMaster master=cluster.getMaster();
  MasterQuotaManager quotaManager=master.getMasterQuotaManager();
  Map<RegionInfo,Long> regionSizes=quotaManager.snapshotRegionSizes();
  int observedRegions=numRegionsForTable(tn,regionSizes);
  while (observedRegions < regions.size()) {
    LOG.debug("Expecting more regions. Saw " + observedRegions + " region sizes reported, expected at least "+ regions.size());
    Thread.sleep(1000);
    regionSizes=quotaManager.snapshotRegionSizes();
    observedRegions=numRegionsForTable(tn,regionSizes);
  }
  LOG.debug("Observed region sizes by the HMaster: " + regionSizes);
  long totalRegionSize=0L;
  for (  Long regionSize : regionSizes.values()) {
    totalRegionSize+=regionSize;
  }
  assertTrue("Expected region size report to exceed " + bytesWritten + ", but was "+ totalRegionSize+ ". RegionSizes="+ regionSizes,bytesWritten < totalRegionSize);
}
