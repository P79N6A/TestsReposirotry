/** 
 * Tests that the master does not call retainAssignment after recovery from expired zookeeper session. Without the HBASE-6046 fix master always tries to assign all the user regions by calling retainAssignment.
 */
@Test public void testRegionAssignmentAfterMasterRecoveryDueToZKExpiry() throws Exception {
  MiniHBaseCluster cluster=TEST_UTIL.getHBaseCluster();
  cluster.startRegionServer();
  cluster.waitForActiveAndReadyMaster(10000);
  HMaster m=cluster.getMaster();
  final ZKWatcher zkw=m.getZooKeeper();
  try (Admin admin=TEST_UTIL.getAdmin()){
    byte[][] SPLIT_KEYS=new byte[][]{Bytes.toBytes("a"),Bytes.toBytes("b"),Bytes.toBytes("c"),Bytes.toBytes("d"),Bytes.toBytes("e"),Bytes.toBytes("f"),Bytes.toBytes("g"),Bytes.toBytes("h"),Bytes.toBytes("i"),Bytes.toBytes("j")};
    TableDescriptor htd=TableDescriptorBuilder.newBuilder(TableName.valueOf(name.getMethodName())).setColumnFamily(ColumnFamilyDescriptorBuilder.of(HConstants.CATALOG_FAMILY)).build();
    admin.createTable(htd,SPLIT_KEYS);
    TEST_UTIL.waitUntilNoRegionsInTransition(60000);
    m.getZooKeeper().close();
    MockLoadBalancer.retainAssignCalled=false;
    final int expectedNumOfListeners=countPermanentListeners(zkw);
    m.abort("Test recovery from zk session expired",new KeeperException.SessionExpiredException());
    assertTrue(m.isStopped());
    assertFalse("Retain assignment should not be called",MockLoadBalancer.retainAssignCalled);
    cluster.waitForActiveAndReadyMaster(120000);
    final HMaster newMaster=cluster.getMasterThread().getMaster();
    assertEquals(expectedNumOfListeners,countPermanentListeners(newMaster.getZooKeeper()));
  }
 }
