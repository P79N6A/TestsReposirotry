/** 
 * Test that if a store file with the same name is present as those already backed up cause the already archived files to be timestamped backup
 */
@Test public void testDuplicateHFileResolution() throws Exception {
  TableDescriptor td=createTableDescriptorForCurrentMethod();
  HRegionInfo parent=new HRegionInfo(td.getTableName(),Bytes.toBytes("aaa"),Bytes.toBytes("eee"));
  HRegionInfo splita=new HRegionInfo(td.getTableName(),Bytes.toBytes("aaa"),Bytes.toBytes("ccc"));
  HRegionInfo splitb=new HRegionInfo(td.getTableName(),Bytes.toBytes("ccc"),Bytes.toBytes("eee"));
  Result r=createResult(parent,splita,splitb);
  FileSystem fs=FileSystem.get(HTU.getConfiguration());
  Path rootdir=this.masterServices.getMasterFileSystem().getRootDir();
  FSUtils.setRootDir(fs.getConf(),rootdir);
  Path tabledir=FSUtils.getTableDir(rootdir,parent.getTable());
  Path storedir=HStore.getStoreHomedir(tabledir,parent,td.getColumnFamilies()[0].getName());
  System.out.println("Old root:" + rootdir);
  System.out.println("Old table:" + tabledir);
  System.out.println("Old store:" + storedir);
  Path storeArchive=HFileArchiveUtil.getStoreArchivePath(this.masterServices.getConfiguration(),parent,tabledir,td.getColumnFamilies()[0].getName());
  System.out.println("Old archive:" + storeArchive);
  addMockStoreFiles(2,this.masterServices,storedir);
  FileStatus[] storeFiles=fs.listStatus(storedir);
  assertTrue(janitor.cleanParent(parent,r));
  Path parentDir=new Path(tabledir,parent.getEncodedName());
  ProcedureTestingUtility.waitAllProcedures(masterServices.getMasterProcedureExecutor());
  assertTrue(!fs.exists(parentDir));
  FileStatus[] archivedStoreFiles=fs.listStatus(storeArchive);
  assertArchiveEqualToOriginal(storeFiles,archivedStoreFiles,fs);
  addMockStoreFiles(2,this.masterServices,storedir);
  assertTrue(janitor.cleanParent(parent,r));
  ProcedureTestingUtility.waitAllProcedures(masterServices.getMasterProcedureExecutor());
  assertTrue(!fs.exists(parentDir));
  archivedStoreFiles=fs.listStatus(storeArchive);
  assertArchiveEqualToOriginal(storeFiles,archivedStoreFiles,fs,true);
}
