/** 
 * test of that unmanaged HConnections are able to reconnect properly (see HBASE-5058)
 */
@Test public void testUnmanagedHConnectionReconnect() throws Exception {
  final TableName tableName=TableName.valueOf(name.getMethodName());
  TEST_UTIL.createTable(tableName,HConstants.CATALOG_FAMILY);
  Connection conn=ConnectionFactory.createConnection(TEST_UTIL.getConfiguration());
  Table t=conn.getTable(tableName);
  try (Admin admin=conn.getAdmin()){
    assertTrue(admin.tableExists(tableName));
    assertTrue(t.get(new Get(ROW)).isEmpty());
  }
   MiniHBaseCluster cluster=TEST_UTIL.getHBaseCluster();
  cluster.stopMaster(0,false);
  cluster.waitOnMaster(0);
  cluster.startMaster();
  assertTrue(cluster.waitForActiveAndReadyMaster());
  boolean tablesOnMaster=LoadBalancer.isTablesOnMaster(TEST_UTIL.getConfiguration());
  try (Admin admin=conn.getAdmin()){
    assertTrue(admin.tableExists(tableName));
    assertTrue(admin.getClusterMetrics(EnumSet.of(Option.LIVE_SERVERS)).getLiveServerMetrics().size() == SLAVES + (tablesOnMaster ? 1 : 0));
  }
 }
