/** 
 * Test for HBASE-17125
 */
@Test public void testReadWithFilter() throws Exception {
  Admin admin=TEST_UTIL.getAdmin();
  final TableName tableName=TableName.valueOf(name.getMethodName());
  Table table=TEST_UTIL.createTable(tableName,FAMILY,3);
  byte[] VALUEA=Bytes.toBytes("value-a");
  byte[] VALUEB=Bytes.toBytes("value-b");
  long[] ts={1000,2000,3000,4000};
  Put put=new Put(ROW);
  for (int t=0; t <= 3; t++) {
    if (t <= 1) {
      put.addColumn(FAMILY,QUALIFIER,ts[t],VALUEA);
    }
 else {
      put.addColumn(FAMILY,QUALIFIER,ts[t],VALUEB);
    }
  }
  table.put(put);
  Scan scan=new Scan().setFilter(new ValueFilter(CompareOperator.EQUAL,new SubstringComparator("value-a"))).setMaxVersions(3);
  ResultScanner scanner=table.getScanner(scan);
  Result result=scanner.next();
  assertNResult(result,ROW,FAMILY,QUALIFIER,new long[]{ts[1]},new byte[][]{VALUEA},0,0);
  Get get=new Get(ROW).setFilter(new ValueFilter(CompareOperator.EQUAL,new SubstringComparator("value-a"))).setMaxVersions(3);
  result=table.get(get);
  assertNResult(result,ROW,FAMILY,QUALIFIER,new long[]{ts[1]},new byte[][]{VALUEA},0,0);
  scan=new Scan().setFilter(new ValueFilter(CompareOperator.EQUAL,new SubstringComparator("value-a"))).setMaxVersions(1);
  scanner=table.getScanner(scan);
  result=scanner.next();
  assertNResult(result,ROW,FAMILY,QUALIFIER,new long[]{ts[1]},new byte[][]{VALUEA},0,0);
  get=new Get(ROW).setFilter(new ValueFilter(CompareOperator.EQUAL,new SubstringComparator("value-a"))).setMaxVersions(1);
  result=table.get(get);
  assertNResult(result,ROW,FAMILY,QUALIFIER,new long[]{ts[1]},new byte[][]{VALUEA},0,0);
  scan=new Scan().setFilter(new ValueFilter(CompareOperator.EQUAL,new SubstringComparator("value-a"))).setMaxVersions(5);
  scanner=table.getScanner(scan);
  result=scanner.next();
  assertNResult(result,ROW,FAMILY,QUALIFIER,new long[]{ts[1]},new byte[][]{VALUEA},0,0);
  get=new Get(ROW).setFilter(new ValueFilter(CompareOperator.EQUAL,new SubstringComparator("value-a"))).setMaxVersions(5);
  result=table.get(get);
  assertNResult(result,ROW,FAMILY,QUALIFIER,new long[]{ts[1]},new byte[][]{VALUEA},0,0);
  table.close();
  admin.close();
}
