/** 
 * see HBASE-18132 This is a test case of failing open a wal(for replication for example) after all datanode restarted (rolling upgrade, for example). Before this patch, low replication detection is only used when syncing wal. But if the wal haven't had any entry whiten, it will never know all the replica of the wal is broken(because of dn restarting). And this wal can never be open
 * @throws Exception
 */
@Test public void test() throws Exception {
  HRegionServer server=TEST_UTIL.getHBaseCluster().getRegionServer(0);
  AbstractFSWAL<?> wal=(AbstractFSWAL<?>)server.getWAL(null);
  Path currentFile=wal.getCurrentFileName();
  for (int i=0, n=TEST_UTIL.getDFSCluster().getDataNodes().size(); i < n; i++) {
    TEST_UTIL.getDFSCluster().restartDataNode(0);
    Thread.sleep(DN_RESTART_INTERVAL);
  }
  if (!server.getFileSystem().exists(currentFile)) {
    Path walRootDir=FSUtils.getWALRootDir(TEST_UTIL.getConfiguration());
    final Path oldLogDir=new Path(walRootDir,HConstants.HREGION_OLDLOGDIR_NAME);
    currentFile=new Path(oldLogDir,currentFile.getName());
  }
  try (WAL.Reader reader=WALFactory.createReader(TEST_UTIL.getTestFileSystem(),currentFile,TEST_UTIL.getConfiguration())){
    reader.next();
  }
 }
