@Test public void testMoveRegion() throws Exception {
  admin.balancerSwitch(false).join();
  RegionInfo hri=createTableAndGetOneRegion(tableName);
  RawAsyncHBaseAdmin rawAdmin=(RawAsyncHBaseAdmin)ASYNC_CONN.getAdmin();
  ServerName serverName=rawAdmin.getRegionLocation(hri.getRegionName()).get().getServerName();
  HMaster master=TEST_UTIL.getHBaseCluster().getMaster();
  ServerManager serverManager=master.getServerManager();
  ServerName destServerName=null;
  List<JVMClusterUtil.RegionServerThread> regionServers=TEST_UTIL.getHBaseCluster().getLiveRegionServerThreads();
  for (  JVMClusterUtil.RegionServerThread regionServer : regionServers) {
    HRegionServer destServer=regionServer.getRegionServer();
    destServerName=destServer.getServerName();
    if (!destServerName.equals(serverName) && serverManager.isServerOnline(destServerName)) {
      break;
    }
  }
  assertTrue(destServerName != null && !destServerName.equals(serverName));
  admin.move(hri.getRegionName(),destServerName).get();
  long timeoutTime=System.currentTimeMillis() + 30000;
  while (true) {
    ServerName sn=rawAdmin.getRegionLocation(hri.getRegionName()).get().getServerName();
    if (sn != null && sn.equals(destServerName)) {
      break;
    }
    long now=System.currentTimeMillis();
    if (now > timeoutTime) {
      fail("Failed to move the region in time: " + hri);
    }
    Thread.sleep(100);
  }
  admin.balancerSwitch(true).join();
}
