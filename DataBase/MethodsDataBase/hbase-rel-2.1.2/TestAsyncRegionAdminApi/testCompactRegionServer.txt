@Test public void testCompactRegionServer() throws Exception {
  byte[][] families={Bytes.toBytes("f1"),Bytes.toBytes("f2"),Bytes.toBytes("f3")};
  createTableWithDefaultConf(tableName,null,families);
  loadData(tableName,families,3000,8);
  List<HRegionServer> rsList=TEST_UTIL.getHBaseCluster().getLiveRegionServerThreads().stream().map(rsThread -> rsThread.getRegionServer()).collect(Collectors.toList());
  List<Region> regions=new ArrayList<>();
  rsList.forEach(rs -> regions.addAll(rs.getRegions(tableName)));
  assertEquals(1,regions.size());
  int countBefore=countStoreFilesInFamilies(regions,families);
  assertTrue(countBefore > 0);
  for (  HRegionServer rs : rsList)   admin.compactRegionServer(rs.getServerName()).get();
  Thread.sleep(5000);
  int countAfterMinorCompaction=countStoreFilesInFamilies(regions,families);
  assertTrue(countAfterMinorCompaction < countBefore);
  for (  HRegionServer rs : rsList)   admin.majorCompactRegionServer(rs.getServerName()).get();
  Thread.sleep(5000);
  int countAfterMajorCompaction=countStoreFilesInFamilies(regions,families);
  assertEquals(3,countAfterMajorCompaction);
}
