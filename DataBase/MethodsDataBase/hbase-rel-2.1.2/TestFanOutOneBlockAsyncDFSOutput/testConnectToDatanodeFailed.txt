@Test public void testConnectToDatanodeFailed() throws IOException, ClassNotFoundException, NoSuchMethodException, IllegalAccessException, InvocationTargetException, InterruptedException, NoSuchFieldException {
  Field xceiverServerDaemonField=DataNode.class.getDeclaredField("dataXceiverServer");
  xceiverServerDaemonField.setAccessible(true);
  Class<?> xceiverServerClass=Class.forName("org.apache.hadoop.hdfs.server.datanode.DataXceiverServer");
  Method numPeersMethod=xceiverServerClass.getDeclaredMethod("getNumPeers");
  numPeersMethod.setAccessible(true);
  DataNodeProperties dnProp=TEST_UTIL.getDFSCluster().stopDataNode(0);
  Path f=new Path("/test");
  EventLoop eventLoop=EVENT_LOOP_GROUP.next();
  try (FanOutOneBlockAsyncDFSOutput output=FanOutOneBlockAsyncDFSOutputHelper.createOutput(FS,f,true,false,(short)3,FS.getDefaultBlockSize(),eventLoop,CHANNEL_CLASS)){
    assertEquals(2,output.getPipeline().length);
  }
  finally {
    TEST_UTIL.getDFSCluster().restartDataNode(dnProp);
  }
}
