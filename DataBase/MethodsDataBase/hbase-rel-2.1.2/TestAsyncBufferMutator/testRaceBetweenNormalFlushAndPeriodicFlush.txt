@Test public void testRaceBetweenNormalFlushAndPeriodicFlush() throws InterruptedException, ExecutionException {
  Put put=new Put(Bytes.toBytes(0)).addColumn(CF,CQ,VALUE);
  try (AsyncBufferMutatorForTest mutator=new AsyncBufferMutatorForTest(AsyncConnectionImpl.RETRY_TIMER,CONN.getTable(TABLE_NAME),10 * put.heapSize(),TimeUnit.MILLISECONDS.toNanos(200))){
    CompletableFuture<?> future=mutator.mutate(put);
    Timeout task=mutator.periodicFlushTask;
    assertNotNull(task);
synchronized (mutator) {
      Thread.sleep(500);
      assertTrue(task.isExpired());
      assertEquals(0,mutator.flushCount);
      assertFalse(future.isDone());
      mutator.flush();
    }
    assertFalse(task.isCancelled());
    future.get();
    AsyncTable<?> table=CONN.getTable(TABLE_NAME);
    assertArrayEquals(VALUE,table.get(new Get(Bytes.toBytes(0))).get().getValue(CF,CQ));
    assertEquals(1,mutator.flushCount);
  }
 }
