/** 
 * Test that we deal with ServerCrashProcedure zero'ing out the targetServer in the RegionStateNode in the midst of our doing an assign. The trickery is done above in TargetServerBeingNulledOnUsAssignProcedure. We skip a bunch of logic to get at the guts where the problem happens (We also skip-out the failure handling because it'd take a bunch of mocking to get it to run). Fix is inside in RemoteProcedureDispatch#addOperationToNode. It now notices empty targetServer and just returns false so we fall into failure processing and we'll reassign elsewhere instead of NPE'ing. The fake of ServerCrashProcedure nulling out the targetServer happens inside in updateTransition just after it was called but before it gets to the near the end when addToRemoteDispatcher is called. See the TargetServerBeingNulledOnUsAssignProcedure class above. See HBASE-19218. Before fix, this test would fail w/ a NullPointerException.
 */
@Test public void testTargetServerBeingNulledOnUs() throws ProcedureSuspendedException, IOException {
  TableName tn=TableName.valueOf(this.name.getMethodName());
  RegionInfo ri=RegionInfoBuilder.newBuilder(tn).build();
  RegionStates.RegionStateNode rsn=new RegionStates.RegionStateNode(ri);
  rsn.setRegionLocation(ServerName.valueOf("server.example.org",0,0));
  MasterProcedureEnv env=Mockito.mock(MasterProcedureEnv.class);
  AssignmentManager am=Mockito.mock(AssignmentManager.class);
  ServerManager sm=Mockito.mock(ServerManager.class);
  Mockito.when(sm.isServerOnline(Mockito.any())).thenReturn(true);
  MasterServices ms=Mockito.mock(MasterServices.class);
  Mockito.when(ms.getServerManager()).thenReturn(sm);
  Configuration configuration=HBaseConfiguration.create();
  Mockito.when(ms.getConfiguration()).thenReturn(configuration);
  Mockito.when(env.getAssignmentManager()).thenReturn(am);
  Mockito.when(env.getMasterServices()).thenReturn(ms);
  RSProcedureDispatcher rsd=new RSProcedureDispatcher(ms);
  Mockito.when(env.getRemoteDispatcher()).thenReturn(rsd);
  TargetServerBeingNulledOnUsAssignProcedure assignProcedure=new TargetServerBeingNulledOnUsAssignProcedure(ri,rsn);
  assignProcedure.updateTransition(env,rsn);
  assertTrue(assignProcedure.remoteCallFailedWasCalled.get());
  assertTrue(assignProcedure.addToRemoteDispatcherWasCalled.get());
}
