@Test public void testPuttingBackChunksWithOpeningScanner() throws IOException {
  byte[] row=Bytes.toBytes("testrow");
  byte[] fam=Bytes.toBytes("testfamily");
  byte[] qf1=Bytes.toBytes("testqualifier1");
  byte[] qf2=Bytes.toBytes("testqualifier2");
  byte[] qf3=Bytes.toBytes("testqualifier3");
  byte[] qf4=Bytes.toBytes("testqualifier4");
  byte[] qf5=Bytes.toBytes("testqualifier5");
  byte[] qf6=Bytes.toBytes("testqualifier6");
  byte[] qf7=Bytes.toBytes("testqualifier7");
  byte[] val=Bytes.toBytes("testval");
  DefaultMemStore memstore=new DefaultMemStore();
  memstore.add(new KeyValue(row,fam,qf1,val),null);
  memstore.add(new KeyValue(row,fam,qf2,val),null);
  memstore.add(new KeyValue(row,fam,qf3,val),null);
  MemStoreSnapshot snapshot=memstore.snapshot();
  assertEquals(3,memstore.getSnapshot().getCellsCount());
  assertEquals(0,memstore.getActive().getCellsCount());
  memstore.add(new KeyValue(row,fam,qf4,val),null);
  memstore.add(new KeyValue(row,fam,qf5,val),null);
  assertEquals(2,memstore.getActive().getCellsCount());
  List<KeyValueScanner> scanners=memstore.getScanners(0);
  for (  KeyValueScanner scanner : snapshot.getScanners()) {
    scanner.close();
  }
  memstore.clearSnapshot(snapshot.getId());
  assertTrue(chunkCreator.getPoolSize() == 0);
  for (  KeyValueScanner scanner : scanners) {
    scanner.close();
  }
  assertTrue(chunkCreator.getPoolSize() > 0);
  chunkCreator.clearChunksInPool();
  snapshot=memstore.snapshot();
  memstore.add(new KeyValue(row,fam,qf6,val),null);
  memstore.add(new KeyValue(row,fam,qf7,val),null);
  scanners=memstore.getScanners(0);
  for (  KeyValueScanner scanner : scanners) {
    scanner.close();
  }
  for (  KeyValueScanner scanner : snapshot.getScanners()) {
    scanner.close();
  }
  memstore.clearSnapshot(snapshot.getId());
  assertTrue(chunkCreator.getPoolSize() > 0);
}
