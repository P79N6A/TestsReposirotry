@Test public void testIsStale() throws IOException {
  int period=0;
  byte[][] families=new byte[][]{Bytes.toBytes("cf")};
  byte[] qf=Bytes.toBytes("cq");
  HRegionServer regionServer=mock(HRegionServer.class);
  List<HRegion> regions=new ArrayList<>();
  when(regionServer.getOnlineRegionsLocalContext()).thenReturn(regions);
  when(regionServer.getConfiguration()).thenReturn(TEST_UTIL.getConfiguration());
  TableDescriptor htd=getTableDesc(TableName.valueOf(name.getMethodName()),2,families);
  HRegion primary=initHRegion(htd,HConstants.EMPTY_START_ROW,HConstants.EMPTY_END_ROW,0);
  HRegion replica1=initHRegion(htd,HConstants.EMPTY_START_ROW,HConstants.EMPTY_END_ROW,1);
  regions.add(primary);
  regions.add(replica1);
  StaleStorefileRefresherChore chore=new StaleStorefileRefresherChore(period,regionServer,new StoppableImplementation());
  putData(primary,0,100,qf,families);
  primary.flush(true);
  verifyData(primary,0,100,qf,families);
  verifyDataExpectFail(replica1,0,100,qf,families);
  chore.chore();
  verifyData(replica1,0,100,qf,families);
  ((FailingHRegionFileSystem)replica1.getRegionFileSystem()).fail=true;
  putData(primary,100,100,qf,families);
  primary.flush(true);
  verifyData(primary,0,200,qf,families);
  chore.chore();
  verifyData(replica1,0,100,qf,families);
  verifyDataExpectFail(replica1,100,100,qf,families);
  chore.isStale=true;
  chore.chore();
  try {
    verifyData(replica1,0,100,qf,families);
    fail("should have failed with IOException");
  }
 catch (  IOException ex) {
  }
}
