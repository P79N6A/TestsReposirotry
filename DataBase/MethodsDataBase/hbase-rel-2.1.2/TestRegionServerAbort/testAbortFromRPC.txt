/** 
 * Test that a regionserver is able to abort properly, even when a coprocessor throws an exception in preStopRegionServer().
 */
@Test public void testAbortFromRPC() throws Exception {
  TableName tableName=TableName.valueOf("testAbortFromRPC");
  Table table=testUtil.createTable(tableName,FAMILY_BYTES);
  testUtil.loadTable(table,FAMILY_BYTES);
  LOG.info("Wrote data");
  cluster.flushcache(tableName);
  LOG.info("Flushed table");
  Put put=new Put(new byte[]{0,0,0,0});
  put.addColumn(FAMILY_BYTES,Bytes.toBytes("c"),new byte[]{});
  put.setAttribute(StopBlockingRegionObserver.DO_ABORT,new byte[]{1});
  List<HRegion> regions=cluster.findRegionsForTable(tableName);
  HRegion firstRegion=cluster.findRegionsForTable(tableName).get(0);
  table.put(put);
  assertNotNull(firstRegion);
  assertNotNull(firstRegion.getRegionServerServices());
  LOG.info("isAborted = " + firstRegion.getRegionServerServices().isAborted());
  assertTrue(firstRegion.getRegionServerServices().isAborted());
  LOG.info("isStopped = " + firstRegion.getRegionServerServices().isStopped());
  assertTrue(firstRegion.getRegionServerServices().isStopped());
}
