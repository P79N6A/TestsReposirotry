@Test public void testCompactionTimestamps() throws Exception {
  createTableWithDefaultConf(tableName);
  AsyncTable<?> table=ASYNC_CONN.getTable(tableName);
  Optional<Long> ts=admin.getLastMajorCompactionTimestamp(tableName).get();
  assertFalse(ts.isPresent());
  Put p=new Put(Bytes.toBytes("row1"));
  p.addColumn(FAMILY,Bytes.toBytes("q"),Bytes.toBytes("v"));
  table.put(p).join();
  ts=admin.getLastMajorCompactionTimestamp(tableName).get();
  assertFalse(ts.isPresent());
  admin.flush(tableName).join();
  ts=admin.getLastMajorCompactionTimestamp(tableName).get();
  assertFalse(ts.isPresent());
  byte[] regionName=ASYNC_CONN.getRegionLocator(tableName).getRegionLocation(Bytes.toBytes("row1")).get().getRegion().getRegionName();
  Optional<Long> ts1=admin.getLastMajorCompactionTimestampForRegion(regionName).get();
  assertFalse(ts1.isPresent());
  p=new Put(Bytes.toBytes("row2"));
  p.addColumn(FAMILY,Bytes.toBytes("q"),Bytes.toBytes("v"));
  table.put(p).join();
  admin.flush(tableName).join();
  ts1=admin.getLastMajorCompactionTimestamp(tableName).get();
  assertFalse(ts1.isPresent());
  for (int i=0; i < 3; i++) {
    table.put(p).join();
    admin.flush(tableName).join();
  }
  admin.majorCompact(tableName).join();
  long curt=System.currentTimeMillis();
  long waitTime=10000;
  long endt=curt + waitTime;
  CompactionState state=admin.getCompactionState(tableName).get();
  LOG.info("Current compaction state 1 is " + state);
  while (state == CompactionState.NONE && curt < endt) {
    Thread.sleep(100);
    state=admin.getCompactionState(tableName).get();
    curt=System.currentTimeMillis();
    LOG.info("Current compaction state 2 is " + state);
  }
  if (state == CompactionState.MAJOR) {
    state=admin.getCompactionState(tableName).get();
    LOG.info("Current compaction state 3 is " + state);
    while (state != CompactionState.NONE && curt < endt) {
      Thread.sleep(10);
      state=admin.getCompactionState(tableName).get();
      LOG.info("Current compaction state 4 is " + state);
    }
  }
  Thread.sleep(TEST_UTIL.getConfiguration().getInt("hbase.regionserver.msginterval",3 * 1000) * 2);
  ts=admin.getLastMajorCompactionTimestamp(tableName).get();
  assertTrue(ts.isPresent());
  assertTrue(ts.get() > 0);
  ts1=admin.getLastMajorCompactionTimestampForRegion(regionName).get();
  assertTrue(ts1.isPresent());
  assertEquals(ts.get(),ts1.get());
  table.put(p).join();
  admin.flush(tableName).join();
  ts=admin.getLastMajorCompactionTimestamp(tableName).join();
  assertTrue(ts.isPresent());
  assertEquals(ts.get(),ts1.get());
  ts1=admin.getLastMajorCompactionTimestampForRegion(regionName).get();
  assertTrue(ts1.isPresent());
  assertEquals(ts.get(),ts1.get());
}
