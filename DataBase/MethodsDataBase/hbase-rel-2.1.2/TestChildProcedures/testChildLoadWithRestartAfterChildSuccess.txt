/** 
 * Test the state setting that happens after store to WAL; in particular the bit where we set the parent runnable again after its children have all completed successfully. See HBASE-20978.
 */
@Test public void testChildLoadWithRestartAfterChildSuccess() throws Exception {
  procEnv.toggleKillAfterStoreUpdate=true;
  TestRootProcedure proc=new TestRootProcedure();
  long procId=ProcedureTestingUtility.submitAndWait(procExecutor,proc);
  int restartCount=0;
  while (!procExecutor.isFinished(procId)) {
    ProcedureTestingUtility.restart(procExecutor);
    ProcedureTestingUtility.waitProcedure(procExecutor,proc);
    restartCount++;
  }
  assertEquals(4,restartCount);
  assertTrue("expected completed proc",procExecutor.isFinished(procId));
  ProcedureTestingUtility.assertProcNotFailed(procExecutor,procId);
}
