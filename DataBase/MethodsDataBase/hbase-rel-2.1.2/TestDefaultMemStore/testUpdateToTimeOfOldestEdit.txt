/** 
 * Tests that the timeOfOldestEdit is updated correctly for the various edit operations in memstore.
 * @throws Exception
 */
@Test public void testUpdateToTimeOfOldestEdit() throws Exception {
  try {
    EnvironmentEdgeForMemstoreTest edge=new EnvironmentEdgeForMemstoreTest();
    EnvironmentEdgeManager.injectEdge(edge);
    DefaultMemStore memstore=new DefaultMemStore();
    long t=memstore.timeOfOldestEdit();
    assertEquals(Long.MAX_VALUE,t);
    memstore.add(KeyValueTestUtil.create("r","f","q",100,"v"),null);
    t=memstore.timeOfOldestEdit();
    assertTrue(t == 1234);
    t=runSnapshot(memstore);
    memstore.add(KeyValueTestUtil.create("r","f","q",100,KeyValue.Type.Delete,"v"),null);
    t=memstore.timeOfOldestEdit();
    assertTrue(t == 1234);
    t=runSnapshot(memstore);
    List<Cell> l=new ArrayList<>();
    KeyValue kv1=KeyValueTestUtil.create("r","f","q",100,"v");
    kv1.setSequenceId(100);
    l.add(kv1);
    memstore.upsert(l,1000,null);
    t=memstore.timeOfOldestEdit();
    assertTrue(t == 1234);
  }
  finally {
    EnvironmentEdgeManager.reset();
  }
}
