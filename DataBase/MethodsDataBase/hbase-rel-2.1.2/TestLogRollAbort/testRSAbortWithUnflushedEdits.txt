/** 
 * Tests that RegionServer aborts if we hit an error closing the WAL when there are unsynced WAL edits.  See HBASE-4282.
 */
@Test public void testRSAbortWithUnflushedEdits() throws Exception {
  LOG.info("Starting testRSAbortWithUnflushedEdits()");
  TEST_UTIL.getConnection().getTable(TableName.META_TABLE_NAME).close();
  TableName tableName=TableName.valueOf(this.getClass().getSimpleName());
  TableDescriptor desc=TableDescriptorBuilder.newBuilder(tableName).setColumnFamily(ColumnFamilyDescriptorBuilder.of(HConstants.CATALOG_FAMILY)).build();
  admin.createTable(desc);
  Table table=TEST_UTIL.getConnection().getTable(tableName);
  try {
    HRegionServer server=TEST_UTIL.getRSForFirstRegionInTable(tableName);
    WAL log=server.getWAL(null);
    Put p=new Put(Bytes.toBytes("row2001"));
    p.addColumn(HConstants.CATALOG_FAMILY,Bytes.toBytes("col"),Bytes.toBytes(2001));
    table.put(p);
    log.sync();
    p=new Put(Bytes.toBytes("row2002"));
    p.addColumn(HConstants.CATALOG_FAMILY,Bytes.toBytes("col"),Bytes.toBytes(2002));
    table.put(p);
    dfsCluster.restartDataNodes();
    LOG.info("Restarted datanodes");
    try {
      log.rollWriter(true);
    }
 catch (    FailedLogCloseException flce) {
    }
catch (    Throwable t) {
      LOG.error(HBaseMarkers.FATAL,"FAILED TEST: Got wrong exception",t);
    }
  }
  finally {
    table.close();
  }
}
