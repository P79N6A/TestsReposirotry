/** 
 * Test the cluster startup bulk assignment which attempts to retain assignment info.
 * @throws Exception
 */
@Test public void testRetainAssignment() throws Exception {
  List<ServerAndLoad> servers=randomServers(10,10);
  List<RegionInfo> regions=randomRegions(100);
  Map<RegionInfo,ServerName> existing=new TreeMap<>(RegionInfo.COMPARATOR);
  for (int i=0; i < regions.size(); i++) {
    ServerName sn=servers.get(i % servers.size()).getServerName();
    ServerName snWithOldStartCode=ServerName.valueOf(sn.getHostname(),sn.getPort(),sn.getStartcode() - 10);
    existing.put(regions.get(i),snWithOldStartCode);
  }
  List<ServerName> listOfServerNames=getListOfServerNames(servers);
  Map<ServerName,List<RegionInfo>> assignment=loadBalancer.retainAssignment(existing,listOfServerNames);
  assertRetainedAssignment(existing,listOfServerNames,assignment);
  List<ServerAndLoad> servers2=new ArrayList<>(servers);
  servers2.add(randomServer(10));
  servers2.add(randomServer(10));
  listOfServerNames=getListOfServerNames(servers2);
  assignment=loadBalancer.retainAssignment(existing,listOfServerNames);
  assertRetainedAssignment(existing,listOfServerNames,assignment);
  List<ServerAndLoad> servers3=new ArrayList<>(servers);
  servers3.remove(0);
  servers3.remove(0);
  listOfServerNames=getListOfServerNames(servers3);
  assignment=loadBalancer.retainAssignment(existing,listOfServerNames);
  assertRetainedAssignment(existing,listOfServerNames,assignment);
}
