/** 
 * Tests the bulk assignment used during cluster startup. Round-robin. Should yield a balanced cluster so same invariant as the load balancer holds, all servers holding either floor(avg) or ceiling(avg).
 * @throws Exception
 */
@Test public void testBulkAssignment() throws Exception {
  List<ServerName> tmp=getListOfServerNames(randomServers(5,0));
  List<RegionInfo> hris=randomRegions(20);
  hris.add(RegionInfoBuilder.FIRST_META_REGIONINFO);
  tmp.add(master);
  Map<ServerName,List<RegionInfo>> plans=loadBalancer.roundRobinAssignment(hris,tmp);
  if (LoadBalancer.isTablesOnMaster(loadBalancer.getConf())) {
    assertTrue(plans.get(master).contains(RegionInfoBuilder.FIRST_META_REGIONINFO));
    assertEquals(1,plans.get(master).size());
  }
  int totalRegion=0;
  for (  List<RegionInfo> regions : plans.values()) {
    totalRegion+=regions.size();
  }
  assertEquals(hris.size(),totalRegion);
  for (  int[] mock : regionsAndServersMocks) {
    LOG.debug("testBulkAssignment with " + mock[0] + " regions and "+ mock[1]+ " servers");
    List<RegionInfo> regions=randomRegions(mock[0]);
    List<ServerAndLoad> servers=randomServers(mock[1],0);
    List<ServerName> list=getListOfServerNames(servers);
    Map<ServerName,List<RegionInfo>> assignments=loadBalancer.roundRobinAssignment(regions,list);
    float average=(float)regions.size() / servers.size();
    int min=(int)Math.floor(average);
    int max=(int)Math.ceil(average);
    if (assignments != null && !assignments.isEmpty()) {
      for (      List<RegionInfo> regionList : assignments.values()) {
        assertTrue(regionList.size() == min || regionList.size() == max);
      }
    }
    returnRegions(regions);
    returnServers(list);
  }
}
