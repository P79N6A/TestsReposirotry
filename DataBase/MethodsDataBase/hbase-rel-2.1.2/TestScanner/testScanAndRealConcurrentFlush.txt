/** 
 * Tests to do a concurrent flush (using a 2nd thread) while scanning.  This tests both the StoreScanner update readers and the transition from memstore -> snapshot -> store file.
 * @throws Exception
 */
@Test public void testScanAndRealConcurrentFlush() throws Exception {
  this.region=TEST_UTIL.createLocalHRegion(TESTTABLEDESC,null,null);
  Table hri=new RegionAsTable(region);
  try {
    LOG.info("Added: " + HBaseTestCase.addContent(hri,Bytes.toString(HConstants.CATALOG_FAMILY),Bytes.toString(HConstants.REGIONINFO_QUALIFIER)));
    int count=count(hri,-1,false);
    assertEquals(count,count(hri,100,true));
  }
 catch (  Exception e) {
    LOG.error("Failed",e);
    throw e;
  }
 finally {
    HBaseTestingUtility.closeRegionAndWAL(this.region);
  }
}
