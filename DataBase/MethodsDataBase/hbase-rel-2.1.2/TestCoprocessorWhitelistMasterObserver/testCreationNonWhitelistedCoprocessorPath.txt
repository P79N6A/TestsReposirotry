/** 
 * Test a table creation including a coprocessor path which is not whitelisted
 * @result Table will not be created due to the offending coprocessor
 */
@Test public void testCreationNonWhitelistedCoprocessorPath() throws Exception {
  Configuration conf=UTIL.getConfiguration();
  conf.set(CoprocessorHost.MASTER_COPROCESSOR_CONF_KEY,CoprocessorWhitelistMasterObserver.class.getName());
  conf.setStrings(CoprocessorWhitelistMasterObserver.CP_COPROCESSOR_WHITELIST_PATHS_KEY,new String[]{});
  conf.setInt("hbase.client.retries.number",5);
  UTIL.startMiniCluster();
  HTableDescriptor htd=new HTableDescriptor(TEST_TABLE);
  HColumnDescriptor hcd=new HColumnDescriptor(TEST_FAMILY);
  htd.addFamily(hcd);
  htd.addCoprocessor("net.clayb.hbase.coprocessor.NotWhitelisted",new Path("file:///notpermitted/couldnotpossiblyexist.jar"),Coprocessor.PRIORITY_USER,null);
  Connection connection=ConnectionFactory.createConnection(conf);
  Admin admin=connection.getAdmin();
  LOG.info("Creating Table");
  try {
    admin.createTable(htd);
    fail("Expected coprocessor to raise IOException");
  }
 catch (  IOException e) {
  }
  LOG.info("Done Creating Table");
  assertEquals(new HTableDescriptor[0],admin.listTables("^" + TEST_TABLE.getNameAsString() + "$"));
}
