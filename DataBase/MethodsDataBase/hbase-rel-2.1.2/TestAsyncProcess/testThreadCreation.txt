/** 
 * This test simulates multiple regions on 2 servers. We should have 2 multi requests and 2 threads: 1 per server, this whatever the number of regions.
 */
@Test public void testThreadCreation() throws Exception {
  final int NB_REGS=100;
  List<HRegionLocation> hrls=new ArrayList<>(NB_REGS);
  List<Get> gets=new ArrayList<>(NB_REGS);
  for (int i=0; i < NB_REGS; i++) {
    HRegionInfo hri=new HRegionInfo(DUMMY_TABLE,Bytes.toBytes(i * 10L),Bytes.toBytes(i * 10L + 9L),false,i);
    HRegionLocation hrl=new HRegionLocation(hri,i % 2 == 0 ? sn : sn2);
    hrls.add(hrl);
    Get get=new Get(Bytes.toBytes(i * 10L));
    gets.add(get);
  }
  MyConnectionImpl2 con=new MyConnectionImpl2(hrls);
  MyAsyncProcess ap=new MyAsyncProcess(con,CONF,con.nbThreads);
  HTable ht=(HTable)con.getTable(DUMMY_TABLE,ap.service);
  ht.multiAp=ap;
  ht.batch(gets,null);
  Assert.assertEquals(NB_REGS,ap.nbActions.get());
  Assert.assertEquals("1 multi response per server",2,ap.nbMultiResponse.get());
  Assert.assertEquals("1 thread per server",2,con.nbThreads.get());
  int nbReg=0;
  for (int i=0; i < NB_REGS; i++) {
    if (con.usedRegions[i])     nbReg++;
  }
  Assert.assertEquals("nbReg=" + nbReg,NB_REGS,nbReg);
}
