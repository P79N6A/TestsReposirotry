@Test public void testWriteBufferPeriodicFlushTimeoutMs() throws Exception {
  ClusterConnection conn=createHConnection();
  MyAsyncProcess ap=new MyAsyncProcess(conn,CONF);
  BufferedMutatorParams bufferParam=createBufferedMutatorParams(ap,DUMMY_TABLE);
  bufferParam.setWriteBufferPeriodicFlushTimeoutMs(1);
  bufferParam.setWriteBufferPeriodicFlushTimerTickMs(1);
  bufferParam.writeBufferSize(10000);
  BufferedMutatorImpl ht=new BufferedMutatorImpl(conn,bufferParam,ap);
  Assert.assertEquals(10000,ht.getWriteBufferSize());
  Assert.assertEquals(1,ht.getWriteBufferPeriodicFlushTimeoutMs());
  Assert.assertEquals(BufferedMutator.MIN_WRITE_BUFFER_PERIODIC_FLUSH_TIMERTICK_MS,ht.getWriteBufferPeriodicFlushTimerTickMs());
  Put put=createPut(1,true);
  Assert.assertEquals(0,ht.getExecutedWriteBufferPeriodicFlushes());
  Assert.assertEquals(0,ht.getCurrentWriteBufferSize());
  ht.mutate(put);
  ht.flush();
  Thread.sleep(1000);
  Assert.assertEquals(0,ht.getExecutedWriteBufferPeriodicFlushes());
  Assert.assertEquals(0,ht.getCurrentWriteBufferSize());
  ht.mutate(put);
  Assert.assertEquals(0,ht.getExecutedWriteBufferPeriodicFlushes());
  Assert.assertTrue(ht.getCurrentWriteBufferSize() > 0);
  Thread.sleep(200);
  Assert.assertEquals(1,ht.getExecutedWriteBufferPeriodicFlushes());
  Assert.assertEquals(0,ht.getCurrentWriteBufferSize());
  Thread.sleep(200);
  Assert.assertEquals(1,ht.getExecutedWriteBufferPeriodicFlushes());
  Assert.assertEquals(0,ht.getCurrentWriteBufferSize());
  ht.disableWriteBufferPeriodicFlush();
  ht.mutate(put);
  Assert.assertEquals(1,ht.getExecutedWriteBufferPeriodicFlushes());
  Assert.assertTrue(ht.getCurrentWriteBufferSize() > 0);
  Thread.sleep(200);
  Assert.assertEquals(1,ht.getExecutedWriteBufferPeriodicFlushes());
  Assert.assertTrue(ht.getCurrentWriteBufferSize() > 0);
  ht.setWriteBufferPeriodicFlush(1,100);
  Thread.sleep(2000);
  Assert.assertEquals(2,ht.getExecutedWriteBufferPeriodicFlushes());
  Assert.assertEquals(0,ht.getCurrentWriteBufferSize());
}
