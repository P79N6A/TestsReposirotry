@Test public void testRemovePeerMetricsCleanup() throws Exception {
  final String peerId="DummyPeer";
  final ReplicationPeerConfig peerConfig=new ReplicationPeerConfig().setClusterKey("localhost:" + utility.getZkCluster().getClientPort() + ":/hbase");
  try {
    MetricsReplicationSourceSource globalSource=getGlobalSource();
    final int globalLogQueueSizeInitial=globalSource.getSizeOfLogQueue();
    final long sizeOfLatestPath=getSizeOfLatestPath();
    addPeerAndWait(peerId,peerConfig,true);
    assertEquals(sizeOfLatestPath + globalLogQueueSizeInitial,globalSource.getSizeOfLogQueue());
    ReplicationSourceInterface source=manager.getSource(peerId);
    assertNotNull(source);
    final int sizeOfSingleLogQueue=source.getSourceMetrics().getSizeOfLogQueue();
    source.enqueueLog(new Path("abc"));
    assertEquals(1 + sizeOfSingleLogQueue,source.getSourceMetrics().getSizeOfLogQueue());
    assertEquals(source.getSourceMetrics().getSizeOfLogQueue() + globalLogQueueSizeInitial,globalSource.getSizeOfLogQueue());
    removePeerAndWait(peerId);
    assertEquals(globalLogQueueSizeInitial,globalSource.getSizeOfLogQueue());
    addPeerAndWait(peerId,peerConfig,true);
    source=manager.getSource(peerId);
    assertNotNull(source);
    assertEquals(source.getSourceMetrics().getSizeOfLogQueue() + globalLogQueueSizeInitial,globalSource.getSizeOfLogQueue());
  }
  finally {
    removePeerAndWait(peerId);
  }
}
