/** 
 * Test whether calling removePeer() on a ReplicationSourceManager that failed on initializing the corresponding ReplicationSourceInterface correctly cleans up the corresponding replication queue and ReplicationPeer. See HBASE-16096.
 * @throws Exception
 */
@Test public void testPeerRemovalCleanup() throws Exception {
  String replicationSourceImplName=conf.get("replication.replicationsource.implementation");
  final String peerId="FakePeer";
  final ReplicationPeerConfig peerConfig=new ReplicationPeerConfig().setClusterKey("localhost:" + utility.getZkCluster().getClientPort() + ":/hbase");
  try {
    DummyServer server=new DummyServer();
    ReplicationQueueStorage rq=ReplicationStorageFactory.getReplicationQueueStorage(server.getZooKeeper(),server.getConfiguration());
    conf.set("replication.replicationsource.implementation",FailInitializeDummyReplicationSource.class.getName());
    final ReplicationPeers rp=manager.getReplicationPeers();
    addPeerAndWait(peerId,peerConfig,false);
    assertNull(manager.getSource(peerId));
    rq.addWAL(server.getServerName(),peerId,"FakeFile");
    removePeerAndWait(peerId);
    assertFalse(rq.getAllQueues(server.getServerName()).contains(peerId));
  }
  finally {
    conf.set("replication.replicationsource.implementation",replicationSourceImplName);
    removePeerAndWait(peerId);
  }
}
