/** 
 * Test a bunch of random allocations
 */
@Test public void testLABRandomAllocation(){
  Random rand=new Random();
  MemStoreLAB mslab=new MemStoreLABImpl();
  int expectedOff=0;
  ByteBuffer lastBuffer=null;
  int lastChunkId=-1;
  for (int i=0; i < 100000; i++) {
    int valSize=rand.nextInt(1000);
    KeyValue kv=new KeyValue(rk,cf,q,new byte[valSize]);
    int size=KeyValueUtil.length(kv);
    ByteBufferKeyValue newKv=(ByteBufferKeyValue)mslab.copyCellInto(kv);
    if (newKv.getBuffer() != lastBuffer) {
      expectedOff=Bytes.SIZEOF_INT;
      lastBuffer=newKv.getBuffer();
      int chunkId=newKv.getBuffer().getInt(0);
      assertTrue("chunkid should be different",chunkId != lastChunkId);
      lastChunkId=chunkId;
    }
    assertEquals(expectedOff,newKv.getOffset());
    assertTrue("Allocation overruns buffer",newKv.getOffset() + size <= newKv.getBuffer().capacity());
    expectedOff+=size;
  }
}
