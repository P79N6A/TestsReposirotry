@Test public void testCleanFinishedHandler() throws Exception {
  TableName tableName=TableName.valueOf(name.getMethodName());
  Configuration conf=UTIL.getConfiguration();
  try {
    conf.setLong(SnapshotManager.HBASE_SNAPSHOT_SENTINELS_CLEANUP_TIMEOUT_MILLIS,5 * 1000L);
    SnapshotManager manager=getNewManager(conf,1);
    TakeSnapshotHandler handler=Mockito.mock(TakeSnapshotHandler.class);
    assertFalse("Manager is in process when there is no current handler",manager.isTakingSnapshot(tableName));
    manager.setSnapshotHandlerForTesting(tableName,handler);
    Mockito.when(handler.isFinished()).thenReturn(false);
    assertTrue(manager.isTakingAnySnapshot());
    assertTrue("Manager isn't in process when handler is running",manager.isTakingSnapshot(tableName));
    Mockito.when(handler.isFinished()).thenReturn(true);
    assertFalse("Manager is process when handler isn't running",manager.isTakingSnapshot(tableName));
    assertTrue(manager.isTakingAnySnapshot());
    Thread.sleep(6 * 1000);
    assertFalse(manager.isTakingAnySnapshot());
  }
  finally {
    conf.unset(SnapshotManager.HBASE_SNAPSHOT_SENTINELS_CLEANUP_TIMEOUT_MILLIS);
  }
}
