@Test public void testLongPollRefresh() throws Exception {
  final String someKey="someKey";
  final String someValue="someValue";
  final String anotherValue="anotherValue";
  long someNotificationId=1;
  long pollTimeoutInMS=50;
  Map<String,String> configurations=Maps.newHashMap();
  configurations.put(someKey,someValue);
  ApolloConfig apolloConfig=assembleApolloConfig(configurations);
  ContextHandler configHandler=mockConfigServerHandler(HttpServletResponse.SC_OK,apolloConfig);
  ContextHandler pollHandler=mockPollNotificationHandler(pollTimeoutInMS,HttpServletResponse.SC_OK,Lists.newArrayList(new ApolloConfigNotification(apolloConfig.getNamespaceName(),someNotificationId)),false);
  startServerWithHandlers(configHandler,pollHandler);
  Config config=ConfigService.getAppConfig();
  assertEquals(someValue,config.getProperty(someKey,null));
  final SettableFuture<Boolean> longPollFinished=SettableFuture.create();
  config.addChangeListener(new ConfigChangeListener(){
    @Override public void onChange(    ConfigChangeEvent changeEvent){
      longPollFinished.set(true);
    }
  }
);
  apolloConfig.getConfigurations().put(someKey,anotherValue);
  longPollFinished.get(pollTimeoutInMS * 20,TimeUnit.MILLISECONDS);
  assertEquals(anotherValue,config.getProperty(someKey,null));
}
