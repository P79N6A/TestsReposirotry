@Test public void testQueryConfigWithPublicNamespaceAndAppOverride() throws Exception {
  String someAppSideReleaseKey="1";
  String somePublicAppSideReleaseKey="2";
  HttpServletResponse someResponse=mock(HttpServletResponse.class);
  String somePublicAppId="somePublicAppId";
  AppNamespace somePublicAppNamespace=assemblePublicAppNamespace(somePublicAppId,somePublicNamespaceName);
  when(someRelease.getConfigurations()).thenReturn("{\"apollo.public.foo\": \"foo-override\"}");
  when(somePublicRelease.getConfigurations()).thenReturn("{\"apollo.public.foo\": \"foo\", \"apollo.public.bar\": \"bar\"}");
  when(configService.loadConfig(someAppId,someClientIp,someAppId,someClusterName,somePublicNamespaceName,someDataCenter,someNotificationMessages)).thenReturn(someRelease);
  when(someRelease.getReleaseKey()).thenReturn(someAppSideReleaseKey);
  when(someRelease.getNamespaceName()).thenReturn(somePublicNamespaceName);
  when(appNamespaceService.findPublicNamespaceByName(somePublicNamespaceName)).thenReturn(somePublicAppNamespace);
  when(configService.loadConfig(someAppId,someClientIp,somePublicAppId,someClusterName,somePublicNamespaceName,someDataCenter,someNotificationMessages)).thenReturn(somePublicRelease);
  when(somePublicRelease.getReleaseKey()).thenReturn(somePublicAppSideReleaseKey);
  when(somePublicRelease.getAppId()).thenReturn(somePublicAppId);
  when(somePublicRelease.getClusterName()).thenReturn(someDataCenter);
  when(somePublicRelease.getNamespaceName()).thenReturn(somePublicNamespaceName);
  ApolloConfig result=configController.queryConfig(someAppId,someClusterName,somePublicNamespaceName,someDataCenter,someAppSideReleaseKey,someClientIp,someMessagesAsString,someRequest,someResponse);
  assertEquals(Joiner.on(ConfigConsts.CLUSTER_NAMESPACE_SEPARATOR).join(someAppSideReleaseKey,somePublicAppSideReleaseKey),result.getReleaseKey());
  assertEquals(someAppId,result.getAppId());
  assertEquals(someClusterName,result.getCluster());
  assertEquals(somePublicNamespaceName,result.getNamespaceName());
  assertEquals("foo-override",result.getConfigurations().get("apollo.public.foo"));
  assertEquals("bar",result.getConfigurations().get("apollo.public.bar"));
  verify(instanceConfigAuditUtil,times(1)).audit(someAppId,someClusterName,someDataCenter,someClientIp,someAppId,someClusterName,somePublicNamespaceName,someAppSideReleaseKey);
  verify(instanceConfigAuditUtil,times(1)).audit(someAppId,someClusterName,someDataCenter,someClientIp,somePublicAppId,someDataCenter,somePublicNamespaceName,somePublicAppSideReleaseKey);
}
