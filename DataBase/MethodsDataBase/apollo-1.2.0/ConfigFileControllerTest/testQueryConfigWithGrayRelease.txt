@Test public void testQueryConfigWithGrayRelease() throws Exception {
  String someKey="someKey";
  String someValue="someValue";
  Gson gson=new Gson();
  Type responseType=new TypeToken<Map<String,String>>(){
  }
.getType();
  Map<String,String> configurations=ImmutableMap.of(someKey,someValue);
  when(grayReleaseRulesHolder.hasGrayReleaseRule(someAppId,someClientIp,someNamespace)).thenReturn(true);
  ApolloConfig someApolloConfig=mock(ApolloConfig.class);
  when(someApolloConfig.getConfigurations()).thenReturn(configurations);
  when(configController.queryConfig(someAppId,someClusterName,someNamespace,someDataCenter,"-1",someClientIp,null,someRequest,someResponse)).thenReturn(someApolloConfig);
  ResponseEntity<String> response=configFileController.queryConfigAsJson(someAppId,someClusterName,someNamespace,someDataCenter,someClientIp,someRequest,someResponse);
  ResponseEntity<String> anotherResponse=configFileController.queryConfigAsJson(someAppId,someClusterName,someNamespace,someDataCenter,someClientIp,someRequest,someResponse);
  verify(configController,times(2)).queryConfig(someAppId,someClusterName,someNamespace,someDataCenter,"-1",someClientIp,null,someRequest,someResponse);
  assertEquals(HttpStatus.OK,response.getStatusCode());
  assertEquals(configurations,gson.fromJson(response.getBody(),responseType));
  assertTrue(watchedKeys2CacheKey.isEmpty());
  assertTrue(cacheKey2WatchedKeys.isEmpty());
}
