@Test public void testFindLatestActiveReleaseWithReleaseMessageNotification() throws Exception {
  long someNewNotificationId=someNotificationId + 1;
  ReleaseMessage anotherReleaseMessage=mock(ReleaseMessage.class);
  Release anotherRelease=mock(Release.class);
  when(releaseMessageService.findLatestReleaseMessageForMessages(Lists.newArrayList(someKey))).thenReturn(someReleaseMessage);
  when(releaseService.findLatestActiveRelease(someAppId,someClusterName,someNamespaceName)).thenReturn(someRelease);
  when(someReleaseMessage.getId()).thenReturn(someNotificationId);
  Release release=configServiceWithCache.findLatestActiveRelease(someAppId,someClusterName,someNamespaceName,someNotificationMessages);
  when(releaseMessageService.findLatestReleaseMessageForMessages(Lists.newArrayList(someKey))).thenReturn(anotherReleaseMessage);
  when(releaseService.findLatestActiveRelease(someAppId,someClusterName,someNamespaceName)).thenReturn(anotherRelease);
  when(anotherReleaseMessage.getMessage()).thenReturn(someKey);
  when(anotherReleaseMessage.getId()).thenReturn(someNewNotificationId);
  Release stillOldRelease=configServiceWithCache.findLatestActiveRelease(someAppId,someClusterName,someNamespaceName,someNotificationMessages);
  configServiceWithCache.handleMessage(anotherReleaseMessage,Topics.APOLLO_RELEASE_TOPIC);
  Release shouldBeNewRelease=configServiceWithCache.findLatestActiveRelease(someAppId,someClusterName,someNamespaceName,someNotificationMessages);
  assertEquals(someRelease,release);
  assertEquals(someRelease,stillOldRelease);
  assertEquals(anotherRelease,shouldBeNewRelease);
  verify(releaseMessageService,times(2)).findLatestReleaseMessageForMessages(Lists.newArrayList(someKey));
  verify(releaseService,times(2)).findLatestActiveRelease(someAppId,someClusterName,someNamespaceName);
}
