@Test public void testNewReleasesWithHandleMessage() throws Exception {
  String someMessageContent="someMessage";
  long someMessageId=1;
  ReleaseMessage someMessage=assembleReleaseMsg(someMessageId,someMessageContent);
  when(releaseMessageRepository.findFirst500ByIdGreaterThanOrderByIdAsc(0L)).thenReturn(Lists.newArrayList(someMessage));
  releaseMessageServiceWithCache.afterPropertiesSet();
  ReleaseMessage latestReleaseMsg=releaseMessageServiceWithCache.findLatestReleaseMessageForMessages(Sets.newHashSet(someMessageContent));
  List<ReleaseMessage> latestReleaseMsgGroupByMsgContent=releaseMessageServiceWithCache.findLatestReleaseMessagesGroupByMessages(Sets.newHashSet(someMessageContent));
  assertEquals(someMessageId,latestReleaseMsg.getId());
  assertEquals(someMessageContent,latestReleaseMsg.getMessage());
  assertEquals(latestReleaseMsg,latestReleaseMsgGroupByMsgContent.get(0));
  long newMessageId=2;
  ReleaseMessage newMessage=assembleReleaseMsg(newMessageId,someMessageContent);
  releaseMessageServiceWithCache.handleMessage(newMessage,Topics.APOLLO_RELEASE_TOPIC);
  ReleaseMessage newLatestReleaseMsg=releaseMessageServiceWithCache.findLatestReleaseMessageForMessages(Sets.newHashSet(someMessageContent));
  List<ReleaseMessage> newLatestReleaseMsgGroupByMsgContent=releaseMessageServiceWithCache.findLatestReleaseMessagesGroupByMessages(Sets.newHashSet(someMessageContent));
  assertEquals(newMessageId,newLatestReleaseMsg.getId());
  assertEquals(someMessageContent,newLatestReleaseMsg.getMessage());
  assertEquals(newLatestReleaseMsg,newLatestReleaseMsgGroupByMsgContent.get(0));
}
