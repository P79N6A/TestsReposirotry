/** 
 * Test used to verify the happy path of  {@link ThreadAsyncExecutor#startProcess(Callable)} when a task takes a whileto execute, while waiting on the result using  {@link ThreadAsyncExecutor#endProcess(AsyncResult)}
 */
@Test public void testEndProcess() throws Exception {
  assertTimeout(ofMillis(5000),() -> {
    final ThreadAsyncExecutor executor=new ThreadAsyncExecutor();
    final Object result=new Object();
    final Callable<Object> task=mock(Callable.class);
    when(task.call()).thenAnswer(i -> {
      Thread.sleep(1500);
      return result;
    }
);
    final AsyncResult<Object> asyncResult=executor.startProcess(task);
    assertNotNull(asyncResult);
    assertFalse(asyncResult.isCompleted());
    try {
      asyncResult.getValue();
      fail("Expected IllegalStateException when calling AsyncResult#getValue on a non-completed task");
    }
 catch (    IllegalStateException e) {
      assertNotNull(e.getMessage());
    }
    assertSame(result,executor.endProcess(asyncResult));
    verify(task,times(1)).call();
    assertTrue(asyncResult.isCompleted());
    assertSame(result,executor.endProcess(asyncResult));
    verifyNoMoreInteractions(task);
  }
);
}
