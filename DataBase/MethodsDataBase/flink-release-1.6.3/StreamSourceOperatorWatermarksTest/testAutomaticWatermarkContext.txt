@Test public void testAutomaticWatermarkContext() throws Exception {
  final StoppableStreamSource<String,InfiniteSource<String>> operator=new StoppableStreamSource<>(new InfiniteSource<String>());
  long watermarkInterval=10;
  TestProcessingTimeService processingTimeService=new TestProcessingTimeService();
  processingTimeService.setCurrentTime(0);
  setupSourceOperator(operator,TimeCharacteristic.IngestionTime,watermarkInterval,processingTimeService);
  final List<StreamElement> output=new ArrayList<>();
  StreamSourceContexts.getSourceContext(TimeCharacteristic.IngestionTime,operator.getContainingTask().getProcessingTimeService(),operator.getContainingTask().getCheckpointLock(),operator.getContainingTask().getStreamStatusMaintainer(),new CollectorOutput<String>(output),operator.getExecutionConfig().getAutoWatermarkInterval(),-1);
  for (long i=1; i < 100; i+=watermarkInterval) {
    processingTimeService.setCurrentTime(i);
  }
  assertTrue(output.size() == 9);
  long nextWatermark=0;
  for (  StreamElement el : output) {
    nextWatermark+=watermarkInterval;
    Watermark wm=(Watermark)el;
    assertTrue(wm.getTimestamp() == nextWatermark);
  }
}
