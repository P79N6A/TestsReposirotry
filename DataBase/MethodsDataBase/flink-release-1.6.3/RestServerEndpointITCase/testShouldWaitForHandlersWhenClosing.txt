/** 
 * Tests that after calling  {@link RestServerEndpoint#closeAsync()}, the handlers are closed first, and we wait for in-flight requests to finish. As long as not all handlers are closed, HTTP requests should be served.
 */
@Test public void testShouldWaitForHandlersWhenClosing() throws Exception {
  testHandler.closeFuture=new CompletableFuture<>();
  final HandlerBlocker handlerBlocker=new HandlerBlocker(timeout);
  testHandler.handlerBody=id -> {
    return CompletableFuture.supplyAsync(() -> {
      handlerBlocker.arriveAndBlock();
      return new TestResponse(id);
    }
);
  }
;
  final CompletableFuture<Void> closeRestServerEndpointFuture=serverEndpoint.closeAsync();
  assertThat(closeRestServerEndpointFuture.isDone(),is(false));
  final CompletableFuture<TestResponse> request=sendRequestToTestHandler(new TestRequest(1));
  handlerBlocker.awaitRequestToArrive();
  testHandler.closeFuture.complete(null);
  assertThat(closeRestServerEndpointFuture.isDone(),is(false));
  handlerBlocker.unblockRequest();
  request.get(timeout.getSize(),timeout.getUnit());
  closeRestServerEndpointFuture.get(timeout.getSize(),timeout.getUnit());
}
