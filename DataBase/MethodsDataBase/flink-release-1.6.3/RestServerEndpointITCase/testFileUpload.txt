/** 
 * Tests that multipart/form-data uploads work correctly.
 * @see FileUploadHandler
 */
@Test public void testFileUpload() throws Exception {
  final String boundary=generateMultiPartBoundary();
  final String crlf="\r\n";
  final String uploadedContent="hello";
  final HttpURLConnection connection=openHttpConnectionForUpload(boundary);
  try (OutputStream output=connection.getOutputStream();PrintWriter writer=new PrintWriter(new OutputStreamWriter(output,StandardCharsets.UTF_8),true)){
    writer.append("--" + boundary).append(crlf);
    writer.append("Content-Disposition: form-data; name=\"foo\"; filename=\"bar\"").append(crlf);
    writer.append("Content-Type: plain/text; charset=utf8").append(crlf);
    writer.append(crlf).flush();
    output.write(uploadedContent.getBytes(StandardCharsets.UTF_8));
    output.flush();
    writer.append(crlf).flush();
    writer.append("--" + boundary + "--").append(crlf).flush();
  }
   assertEquals(200,connection.getResponseCode());
  final byte[] lastUploadedFileContents=testUploadHandler.getLastUploadedFileContents();
  assertEquals(uploadedContent,new String(lastUploadedFileContents,StandardCharsets.UTF_8));
}
