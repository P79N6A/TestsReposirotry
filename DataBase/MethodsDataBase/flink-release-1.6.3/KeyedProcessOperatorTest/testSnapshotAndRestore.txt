@Test public void testSnapshotAndRestore() throws Exception {
  final int expectedKey=5;
  KeyedProcessOperator<Integer,Integer,String> operator=new KeyedProcessOperator<>(new BothTriggeringFlatMapFunction(expectedKey));
  OneInputStreamOperatorTestHarness<Integer,String> testHarness=new KeyedOneInputStreamOperatorTestHarness<>(operator,new IdentityKeySelector<Integer>(),BasicTypeInfo.INT_TYPE_INFO);
  testHarness.setup();
  testHarness.open();
  testHarness.processElement(new StreamRecord<>(expectedKey,12L));
  OperatorSubtaskState snapshot=testHarness.snapshot(0,0);
  testHarness.close();
  operator=new KeyedProcessOperator<>(new BothTriggeringFlatMapFunction(expectedKey));
  testHarness=new KeyedOneInputStreamOperatorTestHarness<>(operator,new IdentityKeySelector<Integer>(),BasicTypeInfo.INT_TYPE_INFO);
  testHarness.setup();
  testHarness.initializeState(snapshot);
  testHarness.open();
  testHarness.setProcessingTime(5);
  testHarness.processWatermark(new Watermark(6));
  ConcurrentLinkedQueue<Object> expectedOutput=new ConcurrentLinkedQueue<>();
  expectedOutput.add(new StreamRecord<>("PROC:1777"));
  expectedOutput.add(new StreamRecord<>("EVENT:1777",6L));
  expectedOutput.add(new Watermark(6));
  TestHarnessUtil.assertOutputEquals("Output was not correct.",expectedOutput,testHarness.getOutput());
  testHarness.close();
}
