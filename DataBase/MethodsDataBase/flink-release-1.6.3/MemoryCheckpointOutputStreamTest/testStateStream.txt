@Test public void testStateStream() throws Exception {
  HashMap<String,Integer> state=new HashMap<>();
  state.put("hey there",2);
  state.put("the crazy brown fox stumbles over a sentence that does not contain every letter",77);
  CheckpointStateOutputStream outStream=new MemoryCheckpointOutputStream(MemoryStateBackend.DEFAULT_MAX_STATE_SIZE);
  ObjectOutputStream oos=new ObjectOutputStream(outStream);
  oos.writeObject(state);
  oos.flush();
  StreamStateHandle handle=outStream.closeAndGetHandle();
  assertNotNull(handle);
  try (ObjectInputStream ois=new ObjectInputStream(handle.openInputStream())){
    assertEquals(state,ois.readObject());
    assertTrue(ois.available() <= 0);
  }
 }
