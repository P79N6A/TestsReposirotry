@Test public void testFinalizeIsNotCalledUponFailure() throws Exception {
  final JobID jid=new JobID();
  final JobVertex vertex=spy(new JobVertex("test vertex 1"));
  vertex.setInvokableClass(NoOpInvokable.class);
  vertex.setParallelism(1);
  final ExecutionGraph eg=createSimpleTestGraph(jid,vertex);
  eg.scheduleForExecution();
  assertEquals(JobStatus.RUNNING,eg.getState());
  ExecutionGraphTestUtils.switchAllVerticesToRunning(eg);
  final Execution exec=eg.getJobVertex(vertex.getID()).getTaskVertices()[0].getCurrentExecutionAttempt();
  exec.fail(new Exception("test"));
  assertEquals(JobStatus.FAILED,eg.waitUntilTerminal());
  verify(vertex,times(0)).finalizeOnMaster(any(ClassLoader.class));
  assertEquals(0,eg.getRegisteredExecutions().size());
}
