@Test public void testSkipCorruptedRecordWithPeriodicWatermarks() throws Exception {
  final String testTopic="test topic name";
  Map<KafkaTopicPartition,Long> originalPartitions=new HashMap<>();
  originalPartitions.put(new KafkaTopicPartition(testTopic,1),KafkaTopicPartitionStateSentinel.LATEST_OFFSET);
  TestSourceContext<Long> sourceContext=new TestSourceContext<>();
  TestProcessingTimeService processingTimeProvider=new TestProcessingTimeService();
  TestFetcher<Long> fetcher=new TestFetcher<>(sourceContext,originalPartitions,new SerializedValue<AssignerWithPeriodicWatermarks<Long>>(new PeriodicTestExtractor()),null,processingTimeProvider,10);
  final KafkaTopicPartitionState<Object> partitionStateHolder=fetcher.subscribedPartitionStates().get(0);
  fetcher.emitRecord(1L,partitionStateHolder,1L);
  fetcher.emitRecord(2L,partitionStateHolder,2L);
  fetcher.emitRecord(3L,partitionStateHolder,3L);
  assertEquals(3L,sourceContext.getLatestElement().getValue().longValue());
  assertEquals(3L,sourceContext.getLatestElement().getTimestamp());
  assertEquals(3L,partitionStateHolder.getOffset());
  processingTimeProvider.setCurrentTime(10L);
  assertTrue(sourceContext.hasWatermark());
  assertEquals(3L,sourceContext.getLatestWatermark().getTimestamp());
  fetcher.emitRecord(null,partitionStateHolder,4L);
  assertEquals(3L,sourceContext.getLatestElement().getValue().longValue());
  assertEquals(3L,sourceContext.getLatestElement().getTimestamp());
  assertEquals(4L,partitionStateHolder.getOffset());
  processingTimeProvider.setCurrentTime(20L);
  assertFalse(sourceContext.hasWatermark());
}
