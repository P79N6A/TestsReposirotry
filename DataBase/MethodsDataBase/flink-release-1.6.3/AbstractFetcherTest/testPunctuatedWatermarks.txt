@Test public void testPunctuatedWatermarks() throws Exception {
  final String testTopic="test topic name";
  Map<KafkaTopicPartition,Long> originalPartitions=new HashMap<>();
  originalPartitions.put(new KafkaTopicPartition(testTopic,7),KafkaTopicPartitionStateSentinel.LATEST_OFFSET);
  originalPartitions.put(new KafkaTopicPartition(testTopic,13),KafkaTopicPartitionStateSentinel.LATEST_OFFSET);
  originalPartitions.put(new KafkaTopicPartition(testTopic,21),KafkaTopicPartitionStateSentinel.LATEST_OFFSET);
  TestSourceContext<Long> sourceContext=new TestSourceContext<>();
  TestProcessingTimeService processingTimeProvider=new TestProcessingTimeService();
  TestFetcher<Long> fetcher=new TestFetcher<>(sourceContext,originalPartitions,null,new SerializedValue<AssignerWithPunctuatedWatermarks<Long>>(new PunctuatedTestExtractor()),processingTimeProvider,0);
  final KafkaTopicPartitionState<Object> part1=fetcher.subscribedPartitionStates().get(0);
  final KafkaTopicPartitionState<Object> part2=fetcher.subscribedPartitionStates().get(1);
  final KafkaTopicPartitionState<Object> part3=fetcher.subscribedPartitionStates().get(2);
  fetcher.emitRecord(1L,part1,1L);
  fetcher.emitRecord(2L,part1,2L);
  fetcher.emitRecord(3L,part1,3L);
  assertEquals(3L,sourceContext.getLatestElement().getValue().longValue());
  assertEquals(3L,sourceContext.getLatestElement().getTimestamp());
  assertFalse(sourceContext.hasWatermark());
  fetcher.emitRecord(12L,part2,1L);
  assertEquals(12L,sourceContext.getLatestElement().getValue().longValue());
  assertEquals(12L,sourceContext.getLatestElement().getTimestamp());
  assertFalse(sourceContext.hasWatermark());
  fetcher.emitRecord(101L,part3,1L);
  fetcher.emitRecord(102L,part3,2L);
  assertEquals(102L,sourceContext.getLatestElement().getValue().longValue());
  assertEquals(102L,sourceContext.getLatestElement().getTimestamp());
  assertTrue(sourceContext.hasWatermark());
  assertEquals(3L,sourceContext.getLatestWatermark().getTimestamp());
  fetcher.emitRecord(1003L,part3,3L);
  fetcher.emitRecord(1004L,part3,4L);
  fetcher.emitRecord(1005L,part3,5L);
  assertEquals(1005L,sourceContext.getLatestElement().getValue().longValue());
  assertEquals(1005L,sourceContext.getLatestElement().getTimestamp());
  fetcher.emitRecord(30L,part1,4L);
  assertEquals(30L,sourceContext.getLatestElement().getValue().longValue());
  assertEquals(30L,sourceContext.getLatestElement().getTimestamp());
  assertTrue(sourceContext.hasWatermark());
  assertEquals(12L,sourceContext.getLatestWatermark().getTimestamp());
  fetcher.emitRecord(13L,part2,2L);
  assertFalse(sourceContext.hasWatermark());
  fetcher.emitRecord(14L,part2,3L);
  assertFalse(sourceContext.hasWatermark());
  fetcher.emitRecord(15L,part2,3L);
  assertTrue(sourceContext.hasWatermark());
  assertEquals(15L,sourceContext.getLatestWatermark().getTimestamp());
}
