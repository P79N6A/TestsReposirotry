@Test public void testFairConsumptionRemoteChannelsPreFilled() throws Exception {
  final int numChannels=37;
  final int buffersPerChannel=27;
  final Buffer mockBuffer=TestBufferFactory.createBuffer(42);
  SingleInputGate gate=new FairnessVerifyingInputGate("Test Task Name",new JobID(),new IntermediateDataSetID(),0,numChannels,mock(TaskActions.class),UnregisteredMetricGroups.createUnregisteredTaskMetricGroup().getIOMetricGroup(),true);
  final ConnectionManager connManager=createDummyConnectionManager();
  final RemoteInputChannel[] channels=new RemoteInputChannel[numChannels];
  for (int i=0; i < numChannels; i++) {
    RemoteInputChannel channel=new RemoteInputChannel(gate,i,new ResultPartitionID(),mock(ConnectionID.class),connManager,0,0,UnregisteredMetricGroups.createUnregisteredTaskMetricGroup().getIOMetricGroup());
    channels[i]=channel;
    for (int p=0; p < buffersPerChannel; p++) {
      channel.onBuffer(mockBuffer,p,-1);
    }
    channel.onBuffer(EventSerializer.toBuffer(EndOfPartitionEvent.INSTANCE),buffersPerChannel,-1);
    gate.setInputChannel(new IntermediateResultPartitionID(),channel);
  }
  for (int i=numChannels * (buffersPerChannel + 1); i > 0; --i) {
    assertNotNull(gate.getNextBufferOrEvent());
    int min=Integer.MAX_VALUE;
    int max=0;
    for (    RemoteInputChannel channel : channels) {
      int size=channel.getNumberOfQueuedBuffers();
      min=Math.min(min,size);
      max=Math.max(max,size);
    }
    assertTrue(max == min || max == (min + 1));
  }
  assertFalse(gate.getNextBufferOrEvent().isPresent());
}
