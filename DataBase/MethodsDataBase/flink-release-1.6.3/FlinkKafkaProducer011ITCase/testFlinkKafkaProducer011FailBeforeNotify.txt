@Test public void testFlinkKafkaProducer011FailBeforeNotify() throws Exception {
  String topic="flink-kafka-producer-fail-before-notify";
  OneInputStreamOperatorTestHarness<Integer,Object> testHarness=createTestHarness(topic);
  testHarness.setup();
  testHarness.open();
  testHarness.initializeState(null);
  testHarness.processElement(42,0);
  testHarness.snapshot(0,1);
  testHarness.processElement(43,2);
  OperatorSubtaskState snapshot=testHarness.snapshot(1,3);
  int leaderId=kafkaServer.getLeaderToShutDown(topic);
  failBroker(leaderId);
  try {
    testHarness.processElement(44,4);
    testHarness.snapshot(2,5);
    fail();
  }
 catch (  Exception ex) {
  }
  try {
    testHarness.close();
  }
 catch (  Exception ex) {
  }
  kafkaServer.restartBroker(leaderId);
  testHarness=createTestHarness(topic);
  testHarness.setup();
  testHarness.initializeState(snapshot);
  testHarness.close();
  assertExactlyOnceForTopic(createProperties(),topic,0,Arrays.asList(42,43));
  deleteTestTopic(topic);
}
