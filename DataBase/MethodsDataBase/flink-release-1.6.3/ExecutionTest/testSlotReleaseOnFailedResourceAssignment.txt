/** 
 * Tests that slots are released if we cannot assign the allocated resource to the Execution.
 */
@Test public void testSlotReleaseOnFailedResourceAssignment() throws Exception {
  final JobVertex jobVertex=createNoOpJobVertex();
  final JobVertexID jobVertexId=jobVertex.getID();
  final CompletableFuture<LogicalSlot> slotFuture=new CompletableFuture<>();
  final ProgrammedSlotProvider slotProvider=new ProgrammedSlotProvider(1);
  slotProvider.addSlot(jobVertexId,0,slotFuture);
  ExecutionGraph executionGraph=ExecutionGraphTestUtils.createSimpleTestGraph(new JobID(),slotProvider,new NoRestartStrategy(),jobVertex);
  ExecutionJobVertex executionJobVertex=executionGraph.getJobVertex(jobVertexId);
  final Execution execution=executionJobVertex.getTaskVertices()[0].getCurrentExecutionAttempt();
  final SingleSlotTestingSlotOwner slotOwner=new SingleSlotTestingSlotOwner();
  final SimpleSlot slot=new SimpleSlot(slotOwner,new LocalTaskManagerLocation(),0,new SimpleAckingTaskManagerGateway());
  final LogicalSlot otherSlot=new TestingLogicalSlot();
  CompletableFuture<Execution> allocationFuture=execution.allocateAndAssignSlotForExecution(slotProvider,false,LocationPreferenceConstraint.ALL,Collections.emptySet(),TestingUtils.infiniteTime());
  assertFalse(allocationFuture.isDone());
  assertEquals(ExecutionState.SCHEDULED,execution.getState());
  assertTrue(execution.tryAssignResource(otherSlot));
  slotFuture.complete(slot);
  assertEquals(slot,slotOwner.getReturnedSlotFuture().get());
}
