@Test public void testBlockTraffic() throws Exception {
  try (EchoServer echoServer=new EchoServer(SOCKET_TIMEOUT);NetworkFailuresProxy proxy=new NetworkFailuresProxy(0,"localhost",echoServer.getLocalPort())){
    echoServer.start();
    try (EchoClient echoClient=new EchoClient("localhost",proxy.getLocalPort(),SOCKET_TIMEOUT)){
      assertEquals("42",echoClient.write("42"));
      proxy.blockTraffic();
      try {
        echoClient.write("Ala ma kota!");
      }
 catch (      SocketException ex) {
        assertEquals("Connection reset",ex.getMessage());
      }
    }
     try (EchoClient echoClient=new EchoClient("localhost",proxy.getLocalPort(),SOCKET_TIMEOUT)){
      assertEquals(null,echoClient.write("42"));
    }
 catch (    SocketException ex) {
      assertEquals("Connection reset",ex.getMessage());
    }
    proxy.unblockTraffic();
    try (EchoClient echoClient=new EchoClient("localhost",proxy.getLocalPort(),SOCKET_TIMEOUT)){
      assertEquals("42",echoClient.write("42"));
      assertEquals("Ala ma kota!",echoClient.write("Ala ma kota!"));
    }
   }
 }
