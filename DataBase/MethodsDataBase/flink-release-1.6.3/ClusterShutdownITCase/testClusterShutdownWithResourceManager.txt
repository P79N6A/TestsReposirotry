/** 
 * Tests a faked cluster shutdown procedure with the ResourceManager.
 */
@Test public void testClusterShutdownWithResourceManager(){
  new JavaTestKit(system){
{
      new Within(duration("30 seconds")){
        @Override protected void run(){
          ActorGateway jobManager=null;
          ActorGateway taskManager=null;
          ActorGateway resourceManager=null;
          ActorGateway forwardingActor=null;
          try {
            jobManager=TestingUtils.createJobManager(system,TestingUtils.defaultExecutor(),TestingUtils.defaultExecutor(),config,highAvailabilityServices,"jobmanager2");
            forwardingActor=TestingUtils.createForwardingActor(system,getTestActor(),jobManager.leaderSessionID(),Option.<String>empty());
            jobManager.tell(TestingMessages.getNotifyOfComponentShutdown(),forwardingActor);
            taskManager=TestingUtils.createTaskManager(system,highAvailabilityServices,config,true,true);
            taskManager.tell(TestingMessages.getNotifyOfComponentShutdown(),forwardingActor);
            resourceManager=TestingUtils.createResourceManager(system,config,highAvailabilityServices);
            resourceManager.tell(TestingMessages.getNotifyOfComponentShutdown(),forwardingActor);
            resourceManager.tell(new TestingResourceManager.NotifyWhenResourceManagerConnected(),forwardingActor);
            expectMsgEquals(Acknowledge.get());
            jobManager.tell(new StopCluster(ApplicationStatus.SUCCEEDED,"Shutting down."),forwardingActor);
            expectMsgAllOf(new TestingMessages.ComponentShutdown(taskManager.actor()),new TestingMessages.ComponentShutdown(jobManager.actor()),new TestingMessages.ComponentShutdown(resourceManager.actor()),StopClusterSuccessful.getInstance());
          }
  finally {
            TestingUtils.stopActorGatewaysGracefully(Arrays.asList(jobManager,taskManager,resourceManager,forwardingActor));
          }
        }
      }
;
    }
  }
;
}
