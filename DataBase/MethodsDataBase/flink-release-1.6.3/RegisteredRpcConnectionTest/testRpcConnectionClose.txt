@Test public void testRpcConnectionClose() throws Exception {
  final String testRpcConnectionEndpointAddress="<TestRpcConnectionEndpointAddress>";
  final UUID leaderId=UUID.randomUUID();
  final String connectionID="Test RPC Connection ID";
  TestRegistrationGateway testGateway=new TestRegistrationGateway(new RetryingRegistrationTest.TestRegistrationSuccess(connectionID));
  try {
    rpcService.registerGateway(testRpcConnectionEndpointAddress,testGateway);
    TestRpcConnection connection=new TestRpcConnection(testRpcConnectionEndpointAddress,leaderId,rpcService.getExecutor(),rpcService);
    connection.start();
    connection.close();
    assertEquals(testRpcConnectionEndpointAddress,connection.getTargetAddress());
    assertEquals(leaderId,connection.getTargetLeaderId());
    assertTrue(connection.isClosed());
  }
  finally {
    testGateway.stop();
  }
}
