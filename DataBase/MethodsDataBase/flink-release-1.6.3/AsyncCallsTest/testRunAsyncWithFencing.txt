/** 
 * Tests that async code is not executed if the fencing token changes.
 */
@Test public void testRunAsyncWithFencing() throws Exception {
  final Time shortTimeout=Time.milliseconds(100L);
  final UUID newFencingToken=UUID.randomUUID();
  final CompletableFuture<UUID> resultFuture=new CompletableFuture<>();
  testRunAsync(endpoint -> {
    endpoint.runAsync(() -> resultFuture.complete(endpoint.getFencingToken()));
    return resultFuture;
  }
,newFencingToken);
  try {
    resultFuture.get(shortTimeout.toMilliseconds(),TimeUnit.MILLISECONDS);
    fail("The async run operation should not complete since it is filtered out due to the changed fencing token.");
  }
 catch (  TimeoutException ignored) {
  }
}
