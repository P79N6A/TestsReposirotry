@Test public void testDoublePartitionRequest() throws Exception {
  final PartitionRequestClientHandler handler=new PartitionRequestClientHandler();
  final EmbeddedChannel channel=new EmbeddedChannel(handler);
  final PartitionRequestClient client=new PartitionRequestClient(channel,handler,mock(ConnectionID.class),mock(PartitionRequestClientFactory.class));
  final NetworkBufferPool networkBufferPool=new NetworkBufferPool(10,32);
  final SingleInputGate inputGate=createSingleInputGate();
  final RemoteInputChannel inputChannel=createRemoteInputChannel(inputGate,client);
  try {
    final BufferPool bufferPool=networkBufferPool.createBufferPool(6,6);
    inputGate.setBufferPool(bufferPool);
    final int numExclusiveBuffers=2;
    inputGate.assignExclusiveSegments(networkBufferPool,numExclusiveBuffers);
    inputChannel.requestSubpartition(0);
    assertTrue(channel.isWritable());
    Object readFromOutbound=channel.readOutbound();
    assertThat(readFromOutbound,instanceOf(PartitionRequest.class));
    assertEquals(inputChannel.getInputChannelId(),((PartitionRequest)readFromOutbound).receiverId);
    assertEquals(numExclusiveBuffers,((PartitionRequest)readFromOutbound).credit);
    assertNull(channel.readOutbound());
  }
  finally {
    inputGate.releaseAllResources();
    networkBufferPool.destroyAllBufferPools();
    networkBufferPool.destroy();
  }
}
