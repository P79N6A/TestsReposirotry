/** 
 * This test verifies that watermarks and stream statuses are correctly forwarded. This also checks whether watermarks are forwarded only when we have received watermarks from all inputs. The forwarded watermark must be the minimum of the watermarks of all active inputs.
 */
@Test @SuppressWarnings("unchecked") public void testWatermarkAndStreamStatusForwarding() throws Exception {
  final TwoInputStreamTaskTestHarness<String,Integer,String> testHarness=new TwoInputStreamTaskTestHarness<String,Integer,String>(TwoInputStreamTask::new,2,2,new int[]{1,2},BasicTypeInfo.STRING_TYPE_INFO,BasicTypeInfo.INT_TYPE_INFO,BasicTypeInfo.STRING_TYPE_INFO);
  testHarness.setupOutputForSingletonOperatorChain();
  StreamConfig streamConfig=testHarness.getStreamConfig();
  CoStreamMap<String,Integer,String> coMapOperator=new CoStreamMap<String,Integer,String>(new IdentityMap());
  streamConfig.setStreamOperator(coMapOperator);
  streamConfig.setOperatorID(new OperatorID());
  ConcurrentLinkedQueue<Object> expectedOutput=new ConcurrentLinkedQueue<Object>();
  long initialTime=0L;
  testHarness.invoke();
  testHarness.waitForTaskRunning();
  testHarness.processElement(new Watermark(initialTime),0,0);
  testHarness.processElement(new Watermark(initialTime),0,1);
  testHarness.processElement(new Watermark(initialTime),1,0);
  testHarness.waitForInputProcessing();
  TestHarnessUtil.assertOutputEquals("Output was not correct.",expectedOutput,testHarness.getOutput());
  testHarness.processElement(new Watermark(initialTime),1,1);
  testHarness.waitForInputProcessing();
  expectedOutput.add(new Watermark(initialTime));
  TestHarnessUtil.assertOutputEquals("Output was not correct.",expectedOutput,testHarness.getOutput());
  testHarness.processElement(new StreamRecord<String>("Hello",initialTime),0,0);
  testHarness.processElement(new StreamRecord<Integer>(42,initialTime),1,1);
  expectedOutput.add(new StreamRecord<String>("Hello",initialTime));
  expectedOutput.add(new StreamRecord<String>("42",initialTime));
  testHarness.waitForInputProcessing();
  TestHarnessUtil.assertOutputEquals("Output was not correct.",expectedOutput,testHarness.getOutput());
  testHarness.processElement(new Watermark(initialTime + 4),0,0);
  testHarness.processElement(new Watermark(initialTime + 3),0,1);
  testHarness.processElement(new Watermark(initialTime + 3),1,0);
  testHarness.processElement(new Watermark(initialTime + 2),1,1);
  expectedOutput.add(new Watermark(initialTime + 2));
  testHarness.waitForInputProcessing();
  TestHarnessUtil.assertOutputEquals("Output was not correct.",expectedOutput,testHarness.getOutput());
  testHarness.processElement(new Watermark(initialTime + 4),1,1);
  testHarness.waitForInputProcessing();
  expectedOutput.add(new Watermark(initialTime + 3));
  TestHarnessUtil.assertOutputEquals("Output was not correct.",expectedOutput,testHarness.getOutput());
  testHarness.processElement(new Watermark(initialTime + 4),0,1);
  testHarness.processElement(new Watermark(initialTime + 4),1,0);
  testHarness.waitForInputProcessing();
  expectedOutput.add(new Watermark(initialTime + 4));
  TestHarnessUtil.assertOutputEquals("Output was not correct.",expectedOutput,testHarness.getOutput());
  testHarness.processElement(StreamStatus.IDLE,0,1);
  testHarness.processElement(StreamStatus.IDLE,1,0);
  testHarness.processElement(new Watermark(initialTime + 6),0,0);
  testHarness.processElement(new Watermark(initialTime + 5),1,1);
  testHarness.processElement(StreamStatus.IDLE,1,1);
  testHarness.waitForInputProcessing();
  expectedOutput.add(new Watermark(initialTime + 5));
  TestHarnessUtil.assertOutputEquals("Output was not correct.",expectedOutput,testHarness.getOutput());
  testHarness.processElement(StreamStatus.IDLE,0,0);
  testHarness.waitForInputProcessing();
  expectedOutput.add(StreamStatus.IDLE);
  TestHarnessUtil.assertOutputEquals("Output was not correct.",expectedOutput,testHarness.getOutput());
  testHarness.processElement(StreamStatus.ACTIVE,1,0);
  testHarness.processElement(StreamStatus.ACTIVE,0,1);
  testHarness.waitForInputProcessing();
  expectedOutput.add(StreamStatus.ACTIVE);
  TestHarnessUtil.assertOutputEquals("Output was not correct.",expectedOutput,testHarness.getOutput());
  testHarness.endInput();
  testHarness.waitForTaskCompletion();
  List<String> resultElements=TestHarnessUtil.getRawElementsFromOutput(testHarness.getOutput());
  Assert.assertEquals(2,resultElements.size());
}
