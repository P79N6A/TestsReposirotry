@Test public void testAllDistributed() throws IOException {
  for (int i=0; i < 1_000; ++i) {
    Random random=new Random();
    List<BufferPool> pools=new ArrayList<>();
    int numPools=numBuffers / 32;
    long maxTotalUsed=0;
    for (int j=0; j < numPools; j++) {
      int numRequiredBuffers=random.nextInt(7 + 1);
      int maxUsedBuffers=random.nextBoolean() ? Integer.MAX_VALUE : Math.max(1,random.nextInt(10) + numRequiredBuffers);
      pools.add(networkBufferPool.createBufferPool(numRequiredBuffers,maxUsedBuffers));
      maxTotalUsed=Math.min(numBuffers,maxTotalUsed + maxUsedBuffers);
      int numDistributedBuffers=0;
      for (      BufferPool pool : pools) {
        numDistributedBuffers+=pool.getNumBuffers();
      }
      assertEquals(maxTotalUsed,numDistributedBuffers);
    }
    verifyAllBuffersReturned();
    setupNetworkBufferPool();
  }
}
