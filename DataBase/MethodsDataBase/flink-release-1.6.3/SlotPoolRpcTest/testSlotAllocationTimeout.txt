/** 
 * Tests that a slot allocation times out wrt to the specified time out.
 */
@Test public void testSlotAllocationTimeout() throws Exception {
  final JobID jid=new JobID();
  final TestingSlotPool pool=new TestingSlotPool(rpcService,jid,SystemClock.getInstance(),TestingUtils.infiniteTime(),TestingUtils.infiniteTime());
  try {
    pool.start(JobMasterId.generate(),"foobar");
    SlotPoolGateway slotPoolGateway=pool.getSelfGateway(SlotPoolGateway.class);
    final CompletableFuture<SlotRequestId> slotRequestTimeoutFuture=new CompletableFuture<>();
    pool.setTimeoutPendingSlotRequestConsumer(slotRequestTimeoutFuture::complete);
    ResourceManagerGateway resourceManagerGateway=new TestingResourceManagerGateway();
    pool.connectToResourceManager(resourceManagerGateway);
    SlotRequestId requestId=new SlotRequestId();
    CompletableFuture<LogicalSlot> future=slotPoolGateway.allocateSlot(requestId,new DummyScheduledUnit(),SlotProfile.noLocality(DEFAULT_TESTING_PROFILE),true,fastTimeout);
    try {
      future.get();
      fail("We expected a TimeoutException.");
    }
 catch (    ExecutionException e) {
      assertTrue(ExceptionUtils.stripExecutionException(e) instanceof TimeoutException);
    }
    slotRequestTimeoutFuture.get();
    assertEquals(0L,(long)pool.getNumberOfPendingRequests().get());
  }
  finally {
    RpcUtils.terminateRpcEndpoint(pool,timeout);
  }
}
