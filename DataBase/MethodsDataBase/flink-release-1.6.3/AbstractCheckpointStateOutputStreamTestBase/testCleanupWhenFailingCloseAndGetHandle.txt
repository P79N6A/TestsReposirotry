/** 
 * Tests that the underlying stream file is deleted if the closeAndGetHandle method fails.
 */
@Test public void testCleanupWhenFailingCloseAndGetHandle() throws IOException {
  final Path folder=new Path(tmp.newFolder().toURI());
  final String fileName="test_name";
  final Path filePath=new Path(folder,fileName);
  final FileSystem fs=spy(new TestFs((path) -> new FailingCloseStream(new File(path.getPath()))));
  FSDataOutputStream stream=createTestStream(fs,folder,fileName);
  stream.write(new byte[]{1,2,3,4,5});
  try {
    closeAndGetResult(stream);
    fail("Expected IOException");
  }
 catch (  IOException ignored) {
  }
  verify(fs).delete(filePath,false);
}
