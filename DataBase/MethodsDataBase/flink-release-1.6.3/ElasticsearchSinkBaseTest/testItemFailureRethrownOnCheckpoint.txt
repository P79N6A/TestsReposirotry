/** 
 * Tests that any item failure in the listener callbacks is rethrown on an immediately following checkpoint. 
 */
@Test public void testItemFailureRethrownOnCheckpoint() throws Throwable {
  final DummyElasticsearchSink<String> sink=new DummyElasticsearchSink<>(new HashMap<String,String>(),new SimpleSinkFunction<String>(),new NoOpFailureHandler());
  final OneInputStreamOperatorTestHarness<String,Object> testHarness=new OneInputStreamOperatorTestHarness<>(new StreamSink<>(sink));
  testHarness.open();
  sink.setMockItemFailuresListForNextBulkItemResponses(Collections.singletonList(new Exception("artificial failure for record")));
  testHarness.processElement(new StreamRecord<>("msg"));
  verify(sink.getMockBulkProcessor(),times(1)).add(any(IndexRequest.class));
  sink.manualBulkRequestWithAllPendingRequests();
  try {
    testHarness.snapshot(1L,1000L);
  }
 catch (  Exception e) {
    Assert.assertTrue(e.getCause().getCause().getMessage().contains("artificial failure for record"));
    return;
  }
  Assert.fail();
}
