@Test public void testDecline() throws Exception {
  final String testId="qui a coupe le fromage";
  final String testEndpointAddress="<test-address>";
  final UUID leaderId=UUID.randomUUID();
  TestRegistrationGateway testGateway=new TestRegistrationGateway(null,new RegistrationResponse.Decline("no reason "),null,new TestRegistrationSuccess(testId));
  try {
    rpcService.registerGateway(testEndpointAddress,testGateway);
    TestRetryingRegistration registration=new TestRetryingRegistration(rpcService,testEndpointAddress,leaderId);
    long started=System.nanoTime();
    registration.startRegistration();
    CompletableFuture<Tuple2<TestRegistrationGateway,TestRegistrationSuccess>> future=registration.getFuture();
    Tuple2<TestRegistrationGateway,TestRegistrationSuccess> success=future.get(10L,TimeUnit.SECONDS);
    long finished=System.nanoTime();
    long elapsedMillis=(finished - started) / 1000000;
    assertEquals(testId,success.f1.getCorrelationId());
    assertEquals(leaderId,testGateway.getInvocations().take().leaderId());
    assertTrue("retries did not properly back off",elapsedMillis >= 2 * TestRetryingRegistration.INITIAL_TIMEOUT + TestRetryingRegistration.DELAY_ON_DECLINE);
  }
  finally {
    testGateway.stop();
  }
}
