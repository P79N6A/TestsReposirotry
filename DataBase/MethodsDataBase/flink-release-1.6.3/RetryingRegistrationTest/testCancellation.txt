@Test public void testCancellation() throws Exception {
  final String testEndpointAddress="my-test-address";
  final UUID leaderId=UUID.randomUUID();
  CompletableFuture<RegistrationResponse> result=new CompletableFuture<>();
  TestRegistrationGateway testGateway=mock(TestRegistrationGateway.class);
  when(testGateway.registrationCall(any(UUID.class),anyLong())).thenReturn(result);
  rpcService.registerGateway(testEndpointAddress,testGateway);
  TestRetryingRegistration registration=new TestRetryingRegistration(rpcService,testEndpointAddress,leaderId);
  registration.startRegistration();
  registration.cancel();
  result.completeExceptionally(new TimeoutException());
  verify(testGateway,atMost(1)).registrationCall(any(UUID.class),anyLong());
}
