/** 
 * Tests that incoming buffer instances are recycled.
 */
@Test public void testIncomingBufferIsRecycled() throws Exception {
  KvStateRegistry registry=new KvStateRegistry();
  AtomicKvStateRequestStats stats=new AtomicKvStateRequestStats();
  MessageSerializer<KvStateInternalRequest,KvStateResponse> serializer=new MessageSerializer<>(new KvStateInternalRequest.KvStateInternalRequestDeserializer(),new KvStateResponse.KvStateResponseDeserializer());
  KvStateServerHandler handler=new KvStateServerHandler(testServer,registry,serializer,stats);
  EmbeddedChannel channel=new EmbeddedChannel(getFrameDecoder(),handler);
  KvStateInternalRequest request=new KvStateInternalRequest(new KvStateID(),new byte[0]);
  ByteBuf serRequest=MessageSerializer.serializeRequest(channel.alloc(),282872L,request);
  assertEquals(1L,serRequest.refCnt());
  channel.writeInbound(serRequest);
  assertEquals("Buffer not recycled",0L,serRequest.refCnt());
  ByteBuf unexpected=channel.alloc().buffer(8);
  unexpected.writeInt(4);
  unexpected.writeInt(4);
  assertEquals(1L,unexpected.refCnt());
  channel.writeInbound(unexpected);
  assertEquals("Buffer not recycled",0L,unexpected.refCnt());
}
