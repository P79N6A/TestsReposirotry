/** 
 * Test CoProcessFunction side output with multiple consumers.
 */
@Test public void testCoProcessFunctionSideOutputWithMultipleConsumers() throws Exception {
  final OutputTag<String> sideOutputTag1=new OutputTag<String>("side1"){
  }
;
  final OutputTag<String> sideOutputTag2=new OutputTag<String>("side2"){
  }
;
  TestListResultSink<String> sideOutputResultSink1=new TestListResultSink<>();
  TestListResultSink<String> sideOutputResultSink2=new TestListResultSink<>();
  TestListResultSink<Integer> resultSink=new TestListResultSink<>();
  StreamExecutionEnvironment see=StreamExecutionEnvironment.getExecutionEnvironment();
  see.setParallelism(3);
  DataStream<Integer> ds1=see.fromCollection(elements);
  DataStream<Integer> ds2=see.fromCollection(elements);
  SingleOutputStreamOperator<Integer> passThroughtStream=ds1.connect(ds2).process(new CoProcessFunction<Integer,Integer,Integer>(){
    @Override public void processElement1(    Integer value,    Context ctx,    Collector<Integer> out) throws Exception {
      if (value < 4) {
        out.collect(value);
        ctx.output(sideOutputTag1,"sideout1-" + String.valueOf(value));
      }
    }
    @Override public void processElement2(    Integer value,    Context ctx,    Collector<Integer> out) throws Exception {
      if (value >= 4) {
        out.collect(value);
        ctx.output(sideOutputTag2,"sideout2-" + String.valueOf(value));
      }
    }
  }
);
  passThroughtStream.getSideOutput(sideOutputTag1).addSink(sideOutputResultSink1);
  passThroughtStream.getSideOutput(sideOutputTag2).addSink(sideOutputResultSink2);
  passThroughtStream.addSink(resultSink);
  see.execute();
  assertEquals(Arrays.asList("sideout1-1","sideout1-2","sideout1-3"),sideOutputResultSink1.getSortedResult());
  assertEquals(Arrays.asList("sideout2-4","sideout2-5"),sideOutputResultSink2.getSortedResult());
  assertEquals(Arrays.asList(1,2,3,4,5),resultSink.getSortedResult());
}
