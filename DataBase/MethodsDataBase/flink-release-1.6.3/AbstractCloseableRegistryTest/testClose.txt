@Test public void testClose() throws Exception {
  setup(Integer.MAX_VALUE);
  startThreads();
  for (int i=0; i < 5; ++i) {
    System.gc();
    Thread.sleep(40);
  }
  closeableRegistry.close();
  joinThreads();
  Assert.assertEquals(0,unclosedCounter.get());
  Assert.assertEquals(0,closeableRegistry.getNumberOfRegisteredCloseables());
  final C testCloseable=spy(createCloseable());
  try {
    closeableRegistry.registerCloseable(testCloseable);
    Assert.fail("Closed registry should not accept closeables!");
  }
 catch (  IOException expected) {
  }
  Assert.assertEquals(0,unclosedCounter.get());
  Assert.assertEquals(0,closeableRegistry.getNumberOfRegisteredCloseables());
  verify(testCloseable).close();
}
