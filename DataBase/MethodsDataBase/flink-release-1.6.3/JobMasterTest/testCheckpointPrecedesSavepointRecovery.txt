/** 
 * Tests that an existing checkpoint will have precedence over an savepoint
 */
@Test public void testCheckpointPrecedesSavepointRecovery() throws Exception {
  final long savepointId=42L;
  final File savepointFile=createSavepoint(savepointId);
  final SavepointRestoreSettings savepointRestoreSettings=SavepointRestoreSettings.forPath("" + savepointFile.getAbsolutePath(),true);
  final JobGraph jobGraph=createJobGraphWithCheckpointing(savepointRestoreSettings);
  final long checkpointId=1L;
  final CompletedCheckpoint completedCheckpoint=new CompletedCheckpoint(jobGraph.getJobID(),checkpointId,1L,1L,Collections.emptyMap(),null,CheckpointProperties.forCheckpoint(CheckpointRetentionPolicy.NEVER_RETAIN_AFTER_TERMINATION),new DummyCheckpointStorageLocation());
  final StandaloneCompletedCheckpointStore completedCheckpointStore=new StandaloneCompletedCheckpointStore(1);
  completedCheckpointStore.addCheckpoint(completedCheckpoint);
  final TestingCheckpointRecoveryFactory testingCheckpointRecoveryFactory=new TestingCheckpointRecoveryFactory(completedCheckpointStore,new StandaloneCheckpointIDCounter());
  haServices.setCheckpointRecoveryFactory(testingCheckpointRecoveryFactory);
  final JobMaster jobMaster=createJobMaster(configuration,jobGraph,haServices,new TestingJobManagerSharedServicesBuilder().build());
  try {
    final CompletedCheckpoint savepointCheckpoint=completedCheckpointStore.getLatestCheckpoint();
    assertThat(savepointCheckpoint,Matchers.notNullValue());
    assertThat(savepointCheckpoint.getCheckpointID(),is(checkpointId));
  }
  finally {
    RpcUtils.terminateRpcEndpoint(jobMaster,testingTimeout);
  }
}
