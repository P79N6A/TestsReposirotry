@Test public void testPutAndRemoveJobGraph() throws Exception {
  ZooKeeperSubmittedJobGraphStore jobGraphs=new ZooKeeperSubmittedJobGraphStore(ZooKeeper.createClient(),"/testPutAndRemoveJobGraph",localStateStorage);
  try {
    SubmittedJobGraphListener listener=mock(SubmittedJobGraphListener.class);
    jobGraphs.start(listener);
    SubmittedJobGraph jobGraph=createSubmittedJobGraph(new JobID(),0);
    assertEquals(0,jobGraphs.getJobIds().size());
    jobGraphs.putJobGraph(jobGraph);
    Collection<JobID> jobIds=jobGraphs.getJobIds();
    assertEquals(1,jobIds.size());
    JobID jobId=jobIds.iterator().next();
    verifyJobGraphs(jobGraph,jobGraphs.recoverJobGraph(jobId));
    jobGraph=createSubmittedJobGraph(jobGraph.getJobId(),1);
    jobGraphs.putJobGraph(jobGraph);
    jobIds=jobGraphs.getJobIds();
    assertEquals(1,jobIds.size());
    jobId=jobIds.iterator().next();
    verifyJobGraphs(jobGraph,jobGraphs.recoverJobGraph(jobId));
    jobGraphs.removeJobGraph(jobGraph.getJobId());
    assertEquals(0,jobGraphs.getJobIds().size());
    verify(listener,atMost(1)).onAddedJobGraph(any(JobID.class));
    verify(listener,never()).onRemovedJobGraph(any(JobID.class));
    jobGraphs.removeJobGraph(jobGraph.getJobId());
  }
  finally {
    jobGraphs.stop();
  }
}
