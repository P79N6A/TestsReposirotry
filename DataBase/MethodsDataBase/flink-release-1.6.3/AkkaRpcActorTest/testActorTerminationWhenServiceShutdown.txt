/** 
 * Tests that actors are properly terminated when the AkkaRpcService is shut down.
 */
@Test public void testActorTerminationWhenServiceShutdown() throws Exception {
  final ActorSystem rpcActorSystem=AkkaUtils.createDefaultActorSystem();
  final RpcService rpcService=new AkkaRpcService(rpcActorSystem,timeout);
  try {
    SimpleRpcEndpoint rpcEndpoint=new SimpleRpcEndpoint(rpcService,SimpleRpcEndpoint.class.getSimpleName());
    rpcEndpoint.start();
    CompletableFuture<Void> terminationFuture=rpcEndpoint.getTerminationFuture();
    rpcService.stopService();
    terminationFuture.get(timeout.toMilliseconds(),TimeUnit.MILLISECONDS);
  }
  finally {
    rpcActorSystem.shutdown();
    rpcActorSystem.awaitTermination(FutureUtils.toFiniteDuration(timeout));
  }
}
