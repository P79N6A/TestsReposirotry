@Test public void testSendCancelAndReceiveFail() throws Exception {
  final ExecutionGraph graph=ExecutionGraphTestUtils.createSimpleTestGraph();
  graph.scheduleForExecution();
  ExecutionGraphTestUtils.switchAllVerticesToRunning(graph);
  assertEquals(JobStatus.RUNNING,graph.getState());
  final ExecutionVertex[] vertices=graph.getVerticesTopologically().iterator().next().getTaskVertices();
  assertEquals(vertices.length,graph.getRegisteredExecutions().size());
  final Execution exec=vertices[3].getCurrentExecutionAttempt();
  exec.cancel();
  assertEquals(ExecutionState.CANCELING,exec.getState());
  exec.markFailed(new Exception("test"));
  assertTrue(exec.getState() == ExecutionState.FAILED || exec.getState() == ExecutionState.CANCELED);
  assertFalse(exec.getAssignedResource().isAlive());
  assertEquals(vertices.length - 1,exec.getVertex().getExecutionGraph().getRegisteredExecutions().size());
}
