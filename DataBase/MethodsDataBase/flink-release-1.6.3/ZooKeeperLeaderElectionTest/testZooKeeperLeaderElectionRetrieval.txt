/** 
 * Tests that the ZooKeeperLeaderElection/RetrievalService return both the correct URL.
 */
@Test public void testZooKeeperLeaderElectionRetrieval() throws Exception {
  ZooKeeperLeaderElectionService leaderElectionService=null;
  ZooKeeperLeaderRetrievalService leaderRetrievalService=null;
  try {
    leaderElectionService=ZooKeeperUtils.createLeaderElectionService(client,configuration);
    leaderRetrievalService=ZooKeeperUtils.createLeaderRetrievalService(client,configuration);
    TestingContender contender=new TestingContender(TEST_URL,leaderElectionService);
    TestingListener listener=new TestingListener();
    leaderElectionService.start(contender);
    leaderRetrievalService.start(listener);
    contender.waitForLeader(timeout);
    assertTrue(contender.isLeader());
    assertEquals(leaderElectionService.getLeaderSessionID(),contender.getLeaderSessionID());
    listener.waitForNewLeader(timeout);
    assertEquals(TEST_URL,listener.getAddress());
    assertEquals(leaderElectionService.getLeaderSessionID(),listener.getLeaderSessionID());
  }
  finally {
    if (leaderElectionService != null) {
      leaderElectionService.stop();
    }
    if (leaderRetrievalService != null) {
      leaderRetrievalService.stop();
    }
  }
}
