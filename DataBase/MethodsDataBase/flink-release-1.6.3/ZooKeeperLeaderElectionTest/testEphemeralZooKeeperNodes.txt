/** 
 * Tests that there is no information left in the ZooKeeper cluster after the ZooKeeper client has terminated. In other words, checks that the ZooKeeperLeaderElection service uses ephemeral nodes.
 */
@Test public void testEphemeralZooKeeperNodes() throws Exception {
  ZooKeeperLeaderElectionService leaderElectionService;
  ZooKeeperLeaderRetrievalService leaderRetrievalService=null;
  TestingContender testingContender;
  TestingListener listener;
  CuratorFramework client=null;
  CuratorFramework client2=null;
  NodeCache cache=null;
  try {
    client=ZooKeeperUtils.startCuratorFramework(configuration);
    client2=ZooKeeperUtils.startCuratorFramework(configuration);
    leaderElectionService=ZooKeeperUtils.createLeaderElectionService(client,configuration);
    leaderRetrievalService=ZooKeeperUtils.createLeaderRetrievalService(client2,configuration);
    testingContender=new TestingContender(TEST_URL,leaderElectionService);
    listener=new TestingListener();
    final String leaderPath=configuration.getString(HighAvailabilityOptions.HA_ZOOKEEPER_LEADER_PATH);
    cache=new NodeCache(client2,leaderPath);
    ExistsCacheListener existsListener=new ExistsCacheListener(cache);
    DeletedCacheListener deletedCacheListener=new DeletedCacheListener(cache);
    cache.getListenable().addListener(existsListener);
    cache.start();
    leaderElectionService.start(testingContender);
    testingContender.waitForLeader(timeout);
    Future<Boolean> existsFuture=existsListener.nodeExists();
    existsFuture.get(timeout,TimeUnit.MILLISECONDS);
    cache.getListenable().addListener(deletedCacheListener);
    leaderElectionService.stop();
    client.close();
    Future<Boolean> deletedFuture=deletedCacheListener.nodeDeleted();
    deletedFuture.get(timeout,TimeUnit.MILLISECONDS);
    leaderRetrievalService.start(listener);
    try {
      listener.waitForNewLeader(1000L);
      fail("TimeoutException was expected because there is no leader registered and " + "thus there shouldn't be any leader information in ZooKeeper.");
    }
 catch (    TimeoutException e) {
    }
  }
  finally {
    if (leaderRetrievalService != null) {
      leaderRetrievalService.stop();
    }
    if (cache != null) {
      cache.close();
    }
    if (client2 != null) {
      client2.close();
    }
  }
}
