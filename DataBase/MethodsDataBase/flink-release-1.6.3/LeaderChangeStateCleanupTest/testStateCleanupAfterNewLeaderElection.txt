/** 
 * Tests that a job is properly canceled in the case of a leader change. However, this time only the JMs are notified about the leader change and the TMs still believe the old leader to have leadership.
 */
@Test public void testStateCleanupAfterNewLeaderElection() throws Exception {
  UUID leaderSessionID=UUID.randomUUID();
  UUID newLeaderSessionID=UUID.randomUUID();
  highAvailabilityServices.grantLeadership(jobId,0,leaderSessionID);
  highAvailabilityServices.notifyRetrievers(jobId,0,leaderSessionID);
  cluster.waitForTaskManagersToBeRegistered(timeout);
  cluster.submitJobDetached(job);
  ActorGateway jm=cluster.getLeaderGateway(timeout);
  Future<Object> wait=jm.ask(new WaitForAllVerticesToBeRunningOrFinished(job.getJobID()),timeout);
  Await.ready(wait,timeout);
  Future<Object> jobRemoval=jm.ask(new NotifyWhenJobRemoved(job.getJobID()),timeout);
  highAvailabilityServices.grantLeadership(jobId,1,newLeaderSessionID);
  Await.ready(jobRemoval,timeout);
}
