@Test public void testSnapshot() throws UnknownHostException {
  final TypeInformation<Row> type=Types.ROW(Types.STRING,Types.LONG);
  TestMaterializedCollectStreamResult<?> result=null;
  try {
    result=new TestMaterializedCollectStreamResult<>(type,new ExecutionConfig(),InetAddress.getLocalHost(),0,Integer.MAX_VALUE);
    result.isRetrieving=true;
    result.processRecord(Tuple2.of(true,Row.of("A",1)));
    result.processRecord(Tuple2.of(true,Row.of("B",1)));
    result.processRecord(Tuple2.of(true,Row.of("A",1)));
    result.processRecord(Tuple2.of(true,Row.of("C",2)));
    assertEquals(TypedResult.payload(4),result.snapshot(1));
    assertEquals(Collections.singletonList(Row.of("A",1)),result.retrievePage(1));
    assertEquals(Collections.singletonList(Row.of("B",1)),result.retrievePage(2));
    assertEquals(Collections.singletonList(Row.of("A",1)),result.retrievePage(3));
    assertEquals(Collections.singletonList(Row.of("C",2)),result.retrievePage(4));
    result.processRecord(Tuple2.of(false,Row.of("A",1)));
    assertEquals(TypedResult.payload(3),result.snapshot(1));
    assertEquals(Collections.singletonList(Row.of("A",1)),result.retrievePage(1));
    assertEquals(Collections.singletonList(Row.of("B",1)),result.retrievePage(2));
    assertEquals(Collections.singletonList(Row.of("C",2)),result.retrievePage(3));
    result.processRecord(Tuple2.of(false,Row.of("C",2)));
    result.processRecord(Tuple2.of(false,Row.of("A",1)));
    assertEquals(TypedResult.payload(1),result.snapshot(1));
    assertEquals(Collections.singletonList(Row.of("B",1)),result.retrievePage(1));
  }
  finally {
    if (result != null) {
      result.close();
    }
  }
}
