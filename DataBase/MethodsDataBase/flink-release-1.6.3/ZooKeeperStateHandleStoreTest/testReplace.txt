/** 
 * Tests that a state handle is replaced.
 */
@Test public void testReplace() throws Exception {
  LongStateStorage stateHandleProvider=new LongStateStorage();
  ZooKeeperStateHandleStore<Long> store=new ZooKeeperStateHandleStore<>(ZOOKEEPER.getClient(),stateHandleProvider);
  final String pathInZooKeeper="/testReplace";
  final Long initialState=30968470898L;
  final Long replaceState=88383776661L;
  store.addAndLock(pathInZooKeeper,initialState);
  store.replace(pathInZooKeeper,0,replaceState);
  assertEquals(2,stateHandleProvider.getStateHandles().size());
  assertEquals(initialState,stateHandleProvider.getStateHandles().get(0).retrieveState());
  assertEquals(replaceState,stateHandleProvider.getStateHandles().get(1).retrieveState());
  Stat stat=ZOOKEEPER.getClient().checkExists().forPath(pathInZooKeeper);
  assertNotNull(stat);
  assertEquals(0,stat.getEphemeralOwner());
  @SuppressWarnings("unchecked") Long actual=((RetrievableStateHandle<Long>)InstantiationUtil.deserializeObject(ZOOKEEPER.getClient().getData().forPath(pathInZooKeeper),ClassLoader.getSystemClassLoader())).retrieveState();
  assertEquals(replaceState,actual);
}
