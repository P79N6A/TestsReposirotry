/** 
 * Tests that the created state handle is discarded if ZooKeeper create fails.
 */
@Test public void testAddDiscardStateHandleAfterFailure() throws Exception {
  LongStateStorage stateHandleProvider=new LongStateStorage();
  CuratorFramework client=spy(ZOOKEEPER.getClient());
  when(client.inTransaction().create()).thenThrow(new RuntimeException("Expected test Exception."));
  ZooKeeperStateHandleStore<Long> store=new ZooKeeperStateHandleStore<>(client,stateHandleProvider);
  final String pathInZooKeeper="/testAddDiscardStateHandleAfterFailure";
  final Long state=81282227L;
  try {
    store.addAndLock(pathInZooKeeper,state);
    fail("Did not throw expected exception");
  }
 catch (  Exception ignored) {
  }
  assertEquals(1,stateHandleProvider.getStateHandles().size());
  assertEquals(state,stateHandleProvider.getStateHandles().get(0).retrieveState());
  assertEquals(1,stateHandleProvider.getStateHandles().get(0).getNumberOfDiscardCalls());
}
