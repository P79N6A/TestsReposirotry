/** 
 * Tests add operation with lock.
 */
@Test public void testAddAndLock() throws Exception {
  LongStateStorage longStateStorage=new LongStateStorage();
  ZooKeeperStateHandleStore<Long> store=new ZooKeeperStateHandleStore<>(ZOOKEEPER.getClient(),longStateStorage);
  final String pathInZooKeeper="/testAdd";
  final Long state=1239712317L;
  store.addAndLock(pathInZooKeeper,state);
  assertEquals(1,store.getAllAndLock().size());
  assertEquals(state,store.getAndLock(pathInZooKeeper).retrieveState());
  Stat stat=ZOOKEEPER.getClient().checkExists().forPath(pathInZooKeeper);
  assertNotNull(stat);
  assertEquals(0,stat.getEphemeralOwner());
  List<String> children=ZOOKEEPER.getClient().getChildren().forPath(pathInZooKeeper);
  assertEquals(1,children.size());
  stat=ZOOKEEPER.getClient().checkExists().forPath(pathInZooKeeper + '/' + children.get(0));
  assertNotNull(stat);
  assertNotEquals(0,stat.getEphemeralOwner());
  @SuppressWarnings("unchecked") Long actual=((RetrievableStateHandle<Long>)InstantiationUtil.deserializeObject(ZOOKEEPER.getClient().getData().forPath(pathInZooKeeper),ClassLoader.getSystemClassLoader())).retrieveState();
  assertEquals(state,actual);
}
