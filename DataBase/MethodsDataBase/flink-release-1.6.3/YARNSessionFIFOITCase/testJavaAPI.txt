/** 
 * Test the YARN Java API.
 */
@Test public void testJavaAPI() throws Exception {
  final int waitTime=15;
  LOG.info("Starting testJavaAPI()");
  String confDirPath=System.getenv(ConfigConstants.ENV_FLINK_CONF_DIR);
  Configuration configuration=GlobalConfiguration.loadConfiguration();
  try (final AbstractYarnClusterDescriptor clusterDescriptor=new LegacyYarnClusterDescriptor(configuration,getYarnConfiguration(),confDirPath,getYarnClient(),true)){
    Assert.assertNotNull("unable to get yarn client",clusterDescriptor);
    clusterDescriptor.setLocalJarPath(new Path(flinkUberjar.getAbsolutePath()));
    clusterDescriptor.addShipFiles(Arrays.asList(flinkLibFolder.listFiles()));
    final ClusterSpecification clusterSpecification=new ClusterSpecification.ClusterSpecificationBuilder().setMasterMemoryMB(768).setTaskManagerMemoryMB(1024).setNumberTaskManagers(1).setSlotsPerTaskManager(1).createClusterSpecification();
    ClusterClient<ApplicationId> yarnClusterClient=null;
    try {
      yarnClusterClient=clusterDescriptor.deploySessionCluster(clusterSpecification);
      GetClusterStatusResponse expectedStatus=new GetClusterStatusResponse(1,1);
      for (int second=0; second < waitTime * 2; second++) {
        try {
          Thread.sleep(1000);
        }
 catch (        InterruptedException e) {
          LOG.warn("Interrupted",e);
        }
        GetClusterStatusResponse status=yarnClusterClient.getClusterStatus();
        if (status != null && status.equals(expectedStatus)) {
          LOG.info("ClusterClient reached status " + status);
          break;
        }
        if (second > waitTime) {
          Assert.fail("The custer didn't start after " + waitTime + " seconds");
        }
      }
      Assert.assertNotNull(yarnClusterClient.getClusterConnectionInfo());
      Assert.assertNotNull(yarnClusterClient.getWebInterfaceURL());
      LOG.info("All tests passed.");
    }
  finally {
      if (yarnClusterClient != null) {
        LOG.info("Shutting down the Flink Yarn application.");
        yarnClusterClient.shutDownCluster();
        yarnClusterClient.shutdown();
      }
    }
  }
   LOG.info("Finished testJavaAPI()");
}
