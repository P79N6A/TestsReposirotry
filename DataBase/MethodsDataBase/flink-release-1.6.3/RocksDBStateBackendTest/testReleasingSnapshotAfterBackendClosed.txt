@Test public void testReleasingSnapshotAfterBackendClosed() throws Exception {
  setupRocksKeyedStateBackend();
  try {
    RunnableFuture<SnapshotResult<KeyedStateHandle>> snapshot=keyedStateBackend.snapshot(0L,0L,testStreamFactory,CheckpointOptions.forCheckpointWithDefaultLocation());
    RocksDB spyDB=keyedStateBackend.db;
    if (!enableIncrementalCheckpointing) {
      verify(spyDB,times(1)).getSnapshot();
      verify(spyDB,times(0)).releaseSnapshot(any(Snapshot.class));
    }
    for (    RocksObject rocksCloseable : allCreatedCloseables) {
      verify(rocksCloseable,times(0)).close();
    }
    snapshot.cancel(true);
    this.keyedStateBackend.dispose();
    verify(spyDB,times(1)).close();
    assertEquals(null,keyedStateBackend.db);
    for (    RocksObject rocksCloseable : allCreatedCloseables) {
      verify(rocksCloseable,times(1)).close();
    }
  }
  finally {
    keyedStateBackend.dispose();
    keyedStateBackend=null;
  }
}
