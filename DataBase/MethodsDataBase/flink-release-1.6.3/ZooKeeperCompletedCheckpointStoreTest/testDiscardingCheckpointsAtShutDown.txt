/** 
 * Tests that checkpoints are discarded when the completed checkpoint store is shut down with a globally terminal state.
 */
@Test public void testDiscardingCheckpointsAtShutDown() throws Exception {
  final SharedStateRegistry sharedStateRegistry=new SharedStateRegistry();
  final Configuration configuration=new Configuration();
  configuration.setString(HighAvailabilityOptions.HA_ZOOKEEPER_QUORUM,zooKeeperResource.getConnectString());
  final CuratorFramework client=ZooKeeperUtils.startCuratorFramework(configuration);
  final ZooKeeperCompletedCheckpointStore checkpointStore=createZooKeeperCheckpointStore(client);
  try {
    final CompletedCheckpointStoreTest.TestCompletedCheckpoint checkpoint1=CompletedCheckpointStoreTest.createCheckpoint(0,sharedStateRegistry);
    checkpointStore.addCheckpoint(checkpoint1);
    assertThat(checkpointStore.getAllCheckpoints(),Matchers.contains(checkpoint1));
    checkpointStore.shutdown(JobStatus.FINISHED);
    CompletedCheckpointStoreTest.verifyCheckpointDiscarded(checkpoint1);
  }
  finally {
    client.close();
  }
}
