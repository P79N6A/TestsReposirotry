/** 
 * Tests that the TaskManager shuts down when it cannot register at the JobManager within the given maximum duration. Unfortunately, this test does not give good error messages. (I have not figured out how to get any better message out of the Akka TestKit than "ask timeout exception".) Anyways: An "ask timeout exception" here means that the TaskManager did not shut down after its registration timeout expired.
 */
@Test public void testShutdownAfterRegistrationDurationExpired(){
  new JavaTestKit(actorSystem){
{
      ActorGateway taskManager=null;
      try {
        Configuration tmConfig=new Configuration();
        tmConfig.setString(TaskManagerOptions.REGISTRATION_TIMEOUT,"500 ms");
        highAvailabilityServices.setJobMasterLeaderRetriever(HighAvailabilityServices.DEFAULT_JOB_ID,new SettableLeaderRetrievalService("foobar",HighAvailabilityServices.DEFAULT_LEADER_ID));
        taskManager=createTaskManager(actorSystem,highAvailabilityServices,tmConfig,true,false);
        watch(taskManager.actor());
        final ActorGateway tm=taskManager;
        new Within(timeout){
          @Override protected void run(){
            expectTerminated(tm.actor());
          }
        }
;
      }
 catch (      Throwable e) {
        e.printStackTrace();
        fail(e.getMessage());
      }
 finally {
        stopActorGracefully(taskManager);
      }
    }
  }
;
}
