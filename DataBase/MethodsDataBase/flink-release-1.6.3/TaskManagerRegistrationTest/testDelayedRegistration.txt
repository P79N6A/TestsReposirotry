/** 
 * A test that verifies that two TaskManagers correctly register at the JobManager.
 */
@Test public void testDelayedRegistration() throws Exception {
  new JavaTestKit(actorSystem){
{
      ActorGateway jobManager=null;
      ActorGateway taskManager=null;
      FiniteDuration delayedTimeout=timeout.$times(3L);
      final EmbeddedHaServices embeddedHaServices=new EmbeddedHaServices(Executors.directExecutor());
      try {
        taskManager=createTaskManager(actorSystem,embeddedHaServices,new Configuration(),true,false);
        Thread.sleep(6000L);
        jobManager=TestingUtils.createJobManager(actorSystem,TestingUtils.defaultExecutor(),TestingUtils.defaultExecutor(),new Configuration(),embeddedHaServices);
        Future<Object> responseFuture=taskManager.ask(TaskManagerMessages.getNotifyWhenRegisteredAtJobManagerMessage(),delayedTimeout);
        Object response=Await.result(responseFuture,delayedTimeout);
        assertTrue(response instanceof TaskManagerMessages.RegisteredAtJobManager);
      }
  finally {
        stopActorGatewaysGracefully(Arrays.asList(taskManager,jobManager));
        embeddedHaServices.closeAndCleanupAllData();
      }
    }
  }
;
}
