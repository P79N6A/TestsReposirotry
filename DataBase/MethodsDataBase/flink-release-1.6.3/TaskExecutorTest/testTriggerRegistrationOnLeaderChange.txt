@Test public void testTriggerRegistrationOnLeaderChange() throws Exception {
  final String address1="/resource/manager/address/one";
  final String address2="/resource/manager/address/two";
  final UUID leaderId1=UUID.randomUUID();
  final UUID leaderId2=UUID.randomUUID();
  final ResourceID rmResourceId1=new ResourceID(address1);
  final ResourceID rmResourceId2=new ResourceID(address2);
  ResourceManagerGateway rmGateway1=mock(ResourceManagerGateway.class);
  ResourceManagerGateway rmGateway2=mock(ResourceManagerGateway.class);
  when(rmGateway1.registerTaskExecutor(anyString(),any(ResourceID.class),anyInt(),any(HardwareDescription.class),any(Time.class))).thenReturn(CompletableFuture.completedFuture(new TaskExecutorRegistrationSuccess(new InstanceID(),rmResourceId1,10L,new ClusterInformation("localhost",1234))));
  when(rmGateway2.registerTaskExecutor(anyString(),any(ResourceID.class),anyInt(),any(HardwareDescription.class),any(Time.class))).thenReturn(CompletableFuture.completedFuture(new TaskExecutorRegistrationSuccess(new InstanceID(),rmResourceId2,10L,new ClusterInformation("localhost",1234))));
  rpc.registerGateway(address1,rmGateway1);
  rpc.registerGateway(address2,rmGateway2);
  final TaskSlotTable taskSlotTable=mock(TaskSlotTable.class);
  final SlotReport slotReport=new SlotReport();
  when(taskSlotTable.createSlotReport(any(ResourceID.class))).thenReturn(slotReport);
  TaskExecutorLocalStateStoresManager localStateStoresManager=new TaskExecutorLocalStateStoresManager(false,new File[]{tmp.newFolder()},Executors.directExecutor());
  final TaskManagerServices taskManagerServices=new TaskManagerServicesBuilder().setTaskManagerLocation(taskManagerLocation).setTaskSlotTable(taskSlotTable).setTaskStateManager(localStateStoresManager).build();
  TaskExecutor taskManager=new TaskExecutor(rpc,taskManagerConfiguration,haServices,taskManagerServices,new HeartbeatServices(1000L,1000L),UnregisteredMetricGroups.createUnregisteredTaskManagerMetricGroup(),dummyBlobCacheService,testingFatalErrorHandler);
  try {
    taskManager.start();
    String taskManagerAddress=taskManager.getAddress();
    assertNull(taskManager.getResourceManagerConnection());
    resourceManagerLeaderRetriever.notifyListener(address1,leaderId1);
    verify(rmGateway1,Mockito.timeout(timeout.toMilliseconds())).registerTaskExecutor(eq(taskManagerAddress),eq(taskManagerLocation.getResourceID()),anyInt(),any(HardwareDescription.class),any(Time.class));
    assertNotNull(taskManager.getResourceManagerConnection());
    resourceManagerLeaderRetriever.notifyListener(null,null);
    resourceManagerLeaderRetriever.notifyListener(address2,leaderId2);
    verify(rmGateway2,Mockito.timeout(timeout.toMilliseconds())).registerTaskExecutor(eq(taskManagerAddress),eq(taskManagerLocation.getResourceID()),anyInt(),any(HardwareDescription.class),any(Time.class));
    assertNotNull(taskManager.getResourceManagerConnection());
  }
  finally {
    taskManager.shutDown();
    taskManager.getTerminationFuture().get(timeout.toMilliseconds(),TimeUnit.MILLISECONDS);
  }
}
