@Test public void testCloseBlockIfAcquired() throws Exception {
  ResourceGuard resourceGuard=new ResourceGuard();
  ResourceGuard.Lease lease=resourceGuard.acquireResource();
  AtomicBoolean checker=new AtomicBoolean(true);
  Thread closerThread=new Thread(){
    @Override public void run(){
      resourceGuard.close();
      checker.set(false);
    }
  }
;
  closerThread.start();
  while (!resourceGuard.isClosed()) {
    Thread.yield();
  }
  Assert.assertTrue(checker.get());
  try {
    resourceGuard.acquireResource();
    Assert.fail("Resource guard is expected to be already closed.");
  }
 catch (  IOException ignore) {
  }
  lease.close();
  closerThread.join(60_000);
  Assert.assertFalse(checker.get());
}
