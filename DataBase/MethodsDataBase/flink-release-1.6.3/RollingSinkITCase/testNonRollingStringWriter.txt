/** 
 * This tests  {@link StringWriter} withnon-rolling output.
 */
@Test public void testNonRollingStringWriter() throws Exception {
  final int numElements=20;
  final String outPath=hdfsURI + "/string-non-rolling-out";
  StreamExecutionEnvironment env=StreamExecutionEnvironment.getExecutionEnvironment();
  env.setParallelism(2);
  DataStream<Tuple2<Integer,String>> source=env.addSource(new TestSourceFunction(numElements)).broadcast().filter(new OddEvenFilter());
  RollingSink<String> sink=new RollingSink<String>(outPath).setBucketer(new NonRollingBucketer()).setPartPrefix("part").setPendingPrefix("").setPendingSuffix("");
  source.map(new MapFunction<Tuple2<Integer,String>,String>(){
    private static final long serialVersionUID=1L;
    @Override public String map(    Tuple2<Integer,String> value) throws Exception {
      return value.f1;
    }
  }
).addSink(sink);
  env.execute("RollingSink String Write Test");
  FSDataInputStream inStream=dfs.open(new Path(outPath + "/part-0-0"));
  BufferedReader br=new BufferedReader(new InputStreamReader(inStream));
  for (int i=0; i < numElements; i+=2) {
    String line=br.readLine();
    Assert.assertEquals("message #" + i,line);
  }
  inStream.close();
  inStream=dfs.open(new Path(outPath + "/part-1-0"));
  br=new BufferedReader(new InputStreamReader(inStream));
  for (int i=1; i < numElements; i+=2) {
    String line=br.readLine();
    Assert.assertEquals("message #" + i,line);
  }
  inStream.close();
}
