@Test public void testScalingUp() throws Exception {
  final File outDir=tempFolder.newFolder();
  OneInputStreamOperatorTestHarness<String,Object> testHarness1=createRescalingTestSink(outDir,2,0);
  testHarness1.setup();
  testHarness1.open();
  OneInputStreamOperatorTestHarness<String,Object> testHarness2=createRescalingTestSink(outDir,2,0);
  testHarness2.setup();
  testHarness2.open();
  testHarness1.processElement(new StreamRecord<>("test1",0L));
  testHarness1.processElement(new StreamRecord<>("test2",0L));
  checkLocalFs(outDir,1,1,0,0);
  testHarness2.processElement(new StreamRecord<>("test3",0L));
  testHarness2.processElement(new StreamRecord<>("test4",0L));
  testHarness2.processElement(new StreamRecord<>("test5",0L));
  checkLocalFs(outDir,2,3,0,0);
  OperatorSubtaskState mergedSnapshot=AbstractStreamOperatorTestHarness.repackageState(testHarness2.snapshot(0,0),testHarness1.snapshot(0,0));
  testHarness1=createRescalingTestSink(outDir,3,0);
  testHarness1.setup();
  testHarness1.initializeState(mergedSnapshot);
  testHarness1.open();
  checkLocalFs(outDir,1,1,3,1);
  testHarness2=createRescalingTestSink(outDir,3,1);
  testHarness2.setup();
  testHarness2.initializeState(mergedSnapshot);
  testHarness2.open();
  checkLocalFs(outDir,0,0,5,2);
  OneInputStreamOperatorTestHarness<String,Object> testHarness3=createRescalingTestSink(outDir,3,2);
  testHarness3.setup();
  testHarness3.initializeState(mergedSnapshot);
  testHarness3.open();
  checkLocalFs(outDir,0,0,5,2);
  testHarness1.processElement(new StreamRecord<>("test6",0));
  testHarness2.processElement(new StreamRecord<>("test6",0));
  testHarness3.processElement(new StreamRecord<>("test6",0));
  checkLocalFs(outDir,3,0,5,2);
  testHarness1.snapshot(1,0);
  testHarness2.snapshot(1,0);
  testHarness3.snapshot(1,0);
  testHarness1.close();
  testHarness2.close();
  testHarness3.close();
  checkLocalFs(outDir,0,3,5,2);
}
