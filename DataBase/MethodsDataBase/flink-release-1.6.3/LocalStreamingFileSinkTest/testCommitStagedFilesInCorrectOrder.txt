@Test public void testCommitStagedFilesInCorrectOrder() throws Exception {
  final File outDir=TEMP_FOLDER.newFolder();
  try (OneInputStreamOperatorTestHarness<Tuple2<String,Integer>,Object> testHarness=TestUtils.createRescalingTestSink(outDir,1,0,100L,10L)){
    testHarness.setup();
    testHarness.open();
    testHarness.setProcessingTime(0L);
    testHarness.processElement(new StreamRecord<>(Tuple2.of("test1",1),1L));
    testHarness.processElement(new StreamRecord<>(Tuple2.of("test1",2),2L));
    TestUtils.checkLocalFs(outDir,1,0);
    testHarness.processElement(new StreamRecord<>(Tuple2.of("test1",3),3L));
    TestUtils.checkLocalFs(outDir,2,0);
    testHarness.snapshot(1L,1L);
    testHarness.processElement(new StreamRecord<>(Tuple2.of("test1",4),4L));
    testHarness.processElement(new StreamRecord<>(Tuple2.of("test1",5),5L));
    testHarness.processElement(new StreamRecord<>(Tuple2.of("test1",6),6L));
    TestUtils.checkLocalFs(outDir,3,0);
    testHarness.snapshot(2L,2L);
    testHarness.processElement(new StreamRecord<>(Tuple2.of("test1",7),7L));
    TestUtils.checkLocalFs(outDir,4,0);
    testHarness.setProcessingTime(101L);
    testHarness.snapshot(3L,3L);
    testHarness.notifyOfCompletedCheckpoint(1L);
    TestUtils.checkLocalFs(outDir,3,1);
    int fileCounter=0;
    for (    Map.Entry<File,String> fileContents : TestUtils.getFileContentByPath(outDir).entrySet()) {
      if (fileContents.getKey().getName().equals("part-0-0")) {
        fileCounter++;
        Assert.assertEquals("test1@1\ntest1@2\n",fileContents.getValue());
      }
 else       if (fileContents.getKey().getName().contains(".part-0-1.inprogress")) {
        fileCounter++;
        Assert.assertEquals("test1@3\ntest1@4\n",fileContents.getValue());
      }
 else       if (fileContents.getKey().getName().contains(".part-0-2.inprogress")) {
        fileCounter++;
        Assert.assertEquals("test1@5\ntest1@6\n",fileContents.getValue());
      }
 else       if (fileContents.getKey().getName().contains(".part-0-3.inprogress")) {
        fileCounter++;
        Assert.assertEquals("test1@7\n",fileContents.getValue());
      }
    }
    Assert.assertEquals(4L,fileCounter);
    testHarness.notifyOfCompletedCheckpoint(3L);
    TestUtils.checkLocalFs(outDir,0,4);
    fileCounter=0;
    for (    Map.Entry<File,String> fileContents : TestUtils.getFileContentByPath(outDir).entrySet()) {
      if (fileContents.getKey().getName().equals("part-0-0")) {
        fileCounter++;
        Assert.assertEquals("test1@1\ntest1@2\n",fileContents.getValue());
      }
 else       if (fileContents.getKey().getName().equals("part-0-1")) {
        fileCounter++;
        Assert.assertEquals("test1@3\ntest1@4\n",fileContents.getValue());
      }
 else       if (fileContents.getKey().getName().equals("part-0-2")) {
        fileCounter++;
        Assert.assertEquals("test1@5\ntest1@6\n",fileContents.getValue());
      }
 else       if (fileContents.getKey().getName().equals("part-0-3")) {
        fileCounter++;
        Assert.assertEquals("test1@7\n",fileContents.getValue());
      }
    }
    Assert.assertEquals(4L,fileCounter);
  }
 }
