/** 
 * Tests  {@link SpillableSubpartition#add(BufferConsumer)} with a spilled partition where adding thewrite request fails with an exception.
 */
@Test public void testAddOnSpilledPartitionWithFailingWriter() throws Exception {
  IOManager ioManager=new IOManagerAsyncWithClosedBufferFileWriter();
  SpillableSubpartition partition=createSubpartition(ioManager);
  assertEquals(0,partition.releaseMemory());
  exception.expect(IOException.class);
  BufferConsumer buffer=createFilledBufferConsumer(BUFFER_DATA_SIZE,BUFFER_DATA_SIZE);
  boolean bufferRecycled;
  try {
    partition.add(buffer);
  }
  finally {
    ioManager.shutdown();
    bufferRecycled=buffer.isRecycled();
    if (!bufferRecycled) {
      buffer.close();
    }
  }
  if (!bufferRecycled) {
    Assert.fail("buffer not recycled");
  }
  assertEquals(0,partition.getTotalNumberOfBuffers());
  assertEquals(0,partition.getTotalNumberOfBytes());
}
