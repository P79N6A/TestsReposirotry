/** 
 * Tests  {@link SpillableSubpartition#add(BufferConsumer)} with a spilled partition where adding thewrite request fails with an exception.
 */
@Test public void testAddOnSpilledPartitionWithSlowWriter() throws Exception {
  IOManager ioManager=new IOManagerAsyncWithNoOpBufferFileWriter();
  SpillableSubpartition partition=createSubpartition(ioManager);
  assertEquals(0,partition.releaseMemory());
  BufferConsumer buffer=createFilledBufferConsumer(BUFFER_DATA_SIZE,BUFFER_DATA_SIZE);
  boolean bufferRecycled;
  try {
    partition.add(buffer);
  }
  finally {
    ioManager.shutdown();
    bufferRecycled=buffer.isRecycled();
    if (!bufferRecycled) {
      buffer.close();
    }
  }
  if (bufferRecycled) {
    Assert.fail("buffer recycled before the write operation completed");
  }
  assertEquals(1,partition.getTotalNumberOfBuffers());
  assertEquals(BUFFER_DATA_SIZE,partition.getTotalNumberOfBytes());
}
