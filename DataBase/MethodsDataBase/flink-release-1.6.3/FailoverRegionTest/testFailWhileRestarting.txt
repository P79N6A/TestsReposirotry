/** 
 * Tests that a new failure comes while the failover region is restarting
 * @throws Exception
 */
@Test public void testFailWhileRestarting() throws Exception {
  RestartStrategy restartStrategy=new InfiniteDelayRestartStrategy();
  ExecutionGraph eg=createSingleRegionExecutionGraph(restartStrategy);
  RestartPipelinedRegionStrategy strategy=(RestartPipelinedRegionStrategy)eg.getFailoverStrategy();
  Iterator<ExecutionVertex> iter=eg.getAllExecutionVertices().iterator();
  ExecutionVertex ev1=iter.next();
  assertEquals(JobStatus.RUNNING,strategy.getFailoverRegion(ev1).getState());
  ev1.getCurrentExecutionAttempt().fail(new Exception("new fail"));
  assertEquals(JobStatus.CANCELLING,strategy.getFailoverRegion(ev1).getState());
  for (  ExecutionVertex evs : eg.getAllExecutionVertices()) {
    evs.getCurrentExecutionAttempt().cancelingComplete();
  }
  assertEquals(JobStatus.RUNNING,strategy.getFailoverRegion(ev1).getState());
  ev1.getCurrentExecutionAttempt().fail(new Exception("new fail"));
  assertEquals(JobStatus.CANCELLING,strategy.getFailoverRegion(ev1).getState());
}
