/** 
 * Verifies that reporters implementing the Scheduled interface are regularly called to report the metrics.
 */
@Test public void testReporterScheduling() throws Exception {
  Configuration config=new Configuration();
  config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + "test." + ConfigConstants.METRICS_REPORTER_CLASS_SUFFIX,TestReporter3.class.getName());
  config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + "test.arg1","hello");
  config.setString(ConfigConstants.METRICS_REPORTER_PREFIX + "test." + ConfigConstants.METRICS_REPORTER_INTERVAL_SUFFIX,"50 MILLISECONDS");
  MetricRegistryImpl registry=new MetricRegistryImpl(MetricRegistryConfiguration.fromConfiguration(config));
  long start=System.currentTimeMillis();
  TestReporter3.reportCount=0;
  for (int x=0; x < 10; x++) {
    Thread.sleep(100);
    int reportCount=TestReporter3.reportCount;
    long curT=System.currentTimeMillis();
    long maxAllowedReports=(curT - start) / 50 + 2;
    Assert.assertTrue("Too many reports were triggered.",maxAllowedReports >= reportCount);
  }
  Assert.assertTrue("No report was triggered.",TestReporter3.reportCount > 0);
  registry.shutdown().get();
}
