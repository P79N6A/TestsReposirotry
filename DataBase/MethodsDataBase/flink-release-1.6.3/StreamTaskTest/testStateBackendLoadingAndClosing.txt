@Test public void testStateBackendLoadingAndClosing() throws Exception {
  Configuration taskManagerConfig=new Configuration();
  taskManagerConfig.setString(CheckpointingOptions.STATE_BACKEND,TestMemoryStateBackendFactory.class.getName());
  StreamConfig cfg=new StreamConfig(new Configuration());
  cfg.setStateKeySerializer(mock(TypeSerializer.class));
  cfg.setOperatorID(new OperatorID(4711L,42L));
  TestStreamSource<Long,MockSourceFunction> streamSource=new TestStreamSource<>(new MockSourceFunction());
  cfg.setStreamOperator(streamSource);
  cfg.setTimeCharacteristic(TimeCharacteristic.ProcessingTime);
  Task task=createTask(StateBackendTestSource.class,cfg,taskManagerConfig);
  StateBackendTestSource.fail=false;
  task.startTaskThread();
  task.getExecutingThread().join();
  verify(TestStreamSource.operatorStateBackend).close();
  verify(TestStreamSource.keyedStateBackend).close();
  verify(TestStreamSource.rawOperatorStateInputs).close();
  verify(TestStreamSource.rawKeyedStateInputs).close();
  verify(TestStreamSource.operatorStateBackend).dispose();
  verify(TestStreamSource.keyedStateBackend).dispose();
  assertEquals(ExecutionState.FINISHED,task.getExecutionState());
}
