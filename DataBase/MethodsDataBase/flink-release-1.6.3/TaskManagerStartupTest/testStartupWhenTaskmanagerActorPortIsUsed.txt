/** 
 * Tests that the TaskManager fails synchronously when the actor system port is in use.
 * @throws Throwable
 */
@Test(expected=BindException.class) public void testStartupWhenTaskmanagerActorPortIsUsed() throws Exception {
  ServerSocket blocker=null;
  try {
    final String localHostName="localhost";
    final InetAddress localBindAddress=InetAddress.getByName(NetUtils.getWildcardIPAddress());
    blocker=new ServerSocket(0,50,localBindAddress);
    final int port=blocker.getLocalPort();
    TaskManager.runTaskManager(localHostName,ResourceID.generate(),port,new Configuration(),highAvailabilityServices,TaskManager.class);
    fail("This should fail with an IOException");
  }
 catch (  Exception e) {
    List<Throwable> causes=StartupUtils.getExceptionCauses(e,new ArrayList<Throwable>());
    for (    Throwable cause : causes) {
      if (cause instanceof BindException) {
        throw (BindException)cause;
      }
    }
    fail("This should fail with an exception caused by BindException");
  }
 finally {
    if (blocker != null) {
      try {
        blocker.close();
      }
 catch (      IOException e) {
      }
    }
    highAvailabilityServices.closeAndCleanupAllData();
  }
}
