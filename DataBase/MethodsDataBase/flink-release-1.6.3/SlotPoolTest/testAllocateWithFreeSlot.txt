@Test public void testAllocateWithFreeSlot() throws Exception {
  final CompletableFuture<SlotRequest> slotRequestFuture=new CompletableFuture<>();
  resourceManagerGateway.setRequestSlotConsumer(slotRequest -> slotRequestFuture.complete(slotRequest));
  final SlotPool slotPool=new SlotPool(rpcService,jobId,LocationPreferenceSchedulingStrategy.getInstance());
  try {
    SlotPoolGateway slotPoolGateway=setupSlotPool(slotPool,resourceManagerGateway);
    slotPoolGateway.registerTaskManager(taskManagerLocation.getResourceID());
    CompletableFuture<LogicalSlot> future1=slotPoolGateway.allocateSlot(new SlotRequestId(),new DummyScheduledUnit(),SlotProfile.noLocality(DEFAULT_TESTING_PROFILE),true,timeout);
    assertFalse(future1.isDone());
    final SlotRequest slotRequest=slotRequestFuture.get(timeout.toMilliseconds(),TimeUnit.MILLISECONDS);
    final SlotOffer slotOffer=new SlotOffer(slotRequest.getAllocationId(),0,DEFAULT_TESTING_PROFILE);
    assertTrue(slotPoolGateway.offerSlot(taskManagerLocation,taskManagerGateway,slotOffer).get());
    LogicalSlot slot1=future1.get(1,TimeUnit.SECONDS);
    assertTrue(future1.isDone());
    slot1.releaseSlot();
    CompletableFuture<LogicalSlot> future2=slotPoolGateway.allocateSlot(new SlotRequestId(),new DummyScheduledUnit(),SlotProfile.noLocality(DEFAULT_TESTING_PROFILE),true,timeout);
    LogicalSlot slot2=future2.get(1,TimeUnit.SECONDS);
    assertTrue(future2.isDone());
    assertNotEquals(slot1,slot2);
    assertFalse(slot1.isAlive());
    assertTrue(slot2.isAlive());
    assertEquals(slot1.getTaskManagerLocation(),slot2.getTaskManagerLocation());
    assertEquals(slot1.getPhysicalSlotNumber(),slot2.getPhysicalSlotNumber());
  }
  finally {
    slotPool.shutDown();
  }
}
