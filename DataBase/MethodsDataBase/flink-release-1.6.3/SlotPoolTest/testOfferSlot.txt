@Test public void testOfferSlot() throws Exception {
  final CompletableFuture<SlotRequest> slotRequestFuture=new CompletableFuture<>();
  resourceManagerGateway.setRequestSlotConsumer(slotRequest -> slotRequestFuture.complete(slotRequest));
  final SlotPool slotPool=new SlotPool(rpcService,jobId,LocationPreferenceSchedulingStrategy.getInstance());
  try {
    SlotPoolGateway slotPoolGateway=setupSlotPool(slotPool,resourceManagerGateway);
    slotPoolGateway.registerTaskManager(taskManagerLocation.getResourceID());
    CompletableFuture<LogicalSlot> future=slotPoolGateway.allocateSlot(new SlotRequestId(),new DummyScheduledUnit(),SlotProfile.noLocality(DEFAULT_TESTING_PROFILE),true,timeout);
    assertFalse(future.isDone());
    final SlotRequest slotRequest=slotRequestFuture.get(timeout.toMilliseconds(),TimeUnit.MILLISECONDS);
    final SlotOffer slotOffer=new SlotOffer(slotRequest.getAllocationId(),0,DEFAULT_TESTING_PROFILE);
    final TaskManagerLocation invalidTaskManagerLocation=new LocalTaskManagerLocation();
    assertFalse(slotPoolGateway.offerSlot(invalidTaskManagerLocation,taskManagerGateway,slotOffer).get());
    final SlotOffer nonRequestedSlotOffer=new SlotOffer(new AllocationID(),0,DEFAULT_TESTING_PROFILE);
    assertTrue(slotPoolGateway.offerSlot(taskManagerLocation,taskManagerGateway,nonRequestedSlotOffer).get());
    assertTrue(slotPoolGateway.offerSlot(taskManagerLocation,taskManagerGateway,slotOffer).get());
    LogicalSlot slot=future.get(timeout.toMilliseconds(),TimeUnit.MILLISECONDS);
    assertTrue(slot.isAlive());
    assertTrue(slotPoolGateway.offerSlot(taskManagerLocation,taskManagerGateway,slotOffer).get());
    assertTrue(slot.isAlive());
    final SlotOffer anotherSlotOfferWithSameAllocationId=new SlotOffer(slotRequest.getAllocationId(),1,DEFAULT_TESTING_PROFILE);
    assertFalse(slotPoolGateway.offerSlot(taskManagerLocation,taskManagerGateway,anotherSlotOfferWithSameAllocationId).get());
    TaskManagerLocation anotherTaskManagerLocation=new LocalTaskManagerLocation();
    assertFalse(slotPoolGateway.offerSlot(anotherTaskManagerLocation,taskManagerGateway,slotOffer).get());
    slot.releaseSlot();
    assertTrue(slotPoolGateway.offerSlot(taskManagerLocation,taskManagerGateway,slotOffer).get());
    assertFalse(slotPoolGateway.offerSlot(taskManagerLocation,taskManagerGateway,anotherSlotOfferWithSameAllocationId).get());
    assertFalse(slotPoolGateway.offerSlot(anotherTaskManagerLocation,taskManagerGateway,slotOffer).get());
  }
  finally {
    slotPool.shutDown();
  }
}
