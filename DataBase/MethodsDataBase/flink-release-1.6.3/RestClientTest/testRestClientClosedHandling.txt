/** 
 * Tests that we fail the operation if the client closes.
 */
@Test public void testRestClientClosedHandling() throws Exception {
  final Configuration config=new Configuration();
  config.setLong(RestOptions.IDLENESS_TIMEOUT,5000L);
  Socket connectionSocket=null;
  try (final ServerSocket serverSocket=new ServerSocket(0);final RestClient restClient=new RestClient(RestClientConfiguration.fromConfiguration(config),TestingUtils.defaultExecutor())){
    final String targetAddress="localhost";
    final int targetPort=serverSocket.getLocalPort();
    final CompletableFuture<Socket> socketCompletableFuture=CompletableFuture.supplyAsync(CheckedSupplier.unchecked(serverSocket::accept));
    final CompletableFuture<EmptyResponseBody> responseFuture=restClient.sendRequest(targetAddress,targetPort,new TestMessageHeaders(),EmptyMessageParameters.getInstance(),EmptyRequestBody.getInstance(),Collections.emptyList());
    try {
      connectionSocket=socketCompletableFuture.get(TIMEOUT,TimeUnit.SECONDS);
    }
 catch (    TimeoutException ignored) {
      socketCompletableFuture.cancel(true);
    }
    restClient.close();
    try {
      responseFuture.get();
    }
 catch (    ExecutionException ee) {
      if (!ExceptionUtils.findThrowable(ee,IOException.class).isPresent()) {
        throw ee;
      }
    }
  }
  finally {
    if (connectionSocket != null) {
      connectionSocket.close();
    }
  }
}
