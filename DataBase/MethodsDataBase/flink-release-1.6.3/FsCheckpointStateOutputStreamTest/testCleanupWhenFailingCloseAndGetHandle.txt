/** 
 * Tests that the underlying stream file is deleted if the closeAndGetHandle method fails.
 */
@Test public void testCleanupWhenFailingCloseAndGetHandle() throws IOException {
  final FileSystem fs=mock(FileSystem.class);
  final FSDataOutputStream outputStream=mock(FSDataOutputStream.class);
  final ArgumentCaptor<Path> pathCaptor=ArgumentCaptor.forClass(Path.class);
  when(fs.create(pathCaptor.capture(),any(FileSystem.WriteMode.class))).thenReturn(outputStream);
  doThrow(new IOException("Test IOException.")).when(outputStream).close();
  CheckpointStreamFactory.CheckpointStateOutputStream stream=new FsCheckpointStreamFactory.FsCheckpointStateOutputStream(Path.fromLocalFile(tempDir.newFolder()),fs,4,0);
  stream.write(new byte[]{1,2,3,4,5});
  verify(fs).create(any(Path.class),any(FileSystem.WriteMode.class));
  try {
    stream.closeAndGetHandle();
    fail("Expected IOException");
  }
 catch (  IOException ioE) {
  }
  verify(fs).delete(eq(pathCaptor.getValue()),anyBoolean());
}
