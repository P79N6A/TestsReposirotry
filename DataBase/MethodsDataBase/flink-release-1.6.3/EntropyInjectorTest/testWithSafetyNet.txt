@Test public void testWithSafetyNet() throws Exception {
  final String entropyKey="__ekey__";
  final String entropyValue="abc";
  final File folder=TMP_FOLDER.newFolder();
  final Path path=new Path(Path.fromLocalFile(folder),entropyKey + "/path/");
  final Path pathWithEntropy=new Path(Path.fromLocalFile(folder),entropyValue + "/path/");
  TestEntropyInjectingFs efs=new TestEntropyInjectingFs(entropyKey,entropyValue);
  FSDataOutputStream out;
  FileSystemSafetyNet.initializeSafetyNetForThread();
  FileSystem fs=FileSystemSafetyNet.wrapWithSafetyNetWhenActivated(efs);
  try {
    OutputStreamAndPath streamAndPath=EntropyInjector.createEntropyAware(fs,path,WriteMode.NO_OVERWRITE);
    out=streamAndPath.stream();
    assertEquals(pathWithEntropy,streamAndPath.path());
  }
  finally {
    FileSystemSafetyNet.closeSafetyNetAndGuardedResourcesForThread();
  }
  try {
    out.write(42);
    out.flush();
    fail("stream should be already close and hence fail with an exception");
  }
 catch (  IOException ignored) {
  }
}
