/** 
 * Tests that the  {@link Dispatcher} fails fatally if the job submission of a recovered job fails.See FLINK-9097.
 */
@Test public void testJobSubmissionErrorAfterJobRecovery() throws Exception {
  final FlinkException testException=new FlinkException("Test exception");
  dispatcher=createAndStartDispatcher(heartbeatServices,haServices,new ExpectedJobIdJobManagerRunnerFactory(TEST_JOB_ID,createdJobManagerRunnerLatch));
  final JobGraph failingJobGraph=createFailingJobGraph(testException);
  final SubmittedJobGraph submittedJobGraph=new SubmittedJobGraph(failingJobGraph,null);
  submittedJobGraphStore.putJobGraph(submittedJobGraph);
  electDispatcher();
  final Throwable error=fatalErrorHandler.getErrorFuture().get(TIMEOUT.toMilliseconds(),TimeUnit.MILLISECONDS);
  assertThat(ExceptionUtils.findThrowableWithMessage(error,testException.getMessage()).isPresent(),is(true));
  fatalErrorHandler.clearError();
}
