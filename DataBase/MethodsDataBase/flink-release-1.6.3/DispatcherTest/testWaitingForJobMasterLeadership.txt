/** 
 * Tests that we wait until the JobMaster has gained leader ship before sending requests to it. See FLINK-8887.
 */
@Test public void testWaitingForJobMasterLeadership() throws Exception {
  dispatcher=createAndStartDispatcher(heartbeatServices,haServices,new ExpectedJobIdJobManagerRunnerFactory(TEST_JOB_ID,createdJobManagerRunnerLatch));
  final DispatcherGateway dispatcherGateway=dispatcher.getSelfGateway(DispatcherGateway.class);
  dispatcherLeaderElectionService.isLeader(UUID.randomUUID()).get();
  dispatcherGateway.submitJob(jobGraph,TIMEOUT).get();
  final CompletableFuture<JobStatus> jobStatusFuture=dispatcherGateway.requestJobStatus(jobGraph.getJobID(),TIMEOUT);
  assertThat(jobStatusFuture.isDone(),is(false));
  try {
    jobStatusFuture.get(10,TimeUnit.MILLISECONDS);
    fail("Should not complete.");
  }
 catch (  TimeoutException ignored) {
  }
  jobMasterLeaderElectionService.isLeader(UUID.randomUUID()).get();
  assertThat(jobStatusFuture.get(),notNullValue());
}
