/** 
 * Tests that the  {@link Dispatcher} terminates if it cannot recover jobs fromthe  {@link SubmittedJobGraphStore}. See FLINK-8943.
 */
@Test public void testFatalErrorAfterJobRecoveryFailure() throws Exception {
  final FlinkException testException=new FlinkException("Test exception");
  dispatcher=createAndStartDispatcher(heartbeatServices,haServices,new ExpectedJobIdJobManagerRunnerFactory(TEST_JOB_ID,createdJobManagerRunnerLatch));
  final SubmittedJobGraph submittedJobGraph=new SubmittedJobGraph(jobGraph,null);
  submittedJobGraphStore.putJobGraph(submittedJobGraph);
  submittedJobGraphStore.setRecoverJobGraphFunction((  JobID jobId,  Map<JobID,SubmittedJobGraph> submittedJobs) -> {
    throw testException;
  }
);
  electDispatcher();
  final Throwable error=fatalErrorHandler.getErrorFuture().get(TIMEOUT.toMilliseconds(),TimeUnit.MILLISECONDS);
  assertThat(ExceptionUtils.findThrowableWithMessage(error,testException.getMessage()).isPresent(),is(true));
  fatalErrorHandler.clearError();
}
