@Test public void testProcessExitsDespiteBlockingShutdownHook() throws Exception {
  assumeTrue(OperatingSystem.isLinux());
  final File markerFile=new File(EnvironmentInformation.getTemporaryFileDirectory(),UUID.randomUUID() + ".marker");
  final BlockingShutdownProcess blockingProcess=new BlockingShutdownProcess(markerFile.getAbsolutePath(),100,true);
  try {
    blockingProcess.startProcess();
    long pid=blockingProcess.getProcessId();
    assertTrue("Cannot determine process ID",pid != -1);
    TestJvmProcess.waitForMarkerFile(markerFile,30000);
    Process kill=Runtime.getRuntime().exec("kill " + pid);
    kill.waitFor();
    assertEquals("failed to send SIG_TERM to process",0,kill.exitValue());
    final long deadline=System.nanoTime() + 30_000_000_000L;
    while (blockingProcess.isAlive() && System.nanoTime() < deadline) {
      Thread.sleep(50);
    }
    assertFalse("shutdown blocking process does not properly terminate itself",blockingProcess.isAlive());
  }
  finally {
    blockingProcess.destroy();
    markerFile.delete();
  }
}
