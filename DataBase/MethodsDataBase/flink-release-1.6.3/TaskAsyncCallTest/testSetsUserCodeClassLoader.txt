/** 
 * Asserts that  {@link AbstractInvokable#triggerCheckpoint(CheckpointMetaData,CheckpointOptions)}, {@link AbstractInvokable#notifyCheckpointComplete(long)}, and  {@link StoppableTask#stop()} areinvoked by a thread whose context class loader is set to the user code class loader.
 */
@Test public void testSetsUserCodeClassLoader() throws Exception {
  numCalls=1;
  Task task=createTask(ContextClassLoaderInterceptingInvokable.class);
  try (TaskCleaner ignored=new TaskCleaner(task)){
    task.startTaskThread();
    awaitLatch.await();
    task.triggerCheckpointBarrier(1,1,CheckpointOptions.forCheckpointWithDefaultLocation());
    task.notifyCheckpointComplete(1);
    task.stopExecution();
    triggerLatch.await();
    notifyCheckpointCompleteLatch.await();
    stopLatch.await();
    assertThat(classLoaders,hasSize(greaterThanOrEqualTo(3)));
    assertThat(classLoaders,everyItem(instanceOf(TestUserCodeClassLoader.class)));
  }
 }
