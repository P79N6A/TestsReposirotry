/** 
 * Tests that an AccessExecutionGraph is invalidated after its TTL expired.
 */
@Test public void testExecutionGraphEntryInvalidation() throws Exception {
  final Time timeout=Time.milliseconds(100L);
  final Time timeToLive=Time.milliseconds(1L);
  final CountingRestfulGateway restfulGateway=createCountingRestfulGateway(expectedJobId,CompletableFuture.completedFuture(expectedExecutionGraph),CompletableFuture.completedFuture(expectedExecutionGraph));
  try (ExecutionGraphCache executionGraphCache=new ExecutionGraphCache(timeout,timeToLive)){
    CompletableFuture<AccessExecutionGraph> executionGraphFuture=executionGraphCache.getExecutionGraph(expectedJobId,restfulGateway);
    assertEquals(expectedExecutionGraph,executionGraphFuture.get());
    Thread.sleep(timeToLive.toMilliseconds() * 5L);
    CompletableFuture<AccessExecutionGraph> executionGraphFuture2=executionGraphCache.getExecutionGraph(expectedJobId,restfulGateway);
    assertEquals(expectedExecutionGraph,executionGraphFuture2.get());
    assertThat(restfulGateway.getNumRequestJobCalls(),Matchers.equalTo(2));
  }
 }
