@Test public void testSnapshotChangeRestore() throws Exception {
  initTest();
  timeProvider.time=0;
  sbetc.setCurrentKey("k1");
  ctx().update(ctx().updateEmpty);
  timeProvider.time=50;
  sbetc.setCurrentKey("k1");
  ctx().update(ctx().updateUnexpired);
  timeProvider.time=100;
  sbetc.setCurrentKey("k2");
  ctx().update(ctx().updateEmpty);
  KeyedStateHandle snapshot=sbetc.takeSnapshot();
  timeProvider.time=170;
  sbetc.setCurrentKey("k1");
  ctx().update(ctx().updateExpired);
  sbetc.setCurrentKey("k2");
  ctx().update(ctx().updateUnexpired);
  sbetc.createAndRestoreKeyedStateBackend();
  sbetc.restoreSnapshot(snapshot);
  createState();
  timeProvider.time=180;
  sbetc.setCurrentKey("k1");
  assertEquals("Expired state should be unavailable",ctx().emptyValue,ctx().get());
  sbetc.setCurrentKey("k2");
  assertEquals("Unexpired state should be available",ctx().getUpdateEmpty,ctx().get());
}
