/** 
 * This test verifies (for onw input tasks) that the Stream tasks react the following way to receiving a checkpoint cancellation barrier: - send a "decline checkpoint" notification out (to the JobManager) - emit a cancellation barrier downstream.
 */
@Test public void testDeclineCallOnCancelBarrierOneInput() throws Exception {
  OneInputStreamTaskTestHarness<String,String> testHarness=new OneInputStreamTaskTestHarness<>(OneInputStreamTask::new,1,2,BasicTypeInfo.STRING_TYPE_INFO,BasicTypeInfo.STRING_TYPE_INFO);
  testHarness.setupOutputForSingletonOperatorChain();
  StreamConfig streamConfig=testHarness.getStreamConfig();
  StreamMap<String,String> mapOperator=new StreamMap<>(new IdentityMap());
  streamConfig.setStreamOperator(mapOperator);
  streamConfig.setOperatorID(new OperatorID());
  StreamMockEnvironment environment=spy(testHarness.createEnvironment());
  testHarness.invoke(environment);
  testHarness.waitForTaskRunning();
  testHarness.processEvent(new CancelCheckpointMarker(2L),0,1);
  testHarness.processEvent(new CancelCheckpointMarker(2L),0,0);
  testHarness.waitForInputProcessing();
  verify(environment,times(1)).declineCheckpoint(eq(2L),any(CheckpointDeclineOnCancellationBarrierException.class));
  Object result=testHarness.getOutput().poll();
  assertNotNull("nothing emitted",result);
  assertTrue("wrong type emitted",result instanceof CancelCheckpointMarker);
  assertEquals("wrong checkpoint id",2L,((CancelCheckpointMarker)result).getCheckpointId());
  testHarness.endInput();
  testHarness.waitForTaskCompletion();
}
