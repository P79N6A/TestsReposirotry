/** 
 * Tests that an update channel does not trigger a partition request before the UDF has requested any partitions. Otherwise, this can lead to races when registering a listener at the gate (e.g. in UnionInputGate), which can result in missed buffer notifications at the listener.
 */
@Test public void testUpdateChannelBeforeRequest() throws Exception {
  SingleInputGate inputGate=createInputGate(1);
  ResultPartitionManager partitionManager=mock(ResultPartitionManager.class);
  InputChannel unknown=new UnknownInputChannel(inputGate,0,new ResultPartitionID(),partitionManager,new TaskEventDispatcher(),new LocalConnectionManager(),0,0,UnregisteredMetricGroups.createUnregisteredTaskMetricGroup().getIOMetricGroup());
  inputGate.setInputChannel(unknown.partitionId.getPartitionId(),unknown);
  inputGate.updateInputChannel(new InputChannelDeploymentDescriptor(unknown.partitionId,ResultPartitionLocation.createLocal()));
  verify(partitionManager,never()).createSubpartitionView(any(ResultPartitionID.class),anyInt(),any(BufferAvailabilityListener.class));
}
