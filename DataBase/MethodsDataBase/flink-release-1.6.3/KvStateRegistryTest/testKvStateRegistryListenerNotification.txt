/** 
 * Tests that  {@link KvStateRegistryListener} only receive the notifications whichare destined for them.
 */
@Test public void testKvStateRegistryListenerNotification(){
  final JobID jobId1=new JobID();
  final JobID jobId2=new JobID();
  final KvStateRegistry kvStateRegistry=new KvStateRegistry();
  final ArrayDeque<JobID> registeredNotifications1=new ArrayDeque<>(2);
  final ArrayDeque<JobID> deregisteredNotifications1=new ArrayDeque<>(2);
  final TestingKvStateRegistryListener listener1=new TestingKvStateRegistryListener(registeredNotifications1,deregisteredNotifications1);
  final ArrayDeque<JobID> registeredNotifications2=new ArrayDeque<>(2);
  final ArrayDeque<JobID> deregisteredNotifications2=new ArrayDeque<>(2);
  final TestingKvStateRegistryListener listener2=new TestingKvStateRegistryListener(registeredNotifications2,deregisteredNotifications2);
  kvStateRegistry.registerListener(jobId1,listener1);
  kvStateRegistry.registerListener(jobId2,listener2);
  final JobVertexID jobVertexId=new JobVertexID();
  final KeyGroupRange keyGroupRange=new KeyGroupRange(0,1);
  final String registrationName="foobar";
  final KvStateID kvStateID=kvStateRegistry.registerKvState(jobId1,jobVertexId,keyGroupRange,registrationName,new DummyKvState());
  assertThat(registeredNotifications1.poll(),equalTo(jobId1));
  assertThat(registeredNotifications2.isEmpty(),is(true));
  final JobVertexID jobVertexId2=new JobVertexID();
  final KeyGroupRange keyGroupRange2=new KeyGroupRange(0,1);
  final String registrationName2="barfoo";
  final KvStateID kvStateID2=kvStateRegistry.registerKvState(jobId2,jobVertexId2,keyGroupRange2,registrationName2,new DummyKvState());
  assertThat(registeredNotifications2.poll(),equalTo(jobId2));
  assertThat(registeredNotifications1.isEmpty(),is(true));
  kvStateRegistry.unregisterKvState(jobId1,jobVertexId,keyGroupRange,registrationName,kvStateID);
  assertThat(deregisteredNotifications1.poll(),equalTo(jobId1));
  assertThat(deregisteredNotifications2.isEmpty(),is(true));
  kvStateRegistry.unregisterKvState(jobId2,jobVertexId2,keyGroupRange2,registrationName2,kvStateID2);
  assertThat(deregisteredNotifications2.poll(),equalTo(jobId2));
  assertThat(deregisteredNotifications1.isEmpty(),is(true));
}
