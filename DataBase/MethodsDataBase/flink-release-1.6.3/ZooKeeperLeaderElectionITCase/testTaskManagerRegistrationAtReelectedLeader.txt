/** 
 * Tests that the TaskManagers successfully register at the new leader once the old leader is terminated.
 */
@Test public void testTaskManagerRegistrationAtReelectedLeader() throws Exception {
  File rootFolder=tempFolder.getRoot();
  Configuration configuration=ZooKeeperTestUtils.createZooKeeperHAConfig(zkServer.getConnectString(),rootFolder.getPath());
  configuration.setString(HighAvailabilityOptions.HA_CLUSTER_ID,UUID.randomUUID().toString());
  int numJMs=10;
  int numTMs=3;
  configuration.setInteger(ConfigConstants.LOCAL_NUMBER_JOB_MANAGER,numJMs);
  configuration.setInteger(ConfigConstants.LOCAL_NUMBER_TASK_MANAGER,numTMs);
  TestingCluster cluster=new TestingCluster(configuration);
  try {
    cluster.start();
    for (int i=0; i < numJMs; i++) {
      ActorGateway leadingJM=cluster.getLeaderGateway(timeout);
      cluster.waitForTaskManagersToBeRegisteredAtJobManager(leadingJM.actor());
      Future<Object> registeredTMs=leadingJM.ask(JobManagerMessages.getRequestNumberRegisteredTaskManager(),timeout);
      int numRegisteredTMs=(Integer)Await.result(registeredTMs,timeout);
      assertEquals(numTMs,numRegisteredTMs);
      cluster.clearLeader();
      leadingJM.tell(PoisonPill.getInstance());
    }
  }
  finally {
    cluster.stop();
  }
}
