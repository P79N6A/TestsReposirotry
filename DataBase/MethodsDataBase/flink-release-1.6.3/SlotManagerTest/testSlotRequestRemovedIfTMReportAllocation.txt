/** 
 * Tests that pending request is removed if task executor reports a slot with its allocation id.
 */
@Test public void testSlotRequestRemovedIfTMReportAllocation() throws Exception {
  try (final SlotManager slotManager=createSlotManager(ResourceManagerId.generate(),new TestingResourceActionsBuilder().createTestingResourceActions())){
    final JobID jobID=new JobID();
    final SlotRequest slotRequest1=new SlotRequest(jobID,new AllocationID(),ResourceProfile.UNKNOWN,"foobar");
    slotManager.registerSlotRequest(slotRequest1);
    final BlockingQueue<Tuple5<SlotID,JobID,AllocationID,String,ResourceManagerId>> requestSlotQueue=new ArrayBlockingQueue<>(1);
    final BlockingQueue<CompletableFuture<Acknowledge>> responseQueue=new ArrayBlockingQueue<>(1);
    final TestingTaskExecutorGateway testingTaskExecutorGateway=new TestingTaskExecutorGatewayBuilder().setRequestSlotFunction(slotIDJobIDAllocationIDStringResourceManagerIdTuple5 -> {
      requestSlotQueue.offer(slotIDJobIDAllocationIDStringResourceManagerIdTuple5);
      try {
        return responseQueue.take();
      }
 catch (      InterruptedException ignored) {
        return FutureUtils.completedExceptionally(new FlinkException("Response queue was interrupted."));
      }
    }
).createTestingTaskExecutorGateway();
    final ResourceID taskExecutorResourceId=ResourceID.generate();
    final TaskExecutorConnection taskExecutionConnection=new TaskExecutorConnection(taskExecutorResourceId,testingTaskExecutorGateway);
    final SlotReport slotReport=new SlotReport(new SlotStatus(new SlotID(taskExecutorResourceId,0),ResourceProfile.UNKNOWN));
    final CompletableFuture<Acknowledge> firstManualSlotRequestResponse=new CompletableFuture<>();
    responseQueue.offer(firstManualSlotRequestResponse);
    slotManager.registerTaskManager(taskExecutionConnection,slotReport);
    final Tuple5<SlotID,JobID,AllocationID,String,ResourceManagerId> firstRequest=requestSlotQueue.take();
    final CompletableFuture<Acknowledge> secondManualSlotRequestResponse=new CompletableFuture<>();
    responseQueue.offer(secondManualSlotRequestResponse);
    final SlotRequest slotRequest2=new SlotRequest(jobID,new AllocationID(),ResourceProfile.UNKNOWN,"foobar");
    slotManager.registerSlotRequest(slotRequest2);
    firstManualSlotRequestResponse.completeExceptionally(new TimeoutException("Test exception to fail first allocation"));
    final Tuple5<SlotID,JobID,AllocationID,String,ResourceManagerId> secondRequest=requestSlotQueue.take();
    secondManualSlotRequestResponse.completeExceptionally(new SlotOccupiedException("Test exception",slotRequest1.getAllocationId(),jobID));
    assertThat(firstRequest.f2,equalTo(slotRequest1.getAllocationId()));
    assertThat(secondRequest.f2,equalTo(slotRequest2.getAllocationId()));
    assertThat(secondRequest.f0,equalTo(firstRequest.f0));
    secondManualSlotRequestResponse.complete(Acknowledge.get());
    final TaskManagerSlot slot=slotManager.getSlot(secondRequest.f0);
    assertThat(slot.getState(),equalTo(TaskManagerSlot.State.ALLOCATED));
    assertThat(slot.getAllocationId(),equalTo(firstRequest.f2));
    assertThat(slotManager.getNumberRegisteredSlots(),is(1));
  }
 }
