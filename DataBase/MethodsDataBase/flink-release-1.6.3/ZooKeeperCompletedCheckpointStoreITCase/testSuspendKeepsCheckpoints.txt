/** 
 * Tests that suspends keeps all checkpoints (so that they can be recovered later by the ZooKeeper store). Furthermore, suspending a job should release all locks.
 */
@Test public void testSuspendKeepsCheckpoints() throws Exception {
  CuratorFramework client=ZOOKEEPER.getClient();
  SharedStateRegistry sharedStateRegistry=new SharedStateRegistry();
  CompletedCheckpointStore store=createCompletedCheckpoints(1);
  TestCompletedCheckpoint checkpoint=createCheckpoint(0,sharedStateRegistry);
  store.addCheckpoint(checkpoint);
  assertEquals(1,store.getNumberOfRetainedCheckpoints());
  assertNotNull(client.checkExists().forPath(CHECKPOINT_PATH + ZooKeeperCompletedCheckpointStore.checkpointIdToPath(checkpoint.getCheckpointID())));
  store.shutdown(JobStatus.SUSPENDED);
  assertEquals(0,store.getNumberOfRetainedCheckpoints());
  final String checkpointPath=CHECKPOINT_PATH + ZooKeeperCompletedCheckpointStore.checkpointIdToPath(checkpoint.getCheckpointID());
  Stat stat=client.checkExists().forPath(checkpointPath);
  assertNotNull("The checkpoint node should exist.",stat);
  assertEquals("The checkpoint node should not be locked.",0,stat.getNumChildren());
  sharedStateRegistry.close();
  store.recover();
  CompletedCheckpoint recovered=store.getLatestCheckpoint();
  assertEquals(checkpoint,recovered);
}
