@Test @SuppressWarnings("unchecked,rawtypes") public void testFoldingState() throws Exception {
  CheckpointStreamFactory streamFactory=createStreamFactory();
  SharedStateRegistry sharedStateRegistry=new SharedStateRegistry();
  AbstractKeyedStateBackend<Integer> backend=createKeyedBackend(IntSerializer.INSTANCE);
  FoldingStateDescriptor<Integer,String> kvId=new FoldingStateDescriptor<>("id","Fold-Initial:",new AppendingFold(),String.class);
  TypeSerializer<Integer> keySerializer=IntSerializer.INSTANCE;
  TypeSerializer<VoidNamespace> namespaceSerializer=VoidNamespaceSerializer.INSTANCE;
  FoldingState<Integer,String> state=backend.getPartitionedState(VoidNamespace.INSTANCE,VoidNamespaceSerializer.INSTANCE,kvId);
  @SuppressWarnings("unchecked") InternalKvState<Integer,VoidNamespace,String> kvState=(InternalKvState<Integer,VoidNamespace,String>)state;
  TypeSerializer<String> valueSerializer=kvId.getSerializer();
  backend.setCurrentKey(1);
  assertNull(state.get());
  assertNull(getSerializedValue(kvState,1,keySerializer,VoidNamespace.INSTANCE,namespaceSerializer,valueSerializer));
  state.add(1);
  backend.setCurrentKey(2);
  assertNull(state.get());
  assertNull(getSerializedValue(kvState,2,keySerializer,VoidNamespace.INSTANCE,namespaceSerializer,valueSerializer));
  state.add(2);
  backend.setCurrentKey(1);
  assertEquals("Fold-Initial:,1",state.get());
  assertEquals("Fold-Initial:,1",getSerializedValue(kvState,1,keySerializer,VoidNamespace.INSTANCE,namespaceSerializer,valueSerializer));
  KeyedStateHandle snapshot1=runSnapshot(backend.snapshot(682375462378L,2,streamFactory,CheckpointOptions.forCheckpointWithDefaultLocation()),sharedStateRegistry);
  backend.setCurrentKey(1);
  state.clear();
  state.add(101);
  backend.setCurrentKey(2);
  state.add(102);
  backend.setCurrentKey(3);
  state.add(103);
  KeyedStateHandle snapshot2=runSnapshot(backend.snapshot(682375462379L,4,streamFactory,CheckpointOptions.forCheckpointWithDefaultLocation()),sharedStateRegistry);
  backend.setCurrentKey(1);
  assertEquals("Fold-Initial:,101",state.get());
  assertEquals("Fold-Initial:,101",getSerializedValue(kvState,1,keySerializer,VoidNamespace.INSTANCE,namespaceSerializer,valueSerializer));
  backend.setCurrentKey(2);
  assertEquals("Fold-Initial:,2,102",state.get());
  assertEquals("Fold-Initial:,2,102",getSerializedValue(kvState,2,keySerializer,VoidNamespace.INSTANCE,namespaceSerializer,valueSerializer));
  backend.setCurrentKey(3);
  assertEquals("Fold-Initial:,103",state.get());
  assertEquals("Fold-Initial:,103",getSerializedValue(kvState,3,keySerializer,VoidNamespace.INSTANCE,namespaceSerializer,valueSerializer));
  backend.dispose();
  backend=restoreKeyedBackend(IntSerializer.INSTANCE,snapshot1);
  snapshot1.discardState();
  FoldingState<Integer,String> restored1=backend.getPartitionedState(VoidNamespace.INSTANCE,VoidNamespaceSerializer.INSTANCE,kvId);
  @SuppressWarnings("unchecked") InternalKvState<Integer,VoidNamespace,String> restoredKvState1=(InternalKvState<Integer,VoidNamespace,String>)restored1;
  backend.setCurrentKey(1);
  assertEquals("Fold-Initial:,1",restored1.get());
  assertEquals("Fold-Initial:,1",getSerializedValue(restoredKvState1,1,keySerializer,VoidNamespace.INSTANCE,namespaceSerializer,valueSerializer));
  backend.setCurrentKey(2);
  assertEquals("Fold-Initial:,2",restored1.get());
  assertEquals("Fold-Initial:,2",getSerializedValue(restoredKvState1,2,keySerializer,VoidNamespace.INSTANCE,namespaceSerializer,valueSerializer));
  backend.dispose();
  backend=restoreKeyedBackend(IntSerializer.INSTANCE,snapshot2);
  snapshot1.discardState();
  @SuppressWarnings("unchecked") FoldingState<Integer,String> restored2=backend.getPartitionedState(VoidNamespace.INSTANCE,VoidNamespaceSerializer.INSTANCE,kvId);
  @SuppressWarnings("unchecked") InternalKvState<Integer,VoidNamespace,String> restoredKvState2=(InternalKvState<Integer,VoidNamespace,String>)restored2;
  backend.setCurrentKey(1);
  assertEquals("Fold-Initial:,101",restored2.get());
  assertEquals("Fold-Initial:,101",getSerializedValue(restoredKvState2,1,keySerializer,VoidNamespace.INSTANCE,namespaceSerializer,valueSerializer));
  backend.setCurrentKey(2);
  assertEquals("Fold-Initial:,2,102",restored2.get());
  assertEquals("Fold-Initial:,2,102",getSerializedValue(restoredKvState2,2,keySerializer,VoidNamespace.INSTANCE,namespaceSerializer,valueSerializer));
  backend.setCurrentKey(3);
  assertEquals("Fold-Initial:,103",restored2.get());
  assertEquals("Fold-Initial:,103",getSerializedValue(restoredKvState2,3,keySerializer,VoidNamespace.INSTANCE,namespaceSerializer,valueSerializer));
  backend.dispose();
}
