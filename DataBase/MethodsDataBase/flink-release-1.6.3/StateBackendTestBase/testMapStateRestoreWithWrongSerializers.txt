@Test @SuppressWarnings("unchecked") public void testMapStateRestoreWithWrongSerializers() throws Exception {
  CheckpointStreamFactory streamFactory=createStreamFactory();
  SharedStateRegistry sharedStateRegistry=new SharedStateRegistry();
  AbstractKeyedStateBackend<Integer> backend=createKeyedBackend(IntSerializer.INSTANCE);
  try {
    MapStateDescriptor<String,String> kvId=new MapStateDescriptor<>("id",StringSerializer.INSTANCE,StringSerializer.INSTANCE);
    MapState<String,String> state=backend.getPartitionedState(VoidNamespace.INSTANCE,VoidNamespaceSerializer.INSTANCE,kvId);
    backend.setCurrentKey(1);
    state.put("1","First");
    backend.setCurrentKey(2);
    state.put("2","Second");
    KeyedStateHandle snapshot1=runSnapshot(backend.snapshot(682375462378L,2,streamFactory,CheckpointOptions.forCheckpointWithDefaultLocation()),sharedStateRegistry);
    backend.dispose();
    backend=restoreKeyedBackend(IntSerializer.INSTANCE,snapshot1);
    snapshot1.discardState();
    @SuppressWarnings("unchecked") TypeSerializer<String> fakeStringSerializer=(TypeSerializer<String>)(TypeSerializer<?>)FloatSerializer.INSTANCE;
    try {
      kvId=new MapStateDescriptor<>("id",fakeStringSerializer,StringSerializer.INSTANCE);
      state=backend.getPartitionedState(VoidNamespace.INSTANCE,VoidNamespaceSerializer.INSTANCE,kvId);
      state.entries();
      fail("should recognize wrong serializers");
    }
 catch (    StateMigrationException ignored) {
    }
    backend.dispose();
  }
  finally {
    backend.dispose();
  }
}
