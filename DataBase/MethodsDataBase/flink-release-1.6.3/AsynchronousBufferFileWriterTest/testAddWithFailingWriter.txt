@Test public void testAddWithFailingWriter() throws Exception {
  AsynchronousBufferFileWriter writer=new AsynchronousBufferFileWriter(ioManager.createChannel(),new RequestQueue<>());
  writer.close();
  exception.expect(IOException.class);
  Buffer buffer=new NetworkBuffer(MemorySegmentFactory.allocateUnpooledSegment(4096),FreeingBufferRecycler.INSTANCE);
  try {
    writer.writeBlock(buffer);
  }
  finally {
    if (!buffer.isRecycled()) {
      buffer.recycleBuffer();
      Assert.fail("buffer not recycled");
    }
    assertEquals("Shouln't increment number of outstanding requests.",0,writer.getNumberOfOutstandingRequests());
  }
}
