@Test @SuppressWarnings("unchecked") public void testFetcherShouldBeCorrectlySeededOnlyItsOwnStates() throws Exception {
  HashMap<StreamShardHandle,SequenceNumber> fakeRestoredState=getFakeRestoredStore("fakeStream1");
  HashMap<StreamShardHandle,SequenceNumber> fakeRestoredStateForOthers=getFakeRestoredStore("fakeStream2");
  TestingListState<Tuple2<StreamShardMetadata,SequenceNumber>> listState=new TestingListState<>();
  for (  Map.Entry<StreamShardHandle,SequenceNumber> state : fakeRestoredState.entrySet()) {
    listState.add(Tuple2.of(KinesisDataFetcher.convertToStreamShardMetadata(state.getKey()),state.getValue()));
  }
  for (  Map.Entry<StreamShardHandle,SequenceNumber> state : fakeRestoredStateForOthers.entrySet()) {
    listState.add(Tuple2.of(KinesisDataFetcher.convertToStreamShardMetadata(state.getKey()),state.getValue()));
  }
  OperatorStateStore operatorStateStore=mock(OperatorStateStore.class);
  when(operatorStateStore.getUnionListState(Matchers.any(ListStateDescriptor.class))).thenReturn(listState);
  StateInitializationContext initializationContext=mock(StateInitializationContext.class);
  when(initializationContext.getOperatorStateStore()).thenReturn(operatorStateStore);
  when(initializationContext.isRestored()).thenReturn(true);
  KinesisDataFetcher mockedFetcher=Mockito.mock(KinesisDataFetcher.class);
  List<StreamShardHandle> shards=new ArrayList<>();
  shards.addAll(fakeRestoredState.keySet());
  when(mockedFetcher.discoverNewShardsToSubscribe()).thenReturn(shards);
  PowerMockito.whenNew(KinesisDataFetcher.class).withAnyArguments().thenReturn(mockedFetcher);
  PowerMockito.mockStatic(KinesisConfigUtil.class);
  PowerMockito.doNothing().when(KinesisConfigUtil.class);
  TestableFlinkKinesisConsumer consumer=new TestableFlinkKinesisConsumer("fakeStream",new Properties(),10,2);
  consumer.initializeState(initializationContext);
  consumer.open(new Configuration());
  consumer.run(Mockito.mock(SourceFunction.SourceContext.class));
  for (  Map.Entry<StreamShardHandle,SequenceNumber> restoredShard : fakeRestoredStateForOthers.entrySet()) {
    Mockito.verify(mockedFetcher,never()).registerNewSubscribedShardState(new KinesisStreamShardState(KinesisDataFetcher.convertToStreamShardMetadata(restoredShard.getKey()),restoredShard.getKey(),restoredShard.getValue()));
  }
  for (  Map.Entry<StreamShardHandle,SequenceNumber> restoredShard : fakeRestoredState.entrySet()) {
    Mockito.verify(mockedFetcher).registerNewSubscribedShardState(new KinesisStreamShardState(KinesisDataFetcher.convertToStreamShardMetadata(restoredShard.getKey()),restoredShard.getKey(),restoredShard.getValue()));
  }
}
