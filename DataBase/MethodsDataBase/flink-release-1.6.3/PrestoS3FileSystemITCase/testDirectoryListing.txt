@Test public void testDirectoryListing() throws Exception {
  final long deadline=System.nanoTime() + 30_000_000_000L;
  final Configuration conf=new Configuration();
  conf.setString("s3.access-key",ACCESS_KEY);
  conf.setString("s3.secret-key",SECRET_KEY);
  FileSystem.initialize(conf);
  final Path directory=new Path("s3://" + BUCKET + '/'+ TEST_DATA_DIR+ "/testdir/");
  final FileSystem fs=directory.getFileSystem();
  assertFalse(fs.exists(directory));
  try {
    assertTrue(fs.mkdirs(directory));
    assertEquals(0,fs.listStatus(directory).length);
    final int numFiles=3;
    for (int i=0; i < numFiles; i++) {
      Path file=new Path(directory,"/file-" + i);
      try (FSDataOutputStream out=fs.create(file,WriteMode.OVERWRITE);OutputStreamWriter writer=new OutputStreamWriter(out,StandardCharsets.UTF_8)){
        writer.write("hello-" + i + "\n");
      }
     }
    FileStatus[] files=fs.listStatus(directory);
    assertNotNull(files);
    assertEquals(3,files.length);
    for (    FileStatus status : files) {
      assertFalse(status.isDir());
    }
    assertTrue(fs.exists(directory));
  }
  finally {
    fs.delete(directory,true);
  }
  checkPathEventualExistence(fs,directory,false,deadline);
}
