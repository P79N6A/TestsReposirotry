@Test public void testMultiChannelAbortCheckpoint() throws Exception {
  BufferOrEvent[] sequence={createBuffer(0,PAGE_SIZE),createBuffer(2,PAGE_SIZE),createBuffer(0,PAGE_SIZE),createBarrier(1,1),createBarrier(1,2),createBuffer(2,PAGE_SIZE),createBuffer(1,PAGE_SIZE),createBarrier(1,0),createBuffer(0,PAGE_SIZE),createBuffer(2,PAGE_SIZE),createBarrier(2,0),createBarrier(2,2),createBuffer(0,PAGE_SIZE),createBuffer(2,PAGE_SIZE),createCancellationBarrier(2,1),createBuffer(2,PAGE_SIZE),createBuffer(1,PAGE_SIZE),createBarrier(3,1),createBarrier(3,2),createBarrier(3,0),createBuffer(0,PAGE_SIZE),createBuffer(1,PAGE_SIZE),createCancellationBarrier(4,1),createBarrier(4,2),createBuffer(0,PAGE_SIZE),createBarrier(4,0),createBuffer(0,PAGE_SIZE),createBuffer(1,PAGE_SIZE),createBuffer(2,PAGE_SIZE),createBarrier(5,2),createBarrier(5,1),createBarrier(5,0),createBuffer(0,PAGE_SIZE),createBuffer(1,PAGE_SIZE),createCancellationBarrier(6,1),createCancellationBarrier(6,2),createBarrier(6,0),createBuffer(0,PAGE_SIZE)};
  MockInputGate gate=new MockInputGate(PAGE_SIZE,3,Arrays.asList(sequence));
  BarrierBuffer buffer=createBarrierHandler(gate);
  AbstractInvokable toNotify=mock(AbstractInvokable.class);
  buffer.registerCheckpointEventHandler(toNotify);
  long startTs;
  check(sequence[0],buffer.getNextNonBlocked(),PAGE_SIZE);
  check(sequence[1],buffer.getNextNonBlocked(),PAGE_SIZE);
  check(sequence[2],buffer.getNextNonBlocked(),PAGE_SIZE);
  startTs=System.nanoTime();
  check(sequence[5],buffer.getNextNonBlocked(),PAGE_SIZE);
  verify(toNotify,times(1)).triggerCheckpointOnBarrier(argThat(new CheckpointMatcher(1L)),any(CheckpointOptions.class),any(CheckpointMetrics.class));
  validateAlignmentTime(startTs,buffer.getAlignmentDurationNanos());
  check(sequence[6],buffer.getNextNonBlocked(),PAGE_SIZE);
  check(sequence[8],buffer.getNextNonBlocked(),PAGE_SIZE);
  check(sequence[9],buffer.getNextNonBlocked(),PAGE_SIZE);
  startTs=System.nanoTime();
  check(sequence[12],buffer.getNextNonBlocked(),PAGE_SIZE);
  verify(toNotify,times(1)).abortCheckpointOnBarrier(eq(2L),any(CheckpointDeclineOnCancellationBarrierException.class));
  validateAlignmentTime(startTs,buffer.getAlignmentDurationNanos());
  check(sequence[13],buffer.getNextNonBlocked(),PAGE_SIZE);
  check(sequence[15],buffer.getNextNonBlocked(),PAGE_SIZE);
  check(sequence[16],buffer.getNextNonBlocked(),PAGE_SIZE);
  startTs=System.nanoTime();
  check(sequence[20],buffer.getNextNonBlocked(),PAGE_SIZE);
  verify(toNotify,times(1)).triggerCheckpointOnBarrier(argThat(new CheckpointMatcher(3L)),any(CheckpointOptions.class),any(CheckpointMetrics.class));
  validateAlignmentTime(startTs,buffer.getAlignmentDurationNanos());
  check(sequence[21],buffer.getNextNonBlocked(),PAGE_SIZE);
  check(sequence[24],buffer.getNextNonBlocked(),PAGE_SIZE);
  verify(toNotify,times(1)).abortCheckpointOnBarrier(eq(4L),any(CheckpointDeclineOnCancellationBarrierException.class));
  assertEquals(0L,buffer.getAlignmentDurationNanos());
  check(sequence[26],buffer.getNextNonBlocked(),PAGE_SIZE);
  check(sequence[27],buffer.getNextNonBlocked(),PAGE_SIZE);
  check(sequence[28],buffer.getNextNonBlocked(),PAGE_SIZE);
  startTs=System.nanoTime();
  check(sequence[32],buffer.getNextNonBlocked(),PAGE_SIZE);
  verify(toNotify,times(1)).triggerCheckpointOnBarrier(argThat(new CheckpointMatcher(5L)),any(CheckpointOptions.class),any(CheckpointMetrics.class));
  validateAlignmentTime(startTs,buffer.getAlignmentDurationNanos());
  check(sequence[33],buffer.getNextNonBlocked(),PAGE_SIZE);
  check(sequence[37],buffer.getNextNonBlocked(),PAGE_SIZE);
  verify(toNotify,times(1)).abortCheckpointOnBarrier(eq(6L),any(CheckpointDeclineOnCancellationBarrierException.class));
  assertEquals(0L,buffer.getAlignmentDurationNanos());
  assertNull(buffer.getNextNonBlocked());
  assertNull(buffer.getNextNonBlocked());
  buffer.cleanup();
}
