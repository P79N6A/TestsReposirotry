/** 
 * Validates that the buffer correctly aligns the streams for inputs with multiple input channels, by buffering and blocking certain inputs.
 */
@Test public void testMultiChannelWithBarriers() throws Exception {
  BufferOrEvent[] sequence={createBuffer(0,PAGE_SIZE),createBuffer(2,PAGE_SIZE),createBuffer(0,PAGE_SIZE),createBarrier(1,1),createBarrier(1,2),createBuffer(2,PAGE_SIZE),createBuffer(1,PAGE_SIZE),createBuffer(0,PAGE_SIZE),createBarrier(1,0),createBuffer(0,PAGE_SIZE),createBuffer(0,PAGE_SIZE),createBuffer(1,PAGE_SIZE),createBuffer(1,PAGE_SIZE),createBuffer(2,PAGE_SIZE),createBarrier(2,0),createBarrier(2,1),createBarrier(2,2),createBuffer(2,PAGE_SIZE),createBuffer(2,PAGE_SIZE),createBarrier(3,2),createBuffer(2,PAGE_SIZE),createBuffer(2,PAGE_SIZE),createBarrier(3,0),createBarrier(3,1),createBarrier(4,1),createBarrier(4,2),createBarrier(4,0),createBuffer(0,PAGE_SIZE),createBuffer(2,PAGE_SIZE),createBuffer(0,PAGE_SIZE),createBarrier(5,1),createBuffer(2,PAGE_SIZE),createBuffer(0,PAGE_SIZE),createBuffer(2,PAGE_SIZE),createBuffer(1,PAGE_SIZE),createBarrier(5,2),createBuffer(1,PAGE_SIZE),createBuffer(0,PAGE_SIZE),createBuffer(2,PAGE_SIZE),createBuffer(1,PAGE_SIZE),createBarrier(5,0),createBuffer(0,PAGE_SIZE),createEndOfPartition(0),createEndOfPartition(1),createEndOfPartition(2)};
  MockInputGate gate=new MockInputGate(PAGE_SIZE,3,Arrays.asList(sequence));
  BarrierBuffer buffer=createBarrierHandler(gate);
  ValidatingCheckpointHandler handler=new ValidatingCheckpointHandler();
  buffer.registerCheckpointEventHandler(handler);
  handler.setNextExpectedCheckpointId(1L);
  check(sequence[0],buffer.getNextNonBlocked(),PAGE_SIZE);
  check(sequence[1],buffer.getNextNonBlocked(),PAGE_SIZE);
  check(sequence[2],buffer.getNextNonBlocked(),PAGE_SIZE);
  assertEquals(1L,handler.getNextExpectedCheckpointId());
  long startTs=System.nanoTime();
  check(sequence[7],buffer.getNextNonBlocked(),PAGE_SIZE);
  assertEquals(1L,handler.getNextExpectedCheckpointId());
  check(sequence[5],buffer.getNextNonBlocked(),PAGE_SIZE);
  assertEquals(2L,handler.getNextExpectedCheckpointId());
  validateAlignmentTime(startTs,buffer.getAlignmentDurationNanos());
  validateAlignmentBuffered(handler.getLastReportedBytesBufferedInAlignment(),sequence[5],sequence[6]);
  check(sequence[6],buffer.getNextNonBlocked(),PAGE_SIZE);
  check(sequence[9],buffer.getNextNonBlocked(),PAGE_SIZE);
  check(sequence[10],buffer.getNextNonBlocked(),PAGE_SIZE);
  check(sequence[11],buffer.getNextNonBlocked(),PAGE_SIZE);
  check(sequence[12],buffer.getNextNonBlocked(),PAGE_SIZE);
  check(sequence[13],buffer.getNextNonBlocked(),PAGE_SIZE);
  assertEquals(2L,handler.getNextExpectedCheckpointId());
  startTs=System.nanoTime();
  check(sequence[17],buffer.getNextNonBlocked(),PAGE_SIZE);
  assertEquals(3L,handler.getNextExpectedCheckpointId());
  validateAlignmentTime(startTs,buffer.getAlignmentDurationNanos());
  validateAlignmentBuffered(handler.getLastReportedBytesBufferedInAlignment());
  check(sequence[18],buffer.getNextNonBlocked(),PAGE_SIZE);
  check(sequence[20],buffer.getNextNonBlocked(),PAGE_SIZE);
  validateAlignmentBuffered(handler.getLastReportedBytesBufferedInAlignment(),sequence[20],sequence[21]);
  assertEquals(4L,handler.getNextExpectedCheckpointId());
  check(sequence[21],buffer.getNextNonBlocked(),PAGE_SIZE);
  check(sequence[27],buffer.getNextNonBlocked(),PAGE_SIZE);
  validateAlignmentBuffered(handler.getLastReportedBytesBufferedInAlignment());
  assertEquals(5L,handler.getNextExpectedCheckpointId());
  check(sequence[28],buffer.getNextNonBlocked(),PAGE_SIZE);
  check(sequence[29],buffer.getNextNonBlocked(),PAGE_SIZE);
  check(sequence[31],buffer.getNextNonBlocked(),PAGE_SIZE);
  check(sequence[32],buffer.getNextNonBlocked(),PAGE_SIZE);
  check(sequence[33],buffer.getNextNonBlocked(),PAGE_SIZE);
  check(sequence[37],buffer.getNextNonBlocked(),PAGE_SIZE);
  check(sequence[34],buffer.getNextNonBlocked(),PAGE_SIZE);
  check(sequence[36],buffer.getNextNonBlocked(),PAGE_SIZE);
  check(sequence[38],buffer.getNextNonBlocked(),PAGE_SIZE);
  check(sequence[39],buffer.getNextNonBlocked(),PAGE_SIZE);
  check(sequence[41],buffer.getNextNonBlocked(),PAGE_SIZE);
  check(sequence[42],buffer.getNextNonBlocked(),PAGE_SIZE);
  check(sequence[43],buffer.getNextNonBlocked(),PAGE_SIZE);
  check(sequence[44],buffer.getNextNonBlocked(),PAGE_SIZE);
  assertNull(buffer.getNextNonBlocked());
  assertNull(buffer.getNextNonBlocked());
  validateAlignmentBuffered(handler.getLastReportedBytesBufferedInAlignment(),sequence[34],sequence[36],sequence[38],sequence[39]);
  buffer.cleanup();
}
