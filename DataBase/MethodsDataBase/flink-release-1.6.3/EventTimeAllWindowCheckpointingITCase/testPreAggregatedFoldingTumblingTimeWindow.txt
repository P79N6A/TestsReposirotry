@Test public void testPreAggregatedFoldingTumblingTimeWindow(){
  final int numElementsPerKey=3000;
  final int windowSize=100;
  final int numKeys=1;
  try {
    StreamExecutionEnvironment env=StreamExecutionEnvironment.getExecutionEnvironment();
    env.setParallelism(PARALLELISM);
    env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime);
    env.enableCheckpointing(100);
    env.setRestartStrategy(RestartStrategies.fixedDelayRestart(1,0));
    env.getConfig().disableSysoutLogging();
    env.addSource(new FailingSource(new EventTimeWindowCheckpointingITCase.KeyedEventTimeGenerator(numKeys,windowSize),numElementsPerKey)).rebalance().timeWindowAll(Time.of(windowSize,MILLISECONDS)).fold(new Tuple4<>(0L,0L,0L,new IntType(0)),new FoldFunction<Tuple2<Long,IntType>,Tuple4<Long,Long,Long,IntType>>(){
      @Override public Tuple4<Long,Long,Long,IntType> fold(      Tuple4<Long,Long,Long,IntType> accumulator,      Tuple2<Long,IntType> value) throws Exception {
        accumulator.f0=value.f0;
        accumulator.f3=new IntType(accumulator.f3.value + value.f1.value);
        return accumulator;
      }
    }
,new RichAllWindowFunction<Tuple4<Long,Long,Long,IntType>,Tuple4<Long,Long,Long,IntType>,TimeWindow>(){
      private boolean open=false;
      @Override public void open(      Configuration parameters){
        assertEquals(1,getRuntimeContext().getNumberOfParallelSubtasks());
        open=true;
      }
      @Override public void apply(      TimeWindow window,      Iterable<Tuple4<Long,Long,Long,IntType>> input,      Collector<Tuple4<Long,Long,Long,IntType>> out){
        assertTrue(open);
        for (        Tuple4<Long,Long,Long,IntType> in : input) {
          out.collect(new Tuple4<>(in.f0,window.getStart(),window.getEnd(),in.f3));
        }
      }
    }
).addSink(new ValidatingSink<>(new EventTimeWindowCheckpointingITCase.SinkValidatorUpdateFun(numElementsPerKey),new EventTimeWindowCheckpointingITCase.SinkValidatorCheckFun(numKeys,numElementsPerKey,windowSize))).setParallelism(1);
    env.execute("Tumbling Window Test");
  }
 catch (  Exception e) {
    e.printStackTrace();
    fail(e.getMessage());
  }
}
