@Test public void testRequestThenTwoCacheHitsOriginalAndOneCacheHitUnsubscribed(){
  AsyncCacheableCommand original=new AsyncCacheableCommand("foo");
  AsyncCacheableCommand fromCache1=new AsyncCacheableCommand("foo");
  AsyncCacheableCommand fromCache2=new AsyncCacheableCommand("foo");
  final AtomicReference<Boolean> originalValue=new AtomicReference<Boolean>(null);
  final AtomicReference<Boolean> fromCache1Value=new AtomicReference<Boolean>(null);
  final AtomicReference<Boolean> fromCache2Value=new AtomicReference<Boolean>(null);
  final CountDownLatch originalLatch=new CountDownLatch(1);
  final CountDownLatch fromCache1Latch=new CountDownLatch(1);
  final CountDownLatch fromCache2Latch=new CountDownLatch(1);
  Observable<Boolean> originalObservable=original.toObservable();
  Observable<Boolean> fromCache1Observable=fromCache1.toObservable();
  Observable<Boolean> fromCache2Observable=fromCache2.toObservable();
  Subscription originalSubscription=originalObservable.doOnUnsubscribe(new Action0(){
    @Override public void call(){
      System.out.println(System.currentTimeMillis() + " : " + Thread.currentThread().getName()+ " Test.Original Unsubscribe");
      originalLatch.countDown();
    }
  }
).subscribe(new Subscriber<Boolean>(){
    @Override public void onCompleted(){
      System.out.println(System.currentTimeMillis() + " : " + Thread.currentThread().getName()+ " Test.Original OnCompleted");
      originalLatch.countDown();
    }
    @Override public void onError(    Throwable e){
      System.out.println(System.currentTimeMillis() + " : " + Thread.currentThread().getName()+ " Test.Original OnError : "+ e);
      originalLatch.countDown();
    }
    @Override public void onNext(    Boolean b){
      System.out.println(System.currentTimeMillis() + " : " + Thread.currentThread().getName()+ " Test.Original OnNext : "+ b);
      originalValue.set(b);
    }
  }
);
  Subscription fromCache1Subscription=fromCache1Observable.doOnUnsubscribe(new Action0(){
    @Override public void call(){
      System.out.println(System.currentTimeMillis() + " : " + Thread.currentThread().getName()+ " Test.FromCache1 Unsubscribe");
      fromCache1Latch.countDown();
    }
  }
).subscribe(new Subscriber<Boolean>(){
    @Override public void onCompleted(){
      System.out.println(System.currentTimeMillis() + " : " + Thread.currentThread().getName()+ " Test.FromCache1 OnCompleted");
      fromCache1Latch.countDown();
    }
    @Override public void onError(    Throwable e){
      System.out.println(System.currentTimeMillis() + " : " + Thread.currentThread().getName()+ " Test.FromCache1 OnError : "+ e);
      fromCache1Latch.countDown();
    }
    @Override public void onNext(    Boolean b){
      System.out.println(System.currentTimeMillis() + " : " + Thread.currentThread().getName()+ " Test.FromCache1 OnNext : "+ b);
      fromCache1Value.set(b);
    }
  }
);
  Subscription fromCache2Subscription=fromCache2Observable.doOnUnsubscribe(new Action0(){
    @Override public void call(){
      System.out.println(System.currentTimeMillis() + " : " + Thread.currentThread().getName()+ " Test.FromCache2 Unsubscribe");
      fromCache2Latch.countDown();
    }
  }
).subscribe(new Subscriber<Boolean>(){
    @Override public void onCompleted(){
      System.out.println(System.currentTimeMillis() + " : " + Thread.currentThread().getName()+ " Test.FromCache2 OnCompleted");
      fromCache2Latch.countDown();
    }
    @Override public void onError(    Throwable e){
      System.out.println(System.currentTimeMillis() + " : " + Thread.currentThread().getName()+ " Test.FromCache2 OnError : "+ e);
      fromCache2Latch.countDown();
    }
    @Override public void onNext(    Boolean b){
      System.out.println(System.currentTimeMillis() + " : " + Thread.currentThread().getName()+ " Test.FromCache2 OnNext : "+ b);
      fromCache2Value.set(b);
    }
  }
);
  try {
    Thread.sleep(10);
    originalSubscription.unsubscribe();
    fromCache2Subscription.unsubscribe();
    assertTrue(originalLatch.await(600,TimeUnit.MILLISECONDS));
    assertTrue(fromCache1Latch.await(600,TimeUnit.MILLISECONDS));
    assertTrue(fromCache2Latch.await(600,TimeUnit.MILLISECONDS));
    System.out.println("ReqLog : " + HystrixRequestLog.getCurrentRequest().getExecutedCommandsAsString());
    assertEquals("Number of execution semaphores in use (original)",0,original.getExecutionSemaphore().getNumberOfPermitsUsed());
    assertEquals("Number of fallback semaphores in use (original)",0,original.getFallbackSemaphore().getNumberOfPermitsUsed());
    assertFalse(original.isExecutionComplete());
    assertTrue(original.isExecutedInThread());
    assertEquals(null,original.getFailedExecutionException());
    assertNull(original.getExecutionException());
    assertTrue(original.getExecutionTimeInMilliseconds() > -1);
    assertFalse(original.isSuccessfulExecution());
    assertCommandExecutionEvents(original,HystrixEventType.CANCELLED);
    assertNull(originalValue.get());
    assertFalse(original.isCancelled());
    assertEquals(0,original.metrics.getCurrentConcurrentExecutionCount());
    assertEquals("Number of execution semaphores in use (fromCache1)",0,fromCache1.getExecutionSemaphore().getNumberOfPermitsUsed());
    assertEquals("Number of fallback semaphores in use (fromCache1)",0,fromCache1.getFallbackSemaphore().getNumberOfPermitsUsed());
    assertTrue(fromCache1.isExecutionComplete());
    assertFalse(fromCache1.isExecutedInThread());
    assertEquals(null,fromCache1.getFailedExecutionException());
    assertNull(fromCache1.getExecutionException());
    assertCommandExecutionEvents(fromCache1,HystrixEventType.SUCCESS,HystrixEventType.RESPONSE_FROM_CACHE);
    assertTrue(fromCache1.getExecutionTimeInMilliseconds() == -1);
    assertTrue(fromCache1.isSuccessfulExecution());
    assertTrue(fromCache1Value.get());
    assertEquals(0,fromCache1.metrics.getCurrentConcurrentExecutionCount());
    assertEquals("Number of execution semaphores in use (fromCache2)",0,fromCache2.getExecutionSemaphore().getNumberOfPermitsUsed());
    assertEquals("Number of fallback semaphores in use (fromCache2)",0,fromCache2.getFallbackSemaphore().getNumberOfPermitsUsed());
    assertFalse(fromCache2.isExecutionComplete());
    assertFalse(fromCache2.isExecutedInThread());
    assertEquals(null,fromCache2.getFailedExecutionException());
    assertNull(fromCache2.getExecutionException());
    assertCommandExecutionEvents(fromCache2,HystrixEventType.RESPONSE_FROM_CACHE,HystrixEventType.CANCELLED);
    assertTrue(fromCache2.getExecutionTimeInMilliseconds() == -1);
    assertFalse(fromCache2.isSuccessfulExecution());
    assertNull(fromCache2Value.get());
    assertEquals(0,fromCache2.metrics.getCurrentConcurrentExecutionCount());
    assertSaneHystrixRequestLog(3);
  }
 catch (  InterruptedException ex) {
    ex.printStackTrace();
  }
}
