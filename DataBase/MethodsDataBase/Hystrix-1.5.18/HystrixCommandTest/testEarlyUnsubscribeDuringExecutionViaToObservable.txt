@Test public void testEarlyUnsubscribeDuringExecutionViaToObservable(){
class AsyncCommand extends HystrixCommand<Boolean> {
    public AsyncCommand(){
      super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey("ASYNC")));
    }
    @Override protected Boolean run(){
      try {
        Thread.sleep(500);
        return true;
      }
 catch (      InterruptedException ex) {
        throw new RuntimeException(ex);
      }
    }
  }
  HystrixCommand<Boolean> cmd=new AsyncCommand();
  final CountDownLatch latch=new CountDownLatch(1);
  Observable<Boolean> o=cmd.toObservable();
  Subscription s=o.doOnUnsubscribe(new Action0(){
    @Override public void call(){
      System.out.println("OnUnsubscribe");
      latch.countDown();
    }
  }
).subscribe(new Subscriber<Boolean>(){
    @Override public void onCompleted(){
      System.out.println("OnCompleted");
    }
    @Override public void onError(    Throwable e){
      System.out.println("OnError : " + e);
    }
    @Override public void onNext(    Boolean b){
      System.out.println("OnNext : " + b);
    }
  }
);
  try {
    Thread.sleep(10);
    s.unsubscribe();
    assertTrue(latch.await(200,TimeUnit.MILLISECONDS));
    System.out.println("ReqLog : " + HystrixRequestLog.getCurrentRequest().getExecutedCommandsAsString());
    assertEquals("Number of execution semaphores in use",0,cmd.getExecutionSemaphore().getNumberOfPermitsUsed());
    assertEquals("Number of fallback semaphores in use",0,cmd.getFallbackSemaphore().getNumberOfPermitsUsed());
    assertFalse(cmd.isExecutionComplete());
    assertEquals(null,cmd.getFailedExecutionException());
    assertNull(cmd.getExecutionException());
    System.out.println("Execution time : " + cmd.getExecutionTimeInMilliseconds());
    assertTrue(cmd.getExecutionTimeInMilliseconds() > -1);
    assertFalse(cmd.isSuccessfulExecution());
    assertCommandExecutionEvents(cmd,HystrixEventType.CANCELLED);
    assertEquals(0,cmd.metrics.getCurrentConcurrentExecutionCount());
    assertSaneHystrixRequestLog(1);
  }
 catch (  InterruptedException ex) {
    ex.printStackTrace();
  }
}
