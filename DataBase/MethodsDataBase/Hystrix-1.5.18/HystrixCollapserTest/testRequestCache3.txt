/** 
 * Test Request scoped caching with a mixture of commands
 */
@Test public void testRequestCache3(){
  final TestCollapserTimer timer=new TestCollapserTimer();
  SuccessfulCacheableCollapsedCommand command1=new SuccessfulCacheableCollapsedCommand(timer,"A",true);
  SuccessfulCacheableCollapsedCommand command2=new SuccessfulCacheableCollapsedCommand(timer,"B",true);
  SuccessfulCacheableCollapsedCommand command3=new SuccessfulCacheableCollapsedCommand(timer,"B",true);
  Future<String> f1=command1.queue();
  Future<String> f2=command2.queue();
  Future<String> f3=command3.queue();
  timer.incrementTime(15);
  try {
    assertEquals("A",f1.get(1000,TimeUnit.MILLISECONDS));
    assertEquals("B",f2.get(1000,TimeUnit.MILLISECONDS));
    assertEquals("B",f3.get(1000,TimeUnit.MILLISECONDS));
  }
 catch (  Exception e) {
    throw new RuntimeException(e);
  }
  Future<String> f4=command1.queue();
  Future<String> f5=command2.queue();
  Future<String> f6=command3.queue();
  timer.incrementTime(15);
  try {
    assertEquals("A",f4.get(1000,TimeUnit.MILLISECONDS));
    assertEquals("B",f5.get(1000,TimeUnit.MILLISECONDS));
    assertEquals("B",f6.get(1000,TimeUnit.MILLISECONDS));
  }
 catch (  Exception e) {
    throw new RuntimeException(e);
  }
  assertEquals(1,HystrixRequestLog.getCurrentRequest().getAllExecutedCommands().size());
  HystrixInvokableInfo<?> command=HystrixRequestLog.getCurrentRequest().getAllExecutedCommands().toArray(new HystrixInvokableInfo<?>[1])[0];
  assertEquals(2,command.getExecutionEvents().size());
  assertTrue(command.getExecutionEvents().contains(HystrixEventType.SUCCESS));
  assertTrue(command.getExecutionEvents().contains(HystrixEventType.COLLAPSED));
  Iterator<HystrixInvokableInfo<?>> cmdIterator=HystrixRequestLog.getCurrentRequest().getAllExecutedCommands().iterator();
  assertEquals(2,cmdIterator.next().getNumberCollapsed());
}
