/** 
 * Test the situation where a rename pending file exists but the rename is really done. This could happen if the rename process died just before deleting the rename pending file. It exercises a non-standard code path in redo().
 */
@Test public void testRenameRedoFolderAlreadyDone() throws IOException {
  String orig="originalFolder";
  String dest="renamedFolder";
  Path destPath=new Path(dest);
  assertTrue(fs.mkdirs(destPath));
  Path home=fs.getHomeDirectory();
  String relativeHomeDir=getRelativePath(home.toString());
  NativeAzureFileSystem.FolderRenamePending pending=new NativeAzureFileSystem.FolderRenamePending(relativeHomeDir + "/" + orig,relativeHomeDir + "/" + dest,null,(NativeAzureFileSystem)fs);
  final String renamePendingStr=orig + FolderRenamePending.SUFFIX;
  Path renamePendingFile=new Path(renamePendingStr);
  FSDataOutputStream out=fs.create(renamePendingFile,true);
  assertTrue(out != null);
  writeStringToStream(out,pending.makeRenamePendingFileContents());
  try {
    pending.redo();
  }
 catch (  Exception e) {
    fail();
  }
  FileStatus[] listed=fs.listStatus(new Path("/"));
  assertEquals("Pending directory still found",1,listed.length);
  assertTrue(listed[0].isDirectory());
}
