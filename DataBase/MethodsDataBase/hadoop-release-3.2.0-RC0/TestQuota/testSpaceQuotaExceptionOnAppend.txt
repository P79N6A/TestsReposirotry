@Test public void testSpaceQuotaExceptionOnAppend() throws Exception {
  GenericTestUtils.setLogLevel(DFSOutputStream.LOG,Level.TRACE);
  GenericTestUtils.setLogLevel(DataStreamer.LOG,Level.TRACE);
  final DFSAdmin dfsAdmin=new DFSAdmin(conf);
  final Path dir=new Path(PathUtils.getTestDir(getClass()).getPath(),GenericTestUtils.getMethodName());
  dfs.delete(dir,true);
  assertTrue(dfs.mkdirs(dir));
  final String[] args=new String[]{"-setSpaceQuota","4000",dir.toString()};
  ToolRunner.run(dfsAdmin,args);
  final Path testFile=new Path(dir,"file");
  OutputStream stream=dfs.create(testFile);
  stream.write("whatever".getBytes());
  stream.close();
  assertEquals(0,cluster.getNamesystem().getNumFilesUnderConstruction());
  stream=dfs.append(testFile);
  byte[] buf=AppendTestUtil.initBuffer(4096);
  stream.write(buf);
  try {
    stream.close();
    fail("close after append should fail");
  }
 catch (  DSQuotaExceededException expected) {
  }
  assertEquals(0,cluster.getNamesystem().getNumFilesUnderConstruction());
}
