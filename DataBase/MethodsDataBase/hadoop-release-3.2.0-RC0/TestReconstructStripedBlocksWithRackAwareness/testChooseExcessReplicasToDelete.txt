@Test public void testChooseExcessReplicasToDelete() throws Exception {
  cluster=new MiniDFSCluster.Builder(conf).racks(racks).hosts(hosts).numDataNodes(hosts.length).build();
  cluster.waitActive();
  fs=cluster.getFileSystem();
  fs.enableErasureCodingPolicy(StripedFileTestUtil.getDefaultECPolicy().getName());
  fs.setErasureCodingPolicy(new Path("/"),StripedFileTestUtil.getDefaultECPolicy().getName());
  MiniDFSCluster.DataNodeProperties lastHost=stopDataNode(hosts[hosts.length - 1]);
  final Path file=new Path("/foo");
  DFSTestUtil.createFile(fs,file,cellSize * dataBlocks * 2,(short)1,0L);
  MiniDFSCluster.DataNodeProperties host1=stopDataNode("host1");
  cluster.restartDataNode(lastHost);
  cluster.waitActive();
  final short blockNum=(short)(dataBlocks + parityBlocks);
  DFSTestUtil.waitForReplication(fs,file,blockNum,15 * 1000);
  cluster.restartDataNode(host1);
  cluster.waitActive();
  for (  DataNode dn : cluster.getDataNodes()) {
    if (dn.getDatanodeId().getHostName().equals("host1")) {
      DataNodeTestUtils.triggerBlockReport(dn);
      break;
    }
  }
  DFSTestUtil.waitForReplication(fs,file,blockNum,15 * 1000);
  LocatedBlocks blks=fs.getClient().getLocatedBlocks(file.toString(),0);
  LocatedStripedBlock block=(LocatedStripedBlock)blks.getLastLocatedBlock();
  for (  DatanodeInfo dn : block.getLocations()) {
    Assert.assertFalse(dn.getHostName().equals("host1"));
  }
}
