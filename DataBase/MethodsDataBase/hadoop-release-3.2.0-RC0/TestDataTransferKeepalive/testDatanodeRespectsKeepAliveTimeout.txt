/** 
 * Regression test for HDFS-3357. Check that the datanode is respecting its configured keepalive timeout.
 */
@Test(timeout=30000) public void testDatanodeRespectsKeepAliveTimeout() throws Exception {
  Configuration clientConf=new Configuration(conf);
  final long CLIENT_EXPIRY_MS=60000L;
  clientConf.setLong(DFS_CLIENT_SOCKET_CACHE_EXPIRY_MSEC_KEY,CLIENT_EXPIRY_MS);
  clientConf.set(DFS_CLIENT_CONTEXT,"testDatanodeRespectsKeepAliveTimeout");
  DistributedFileSystem fs=(DistributedFileSystem)FileSystem.get(cluster.getURI(),clientConf);
  PeerCache peerCache=ClientContext.getFromConf(clientConf).getPeerCache();
  DFSTestUtil.createFile(fs,TEST_FILE,1L,(short)1,0L);
  assertEquals(0,peerCache.size());
  assertXceiverCount(0);
  DFSTestUtil.readFile(fs,TEST_FILE);
  assertEquals(1,peerCache.size());
  assertXceiverCount(1);
  Thread.sleep(DFS_DATANODE_SOCKET_REUSE_KEEPALIVE_DEFAULT + 50);
  assertXceiverCount(0);
  assertEquals(1,peerCache.size());
  Peer peer=peerCache.get(dn.getDatanodeId(),false);
  assertNotNull(peer);
  assertEquals(-1,peer.getInputStream().read());
}
