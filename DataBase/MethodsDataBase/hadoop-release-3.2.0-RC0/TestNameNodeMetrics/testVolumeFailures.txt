/** 
 * Test metrics associated with volume failures.
 */
@Test public void testVolumeFailures() throws Exception {
  assertGauge("VolumeFailuresTotal",0,getMetrics(NS_METRICS));
  assertGauge("EstimatedCapacityLostTotal",0L,getMetrics(NS_METRICS));
  DataNode dn=cluster.getDataNodes().get(0);
  FsDatasetSpi.FsVolumeReferences volumeReferences=DataNodeTestUtils.getFSDataset(dn).getFsVolumeReferences();
  FsVolumeImpl fsVolume=(FsVolumeImpl)volumeReferences.get(0);
  File dataDir=new File(fsVolume.getBaseURI());
  long capacity=fsVolume.getCapacity();
  volumeReferences.close();
  File storageDir=new File(dataDir,Storage.STORAGE_DIR_CURRENT);
  DataNodeTestUtils.injectDataDirFailure(storageDir);
  DataNodeTestUtils.waitForDiskError(dn,fsVolume);
  DataNodeTestUtils.triggerHeartbeat(dn);
  BlockManagerTestUtil.checkHeartbeat(bm);
  assertGauge("VolumeFailuresTotal",1,getMetrics(NS_METRICS));
  assertGauge("EstimatedCapacityLostTotal",capacity,getMetrics(NS_METRICS));
}
