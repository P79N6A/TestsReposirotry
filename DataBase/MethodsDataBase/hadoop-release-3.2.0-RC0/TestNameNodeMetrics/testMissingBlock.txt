/** 
 * Test to ensure metrics reflects missing blocks 
 */
@Test public void testMissingBlock() throws Exception {
  Path file=getTestPath("testMissingBlocks");
  createFile(file,100,(short)1);
  LocatedBlock block=NameNodeAdapter.getBlockLocations(cluster.getNameNode(),file.toString(),0,1).get(0);
  cluster.getNamesystem().writeLock();
  try {
    bm.findAndMarkBlockAsCorrupt(block.getBlock(),block.getLocations()[0],"STORAGE_ID","TEST");
  }
  finally {
    cluster.getNamesystem().writeUnlock();
  }
  Thread.sleep(1000);
  MetricsRecordBuilder rb=getMetrics(NS_METRICS);
  assertGauge("UnderReplicatedBlocks",1L,rb);
  assertGauge("MissingBlocks",1L,rb);
  assertGauge("MissingReplOneBlocks",1L,rb);
  assertGauge("HighestPriorityLowRedundancyReplicatedBlocks",0L,rb);
  assertGauge("HighestPriorityLowRedundancyECBlocks",0L,rb);
  fs.delete(file,true);
  waitForDnMetricValue(NS_METRICS,"UnderReplicatedBlocks",0L);
}
