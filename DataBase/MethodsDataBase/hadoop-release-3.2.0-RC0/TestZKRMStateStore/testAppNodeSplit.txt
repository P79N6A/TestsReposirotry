@Test public void testAppNodeSplit() throws Exception {
  TestZKRMStateStoreTester zkTester=new TestZKRMStateStoreTester();
  long submitTime=System.currentTimeMillis();
  long startTime=submitTime + 1234;
  Configuration conf=new YarnConfiguration();
  RMStateStore store=zkTester.getRMStateStore(createConfForAppNodeSplit(1));
  TestDispatcher dispatcher=new TestDispatcher();
  store.setRMDispatcher(dispatcher);
  RMContext rmContext=mock(RMContext.class);
  when(rmContext.getStateStore()).thenReturn(store);
  AMRMTokenSecretManager appTokenMgr=spy(new AMRMTokenSecretManager(conf,rmContext));
  MasterKeyData masterKeyData=appTokenMgr.createNewMasterKey();
  when(appTokenMgr.getMasterKey()).thenReturn(masterKeyData);
  ClientToAMTokenSecretManagerInRM clientToAMTokenMgr=new ClientToAMTokenSecretManagerInRM();
  ApplicationId appId1=ApplicationId.newInstance(1352994193343L,1);
  ApplicationAttemptId attemptId1=ApplicationAttemptId.newInstance(appId1,1);
  ApplicationAttemptId attemptId2=ApplicationAttemptId.newInstance(appId1,2);
  storeAppWithAttempts(store,dispatcher,submitTime,startTime,appTokenMgr,clientToAMTokenMgr,attemptId1,attemptId2);
  ApplicationId appId21=ApplicationId.newInstance(1352994193343L,120213);
  storeApp(store,appId21,submitTime,startTime);
  waitNotify(dispatcher);
  ApplicationId appIdRemoved=ApplicationId.newInstance(1352994193343L,2);
  ApplicationAttemptId attemptIdRemoved=ApplicationAttemptId.newInstance(appIdRemoved,1);
  storeAppWithAttempts(store,dispatcher,submitTime,startTime,null,null,attemptIdRemoved);
  RMApp mockRemovedApp=createMockAppForRemove(appIdRemoved,attemptIdRemoved);
  store.removeApplication(mockRemovedApp);
  store.close();
  store=zkTester.getRMStateStore(createConfForAppNodeSplit(1));
  store.setRMDispatcher(dispatcher);
  RMState state=store.loadState();
  verifyAppPathPath(store,appId21,1);
  verifyLoadedApp(state,appId1,submitTime,startTime,0,false,Lists.newArrayList(attemptId1,attemptId2),Lists.newArrayList(-1000,-1000),Lists.newArrayList((FinalApplicationStatus)null,null));
  finishAppWithAttempts(state,store,dispatcher,attemptId2,submitTime,startTime,100,1234,false);
  ApplicationId dummyAppId=ApplicationId.newInstance(1234,10);
  ApplicationAttemptId dummyAttemptId=ApplicationAttemptId.newInstance(dummyAppId,6);
  finishAppWithAttempts(state,store,dispatcher,dummyAttemptId,submitTime,startTime,111,1234,true);
  store.close();
  store=zkTester.getRMStateStore(createConfForAppNodeSplit(1));
  store.setRMDispatcher(dispatcher);
  RMState newRMState=store.loadState();
  verifyLoadedApp(newRMState,dummyAppId,submitTime,startTime,1234,true,Lists.newArrayList(dummyAttemptId),Lists.newArrayList(111),Lists.newArrayList(FinalApplicationStatus.SUCCEEDED));
  verifyLoadedApp(newRMState,appId1,submitTime,startTime,1234,true,Lists.newArrayList(attemptId1,attemptId2),Lists.newArrayList(-1000,100),Lists.newArrayList(null,FinalApplicationStatus.SUCCEEDED));
  assertTrue("Store is not in expected state",zkTester.isFinalStateValid());
  store.close();
}
