/** 
 * Test to simulate interleaved checkpointing by 2 2NNs after a storage directory has been taken offline. The first will cause the directory to come back online, but it won't have any valid contents. The second 2NN will then try to perform a checkpoint. The NN should not serve up the image or edits from the restored (empty) dir.
 */
@Test public void testMultipleSecondaryCheckpoint() throws IOException {
  SecondaryNameNode secondary=null;
  try {
    cluster=new MiniDFSCluster.Builder(config).numDataNodes(1).manageNameDfsDirs(false).build();
    cluster.waitActive();
    secondary=new SecondaryNameNode(config);
    FSImage fsImage=cluster.getNameNode().getFSImage();
    printStorages(fsImage);
    FileSystem fs=cluster.getFileSystem();
    Path testPath=new Path("/","test");
    assertTrue(fs.mkdirs(testPath));
    printStorages(fsImage);
    invalidateStorage(fsImage,ImmutableSet.of(path1));
    cluster.getNameNodeRpc().rollEditLog();
    printStorages(fsImage);
    secondary.doCheckpoint();
    printStorages(fsImage);
    assertTrue("path exists before restart",fs.exists(testPath));
    secondary.shutdown();
    cluster.restartNameNode();
    assertTrue("path should still exist after restart",fs.exists(testPath));
  }
  finally {
    if (cluster != null) {
      cluster.shutdown();
    }
    if (secondary != null) {
      secondary.shutdown();
    }
  }
}
