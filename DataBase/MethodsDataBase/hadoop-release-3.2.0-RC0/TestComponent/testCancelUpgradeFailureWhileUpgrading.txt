@Test public void testCancelUpgradeFailureWhileUpgrading() throws Exception {
  String serviceName="testCancelUpgradeFailureWhileUpgrading";
  MockRunningServiceContext context=createTestContext(rule,serviceName);
  Component comp=context.scheduler.getAllComponents().entrySet().iterator().next().getValue();
  cancelUpgradeWhileUpgrading(context,comp);
  for (  ComponentInstance instance : comp.getAllComponentInstances()) {
    instance.handle(new ComponentInstanceEvent(instance.getContainer().getId(),ComponentInstanceEventType.STOP));
  }
  comp.handle(new ComponentEvent(comp.getName(),ComponentEventType.CHECK_STABLE));
  Assert.assertEquals("component not in flexing state",ComponentState.FLEXING,comp.getComponentSpec().getState());
  for (  ComponentInstance instance : comp.getAllComponentInstances()) {
    context.assignNewContainer(context.attemptId,10,comp);
  }
  comp.handle(new ComponentEvent(comp.getName(),ComponentEventType.CHECK_STABLE));
  Assert.assertEquals("component not in stable state",ComponentState.STABLE,comp.getComponentSpec().getState());
  Assert.assertEquals("cancel upgrade failed","val0",comp.getComponentSpec().getConfiguration().getEnv("key1"));
}
