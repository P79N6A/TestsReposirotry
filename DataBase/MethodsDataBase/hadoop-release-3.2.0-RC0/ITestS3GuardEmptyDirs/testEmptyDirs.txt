@Test public void testEmptyDirs() throws Exception {
  S3AFileSystem fs=getFileSystem();
  Assume.assumeTrue(fs.hasMetadataStore());
  MetadataStore configuredMs=fs.getMetadataStore();
  Path existingDir=path("existing-dir");
  Path existingFile=path("existing-dir/existing-file");
  try {
    fs.setMetadataStore(new NullMetadataStore());
    assertTrue(fs.mkdirs(existingDir));
    touch(fs,existingFile);
    fs.setMetadataStore(configuredMs);
    Path newFile=path("existing-dir/new-file");
    touch(fs,newFile);
    S3AFileStatus status=fs.innerGetFileStatus(existingDir,true);
    assertEquals("Should not be empty dir",Tristate.FALSE,status.isEmptyDirectory());
    fs.delete(newFile,false);
    status=fs.innerGetFileStatus(existingDir,true);
    assertEquals("Should not be empty dir",Tristate.FALSE,status.isEmptyDirectory());
    fs.delete(existingFile,false);
    status=fs.innerGetFileStatus(existingDir,true);
    assertEquals("Should be empty dir now",Tristate.TRUE,status.isEmptyDirectory());
  }
  finally {
    configuredMs.forgetMetadata(existingFile);
    configuredMs.forgetMetadata(existingDir);
  }
}
