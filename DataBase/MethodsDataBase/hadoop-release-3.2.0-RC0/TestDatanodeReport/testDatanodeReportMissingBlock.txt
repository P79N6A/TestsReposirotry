@Test public void testDatanodeReportMissingBlock() throws Exception {
  conf.setLong(DFSConfigKeys.DFS_HEARTBEAT_INTERVAL_KEY,1L);
  conf.setLong(HdfsClientConfigKeys.Retry.WINDOW_BASE_KEY,1);
  MiniDFSCluster cluster=new MiniDFSCluster.Builder(conf).numDataNodes(NUM_OF_DATANODES).build();
  try {
    cluster.waitActive();
    DistributedFileSystem fs=cluster.getFileSystem();
    Path p=new Path("/testDatanodeReportMissingBlock");
    DFSTestUtil.writeFile(fs,p,new String("testdata"));
    LocatedBlock lb=fs.getClient().getLocatedBlocks(p.toString(),0).get(0);
    assertEquals(3,lb.getLocations().length);
    ExtendedBlock b=lb.getBlock();
    cluster.corruptBlockOnDataNodesByDeletingBlockFile(b);
    try {
      DFSTestUtil.readFile(fs,p);
      Assert.fail("Must throw exception as the block doesn't exists on disk");
    }
 catch (    IOException e) {
    }
    cluster.triggerHeartbeats();
    lb=fs.getClient().getLocatedBlocks(p.toString(),0).get(0);
    assertEquals(0,lb.getLocations().length);
  }
  finally {
    cluster.shutdown();
  }
}
