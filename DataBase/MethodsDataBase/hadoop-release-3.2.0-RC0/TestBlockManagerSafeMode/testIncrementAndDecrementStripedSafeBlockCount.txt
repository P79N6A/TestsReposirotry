/** 
 * Test when the block safe increment and decrement interleave for striped blocks. Both the increment and decrement will be a no-op if the safe mode is OFF. The safe mode status lifecycle: OFF -> PENDING_THRESHOLD -> OFF
 */
@Test(timeout=30000) public void testIncrementAndDecrementStripedSafeBlockCount(){
  bmSafeMode.activate(BLOCK_TOTAL);
  Whitebox.setInternalState(bmSafeMode,"extension",0);
  final int liveReplicasWhenDecrementing=1;
  final short realDataBlockNum=2;
  mockBlockManagerForStripedBlockSafeDecrement(liveReplicasWhenDecrementing);
  for (long i=1; i <= BLOCK_TOTAL; i++) {
    BlockInfoStriped blockInfo=mock(BlockInfoStriped.class);
    when(blockInfo.getRealDataBlockNum()).thenReturn(realDataBlockNum);
    bmSafeMode.incrementSafeBlockCount(realDataBlockNum,blockInfo);
    bmSafeMode.decrementSafeBlockCount(blockInfo);
    bmSafeMode.incrementSafeBlockCount(realDataBlockNum,blockInfo);
    assertSafeModeIsLeftAtThreshold(i);
  }
}
