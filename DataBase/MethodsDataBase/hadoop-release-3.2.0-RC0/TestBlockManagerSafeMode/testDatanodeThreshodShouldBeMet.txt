/** 
 * Test block manager won't leave safe mode if datanode threshold is not met.
 */
@Test(timeout=30000) public void testDatanodeThreshodShouldBeMet() throws Exception {
  bmSafeMode.activate(BLOCK_TOTAL);
  when(dn.getNumLiveDataNodes()).thenReturn(1);
  setBlockSafe(BLOCK_THRESHOLD);
  bmSafeMode.checkSafeMode();
  assertTrue(bmSafeMode.isInSafeMode());
  when(dn.getNumLiveDataNodes()).thenReturn(DATANODE_NUM);
  bmSafeMode.checkSafeMode();
  waitForExtensionPeriod();
  assertFalse(bmSafeMode.isInSafeMode());
}
