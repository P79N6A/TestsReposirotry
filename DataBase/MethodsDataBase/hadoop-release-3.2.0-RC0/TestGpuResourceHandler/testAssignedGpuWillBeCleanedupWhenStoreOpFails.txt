@SuppressWarnings("unchecked") @Test public void testAssignedGpuWillBeCleanedupWhenStoreOpFails() throws Exception {
  Configuration conf=new YarnConfiguration();
  conf.set(YarnConfiguration.NM_GPU_ALLOWED_DEVICES,"0:0,1:1,2:3,3:4");
  GpuDiscoverer.getInstance().initialize(conf);
  gpuResourceHandler.bootstrap(conf);
  Assert.assertEquals(4,gpuResourceHandler.getGpuAllocator().getAvailableGpus());
  doThrow(new IOException("Exception ...")).when(mockNMStateStore).storeAssignedResources(any(Container.class),anyString(),anyList());
  boolean exception=false;
  try {
    gpuResourceHandler.preStart(mockContainerWithGpuRequest(1,3));
  }
 catch (  ResourceHandlerException e) {
    exception=true;
  }
  Assert.assertTrue("preStart should throw exception",exception);
  Assert.assertEquals(4,gpuResourceHandler.getGpuAllocator().getAvailableGpus());
}
