@Test public void testIdempotentCloseWithFailedStreams() throws Exception {
  HdfsConfiguration conf=new HdfsConfiguration();
  conf.setLong(DFSConfigKeys.DFS_BLOCK_SIZE_KEY,blockSize);
  try {
    setup(conf);
    while (cluster.getDataNodes().size() >= dataBlocks) {
      cluster.stopDataNode(0);
    }
    cluster.restartNameNodes();
    cluster.triggerHeartbeats();
    testCloseWithExceptionsInStreamer(1,false);
    testCloseWithExceptionsInStreamer(ecPolicy.getNumParityUnits(),false);
    testCloseWithExceptionsInStreamer(ecPolicy.getNumParityUnits() + 1,true);
    testCloseWithExceptionsInStreamer(ecPolicy.getNumDataUnits(),true);
  }
  finally {
    tearDown();
  }
}
