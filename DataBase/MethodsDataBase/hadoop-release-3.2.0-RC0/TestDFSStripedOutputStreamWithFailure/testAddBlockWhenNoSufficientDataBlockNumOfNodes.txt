@Test(timeout=90000) public void testAddBlockWhenNoSufficientDataBlockNumOfNodes() throws Exception {
  HdfsConfiguration conf=new HdfsConfiguration();
  conf.setLong(DFSConfigKeys.DFS_BLOCK_SIZE_KEY,blockSize);
  try {
    setup(conf);
    ArrayList<DataNode> dataNodes=cluster.getDataNodes();
    int numDatanodes=dataNodes.size();
    while (numDatanodes >= dataBlocks) {
      cluster.stopDataNode(0);
      numDatanodes--;
    }
    cluster.restartNameNodes();
    cluster.triggerHeartbeats();
    DatanodeInfo[] info=dfs.getClient().datanodeReport(DatanodeReportType.LIVE);
    assertEquals("Mismatches number of live Dns",numDatanodes,info.length);
    final Path dirFile=new Path(dir,"ecfile");
    LambdaTestUtils.intercept(IOException.class,"File " + dirFile + " could only be written to "+ numDatanodes+ " of the "+ dataBlocks+ " required nodes for "+ ecPolicy.getName(),() -> {
      try (FSDataOutputStream out=dfs.create(dirFile,true)){
        out.write("something".getBytes());
        out.flush();
      }
       return 0;
    }
);
  }
  finally {
    tearDown();
  }
}
