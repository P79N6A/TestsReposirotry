@Test public void testFakeDirectoryDeletion() throws Throwable {
  describe("Verify whether create file works after renaming a file. " + "In S3, rename deletes any fake directories as a part of " + "clean up activity");
  S3AFileSystem fs=getFileSystem();
  Path srcBaseDir=path("src");
  mkdirs(srcBaseDir);
  MetricDiff deleteRequests=new MetricDiff(fs,Statistic.OBJECT_DELETE_REQUESTS);
  MetricDiff directoriesDeleted=new MetricDiff(fs,Statistic.DIRECTORIES_DELETED);
  MetricDiff fakeDirectoriesDeleted=new MetricDiff(fs,Statistic.FAKE_DIRECTORIES_DELETED);
  MetricDiff directoriesCreated=new MetricDiff(fs,Statistic.DIRECTORIES_CREATED);
  Object summary=new Object(){
    @Override public String toString(){
      return String.format("[%s, %s, %s, %s]",directoriesCreated,directoriesDeleted,deleteRequests,fakeDirectoriesDeleted);
    }
  }
;
  Callable<Boolean> reset=() -> reset(deleteRequests,directoriesCreated,directoriesDeleted,fakeDirectoriesDeleted);
  Path srcDir=new Path(srcBaseDir,"1/2/3/4/5/6");
  int srcDirDepth=directoriesInPath(srcDir);
  mkdirs(srcDir);
  String state="after mkdir(srcDir) " + summary;
  directoriesCreated.assertDiffEquals(state,1);
  deleteRequests.assertDiffEquals(state,1);
  directoriesDeleted.assertDiffEquals(state,0);
  fakeDirectoriesDeleted.assertDiffEquals(state,srcDirDepth - 1);
  reset.call();
  final Path srcFilePath=new Path(srcDir,"source.txt");
  touch(fs,srcFilePath);
  state="after touch(fs, srcFilePath) " + summary;
  deleteRequests.assertDiffEquals(state,1);
  directoriesCreated.assertDiffEquals(state,0);
  directoriesDeleted.assertDiffEquals(state,0);
  fakeDirectoriesDeleted.assertDiffEquals(state,srcDirDepth);
  reset.call();
  Path destBaseDir=path("dest");
  Path destDir=new Path(destBaseDir,"1/2/3/4/5/6");
  Path destFilePath=new Path(destDir,"dest.txt");
  mkdirs(destDir);
  state="after mkdir(destDir) " + summary;
  int destDirDepth=directoriesInPath(destDir);
  directoriesCreated.assertDiffEquals(state,1);
  deleteRequests.assertDiffEquals(state,1);
  directoriesDeleted.assertDiffEquals(state,0);
  fakeDirectoriesDeleted.assertDiffEquals(state,destDirDepth - 1);
  final Path srcFile2=new Path(srcDir.toUri() + "/source2.txt");
  touch(fs,srcFile2);
  reset.call();
  fs.rename(srcFilePath,destFilePath);
  state=String.format("after rename(srcFilePath, destFilePath)" + " %s dest dir depth=%d",summary,destDirDepth);
  directoriesCreated.assertDiffEquals(state,0);
  deleteRequests.assertDiffEquals(state,2);
  directoriesDeleted.assertDiffEquals(state,0);
  fakeDirectoriesDeleted.assertDiffEquals(state,destDirDepth);
  assertIsFile(destFilePath);
  assertIsDirectory(srcDir);
  assertPathDoesNotExist("should have gone in the rename",srcFilePath);
  reset.call();
  fs.rename(srcFile2,srcFilePath);
  state=String.format("after rename(%s, %s) %s dest dir depth=%d",srcFile2,srcFilePath,summary,destDirDepth);
  directoriesCreated.assertDiffEquals(state,0);
  deleteRequests.assertDiffEquals(state,1);
  directoriesDeleted.assertDiffEquals(state,0);
  fakeDirectoriesDeleted.assertDiffEquals(state,0);
}
