@Test public void testDirectoryScannerInFederatedCluster() throws Exception {
  try (MiniDFSCluster cluster=new MiniDFSCluster.Builder(CONF).nnTopology(MiniDFSNNTopology.simpleHAFederatedTopology(2)).numDataNodes(1).build()){
    cluster.waitActive();
    cluster.transitionToActive(1);
    cluster.transitionToActive(3);
    DataNode dataNode=cluster.getDataNodes().get(0);
    fds=DataNodeTestUtils.getFSDataset(cluster.getDataNodes().get(0));
    FileSystem fs=cluster.getFileSystem(1);
    int bp1Files=1;
    writeFile(fs,bp1Files);
    FileSystem fs2=cluster.getFileSystem(3);
    int bp2Files=2;
    writeFile(fs2,bp2Files);
    scanner=new DirectoryScanner(dataNode,fds,CONF);
    scanner.setRetainDiffs(true);
    scanner.reconcile();
    GenericTestUtils.waitFor(() -> {
      try {
        bpid=cluster.getNamesystem(1).getBlockPoolId();
        verifyStats(bp1Files,0,0,0,0,0,0);
        bpid=cluster.getNamesystem(3).getBlockPoolId();
        verifyStats(bp2Files,0,0,0,0,0,0);
      }
 catch (      AssertionError ex) {
        return false;
      }
      return true;
    }
,50,2000);
  }
  finally {
    if (scanner != null) {
      scanner.shutdown();
      scanner=null;
    }
  }
}
