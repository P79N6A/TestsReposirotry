/** 
 * Assert that when we abort a multipart upload, the resulting file does not show up.
 */
@Test public void testMultipartUploadAbort() throws Exception {
  describe("Upload and then abort it before completing");
  FileSystem fs=getFileSystem();
  Path file=path("testMultipartUploadAbort");
  MultipartUploader mpu=MultipartUploaderFactory.get(fs,null);
  UploadHandle uploadHandle=mpu.initialize(file);
  List<Pair<Integer,PartHandle>> partHandles=new ArrayList<>();
  for (int i=20; i >= 10; --i) {
    byte[] payload=generatePayload(i);
    InputStream is=new ByteArrayInputStream(payload);
    PartHandle partHandle=mpu.putPart(file,is,i,uploadHandle,payload.length);
    partHandles.add(Pair.of(i,partHandle));
  }
  mpu.abort(file,uploadHandle);
  String contents="ThisIsPart49\n";
  int len=contents.getBytes(Charsets.UTF_8).length;
  InputStream is=IOUtils.toInputStream(contents,"UTF-8");
  intercept(IOException.class,() -> mpu.putPart(file,is,49,uploadHandle,len));
  intercept(IOException.class,() -> mpu.complete(file,partHandles,uploadHandle));
  assertPathDoesNotExist("Uploaded file should not exist",file);
}
