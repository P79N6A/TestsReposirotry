/** 
 * Assert that a multipart upload is successful.
 * @throws Exception failure
 */
@Test public void testMultipartUpload() throws Exception {
  FileSystem fs=getFileSystem();
  Path file=path("testMultipartUpload");
  MultipartUploader mpu=MultipartUploaderFactory.get(fs,null);
  UploadHandle uploadHandle=mpu.initialize(file);
  List<Pair<Integer,PartHandle>> partHandles=new ArrayList<>();
  MessageDigest origDigest=DigestUtils.getMd5Digest();
  final int payloadCount=getTestPayloadCount();
  for (int i=1; i <= payloadCount; ++i) {
    byte[] payload=generatePayload(i);
    origDigest.update(payload);
    InputStream is=new ByteArrayInputStream(payload);
    PartHandle partHandle=mpu.putPart(file,is,i,uploadHandle,payload.length);
    partHandles.add(Pair.of(i,partHandle));
  }
  completeUpload(file,mpu,uploadHandle,partHandles,origDigest,payloadCount * partSizeInBytes());
}
