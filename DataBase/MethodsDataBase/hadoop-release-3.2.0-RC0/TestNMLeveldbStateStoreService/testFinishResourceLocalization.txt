@Test public void testFinishResourceLocalization() throws IOException {
  String user="somebody";
  ApplicationId appId=ApplicationId.newInstance(1,1);
  Path appRsrcPath=new Path("hdfs://some/app/resource");
  LocalResourcePBImpl rsrcPb=(LocalResourcePBImpl)LocalResource.newInstance(URL.fromPath(appRsrcPath),LocalResourceType.ARCHIVE,LocalResourceVisibility.APPLICATION,123L,456L);
  LocalResourceProto appRsrcProto=rsrcPb.getProto();
  Path appRsrcLocalPath=new Path("/some/local/dir/for/apprsrc");
  stateStore.startResourceLocalization(user,appId,appRsrcProto,appRsrcLocalPath);
  LocalizedResourceProto appLocalizedProto=LocalizedResourceProto.newBuilder().setResource(appRsrcProto).setLocalPath(appRsrcLocalPath.toString()).setSize(1234567L).build();
  stateStore.finishResourceLocalization(user,appId,appLocalizedProto);
  List<LocalizedResourceProto> completedResources=new ArrayList<LocalizedResourceProto>();
  Map<LocalResourceProto,Path> startedResources=new HashMap<LocalResourceProto,Path>();
  restartStateStore();
  RecoveredLocalizationState state=stateStore.loadLocalizationState();
  LocalResourceTrackerState pubts=state.getPublicTrackerState();
  completedResources=loadCompletedResources(pubts.getCompletedResourcesIterator());
  startedResources=loadStartedResources(pubts.getStartedResourcesIterator());
  assertTrue(completedResources.isEmpty());
  assertTrue(startedResources.isEmpty());
  Map<String,RecoveredUserResources> userResources=loadUserResources(state.getIterator());
  assertEquals(1,userResources.size());
  RecoveredUserResources rur=userResources.get(user);
  LocalResourceTrackerState privts=rur.getPrivateTrackerState();
  assertNotNull(privts);
  completedResources=loadCompletedResources(privts.getCompletedResourcesIterator());
  startedResources=loadStartedResources(privts.getStartedResourcesIterator());
  assertTrue(completedResources.isEmpty());
  assertTrue(startedResources.isEmpty());
  assertEquals(1,rur.getAppTrackerStates().size());
  LocalResourceTrackerState appts=rur.getAppTrackerStates().get(appId);
  assertNotNull(appts);
  completedResources=loadCompletedResources(appts.getCompletedResourcesIterator());
  startedResources=loadStartedResources(appts.getStartedResourcesIterator());
  assertTrue(startedResources.isEmpty());
  assertEquals(1,completedResources.size());
  assertEquals(appLocalizedProto,completedResources.iterator().next());
  Path pubRsrcPath1=new Path("hdfs://some/public/resource1");
  rsrcPb=(LocalResourcePBImpl)LocalResource.newInstance(URL.fromPath(pubRsrcPath1),LocalResourceType.FILE,LocalResourceVisibility.PUBLIC,789L,135L);
  LocalResourceProto pubRsrcProto1=rsrcPb.getProto();
  Path pubRsrcLocalPath1=new Path("/some/local/dir/for/pubrsrc1");
  stateStore.startResourceLocalization(null,null,pubRsrcProto1,pubRsrcLocalPath1);
  Path pubRsrcPath2=new Path("hdfs://some/public/resource2");
  rsrcPb=(LocalResourcePBImpl)LocalResource.newInstance(URL.fromPath(pubRsrcPath2),LocalResourceType.FILE,LocalResourceVisibility.PUBLIC,789L,135L);
  LocalResourceProto pubRsrcProto2=rsrcPb.getProto();
  Path pubRsrcLocalPath2=new Path("/some/local/dir/for/pubrsrc2");
  stateStore.startResourceLocalization(null,null,pubRsrcProto2,pubRsrcLocalPath2);
  Path privRsrcPath=new Path("hdfs://some/private/resource");
  rsrcPb=(LocalResourcePBImpl)LocalResource.newInstance(URL.fromPath(privRsrcPath),LocalResourceType.PATTERN,LocalResourceVisibility.PRIVATE,789L,680L,"*pattern*");
  LocalResourceProto privRsrcProto=rsrcPb.getProto();
  Path privRsrcLocalPath=new Path("/some/local/dir/for/privrsrc");
  stateStore.startResourceLocalization(user,null,privRsrcProto,privRsrcLocalPath);
  LocalizedResourceProto pubLocalizedProto1=LocalizedResourceProto.newBuilder().setResource(pubRsrcProto1).setLocalPath(pubRsrcLocalPath1.toString()).setSize(pubRsrcProto1.getSize()).build();
  stateStore.finishResourceLocalization(null,null,pubLocalizedProto1);
  LocalizedResourceProto privLocalizedProto=LocalizedResourceProto.newBuilder().setResource(privRsrcProto).setLocalPath(privRsrcLocalPath.toString()).setSize(privRsrcProto.getSize()).build();
  stateStore.finishResourceLocalization(user,null,privLocalizedProto);
  restartStateStore();
  state=stateStore.loadLocalizationState();
  pubts=state.getPublicTrackerState();
  completedResources=loadCompletedResources(pubts.getCompletedResourcesIterator());
  startedResources=loadStartedResources(pubts.getStartedResourcesIterator());
  assertEquals(1,completedResources.size());
  assertEquals(pubLocalizedProto1,completedResources.iterator().next());
  assertEquals(1,startedResources.size());
  assertEquals(pubRsrcLocalPath2,startedResources.get(pubRsrcProto2));
  userResources=loadUserResources(state.getIterator());
  assertEquals(1,userResources.size());
  rur=userResources.get(user);
  privts=rur.getPrivateTrackerState();
  assertNotNull(privts);
  completedResources=loadCompletedResources(privts.getCompletedResourcesIterator());
  startedResources=loadStartedResources(privts.getStartedResourcesIterator());
  assertEquals(1,completedResources.size());
  assertEquals(privLocalizedProto,completedResources.iterator().next());
  assertTrue(startedResources.isEmpty());
  assertEquals(1,rur.getAppTrackerStates().size());
  appts=rur.getAppTrackerStates().get(appId);
  assertNotNull(appts);
  completedResources=loadCompletedResources(appts.getCompletedResourcesIterator());
  startedResources=loadStartedResources(appts.getStartedResourcesIterator());
  assertTrue(startedResources.isEmpty());
  assertEquals(1,completedResources.size());
  assertEquals(appLocalizedProto,completedResources.iterator().next());
}
