@Test public void testInvalidateBlock() throws IOException {
  final Path file=new Path("/invalidate");
  final int length=10;
  final byte[] bytes=StripedFileTestUtil.generateBytes(length);
  DFSTestUtil.writeFile(dfs,file,bytes);
  int dnIndex=findFirstDataNode(cluster,dfs,file,CELL_SIZE * NUM_DATA_UNITS);
  Assert.assertNotEquals(-1,dnIndex);
  LocatedStripedBlock slb=(LocatedStripedBlock)dfs.getClient().getLocatedBlocks(file.toString(),0,CELL_SIZE * NUM_DATA_UNITS).get(0);
  final LocatedBlock[] blks=StripedBlockUtil.parseStripedBlockGroup(slb,CELL_SIZE,NUM_DATA_UNITS,NUM_PARITY_UNITS);
  final Block b=blks[0].getBlock().getLocalBlock();
  DataNode dn=cluster.getDataNodes().get(dnIndex);
  DataNodeTestUtils.setHeartbeatsDisabledForTests(dn,true);
  try {
    dfs.delete(file,true);
    final FSNamesystem fsn=cluster.getNamesystem();
    final BlockManager bm=fsn.getBlockManager();
    DatanodeDescriptor dnd=NameNodeAdapter.getDatanode(fsn,dn.getDatanodeId());
    Assert.assertTrue(bm.containsInvalidateBlock(blks[0].getLocations()[0],b) || dnd.containsInvalidateBlock(b));
  }
  finally {
    DataNodeTestUtils.setHeartbeatsDisabledForTests(dn,false);
  }
}
