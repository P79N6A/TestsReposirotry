@Test public void testParentQueueUpdateInQueueMappingFailsAfterAutoCreation() throws Exception {
  MockRM newMockRM=setupSchedulerInstance();
  CapacityScheduler newCS=(CapacityScheduler)newMockRM.getResourceScheduler();
  try {
    submitApp(newCS,USER0,USER0,PARENT_QUEUE);
    assertNotNull(newCS.getQueue(USER0));
    setupQueueMapping(newCS,USER0,"d",USER0);
    newCS.updatePlacementRules();
    RMContext rmContext=mock(RMContext.class);
    when(rmContext.getDispatcher()).thenReturn(dispatcher);
    newCS.setRMContext(rmContext);
    ApplicationId appId=BuilderUtils.newApplicationId(1,1);
    SchedulerEvent addAppEvent=new AppAddedSchedulerEvent(appId,USER0,USER0,new ApplicationPlacementContext(USER0,"d"));
    newCS.handle(addAppEvent);
    RMAppEvent event=new RMAppEvent(appId,RMAppEventType.APP_REJECTED,"error");
    dispatcher.spyOnNextEvent(event,10000);
  }
  finally {
    if (newMockRM != null) {
      ((CapacityScheduler)newMockRM.getResourceScheduler()).stop();
      newMockRM.stop();
    }
  }
}
