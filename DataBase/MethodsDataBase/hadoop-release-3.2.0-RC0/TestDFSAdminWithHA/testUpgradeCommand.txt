@Test(timeout=300000) public void testUpgradeCommand() throws Exception {
  final String finalizedMsg="Upgrade finalized for.*";
  final String notFinalizedMsg="Upgrade not finalized for.*";
  final String failMsg="Getting upgrade status failed for.*" + newLine + "upgrade: .*";
  final String finalizeSuccessMsg="Finalize upgrade successful for.*";
  setUpHaCluster(false);
  MiniDFSCluster dfsCluster=cluster.getDfsCluster();
  String message=finalizedMsg + newLine + finalizedMsg+ newLine;
  verifyUpgradeQueryOutput(message,0);
  dfsCluster.shutdownNameNode(0);
  dfsCluster.shutdownNameNode(1);
  dfsCluster.getNameNodeInfos()[0].setStartOpt(HdfsServerConstants.StartupOption.UPGRADE);
  dfsCluster.restartNameNode(0,true);
  message=notFinalizedMsg + newLine;
  verifyUpgradeQueryOutput(message,-1);
  String errorMsg=failMsg + newLine;
  verifyUpgradeQueryOutput(errorMsg,-1);
  int rc=BootstrapStandby.run(new String[]{"-force"},dfsCluster.getConfiguration(1));
  assertEquals(0,rc);
  out.reset();
  dfsCluster.restartNameNode(1);
  message=notFinalizedMsg + newLine + notFinalizedMsg+ newLine;
  verifyUpgradeQueryOutput(message,0);
  int exitCode=admin.run(new String[]{"-upgrade","finalize"});
  assertEquals(err.toString().trim(),0,exitCode);
  message=finalizeSuccessMsg + newLine + finalizeSuccessMsg+ newLine;
  assertOutputMatches(message);
  message=finalizedMsg + newLine + finalizedMsg+ newLine;
  verifyUpgradeQueryOutput(message,0);
}
