/** 
 * Regression test for HDFS-2810. In this bug, the LeaseRenewer has handles to several DFSClients with the same name, the first of which has no files open. Previously, this was causing the lease to not get renewed.
 */
@Test public void testManyDfsClientsWhereSomeNotOpen() throws Exception {
  final DFSClient mockClient1=createMockClient();
  Mockito.doReturn(false).when(mockClient1).renewLease();
  assertSame(renewer,LeaseRenewer.getInstance(FAKE_AUTHORITY,FAKE_UGI_A,mockClient1));
  long fileId=456L;
  renewer.put(mockClient1);
  final DFSClient mockClient2=createMockClient();
  Mockito.doReturn(true).when(mockClient2).renewLease();
  assertSame(renewer,LeaseRenewer.getInstance(FAKE_AUTHORITY,FAKE_UGI_A,mockClient2));
  renewer.put(mockClient2);
  GenericTestUtils.waitFor(new Supplier<Boolean>(){
    @Override public Boolean get(){
      try {
        Mockito.verify(mockClient1,Mockito.atLeastOnce()).renewLease();
        Mockito.verify(mockClient2,Mockito.atLeastOnce()).renewLease();
        return true;
      }
 catch (      AssertionError err) {
        LeaseRenewer.LOG.warn("Not yet satisfied",err);
        return false;
      }
catch (      IOException e) {
        throw new RuntimeException(e);
      }
    }
  }
,100,10000);
  renewer.closeClient(mockClient1);
  renewer.closeClient(mockClient2);
}
