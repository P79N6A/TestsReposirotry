@Test public void testMetaSaveCorruptBlocks() throws Exception {
  List<DatanodeStorageInfo> origStorages=getStorages(0,1);
  List<DatanodeDescriptor> origNodes=getNodes(origStorages);
  addCorruptBlockOnNodes(0,origNodes);
  File file=new File("test.log");
  PrintWriter out=new PrintWriter(file);
  bm.metaSave(out);
  out.flush();
  FileInputStream fstream=new FileInputStream(file);
  DataInputStream in=new DataInputStream(fstream);
  BufferedReader reader=new BufferedReader(new InputStreamReader(in));
  String corruptBlocksLine;
  Boolean foundIt=false;
  try {
    while ((corruptBlocksLine=reader.readLine()) != null) {
      if (corruptBlocksLine.compareTo("Corrupt Blocks:") == 0) {
        foundIt=true;
        break;
      }
    }
    assertTrue("Unexpected text in metasave," + "was expecting corrupt blocks section!",foundIt);
    corruptBlocksLine=reader.readLine();
    String regex="Block=blk_[0-9]+_[0-9]+\\tSize=.*\\tNode=.*" + "\\tStorageID=.*\\tStorageState.*" + "\\tTotalReplicas=.*\\tReason=GENSTAMP_MISMATCH";
    assertTrue("Unexpected corrupt block section in metasave!",corruptBlocksLine.matches(regex));
    corruptBlocksLine=reader.readLine();
    regex="Metasave: Number of datanodes.*";
    assertTrue("Unexpected corrupt block section in metasave!",corruptBlocksLine.matches(regex));
  }
  finally {
    if (reader != null)     reader.close();
    file.delete();
  }
}
