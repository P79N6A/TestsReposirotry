@Test public void testRouterManualSafeMode() throws Exception {
  InetSocketAddress adminAddr=router.getAdminServerAddress();
  conf.setSocketAddr(RBFConfigKeys.DFS_ROUTER_ADMIN_ADDRESS_KEY,adminAddr);
  RouterAdmin admin=new RouterAdmin(conf);
  assertTrue(router.getSafemodeService().isInSafeMode());
  verifyRouter(RouterServiceState.SAFEMODE);
  long interval=conf.getTimeDuration(DFS_ROUTER_SAFEMODE_EXTENSION,TimeUnit.SECONDS.toMillis(2),TimeUnit.MILLISECONDS) + 300;
  Thread.sleep(interval);
  verifyRouter(RouterServiceState.RUNNING);
  assertEquals(0,ToolRunner.run(admin,new String[]{"-safemode","enter"}));
  verifyRouter(RouterServiceState.SAFEMODE);
  interval=2 * conf.getTimeDuration(DFS_ROUTER_CACHE_TIME_TO_LIVE_MS,TimeUnit.SECONDS.toMillis(1),TimeUnit.MILLISECONDS);
  Thread.sleep(interval);
  verifyRouter(RouterServiceState.SAFEMODE);
  assertEquals(0,ToolRunner.run(admin,new String[]{"-safemode","leave"}));
  verifyRouter(RouterServiceState.RUNNING);
}
