@Test public void testRouterEnterSafemode() throws IllegalStateException, IOException, InterruptedException {
  assertTrue(router.getSafemodeService().isInSafeMode());
  verifyRouter(RouterServiceState.SAFEMODE);
  long interval0=conf.getTimeDuration(DFS_ROUTER_SAFEMODE_EXTENSION,TimeUnit.SECONDS.toMillis(2),TimeUnit.MILLISECONDS) - 1000;
  long t0=Time.now();
  while (Time.now() - t0 < interval0) {
    verifyRouter(RouterServiceState.SAFEMODE);
    Thread.sleep(100);
  }
  long interval1=1000 + 2 * conf.getTimeDuration(DFS_ROUTER_CACHE_TIME_TO_LIVE_MS,TimeUnit.SECONDS.toMillis(1),TimeUnit.MILLISECONDS);
  Thread.sleep(interval1);
  assertFalse(router.getSafemodeService().isInSafeMode());
  verifyRouter(RouterServiceState.RUNNING);
  router.getStateStore().stopCacheUpdateService();
  long interval2=conf.getTimeDuration(DFS_ROUTER_SAFEMODE_EXPIRATION,TimeUnit.SECONDS.toMillis(2),TimeUnit.MILLISECONDS) + 2 * conf.getTimeDuration(DFS_ROUTER_CACHE_TIME_TO_LIVE_MS,TimeUnit.SECONDS.toMillis(1),TimeUnit.MILLISECONDS);
  Thread.sleep(interval2);
  assertTrue(router.getSafemodeService().isInSafeMode());
  verifyRouter(RouterServiceState.SAFEMODE);
}
