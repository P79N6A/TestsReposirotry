/** 
 * Test that, an attempt to lock a storage that is already locked by nodename, logs error message that includes JVM name of the namenode that locked it.
 */
@Test public void testStorageAlreadyLockedErrorMessage() throws Exception {
  Configuration conf=new HdfsConfiguration();
  MiniDFSCluster cluster=null;
  StorageDirectory savedSd=null;
  try {
    cluster=new MiniDFSCluster.Builder(conf).numDataNodes(0).build();
    NNStorage storage=cluster.getNameNode().getFSImage().getStorage();
    for (    StorageDirectory sd : storage.dirIterable(null)) {
      assertLockFails(sd);
      savedSd=sd;
    }
    LogCapturer logs=GenericTestUtils.LogCapturer.captureLogs(LoggerFactory.getLogger(Storage.class));
    try {
      savedSd.lock();
      fail("Namenode should not be able to lock a storage" + " that is already locked");
    }
 catch (    IOException ioe) {
      String lockingJvmName=Path.WINDOWS ? "" : " " + ManagementFactory.getRuntimeMXBean().getName();
      String expectedLogMessage="It appears that another node " + lockingJvmName + " has already locked the storage directory";
      assertTrue("Log output does not contain expected log message: " + expectedLogMessage,logs.getOutput().contains(expectedLogMessage));
    }
  }
  finally {
    cleanup(cluster);
    cluster=null;
  }
}
