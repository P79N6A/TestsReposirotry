@Test(timeout=60000) public void testNestedEncryptionZones() throws Exception {
  initTopEZDirAndNestedEZDir(new Path(rootDir,"topEZ"));
  verifyEncryption();
  cluster.restartNameNodes();
  cluster.waitActive();
  fs=cluster.getFileSystem();
  verifyEncryption();
  fs.setSafeMode(HdfsConstants.SafeModeAction.SAFEMODE_ENTER);
  fs.saveNamespace();
  fs.setSafeMode(HdfsConstants.SafeModeAction.SAFEMODE_LEAVE);
  cluster.restartNameNodes();
  cluster.waitActive();
  fs=cluster.getFileSystem();
  verifyEncryption();
  renameChildrenOfEZ();
  Path topEZ2Dir=new Path(rootDir,"topEZ2");
  fs.mkdir(topEZ2Dir,FsPermission.getDirDefault());
  fs.createEncryptionZone(topEZ2Dir,TOP_EZ_KEY);
  try {
    fs.rename(topEZ2Dir,new Path(topEZDir,"topEZ2"));
    fail("Shouldn't be able to move a non-nested EZ into another " + "existing EZ.");
  }
 catch (  Exception e) {
    assertTrue(e.getMessage().contains("can't be moved into an encryption zone"));
  }
  fs.rename(topEZDir,new Path(rootDir,"newTopEZ"));
  fs.rename(new Path(rootDir,"newTopEZ/nestedEZ"),new Path(rootDir,"newTopEZ/newNestedEZ"));
}
