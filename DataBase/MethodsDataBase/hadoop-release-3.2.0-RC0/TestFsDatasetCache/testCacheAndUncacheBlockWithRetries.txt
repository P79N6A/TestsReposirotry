/** 
 * Run testCacheAndUncacheBlock with some failures injected into the mlock call.  This tests the ability of the NameNode to resend commands.
 */
@Test(timeout=600000) public void testCacheAndUncacheBlockWithRetries() throws Exception {
  NativeIO.POSIX.setCacheManipulator(new NoMlockCacheManipulator(){
    private final Set<String> seenIdentifiers=new HashSet<String>();
    @Override public void mlock(    String identifier,    ByteBuffer mmap,    long length) throws IOException {
      if (seenIdentifiers.contains(identifier)) {
        LOG.info("mlocking " + identifier);
        return;
      }
      seenIdentifiers.add(identifier);
      throw new IOException("injecting IOException during mlock of " + identifier);
    }
  }
);
  testCacheAndUncacheBlock();
}
