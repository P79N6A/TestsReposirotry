@Test public void testTailer() throws IOException, InterruptedException, ServiceFailedException {
  Configuration conf=getConf();
  conf.setInt(DFSConfigKeys.DFS_HA_TAILEDITS_PERIOD_KEY,0);
  conf.setInt(DFSConfigKeys.DFS_HA_TAILEDITS_ALL_NAMESNODES_RETRY_KEY,100);
  conf.setLong(EditLogTailer.DFS_HA_TAILEDITS_MAX_TXNS_PER_LOCK_KEY,3);
  HAUtil.setAllowStandbyReads(conf,true);
  MiniDFSCluster cluster=new MiniDFSCluster.Builder(conf).nnTopology(MiniDFSNNTopology.simpleHATopology()).numDataNodes(0).build();
  cluster.waitActive();
  cluster.transitionToActive(0);
  NameNode nn1=cluster.getNameNode(0);
  NameNode nn2=cluster.getNameNode(1);
  try {
    for (int i=0; i < DIRS_TO_MAKE / 2; i++) {
      NameNodeAdapter.mkdirs(nn1,getDirPath(i),new PermissionStatus("test","test",new FsPermission((short)00755)),true);
    }
    HATestUtil.waitForStandbyToCatchUp(nn1,nn2);
    assertEquals("Inconsistent number of applied txns on Standby",nn1.getNamesystem().getEditLog().getLastWrittenTxId(),nn2.getNamesystem().getFSImage().getLastAppliedTxId() + 1);
    for (int i=0; i < DIRS_TO_MAKE / 2; i++) {
      assertTrue(NameNodeAdapter.getFileInfo(nn2,getDirPath(i),false,false,false).isDirectory());
    }
    for (int i=DIRS_TO_MAKE / 2; i < DIRS_TO_MAKE; i++) {
      NameNodeAdapter.mkdirs(nn1,getDirPath(i),new PermissionStatus("test","test",new FsPermission((short)00755)),true);
    }
    HATestUtil.waitForStandbyToCatchUp(nn1,nn2);
    assertEquals("Inconsistent number of applied txns on Standby",nn1.getNamesystem().getEditLog().getLastWrittenTxId(),nn2.getNamesystem().getFSImage().getLastAppliedTxId() + 1);
    for (int i=DIRS_TO_MAKE / 2; i < DIRS_TO_MAKE; i++) {
      assertTrue(NameNodeAdapter.getFileInfo(nn2,getDirPath(i),false,false,false).isDirectory());
    }
  }
  finally {
    cluster.shutdown();
  }
}
