@Test public void testMultipleAppendsOnSameStream() throws Throwable {
  int baseDataSize=50;
  byte[] baseDataBuffer=createBaseFileWithData(baseDataSize,testPath);
  int appendDataSize=100;
  int targetAppendCount=50;
  byte[] testData=new byte[baseDataSize + (appendDataSize * targetAppendCount)];
  int testDataIndex=0;
  System.arraycopy(baseDataBuffer,0,testData,testDataIndex,baseDataSize);
  testDataIndex+=baseDataSize;
  int appendCount=0;
  FSDataOutputStream appendStream=null;
  try {
    while (appendCount < targetAppendCount) {
      appendStream=fs.append(testPath,50);
      int singleAppendChunkSize=20;
      int appendRunSize=0;
      while (appendRunSize < appendDataSize) {
        byte[] appendDataBuffer=getTestData(singleAppendChunkSize);
        appendStream.write(appendDataBuffer);
        System.arraycopy(appendDataBuffer,0,testData,testDataIndex + appendRunSize,singleAppendChunkSize);
        appendRunSize+=singleAppendChunkSize;
      }
      appendStream.close();
      testDataIndex+=appendDataSize;
      appendCount++;
    }
    assertTrue(verifyAppend(testData,testPath));
  }
  finally {
    if (appendStream != null) {
      appendStream.close();
    }
  }
}
