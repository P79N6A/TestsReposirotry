/** 
 * Ensure that there is waiting (sleepDuration != 0) if the metrics have only been updated with many successful and failed requests.  Also ensure that the sleepDuration decreases to zero over time.
 */
@Test public void testManySuccessAndErrorsAndWaiting(){
  ClientThrottlingAnalyzer analyzer=new ClientThrottlingAnalyzer("test",ANALYSIS_PERIOD);
  validate(0,analyzer.getSleepDuration());
  final int numberOfRequests=20;
  for (int i=0; i < numberOfRequests; i++) {
    analyzer.addBytesTransferred(8 * MEGABYTE,false);
    analyzer.addBytesTransferred(2 * MEGABYTE,true);
  }
  sleep(ANALYSIS_PERIOD_PLUS_10_PERCENT);
  NanoTimer timer=new NanoTimer();
  analyzer.suspendIfNecessary();
  fuzzyValidate(7,timer.elapsedTimeMs(),MAX_ACCEPTABLE_PERCENT_DIFFERENCE);
  sleep(10 * ANALYSIS_PERIOD);
  validate(0,analyzer.getSleepDuration());
}
