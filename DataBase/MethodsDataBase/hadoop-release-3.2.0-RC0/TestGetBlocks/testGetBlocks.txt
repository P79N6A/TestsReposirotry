/** 
 * test getBlocks 
 */
@Test public void testGetBlocks() throws Exception {
  final Configuration CONF=new HdfsConfiguration();
  final short REPLICATION_FACTOR=(short)2;
  final int DEFAULT_BLOCK_SIZE=1024;
  CONF.setLong(DFSConfigKeys.DFS_BLOCK_SIZE_KEY,DEFAULT_BLOCK_SIZE);
  CONF.setLong(DFSConfigKeys.DFS_BALANCER_GETBLOCKS_MIN_BLOCK_SIZE_KEY,DEFAULT_BLOCK_SIZE);
  MiniDFSCluster cluster=new MiniDFSCluster.Builder(CONF).numDataNodes(REPLICATION_FACTOR).storagesPerDatanode(4).build();
  try {
    cluster.waitActive();
    long fileLen=12 * DEFAULT_BLOCK_SIZE + 1;
    DFSTestUtil.createFile(cluster.getFileSystem(),new Path("/tmp.txt"),fileLen,REPLICATION_FACTOR,0L);
    List<LocatedBlock> locatedBlocks;
    DatanodeInfo[] dataNodes=null;
    boolean notWritten;
    final DFSClient dfsclient=new DFSClient(DFSUtilClient.getNNAddress(CONF),CONF);
    do {
      locatedBlocks=dfsclient.getNamenode().getBlockLocations("/tmp.txt",0,fileLen).getLocatedBlocks();
      assertEquals(13,locatedBlocks.size());
      notWritten=false;
      for (int i=0; i < 2; i++) {
        dataNodes=locatedBlocks.get(i).getLocations();
        if (dataNodes.length != REPLICATION_FACTOR) {
          notWritten=true;
          try {
            Thread.sleep(10);
          }
 catch (          InterruptedException e) {
          }
          break;
        }
      }
    }
 while (notWritten);
    dfsclient.close();
    InetSocketAddress addr=new InetSocketAddress("localhost",cluster.getNameNodePort());
    NamenodeProtocol namenode=NameNodeProxies.createProxy(CONF,DFSUtilClient.getNNUri(addr),NamenodeProtocol.class).getProxy();
    BlockWithLocations[] locs;
    locs=namenode.getBlocks(dataNodes[0],fileLen,0).getBlocks();
    assertEquals(13,locs.length);
    assertEquals(locs[0].getStorageIDs().length,2);
    assertEquals(locs[1].getStorageIDs().length,2);
    locs=namenode.getBlocks(dataNodes[0],fileLen,DEFAULT_BLOCK_SIZE).getBlocks();
    assertEquals(12,locs.length);
    assertEquals(locs[0].getStorageIDs().length,2);
    assertEquals(locs[1].getStorageIDs().length,2);
    locs=namenode.getBlocks(dataNodes[0],DEFAULT_BLOCK_SIZE,DEFAULT_BLOCK_SIZE).getBlocks();
    assertEquals(locs.length,1);
    assertEquals(locs[0].getStorageIDs().length,2);
    locs=namenode.getBlocks(dataNodes[0],1,1).getBlocks();
    assertEquals(locs.length,1);
    assertEquals(locs[0].getStorageIDs().length,2);
    getBlocksWithException(namenode,dataNodes[0],0,0);
    getBlocksWithException(namenode,dataNodes[0],-1,0);
    getBlocksWithException(namenode,dataNodes[0],DEFAULT_BLOCK_SIZE,-1);
    DatanodeInfo info=DFSTestUtil.getDatanodeInfo("1.2.3.4");
    getBlocksWithIncorrectDatanodeException(namenode,info,2,0);
    testBlockIterator(cluster);
  }
  finally {
    cluster.shutdown();
  }
}
