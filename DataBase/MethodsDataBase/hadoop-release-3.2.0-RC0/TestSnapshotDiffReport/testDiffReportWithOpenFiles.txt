/** 
 * Test Snapshot diff report for snapshots with open files captures in them. Also verify if the diff report remains the same across NameNode restarts.
 */
@Test(timeout=120000) public void testDiffReportWithOpenFiles() throws Exception {
  final Path level0A=new Path("/level_0_A");
  final Path flumeSnapRootDir=level0A;
  final String flumeFileName="flume.log";
  final String flumeSnap1Name="flume_snap_1";
  final String flumeSnap2Name="flume_snap_2";
  final Path flumeFile=new Path(level0A,flumeFileName);
  createFile(flumeFile);
  FSDataOutputStream flumeOutputStream=hdfs.append(flumeFile);
  final Path flumeS1Dir=SnapshotTestHelper.createSnapshot(hdfs,flumeSnapRootDir,flumeSnap1Name);
  final Path flumeS1Path=new Path(flumeS1Dir,flumeFileName);
  final long flumeFileLengthAfterS1=hdfs.getFileStatus(flumeFile).getLen();
  Assert.assertEquals(flumeFileLengthAfterS1,hdfs.getFileStatus(flumeS1Path).getLen());
  verifyDiffReport(level0A,flumeSnap1Name,"",new DiffReportEntry(DiffType.MODIFY,DFSUtil.string2Bytes("")));
  long flumeFileWrittenDataLength=flumeFileLengthAfterS1;
  int newWriteLength=(int)(BLOCKSIZE * 1.5);
  byte[] buf=new byte[newWriteLength];
  Random random=new Random();
  random.nextBytes(buf);
  flumeFileWrittenDataLength+=writeToStream(flumeOutputStream,buf);
  final Path flumeS2Dir=SnapshotTestHelper.createSnapshot(hdfs,flumeSnapRootDir,flumeSnap2Name);
  final Path flumeS2Path=new Path(flumeS2Dir,flumeFileName);
  final long flumeFileLengthAfterS2=hdfs.getFileStatus(flumeFile).getLen();
  Assert.assertEquals(flumeFileWrittenDataLength,flumeFileLengthAfterS2);
  Assert.assertEquals(flumeFileLengthAfterS2,hdfs.getFileStatus(flumeS2Path).getLen());
  verifyDiffReport(level0A,flumeSnap1Name,"",new DiffReportEntry(DiffType.MODIFY,DFSUtil.string2Bytes("")),new DiffReportEntry(DiffType.MODIFY,DFSUtil.string2Bytes(flumeFileName)));
  verifyDiffReport(level0A,flumeSnap2Name,"",new DiffReportEntry(DiffType.MODIFY,DFSUtil.string2Bytes("")));
  verifyDiffReport(level0A,flumeSnap1Name,flumeSnap2Name,new DiffReportEntry(DiffType.MODIFY,DFSUtil.string2Bytes("")),new DiffReportEntry(DiffType.MODIFY,DFSUtil.string2Bytes(flumeFileName)));
  flumeFileWrittenDataLength+=writeToStream(flumeOutputStream,buf);
  Assert.assertEquals(flumeFileLengthAfterS1,hdfs.getFileStatus(flumeS1Path).getLen());
  Assert.assertEquals(flumeFileLengthAfterS2,hdfs.getFileStatus(flumeS2Path).getLen());
  flumeOutputStream.close();
  Assert.assertEquals(flumeFileWrittenDataLength,hdfs.getFileStatus(flumeFile).getLen());
  Assert.assertEquals(flumeFileLengthAfterS1,hdfs.getFileStatus(flumeS1Path).getLen());
  Assert.assertEquals(flumeFileLengthAfterS2,hdfs.getFileStatus(flumeS2Path).getLen());
  verifyDiffReport(level0A,flumeSnap1Name,"",new DiffReportEntry(DiffType.MODIFY,DFSUtil.string2Bytes("")),new DiffReportEntry(DiffType.MODIFY,DFSUtil.string2Bytes(flumeFileName)));
  verifyDiffReport(level0A,flumeSnap2Name,"",new DiffReportEntry(DiffType.MODIFY,DFSUtil.string2Bytes("")),new DiffReportEntry(DiffType.MODIFY,DFSUtil.string2Bytes(flumeFileName)));
  verifyDiffReport(level0A,flumeSnap1Name,flumeSnap2Name,new DiffReportEntry(DiffType.MODIFY,DFSUtil.string2Bytes("")),new DiffReportEntry(DiffType.MODIFY,DFSUtil.string2Bytes(flumeFileName)));
  restartNameNode();
  verifyDiffReport(level0A,flumeSnap1Name,flumeSnap2Name,new DiffReportEntry(DiffType.MODIFY,DFSUtil.string2Bytes("")),new DiffReportEntry(DiffType.MODIFY,DFSUtil.string2Bytes(flumeFileName)));
}
