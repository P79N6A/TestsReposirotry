@Test public void testSnapshotDiffReportRemoteIterator() throws Exception {
  final Path root=new Path("/");
  hdfs.mkdirs(root);
  for (int i=1; i <= 3; i++) {
    final Path path=new Path(root,"dir" + i);
    hdfs.mkdirs(path);
  }
  for (int i=1; i <= 3; i++) {
    final Path path=new Path(root,"dir" + i);
    for (int j=1; j < 4; j++) {
      final Path file=new Path(path,"file" + j);
      DFSTestUtil.createFile(hdfs,file,BLOCKSIZE,REPLICATION,SEED);
    }
  }
  SnapshotTestHelper.createSnapshot(hdfs,root,"s0");
  Path targetDir=new Path(root,"dir4");
  hdfs.mkdirs(targetDir);
  Path path=new Path(root,"dir1");
  for (int j=1; j < 4; j++) {
    final Path srcPath=new Path(path,"file" + j);
    final Path targetPath=new Path(targetDir,"file" + j);
    hdfs.rename(srcPath,targetPath);
  }
  targetDir=new Path(root,"dir3");
  path=new Path(root,"dir2");
  for (int j=1; j < 4; j++) {
    final Path srcPath=new Path(path,"file" + j);
    final Path targetPath=new Path(targetDir,"file" + j);
    hdfs.rename(srcPath,targetPath,Rename.OVERWRITE);
  }
  final Path pathToRename=new Path(root,"dir2");
  hdfs.rename(pathToRename,targetDir);
  SnapshotTestHelper.createSnapshot(hdfs,root,"s1");
  RemoteIterator<SnapshotDiffReportListing> iterator=hdfs.snapshotDiffReportListingRemoteIterator(root,"s0","s1");
  SnapshotDiffReportGenerator snapshotDiffReport;
  List<SnapshotDiffReportListing.DiffReportListingEntry> modifiedList=new TreeList();
  List<SnapshotDiffReportListing.DiffReportListingEntry> createdList=new ChunkedArrayList<>();
  List<SnapshotDiffReportListing.DiffReportListingEntry> deletedList=new ChunkedArrayList<>();
  SnapshotDiffReportListing report=null;
  List<SnapshotDiffReportListing> reportList=new ArrayList<>();
  while (iterator.hasNext()) {
    report=iterator.next();
    reportList.add(report);
    modifiedList.addAll(report.getModifyList());
    createdList.addAll(report.getCreateList());
    deletedList.addAll(report.getDeleteList());
  }
  try {
    iterator.next();
  }
 catch (  Exception e) {
    Assert.assertTrue(e.getMessage().contains("No more entry in SnapshotDiffReport for /"));
  }
  Assert.assertNotEquals(0,reportList.size());
  snapshotDiffReport=new SnapshotDiffReportGenerator("/","s0","s1",report.getIsFromEarlier(),modifiedList,createdList,deletedList);
  verifyDiffReportForGivenReport(root,"s0","s1",snapshotDiffReport.generateReport(),new DiffReportEntry(DiffType.MODIFY,DFSUtil.string2Bytes("")),new DiffReportEntry(DiffType.CREATE,DFSUtil.string2Bytes("dir4")),new DiffReportEntry(DiffType.RENAME,DFSUtil.string2Bytes("dir2"),DFSUtil.string2Bytes("dir3/dir2")),new DiffReportEntry(DiffType.MODIFY,DFSUtil.string2Bytes("dir1")),new DiffReportEntry(DiffType.RENAME,DFSUtil.string2Bytes("dir1/file1"),DFSUtil.string2Bytes("dir4/file1")),new DiffReportEntry(DiffType.RENAME,DFSUtil.string2Bytes("dir1/file2"),DFSUtil.string2Bytes("dir4/file2")),new DiffReportEntry(DiffType.RENAME,DFSUtil.string2Bytes("dir1/file3"),DFSUtil.string2Bytes("dir4/file3")),new DiffReportEntry(DiffType.MODIFY,DFSUtil.string2Bytes("dir2")),new DiffReportEntry(DiffType.RENAME,DFSUtil.string2Bytes("dir2/file1"),DFSUtil.string2Bytes("dir3/file1")),new DiffReportEntry(DiffType.RENAME,DFSUtil.string2Bytes("dir2/file2"),DFSUtil.string2Bytes("dir3/file2")),new DiffReportEntry(DiffType.RENAME,DFSUtil.string2Bytes("dir2/file3"),DFSUtil.string2Bytes("dir3/file3")),new DiffReportEntry(DiffType.MODIFY,DFSUtil.string2Bytes("dir3")),new DiffReportEntry(DiffType.DELETE,DFSUtil.string2Bytes("dir3/file1")),new DiffReportEntry(DiffType.DELETE,DFSUtil.string2Bytes("dir3/file1")),new DiffReportEntry(DiffType.DELETE,DFSUtil.string2Bytes("dir3/file3")));
}
