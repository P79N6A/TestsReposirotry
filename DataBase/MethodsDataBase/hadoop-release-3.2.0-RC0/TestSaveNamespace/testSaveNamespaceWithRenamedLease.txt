/** 
 * Test for save namespace should succeed when parent directory renamed with open lease and destination directory exist.  This test is a regression for HDFS-2827
 */
@Test(timeout=30000) public void testSaveNamespaceWithRenamedLease() throws Exception {
  MiniDFSCluster cluster=new MiniDFSCluster.Builder(new Configuration()).numDataNodes(1).build();
  cluster.waitActive();
  DistributedFileSystem fs=cluster.getFileSystem();
  OutputStream out=null;
  try {
    fs.mkdirs(new Path("/test-target"));
    out=fs.create(new Path("/test-source/foo"));
    fs.rename(new Path("/test-source/"),new Path("/test-target/"));
    fs.setSafeMode(SafeModeAction.SAFEMODE_ENTER);
    cluster.getNameNodeRpc().saveNamespace(0,0);
    fs.setSafeMode(SafeModeAction.SAFEMODE_LEAVE);
  }
  finally {
    IOUtils.cleanupWithLogger(LOG,out,fs);
    cluster.shutdown();
  }
}
