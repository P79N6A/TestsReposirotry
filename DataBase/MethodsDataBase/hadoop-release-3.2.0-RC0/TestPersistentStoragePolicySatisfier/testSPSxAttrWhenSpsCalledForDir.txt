/** 
 * Test SPS xAttr on directory. xAttr should be removed from the directory once all the files blocks moved to specific storage.
 */
@Test(timeout=300000) public void testSPSxAttrWhenSpsCalledForDir() throws Exception {
  try {
    clusterSetUp();
    Path parent=new Path("/parent");
    fs.mkdirs(parent);
    for (int i=0; i < 5; i++) {
      DFSTestUtil.createFile(fs,new Path(parent,"f" + i),1024,(short)3,0);
    }
    fs.setStoragePolicy(parent,"COLD");
    DataNodeProperties stopDataNode=cluster.stopDataNode(0);
    fs.satisfyStoragePolicy(parent);
    FSNamesystem namesystem=cluster.getNamesystem();
    INode inode=namesystem.getFSDirectory().getINode("/parent");
    XAttrFeature f=inode.getXAttrFeature();
    assertTrue("SPS xAttr should be exist",f.getXAttr(XATTR_SATISFY_STORAGE_POLICY) != null);
    for (int i=0; i < 5; i++) {
      inode=namesystem.getFSDirectory().getINode("/parent/f" + i);
      f=inode.getXAttrFeature();
      assertTrue(f == null);
    }
    cluster.restartDataNode(stopDataNode,false);
    for (int i=0; i < 5; i++) {
      DFSTestUtil.waitExpectedStorageType("/parent/f" + i,StorageType.ARCHIVE,3,30000,cluster.getFileSystem());
    }
    DFSTestUtil.waitForXattrRemoved("/parent",XATTR_SATISFY_STORAGE_POLICY,namesystem,10000);
  }
  finally {
    clusterShutdown();
  }
}
