/** 
 * Test SPS xAttr on file. xAttr should be removed from the file once all the blocks moved to specific storage.
 */
@Test(timeout=300000) public void testSPSxAttrWhenSpsCalledForFile() throws Exception {
  try {
    clusterSetUp();
    Path file=new Path("/file");
    DFSTestUtil.createFile(fs,file,1024,(short)3,0);
    fs.setStoragePolicy(file,"COLD");
    DataNodeProperties stopDataNode=cluster.stopDataNode(0);
    fs.satisfyStoragePolicy(file);
    FSNamesystem namesystem=cluster.getNamesystem();
    INode inode=namesystem.getFSDirectory().getINode("/file");
    XAttrFeature f=inode.getXAttrFeature();
    assertTrue("SPS xAttr should be exist",f.getXAttr(XATTR_SATISFY_STORAGE_POLICY) != null);
    cluster.restartDataNode(stopDataNode,false);
    DFSTestUtil.waitExpectedStorageType("/file",StorageType.ARCHIVE,3,30000,cluster.getFileSystem());
    GenericTestUtils.waitFor(new Supplier<Boolean>(){
      @Override public Boolean get(){
        List<XAttr> existingXAttrs=XAttrStorage.readINodeXAttrs(inode);
        return !existingXAttrs.contains(XATTR_SATISFY_STORAGE_POLICY);
      }
    }
,100,10000);
  }
  finally {
    clusterShutdown();
  }
}
