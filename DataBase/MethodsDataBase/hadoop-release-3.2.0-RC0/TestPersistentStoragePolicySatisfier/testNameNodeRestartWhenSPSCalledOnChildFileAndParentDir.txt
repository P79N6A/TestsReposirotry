/** 
 * Test loading of SPS xAttrs from the edits log when satisfyStoragePolicy called on child file and parent directory. 1. Create one directory and create one child file. 2. Set storage policy for child file and call satisfyStoragePolicy. 3. wait for SPS to remove xAttr for file child file. 4. Set storage policy for parent directory and call satisfyStoragePolicy. 5. restart the namenode. NameNode should be started successfully.
 */
@Test(timeout=300000) public void testNameNodeRestartWhenSPSCalledOnChildFileAndParentDir() throws Exception {
  try {
    clusterSetUp();
    fs.setStoragePolicy(childFile,"COLD");
    fs.satisfyStoragePolicy(childFile);
    DFSTestUtil.waitExpectedStorageType(childFile.toUri().getPath(),StorageType.ARCHIVE,3,30000,cluster.getFileSystem());
    Thread.sleep(30000);
    fs.setStoragePolicy(childDir,"COLD");
    fs.satisfyStoragePolicy(childDir);
    try {
      cluster.restartNameNodes();
    }
 catch (    Exception e) {
      assertFalse(e.getMessage().contains("Cannot request to call satisfy storage policy"));
    }
  }
  finally {
    clusterShutdown();
  }
}
