/** 
 * Tests to verify SPS xattr will be removed if the satisfy work has been finished, expect that the method satisfyStoragePolicy can be invoked on the same file again after the block movement has been finished: 1. satisfy storage policy of file1. 2. wait until storage policy is satisfied. 3. satisfy storage policy of file1 again 4. make sure step 3 works as expected.
 * @throws Exception
 */
@Test(timeout=300000) public void testMultipleSatisfyStoragePolicy() throws Exception {
  try {
    conf=new HdfsConfiguration();
    final long minCheckTimeout=500;
    conf.setLong(DFSConfigKeys.DFS_STORAGE_POLICY_SATISFIER_RECHECK_TIMEOUT_MILLIS_KEY,minCheckTimeout);
    clusterSetUp(conf);
    fs.setStoragePolicy(testFile,ONE_SSD);
    fs.satisfyStoragePolicy(testFile);
    DFSTestUtil.waitExpectedStorageType(testFileName,StorageType.SSD,1,timeout,fs);
    DFSTestUtil.waitExpectedStorageType(testFileName,StorageType.DISK,2,timeout,fs);
    DFSTestUtil.waitForXattrRemoved(testFileName,XATTR_SATISFY_STORAGE_POLICY,cluster.getNamesystem(),30000);
    fs.setStoragePolicy(testFile,COLD);
    fs.satisfyStoragePolicy(testFile);
    DFSTestUtil.waitExpectedStorageType(testFileName,StorageType.ARCHIVE,3,timeout,fs);
  }
  finally {
    clusterShutdown();
  }
}
