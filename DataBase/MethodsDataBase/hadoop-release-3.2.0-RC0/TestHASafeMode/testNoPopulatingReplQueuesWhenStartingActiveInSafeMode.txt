/** 
 * Make sure that when we transition to active in safe mode that we don't prematurely consider blocks missing just because not all DNs have reported yet. This is a regression test for HDFS-3921.
 */
@Test public void testNoPopulatingReplQueuesWhenStartingActiveInSafeMode() throws IOException {
  DFSTestUtil.createFile(fs,new Path("/test"),15 * BLOCK_SIZE,(short)3,1L);
  cluster.stopDataNode(1);
  cluster.restartNameNode(0,false);
  cluster.transitionToActive(0);
  assertTrue(cluster.getNameNode(0).isInSafeMode());
  assertEquals(0,cluster.getNamesystem(0).getMissingBlocksCount());
}
