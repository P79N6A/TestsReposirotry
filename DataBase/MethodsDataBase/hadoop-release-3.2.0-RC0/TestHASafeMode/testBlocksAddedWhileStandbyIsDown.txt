/** 
 * Regression test for HDFS-2753. In this bug, the following sequence was observed: - Some blocks are written to DNs while the SBN was down. This causes the blockReceived messages to get queued in the BPServiceActor on the DN. - When the SBN returns, the DN re-registers with the SBN, and then flushes its blockReceived queue to the SBN before it sends its first block report. This caused the first block report to be incorrect ignored. - The SBN would become stuck in safemode.
 */
@Test public void testBlocksAddedWhileStandbyIsDown() throws Exception {
  DFSTestUtil.createFile(fs,new Path("/test"),3 * BLOCK_SIZE,(short)3,1L);
  banner("Stopping standby");
  cluster.shutdownNameNode(1);
  DFSTestUtil.createFile(fs,new Path("/test2"),3 * BLOCK_SIZE,(short)3,1L);
  banner("Rolling edit log so standby gets all edits on restart");
  nn0.getRpcServer().rollEditLog();
  restartStandby();
  assertSafeMode(nn1,6,6,3,0);
}
