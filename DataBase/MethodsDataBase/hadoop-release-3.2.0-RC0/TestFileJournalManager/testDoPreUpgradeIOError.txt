/** 
 * Tests that internal renames are done using native code on platforms that have it.  The native rename includes more detailed information about the failure, which can be useful for troubleshooting.
 */
@Test public void testDoPreUpgradeIOError() throws IOException {
  File storageDir=new File(TestEditLog.TEST_DIR,"preupgradeioerror");
  List<URI> editUris=Collections.singletonList(storageDir.toURI());
  NNStorage storage=setupEdits(editUris,5);
  StorageDirectory sd=storage.dirIterator(NameNodeDirType.EDITS).next();
  assertNotNull(sd);
  FileUtil.setWritable(storageDir,false);
  FileJournalManager jm=null;
  try {
    jm=new FileJournalManager(conf,sd,storage);
    exception.expect(IOException.class);
    if (NativeCodeLoader.isNativeCodeLoaded()) {
      exception.expectMessage("failure in native rename");
    }
    jm.doPreUpgrade();
  }
  finally {
    IOUtils.cleanupWithLogger(LOG,jm);
    FileUtil.setWritable(storageDir,true);
    FileUtil.fullyDelete(storageDir);
  }
}
