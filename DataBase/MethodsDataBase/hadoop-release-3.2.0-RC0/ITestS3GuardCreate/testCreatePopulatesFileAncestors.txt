/** 
 * Test that ancestor creation during S3AFileSystem#create() is properly accounted for in the MetadataStore.  This should be handled by the FileSystem, and be a FS contract test, but S3A does not handle ancestors on create(), so we need to take care in the S3Guard code to do the right thing.  This may change: See HADOOP-13221 for more detail.
 */
@Test public void testCreatePopulatesFileAncestors() throws Exception {
  final S3AFileSystem fs=getFileSystem();
  Assume.assumeTrue(fs.hasMetadataStore());
  final MetadataStore ms=fs.getMetadataStore();
  final Path parent=path("testCreatePopulatesFileAncestors");
  try {
    fs.mkdirs(parent);
    final Path nestedFile=new Path(parent,"dir1/dir2/file4");
    touch(fs,nestedFile);
    DirListingMetadata list=ms.listChildren(parent);
    assertFalse("MetadataStore falsely reports authoritative empty list",list.isEmpty() == Tristate.TRUE);
  }
  finally {
    fs.delete(parent,true);
  }
}
