/** 
 * Test to verify that satisfy worker can't move blocks. If the given block is pinned it shouldn't be considered for retries.
 */
@Test(timeout=120000) public void testMoveWithBlockPinning() throws Exception {
  try {
    config.setBoolean(DFSConfigKeys.DFS_DATANODE_BLOCK_PINNING_ENABLED,true);
    hdfsCluster=startCluster(config,allDiskTypes,3,2,CAPACITY);
    hdfsCluster.waitActive();
    dfs=hdfsCluster.getFileSystem();
    final String file1=createFileAndSimulateFavoredNodes(2);
    dfs.setStoragePolicy(new Path(file1),COLD);
    StorageType[][] newtypes=new StorageType[][]{{StorageType.ARCHIVE,StorageType.ARCHIVE},{StorageType.ARCHIVE,StorageType.ARCHIVE},{StorageType.ARCHIVE,StorageType.ARCHIVE}};
    startAdditionalDNs(config,3,NUM_OF_DATANODES,newtypes,STORAGES_PER_DATANODE,CAPACITY,hdfsCluster);
    dfs.satisfyStoragePolicy(new Path(file1));
    hdfsCluster.triggerHeartbeats();
    waitForAttemptedItems(1,30000);
    waitForBlocksMovementAttemptReport(1,30000);
    DFSTestUtil.waitExpectedStorageType(file1,StorageType.ARCHIVE,1,30000,dfs);
    DFSTestUtil.waitExpectedStorageType(file1,StorageType.DISK,2,30000,dfs);
  }
  finally {
    shutdownCluster();
  }
}
