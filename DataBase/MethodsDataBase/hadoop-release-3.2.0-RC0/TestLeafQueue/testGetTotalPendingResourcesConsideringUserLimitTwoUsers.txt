@Test public void testGetTotalPendingResourcesConsideringUserLimitTwoUsers() throws Exception {
  LeafQueue e=stubLeafQueue((LeafQueue)queues.get(E));
  e.setMaxCapacity(1.0f);
  e.setUserLimit(1000);
  final String user_0="user_0";
  final String user_1="user_1";
  final ApplicationAttemptId appAttemptId_0=TestUtils.getMockApplicationAttemptId(0,0);
  FiCaSchedulerApp app_0=new FiCaSchedulerApp(appAttemptId_0,user_0,e,mock(ActiveUsersManager.class),spyRMContext);
  e.submitApplicationAttempt(app_0,user_0);
  final ApplicationAttemptId appAttemptId_1=TestUtils.getMockApplicationAttemptId(1,0);
  FiCaSchedulerApp app_1=new FiCaSchedulerApp(appAttemptId_1,user_0,e,mock(ActiveUsersManager.class),spyRMContext);
  e.submitApplicationAttempt(app_1,user_0);
  final ApplicationAttemptId appAttemptId_2=TestUtils.getMockApplicationAttemptId(2,0);
  FiCaSchedulerApp app_2=new FiCaSchedulerApp(appAttemptId_2,user_1,e,mock(ActiveUsersManager.class),spyRMContext);
  e.submitApplicationAttempt(app_2,user_1);
  final ApplicationAttemptId appAttemptId_3=TestUtils.getMockApplicationAttemptId(3,0);
  FiCaSchedulerApp app_3=new FiCaSchedulerApp(appAttemptId_3,user_1,e,mock(ActiveUsersManager.class),spyRMContext);
  e.submitApplicationAttempt(app_3,user_1);
  Map<ApplicationAttemptId,FiCaSchedulerApp> apps=ImmutableMap.of(app_0.getApplicationAttemptId(),app_0,app_1.getApplicationAttemptId(),app_1,app_2.getApplicationAttemptId(),app_2,app_3.getApplicationAttemptId(),app_3);
  String host_0="127.0.0.1";
  FiCaSchedulerNode node_0=TestUtils.getMockNode(host_0,DEFAULT_RACK,0,100 * GB);
  Map<NodeId,FiCaSchedulerNode> nodes=ImmutableMap.of(node_0.getNodeID(),node_0);
  final int numNodes=1;
  Resource clusterResource=Resources.createResource(numNodes * (100 * GB),numNodes * 128);
  when(csContext.getNumClusterNodes()).thenReturn(numNodes);
  root.updateClusterResource(clusterResource,new ResourceLimits(clusterResource));
  Priority priority=TestUtils.createMockPriority(1);
  app_0.updateResourceRequests(Collections.singletonList(TestUtils.createResourceRequest(ResourceRequest.ANY,1 * GB,1,true,priority,recordFactory)));
  app_1.updateResourceRequests(Collections.singletonList(TestUtils.createResourceRequest(ResourceRequest.ANY,1 * GB,2,true,priority,recordFactory)));
  priority=TestUtils.createMockPriority(1);
  app_2.updateResourceRequests(Collections.singletonList(TestUtils.createResourceRequest(ResourceRequest.ANY,1 * GB,2,true,priority,recordFactory)));
  app_3.updateResourceRequests(Collections.singletonList(TestUtils.createResourceRequest(ResourceRequest.ANY,1 * GB,1,true,priority,recordFactory)));
  assertEquals(2 * GB,e.getTotalPendingResourcesConsideringUserLimit(clusterResource,NO_LABEL,false).getMemorySize());
  assertEquals(0 * GB,app_0.getCurrentConsumption().getMemorySize());
  assertEquals(0 * GB,app_1.getCurrentConsumption().getMemorySize());
  assertEquals(0 * GB,app_2.getCurrentConsumption().getMemorySize());
  assertEquals(0 * GB,app_3.getCurrentConsumption().getMemorySize());
  applyCSAssignment(clusterResource,e.assignContainers(clusterResource,node_0,new ResourceLimits(clusterResource),SchedulingMode.RESPECT_PARTITION_EXCLUSIVITY),e,nodes,apps);
  assertEquals(1 * GB,e.getTotalPendingResourcesConsideringUserLimit(clusterResource,NO_LABEL,false).getMemorySize());
  assertEquals(1 * GB,app_0.getCurrentConsumption().getMemorySize());
  assertEquals(0 * GB,app_1.getCurrentConsumption().getMemorySize());
  assertEquals(0 * GB,app_2.getCurrentConsumption().getMemorySize());
  assertEquals(0 * GB,app_3.getCurrentConsumption().getMemorySize());
  applyCSAssignment(clusterResource,e.assignContainers(clusterResource,node_0,new ResourceLimits(clusterResource),SchedulingMode.RESPECT_PARTITION_EXCLUSIVITY),e,nodes,apps);
  assertEquals(1 * GB,e.getTotalPendingResourcesConsideringUserLimit(clusterResource,NO_LABEL,false).getMemorySize());
  assertEquals(1 * GB,app_0.getCurrentConsumption().getMemorySize());
  assertEquals(1 * GB,app_1.getCurrentConsumption().getMemorySize());
  assertEquals(0 * GB,app_2.getCurrentConsumption().getMemorySize());
  assertEquals(0 * GB,app_3.getCurrentConsumption().getMemorySize());
  applyCSAssignment(clusterResource,e.assignContainers(clusterResource,node_0,new ResourceLimits(clusterResource),SchedulingMode.RESPECT_PARTITION_EXCLUSIVITY),e,nodes,apps);
  assertEquals(0 * GB,e.getTotalPendingResourcesConsideringUserLimit(clusterResource,NO_LABEL,false).getMemorySize());
  assertEquals(1 * GB,app_0.getCurrentConsumption().getMemorySize());
  assertEquals(1 * GB,app_1.getCurrentConsumption().getMemorySize());
  assertEquals(1 * GB,app_2.getCurrentConsumption().getMemorySize());
  assertEquals(0 * GB,app_3.getCurrentConsumption().getMemorySize());
  applyCSAssignment(clusterResource,e.assignContainers(clusterResource,node_0,new ResourceLimits(clusterResource),SchedulingMode.RESPECT_PARTITION_EXCLUSIVITY),e,nodes,apps);
  assertEquals(0 * GB,e.getTotalPendingResourcesConsideringUserLimit(clusterResource,NO_LABEL,false).getMemorySize());
  long app_0_consumption=app_0.getCurrentConsumption().getMemorySize();
  assertEquals(1 * GB,app_0_consumption);
  long app_1_consumption=app_1.getCurrentConsumption().getMemorySize();
  assertEquals(1 * GB,app_1_consumption);
  long app_2_consumption=app_2.getCurrentConsumption().getMemorySize();
  assertEquals(2 * GB,app_2_consumption);
  long app_3_consumption=app_3.getCurrentConsumption().getMemorySize();
  assertEquals(0 * GB,app_3_consumption);
  applyCSAssignment(clusterResource,e.assignContainers(clusterResource,node_0,new ResourceLimits(clusterResource),SchedulingMode.RESPECT_PARTITION_EXCLUSIVITY),e,nodes,apps);
  assertEquals(0 * GB,e.getTotalPendingResourcesConsideringUserLimit(clusterResource,NO_LABEL,false).getMemorySize());
  assertEquals(app_0_consumption,app_0.getCurrentConsumption().getMemorySize());
  assertEquals(app_1_consumption,app_1.getCurrentConsumption().getMemorySize());
  assertEquals(app_2_consumption,app_2.getCurrentConsumption().getMemorySize());
  assertEquals(app_3_consumption,app_3.getCurrentConsumption().getMemorySize());
  e.setUserLimitFactor(10.0f);
  applyCSAssignment(clusterResource,e.assignContainers(clusterResource,node_0,new ResourceLimits(clusterResource),SchedulingMode.RESPECT_PARTITION_EXCLUSIVITY),e,nodes,apps);
  assertEquals(1 * GB,e.getTotalPendingResourcesConsideringUserLimit(clusterResource,NO_LABEL,false).getMemorySize());
  assertEquals(1 * GB,app_0.getCurrentConsumption().getMemorySize());
  assertEquals(2 * GB,app_1.getCurrentConsumption().getMemorySize());
  assertEquals(2 * GB,app_2.getCurrentConsumption().getMemorySize());
  assertEquals(0 * GB,app_3.getCurrentConsumption().getMemorySize());
  applyCSAssignment(clusterResource,e.assignContainers(clusterResource,node_0,new ResourceLimits(clusterResource),SchedulingMode.RESPECT_PARTITION_EXCLUSIVITY),e,nodes,apps);
  assertEquals(0 * GB,e.getTotalPendingResourcesConsideringUserLimit(clusterResource,NO_LABEL,false).getMemorySize());
  assertEquals(1 * GB,app_0.getCurrentConsumption().getMemorySize());
  assertEquals(2 * GB,app_1.getCurrentConsumption().getMemorySize());
  assertEquals(2 * GB,app_2.getCurrentConsumption().getMemorySize());
  assertEquals(1 * GB,app_3.getCurrentConsumption().getMemorySize());
  for (  RMContainer rmContainer : app_0.getLiveContainers()) {
    e.completedContainer(clusterResource,app_0,node_0,rmContainer,ContainerStatus.newInstance(rmContainer.getContainerId(),ContainerState.COMPLETE,"",ContainerExitStatus.KILLED_BY_RESOURCEMANAGER),RMContainerEventType.KILL,null,true);
  }
  for (  RMContainer rmContainer : app_1.getLiveContainers()) {
    e.completedContainer(clusterResource,app_1,node_0,rmContainer,ContainerStatus.newInstance(rmContainer.getContainerId(),ContainerState.COMPLETE,"",ContainerExitStatus.KILLED_BY_RESOURCEMANAGER),RMContainerEventType.KILL,null,true);
  }
}
