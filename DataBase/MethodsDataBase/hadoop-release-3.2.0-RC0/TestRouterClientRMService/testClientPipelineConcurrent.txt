/** 
 * This test validates if the ClientRequestInterceptor chain for the user can build and init correctly when a multi-client process begins to request RouterClientRMService for the same user simultaneously.
 */
@Test public void testClientPipelineConcurrent() throws InterruptedException {
  final String user="test1";
class ClientTestThread extends Thread {
    private ClientRequestInterceptor interceptor;
    @Override public void run(){
      try {
        interceptor=pipeline();
      }
 catch (      IOException|InterruptedException e) {
        e.printStackTrace();
      }
    }
    private ClientRequestInterceptor pipeline() throws IOException, InterruptedException {
      return UserGroupInformation.createRemoteUser(user).doAs(new PrivilegedExceptionAction<ClientRequestInterceptor>(){
        @Override public ClientRequestInterceptor run() throws Exception {
          RequestInterceptorChainWrapper wrapper=getRouterClientRMService().getInterceptorChain();
          ClientRequestInterceptor interceptor=wrapper.getRootInterceptor();
          Assert.assertNotNull(interceptor);
          LOG.info("init client interceptor success for user " + user);
          return interceptor;
        }
      }
);
    }
  }
  ClientTestThread client1=new ClientTestThread();
  ClientTestThread client2=new ClientTestThread();
  client1.start();
  client2.start();
  client1.join();
  client2.join();
  Assert.assertNotNull(client1.interceptor);
  Assert.assertNotNull(client2.interceptor);
  Assert.assertTrue(client1.interceptor == client2.interceptor);
}
