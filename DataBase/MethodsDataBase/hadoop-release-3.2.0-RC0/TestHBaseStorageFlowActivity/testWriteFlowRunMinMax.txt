/** 
 * Writes 4 timeline entities belonging to one flow run through the {@link HBaseTimelineWriterImpl}Checks the flow run table contents The first entity has a created event, metrics and a finish event. The second entity has a created event and this is the entity with smallest start time. This should be the start time for the flow run. The third entity has a finish event and this is the entity with the max end time. This should be the end time for the flow run. The fourth entity has a created event which has a start time that is greater than min start time. The test also checks in the flow activity table that one entry has been made for all of these 4 application entities since they belong to the same flow run.
 */
@Test public void testWriteFlowRunMinMax() throws Exception {
  TimelineEntities te=new TimelineEntities();
  te.addEntity(TestFlowDataGenerator.getEntity1());
  HBaseTimelineWriterImpl hbi=null;
  Configuration c1=util.getConfiguration();
  String cluster="testWriteFlowRunMinMaxToHBase_cluster1";
  String user="testWriteFlowRunMinMaxToHBase_user1";
  String flow="testing_flowRun_flow_name";
  String flowVersion="CF7022C10F1354";
  long runid=1002345678919L;
  String appName="application_100000000000_1111";
  long minStartTs=1424995200300L;
  long greaterStartTs=1424995200300L + 864000L;
  long endTs=1424995200300L + 86000000L;
  TimelineEntity entityMinStartTime=TestFlowDataGenerator.getEntityMinStartTime(minStartTs);
  try {
    hbi=new HBaseTimelineWriterImpl();
    hbi.init(c1);
    UserGroupInformation remoteUser=UserGroupInformation.createRemoteUser(user);
    hbi.write(new TimelineCollectorContext(cluster,user,flow,flowVersion,runid,appName),te,remoteUser);
    te=new TimelineEntities();
    te.addEntity(entityMinStartTime);
    appName="application_100000000000_3333";
    hbi.write(new TimelineCollectorContext(cluster,user,flow,flowVersion,runid,appName),te,remoteUser);
    TimelineEntity entityMaxEndTime=TestFlowDataGenerator.getEntityMaxEndTime(endTs);
    te=new TimelineEntities();
    te.addEntity(entityMaxEndTime);
    appName="application_100000000000_4444";
    hbi.write(new TimelineCollectorContext(cluster,user,flow,flowVersion,runid,appName),te,remoteUser);
    TimelineEntity entityGreaterStartTime=TestFlowDataGenerator.getEntityGreaterStartTime(greaterStartTs);
    te=new TimelineEntities();
    te.addEntity(entityGreaterStartTime);
    appName="application_1000000000000000_2222";
    hbi.write(new TimelineCollectorContext(cluster,user,flow,flowVersion,runid,appName),te,remoteUser);
    hbi.flush();
  }
  finally {
    if (hbi != null) {
      hbi.close();
    }
  }
  Connection conn=ConnectionFactory.createConnection(c1);
  Table table1=conn.getTable(BaseTableRW.getTableName(c1,FlowActivityTableRW.TABLE_NAME_CONF_NAME,FlowActivityTableRW.DEFAULT_TABLE_NAME));
  byte[] startRow=new FlowActivityRowKey(cluster,minStartTs,user,flow).getRowKey();
  Get g=new Get(startRow);
  Result r1=table1.get(g);
  assertNotNull(r1);
  assertTrue(!r1.isEmpty());
  Map<byte[],byte[]> values=r1.getFamilyMap(FlowActivityColumnFamily.INFO.getBytes());
  assertEquals(1,values.size());
  byte[] row=r1.getRow();
  FlowActivityRowKey flowActivityRowKey=FlowActivityRowKey.parseRowKey(row);
  assertNotNull(flowActivityRowKey);
  assertEquals(cluster,flowActivityRowKey.getClusterId());
  assertEquals(user,flowActivityRowKey.getUserId());
  assertEquals(flow,flowActivityRowKey.getFlowName());
  Long dayTs=HBaseTimelineSchemaUtils.getTopOfTheDayTimestamp(minStartTs);
  assertEquals(dayTs,flowActivityRowKey.getDayTimestamp());
  assertEquals(1,values.size());
  checkFlowActivityRunId(runid,flowVersion,values);
  HBaseTimelineReaderImpl hbr=null;
  try {
    hbr=new HBaseTimelineReaderImpl();
    hbr.init(c1);
    hbr.start();
    Set<TimelineEntity> entities=hbr.getEntities(new TimelineReaderContext(cluster,null,null,null,null,TimelineEntityType.YARN_FLOW_ACTIVITY.toString(),null),new TimelineEntityFilters.Builder().entityLimit(10L).build(),new TimelineDataToRetrieve());
    assertEquals(1,entities.size());
    for (    TimelineEntity e : entities) {
      FlowActivityEntity flowActivity=(FlowActivityEntity)e;
      assertEquals(cluster,flowActivity.getCluster());
      assertEquals(user,flowActivity.getUser());
      assertEquals(flow,flowActivity.getFlowName());
      assertEquals(dayTs,Long.valueOf(flowActivity.getDate().getTime()));
      Set<FlowRunEntity> flowRuns=flowActivity.getFlowRuns();
      assertEquals(1,flowRuns.size());
    }
  }
  finally {
    if (hbr != null) {
      hbr.close();
    }
  }
}
