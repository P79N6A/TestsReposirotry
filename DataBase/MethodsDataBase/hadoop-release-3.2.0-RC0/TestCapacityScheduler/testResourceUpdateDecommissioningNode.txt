@Test public void testResourceUpdateDecommissioningNode() throws Exception {
  RMContext spyContext=Mockito.spy(resourceManager.getRMContext());
  Dispatcher mockDispatcher=mock(AsyncDispatcher.class);
  when(mockDispatcher.getEventHandler()).thenReturn(new EventHandler<Event>(){
    @Override public void handle(    Event event){
      if (event instanceof RMNodeResourceUpdateEvent) {
        RMNodeResourceUpdateEvent resourceEvent=(RMNodeResourceUpdateEvent)event;
        resourceManager.getResourceScheduler().getSchedulerNode(resourceEvent.getNodeId()).updateTotalResource(resourceEvent.getResourceOption().getResource());
      }
    }
  }
);
  Mockito.doReturn(mockDispatcher).when(spyContext).getDispatcher();
  ((CapacityScheduler)resourceManager.getResourceScheduler()).setRMContext(spyContext);
  ((AsyncDispatcher)mockDispatcher).start();
  String host_0="host_0";
  NodeManager nm_0=registerNode(host_0,1234,2345,NetworkTopology.DEFAULT_RACK,Resources.createResource(8 * GB,4));
  Priority priority_0=Priority.newInstance(0);
  Application application_0=new Application("user_0","a1",resourceManager);
  application_0.submit();
  application_0.addNodeManager(host_0,1234,nm_0);
  Resource capability_0_0=Resources.createResource(1 * GB,1);
  application_0.addResourceRequestSpec(priority_0,capability_0_0);
  Task task_0_0=new Task(application_0,priority_0,new String[]{host_0});
  application_0.addTask(task_0_0);
  application_0.schedule();
  nodeUpdate(nm_0);
  RMNode spyNode=Mockito.spy(resourceManager.getRMContext().getRMNodes().get(nm_0.getNodeId()));
  when(spyNode.getState()).thenReturn(NodeState.DECOMMISSIONING);
  resourceManager.getResourceScheduler().handle(new NodeUpdateSchedulerEvent(spyNode));
  application_0.schedule();
  Assert.assertEquals(1 * GB,nm_0.getUsed().getMemorySize());
  Resource usedResource=resourceManager.getResourceScheduler().getSchedulerNode(nm_0.getNodeId()).getAllocatedResource();
  Assert.assertEquals("Used Resource Memory Size should be 1GB",1 * GB,usedResource.getMemorySize());
  Assert.assertEquals("Used Resource Virtual Cores should be 1",1,usedResource.getVirtualCores());
  Resource totalResource=resourceManager.getResourceScheduler().getSchedulerNode(nm_0.getNodeId()).getTotalResource();
  Assert.assertEquals("Total Resource Memory Size should be 1GB",1 * GB,totalResource.getMemorySize());
  Assert.assertEquals("Total Resource Virtual Cores should be 1",1,totalResource.getVirtualCores());
  Resource availableResource=resourceManager.getResourceScheduler().getSchedulerNode(nm_0.getNodeId()).getUnallocatedResource();
  Assert.assertEquals("Available Resource Memory Size should be 0",0,availableResource.getMemorySize());
  Assert.assertEquals("Available Resource Memory Size should be 0",0,availableResource.getVirtualCores());
}
