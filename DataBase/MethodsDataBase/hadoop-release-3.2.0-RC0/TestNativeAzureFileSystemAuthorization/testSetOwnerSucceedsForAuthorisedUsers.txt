/** 
 * Test for setOwner when Authorization is enabled and the user is specified in chown allowed user list.
 */
@Test public void testSetOwnerSucceedsForAuthorisedUsers() throws Throwable {
  Path testPath=new Path("/testSetOwnerPositive");
  authorizer.addAuthRuleForOwner("/",WRITE,true);
  fs.updateWasbAuthorizer(authorizer);
  String newOwner="user2";
  String newGroup="newgroup";
  UserGroupInformation authorisedUser=UserGroupInformation.createUserForTesting("user2",new String[]{"group1"});
  try {
    fs.mkdirs(testPath);
    ContractTestUtils.assertPathExists(fs,"test path does not exist",testPath);
    String owner=fs.getFileStatus(testPath).getOwner();
    Assume.assumeTrue("changing owner requires original and new owner to be different",!StringUtils.equalsIgnoreCase(owner,newOwner));
    authorisedUser.doAs(new PrivilegedExceptionAction<Void>(){
      @Override public Void run() throws Exception {
        fs.setOwner(testPath,newOwner,newGroup);
        assertOwnerEquals(testPath,newOwner);
        assertEquals(newGroup,fs.getFileStatus(testPath).getGroup());
        return null;
      }
    }
);
  }
  finally {
    fs.delete(testPath,false);
  }
}
