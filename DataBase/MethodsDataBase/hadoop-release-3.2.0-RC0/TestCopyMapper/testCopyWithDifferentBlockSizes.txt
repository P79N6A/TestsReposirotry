@Test(timeout=40000) public void testCopyWithDifferentBlockSizes() throws Exception {
  try {
    deleteState();
    createSourceDataWithDifferentBlockSize();
    FileSystem fs=cluster.getFileSystem();
    CopyMapper copyMapper=new CopyMapper();
    StubContext stubContext=new StubContext(getConfiguration(),null,0);
    Mapper<Text,CopyListingFileStatus,Text,Text>.Context context=stubContext.getContext();
    Configuration configuration=context.getConfiguration();
    EnumSet<DistCpOptions.FileAttribute> fileAttributes=EnumSet.noneOf(DistCpOptions.FileAttribute.class);
    configuration.set(DistCpOptionSwitch.PRESERVE_STATUS.getConfigLabel(),DistCpUtils.packAttributes(fileAttributes));
    copyMapper.setup(context);
    for (    Path path : pathList) {
      final FileStatus fileStatus=fs.getFileStatus(path);
      copyMapper.map(new Text(DistCpUtils.getRelativePath(new Path(SOURCE_PATH),path)),new CopyListingFileStatus(fileStatus),context);
    }
    if (expectDifferentBlockSizesMultipleBlocksToSucceed()) {
      verifyCopy(fs,false,false);
    }
 else {
      Assert.fail("Copy should have failed because of block-size difference.");
    }
  }
 catch (  Exception exception) {
    if (expectDifferentBlockSizesMultipleBlocksToSucceed()) {
      throw exception;
    }
 else {
      Throwable cause=exception.getCause().getCause();
      GenericTestUtils.assertExceptionContains("-pb",cause);
      GenericTestUtils.assertExceptionContains("-skipcrccheck",cause);
    }
  }
}
