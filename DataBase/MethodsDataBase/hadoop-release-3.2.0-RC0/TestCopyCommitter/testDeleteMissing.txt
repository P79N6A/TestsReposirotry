@Test public void testDeleteMissing() throws IOException {
  TaskAttemptContext taskAttemptContext=getTaskAttemptContext(config);
  JobContext jobContext=new JobContextImpl(taskAttemptContext.getConfiguration(),taskAttemptContext.getTaskAttemptID().getJobID());
  Configuration conf=jobContext.getConfiguration();
  String sourceBase;
  String targetBase;
  FileSystem fs=null;
  try {
    OutputCommitter committer=new CopyCommitter(null,taskAttemptContext);
    fs=FileSystem.get(conf);
    sourceBase=TestDistCpUtils.createTestSetup(fs,FsPermission.getDefault());
    targetBase=TestDistCpUtils.createTestSetup(fs,FsPermission.getDefault());
    String targetBaseAdd=TestDistCpUtils.createTestSetup(fs,FsPermission.getDefault());
    fs.rename(new Path(targetBaseAdd),new Path(targetBase));
    final DistCpOptions options=new DistCpOptions.Builder(Collections.singletonList(new Path(sourceBase)),new Path("/out")).withSyncFolder(true).withDeleteMissing(true).build();
    options.appendToConf(conf);
    final DistCpContext context=new DistCpContext(options);
    CopyListing listing=new GlobbedCopyListing(conf,CREDENTIALS);
    Path listingFile=new Path("/tmp1/" + String.valueOf(rand.nextLong()));
    listing.buildListing(listingFile,context);
    conf.set(DistCpConstants.CONF_LABEL_TARGET_WORK_PATH,targetBase);
    conf.set(DistCpConstants.CONF_LABEL_TARGET_FINAL_PATH,targetBase);
    committer.commitJob(jobContext);
    verifyFoldersAreInSync(fs,targetBase,sourceBase);
    verifyFoldersAreInSync(fs,sourceBase,targetBase);
    committer.commitJob(jobContext);
    verifyFoldersAreInSync(fs,targetBase,sourceBase);
    verifyFoldersAreInSync(fs,sourceBase,targetBase);
  }
  finally {
    TestDistCpUtils.delete(fs,"/tmp1");
    conf.set(DistCpConstants.CONF_LABEL_DELETE_MISSING,"false");
  }
}
