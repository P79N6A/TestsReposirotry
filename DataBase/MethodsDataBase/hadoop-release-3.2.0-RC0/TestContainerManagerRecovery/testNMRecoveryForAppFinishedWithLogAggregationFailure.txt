@Test public void testNMRecoveryForAppFinishedWithLogAggregationFailure() throws Exception {
  conf.setBoolean(YarnConfiguration.NM_RECOVERY_ENABLED,true);
  conf.setBoolean(YarnConfiguration.NM_RECOVERY_SUPERVISED,true);
  NMStateStoreService stateStore=new NMMemoryStateStoreService();
  stateStore.init(conf);
  stateStore.start();
  Context context=createContext(conf,stateStore);
  ContainerManagerImpl cm=createContainerManager(context);
  cm.init(conf);
  cm.start();
  ApplicationId appId=ApplicationId.newInstance(0,1);
  ApplicationAttemptId attemptId=ApplicationAttemptId.newInstance(appId,1);
  ContainerId cid=ContainerId.newContainerId(attemptId,1);
  Map<String,LocalResource> localResources=Collections.emptyMap();
  Map<String,String> containerEnv=new HashMap<>();
  setFlowContext(containerEnv,"app_name1",appId);
  List<String> containerCmds=Collections.emptyList();
  Map<String,ByteBuffer> serviceData=Collections.emptyMap();
  ContainerLaunchContext clc=ContainerLaunchContext.newInstance(localResources,containerEnv,containerCmds,serviceData,null,null);
  StartContainersResponse startResponse=startContainer(context,cm,cid,clc,null,ContainerType.TASK);
  assertTrue(startResponse.getFailedRequests().isEmpty());
  assertEquals(1,context.getApplications().size());
  Application app=context.getApplications().get(appId);
  assertNotNull(app);
  waitForAppState(app,ApplicationState.INITING);
  List<ApplicationId> finishedApps=new ArrayList<ApplicationId>();
  finishedApps.add(appId);
  app.handle(new ApplicationFinishEvent(appId,"Application killed by ResourceManager"));
  waitForAppState(app,ApplicationState.APPLICATION_RESOURCES_CLEANINGUP);
  app.handle(new ApplicationEvent(app.getAppId(),ApplicationEventType.APPLICATION_RESOURCES_CLEANEDUP));
  assertEquals(app.getApplicationState(),ApplicationState.FINISHED);
  assertEquals(1,context.getApplications().size());
  cm.stop();
  context=createContext(conf,stateStore);
  cm=createContainerManager(context);
  cm.init(conf);
  cm.start();
  assertEquals(1,context.getApplications().size());
  app=context.getApplications().get(appId);
  assertNotNull(app);
  app.handle(new ApplicationFinishEvent(appId,"Application killed by ResourceManager"));
  waitForAppState(app,ApplicationState.APPLICATION_RESOURCES_CLEANINGUP);
  app.handle(new ApplicationEvent(app.getAppId(),ApplicationEventType.APPLICATION_RESOURCES_CLEANEDUP));
  assertEquals(app.getApplicationState(),ApplicationState.FINISHED);
  app.handle(new ApplicationEvent(app.getAppId(),ApplicationEventType.APPLICATION_LOG_HANDLING_FAILED));
  cm.stop();
  context=createContext(conf,stateStore);
  cm=createContainerManager(context);
  cm.init(conf);
  cm.start();
  assertTrue(context.getApplications().isEmpty());
  cm.stop();
}
