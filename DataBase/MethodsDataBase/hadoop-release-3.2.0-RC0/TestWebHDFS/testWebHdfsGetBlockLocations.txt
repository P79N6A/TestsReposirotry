@Test public void testWebHdfsGetBlockLocations() throws Exception {
  MiniDFSCluster cluster=null;
  final Configuration conf=WebHdfsTestUtil.createConf();
  final int offset=42;
  final int length=512;
  final Path path=new Path("/foo");
  byte[] contents=new byte[1024];
  RANDOM.nextBytes(contents);
  try {
    cluster=new MiniDFSCluster.Builder(conf).numDataNodes(1).build();
    final WebHdfsFileSystem fs=WebHdfsTestUtil.getWebHdfsFileSystem(conf,WebHdfsConstants.WEBHDFS_SCHEME);
    try (OutputStream os=fs.create(path)){
      os.write(contents);
    }
     BlockLocation[] locations=fs.getFileBlockLocations(path,offset,length);
    InetSocketAddress addr=cluster.getNameNode().getHttpAddress();
    URL url1=new URL("http",addr.getHostString(),addr.getPort(),WebHdfsFileSystem.PATH_PREFIX + "/foo?op=GETFILEBLOCKLOCATIONS");
    String response1=getResponse(url1,"GET");
    BlockLocation[] locationArray1=toBlockLocationArray(response1);
    verifyEquals(locations,locationArray1);
    URL url2=new URL("http",addr.getHostString(),addr.getPort(),WebHdfsFileSystem.PATH_PREFIX + "/foo?op=GETFILEBLOCKLOCATIONS" + "&length="+ length+ "&offset="+ offset);
    String response2=getResponse(url2,"GET");
    BlockLocation[] locationArray2=toBlockLocationArray(response2);
    verifyEquals(locations,locationArray2);
    URL url3=new URL("http",addr.getHostString(),addr.getPort(),WebHdfsFileSystem.PATH_PREFIX + "/foo?op=GETFILEBLOCKLOCATIONS" + "&length="+ length);
    String response3=getResponse(url3,"GET");
    BlockLocation[] locationArray3=toBlockLocationArray(response3);
    verifyEquals(locations,locationArray3);
    URL url4=new URL("http",addr.getHostString(),addr.getPort(),WebHdfsFileSystem.PATH_PREFIX + "/foo?op=GETFILEBLOCKLOCATIONS" + "&offset="+ offset);
    String response4=getResponse(url4,"GET");
    BlockLocation[] locationArray4=toBlockLocationArray(response4);
    verifyEquals(locations,locationArray4);
    URL url5=new URL("http",addr.getHostString(),addr.getPort(),WebHdfsFileSystem.PATH_PREFIX + "/foo?op=GETFILEBLOCKLOCATIONS" + "&offset=1200");
    String response5=getResponse(url5,"GET");
    BlockLocation[] locationArray5=toBlockLocationArray(response5);
    verifyEquals(new BlockLocation[]{},locationArray5);
  }
  finally {
    if (cluster != null) {
      cluster.shutdown();
    }
  }
}
