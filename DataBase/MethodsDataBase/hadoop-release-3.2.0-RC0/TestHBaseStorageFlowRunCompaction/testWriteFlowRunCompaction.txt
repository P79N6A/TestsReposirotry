@Test public void testWriteFlowRunCompaction() throws Exception {
  String cluster="kompaction_cluster1";
  String user="kompaction_FlowRun__user1";
  String flow="kompaction_flowRun_flow_name";
  String flowVersion="AF1021C19F1351";
  long runid=1449526652000L;
  int start=10;
  int count=2000;
  int appIdSuffix=1;
  HBaseTimelineWriterImpl hbi=null;
  long insertTs=System.currentTimeMillis() - count;
  Configuration c1=util.getConfiguration();
  TimelineEntities te1=null;
  TimelineEntity entityApp1=null;
  UserGroupInformation remoteUser=UserGroupInformation.createRemoteUser(user);
  try {
    hbi=new HBaseTimelineWriterImpl();
    hbi.init(c1);
    for (int i=start; i < start + count; i++) {
      String appName="application_10240000000000_" + appIdSuffix;
      insertTs++;
      te1=new TimelineEntities();
      entityApp1=TestFlowDataGenerator.getEntityMetricsApp1(insertTs,c1);
      te1.addEntity(entityApp1);
      hbi.write(new TimelineCollectorContext(cluster,user,flow,flowVersion,runid,appName),te1,remoteUser);
      appName="application_2048000000000_7" + appIdSuffix;
      insertTs++;
      te1=new TimelineEntities();
      entityApp1=TestFlowDataGenerator.getEntityMetricsApp2(insertTs);
      te1.addEntity(entityApp1);
      hbi.write(new TimelineCollectorContext(cluster,user,flow,flowVersion,runid,appName),te1,remoteUser);
    }
  }
  finally {
    String appName="application_10240000000000_" + appIdSuffix;
    te1=new TimelineEntities();
    entityApp1=TestFlowDataGenerator.getEntityMetricsApp1Complete(insertTs + 1,c1);
    te1.addEntity(entityApp1);
    if (hbi != null) {
      hbi.write(new TimelineCollectorContext(cluster,user,flow,flowVersion,runid,appName),te1,remoteUser);
      hbi.flush();
      hbi.close();
    }
  }
  TableName flowRunTable=BaseTableRW.getTableName(c1,FlowRunTableRW.TABLE_NAME_CONF_NAME,FlowRunTableRW.DEFAULT_TABLE_NAME);
  HRegionServer server=util.getRSForFirstRegionInTable(flowRunTable);
  int regionNum=HBaseTimelineServerUtils.flushCompactTableRegions(server,flowRunTable);
  assertTrue("Didn't find any regions for primary table!",regionNum > 0);
  checkFlowRunTable(cluster,user,flow,runid,c1,4);
}
