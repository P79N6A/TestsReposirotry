@Test(timeout=60000) public void testReleaseOutdatedReservedContainer() throws Exception {
  MockRM rm1=new MockRM();
  rm1.getRMContext().setNodeLabelManager(mgr);
  rm1.start();
  MockNM nm1=rm1.registerNode("h1:1234",8 * GB);
  MockNM nm2=rm1.registerNode("h2:1234",8 * GB);
  MockNM nm3=rm1.registerNode("h3:1234",8 * GB);
  rm1.drainEvents();
  CapacityScheduler cs=(CapacityScheduler)rm1.getResourceScheduler();
  RMNode rmNode1=rm1.getRMContext().getRMNodes().get(nm1.getNodeId());
  LeafQueue defaultQueue=(LeafQueue)cs.getQueue("default");
  SchedulerNode sn1=cs.getSchedulerNode(nm1.getNodeId());
  SchedulerNode sn2=cs.getSchedulerNode(nm2.getNodeId());
  SchedulerNode sn3=cs.getSchedulerNode(nm3.getNodeId());
  RMApp app1=rm1.submitApp(4 * GB,"app","user",null,"default");
  MockAM am1=MockRM.launchAndRegisterAM(app1,rm1,nm1);
  Resource allocateResource=Resources.createResource(5 * GB);
  am1.allocate("*",(int)allocateResource.getMemorySize(),3,0,new ArrayList<ContainerId>(),"");
  FiCaSchedulerApp schedulerApp1=cs.getApplicationAttempt(am1.getApplicationAttemptId());
  cs.handle(new NodeUpdateSchedulerEvent(rmNode1));
  Assert.assertEquals(1,schedulerApp1.getReservedContainers().size());
  Assert.assertEquals(9 * GB,defaultQueue.getQueueResourceUsage().getUsed().getMemorySize());
  RMContainer reservedContainer=schedulerApp1.getReservedContainers().get(0);
  ResourceCommitRequest allocateFromSameReservedContainerProposal1=createAllocateFromReservedProposal(3,allocateResource,schedulerApp1,sn2,sn1,cs.getRMContext(),reservedContainer);
  boolean tryCommitResult=cs.tryCommit(cs.getClusterResource(),allocateFromSameReservedContainerProposal1,true);
  Assert.assertTrue(tryCommitResult);
  ResourceCommitRequest allocateFromSameReservedContainerProposal2=createAllocateFromReservedProposal(4,allocateResource,schedulerApp1,sn3,sn1,cs.getRMContext(),reservedContainer);
  tryCommitResult=cs.tryCommit(cs.getClusterResource(),allocateFromSameReservedContainerProposal2,true);
  Assert.assertFalse("This proposal should be rejected because " + "it try to release an outdated reserved container",tryCommitResult);
  rm1.close();
}
