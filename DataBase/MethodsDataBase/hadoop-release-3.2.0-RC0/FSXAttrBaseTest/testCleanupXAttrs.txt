/** 
 * Steps: 1) Set xattrs on a file. 2) Remove xattrs from that file. 3) Save a checkpoint and restart NN. 4) Set xattrs again on the same file. 5) Remove xattrs from that file. 6) Restart NN without saving a checkpoint. 7) Set xattrs again on the same file.
 */
@Test(timeout=120000) public void testCleanupXAttrs() throws Exception {
  FileSystem.mkdirs(fs,path,FsPermission.createImmutable((short)0750));
  fs.setXAttr(path,name1,value1,EnumSet.of(XAttrSetFlag.CREATE));
  fs.setXAttr(path,name2,value2,EnumSet.of(XAttrSetFlag.CREATE));
  fs.removeXAttr(path,name1);
  fs.removeXAttr(path,name2);
  restart(true);
  initFileSystem();
  fs.setXAttr(path,name1,value1,EnumSet.of(XAttrSetFlag.CREATE));
  fs.setXAttr(path,name2,value2,EnumSet.of(XAttrSetFlag.CREATE));
  fs.removeXAttr(path,name1);
  fs.removeXAttr(path,name2);
  restart(false);
  initFileSystem();
  fs.setXAttr(path,name1,value1,EnumSet.of(XAttrSetFlag.CREATE));
  fs.setXAttr(path,name2,value2,EnumSet.of(XAttrSetFlag.CREATE));
  fs.removeXAttr(path,name1);
  fs.removeXAttr(path,name2);
  fs.setXAttr(path,name1,value1,EnumSet.of(XAttrSetFlag.CREATE));
  fs.setXAttr(path,name2,value2,EnumSet.of(XAttrSetFlag.CREATE));
  Map<String,byte[]> xattrs=fs.getXAttrs(path);
  Assert.assertEquals(xattrs.size(),2);
  Assert.assertArrayEquals(value1,xattrs.get(name1));
  Assert.assertArrayEquals(value2,xattrs.get(name2));
}
