@Test(timeout=30000) public void testCorruptImageFallbackLostECPolicy() throws IOException {
  final ErasureCodingPolicy defaultPolicy=StripedFileTestUtil.getDefaultECPolicy();
  final String policy=defaultPolicy.getName();
  final Path f1=new Path("/f1");
  MiniDFSCluster cluster=new MiniDFSCluster.Builder(config).numDataNodes(0).format(true).build();
  try {
    cluster.waitActive();
    DistributedFileSystem fs=cluster.getFileSystem();
    fs.enableErasureCodingPolicy(policy);
    Path srcECDir=new Path("/");
    fs.setErasureCodingPolicy(srcECDir,defaultPolicy.getName());
    fs.create(f1);
    FileStatus fs1=fs.getFileStatus(f1);
    assertTrue(fs1.isErasureCoded());
    ErasureCodingPolicy fs1Policy=fs.getErasureCodingPolicy(f1);
    assertEquals(fs1Policy,defaultPolicy);
  }
  finally {
    cluster.close();
  }
  corruptFSImageMD5(false);
  cluster=new MiniDFSCluster.Builder(config).numDataNodes(0).format(false).build();
  try {
    cluster.waitActive();
    ErasureCodingPolicy[] ecPolicies=cluster.getNameNode().getNamesystem().getErasureCodingPolicyManager().getEnabledPolicies();
    DistributedFileSystem fs=cluster.getFileSystem();
    assertEquals(fs.getErasureCodingPolicy(f1),defaultPolicy);
    assertTrue(ecPolicies.length == 1);
  }
  finally {
    cluster.shutdown();
  }
}
