@Test public void testReencryptionNNSafeMode() throws Exception {
  final int len=8196;
  final Path zoneParent=new Path("/zones");
  final Path zone=new Path(zoneParent,"zone");
  fsWrapper.mkdir(zone,FsPermission.getDirDefault(),true);
  dfsAdmin.createEncryptionZone(zone,TEST_KEY,NO_TRASH);
  for (int i=0; i < 10; ++i) {
    DFSTestUtil.createFile(fs,new Path(zone,Integer.toString(i)),len,(short)1,0xFEED);
  }
  rollKey(TEST_KEY);
  getEzManager().pauseForTestingAfterNthSubmission(1);
  dfsAdmin.reencryptEncryptionZone(zone,ReencryptAction.START);
  waitForReencryptedFiles(zone.toString(),5);
  fs.setSafeMode(SafeModeAction.SAFEMODE_ENTER);
  getEzManager().resumeReencryptForTesting();
  for (int i=0; i < 3; ++i) {
    Thread.sleep(1000);
    RemoteIterator<ZoneReencryptionStatus> it=dfsAdmin.listReencryptionStatus();
    assertTrue(it.hasNext());
    ZoneReencryptionStatus zs=it.next();
    assertEquals(zone.toString(),zs.getZoneName());
    assertEquals(0,zs.getCompletionTime());
    assertEquals(5,zs.getFilesReencrypted());
  }
  fs.setSafeMode(SafeModeAction.SAFEMODE_LEAVE);
  getHandler().notifyNewSubmission();
  waitForReencryptedFiles(zone.toString(),10);
}
