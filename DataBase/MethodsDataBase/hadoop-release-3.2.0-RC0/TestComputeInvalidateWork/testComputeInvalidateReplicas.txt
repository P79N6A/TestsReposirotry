/** 
 * Test if  {@link BlockManager#computeInvalidateWork(int)}can schedule invalidate work correctly for the replicas.
 */
@Test(timeout=120000) public void testComputeInvalidateReplicas() throws Exception {
  final int blockInvalidateLimit=bm.getDatanodeManager().getBlockInvalidateLimit();
  namesystem.writeLock();
  try {
    for (int i=0; i < nodes.length; i++) {
      for (int j=0; j < 3 * blockInvalidateLimit + 1; j++) {
        Block block=new Block(i * (blockInvalidateLimit + 1) + j,0,GenerationStamp.LAST_RESERVED_STAMP);
        bm.addToInvalidates(block,nodes[i]);
      }
    }
    verifyInvalidationWorkCounts(blockInvalidateLimit);
  }
  finally {
    namesystem.writeUnlock();
  }
}
