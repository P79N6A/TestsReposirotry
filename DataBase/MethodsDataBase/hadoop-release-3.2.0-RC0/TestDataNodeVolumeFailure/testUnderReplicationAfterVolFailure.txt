/** 
 * Test that there are under replication blocks after vol failures
 */
@Test public void testUnderReplicationAfterVolFailure() throws Exception {
  assumeNotWindows();
  cluster.startDataNodes(conf,1,true,null,null);
  cluster.waitActive();
  final BlockManager bm=cluster.getNamesystem().getBlockManager();
  Path file1=new Path("/test1");
  DFSTestUtil.createFile(fs,file1,1024,(short)3,1L);
  DFSTestUtil.waitReplication(fs,file1,(short)3);
  File dn1Vol1=cluster.getInstanceStorageDir(0,0);
  File dn2Vol1=cluster.getInstanceStorageDir(1,0);
  DataNodeTestUtils.injectDataDirFailure(dn1Vol1,dn2Vol1);
  Path file2=new Path("/test2");
  DFSTestUtil.createFile(fs,file2,1024,(short)3,1L);
  DFSTestUtil.waitReplication(fs,file2,(short)3);
  GenericTestUtils.waitFor(new Supplier<Boolean>(){
    @Override public Boolean get(){
      long underReplicatedBlocks=bm.getLowRedundancyBlocksCount() + bm.getPendingReconstructionBlocksCount();
      if (underReplicatedBlocks > 0) {
        return true;
      }
      LOG.info("There is no under replicated block after volume failure.");
      return false;
    }
  }
,500,60000);
}
