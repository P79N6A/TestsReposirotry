/** 
 * Test that DN does not shutdown, as long as failure volumes being hot swapped.
 */
@Test public void testVolumeFailureRecoveredByHotSwappingVolume() throws Exception {
  assumeNotWindows();
  final File dn0Vol1=cluster.getInstanceStorageDir(0,0);
  final File dn0Vol2=cluster.getInstanceStorageDir(0,1);
  final DataNode dn0=cluster.getDataNodes().get(0);
  final String oldDataDirs=dn0.getConf().get(DFSConfigKeys.DFS_DATANODE_DATA_DIR_KEY);
  DataNodeTestUtils.injectDataDirFailure(dn0Vol1);
  DataNodeTestUtils.waitForDiskError(dn0,DataNodeTestUtils.getVolume(dn0,dn0Vol1));
  String dataDirs=dn0Vol2.getPath();
  assertThat(dn0.reconfigurePropertyImpl(DFSConfigKeys.DFS_DATANODE_DATA_DIR_KEY,dataDirs),is(dn0.getConf().get(DFSConfigKeys.DFS_DATANODE_DATA_DIR_KEY)));
  DataNodeTestUtils.restoreDataDirFromFailure(dn0Vol1);
  assertThat(dn0.reconfigurePropertyImpl(DFSConfigKeys.DFS_DATANODE_DATA_DIR_KEY,oldDataDirs),is(dn0.getConf().get(DFSConfigKeys.DFS_DATANODE_DATA_DIR_KEY)));
  DataNodeTestUtils.injectDataDirFailure(dn0Vol2);
  DataNodeTestUtils.waitForDiskError(dn0,DataNodeTestUtils.getVolume(dn0,dn0Vol2));
  assertTrue(dn0.shouldRun());
}
