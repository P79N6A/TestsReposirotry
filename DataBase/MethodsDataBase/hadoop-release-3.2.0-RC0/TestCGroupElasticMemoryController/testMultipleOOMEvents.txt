/** 
 * Test that the handler is notified about multiple OOM events.
 * @throws Exception on exception
 */
@Test(timeout=20000) public void testMultipleOOMEvents() throws Exception {
  conf.set(YarnConfiguration.NM_ELASTIC_MEMORY_CONTROL_OOM_LISTENER_PATH,script.getAbsolutePath());
  try {
    FileUtils.writeStringToFile(script,"#!/bin/bash\nprintf oomevent;printf oomevent;\n",Charset.defaultCharset(),false);
    assertTrue("Could not set executable",script.setExecutable(true));
    CGroupsHandler cgroups=mock(CGroupsHandler.class);
    when(cgroups.getPathForCGroup(any(),any())).thenReturn("");
    when(cgroups.getCGroupParam(any(),any(),any())).thenReturn("under_oom 0");
    Runnable handler=mock(Runnable.class);
    doNothing().when(handler).run();
    CGroupElasticMemoryController controller=new CGroupElasticMemoryController(conf,null,cgroups,true,false,10000,handler);
    controller.run();
    verify(handler,times(2)).run();
  }
  finally {
    assertTrue(String.format("Could not clean up script %s",script.getAbsolutePath()),script.delete());
  }
}
