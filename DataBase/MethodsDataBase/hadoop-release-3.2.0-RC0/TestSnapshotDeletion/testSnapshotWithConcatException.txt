@Test public void testSnapshotWithConcatException() throws Exception {
  final Path st=new Path("/st");
  hdfs.mkdirs(st);
  hdfs.allowSnapshot(st);
  Path[] files=new Path[3];
  for (int i=0; i < 3; i++) {
    files[i]=new Path(st,i + ".txt");
  }
  Path dest=new Path(st,"dest.txt");
  hdfs.createNewFile(dest);
  hdfs.createSnapshot(st,"ss");
  for (int j=0; j < 3; j++) {
    FileSystem fs=cluster.getFileSystem();
    DFSTestUtil.createFile(fs,files[j],false,1024,1024,512,(short)1,RandomUtils.nextLong(1,512),true);
  }
  hdfs.createSnapshot(st,"s0");
  exception.expect(RemoteException.class);
  String error="Concat: the source file /st/0.txt is in snapshot";
  exception.expectMessage(error);
  hdfs.concat(dest,files);
  hdfs.setSafeMode(SafeModeAction.SAFEMODE_ENTER);
  hdfs.saveNamespace();
  hdfs.setSafeMode(SafeModeAction.SAFEMODE_LEAVE);
  cluster.restartNameNodes();
}
