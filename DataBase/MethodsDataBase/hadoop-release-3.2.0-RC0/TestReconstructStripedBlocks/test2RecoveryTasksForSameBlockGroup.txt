@Test public void test2RecoveryTasksForSameBlockGroup() throws Exception {
  Configuration conf=new HdfsConfiguration();
  conf.setInt(DFSConfigKeys.DFS_HEARTBEAT_INTERVAL_KEY,1000);
  conf.setInt(DFSConfigKeys.DFS_NAMENODE_REDUNDANCY_INTERVAL_SECONDS_KEY,1000);
  conf.setLong(DFSConfigKeys.DFS_BLOCK_SIZE_KEY,blockSize);
  cluster=new MiniDFSCluster.Builder(conf).numDataNodes(groupSize + 2).build();
  try {
    cluster.waitActive();
    DistributedFileSystem fs=cluster.getFileSystem();
    BlockManager bm=cluster.getNamesystem().getBlockManager();
    fs.enableErasureCodingPolicy(StripedFileTestUtil.getDefaultECPolicy().getName());
    fs.getClient().setErasureCodingPolicy("/",StripedFileTestUtil.getDefaultECPolicy().getName());
    int fileLen=dataBlocks * blockSize;
    Path p=new Path("/test2RecoveryTasksForSameBlockGroup");
    final byte[] data=new byte[fileLen];
    DFSTestUtil.writeFile(fs,p,data);
    DFSTestUtil.waitForReplication(fs,p,groupSize,5000);
    BlockManagerTestUtil.updateState(bm);
    DFSTestUtil.verifyClientStats(conf,cluster);
    LocatedStripedBlock lb=(LocatedStripedBlock)fs.getClient().getLocatedBlocks(p.toString(),0).get(0);
    LocatedBlock[] lbs=StripedBlockUtil.parseStripedBlockGroup(lb,cellSize,dataBlocks,parityBlocks);
    BlockManagerTestUtil.getComputedDatanodeWork(bm);
    BlockManagerTestUtil.updateState(bm);
    assertEquals(0,getNumberOfBlocksToBeErasureCoded(cluster));
    assertEquals(0,bm.getPendingReconstructionBlocksCount());
    DFSTestUtil.verifyClientStats(conf,cluster);
    DatanodeInfo dn0=lbs[0].getLocations()[0];
    cluster.stopDataNode(dn0.getName());
    cluster.setDataNodeDead(dn0);
    BlockManagerTestUtil.getComputedDatanodeWork(bm);
    BlockManagerTestUtil.updateState(bm);
    assertEquals(1,getNumberOfBlocksToBeErasureCoded(cluster));
    assertEquals(1,bm.getPendingReconstructionBlocksCount());
    DFSTestUtil.verifyClientStats(conf,cluster);
    DatanodeInfo dn1=lbs[1].getLocations()[0];
    cluster.stopDataNode(dn1.getName());
    cluster.setDataNodeDead(dn1);
    BlockManagerTestUtil.getComputedDatanodeWork(bm);
    BlockManagerTestUtil.updateState(bm);
    assertEquals(1,getNumberOfBlocksToBeErasureCoded(cluster));
    assertEquals(1,bm.getPendingReconstructionBlocksCount());
    DFSTestUtil.verifyClientStats(conf,cluster);
  }
  finally {
    cluster.shutdown();
  }
}
