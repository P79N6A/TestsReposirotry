@Test public void testRWRShouldNotAddedOnDNRestart() throws Exception {
  Configuration conf=new HdfsConfiguration();
  conf.set("dfs.client.block.write.replace-datanode-on-failure.enable","false");
  try (MiniDFSCluster cluster=new MiniDFSCluster.Builder(conf).numDataNodes(2).build()){
    Path path=new Path("/testRBW");
    FSDataOutputStream out=cluster.getFileSystem().create(path,(short)2);
    out.writeBytes("old gs data\n");
    out.hflush();
    DataNodeProperties dnProp=cluster.stopDataNode(0);
    String dnAddress=dnProp.getDatanode().getXferAddress().toString();
    if (dnAddress.startsWith("/")) {
      dnAddress=dnAddress.substring(1);
    }
    out.writeBytes("old gs data\n");
    out.hflush();
    cluster.restartDataNode(dnProp,true);
    Thread.sleep(3000);
    BlockLocation[] locations=cluster.getFileSystem().getFileBlockLocations(path,0,Long.MAX_VALUE);
    String[] names=locations[0].getNames();
    for (    String node : names) {
      if (node.equals(dnAddress)) {
        fail("Old GS DN should not be present in latest block locations.");
      }
    }
    out.close();
  }
 }
