@Test public void testAbfsOutputStreamAsyncFlushWithRetainUncommittedData() throws Exception {
  final AzureBlobFileSystem fs=getFileSystem();
  final Path testFilePath=path(methodName.getMethodName());
  final byte[] b;
  try (FSDataOutputStream stream=fs.create(testFilePath)){
    b=new byte[TEST_BUFFER_SIZE];
    new Random().nextBytes(b);
    for (int i=0; i < 2; i++) {
      stream.write(b);
      for (int j=0; j < FLUSH_TIMES; j++) {
        stream.flush();
        Thread.sleep(10);
      }
    }
  }
   final byte[] r=new byte[TEST_BUFFER_SIZE];
  try (FSDataInputStream inputStream=fs.open(testFilePath,4 * ONE_MB)){
    while (inputStream.available() != 0) {
      int result=inputStream.read(r);
      assertNotEquals("read returned -1",-1,result);
      assertArrayEquals("buffer read from stream",r,b);
    }
  }
 }
