@Test public void testWriteHeavyBytesToFileAsyncFlush() throws Exception {
  final AzureBlobFileSystem fs=getFileSystem();
  ExecutorService es=Executors.newFixedThreadPool(10);
  final Path testFilePath=path(methodName.getMethodName());
  try (FSDataOutputStream stream=fs.create(testFilePath)){
    final byte[] b=new byte[TEST_BUFFER_SIZE];
    new Random().nextBytes(b);
    List<Future<Void>> tasks=new ArrayList<>();
    for (int i=0; i < FLUSH_TIMES; i++) {
      Callable<Void> callable=new Callable<Void>(){
        @Override public Void call() throws Exception {
          stream.write(b);
          return null;
        }
      }
;
      tasks.add(es.submit(callable));
    }
    boolean shouldStop=false;
    while (!shouldStop) {
      shouldStop=true;
      for (      Future<Void> task : tasks) {
        if (!task.isDone()) {
          stream.flush();
          shouldStop=false;
        }
      }
    }
    Thread.sleep(THREAD_SLEEP_TIME);
    tasks.clear();
  }
   es.shutdownNow();
  FileStatus fileStatus=fs.getFileStatus(testFilePath);
  assertEquals((long)TEST_BUFFER_SIZE * FLUSH_TIMES,fileStatus.getLen());
}
