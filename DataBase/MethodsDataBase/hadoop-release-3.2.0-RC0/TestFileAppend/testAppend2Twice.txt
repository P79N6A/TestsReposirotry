/** 
 * Test two consecutive appends on a file with a full block. 
 */
@Test public void testAppend2Twice() throws Exception {
  Configuration conf=new HdfsConfiguration();
  File builderBaseDir=new File(GenericTestUtils.getRandomizedTempPath());
  MiniDFSCluster cluster=new MiniDFSCluster.Builder(conf,builderBaseDir).build();
  final DistributedFileSystem fs1=cluster.getFileSystem();
  final FileSystem fs2=AppendTestUtil.createHdfsWithDifferentUsername(conf);
  try {
    final Path p=new Path("/testAppendTwice/foo");
    final int len=1 << 16;
    final byte[] fileContents=AppendTestUtil.initBuffer(len);
{
      FSDataOutputStream out=fs2.create(p,true,4096,(short)1,len);
      out.write(fileContents,0,len);
      out.close();
    }
    ((DistributedFileSystem)fs2).append(p,EnumSet.of(CreateFlag.APPEND,CreateFlag.NEW_BLOCK),4096,null);
    fs1.append(p);
    Assert.fail();
  }
 catch (  RemoteException re) {
    AppendTestUtil.LOG.info("Got an exception:",re);
    Assert.assertEquals(AlreadyBeingCreatedException.class.getName(),re.getClassName());
  }
 finally {
    fs2.close();
    fs1.close();
    cluster.shutdown();
  }
}
