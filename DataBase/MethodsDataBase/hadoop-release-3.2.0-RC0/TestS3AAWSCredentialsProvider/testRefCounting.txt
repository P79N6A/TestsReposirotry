@Test public void testRefCounting() throws Throwable {
  AWSCredentialProviderList providers=new AWSCredentialProviderList();
  assertEquals("Ref count for " + providers,1,providers.getRefCount());
  AWSCredentialProviderList replicate=providers.share();
  assertEquals(providers,replicate);
  assertEquals("Ref count after replication for " + providers,2,providers.getRefCount());
  assertFalse("Was closed " + providers,providers.isClosed());
  providers.close();
  assertFalse("Was closed " + providers,providers.isClosed());
  assertEquals("Ref count after close() for " + providers,1,providers.getRefCount());
  providers.close();
  assertTrue("Was not closed " + providers,providers.isClosed());
  assertEquals("Ref count after close() for " + providers,0,providers.getRefCount());
  assertEquals("Ref count after second close() for " + providers,0,providers.getRefCount());
  intercept(IllegalStateException.class,"closed",() -> providers.share());
  providers.close();
  assertEquals("Ref count after close() for " + providers,0,providers.getRefCount());
  providers.refresh();
  intercept(NoAuthWithAWSException.class,AWSCredentialProviderList.CREDENTIALS_REQUESTED_WHEN_CLOSED,() -> providers.getCredentials());
}
