/** 
 * It is possible to delete directories without the proper encryption key and the hierarchy above it.
 * @throws Exception
 */
@Test public void testDeleteEncryptedObjectWithDifferentKey() throws Exception {
  assumeEnabled();
  skipIfEncryptionTestsDisabled(getConfiguration());
  assumeS3GuardState(false,getConfiguration());
  Path pathABC=path("testDeleteEncryptedObjectWithDifferentKey/a/b/c/");
  Path pathAB=pathABC.getParent();
  Path pathA=pathAB.getParent();
  assertTrue(getFileSystem().mkdirs(pathABC));
  Path fileToDelete=new Path(pathABC,"filetobedeleted.txt");
  writeThenReadFile(fileToDelete,TEST_FILE_LEN);
  fsKeyB=createNewFileSystemWithSSECKey(KEY_4);
  intercept(AccessDeniedException.class,SERVICE_AMAZON_S3_STATUS_CODE_403,() -> {
    fsKeyB.delete(fileToDelete,false);
  }
);
  fsKeyB.delete(pathABC,true);
  fsKeyB.delete(pathAB,true);
  fsKeyB.delete(pathA,true);
  assertPathDoesNotExist("expected recursive delete",fileToDelete);
}
