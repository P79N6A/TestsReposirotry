/** 
 * It is possible to list the contents of a directory up to the actual end of the nested directories.  This is due to how S3A mocks the directories and how prefixes work in S3.
 * @throws Exception
 */
@Test public void testListEncryptedDir() throws Exception {
  assumeEnabled();
  skipIfEncryptionTestsDisabled(getConfiguration());
  assumeS3GuardState(false,getConfiguration());
  Path pathABC=path("testListEncryptedDir/a/b/c/");
  Path pathAB=pathABC.getParent();
  Path pathA=pathAB.getParent();
  Path nestedDirectory=createTestPath(pathABC);
  assertTrue(getFileSystem().mkdirs(nestedDirectory));
  fsKeyB=createNewFileSystemWithSSECKey(KEY_4);
  fsKeyB.listFiles(pathA,true);
  fsKeyB.listFiles(pathAB,true);
  intercept(AccessDeniedException.class,SERVICE_AMAZON_S3_STATUS_CODE_403,() -> {
    fsKeyB.listFiles(pathABC,false);
  }
);
  Configuration conf=this.createConfiguration();
  conf.unset(Constants.SERVER_SIDE_ENCRYPTION_ALGORITHM);
  conf.unset(Constants.SERVER_SIDE_ENCRYPTION_KEY);
  S3AContract contract=(S3AContract)createContract(conf);
  contract.init();
  FileSystem unencryptedFileSystem=contract.getTestFileSystem();
  unencryptedFileSystem.listFiles(pathA,true);
  unencryptedFileSystem.listFiles(pathAB,true);
  AWSBadRequestException ex=intercept(AWSBadRequestException.class,() -> {
    unencryptedFileSystem.listFiles(pathABC,false);
  }
);
}
