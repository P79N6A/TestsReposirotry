class ProgressiveLogClient {
  JenkinsRule.WebClient wc;
  Run run;
  String consoleAnnotator;
  String start;
  private Page p;
  ProgressiveLogClient(  JenkinsRule.WebClient wc,  Run r){
    this.wc=wc;
    this.run=r;
  }
  String next() throws IOException {
    WebRequest req=new WebRequest(new URL(r.getURL() + run.getUrl() + "/logText/progressiveHtml"+ (start != null ? "?start=" + start : "")));
    req.setEncodingType(null);
    Map headers=new HashMap();
    if (consoleAnnotator != null)     headers.put("X-ConsoleAnnotator",consoleAnnotator);
    req.setAdditionalHeaders(headers);
    p=wc.getPage(req);
    consoleAnnotator=p.getWebResponse().getResponseHeaderValue("X-ConsoleAnnotator");
    start=p.getWebResponse().getResponseHeaderValue("X-Text-Size");
    return p.getWebResponse().getContentAsString();
  }
}
