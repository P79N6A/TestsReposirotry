/** 
 * @author Kohsuke Kawaguchi
 */
public class TooManyJobsButNoViewTest {
  @Rule public JenkinsRule r=new JenkinsRule();
  private TooManyJobsButNoView mon;
  @Before public void setUp() throws Exception {
    mon=AdministrativeMonitor.all().get(TooManyJobsButNoView.class);
  }
  /** 
 * Shouldn't be active at the beginning
 */
  @Test public void initialState() throws Exception {
    verifyNoForm();
  }
  private void verifyNoForm() throws IOException, SAXException {
    HtmlPage p=r.createWebClient().goTo("manage");
    try {
      p.getFormByName(mon.id);
      fail();
    }
 catch (    ElementNotFoundException e) {
    }
  }
  /** 
 * Once we have enough jobs, it should kick in
 */
  @Test public void activated() throws Exception {
    for (int i=0; i <= TooManyJobsButNoView.THRESHOLD; i++)     r.createFreeStyleProject();
    HtmlPage p=r.createWebClient().goTo("manage");
    HtmlForm f=p.getFormByName(mon.id);
    assertNotNull(f);
    URL url=r.submit(f,"yes").getUrl();
    assertTrue(url.toExternalForm(),url.toExternalForm().endsWith("/newView"));
    p=r.createWebClient().goTo("manage");
    assertNotNull(p.getFormByName(mon.id));
    r.jenkins.addView(new ListView("test"));
    verifyNoForm();
  }
}
