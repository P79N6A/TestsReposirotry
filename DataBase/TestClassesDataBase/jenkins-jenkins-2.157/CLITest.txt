public class CLITest {
  @Rule public JenkinsRule j=new JenkinsRule();
  /** 
 * Checks if the kill switch works correctly
 */
  @Test public void killSwitch() throws Exception {
    j.jenkins.setSlaveAgentPort(-1);
    makeCall();
    j.jenkins.setSlaveAgentPort(0);
    makeCall();
    CLI.get().setEnabled(false);
    try {
      j.jenkins.setSlaveAgentPort(-1);
      makeCall();
      fail("Should have been rejected");
    }
 catch (    Exception e) {
      e.printStackTrace();
    }
    try {
      j.jenkins.setSlaveAgentPort(0);
      makeCall();
      fail("Should have been rejected");
    }
 catch (    Exception e) {
      e.printStackTrace();
    }
  }
  private void makeCall() throws Exception {
    int r=hudson.cli.CLI._main(new String[]{"-s",j.getURL().toString(),"-remoting","-noKeyAuth","version"});
    if (r != 0)     throw new Failure("CLI failed");
  }
}
