public class ParametersDefinitionPropertyTest {
  @Rule public JenkinsRule r=new JenkinsRule();
  @Rule public LoggerRule logs=new LoggerRule();
  @Issue("JENKINS-31458") @Test public void customNewInstance() throws Exception {
    logs.record(Descriptor.class,Level.ALL);
    KrazyParameterDefinition kpd=new KrazyParameterDefinition("kpd","desc","KrAzY");
    FreeStyleProject p=r.createFreeStyleProject();
    ParametersDefinitionProperty pdp=new ParametersDefinitionProperty(kpd);
    p.addProperty(pdp);
    r.configRoundtrip(p);
    pdp=p.getProperty(ParametersDefinitionProperty.class);
    kpd=(KrazyParameterDefinition)pdp.getParameterDefinition("kpd");
    assertEquals("desc",kpd.getDescription());
    assertEquals("krazy",kpd.field);
  }
public static class KrazyParameterDefinition extends ParameterDefinition {
    public final String field;
    public KrazyParameterDefinition(    String name,    String description,    String field){
      super(name,description);
      this.field=field;
    }
    @Override public ParameterValue createValue(    StaplerRequest req,    JSONObject jo){
      throw new UnsupportedOperationException();
    }
    @Override public ParameterValue createValue(    StaplerRequest req){
      throw new UnsupportedOperationException();
    }
@TestExtension("customNewInstance") public static class DescriptorImpl extends ParameterDescriptor {
      @Override public ParameterDefinition newInstance(      StaplerRequest req,      JSONObject formData) throws FormException {
        return new KrazyParameterDefinition(formData.getString("name"),formData.getString("description"),formData.getString("field").toLowerCase(Locale.ENGLISH));
      }
    }
  }
}
