/** 
 * @author Kohsuke Kawaguchi
 */
public class UpdateCenter2Test {
  @Rule public JenkinsRule j=new JenkinsRule();
  /** 
 * Makes sure a plugin installs fine.
 */
  @Test public void install() throws Exception {
    UpdateSite.neverUpdate=false;
    j.jenkins.pluginManager.doCheckUpdatesServer();
    DownloadJob job=(DownloadJob)j.jenkins.getUpdateCenter().getPlugin("changelog-history").deploy().get();
    System.out.println(job.status);
    assertTrue(job.status instanceof Success);
  }
  @Test public void getLastUpdatedString(){
    UpdateSite.neverUpdate=false;
    assertTrue(j.jenkins.getUpdateCenter().getById("default").isDue());
    assertEquals(Messages.UpdateCenter_n_a(),j.jenkins.getUpdateCenter().getLastUpdatedString());
  }
  @Issue("SECURITY-234") @Test public void installInvalidChecksum() throws Exception {
    UpdateSite.neverUpdate=false;
    j.jenkins.pluginManager.doCheckUpdatesServer();
    String wrongChecksum="ABCDEFG1234567890";
    j.jenkins.getUpdateCenter().getSite("default").getPlugin("changelog-history").sha512=wrongChecksum;
    DownloadJob job=(DownloadJob)j.jenkins.getUpdateCenter().getPlugin("changelog-history").deploy().get();
    assertTrue(job.status instanceof Failure);
    assertTrue("error message references checksum",((Failure)job.status).problem.getMessage().contains(wrongChecksum));
  }
}
