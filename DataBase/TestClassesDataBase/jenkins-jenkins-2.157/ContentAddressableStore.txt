/** 
 * Simulation of a storage service with URLs unrelated to  {@link Run#doArtifact}. 
 */
@TestExtension("externalURLDownload") public static final class ContentAddressableStore implements UnprotectedRootAction {
  final List<byte[]> files=new ArrayList<>();
  @Override public String getUrlName(){
    return "files";
  }
  @Override public String getIconFileName(){
    return null;
  }
  @Override public String getDisplayName(){
    return null;
  }
  public void doDynamic(  StaplerRequest req,  StaplerResponse rsp) throws Exception {
    String hash=req.getRestOfPath().substring(1);
    for (    byte[] file : files) {
      if (Util.getDigestOf(new ByteArrayInputStream(file)).equals(hash)) {
        rsp.setContentType("application/octet-stream");
        rsp.getOutputStream().write(file);
        return;
      }
    }
    rsp.sendError(404);
  }
}
