/** 
 * Operator that counts processed messages and keeps result on state.
 */
private static class CounterOperator extends RestoreWatchOperator<String,String> {
  private static final long serialVersionUID=2048954179291813243L;
  private ListState<Long> counterState;
  private long counter=0;
  @Override public void processElement(  StreamRecord<String> element) throws Exception {
    counter++;
    output.collect(element);
  }
  @Override public void initializeState(  StateInitializationContext context) throws Exception {
    super.initializeState(context);
    counterState=context.getOperatorStateStore().getListState(new ListStateDescriptor<>("counter-state",LongSerializer.INSTANCE));
    if (context.isRestored()) {
      for (      Long value : counterState.get()) {
        counter+=value;
      }
      counterState.clear();
    }
  }
  @Override public void snapshotState(  StateSnapshotContext context) throws Exception {
    counterState.add(counter);
  }
}
