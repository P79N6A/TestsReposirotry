/** 
 * Tests for the  {@link StandaloneJobClusterConfigurationParserFactory}.
 */
public class StandaloneJobClusterConfigurationParserFactoryTest extends TestLogger {
  private static final CommandLineParser<StandaloneJobClusterConfiguration> commandLineParser=new CommandLineParser<>(new StandaloneJobClusterConfigurationParserFactory());
  private static final String JOB_CLASS_NAME="foobar";
  private static final String CONFIG_DIR="/foo/bar";
  @Test public void testEntrypointClusterConfigurationParsing() throws FlinkParseException {
    final String key="key";
    final String value="value";
    final int restPort=1234;
    final String arg1="arg1";
    final String arg2="arg2";
    final String[] args={"--configDir",CONFIG_DIR,"--webui-port",String.valueOf(restPort),"--job-classname",JOB_CLASS_NAME,String.format("-D%s=%s",key,value),arg1,arg2};
    final StandaloneJobClusterConfiguration clusterConfiguration=commandLineParser.parse(args);
    assertThat(clusterConfiguration.getConfigDir(),is(equalTo(CONFIG_DIR)));
    assertThat(clusterConfiguration.getJobClassName(),is(equalTo(JOB_CLASS_NAME)));
    assertThat(clusterConfiguration.getRestPort(),is(equalTo(restPort)));
    final Properties dynamicProperties=clusterConfiguration.getDynamicProperties();
    assertThat(dynamicProperties,hasEntry(key,value));
    assertThat(clusterConfiguration.getArgs(),arrayContaining(arg1,arg2));
    assertThat(clusterConfiguration.getSavepointRestoreSettings(),is(equalTo(SavepointRestoreSettings.none())));
  }
  @Test public void testOnlyRequiredArguments() throws FlinkParseException {
    final String configDir="/foo/bar";
    final String jobClassName="foobar";
    final String[] args={"--configDir",configDir,"--job-classname",jobClassName};
    final StandaloneJobClusterConfiguration clusterConfiguration=commandLineParser.parse(args);
    assertThat(clusterConfiguration.getConfigDir(),is(equalTo(configDir)));
    assertThat(clusterConfiguration.getJobClassName(),is(equalTo(jobClassName)));
    assertThat(clusterConfiguration.getRestPort(),is(equalTo(-1)));
  }
  @Test(expected=FlinkParseException.class) public void testMissingRequiredArgument() throws FlinkParseException {
    final String[] args={};
    commandLineParser.parse(args);
  }
  @Test public void testSavepointRestoreSettingsParsing() throws FlinkParseException {
    final String restorePath="foobar";
    final String[] args={"-c",CONFIG_DIR,"-j",JOB_CLASS_NAME,"-s",restorePath,"-n"};
    final StandaloneJobClusterConfiguration standaloneJobClusterConfiguration=commandLineParser.parse(args);
    final SavepointRestoreSettings savepointRestoreSettings=standaloneJobClusterConfiguration.getSavepointRestoreSettings();
    assertThat(savepointRestoreSettings.restoreSavepoint(),is(true));
    assertThat(savepointRestoreSettings.getRestorePath(),is(equalTo(restorePath)));
    assertThat(savepointRestoreSettings.allowNonRestoredState(),is(true));
  }
}
