/** 
 * Test network stack with taskmanager.network.netty.transport set to epoll. This test can only run on linux. On other platforms it's basically a NO-OP. See https://github.com/apache/flink-shaded/issues/30
 */
public class NettyEpollITCase extends TestLogger {
  private static final Logger LOG=LoggerFactory.getLogger(NettyEpollITCase.class);
  private static final int NUM_TASK_MANAGERS=2;
  @Test public void testNettyEpoll() throws Exception {
    MiniClusterResource cluster=trySetUpCluster();
    try {
      StreamExecutionEnvironment env=StreamExecutionEnvironment.getExecutionEnvironment();
      env.setParallelism(NUM_TASK_MANAGERS);
      env.getConfig().disableSysoutLogging();
      DataStream<Integer> input=env.fromElements(1,2,3,4,1,2,3,42);
      input.keyBy(new KeySelector<Integer,Integer>(){
        @Override public Integer getKey(        Integer value) throws Exception {
          return value;
        }
      }
).sum(0).print();
      env.execute();
    }
  finally {
      cluster.after();
    }
  }
  private MiniClusterResource trySetUpCluster() throws Exception {
    try {
      Configuration config=new Configuration();
      config.setString(TRANSPORT_TYPE,"epoll");
      MiniClusterResource cluster=new MiniClusterResource(new MiniClusterResourceConfiguration.Builder().setConfiguration(config).setNumberTaskManagers(NUM_TASK_MANAGERS).setNumberSlotsPerTaskManager(1).build());
      cluster.before();
      return cluster;
    }
 catch (    UnsatisfiedLinkError ex) {
      if (findThrowableWithMessage(ex,"Only supported on Linux").isPresent()) {
        throw new AssumptionViolatedException("This test is only supported on linux");
      }
      throw ex;
    }
  }
}
