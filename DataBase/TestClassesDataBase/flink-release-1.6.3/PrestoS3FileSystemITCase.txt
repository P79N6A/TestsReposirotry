/** 
 * Unit tests for the S3 file system support via Presto's  {@link com.facebook.presto.hive.PrestoS3FileSystem}. <p><strong>BEWARE</strong>: tests must take special care of S3's <a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/Introduction.html#ConsistencyModel">consistency guarantees</a> and what the  {@link com.facebook.presto.hive.PrestoS3FileSystem} offers.
 */
public class PrestoS3FileSystemITCase extends TestLogger {
  private static final String BUCKET=System.getenv("ARTIFACTS_AWS_BUCKET");
  private static final String TEST_DATA_DIR="tests-" + UUID.randomUUID();
  private static final String ACCESS_KEY=System.getenv("ARTIFACTS_AWS_ACCESS_KEY");
  private static final String SECRET_KEY=System.getenv("ARTIFACTS_AWS_SECRET_KEY");
  @BeforeClass public static void checkIfCredentialsArePresent(){
    Assume.assumeTrue("AWS S3 bucket not configured, skipping test...",BUCKET != null);
    Assume.assumeTrue("AWS S3 access key not configured, skipping test...",ACCESS_KEY != null);
    Assume.assumeTrue("AWS S3 secret key not configured, skipping test...",SECRET_KEY != null);
  }
  @Test public void testConfigKeysForwarding() throws Exception {
    final Path path=new Path("s3://" + BUCKET + '/'+ TEST_DATA_DIR);
{
      Configuration conf=new Configuration();
      conf.setString(S3_USE_INSTANCE_CREDENTIALS,"false");
      FileSystem.initialize(conf);
      try {
        path.getFileSystem().exists(path);
        fail("should fail with an exception");
      }
 catch (      IOException ignored) {
      }
    }
{
      Configuration conf=new Configuration();
      conf.setString(S3_USE_INSTANCE_CREDENTIALS,"false");
      conf.setString("presto.s3.access-key",ACCESS_KEY);
      conf.setString("presto.s3.secret-key",SECRET_KEY);
      FileSystem.initialize(conf);
      path.getFileSystem().exists(path);
    }
{
      Configuration conf=new Configuration();
      conf.setString(S3_USE_INSTANCE_CREDENTIALS,"false");
      conf.setString("s3.access-key",ACCESS_KEY);
      conf.setString("s3.secret-key",SECRET_KEY);
      FileSystem.initialize(conf);
      path.getFileSystem().exists(path);
    }
{
      Configuration conf=new Configuration();
      conf.setString(S3_USE_INSTANCE_CREDENTIALS,"false");
      conf.setString("s3.access.key",ACCESS_KEY);
      conf.setString("s3.secret.key",SECRET_KEY);
      FileSystem.initialize(conf);
      path.getFileSystem().exists(path);
    }
{
      Configuration conf=new Configuration();
      conf.setString(S3_USE_INSTANCE_CREDENTIALS,"false");
      conf.setString("presto.s3.access.key",ACCESS_KEY);
      conf.setString("presto.s3.secret.key",SECRET_KEY);
      FileSystem.initialize(conf);
      path.getFileSystem().exists(path);
    }
    FileSystem.initialize(new Configuration());
  }
  @Test public void testSimpleFileWriteAndRead() throws Exception {
    final long deadline=System.nanoTime() + 30_000_000_000L;
    final Configuration conf=new Configuration();
    conf.setString("s3.access-key",ACCESS_KEY);
    conf.setString("s3.secret-key",SECRET_KEY);
    final String testLine="Hello Upload!";
    FileSystem.initialize(conf);
    final Path path=new Path("s3://" + BUCKET + '/'+ TEST_DATA_DIR+ "/test.txt");
    final FileSystem fs=path.getFileSystem();
    try {
      try (FSDataOutputStream out=fs.create(path,WriteMode.OVERWRITE);OutputStreamWriter writer=new OutputStreamWriter(out,StandardCharsets.UTF_8)){
        writer.write(testLine);
      }
       try (FSDataInputStream in=fs.open(path);InputStreamReader ir=new InputStreamReader(in,StandardCharsets.UTF_8);BufferedReader reader=new BufferedReader(ir)){
        String line=reader.readLine();
        assertEquals(testLine,line);
      }
     }
  finally {
      fs.delete(path,false);
    }
    checkPathEventualExistence(fs,path,false,deadline);
  }
  @Test public void testDirectoryListing() throws Exception {
    final long deadline=System.nanoTime() + 30_000_000_000L;
    final Configuration conf=new Configuration();
    conf.setString("s3.access-key",ACCESS_KEY);
    conf.setString("s3.secret-key",SECRET_KEY);
    FileSystem.initialize(conf);
    final Path directory=new Path("s3://" + BUCKET + '/'+ TEST_DATA_DIR+ "/testdir/");
    final FileSystem fs=directory.getFileSystem();
    assertFalse(fs.exists(directory));
    try {
      assertTrue(fs.mkdirs(directory));
      assertEquals(0,fs.listStatus(directory).length);
      final int numFiles=3;
      for (int i=0; i < numFiles; i++) {
        Path file=new Path(directory,"/file-" + i);
        try (FSDataOutputStream out=fs.create(file,WriteMode.OVERWRITE);OutputStreamWriter writer=new OutputStreamWriter(out,StandardCharsets.UTF_8)){
          writer.write("hello-" + i + "\n");
        }
       }
      FileStatus[] files=fs.listStatus(directory);
      assertNotNull(files);
      assertEquals(3,files.length);
      for (      FileStatus status : files) {
        assertFalse(status.isDir());
      }
      assertTrue(fs.exists(directory));
    }
  finally {
      fs.delete(directory,true);
    }
    checkPathEventualExistence(fs,directory,false,deadline);
  }
}
