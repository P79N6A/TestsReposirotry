/** 
 * IT case for the  {@link AvroExternalJarProgram}.
 */
public class LegacyAvroExternalJarProgramITCase extends TestLogger {
  private static final String JAR_FILE="maven-test-jar.jar";
  private static final String TEST_DATA_FILE="/testdata.avro";
  @Test public void testExternalProgram(){
    LocalFlinkMiniCluster testMiniCluster=null;
    try {
      int parallelism=4;
      Configuration config=new Configuration();
      config.setInteger(ConfigConstants.TASK_MANAGER_NUM_TASK_SLOTS,parallelism);
      testMiniCluster=new LocalFlinkMiniCluster(config,false);
      testMiniCluster.start();
      String jarFile=JAR_FILE;
      String testData=getClass().getResource(TEST_DATA_FILE).toString();
      PackagedProgram program=new PackagedProgram(new File(jarFile),new String[]{testData});
      TestEnvironment.setAsContext(testMiniCluster,parallelism,Collections.singleton(new Path(jarFile)),Collections.<URL>emptyList());
      config.setString(JobManagerOptions.ADDRESS,"localhost");
      config.setInteger(JobManagerOptions.PORT,testMiniCluster.getLeaderRPCPort());
      program.invokeInteractiveModeForExecution();
    }
 catch (    Throwable t) {
      System.err.println(t.getMessage());
      t.printStackTrace();
      Assert.fail("Error during the packaged program execution: " + t.getMessage());
    }
 finally {
      TestEnvironment.unsetAsContext();
      if (testMiniCluster != null) {
        try {
          testMiniCluster.stop();
        }
 catch (        Throwable t) {
        }
      }
    }
  }
}
