private static class StateSourceBase extends RichParallelSourceFunction<Integer> {
  private static final long serialVersionUID=7512206069681177940L;
  private static volatile CountDownLatch workStartedLatch=new CountDownLatch(1);
  protected volatile int counter=0;
  protected volatile boolean running=true;
  @Override public void run(  SourceContext<Integer> ctx) throws Exception {
    final Object lock=ctx.getCheckpointLock();
    while (running) {
synchronized (lock) {
        ++counter;
        ctx.collect(1);
      }
      Thread.sleep(2);
      if (counter == 10) {
        workStartedLatch.countDown();
      }
      if (counter >= 500) {
        break;
      }
    }
  }
  @Override public void cancel(){
    running=false;
  }
}
