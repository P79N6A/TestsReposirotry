private static class OnceFailingIdentityMapper extends RichMapFunction<String,String> {
  private static final long serialVersionUID=1L;
  private static volatile boolean hasFailed=false;
  private final long numElements;
  private long failurePos;
  private long count;
  OnceFailingIdentityMapper(  long numElements){
    this.numElements=numElements;
  }
  @Override public void open(  org.apache.flink.configuration.Configuration parameters) throws IOException {
    long failurePosMin=(long)(0.7 * numElements / getRuntimeContext().getNumberOfParallelSubtasks());
    long failurePosMax=(long)(0.9 * numElements / getRuntimeContext().getNumberOfParallelSubtasks());
    failurePos=(new Random().nextLong() % (failurePosMax - failurePosMin)) + failurePosMin;
    count=0;
  }
  @Override public String map(  String value) throws Exception {
    count++;
    if (!hasFailed && count >= failurePos) {
      hasFailed=true;
      throw new Exception("Test Failure");
    }
    return value;
  }
}
