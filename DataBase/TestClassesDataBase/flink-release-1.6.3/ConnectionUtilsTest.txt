/** 
 * Tests for the network utilities.
 */
@RunWith(PowerMockRunner.class) @PrepareForTest(ConnectionUtils.class) public class ConnectionUtilsTest {
  @Test public void testReturnLocalHostAddressUsingHeuristics() throws Exception {
    try (ServerSocket blocker=new ServerSocket(0,1,InetAddress.getLocalHost())){
      InetSocketAddress unreachable=new InetSocketAddress("localhost",blocker.getLocalPort());
      final long start=System.nanoTime();
      InetAddress add=ConnectionUtils.findConnectingAddress(unreachable,2000,400);
      assertTrue(System.nanoTime() - start < 30_000_000_000L);
      assertNotNull(add);
      assertEquals(InetAddress.getLocalHost(),add);
    }
   }
  @Test public void testFindConnectingAddressWhenGetLocalHostThrows() throws Exception {
    PowerMockito.mockStatic(InetAddress.class);
    Mockito.when(InetAddress.getLocalHost()).thenThrow(new UnknownHostException()).thenCallRealMethod();
    final InetAddress loopbackAddress=Inet4Address.getByName("127.0.0.1");
    Thread socketServerThread;
    try (ServerSocket socket=new ServerSocket(0,1,loopbackAddress)){
      socket.setSoTimeout(10_000);
      socketServerThread=new Thread(new Runnable(){
        @Override public void run(){
          try {
            socket.accept();
          }
 catch (          IOException e) {
          }
        }
      }
);
      socketServerThread.start();
      final InetSocketAddress socketAddress=new InetSocketAddress(loopbackAddress,socket.getLocalPort());
      final InetAddress address=ConnectionUtils.findConnectingAddress(socketAddress,2000,400);
      PowerMockito.verifyStatic();
      assertNotNull(address);
    }
   }
}
