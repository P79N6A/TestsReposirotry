private static class OnceFailingReducer extends RichReduceFunction<PrefixCount> {
  private static volatile boolean hasFailed=false;
  private final long numElements;
  private long failurePos;
  private long count;
  OnceFailingReducer(  long numElements){
    this.numElements=numElements;
  }
  @Override public void open(  Configuration parameters){
    long failurePosMin=(long)(0.4 * numElements / getRuntimeContext().getNumberOfParallelSubtasks());
    long failurePosMax=(long)(0.7 * numElements / getRuntimeContext().getNumberOfParallelSubtasks());
    failurePos=(new Random().nextLong() % (failurePosMax - failurePosMin)) + failurePosMin;
    count=0;
  }
  @Override public PrefixCount reduce(  PrefixCount value1,  PrefixCount value2) throws Exception {
    count++;
    if (!hasFailed && count >= failurePos) {
      hasFailed=true;
      throw new Exception("Test Failure");
    }
    value1.count+=value2.count;
    return value1;
  }
}
