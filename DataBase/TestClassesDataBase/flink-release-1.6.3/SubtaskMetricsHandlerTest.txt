/** 
 * Tests for the  {@link SubtaskMetricsHandler}.
 */
public class SubtaskMetricsHandlerTest extends TestLogger {
  @Test public void testGetPaths(){
    SubtaskMetricsHandler handler=new SubtaskMetricsHandler(Executors.directExecutor(),mock(MetricFetcher.class));
    String[] paths=handler.getPaths();
    Assert.assertEquals(1,paths.length);
    Assert.assertEquals("/jobs/:jobid/vertices/:vertexid/subtasks/:subtasknum/metrics",paths[0]);
  }
  @Test public void getMapFor() throws Exception {
    MetricFetcher fetcher=new MetricFetcher(mock(GatewayRetriever.class),mock(MetricQueryServiceRetriever.class),Executors.directExecutor(),TestingUtils.TIMEOUT());
    MetricStore store=MetricStoreTest.setupStore(fetcher.getMetricStore());
    SubtaskMetricsHandler handler=new SubtaskMetricsHandler(Executors.directExecutor(),fetcher);
    Map<String,String> pathParams=new HashMap<>();
    pathParams.put(PARAMETER_JOB_ID,"jobid");
    pathParams.put(PARAMETER_VERTEX_ID,"taskid");
    pathParams.put(PARAMETER_SUBTASK_INDEX,"8");
    Map<String,String> metrics=handler.getMapFor(pathParams,store);
    assertEquals("4",metrics.get("abc.metric5"));
    assertEquals("5",metrics.get("opname.abc.metric6"));
    assertEquals("6",metrics.get("opname.abc.metric7"));
  }
  @Test public void getMapForNull(){
    MetricFetcher fetcher=new MetricFetcher(mock(GatewayRetriever.class),mock(MetricQueryServiceRetriever.class),Executors.directExecutor(),TestingUtils.TIMEOUT());
    MetricStore store=fetcher.getMetricStore();
    SubtaskMetricsHandler handler=new SubtaskMetricsHandler(Executors.directExecutor(),fetcher);
    Map<String,String> pathParams=new HashMap<>();
    Map<String,String> metrics=handler.getMapFor(pathParams,store);
    assertNull(metrics);
  }
}
