/** 
 * UDF that notifies when it changes the accumulator values.
 */
private static class NotifyingMapper extends RichFlatMapFunction<Integer,Integer> {
  private static final long serialVersionUID=1L;
  private static final OneShotLatch notifyLatch=new OneShotLatch();
  private static final OneShotLatch shutdownLatch=new OneShotLatch();
  private final IntCounter counter=new IntCounter();
  @Override public void open(  Configuration parameters) throws Exception {
    getRuntimeContext().addAccumulator(ACCUMULATOR_NAME,counter);
  }
  @Override public void flatMap(  Integer value,  Collector<Integer> out) throws Exception {
    counter.add(1);
    out.collect(value);
    LOG.debug("Emitting value {}.",value);
    if (counter.getLocalValuePrimitive() == 5) {
      notifyLatch.trigger();
    }
  }
  @Override public void close() throws Exception {
    shutdownLatch.await();
  }
  private static void reset() throws InterruptedException {
    notifyLatch.reset();
    shutdownLatch.reset();
  }
}
