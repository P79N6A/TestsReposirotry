/** 
 * Basic integration tests for demo application.
 * @author Dave Syer
 * @author Andy Wilkinson
 */
@RunWith(SpringRunner.class) @SpringBootTest(webEnvironment=WebEnvironment.RANDOM_PORT) public class SampleTomcatApplicationTests {
  @Autowired private TestRestTemplate restTemplate;
  @Autowired private ApplicationContext applicationContext;
  @Test public void testHome(){
    ResponseEntity<String> entity=this.restTemplate.getForEntity("/",String.class);
    assertThat(entity.getStatusCode()).isEqualTo(HttpStatus.OK);
    assertThat(entity.getBody()).isEqualTo("Hello World");
  }
  @Test public void testCompression() throws Exception {
    HttpHeaders requestHeaders=new HttpHeaders();
    requestHeaders.set("Accept-Encoding","gzip");
    HttpEntity<?> requestEntity=new HttpEntity<>(requestHeaders);
    ResponseEntity<byte[]> entity=this.restTemplate.exchange("/",HttpMethod.GET,requestEntity,byte[].class);
    assertThat(entity.getStatusCode()).isEqualTo(HttpStatus.OK);
    try (GZIPInputStream inflater=new GZIPInputStream(new ByteArrayInputStream(entity.getBody()))){
      assertThat(StreamUtils.copyToString(inflater,StandardCharsets.UTF_8)).isEqualTo("Hello World");
    }
   }
  @Test public void testTimeout(){
    ServletWebServerApplicationContext context=(ServletWebServerApplicationContext)this.applicationContext;
    TomcatWebServer embeddedServletContainer=(TomcatWebServer)context.getWebServer();
    ProtocolHandler protocolHandler=embeddedServletContainer.getTomcat().getConnector().getProtocolHandler();
    int timeout=((AbstractProtocol<?>)protocolHandler).getConnectionTimeout();
    assertThat(timeout).isEqualTo(5000);
  }
}
