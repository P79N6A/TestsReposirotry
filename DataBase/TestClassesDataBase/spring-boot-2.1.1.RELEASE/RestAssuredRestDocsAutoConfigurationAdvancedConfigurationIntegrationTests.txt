/** 
 * Integration tests for advanced configuration of  {@link AutoConfigureRestDocs} with RESTAssured.
 * @author Eddú Meléndez
 */
@RunWith(SpringRunner.class) @SpringBootTest(webEnvironment=WebEnvironment.RANDOM_PORT) @AutoConfigureRestDocs public class RestAssuredRestDocsAutoConfigurationAdvancedConfigurationIntegrationTests {
  @LocalServerPort private int port;
  @Before public void deleteSnippets(){
    FileSystemUtils.deleteRecursively(new File("target/generated-snippets"));
  }
  @Autowired private RequestSpecification documentationSpec;
  @Test public void snippetGeneration(){
    given(this.documentationSpec).filter(document("default-snippets",preprocessRequest(modifyUris().scheme("https").host("api.example.com").removePort()))).when().port(this.port).get("/").then().assertThat().statusCode(is(200));
    File defaultSnippetsDir=new File("target/generated-snippets/default-snippets");
    assertThat(defaultSnippetsDir).exists();
    assertThat(new File(defaultSnippetsDir,"curl-request.md")).has(contentContaining("'https://api.example.com/'"));
    assertThat(new File(defaultSnippetsDir,"http-request.md")).has(contentContaining("api.example.com"));
    assertThat(new File(defaultSnippetsDir,"http-response.md")).isFile();
    assertThat(new File(defaultSnippetsDir,"response-fields.md")).isFile();
  }
  private Condition<File> contentContaining(  String toContain){
    return new ContentContainingCondition(toContain);
  }
@TestConfiguration public static class CustomizationConfiguration {
    @Bean public RestDocumentationResultHandler restDocumentation(){
      return MockMvcRestDocumentation.document("{method-name}");
    }
    @Bean public RestDocsRestAssuredConfigurationCustomizer templateFormatCustomizer(){
      return (configurer) -> configurer.snippets().withTemplateFormat(TemplateFormats.markdown());
    }
    @Bean public RestDocsRestAssuredConfigurationCustomizer defaultSnippetsCustomizer(){
      return (configurer) -> configurer.snippets().withAdditionalDefaults(responseFields(fieldWithPath("_links.self").description("Main URL")));
    }
  }
}
