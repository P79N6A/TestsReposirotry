@Configuration protected static class TestConfigurationWithEntityManagerFactory extends TestConfiguration {
  @Bean public EntityManagerFactory entityManagerFactory(  DataSource dataSource,  JpaVendorAdapter adapter){
    LocalContainerEntityManagerFactoryBean factoryBean=new LocalContainerEntityManagerFactoryBean();
    factoryBean.setJpaVendorAdapter(adapter);
    factoryBean.setDataSource(dataSource);
    factoryBean.setPersistenceUnitName("manually-configured");
    Map<String,Object> properties=new HashMap<>();
    properties.put("configured","manually");
    properties.put("hibernate.transaction.jta.platform",NoJtaPlatform.INSTANCE);
    factoryBean.setJpaPropertyMap(properties);
    factoryBean.afterPropertiesSet();
    return factoryBean.getObject();
  }
  @Bean public PlatformTransactionManager transactionManager(  EntityManagerFactory emf){
    JpaTransactionManager transactionManager=new JpaTransactionManager();
    transactionManager.setEntityManagerFactory(emf);
    return transactionManager;
  }
}
