private class TestGzipInputStreamFactory implements InputStreamFactory {
  private final AtomicBoolean requested=new AtomicBoolean(false);
  @Override public InputStream create(  InputStream in) throws IOException {
    if (this.requested.get()) {
      throw new IllegalStateException("On deflated InputStream already requested");
    }
    this.requested.set(true);
    return new GZIPInputStream(in);
  }
  public boolean wasCompressionUsed(){
    return this.requested.get();
  }
}
