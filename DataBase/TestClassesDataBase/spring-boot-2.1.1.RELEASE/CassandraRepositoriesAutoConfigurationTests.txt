/** 
 * Tests for  {@link CassandraRepositoriesAutoConfiguration}.
 * @author Eddú Meléndez
 * @author Mark Paluch
 * @author Stephane Nicoll
 */
public class CassandraRepositoriesAutoConfigurationTests {
  private final ApplicationContextRunner contextRunner=new ApplicationContextRunner().withConfiguration(AutoConfigurations.of(CassandraAutoConfiguration.class,CassandraRepositoriesAutoConfiguration.class,CassandraDataAutoConfiguration.class,PropertyPlaceholderAutoConfiguration.class));
  @Test public void testDefaultRepositoryConfiguration(){
    this.contextRunner.withUserConfiguration(TestConfiguration.class).run((context) -> {
      assertThat(context).hasSingleBean(CityRepository.class);
      assertThat(context).hasSingleBean(Cluster.class);
      assertThat(getInitialEntitySet(context)).hasSize(1);
    }
);
  }
  @Test public void testNoRepositoryConfiguration(){
    this.contextRunner.withUserConfiguration(TestExcludeConfiguration.class,EmptyConfiguration.class).run((context) -> {
      assertThat(context).hasSingleBean(Cluster.class);
      assertThat(getInitialEntitySet(context)).hasSize(1).containsOnly(City.class);
    }
);
  }
  @Test public void doesNotTriggerDefaultRepositoryDetectionIfCustomized(){
    this.contextRunner.withUserConfiguration(TestExcludeConfiguration.class,CustomizedConfiguration.class).run((context) -> {
      assertThat(context).hasSingleBean(CityCassandraRepository.class);
      assertThat(getInitialEntitySet(context)).hasSize(1).containsOnly(City.class);
    }
);
  }
  @Test public void enablingReactiveRepositoriesDisablesImperativeRepositories(){
    this.contextRunner.withUserConfiguration(TestConfiguration.class).withPropertyValues("spring.data.cassandra.repositories.type=reactive").run((context) -> assertThat(context).doesNotHaveBean(CityCassandraRepository.class));
  }
  @Test public void enablingNoRepositoriesDisablesImperativeRepositories(){
    this.contextRunner.withUserConfiguration(TestConfiguration.class).withPropertyValues("spring.data.cassandra.repositories.type=none").run((context) -> assertThat(context).doesNotHaveBean(CityCassandraRepository.class));
  }
  @SuppressWarnings("unchecked") private Set<Class<?>> getInitialEntitySet(  AssertableApplicationContext context){
    CassandraMappingContext mappingContext=context.getBean(CassandraMappingContext.class);
    return (Set<Class<?>>)ReflectionTestUtils.getField(mappingContext,"initialEntitySet");
  }
@Configuration @TestAutoConfigurationPackage(City.class) static class TestConfiguration {
    @Bean public Session session(){
      return mock(Session.class);
    }
  }
@Configuration @TestAutoConfigurationPackage(EmptyDataPackage.class) static class EmptyConfiguration {
  }
@Configuration @TestAutoConfigurationPackage(CassandraRepositoriesAutoConfigurationTests.class) @EnableCassandraRepositories(basePackageClasses=CityCassandraRepository.class) static class CustomizedConfiguration {
  }
@Configuration @ComponentScan(excludeFilters=@ComponentScan.Filter(classes={Session.class},type=FilterType.ASSIGNABLE_TYPE)) static class TestExcludeConfiguration {
  }
}
