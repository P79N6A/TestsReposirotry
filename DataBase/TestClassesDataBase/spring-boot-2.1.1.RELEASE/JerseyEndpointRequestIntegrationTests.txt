/** 
 * Integration tests for  {@link EndpointRequest} with Jersey.
 * @author Madhura Bhave
 */
public class JerseyEndpointRequestIntegrationTests extends AbstractEndpointRequestIntegrationTests {
  @Override protected WebApplicationContextRunner getContextRunner(){
    return new WebApplicationContextRunner(AnnotationConfigServletWebServerApplicationContext::new).withClassLoader(new FilteredClassLoader("org.springframework.web.servlet.DispatcherServlet")).withUserConfiguration(JerseyEndpointConfiguration.class,SecurityConfiguration.class,BaseConfiguration.class).withConfiguration(AutoConfigurations.of(SecurityAutoConfiguration.class,UserDetailsServiceAutoConfiguration.class,SecurityRequestMatcherProviderAutoConfiguration.class,JacksonAutoConfiguration.class,JerseyAutoConfiguration.class));
  }
  @Test public void toLinksWhenApplicationPathSetShouldMatch(){
    getContextRunner().withPropertyValues("spring.jersey.application-path=/admin").run((context) -> {
      WebTestClient webTestClient=getWebTestClient(context);
      webTestClient.get().uri("/admin/actuator/").exchange().expectStatus().isOk();
      webTestClient.get().uri("/admin/actuator").exchange().expectStatus().isOk();
    }
);
  }
  @Test public void toEndpointWhenApplicationPathSetShouldMatch(){
    getContextRunner().withPropertyValues("spring.jersey.application-path=/admin").run((context) -> {
      WebTestClient webTestClient=getWebTestClient(context);
      webTestClient.get().uri("/admin/actuator/e1").exchange().expectStatus().isOk();
    }
);
  }
  @Test public void toAnyEndpointWhenApplicationPathSetShouldMatch(){
    getContextRunner().withPropertyValues("spring.jersey.application-path=/admin","spring.security.user.password=password").run((context) -> {
      WebTestClient webTestClient=getWebTestClient(context);
      webTestClient.get().uri("/admin/actuator/e2").exchange().expectStatus().isUnauthorized();
      webTestClient.get().uri("/admin/actuator/e2").header("Authorization",getBasicAuth()).exchange().expectStatus().isOk();
    }
);
  }
@Configuration @EnableConfigurationProperties(WebEndpointProperties.class) static class JerseyEndpointConfiguration {
    private final ApplicationContext applicationContext;
    JerseyEndpointConfiguration(    ApplicationContext applicationContext){
      this.applicationContext=applicationContext;
    }
    @Bean public TomcatServletWebServerFactory tomcat(){
      return new TomcatServletWebServerFactory(0);
    }
    @Bean public ResourceConfig resourceConfig(){
      return new ResourceConfig();
    }
    @Bean public ResourceConfigCustomizer webEndpointRegistrar(){
      return this::customize;
    }
    private void customize(    ResourceConfig config){
      List<String> mediaTypes=Arrays.asList(javax.ws.rs.core.MediaType.APPLICATION_JSON,ActuatorMediaType.V2_JSON);
      EndpointMediaTypes endpointMediaTypes=new EndpointMediaTypes(mediaTypes,mediaTypes);
      WebEndpointDiscoverer discoverer=new WebEndpointDiscoverer(this.applicationContext,new ConversionServiceParameterValueMapper(),endpointMediaTypes,Arrays.asList((id) -> id.toString()),Collections.emptyList(),Collections.emptyList());
      Collection<Resource> resources=new JerseyEndpointResourceFactory().createEndpointResources(new EndpointMapping("/actuator"),discoverer.getEndpoints(),endpointMediaTypes,new EndpointLinksResolver(discoverer.getEndpoints()));
      config.registerResources(new HashSet<>(resources));
    }
  }
}
