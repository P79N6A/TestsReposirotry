/** 
 * Tests for  {@link CouchbaseReactiveDataAutoConfiguration}.
 * @author Alex Derkach
 */
public class CouchbaseReactiveDataAutoConfigurationTests {
  private AnnotationConfigApplicationContext context;
  @After public void close(){
    if (this.context != null) {
      this.context.close();
    }
  }
  @Test public void disabledIfCouchbaseIsNotConfigured(){
    load(null);
    assertThat(this.context.getBeansOfType(IndexManager.class)).isEmpty();
  }
  @Test public void customConfiguration(){
    load(CustomCouchbaseConfiguration.class);
    RxJavaCouchbaseTemplate rxJavaCouchbaseTemplate=this.context.getBean(RxJavaCouchbaseTemplate.class);
    assertThat(rxJavaCouchbaseTemplate.getDefaultConsistency()).isEqualTo(Consistency.STRONGLY_CONSISTENT);
  }
  @Test public void validatorIsPresent(){
    load(CouchbaseTestConfigurer.class);
    assertThat(this.context.getBeansOfType(ValidatingCouchbaseEventListener.class)).hasSize(1);
  }
  @Test @SuppressWarnings("unchecked") public void entityScanShouldSetInitialEntitySet(){
    load(EntityScanConfig.class);
    CouchbaseMappingContext mappingContext=this.context.getBean(CouchbaseMappingContext.class);
    Set<Class<?>> initialEntitySet=(Set<Class<?>>)ReflectionTestUtils.getField(mappingContext,"initialEntitySet");
    assertThat(initialEntitySet).containsOnly(City.class);
  }
  @Test public void customConversions(){
    load(CustomConversionsConfig.class);
    RxJavaCouchbaseTemplate template=this.context.getBean(RxJavaCouchbaseTemplate.class);
    assertThat(template.getConverter().getConversionService().canConvert(CouchbaseProperties.class,Boolean.class)).isTrue();
  }
  private void load(  Class<?> config,  String... environment){
    AnnotationConfigApplicationContext context=new AnnotationConfigApplicationContext();
    TestPropertyValues.of(environment).applyTo(context);
    if (config != null) {
      context.register(config);
    }
    context.register(PropertyPlaceholderAutoConfiguration.class,ValidationAutoConfiguration.class,CouchbaseAutoConfiguration.class,CouchbaseDataAutoConfiguration.class,CouchbaseReactiveDataAutoConfiguration.class);
    context.refresh();
    this.context=context;
  }
@Configuration static class CustomCouchbaseConfiguration extends AbstractReactiveCouchbaseDataConfiguration {
    @Override protected CouchbaseConfigurer couchbaseConfigurer(){
      return new CouchbaseTestConfigurer();
    }
    @Override protected Consistency getDefaultConsistency(){
      return Consistency.STRONGLY_CONSISTENT;
    }
  }
@Configuration @Import(CouchbaseTestConfigurer.class) static class CustomConversionsConfig {
    @Bean(BeanNames.COUCHBASE_CUSTOM_CONVERSIONS) public CouchbaseCustomConversions myCustomConversions(){
      return new CouchbaseCustomConversions(Collections.singletonList(new MyConverter()));
    }
  }
@Configuration @EntityScan("org.springframework.boot.autoconfigure.data.couchbase.city") @Import(CustomCouchbaseConfiguration.class) static class EntityScanConfig {
  }
static class MyConverter implements Converter<CouchbaseProperties,Boolean> {
    @Override public Boolean convert(    CouchbaseProperties value){
      return true;
    }
  }
}
