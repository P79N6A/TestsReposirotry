/** 
 * Basic integration tests for demo application.
 * @author Ivan Sopov
 * @author Andy Wilkinson
 */
@RunWith(SpringRunner.class) @SpringBootTest(webEnvironment=WebEnvironment.RANDOM_PORT) public class SampleUndertowApplicationTests {
  @Autowired private TestRestTemplate restTemplate;
  @Test public void testHome(){
    assertOkResponse("/","Hello World");
  }
  @Test public void testAsync(){
    assertOkResponse("/async","async: Hello World");
  }
  @Test public void testCompression() throws Exception {
    HttpHeaders requestHeaders=new HttpHeaders();
    requestHeaders.set("Accept-Encoding","gzip");
    HttpEntity<?> requestEntity=new HttpEntity<>(requestHeaders);
    ResponseEntity<byte[]> entity=this.restTemplate.exchange("/",HttpMethod.GET,requestEntity,byte[].class);
    assertThat(entity.getStatusCode()).isEqualTo(HttpStatus.OK);
    try (GZIPInputStream inflater=new GZIPInputStream(new ByteArrayInputStream(entity.getBody()))){
      assertThat(StreamUtils.copyToString(inflater,StandardCharsets.UTF_8)).isEqualTo("Hello World");
    }
   }
  private void assertOkResponse(  String path,  String body){
    ResponseEntity<String> entity=this.restTemplate.getForEntity(path,String.class);
    assertThat(entity.getStatusCode()).isEqualTo(HttpStatus.OK);
    assertThat(entity.getBody()).isEqualTo(body);
  }
}
