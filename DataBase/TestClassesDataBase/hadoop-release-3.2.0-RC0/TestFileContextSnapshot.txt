public class TestFileContextSnapshot {
  private static final short REPLICATION=3;
  private static final int BLOCKSIZE=1024;
  private static final long SEED=0;
  private Configuration conf;
  private MiniDFSCluster cluster;
  private FileContext fileContext;
  private DistributedFileSystem dfs;
  private final String snapshotRoot="/snapshot";
  private final Path filePath=new Path(snapshotRoot,"file1");
  private Path snapRootPath;
  @Before public void setUp() throws Exception {
    conf=new Configuration();
    conf.setLong(DFSConfigKeys.DFS_BLOCK_SIZE_KEY,BLOCKSIZE);
    cluster=new MiniDFSCluster.Builder(conf).numDataNodes(REPLICATION).build();
    cluster.waitActive();
    fileContext=FileContext.getFileContext(conf);
    dfs=(DistributedFileSystem)cluster.getFileSystem();
    snapRootPath=new Path(snapshotRoot);
    dfs.mkdirs(snapRootPath);
  }
  @After public void tearDown() throws Exception {
    if (cluster != null) {
      cluster.shutdown();
      cluster=null;
    }
  }
  @Test(timeout=60000) public void testCreateAndDeleteSnapshot() throws Exception {
    DFSTestUtil.createFile(dfs,filePath,BLOCKSIZE,REPLICATION,SEED);
    dfs.disallowSnapshot(snapRootPath);
    try {
      fileContext.createSnapshot(snapRootPath,"s1");
    }
 catch (    SnapshotException e) {
      GenericTestUtils.assertExceptionContains("Directory is not a snapshottable directory: " + snapRootPath,e);
    }
    dfs.allowSnapshot(snapRootPath);
    Path ssPath=fileContext.createSnapshot(snapRootPath,"s1");
    assertTrue("Failed to create snapshot",dfs.exists(ssPath));
    fileContext.deleteSnapshot(snapRootPath,"s1");
    assertFalse("Failed to delete snapshot",dfs.exists(ssPath));
  }
  /** 
 * Test FileStatus of snapshot file before/after rename
 */
  @Test(timeout=60000) public void testRenameSnapshot() throws Exception {
    DFSTestUtil.createFile(dfs,filePath,BLOCKSIZE,REPLICATION,SEED);
    dfs.allowSnapshot(snapRootPath);
    Path snapPath1=fileContext.createSnapshot(snapRootPath,"s1");
    Path ssPath=new Path(snapPath1,filePath.getName());
    assertTrue("Failed to create snapshot",dfs.exists(ssPath));
    FileStatus statusBeforeRename=dfs.getFileStatus(ssPath);
    fileContext.renameSnapshot(snapRootPath,"s1","s2");
    assertFalse("Old snapshot still exists after rename!",dfs.exists(ssPath));
    Path snapshotRoot=SnapshotTestHelper.getSnapshotRoot(snapRootPath,"s2");
    ssPath=new Path(snapshotRoot,filePath.getName());
    assertTrue("Snapshot doesn't exists!",dfs.exists(ssPath));
    FileStatus statusAfterRename=dfs.getFileStatus(ssPath);
    assertFalse("Filestatus of the snapshot matches",statusBeforeRename.equals(statusAfterRename));
    statusBeforeRename.setPath(statusAfterRename.getPath());
    assertEquals("FileStatus of the snapshot mismatches!",statusBeforeRename.toString(),statusAfterRename.toString());
  }
}
