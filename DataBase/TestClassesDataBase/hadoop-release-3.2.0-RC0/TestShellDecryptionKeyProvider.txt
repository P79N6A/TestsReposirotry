/** 
 * Test ShellDecryptionKeyProvider.
 */
public class TestShellDecryptionKeyProvider {
  public static final Log LOG=LogFactory.getLog(TestShellDecryptionKeyProvider.class);
  private static final File TEST_ROOT_DIR=new File(System.getProperty("test.build.data","/tmp"),"TestShellDecryptionKeyProvider");
  @Test public void testScriptPathNotSpecified() throws Exception {
    if (!Shell.WINDOWS) {
      return;
    }
    ShellDecryptionKeyProvider provider=new ShellDecryptionKeyProvider();
    Configuration conf=new Configuration();
    String account="testacct";
    String key="key";
    conf.set(ConfigurationKeys.FS_AZURE_ACCOUNT_KEY_PROPERTY_NAME + account,key);
    try {
      provider.getStorageAccountKey(account,conf);
      Assert.fail("fs.azure.shellkeyprovider.script is not specified, we should throw");
    }
 catch (    KeyProviderException e) {
      LOG.info("Received an expected exception: " + e.getMessage());
    }
  }
  @Test public void testValidScript() throws Exception {
    if (!Shell.WINDOWS) {
      return;
    }
    String expectedResult="decretedKey";
    File scriptFile=new File(TEST_ROOT_DIR,"testScript.cmd");
    FileUtils.writeStringToFile(scriptFile,"@echo %1 " + expectedResult,Charset.forName("UTF-8"));
    ShellDecryptionKeyProvider provider=new ShellDecryptionKeyProvider();
    Configuration conf=new Configuration();
    String account="testacct";
    String key="key1";
    conf.set(ConfigurationKeys.FS_AZURE_ACCOUNT_KEY_PROPERTY_NAME + account,key);
    conf.set(ConfigurationKeys.AZURE_KEY_ACCOUNT_SHELLKEYPROVIDER_SCRIPT,"cmd /c " + scriptFile.getAbsolutePath());
    String result=provider.getStorageAccountKey(account,conf);
    assertEquals(key + " " + expectedResult,result);
  }
}
