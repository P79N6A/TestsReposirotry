/** 
 * Test finalize() method when "fs.abfs.impl.disable.cache" is enabled.
 */
public class ITestAzureBlobFileSystemFinalize extends AbstractAbfsScaleTest {
  static final String DISABLE_ABFS_CACHE_KEY="fs.abfs.impl.disable.cache";
  static final String DISABLE_ABFSSS_CACHE_KEY="fs.abfss.impl.disable.cache";
  public ITestAzureBlobFileSystemFinalize() throws Exception {
    super();
  }
  @Test public void testFinalize() throws Exception {
    Configuration rawConfig=this.getRawConfiguration();
    rawConfig.setBoolean(this.getAuthType() == AuthType.SharedKey ? DISABLE_ABFS_CACHE_KEY : DISABLE_ABFSSS_CACHE_KEY,true);
    AzureBlobFileSystem fs=(AzureBlobFileSystem)FileSystem.get(rawConfig);
    WeakReference<Object> ref=new WeakReference<Object>(fs);
    fs=null;
    int i=0;
    int maxTries=1000;
    while (ref.get() != null && i < maxTries) {
      System.gc();
      System.runFinalization();
      i++;
    }
    Assert.assertTrue("testFinalizer didn't get cleaned up within maxTries",ref.get() == null);
  }
}
