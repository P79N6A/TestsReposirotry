private class InternalCompletionListenerForTest extends TaskExecutorService.InternalCompletionListener {
  private final Lock lock=new ReentrantLock();
  private final Condition completionCondition=lock.newCondition();
  private final AtomicBoolean isComplete=new AtomicBoolean(false);
  public InternalCompletionListenerForTest(  TaskWrapper taskWrapper){
    super(taskWrapper);
  }
  @Override public void onSuccess(  TaskRunner2Result result){
    super.onSuccess(result);
    markComplete();
  }
  @Override public void onFailure(  Throwable t){
    super.onFailure(t);
    markComplete();
  }
  private void markComplete(){
    lock.lock();
    try {
      isComplete.set(true);
      completionCondition.signal();
    }
  finally {
      lock.unlock();
    }
  }
  private void awaitCompletion() throws InterruptedException {
    lock.lock();
    try {
      while (!isComplete.get()) {
        completionCondition.await();
      }
    }
  finally {
      lock.unlock();
    }
  }
}
