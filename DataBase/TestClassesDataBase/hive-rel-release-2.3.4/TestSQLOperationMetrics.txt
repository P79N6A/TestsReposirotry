/** 
 * TestSQLOperationMetrics
 */
public class TestSQLOperationMetrics {
  private SQLOperation operation;
  private CodahaleMetrics metrics;
  @Before public void setup() throws Exception {
    HiveConf conf=new HiveConf();
    conf.setBoolVar(HiveConf.ConfVars.HIVE_SERVER2_METRICS_ENABLED,true);
    MetricsFactory.init(conf);
    HiveSession session=mock(HiveSession.class);
    when(session.getHiveConf()).thenReturn(conf);
    when(session.getSessionState()).thenReturn(mock(SessionState.class));
    when(session.getUserName()).thenReturn("userName");
    operation=new SQLOperation(session,"select * from dummy",Maps.<String,String>newHashMap(),false,0L);
    metrics=(CodahaleMetrics)MetricsFactory.getInstance();
  }
  @After public void tearDown() throws Exception {
    MetricsFactory.getInstance().close();
  }
  @Test public void testSubmittedQueryCount() throws Exception {
    String json=((CodahaleMetrics)metrics).dumpJson();
    MetricsTestUtils.verifyMetricsJson(json,MetricsTestUtils.TIMER,MetricsConstant.HS2_SUBMITTED_QURIES,"0");
    operation.onNewState(OperationState.FINISHED,OperationState.RUNNING);
    json=((CodahaleMetrics)metrics).dumpJson();
    MetricsTestUtils.verifyMetricsJson(json,MetricsTestUtils.TIMER,MetricsConstant.HS2_SUBMITTED_QURIES,"1");
  }
  @Test public void testActiveUserQueriesCount() throws Exception {
    String name=MetricsConstant.SQL_OPERATION_PREFIX + "active_user";
    String json=((CodahaleMetrics)metrics).dumpJson();
    MetricsTestUtils.verifyMetricsJson(json,MetricsTestUtils.COUNTER,name,"");
    operation.onNewState(OperationState.RUNNING,OperationState.INITIALIZED);
    json=((CodahaleMetrics)metrics).dumpJson();
    MetricsTestUtils.verifyMetricsJson(json,MetricsTestUtils.COUNTER,name,"1");
    operation.onNewState(OperationState.RUNNING,OperationState.RUNNING);
    json=((CodahaleMetrics)metrics).dumpJson();
    MetricsTestUtils.verifyMetricsJson(json,MetricsTestUtils.COUNTER,name,"1");
    operation.onNewState(OperationState.FINISHED,OperationState.RUNNING);
    json=((CodahaleMetrics)metrics).dumpJson();
    MetricsTestUtils.verifyMetricsJson(json,MetricsTestUtils.COUNTER,name,"0");
  }
  @Test public void testSucceededQueriesCount() throws Exception {
    String json=((CodahaleMetrics)metrics).dumpJson();
    MetricsTestUtils.verifyMetricsJson(json,MetricsTestUtils.METER,MetricsConstant.HS2_SUCCEEDED_QUERIES,"");
    operation.onNewState(OperationState.FINISHED,OperationState.RUNNING);
    json=((CodahaleMetrics)metrics).dumpJson();
    MetricsTestUtils.verifyMetricsJson(json,MetricsTestUtils.METER,MetricsConstant.HS2_SUCCEEDED_QUERIES,"1");
    operation.onNewState(OperationState.ERROR,OperationState.RUNNING);
    json=((CodahaleMetrics)metrics).dumpJson();
    MetricsTestUtils.verifyMetricsJson(json,MetricsTestUtils.METER,MetricsConstant.HS2_SUCCEEDED_QUERIES,"1");
    operation.onNewState(OperationState.CANCELED,OperationState.RUNNING);
    json=((CodahaleMetrics)metrics).dumpJson();
    MetricsTestUtils.verifyMetricsJson(json,MetricsTestUtils.METER,MetricsConstant.HS2_SUCCEEDED_QUERIES,"1");
    operation.onNewState(OperationState.FINISHED,OperationState.RUNNING);
    json=((CodahaleMetrics)metrics).dumpJson();
    MetricsTestUtils.verifyMetricsJson(json,MetricsTestUtils.METER,MetricsConstant.HS2_SUCCEEDED_QUERIES,"2");
  }
  @Test public void testFailedQueriesCount() throws Exception {
    String json=((CodahaleMetrics)metrics).dumpJson();
    MetricsTestUtils.verifyMetricsJson(json,MetricsTestUtils.METER,MetricsConstant.HS2_FAILED_QUERIES,"");
    operation.onNewState(OperationState.ERROR,OperationState.RUNNING);
    json=((CodahaleMetrics)metrics).dumpJson();
    MetricsTestUtils.verifyMetricsJson(json,MetricsTestUtils.METER,MetricsConstant.HS2_FAILED_QUERIES,"1");
    operation.onNewState(OperationState.FINISHED,OperationState.RUNNING);
    json=((CodahaleMetrics)metrics).dumpJson();
    MetricsTestUtils.verifyMetricsJson(json,MetricsTestUtils.METER,MetricsConstant.HS2_FAILED_QUERIES,"1");
    operation.onNewState(OperationState.CANCELED,OperationState.RUNNING);
    json=((CodahaleMetrics)metrics).dumpJson();
    MetricsTestUtils.verifyMetricsJson(json,MetricsTestUtils.METER,MetricsConstant.HS2_FAILED_QUERIES,"1");
    operation.onNewState(OperationState.ERROR,OperationState.RUNNING);
    json=((CodahaleMetrics)metrics).dumpJson();
    MetricsTestUtils.verifyMetricsJson(json,MetricsTestUtils.METER,MetricsConstant.HS2_FAILED_QUERIES,"2");
  }
}
