@RunWith(EasyMockRunner.class) public class SessionStoreBuilderTest {
  @Mock(type=MockType.NICE) private SessionBytesStoreSupplier supplier;
  @Mock(type=MockType.NICE) private SessionStore<Bytes,byte[]> inner;
  private SessionStoreBuilder<String,String> builder;
  @Before public void setUp() throws Exception {
    EasyMock.expect(supplier.get()).andReturn(inner);
    EasyMock.expect(supplier.name()).andReturn("name");
    EasyMock.replay(supplier);
    builder=new SessionStoreBuilder<>(supplier,Serdes.String(),Serdes.String(),new MockTime());
  }
  @Test public void shouldHaveMeteredStoreAsOuterStore(){
    final SessionStore<String,String> store=builder.build();
    assertThat(store,instanceOf(MeteredSessionStore.class));
  }
  @Test public void shouldHaveChangeLoggingStoreByDefault(){
    final SessionStore<String,String> store=builder.build();
    final StateStore next=((WrappedStateStore)store).wrappedStore();
    assertThat(next,instanceOf(ChangeLoggingSessionBytesStore.class));
  }
  @Test public void shouldNotHaveChangeLoggingStoreWhenDisabled(){
    final SessionStore<String,String> store=builder.withLoggingDisabled().build();
    final StateStore next=((WrappedStateStore)store).wrappedStore();
    assertThat(next,CoreMatchers.<StateStore>equalTo(inner));
  }
  @Test public void shouldHaveCachingStoreWhenEnabled(){
    final SessionStore<String,String> store=builder.withCachingEnabled().build();
    final StateStore wrapped=((WrappedStateStore)store).wrappedStore();
    assertThat(store,instanceOf(MeteredSessionStore.class));
    assertThat(wrapped,instanceOf(CachingSessionStore.class));
  }
  @Test public void shouldHaveChangeLoggingStoreWhenLoggingEnabled(){
    final SessionStore<String,String> store=builder.withLoggingEnabled(Collections.<String,String>emptyMap()).build();
    final StateStore wrapped=((WrappedStateStore)store).wrappedStore();
    assertThat(store,instanceOf(MeteredSessionStore.class));
    assertThat(wrapped,instanceOf(ChangeLoggingSessionBytesStore.class));
    assertThat(((WrappedStateStore)wrapped).wrappedStore(),CoreMatchers.<StateStore>equalTo(inner));
  }
  @Test public void shouldHaveCachingAndChangeLoggingWhenBothEnabled(){
    final SessionStore<String,String> store=builder.withLoggingEnabled(Collections.<String,String>emptyMap()).withCachingEnabled().build();
    final WrappedStateStore caching=(WrappedStateStore)((WrappedStateStore)store).wrappedStore();
    final WrappedStateStore changeLogging=(WrappedStateStore)caching.wrappedStore();
    assertThat(store,instanceOf(MeteredSessionStore.class));
    assertThat(caching,instanceOf(CachingSessionStore.class));
    assertThat(changeLogging,instanceOf(ChangeLoggingSessionBytesStore.class));
    assertThat(changeLogging.wrappedStore(),CoreMatchers.<StateStore>equalTo(inner));
  }
  @Test(expected=NullPointerException.class) public void shouldThrowNullPointerIfInnerIsNull(){
    new SessionStoreBuilder<>(null,Serdes.String(),Serdes.String(),new MockTime());
  }
  @Test(expected=NullPointerException.class) public void shouldThrowNullPointerIfKeySerdeIsNull(){
    new SessionStoreBuilder<>(supplier,null,Serdes.String(),new MockTime());
  }
  @Test(expected=NullPointerException.class) public void shouldThrowNullPointerIfValueSerdeIsNull(){
    new SessionStoreBuilder<>(supplier,Serdes.String(),null,new MockTime());
  }
  @Test(expected=NullPointerException.class) public void shouldThrowNullPointerIfTimeIsNull(){
    new SessionStoreBuilder<>(supplier,Serdes.String(),Serdes.String(),null);
  }
  @Test(expected=NullPointerException.class) public void shouldThrowNullPointerIfMetricsScopeIsNull(){
    new SessionStoreBuilder<>(supplier,Serdes.String(),Serdes.String(),new MockTime());
  }
}
