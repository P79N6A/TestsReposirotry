/** 
 * Tests proper behavior of DefaultManagementAgent when {@link MBeanServer#registerMBean(Object,ObjectName)} returns an{@link ObjectInstance} with a different ObjectName
 */
public class DefaultManagementAgentMockTest {
  @Test public void testObjectNameModification() throws JMException {
    MBeanServer mbeanServer=mock(MBeanServer.class);
    ObjectInstance instance=mock(ObjectInstance.class);
    ManagementAgent agent=new DefaultManagementAgent();
    agent.setMBeanServer(mbeanServer);
    Object object="object";
    ObjectName sourceObjectName=new ObjectName("domain","key","value");
    ObjectName registeredObjectName=new ObjectName("domain","key","otherValue");
    when(mbeanServer.isRegistered(sourceObjectName)).thenReturn(false);
    when(mbeanServer.registerMBean(object,sourceObjectName)).thenReturn(instance);
    when(instance.getObjectName()).thenReturn(registeredObjectName);
    when(mbeanServer.isRegistered(registeredObjectName)).thenReturn(true);
    agent.register(object,sourceObjectName);
    assertTrue(agent.isRegistered(sourceObjectName));
    reset(mbeanServer,instance);
    when(mbeanServer.isRegistered(registeredObjectName)).thenReturn(true);
    mbeanServer.unregisterMBean(registeredObjectName);
    when(mbeanServer.isRegistered(sourceObjectName)).thenReturn(false);
    agent.unregister(sourceObjectName);
    assertFalse(agent.isRegistered(sourceObjectName));
  }
  @Test public void testShouldUseHostIPAddressWhenFlagisTrue() throws Exception {
    System.setProperty(JmxSystemPropertyKeys.USE_HOST_IP_ADDRESS,"true");
    System.setProperty(JmxSystemPropertyKeys.CREATE_CONNECTOR,"true");
    CamelContext ctx=new DefaultCamelContext();
    ManagementAgent agent=new DefaultManagementAgent(ctx);
    agent.start();
    assertTrue(agent.getUseHostIPAddress());
  }
  @Test public void shouldUseHostNameWhenFlagisFalse() throws Exception {
    System.setProperty(JmxSystemPropertyKeys.USE_HOST_IP_ADDRESS,"false");
    System.setProperty(JmxSystemPropertyKeys.CREATE_CONNECTOR,"true");
    CamelContext ctx=new DefaultCamelContext();
    ManagementAgent agent=new DefaultManagementAgent(ctx);
    agent.start();
    assertFalse(agent.getUseHostIPAddress());
  }
}
