/** 
 */
public class JmsJettyAsyncTest extends CamelTestSupport {
  private int size=100;
  private int port;
  @Test public void testJmsJettyAsyncTest() throws Exception {
    getMockEndpoint("mock:result").expectedMessageCount(size);
    getMockEndpoint("mock:result").expectsNoDuplicates(body());
    for (int i=0; i < size; i++) {
      template.sendBody("activemq:queue:inbox","" + i);
    }
    assertMockEndpointsSatisfied(2,TimeUnit.MINUTES);
  }
  @Override protected RouteBuilder createRouteBuilder() throws Exception {
    port=AvailablePortFinder.getNextAvailable(8000);
    return new RouteBuilder(){
      @Override public void configure() throws Exception {
        from("activemq:queue:inbox?asyncConsumer=false").to("jetty:http://0.0.0.0:" + port + "/myapp").to("log:result?groupSize=10","mock:result");
        from("jetty:http://0.0.0.0:" + port + "/myapp").delay(100).transform(body().prepend("Bye "));
      }
    }
;
  }
  @Override protected Context createJndiContext() throws Exception {
    JndiContext answer=new JndiContext();
    ConnectionFactory connectionFactory=CamelJmsTestHelper.createConnectionFactory();
    JmsComponent amq=jmsComponentAutoAcknowledge(connectionFactory);
    amq.setCamelContext(context);
    answer.bind("activemq",amq);
    return answer;
  }
}
