@RunWith(FrameworkRunner.class) @CreateLdapServer(transports={@CreateTransport(protocol="LDAP")}) @ApplyLdifFiles("org/apache/camel/component/ldap/LdapRouteTest.ldif") public class LdapRouteTest extends AbstractLdapTestUnit {
  private CamelContext camel;
  private ProducerTemplate template;
  private int port;
  @Before public void setup() throws Exception {
    port=super.getLdapServer().getPort();
    LdapContext ctx=getWiredContext(ldapServer);
    SimpleRegistry reg=new SimpleRegistry();
    reg.put("localhost:" + port,ctx);
    camel=new DefaultCamelContext(reg);
    template=camel.createProducerTemplate();
  }
  @After public void tearDown() throws Exception {
    camel.stop();
  }
  @Test public void testLdapRouteStandard() throws Exception {
    camel.addRoutes(createRouteBuilder("ldap:localhost:" + port + "?base=ou=system"));
    camel.start();
    Endpoint endpoint=camel.getEndpoint("direct:start");
    Exchange exchange=endpoint.createExchange();
    exchange.getIn().setBody("(!(ou=test1))");
    Exchange out=template.send(endpoint,exchange);
    Collection<SearchResult> searchResults=defaultLdapModuleOutAssertions(out);
    assertFalse(contains("uid=test1,ou=test,ou=system",searchResults));
    assertTrue(contains("uid=test2,ou=test,ou=system",searchResults));
    assertTrue(contains("uid=testNoOU,ou=test,ou=system",searchResults));
    assertTrue(contains("uid=tcruise,ou=actors,ou=system",searchResults));
  }
  @Test public void testLdapRouteWithPaging() throws Exception {
    camel.addRoutes(createRouteBuilder("ldap:localhost:" + port + "?base=ou=system&pageSize=5"));
    camel.start();
    Endpoint endpoint=camel.getEndpoint("direct:start");
    Exchange exchange=endpoint.createExchange();
    exchange.getIn().setBody("(objectClass=*)");
    Exchange out=template.send(endpoint,exchange);
    Collection<SearchResult> searchResults=defaultLdapModuleOutAssertions(out);
    assertEquals(16,searchResults.size());
  }
  @Test public void testLdapRouteReturnedAttributes() throws Exception {
    camel.addRoutes(createRouteBuilder("ldap:localhost:" + port + "?base=ou=system&returnedAttributes=uid,cn"));
    camel.start();
    Endpoint endpoint=camel.getEndpoint("direct:start");
    Exchange exchange=endpoint.createExchange();
    exchange.getIn().setBody("(uid=tcruise)");
    Exchange out=template.send(endpoint,exchange);
    Collection<SearchResult> searchResults=defaultLdapModuleOutAssertions(out);
    assertEquals(1,searchResults.size());
    assertTrue(contains("uid=tcruise,ou=actors,ou=system",searchResults));
    Attributes theOneResultAtts=searchResults.iterator().next().getAttributes();
    assertEquals("tcruise",theOneResultAtts.get("uid").get());
    assertEquals("Tom Cruise",theOneResultAtts.get("cn").get());
    assertNull(theOneResultAtts.get("sn"));
  }
  @Test public void testLdapRoutePreserveHeaderAndAttachments() throws Exception {
    camel.addRoutes(createRouteBuilder("ldap:localhost:" + port + "?base=ou=system"));
    camel.start();
    final DataHandler dataHandler=new DataHandler("test","text");
    Exchange out=template.request("direct:start",new Processor(){
      public void process(      Exchange exchange) throws Exception {
        exchange.getIn().setBody("(!(ou=test1))");
        exchange.getIn().setHeader("ldapTest","Camel");
        exchange.getIn().addAttachment("ldapAttachment",dataHandler);
      }
    }
);
    Collection<SearchResult> searchResults=defaultLdapModuleOutAssertions(out);
    assertFalse(contains("uid=test1,ou=test,ou=system",searchResults));
    assertTrue(contains("uid=test2,ou=test,ou=system",searchResults));
    assertTrue(contains("uid=testNoOU,ou=test,ou=system",searchResults));
    assertTrue(contains("uid=tcruise,ou=actors,ou=system",searchResults));
    assertEquals("Camel",out.getOut().getHeader("ldapTest"));
    assertSame(dataHandler,out.getOut().getAttachment("ldapAttachment"));
  }
  @SuppressWarnings("unchecked") private Collection<SearchResult> defaultLdapModuleOutAssertions(  Exchange out){
    assertNotNull(out);
    assertNotNull(out.getOut());
    Collection<SearchResult> data=out.getOut().getBody(Collection.class);
    assertNotNull("out body could not be converted to a Collection - was: " + out.getOut().getBody(),data);
    return data;
  }
  protected boolean contains(  String dn,  Collection<SearchResult> results){
    for (    SearchResult result : results) {
      if (result.getNameInNamespace().equals(dn)) {
        return true;
      }
    }
    return false;
  }
  protected RouteBuilder createRouteBuilder(  final String ldapEndpointUrl) throws Exception {
    return new RouteBuilder(){
      public void configure() throws Exception {
        from("direct:start").to(ldapEndpointUrl);
      }
    }
;
  }
}
