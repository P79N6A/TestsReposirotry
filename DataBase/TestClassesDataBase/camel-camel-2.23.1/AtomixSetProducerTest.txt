public class AtomixSetProducerTest extends AtomixClientTestSupport {
  private static final String SET_NAME=UUID.randomUUID().toString();
  private DistributedSet<Object> set;
  @EndpointInject(uri="direct:start") private FluentProducerTemplate fluent;
  @Override protected Map<String,Component> createComponents(){
    AtomixSetComponent component=new AtomixSetComponent();
    component.setNodes(Collections.singletonList(getReplicaAddress()));
    return Collections.singletonMap("atomix-set",component);
  }
  @Override protected void doPreSetup() throws Exception {
    super.doPreSetup();
    set=getClient().getSet(SET_NAME).join();
  }
  @Override @After public void tearDown() throws Exception {
    set.close();
    super.tearDown();
  }
  @Test public void testAdd() throws Exception {
    final String val1=context().getUuidGenerator().generateUuid();
    final String val2=context().getUuidGenerator().generateUuid();
    Message result;
    result=fluent.clearAll().withHeader(AtomixClientConstants.RESOURCE_ACTION,AtomixSet.Action.ADD).withBody(val1).request(Message.class);
    assertTrue(result.getHeader(AtomixClientConstants.RESOURCE_ACTION_HAS_RESULT,Boolean.class));
    assertTrue(set.contains(val1).join());
    result=fluent.clearAll().withHeader(AtomixClientConstants.RESOURCE_ACTION,AtomixSet.Action.ADD).withBody(val2).request(Message.class);
    assertTrue(result.getHeader(AtomixClientConstants.RESOURCE_ACTION_HAS_RESULT,Boolean.class));
    assertTrue(set.contains(val2).join());
  }
  @Test public void testSizeClearIsEmpty() throws Exception {
    final String val1=context().getUuidGenerator().generateUuid();
    final String val2=context().getUuidGenerator().generateUuid();
    Message result;
    result=fluent.clearAll().withHeader(AtomixClientConstants.RESOURCE_ACTION,AtomixSet.Action.SIZE).request(Message.class);
    assertTrue(result.getHeader(AtomixClientConstants.RESOURCE_ACTION_HAS_RESULT,Boolean.class));
    assertEquals(0,result.getBody(Integer.class).intValue());
    assertEquals(set.size().join(),result.getBody(Integer.class));
    set.add(val1).join();
    set.add(val2).join();
    result=fluent.clearAll().withHeader(AtomixClientConstants.RESOURCE_ACTION,AtomixSet.Action.SIZE).request(Message.class);
    assertTrue(result.getHeader(AtomixClientConstants.RESOURCE_ACTION_HAS_RESULT,Boolean.class));
    assertEquals(set.size().join(),result.getBody(Integer.class));
    result=fluent.clearAll().withHeader(AtomixClientConstants.RESOURCE_ACTION,AtomixSet.Action.IS_EMPTY).request(Message.class);
    assertTrue(result.getHeader(AtomixClientConstants.RESOURCE_ACTION_HAS_RESULT,Boolean.class));
    assertFalse(result.getBody(Boolean.class));
    assertFalse(set.isEmpty().join());
    result=fluent.clearAll().withHeader(AtomixClientConstants.RESOURCE_ACTION,AtomixSet.Action.CLEAR).request(Message.class);
    assertFalse(result.getHeader(AtomixClientConstants.RESOURCE_ACTION_HAS_RESULT,Boolean.class));
    assertEquals(0,set.size().join().intValue());
    result=fluent.clearAll().withHeader(AtomixClientConstants.RESOURCE_ACTION,AtomixSet.Action.IS_EMPTY).request(Message.class);
    assertTrue(result.getHeader(AtomixClientConstants.RESOURCE_ACTION_HAS_RESULT,Boolean.class));
    assertTrue(result.getBody(Boolean.class));
    assertTrue(set.isEmpty().join());
  }
  @Test public void testContains() throws Exception {
    final String val=context().getUuidGenerator().generateUuid();
    Message result;
    result=fluent.clearAll().withHeader(AtomixClientConstants.RESOURCE_ACTION,AtomixSet.Action.CONTAINS).withBody(val).request(Message.class);
    assertTrue(result.getHeader(AtomixClientConstants.RESOURCE_ACTION_HAS_RESULT,Boolean.class));
    assertFalse(result.getBody(Boolean.class));
    assertFalse(set.contains(val).join());
    set.add(val);
    result=fluent.clearAll().withHeader(AtomixClientConstants.RESOURCE_ACTION,AtomixSet.Action.CONTAINS).withBody(val).request(Message.class);
    assertTrue(result.getHeader(AtomixClientConstants.RESOURCE_ACTION_HAS_RESULT,Boolean.class));
    assertTrue(result.getBody(Boolean.class));
    assertTrue(set.contains(val).join());
  }
  @Test public void testRemove() throws Exception {
    final String val1=context().getUuidGenerator().generateUuid();
    final String val2=context().getUuidGenerator().generateUuid();
    set.add(val1).join();
    set.add(val2).join();
    Message result;
    result=fluent.clearAll().withHeader(AtomixClientConstants.RESOURCE_ACTION,AtomixSet.Action.REMOVE).withHeader(AtomixClientConstants.RESOURCE_VALUE,val1).request(Message.class);
    assertTrue(result.getHeader(AtomixClientConstants.RESOURCE_ACTION_HAS_RESULT,Boolean.class));
    assertFalse(set.contains(val1).join());
    assertTrue(set.contains(val2).join());
  }
  @Override protected RoutesBuilder createRouteBuilder() throws Exception {
    return new RouteBuilder(){
      public void configure(){
        from("direct:start").toF("atomix-set:%s",SET_NAME);
      }
    }
;
  }
}
