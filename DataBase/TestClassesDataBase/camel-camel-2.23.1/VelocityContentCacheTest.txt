/** 
 * Unit test the cache when reloading .vm files in the classpath
 */
public class VelocityContentCacheTest extends CamelTestSupport {
  @Before public void setUp() throws Exception {
    super.setUp();
    template.sendBodyAndHeader("file://target/test-classes/org/apache/camel/component/velocity?fileExist=Override","Hello $headers.name",Exchange.FILE_NAME,"hello.vm");
  }
  @Override public boolean useJmx(){
    return true;
  }
  @Test public void testNotCached() throws Exception {
    MockEndpoint mock=getMockEndpoint("mock:result");
    mock.expectedBodiesReceived("Hello London");
    template.sendBodyAndHeader("direct:a","Body","name","London");
    mock.assertIsSatisfied();
    template.sendBodyAndHeader("file://target/test-classes/org/apache/camel/component/velocity?fileExist=Override","Bye $headers.name",Exchange.FILE_NAME,"hello.vm");
    mock.reset();
    mock.expectedBodiesReceived("Bye Paris","Bye World");
    template.sendBodyAndHeader("direct:a","Body","name","Paris");
    template.sendBodyAndHeader("direct:a","Body","name","World");
    mock.assertIsSatisfied();
  }
  @Test public void testCached() throws Exception {
    MockEndpoint mock=getMockEndpoint("mock:result");
    mock.expectedBodiesReceived("Hello London");
    template.sendBodyAndHeader("direct:b","Body","name","London");
    mock.assertIsSatisfied();
    template.sendBodyAndHeader("file://target/test-classes/org/apache/camel/component/velocity?fileExist=Override","Bye $headers.name",Exchange.FILE_NAME,"hello.vm");
    mock.reset();
    mock.expectedBodiesReceived("Hello Paris");
    template.sendBodyAndHeader("direct:b","Body","name","Paris");
    mock.assertIsSatisfied();
  }
  @Test public void testCachedIsDefault() throws Exception {
    MockEndpoint mock=getMockEndpoint("mock:result");
    mock.expectedBodiesReceived("Hello London");
    template.sendBodyAndHeader("direct:c","Body","name","London");
    mock.assertIsSatisfied();
    template.sendBodyAndHeader("file://target/test-classes/org/apache/camel/component/velocity?fileExist=Override","Bye $headers.name",Exchange.FILE_NAME,"hello.vm");
    mock.reset();
    mock.expectedBodiesReceived("Hello Paris");
    template.sendBodyAndHeader("direct:c","Body","name","Paris");
    mock.assertIsSatisfied();
  }
  @Test public void testClearCacheViaJmx() throws Exception {
    MockEndpoint mock=getMockEndpoint("mock:result");
    mock.expectedBodiesReceived("Hello London");
    template.sendBodyAndHeader("direct:b","Body","name","London");
    mock.assertIsSatisfied();
    template.sendBodyAndHeader("file://target/test-classes/org/apache/camel/component/velocity?fileExist=Override","Bye $headers.name",Exchange.FILE_NAME,"hello.vm");
    mock.reset();
    mock.expectedBodiesReceived("Hello Paris");
    template.sendBodyAndHeader("direct:b","Body","name","Paris");
    mock.assertIsSatisfied();
    MBeanServer mbeanServer=context.getManagementStrategy().getManagementAgent().getMBeanServer();
    Set<ObjectName> objNameSet=mbeanServer.queryNames(new ObjectName("org.apache.camel:type=endpoints,name=\"velocity:*contentCache=true*\",*"),null);
    ObjectName managedObjName=new ArrayList<>(objNameSet).get(0);
    mbeanServer.invoke(managedObjName,"clearContentCache",null,null);
    template.sendBodyAndHeader("file://target/test-classes/org/apache/camel/component/velocity?fileExist=Override","Bye $headers.name",Exchange.FILE_NAME,"hello.vm");
    mock.reset();
    mock.expectedBodiesReceived("Bye Paris");
    template.sendBodyAndHeader("direct:b","Body","name","Paris");
    mock.assertIsSatisfied();
    template.sendBodyAndHeader("file://target/test-classes/org/apache/camel/component/velocity?fileExist=Override","Hello $headers.name",Exchange.FILE_NAME,"hello.vm");
    mock.reset();
    mock.expectedBodiesReceived("Bye Paris");
    template.sendBodyAndHeader("direct:b","Body","name","Paris");
    mock.assertIsSatisfied();
  }
  protected RouteBuilder createRouteBuilder() throws Exception {
    return new RouteBuilder(){
      public void configure() throws Exception {
        from("direct:a").to("velocity://org/apache/camel/component/velocity/hello.vm?contentCache=false").to("mock:result");
        from("direct:b").to("velocity://org/apache/camel/component/velocity/hello.vm?contentCache=true").to("mock:result");
        from("direct:c").to("velocity://org/apache/camel/component/velocity/hello.vm").to("mock:result");
      }
    }
;
  }
}
