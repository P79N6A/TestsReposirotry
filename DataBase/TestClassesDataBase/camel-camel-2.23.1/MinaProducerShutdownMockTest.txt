/** 
 * Unit testing for using a MinaProducer that it can shutdown properly (CAMEL-395)
 */
public class MinaProducerShutdownMockTest extends BaseMinaTest {
  @Test public void testProducerShutdownTestingWithMock() throws Exception {
    MockEndpoint mock=getMockEndpoint("mock:result");
    mock.expectedBodiesReceived("Hello World");
    SocketConnector mockConnector=mock(SocketConnector.class);
    Endpoint endpoint=context.getEndpoint("mina:tcp://localhost:{{port}}?textline=true&sync=false");
    Exchange exchange=endpoint.createExchange();
    Producer producer=endpoint.createProducer();
    producer.start();
    exchange.getIn().setBody("Hello World");
    producer.process(exchange);
    Field field=producer.getClass().getDeclaredField("connector");
    field.setAccessible(true);
    field.set(producer,mockConnector);
    producer.stop();
    verify(mockConnector).setWorkerTimeout(0);
    assertMockEndpointsSatisfied();
  }
  protected RouteBuilder createRouteBuilder(){
    return new RouteBuilder(){
      public void configure(){
        from("mina:tcp://localhost:{{port}}?textline=true&sync=false").to("mock:result");
      }
    }
;
  }
}
