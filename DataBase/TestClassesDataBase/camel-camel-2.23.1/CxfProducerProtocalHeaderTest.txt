/** 
 */
public class CxfProducerProtocalHeaderTest extends CamelTestSupport {
  private static int port=AvailablePortFinder.getNextAvailable();
  private static final String RESPONSE="<soap:Envelope xmlns:soap=\"http://schemas.xmlsoap.org/soap/envelope/\">" + "<soap:Body><ns1:echoResponse xmlns:ns1=\"http://cxf.component.camel.apache.org/\">" + "<return xmlns=\"http://cxf.component.camel.apache.org/\">echo Hello World!</return>"+ "</ns1:echoResponse></soap:Body></soap:Envelope>";
  @Override public boolean isCreateCamelContextPerClass(){
    return true;
  }
  protected RouteBuilder createRouteBuilder(){
    return new RouteBuilder(){
      public void configure(){
        from("jetty:http://localhost:" + port + "/CxfProducerProtocalHeaderTest/user").process(new Processor(){
          public void process(          Exchange exchange) throws Exception {
            assertNull("We should not get this header",exchange.getIn().getHeader("CamelCxfTest"));
            assertNull("We should not get this header",exchange.getIn().getHeader("Transfer-Encoding"));
            exchange.getOut().setHeader("Content-Type","text/xml");
            exchange.getOut().setHeader(Exchange.HTTP_RESPONSE_CODE,200);
            exchange.getOut().setBody(RESPONSE);
          }
        }
);
      }
    }
;
  }
  private Exchange sendSimpleMessage(  String endpointUri){
    Exchange exchange=template.send(endpointUri,new Processor(){
      public void process(      final Exchange exchange){
        final List<String> params=new ArrayList<>();
        params.add("Hello World!");
        exchange.getIn().setBody(params);
        exchange.getIn().setHeader(CxfConstants.OPERATION_NAME,"echo");
        exchange.getIn().setHeader("CamelCxfTest","\"test\"");
        exchange.getIn().setHeader("SOAPAction","\"test\"");
        exchange.getIn().setHeader("Transfer-Encoding","chunked");
      }
    }
);
    return exchange;
  }
  @Test public void testSendMessage(){
    Exchange exchange=sendSimpleMessage("cxf://http://localhost:" + port + "/CxfProducerProtocalHeaderTest/user"+ "?serviceClass=org.apache.camel.component.cxf.HelloService");
    org.apache.camel.Message out=exchange.getOut();
    String result=out.getBody(String.class);
    assertEquals("reply body on Camel","echo " + "Hello World!",result);
  }
}
