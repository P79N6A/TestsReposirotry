public class DefaultErrorHandlerOnPrepareTest extends ContextTestSupport {
  @Test public void testDefaultErrorHandlerOnPrepare() throws Exception {
    Exchange out=template.request("direct:start",new Processor(){
      @Override public void process(      Exchange exchange) throws Exception {
        exchange.getIn().setBody("Hello World");
      }
    }
);
    assertNotNull(out);
    assertTrue("Should be failed",out.isFailed());
    assertIsInstanceOf(IllegalArgumentException.class,out.getException());
    assertEquals("Forced",out.getIn().getHeader("FailedBecause"));
  }
  @Override protected RouteBuilder createRouteBuilder() throws Exception {
    return new RouteBuilder(){
      @Override public void configure() throws Exception {
        errorHandler(defaultErrorHandler().onPrepareFailure(new MyPrepareProcessor()));
        from("direct:start").log("Incoming ${body}").throwException(new IllegalArgumentException("Forced"));
      }
    }
;
  }
public static class MyPrepareProcessor implements Processor {
    @Override public void process(    Exchange exchange) throws Exception {
      Exception cause=exchange.getProperty(Exchange.EXCEPTION_CAUGHT,Exception.class);
      exchange.getIn().setHeader("FailedBecause",cause.getMessage());
    }
  }
}
