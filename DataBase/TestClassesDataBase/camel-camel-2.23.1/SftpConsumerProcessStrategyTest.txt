public class SftpConsumerProcessStrategyTest extends SftpServerTestSupport {
  private MyStrategy myStrategy;
  @Override public boolean isUseRouteBuilder(){
    return false;
  }
  @Override protected JndiRegistry createRegistry() throws Exception {
    JndiRegistry jndi=super.createRegistry();
    myStrategy=new MyStrategy();
    jndi.bind("myStrategy",myStrategy);
    return jndi;
  }
  @Test public void testSftpConsume() throws Exception {
    if (!canTest()) {
      return;
    }
    template.sendBodyAndHeader("file://" + FTP_ROOT_DIR,"Hello World",Exchange.FILE_NAME,"hello.txt");
    String out=consumer.receiveBody("sftp://localhost:" + getPort() + "/"+ FTP_ROOT_DIR+ "?username=admin&password=admin&processStrategy=#myStrategy",5000,String.class);
    assertNotNull(out);
    assertTrue(out.startsWith("Hello World"));
    assertEquals("CustomProcessStrategy should have been invoked 1 times",1,myStrategy.getInvoked());
  }
private static class MyStrategy implements GenericFileProcessStrategy {
    private volatile int invoked;
    @Override public void prepareOnStartup(    GenericFileOperations operations,    GenericFileEndpoint endpoint) throws Exception {
    }
    @Override public boolean begin(    GenericFileOperations operations,    GenericFileEndpoint endpoint,    Exchange exchange,    GenericFile file) throws Exception {
      return true;
    }
    @Override public void abort(    GenericFileOperations operations,    GenericFileEndpoint endpoint,    Exchange exchange,    GenericFile file) throws Exception {
    }
    @Override public void commit(    GenericFileOperations operations,    GenericFileEndpoint endpoint,    Exchange exchange,    GenericFile file) throws Exception {
      invoked++;
    }
    @Override public void rollback(    GenericFileOperations operations,    GenericFileEndpoint endpoint,    Exchange exchange,    GenericFile file) throws Exception {
    }
    int getInvoked(){
      return invoked;
    }
  }
}
