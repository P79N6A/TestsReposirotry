/** 
 * @version 
 */
public class XmppMultiUserChatTest extends CamelTestSupport {
  protected MockEndpoint consumerEndpoint;
  protected String body1="the first message";
  protected String body2="the second message";
  private EmbeddedXmppTestServer embeddedXmppTestServer;
  @Override protected JndiRegistry createRegistry() throws Exception {
    JndiRegistry registry=super.createRegistry();
    embeddedXmppTestServer.bindSSLContextTo(registry);
    return registry;
  }
  @Test public void testXmppChat() throws Exception {
    consumerEndpoint=context.getEndpoint("mock:out",MockEndpoint.class);
    consumerEndpoint.expectedBodiesReceived(body1,body2);
    template.sendBody("direct:toProducer",body1);
    Thread.sleep(50);
    template.sendBody("direct:toProducer",body2);
    consumerEndpoint.assertIsSatisfied();
  }
  protected RouteBuilder createRouteBuilder() throws Exception {
    return new RouteBuilder(){
      public void configure() throws Exception {
        from("direct:toProducer").to(getProducerUri());
        from(getConsumerUri()).to("mock:out");
      }
    }
;
  }
  protected String getProducerUri(){
    return "xmpp://localhost:" + embeddedXmppTestServer.getXmppPort() + "/?connectionConfig=#customConnectionConfig&room=camel-test&user=camel_producer@apache.camel&password=secret&nickname=camel_producer";
  }
  protected String getConsumerUri(){
    return "xmpp://localhost:" + embeddedXmppTestServer.getXmppPort() + "/?connectionConfig=#customConnectionConfig&room=camel-test@conference.apache.camel&user=camel_consumer@apache.camel&password=secret&nickname=camel_consumer";
  }
  @Override public void doPreSetup() throws Exception {
    embeddedXmppTestServer=new EmbeddedXmppTestServer();
  }
  @Override @After public void tearDown() throws Exception {
    super.tearDown();
    embeddedXmppTestServer.stop();
  }
}
