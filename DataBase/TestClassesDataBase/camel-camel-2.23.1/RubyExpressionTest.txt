/** 
 * Tests a routing expression using Ruby
 */
@Ignore("May fail on CI server on JDK 1.6") public class RubyExpressionTest extends CamelTestSupport {
  @Test public void testSendMatchingMessage() throws Exception {
    getMockEndpoint("mock:result").expectedMessageCount(1);
    getMockEndpoint("mock:unmatched").expectedMessageCount(0);
    Map<String,Object> headers=new HashMap<>();
    headers.put("foo","bar");
    sendBody("direct:start","hello",headers);
    assertMockEndpointsSatisfied();
  }
  @Test public void testSendNonMatchingMessage() throws Exception {
    getMockEndpoint("mock:result").expectedMessageCount(0);
    getMockEndpoint("mock:unmatched").expectedMessageCount(1);
    Map<String,Object> headers=new HashMap<>();
    headers.put("foo","foo");
    sendBody("direct:start","hello",headers);
    assertMockEndpointsSatisfied();
  }
  protected RouteBuilder createRouteBuilder() throws Exception {
    return new RouteBuilder(){
      public void configure() throws Exception {
        from("direct:start").choice().when().ruby("$request.headers['foo'] == 'bar'").to("mock:result").otherwise().to("mock:unmatched");
      }
    }
;
  }
}
