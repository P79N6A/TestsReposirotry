/** 
 * @version
 */
@Ignore("Fails with Address already in use") public class SpringJettyNoConnectionRedeliveryTest extends CamelSpringTestSupport {
  @Override protected AbstractXmlApplicationContext createApplicationContext(){
    return new ClassPathXmlApplicationContext("org/apache/camel/component/jetty/jetty-noconnection-redelivery.xml");
  }
  @Test public void testConnectionOk() throws Exception {
    String reply=template.requestBody("direct:start","World",String.class);
    assertEquals("Bye World",reply);
  }
  @Test public void testConnectionNotOk() throws Exception {
    context.stopRoute("jetty");
    Exchange exchange=template.request("direct:start",new Processor(){
      public void process(      Exchange exchange) throws Exception {
        exchange.getIn().setBody("Moon");
      }
    }
);
    assertTrue(exchange.isFailed());
    ConnectException ce=exchange.getException(ConnectException.class);
    assertNotNull(ce);
    assertEquals(true,exchange.getIn().getHeader(Exchange.REDELIVERED));
    assertEquals(4,exchange.getIn().getHeader(Exchange.REDELIVERY_COUNTER));
  }
}
