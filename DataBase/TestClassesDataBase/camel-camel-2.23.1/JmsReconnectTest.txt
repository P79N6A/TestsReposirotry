/** 
 * Test for issue CAMEL-3193. Camel should support reconnects in case of connection loss to jms server. After reconnect Temporary destinations have to be recreated as they may become invalid
 */
public class JmsReconnectTest {
public interface MyService {
    String echo(    String st);
  }
private static final class EchoServiceImpl implements MyService {
    public String echo(    String st){
      return st;
    }
  }
  @Produce(uri="direct:test") MyService proxy;
  /** 
 * This test is disabled as the problem can currently not be reproduced using ActiveMQ. TODO Find a way to recreate the problem with ActiveMQ and fully automate the test
 * @throws Exception
 */
  @Ignore @Test public void testRequestReply() throws Exception {
    BrokerService broker=new BrokerService();
    broker.addConnector("tcp://localhost:61616");
    broker.setPersistent(false);
    broker.setTimeBeforePurgeTempDestinations(1000);
    broker.start();
    DefaultCamelContext context=new DefaultCamelContext();
    JmsComponent jmsComponent=new JmsComponent();
    ActiveMQConnectionFactory connectionFactory=new ActiveMQConnectionFactory();
    connectionFactory.setBrokerURL("failover://(tcp://localhost:61616)?maxReconnectAttempts=1");
    jmsComponent.setConnectionFactory(connectionFactory);
    jmsComponent.setRequestTimeout(1000);
    jmsComponent.setReceiveTimeout(1000);
    context.addComponent("jms",jmsComponent);
    context.addRoutes(new RouteBuilder(){
      @Override public void configure() throws Exception {
        from("jms:testqueue").bean(new EchoServiceImpl());
        from("direct:test").to("jms:testqueue");
      }
    }
);
    CamelBeanPostProcessor processor=new CamelBeanPostProcessor();
    processor.setCamelContext(context);
    processor.postProcessBeforeInitialization(this,"this");
    context.start();
    String ret=proxy.echo("test");
    Assert.assertEquals("test",ret);
    broker.stop();
    Thread.sleep(5000);
    System.in.read();
    broker.start(true);
    String ret2=proxy.echo("test");
    Assert.assertEquals("test",ret2);
  }
}
