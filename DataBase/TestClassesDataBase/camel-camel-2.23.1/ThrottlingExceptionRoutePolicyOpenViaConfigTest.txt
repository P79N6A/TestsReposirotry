public class ThrottlingExceptionRoutePolicyOpenViaConfigTest extends ContextTestSupport {
  private String url="seda:foo?concurrentConsumers=20";
  private MockEndpoint result;
  private int size=5;
  private ThrottlingExceptionRoutePolicy policy;
  @Override @Before public void setUp() throws Exception {
    this.createPolicy();
    super.setUp();
    this.setUseRouteBuilder(true);
    result=getMockEndpoint("mock:result");
    context.getShutdownStrategy().setTimeout(1);
  }
  protected void createPolicy(){
    int threshold=2;
    long failureWindow=30;
    long halfOpenAfter=100;
    boolean keepOpen=false;
    policy=new ThrottlingExceptionRoutePolicy(threshold,failureWindow,halfOpenAfter,null,keepOpen);
  }
  @Test public void testThrottlingRoutePolicyStartWithAlwaysOpenOffThenToggle() throws Exception {
    for (int i=0; i < size; i++) {
      template.sendBody(url,"MessageRound1 " + i);
      Thread.sleep(3);
    }
    result.expectedMessageCount(size);
    result.setResultWaitTime(1000);
    assertMockEndpointsSatisfied();
    policy.setKeepOpen(true);
    template.sendBody(url,"MessageTrigger");
    Thread.sleep(500);
    for (int i=0; i < size; i++) {
      template.sendBody(url,"MessageRound2 " + i);
      Thread.sleep(3);
    }
    Thread.sleep(500);
    result.expectedMessageCount(size + 1);
    result.setResultWaitTime(1000);
    assertMockEndpointsSatisfied();
    policy.setKeepOpen(false);
    result.expectedMessageCount(size * 2 + 1);
    result.setResultWaitTime(1000);
    assertMockEndpointsSatisfied();
  }
  @Override protected RouteBuilder createRouteBuilder() throws Exception {
    return new RouteBuilder(){
      @Override public void configure() throws Exception {
        from(url).routePolicy(policy).log("${body}").to("log:foo?groupSize=10").to("mock:result");
      }
    }
;
  }
}
