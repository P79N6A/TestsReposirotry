public class JGroupsProducerTest extends CamelTestSupport {
  static final String CLUSTER_NAME="CLUSTER_NAME";
  static final String MESSAGE="MESSAGE";
  JChannel channel;
  Object messageReceived;
  @Override protected RouteBuilder createRouteBuilder() throws Exception {
    return new RouteBuilder(){
      @Override public void configure() throws Exception {
        from("direct:start").to("jgroups:" + CLUSTER_NAME);
      }
    }
;
  }
  @Override protected void doPreSetup() throws Exception {
    super.doPreSetup();
    channel=new JChannel();
    channel.setReceiver(new ReceiverAdapter(){
      @Override public void receive(      Message msg){
        messageReceived=msg.getObject();
      }
    }
);
    channel.connect(CLUSTER_NAME);
  }
  @Override @After public void tearDown() throws Exception {
    channel.close();
    super.tearDown();
  }
  @Test public void shouldReceiveMulticastedBody() throws Exception {
    sendBody("direct:start",MESSAGE);
    waitForMulticastChannel(5);
    assertEquals(MESSAGE,messageReceived);
  }
  @Test public void shouldNotSendNullMessage() throws Exception {
    sendBody("direct:start",null);
    waitForMulticastChannel(2);
    assertNull(messageReceived);
  }
  private void waitForMulticastChannel(  int attempts) throws InterruptedException {
    while (messageReceived == null && attempts > 0) {
      TimeUnit.SECONDS.sleep(1);
      attempts--;
    }
  }
}
