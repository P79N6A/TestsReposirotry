/** 
 * Test that verifies JMX is enabled by default.
 * @version 
 */
public class DefaultJMXAgentTest extends SpringTestSupport {
  protected MBeanServerConnection mbsc;
  @Override protected boolean useJmx(){
    return true;
  }
  @Override @Before public void setUp() throws Exception {
    releaseMBeanServers();
    super.setUp();
    await().atMost(3,TimeUnit.SECONDS).ignoreExceptions().until(() -> {
      mbsc=getMBeanConnection();
      return true;
    }
);
  }
  @Override @After public void tearDown() throws Exception {
    try {
      releaseMBeanServers();
    }
  finally {
      mbsc=null;
      super.tearDown();
    }
  }
  protected void releaseMBeanServers(){
    List<MBeanServer> servers=MBeanServerFactory.findMBeanServer(null);
    for (    MBeanServer server : servers) {
      MBeanServerFactory.releaseMBeanServer(server);
    }
  }
  @Test public void testQueryMbeans() throws Exception {
    int before=mbsc.queryNames(new ObjectName("org.apache.camel" + ":type=consumers,*"),null).size();
    context.startRoute("foo");
    int after=mbsc.queryNames(new ObjectName("org.apache.camel" + ":type=consumers,*"),null).size();
    assertTrue("Should have added consumer to JMX, before: " + before + ", after: "+ after,after > before);
  }
  @Override protected AbstractXmlApplicationContext createApplicationContext(){
    return new ClassPathXmlApplicationContext("org/apache/camel/spring/defaultJmxConfig.xml");
  }
  protected MBeanServerConnection getMBeanConnection() throws Exception {
    if (mbsc == null) {
      mbsc=ManagementFactory.getPlatformMBeanServer();
    }
    return mbsc;
  }
}
