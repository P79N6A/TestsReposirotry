@RunWith(Arquillian.class) public class AdvisedRouteTest {
  @Inject @Uri("direct:inbound") private ProducerTemplate inbound;
  @Inject @Uri("mock:outbound") private MockEndpoint outbound;
  @Produces @ApplicationScoped @Named("properties") private static PropertiesComponent configuration(){
    Properties properties=new Properties();
    properties.put("from","inbound");
    properties.put("to","direct:outbound");
    properties.put("header.message","n/a");
    PropertiesComponent component=new PropertiesComponent();
    component.setInitialProperties(properties);
    return component;
  }
  @Deployment public static Archive<?> deployment(){
    return ShrinkWrap.create(JavaArchive.class).addPackage(CdiCamelExtension.class.getPackage()).addClasses(ManualStartupCamelContext.class,PropertyEndpointRoute.class).addAsManifestResource(EmptyAsset.INSTANCE,"beans.xml");
  }
  @Test @InSequence(1) public void adviseCamelContext(  ModelCamelContext context) throws Exception {
    context.getRouteDefinition("route").adviceWith(context,new AdviceWithRouteBuilder(){
      @Override public void configure(){
        interceptSendToEndpoint("{{to}}").skipSendToOriginalEndpoint().to("mock:outbound");
      }
    }
);
    context.startAllRoutes();
  }
  @Test @InSequence(2) public void sendMessageToInbound() throws InterruptedException {
    outbound.expectedMessageCount(1);
    outbound.expectedBodiesReceived("test");
    outbound.expectedHeaderReceived("header","n/a");
    inbound.sendBody("test");
    assertIsSatisfied(2L,TimeUnit.SECONDS,outbound);
  }
}
