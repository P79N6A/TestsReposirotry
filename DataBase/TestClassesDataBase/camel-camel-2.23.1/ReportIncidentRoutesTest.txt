/** 
 * Unit test of our routes
 */
public class ReportIncidentRoutesTest {
  private static String url;
  protected Main main;
  @BeforeClass public static void setupFreePort() throws Exception {
    int port=AvailablePortFinder.getNextAvailable();
    String s="proxy.port=" + port;
    int port2=AvailablePortFinder.getNextAvailable();
    String s2="real.port=" + port2;
    File custom=new File("target/custom.properties");
    FileOutputStream fos=new FileOutputStream(custom);
    fos.write(s.getBytes());
    fos.write("\n".getBytes());
    fos.write(s2.getBytes());
    fos.close();
    url="http://localhost:" + port + "/camel-example-cxf-proxy/webservices/incident";
  }
  @AfterClass public static void cleanup(){
    File custom=new File("target/custom.properties");
    FileUtil.deleteFile(custom);
  }
  protected void startCamel() throws Exception {
    if (!"true".equalsIgnoreCase(System.getProperty("skipStartingCamelContext"))) {
      main=new Main();
      main.setApplicationContextUri("META-INF/spring/camel-config.xml");
      main.start();
    }
 else {
      System.out.println("Skipping starting CamelContext as system property skipStartingCamelContext is set to be true.");
    }
  }
  protected void stopCamel() throws Exception {
    if (main != null) {
      main.stop();
    }
  }
  protected static ReportIncidentEndpoint createCXFClient(){
    JaxWsProxyFactoryBean factory=new JaxWsProxyFactoryBean();
    factory.setServiceClass(ReportIncidentEndpoint.class);
    factory.setAddress(url);
    return (ReportIncidentEndpoint)factory.create();
  }
  @Test public void testReportIncident() throws Exception {
    startCamel();
    runTest();
    stopCamel();
  }
  protected void runTest() throws Exception {
    InputReportIncident input=new InputReportIncident();
    input.setIncidentId("123");
    input.setIncidentDate("2008-08-18");
    input.setGivenName("Claus");
    input.setFamilyName("Ibsen");
    input.setSummary("Bla");
    input.setDetails("Bla bla");
    input.setEmail("davsclaus@apache.org");
    input.setPhone("0045 2962 7576");
    ReportIncidentEndpoint client=createCXFClient();
    OutputReportIncident out=client.reportIncident(input);
    Assert.assertEquals("OK;456",out.getCode());
  }
}
