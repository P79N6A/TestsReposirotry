/** 
 * @version 
 */
public class NettyTransferExchangeOptionTest extends BaseNettyTest {
  @Test public void testNettyTransferExchangeOptionWithoutException() throws Exception {
    Exchange exchange=sendExchange(false);
    assertExchange(exchange,false);
  }
  @Test public void testNettyTransferExchangeOptionWithException() throws Exception {
    Exchange exchange=sendExchange(true);
    assertExchange(exchange,true);
  }
  private Exchange sendExchange(  boolean setException) throws Exception {
    Endpoint endpoint=context.getEndpoint("netty4:tcp://localhost:{{port}}?transferExchange=true");
    Exchange exchange=endpoint.createExchange();
    Message message=exchange.getIn();
    message.setBody("Hello!");
    message.setHeader("cheese","feta");
    exchange.setProperty("ham","old");
    exchange.setProperty("setException",setException);
    Producer producer=endpoint.createProducer();
    producer.start();
    try {
      producer.process(exchange);
    }
  finally {
      producer.stop();
    }
    return exchange;
  }
  private void assertExchange(  Exchange exchange,  boolean hasFault){
    if (!hasFault) {
      Message out=exchange.getOut();
      assertNotNull(out);
      assertFalse(out.isFault());
      assertEquals("Goodbye!",out.getBody());
      assertEquals("cheddar",out.getHeader("cheese"));
    }
 else {
      Message fault=exchange.getOut();
      assertNotNull(fault);
      assertTrue(fault.isFault());
      assertNotNull(fault.getBody());
      assertTrue("Should get the InterrupteException exception",fault.getBody() instanceof InterruptedException);
      assertEquals("nihao",fault.getHeader("hello"));
    }
    Message in=exchange.getIn();
    assertNotNull(in);
    assertEquals("Hello!",in.getBody());
    assertEquals("feta",in.getHeader("cheese"));
    assertEquals("fresh",exchange.getProperty("salami"));
    assertNull(exchange.getProperty("Charset"));
  }
  protected RouteBuilder createRouteBuilder(){
    return new RouteBuilder(){
      public void configure(){
        from("netty4:tcp://localhost:{{port}}?transferExchange=true").process(new Processor(){
          public void process(          Exchange e) throws InterruptedException {
            assertNotNull(e.getIn().getBody());
            assertNotNull(e.getIn().getHeaders());
            assertNotNull(e.getProperties());
            assertEquals("Hello!",e.getIn().getBody());
            assertEquals("feta",e.getIn().getHeader("cheese"));
            assertEquals("old",e.getProperty("ham"));
            assertEquals(ExchangePattern.InOut,e.getPattern());
            Boolean setException=(Boolean)e.getProperty("setException");
            if (setException) {
              e.getOut().setFault(true);
              e.getOut().setBody(new InterruptedException());
              e.getOut().setHeader("hello","nihao");
            }
 else {
              e.getOut().setBody("Goodbye!");
              e.getOut().setHeader("cheese","cheddar");
            }
            e.setProperty("salami","fresh");
            e.setProperty("Charset",Charset.defaultCharset());
          }
        }
);
      }
    }
;
  }
}
