/** 
 * Unit test to test what happens if remote server closes session but doesn't reply
 */
public class MinaNoResponseFromServerTest extends BaseMinaTest {
  @Test public void testNoResponse() throws Exception {
    MockEndpoint mock=getMockEndpoint("mock:result");
    mock.expectedMessageCount(0);
    try {
      template.requestBody("mina:tcp://localhost:{{port}}?sync=true&codec=#myCodec","Hello World");
      fail("Should throw a CamelExchangeException");
    }
 catch (    RuntimeCamelException e) {
      assertIsInstanceOf(CamelExchangeException.class,e.getCause());
      assertTrue(e.getCause().getMessage().startsWith("No response received from remote server"));
    }
    mock.assertIsSatisfied();
  }
  protected JndiRegistry createRegistry() throws Exception {
    JndiRegistry jndi=super.createRegistry();
    jndi.bind("myCodec",new MyCodec());
    return jndi;
  }
  protected RouteBuilder createRouteBuilder() throws Exception {
    return new RouteBuilder(){
      public void configure() throws Exception {
        from("mina:tcp://localhost:{{port}}?sync=true&codec=#myCodec").transform(constant("Bye World")).to("mock:result");
      }
    }
;
  }
private static class MyCodec implements ProtocolCodecFactory {
    public ProtocolEncoder getEncoder() throws Exception {
      return new ProtocolEncoder(){
        public void encode(        IoSession ioSession,        Object message,        ProtocolEncoderOutput out) throws Exception {
          ioSession.close();
        }
        public void dispose(        IoSession ioSession) throws Exception {
        }
      }
;
    }
    public ProtocolDecoder getDecoder() throws Exception {
      return new ProtocolDecoder(){
        public void decode(        IoSession ioSession,        ByteBuffer in,        ProtocolDecoderOutput out) throws Exception {
          ioSession.close();
        }
        public void finishDecode(        IoSession ioSession,        ProtocolDecoderOutput protocolDecoderOutput) throws Exception {
        }
        public void dispose(        IoSession ioSession) throws Exception {
        }
      }
;
    }
  }
}
