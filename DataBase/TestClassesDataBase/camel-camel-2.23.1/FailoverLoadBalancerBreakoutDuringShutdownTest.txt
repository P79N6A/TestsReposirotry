/** 
 * Tests that the failover load balancer will break out if CamelContext is shutting down.
 */
public class FailoverLoadBalancerBreakoutDuringShutdownTest extends ContextTestSupport {
  @Test public void testFailover() throws Exception {
    getMockEndpoint("mock:before").expectedMessageCount(1);
    getMockEndpoint("mock:after").expectedMessageCount(0);
    template.sendBody("seda:start","Hello World");
    assertMockEndpointsSatisfied();
    StopWatch watch=new StopWatch();
    context.getShutdownStrategy().setTimeout(1);
    context.stop();
    assertTrue("Should take less than 5 seconds, was " + watch.taken(),watch.taken() < 5000);
  }
  @Override protected RouteBuilder createRouteBuilder() throws Exception {
    return new RouteBuilder(){
      @Override public void configure() throws Exception {
        from("seda:start").to("mock:before").loadBalance().failover(-1,false,true).to("direct:a").to("direct:b").end().to("mock:after");
        from("direct:a").process(new Processor(){
          public void process(          Exchange exchange) throws Exception {
            throw new IllegalArgumentException("Forced");
          }
        }
);
        from("direct:b").process(new Processor(){
          public void process(          Exchange exchange) throws Exception {
            throw new IllegalArgumentException("Forced");
          }
        }
);
      }
    }
;
  }
}
