/** 
 * @version 
 */
@Ignore("This test is flaky on CI server") public class XmppRouteChatTest extends CamelTestSupport {
  protected MockEndpoint consumerEndpoint;
  protected MockEndpoint producerEndpoint;
  protected String body1="the first message";
  protected String body2="the second message";
  private EmbeddedXmppTestServer embeddedXmppTestServer;
  @Override protected JndiRegistry createRegistry() throws Exception {
    JndiRegistry registry=super.createRegistry();
    embeddedXmppTestServer.bindSSLContextTo(registry);
    return registry;
  }
  @Test public void testXmppChat() throws Exception {
    consumerEndpoint=context.getEndpoint("mock:out1",MockEndpoint.class);
    producerEndpoint=context.getEndpoint("mock:out2",MockEndpoint.class);
    consumerEndpoint.expectedBodiesReceived(body1,body2);
    producerEndpoint.expectedBodiesReceived(body1,body2);
    template.sendBody("direct:toConsumer",body1);
    Thread.sleep(50);
    template.sendBody("direct:toConsumer",body2);
    template.sendBody("direct:toProducer",body1);
    Thread.sleep(50);
    template.sendBody("direct:toProducer",body2);
    consumerEndpoint.assertIsSatisfied();
    producerEndpoint.assertIsSatisfied();
  }
  protected RouteBuilder createRouteBuilder() throws Exception {
    return new RouteBuilder(){
      public void configure() throws Exception {
        from("direct:toConsumer").to(getConsumerUri());
        from("direct:toProducer").to(getProducerUri());
        from(getConsumerUri()).to("mock:out1");
        from(getProducerUri()).to("mock:out2");
      }
    }
;
  }
  protected String getProducerUri(){
    return "xmpp://localhost:" + embeddedXmppTestServer.getXmppPort() + "/camel_producer@apache.camel?connectionConfig=#customConnectionConfig&room=camel-test-producer@conference.apache.camel&user=camel_producer&password=secret&serviceName=apache.camel";
  }
  protected String getConsumerUri(){
    return "xmpp://localhost:" + embeddedXmppTestServer.getXmppPort() + "/camel_consumer@apache.camel?connectionConfig=#customConnectionConfig&room=camel-test-consumer@conference.apache.camel&user=camel_consumer&password=secret&serviceName=apache.camel";
  }
  @Override public void doPreSetup() throws Exception {
    embeddedXmppTestServer=new EmbeddedXmppTestServer();
  }
  @Override @After public void tearDown() throws Exception {
    super.tearDown();
    embeddedXmppTestServer.stop();
  }
}
