/** 
 * Unite test for  {@link CassandraAggregationRepository}
 */
public class CassandraAggregationSerializedHeadersTest extends CamelTestSupport {
  private Cluster cluster;
  private CassandraAggregationRepository aggregationRepository;
  @Override protected void doPreSetup() throws Exception {
    assumeTrue("Skipping test running in CI server - Fails sometimes on CI server with address already in use",System.getenv("BUILD_ID") == null);
    CassandraUnitUtils.startEmbeddedCassandra();
    cluster=CassandraUnitUtils.cassandraCluster();
    Session rootSession=cluster.connect();
    CassandraUnitUtils.loadCQLDataSet(rootSession,"NamedAggregationDataSet.cql");
    rootSession.close();
    aggregationRepository=new NamedCassandraAggregationRepository(cluster,CassandraUnitUtils.KEYSPACE,"ID");
    aggregationRepository.setTable("NAMED_CAMEL_AGGREGATION");
    aggregationRepository.setAllowSerializedHeaders(true);
    aggregationRepository.start();
    super.doPreSetup();
  }
  @Override @After public void tearDown() throws Exception {
    super.tearDown();
    aggregationRepository.stop();
    cluster.close();
    try {
      CassandraUnitUtils.cleanEmbeddedCassandra();
    }
 catch (    Throwable e) {
    }
  }
  @Override protected RouteBuilder createRouteBuilder() throws Exception {
    return new RouteBuilder(){
      @Override public void configure() throws Exception {
        AggregationStrategy aggregationStrategy=new AggregationStrategy(){
          @Override public Exchange aggregate(          Exchange oldExchange,          Exchange newExchange){
            if (oldExchange == null) {
              return newExchange;
            }
            String oldBody=oldExchange.getIn().getBody(String.class);
            String newBody=newExchange.getIn().getBody(String.class);
            oldExchange.getIn().setBody(oldBody + "," + newBody);
            return oldExchange;
          }
        }
;
        from("direct:input").aggregate(header("aggregationId"),aggregationStrategy).completionSize(3).completionTimeout(3000L).aggregationRepository(aggregationRepository).to("mock:output");
      }
    }
;
  }
  private void send(  HeaderDto aggregationId,  String body){
    super.template.sendBodyAndHeader("direct:input",body,"aggregationId",aggregationId);
  }
  @Test public void testAggregationRoute() throws Exception {
    MockEndpoint mockOutput=getMockEndpoint("mock:output");
    mockOutput.expectedMessageCount(2);
    mockOutput.expectedBodiesReceivedInAnyOrder("A,C,E","B,D");
    HeaderDto dto1=new HeaderDto("org","company",1);
    HeaderDto dto2=new HeaderDto("org","company",2);
    send(dto1,"A");
    send(dto2,"B");
    send(dto1,"C");
    send(dto2,"D");
    send(dto1,"E");
    mockOutput.assertIsSatisfied(4000L);
  }
}
