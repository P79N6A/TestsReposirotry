/** 
 * Concurrency test of XQuery using classpath resources (to).
 */
public class XQueryURLBasedConcurrencyTest extends CamelTestSupport {
  @Test public void testConcurrency() throws Exception {
    int total=1000;
    MockEndpoint mock=getMockEndpoint("mock:result");
    mock.expectedMessageCount(total);
    ThreadPoolTaskExecutor executor=new ThreadPoolTaskExecutor();
    executor.setCorePoolSize(5);
    executor.afterPropertiesSet();
    for (int i=0; i < 5; i++) {
      final int threadCount=i;
      executor.execute(new Runnable(){
        public void run(){
          int start=threadCount * 200;
          for (int i=0; i < 200; i++) {
            try {
              Thread.sleep(new Random().nextInt(10));
            }
 catch (            InterruptedException e) {
            }
            template.sendBody("direct:start","<mail><subject>" + (start + i) + "</subject><body>Hello world!</body></mail>");
          }
        }
      }
);
    }
    mock.assertIsSatisfied();
    mock.assertNoDuplicates(bodyAs(String.class));
    executor.shutdown();
  }
  protected RouteBuilder createRouteBuilder() throws Exception {
    return new RouteBuilder(){
      public void configure() throws Exception {
        errorHandler(noErrorHandler());
        from("direct:start").to("seda:foo?concurrentConsumers=5");
        from("seda:foo?concurrentConsumers=5").to("xquery:org/apache/camel/component/xquery/transform.xquery").to("mock:result");
      }
    }
;
  }
}
