/** 
 * Unit test for producer writing to URL.
 */
public class StreamToUrlTest extends CamelTestSupport {
  ByteArrayOutputStream buffer=new ByteArrayOutputStream();
  String message="message";
  String existingHandlers=System.getProperty("java.protocol.handler.pkgs");
  @Override protected void doPreSetup() throws Exception {
    System.setProperty("java.protocol.handler.pkgs",getClass().getPackage().getName());
    MockURLConnection.setOutputStream(buffer);
  }
  @Override @After public void tearDown() throws Exception {
    if (existingHandlers != null) {
      System.setProperty("java.protocol.handler.pkgs",existingHandlers);
    }
    super.tearDown();
  }
  protected RouteBuilder createRouteBuilder(){
    return new RouteBuilder(){
      public void configure(){
        from("direct:start").to("stream:url?url=mock:&httpHeaders.foo=123&httpHeaders.bar=yes");
      }
    }
;
  }
  @Test public void shouldSendToUrlOutputStream() throws Exception {
    template.sendBody("direct:start",message);
    String messageReceived=new String(buffer.toByteArray()).trim();
    assertEquals(message,messageReceived);
    assertEquals("123",MockURLConnection.getHeaders().get("foo"));
    assertEquals("yes",MockURLConnection.getHeaders().get("bar"));
  }
}
