/** 
 * @version 
 */
public class HttpBasicAuthComponentConfiguredTest extends BaseJettyTest {
  @Override protected JndiRegistry createRegistry() throws Exception {
    JndiRegistry jndi=super.createRegistry();
    jndi.bind("myAuthHandler",getSecurityHandler());
    return jndi;
  }
  private SecurityHandler getSecurityHandler() throws IOException {
    Constraint constraint=new Constraint(Constraint.__BASIC_AUTH,"user");
    constraint.setAuthenticate(true);
    ConstraintMapping cm=new ConstraintMapping();
    cm.setPathSpec("/*");
    cm.setConstraint(constraint);
    ConstraintSecurityHandler sh=new ConstraintSecurityHandler();
    sh.setAuthenticator(new BasicAuthenticator());
    sh.setConstraintMappings(Arrays.asList(new ConstraintMapping[]{cm}));
    HashLoginService loginService=new HashLoginService("MyRealm","src/test/resources/myRealm.properties");
    sh.setLoginService(loginService);
    sh.setConstraintMappings(Arrays.asList(new ConstraintMapping[]{cm}));
    return sh;
  }
  @Test public void testHttpBasicAuth() throws Exception {
    String out=template.requestBody("http://localhost:{{port}}/test","Hello World",String.class);
    assertEquals("Bye World",out);
    out=template.requestBody("http://localhost:{{port}}/anotherTest","Hello World",String.class);
    assertEquals("See you later",out);
  }
  @Override protected RouteBuilder createRouteBuilder() throws Exception {
    return new RouteBuilder(){
      @Override public void configure() throws Exception {
        HttpConfiguration config=new HttpConfiguration();
        config.setAuthMethod("Basic");
        config.setAuthUsername("donald");
        config.setAuthPassword("duck");
        HttpComponent http=context.getComponent("http",HttpComponent.class);
        http.setHttpConfiguration(config);
        from("jetty://http://localhost:{{port}}/test?handlers=myAuthHandler").process(new Processor(){
          public void process(          Exchange exchange) throws Exception {
            HttpServletRequest req=exchange.getIn().getBody(HttpServletRequest.class);
            assertNotNull(req);
            Principal user=req.getUserPrincipal();
            assertNotNull(user);
            assertEquals("donald",user.getName());
          }
        }
).transform(constant("Bye World"));
        from("jetty://http://localhost:{{port}}/anotherTest?handlers=myAuthHandler").transform(constant("See you later"));
      }
    }
;
  }
}
