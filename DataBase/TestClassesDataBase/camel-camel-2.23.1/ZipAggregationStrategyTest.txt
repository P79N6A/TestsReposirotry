public class ZipAggregationStrategyTest extends CamelTestSupport {
  private static final int EXPECTED_NO_FILES=3;
  @Override @Before public void setUp() throws Exception {
    deleteDirectory("target/out");
    super.setUp();
  }
  @Test public void testSplitter() throws Exception {
    MockEndpoint mock=getMockEndpoint("mock:aggregateToZipEntry");
    mock.expectedMessageCount(1);
    mock.expectedHeaderReceived("foo","bar");
    assertMockEndpointsSatisfied();
    Thread.sleep(500);
    File[] files=new File("target/out").listFiles();
    assertTrue(files != null);
    assertTrue("Should be a file in target/out directory",files.length > 0);
    File resultFile=files[0];
    ZipInputStream zin=new ZipInputStream(new FileInputStream(resultFile));
    try {
      int fileCount=0;
      for (ZipEntry ze=zin.getNextEntry(); ze != null; ze=zin.getNextEntry()) {
        fileCount=fileCount + 1;
      }
      assertEquals("Zip file should contains " + ZipAggregationStrategyTest.EXPECTED_NO_FILES + " files",ZipAggregationStrategyTest.EXPECTED_NO_FILES,fileCount);
    }
  finally {
      IOHelper.close(zin);
    }
  }
  @Override protected RouteBuilder createRouteBuilder() throws Exception {
    return new RouteBuilder(){
      @Override public void configure() throws Exception {
        from("file:src/test/resources/org/apache/camel/aggregate/zipfile/data?consumer.delay=1000&noop=true").setHeader("foo",constant("bar")).aggregate(new ZipAggregationStrategy()).constant(true).completionFromBatchConsumer().eagerCheckCompletion().to("file:target/out").to("mock:aggregateToZipEntry").log("Done processing zip file: ${header.CamelFileName}");
      }
    }
;
  }
}
