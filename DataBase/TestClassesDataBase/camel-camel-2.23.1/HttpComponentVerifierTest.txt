public class HttpComponentVerifierTest extends BaseHttpTest {
  private static final String AUTH_USERNAME="camel";
  private static final String AUTH_PASSWORD="password";
  private static final int PORT=AvailablePortFinder.getNextAvailable();
  private Server localServer;
  @Before @Override public void setUp() throws Exception {
    localServer=new Server(PORT);
    localServer.setHandler(handlers(contextHandler("/basic",new BasicValidationHandler("GET",null,null,getExpectedContent()))));
    localServer.start();
    super.setUp();
  }
  @After @Override public void tearDown() throws Exception {
    super.tearDown();
    if (localServer != null) {
      localServer.stop();
    }
  }
  @Override public boolean isUseRouteBuilder(){
    return false;
  }
  protected String getLocalServerUri(  String contextPath) throws Exception {
    return new StringBuilder().append("http://").append("localhost").append(":").append(PORT).append(contextPath != null ? contextPath : "").toString();
  }
  @Test public void testParameters() throws Exception {
    HttpComponent component=context().getComponent("http",HttpComponent.class);
    ComponentVerifier verifier=component.getVerifier();
    Map<String,Object> parameters=new HashMap<>();
    parameters.put("httpUri",getLocalServerUri("/basic"));
    ComponentVerifier.Result result=verifier.verify(ComponentVerifier.Scope.PARAMETERS,parameters);
    Assert.assertEquals(ComponentVerifier.Result.Status.OK,result.getStatus());
  }
  @Test public void testMissingMandatoryParameters() throws Exception {
    HttpComponent component=context().getComponent("http",HttpComponent.class);
    ComponentVerifier verifier=component.getVerifier();
    Map<String,Object> parameters=new HashMap<>();
    ComponentVerifier.Result result=verifier.verify(ComponentVerifier.Scope.PARAMETERS,parameters);
    Assert.assertEquals(ComponentVerifier.Result.Status.ERROR,result.getStatus());
    Assert.assertEquals(1,result.getErrors().size());
    ComponentVerifier.VerificationError error=result.getErrors().get(0);
    Assert.assertEquals(ComponentVerifier.VerificationError.StandardCode.MISSING_PARAMETER,error.getCode());
    Assert.assertTrue(error.getParameterKeys().contains("httpUri"));
  }
  @Test public void testConnectivity() throws Exception {
    HttpComponent component=context().getComponent("http",HttpComponent.class);
    ComponentVerifier verifier=component.getVerifier();
    Map<String,Object> parameters=new HashMap<>();
    parameters.put("httpUri",getLocalServerUri("/basic"));
    ComponentVerifier.Result result=verifier.verify(ComponentVerifier.Scope.CONNECTIVITY,parameters);
    Assert.assertEquals(ComponentVerifier.Result.Status.OK,result.getStatus());
  }
  @Test public void testConnectivityWithWrongUri() throws Exception {
    HttpComponent component=context().getComponent("http",HttpComponent.class);
    ComponentVerifier verifier=component.getVerifier();
    Map<String,Object> parameters=new HashMap<>();
    parameters.put("httpUri","http://www.not-existing-uri.unknown");
    ComponentVerifier.Result result=verifier.verify(ComponentVerifier.Scope.CONNECTIVITY,parameters);
    Assert.assertEquals(ComponentVerifier.Result.Status.ERROR,result.getStatus());
    Assert.assertEquals(1,result.getErrors().size());
    ComponentVerifier.VerificationError error=result.getErrors().get(0);
    Assert.assertEquals(ComponentVerifier.VerificationError.StandardCode.EXCEPTION,error.getCode());
    Assert.assertTrue(error.getParameterKeys().contains("httpUri"));
  }
}
