public class CamelFileGreeterOneWayTest extends CamelSpringTestSupport {
  private static final Logger LOG=LoggerFactory.getLogger(CamelGreeterTest.class);
  private static Endpoint endpoint;
  private static GreeterImpl greeterImpl;
  private static int port=AvailablePortFinder.getNextAvailable(20000);
static {
    System.setProperty("CamelFileGreeterOneWayTest.port",Integer.toString(port));
  }
  @BeforeClass public static void startServer() throws Exception {
    greeterImpl=new GreeterImpl();
    String address="http://localhost:" + port + "/SoapContext/SoapPort";
    endpoint=Endpoint.publish(address,greeterImpl);
    LOG.info("The WS endpoint is published! ");
  }
  @AfterClass public static void stopServer() throws Exception {
    if (endpoint != null) {
      endpoint.stop();
      endpoint=null;
    }
  }
  @Test public void testFileWithOnewayOperation() throws Exception {
    deleteDirectory("target/messages/input/");
    greeterImpl.resetOneWayCounter();
    ProducerTemplate template=context.createProducerTemplate();
    template.sendBodyAndHeader("file://target/messages/input/","Hello World",Exchange.FILE_NAME,"hello.txt");
    Thread.sleep(4000);
    template.stop();
    assertEquals("The oneway operation of greeter should be called",1,greeterImpl.getOneWayCounter());
    File file=new File("target/messages/input/hello.txt");
    assertFalse("File " + file + " should be deleted",file.exists());
  }
  @Override protected AbstractApplicationContext createApplicationContext(){
    return new ClassPathXmlApplicationContext("org/apache/camel/itest/greeter/CamelFileGreeterOneWayTest.xml");
  }
}
