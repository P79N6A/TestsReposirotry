public class NettyHttpProducerSessionTest extends BaseNettyTest {
  @Test public void testNoSession() throws Exception {
    getMockEndpoint("mock:result").expectedBodiesReceived("New New World","New New World");
    template.sendBody("direct:start","World");
    template.sendBody("direct:start","World");
    assertMockEndpointsSatisfied();
  }
  @Test public void testInstanceSession() throws Exception {
    getMockEndpoint("mock:result").expectedBodiesReceived("Old New World","Old Old World");
    template.sendBody("direct:instance","World");
    template.sendBody("direct:instance","World");
    assertMockEndpointsSatisfied();
  }
  @Test public void testExchangeSession() throws Exception {
    getMockEndpoint("mock:result").expectedBodiesReceived("Old New World","Old New World");
    template.sendBody("direct:exchange","World");
    template.sendBody("direct:exchange","World");
    assertMockEndpointsSatisfied();
  }
  @Override protected JndiRegistry createRegistry() throws Exception {
    JndiRegistry jndiRegistry=super.createRegistry();
    jndiRegistry.bind("instanceCookieHandler",new InstanceCookieHandler());
    jndiRegistry.bind("exchangeCookieHandler",new ExchangeCookieHandler());
    return jndiRegistry;
  }
  @Override protected RouteBuilder createRouteBuilder() throws Exception {
    return new RouteBuilder(){
      @Override public void configure() throws Exception {
        from("direct:start").toF("netty4-http:http://127.0.0.1:%d/session",getPort()).toF("netty4-http:http://127.0.0.1:%d/session",getPort()).to("mock:result");
        from("direct:instance").toF("netty4-http:http://127.0.0.1:%d/session?cookieHandler=#instanceCookieHandler",getPort()).toF("netty4-http:http://127.0.0.1:%d/session?cookieHandler=#instanceCookieHandler",getPort()).to("mock:result");
        from("direct:exchange").toF("netty4-http:http://127.0.0.1:%d/session?cookieHandler=#exchangeCookieHandler",getPort()).toF("netty4-http:http://127.0.0.1:%d/session?cookieHandler=#exchangeCookieHandler",getPort()).to("mock:result");
        fromF("jetty:http://127.0.0.1:%d/session?sessionSupport=true",getPort()).process(new Processor(){
          @Override public void process(          Exchange exchange) throws Exception {
            HttpMessage message=exchange.getIn(HttpMessage.class);
            HttpSession session=message.getRequest().getSession();
            String body=message.getBody(String.class);
            if ("bar".equals(session.getAttribute("foo"))) {
              message.setBody("Old " + body);
            }
 else {
              session.setAttribute("foo","bar");
              message.setBody("New " + body);
            }
          }
        }
);
      }
    }
;
  }
}
