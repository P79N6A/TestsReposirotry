/** 
 * Integration test to confirm REQUEUE header causes message to be re-queued instead of sent to DLQ.
 */
public class RabbitMQRequeueIntTest extends AbstractRabbitMQIntTest {
  public static final String ROUTING_KEY="rk4";
  @Produce(uri="direct:rabbitMQ") protected ProducerTemplate directProducer;
  @EndpointInject(uri="rabbitmq:localhost:5672/ex4??username=cameltest&password=cameltest" + "&autoAck=false&queue=q4&routingKey=" + ROUTING_KEY) private Endpoint rabbitMQEndpoint;
  @EndpointInject(uri="mock:producing") private MockEndpoint producingMockEndpoint;
  @EndpointInject(uri="mock:consuming") private MockEndpoint consumingMockEndpoint;
  @Override protected RouteBuilder createRouteBuilder() throws Exception {
    return new RouteBuilder(){
      @Override public void configure() throws Exception {
        from("direct:rabbitMQ").id("producingRoute").log("Sending message").inOnly(rabbitMQEndpoint).to(producingMockEndpoint);
        from(rabbitMQEndpoint).id("consumingRoute").log("Receiving message").inOnly(consumingMockEndpoint).throwException(new Exception("Simulated exception"));
      }
    }
;
  }
  @Test public void testNoRequeueHeaderCausesReject() throws Exception {
    producingMockEndpoint.expectedMessageCount(1);
    consumingMockEndpoint.expectedMessageCount(1);
    directProducer.sendBody("Hello, World!");
    Thread.sleep(100);
    producingMockEndpoint.assertIsSatisfied();
    consumingMockEndpoint.assertIsSatisfied();
  }
  @Test public void testNonBooleanRequeueHeaderCausesReject() throws Exception {
    producingMockEndpoint.expectedMessageCount(1);
    consumingMockEndpoint.expectedMessageCount(1);
    directProducer.sendBodyAndHeader("Hello, World!",RabbitMQConstants.REQUEUE,4L);
    Thread.sleep(100);
    producingMockEndpoint.assertIsSatisfied();
    consumingMockEndpoint.assertIsSatisfied();
  }
  @Test public void testFalseRequeueHeaderCausesReject() throws Exception {
    producingMockEndpoint.expectedMessageCount(1);
    consumingMockEndpoint.expectedMessageCount(1);
    directProducer.sendBodyAndHeader("Hello, World!",RabbitMQConstants.REQUEUE,false);
    Thread.sleep(100);
    producingMockEndpoint.assertIsSatisfied();
    consumingMockEndpoint.assertIsSatisfied();
  }
  @Test public void testTrueRequeueHeaderCausesRequeue() throws Exception {
    producingMockEndpoint.expectedMessageCount(1);
    consumingMockEndpoint.setMinimumExpectedMessageCount(2);
    directProducer.sendBodyAndHeader("Hello, World!",RabbitMQConstants.REQUEUE,true);
    Thread.sleep(100);
    producingMockEndpoint.assertIsSatisfied();
    consumingMockEndpoint.assertIsSatisfied();
  }
}
