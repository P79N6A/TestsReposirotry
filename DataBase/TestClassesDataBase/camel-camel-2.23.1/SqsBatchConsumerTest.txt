public class SqsBatchConsumerTest extends CamelTestSupport {
  @EndpointInject(uri="mock:result") private MockEndpoint mock;
  @Test public void receiveBatch() throws Exception {
    mock.expectedMessageCount(5);
    assertMockEndpointsSatisfied();
    mock.message(0).exchangeProperty(Exchange.BATCH_INDEX).isEqualTo(0);
    mock.message(1).exchangeProperty(Exchange.BATCH_INDEX).isEqualTo(1);
    mock.message(2).exchangeProperty(Exchange.BATCH_INDEX).isEqualTo(2);
    mock.message(3).exchangeProperty(Exchange.BATCH_INDEX).isEqualTo(3);
    mock.message(4).exchangeProperty(Exchange.BATCH_INDEX).isEqualTo(4);
    mock.message(0).exchangeProperty(Exchange.BATCH_COMPLETE).isEqualTo(false);
    mock.message(1).exchangeProperty(Exchange.BATCH_COMPLETE).isEqualTo(false);
    mock.message(2).exchangeProperty(Exchange.BATCH_COMPLETE).isEqualTo(false);
    mock.message(3).exchangeProperty(Exchange.BATCH_COMPLETE).isEqualTo(false);
    mock.message(3).exchangeProperty(Exchange.BATCH_COMPLETE).isEqualTo(false);
    mock.message(4).exchangeProperty(Exchange.BATCH_COMPLETE).isEqualTo(true);
    mock.expectedPropertyReceived(Exchange.BATCH_SIZE,5);
  }
  @Override protected JndiRegistry createRegistry() throws Exception {
    JndiRegistry registry=super.createRegistry();
    AmazonSQSClientMock clientMock=new AmazonSQSClientMock();
    for (int counter=0; counter < 6; counter++) {
      Message message=new Message();
      message.setBody("Message " + counter);
      message.setMD5OfBody("6a1559560f67c5e7a7d5d838bf0272ee");
      message.setMessageId("f6fb6f99-5eb2-4be4-9b15-144774141458");
      message.setReceiptHandle("0NNAq8PwvXsyZkR6yu4nQ07FGxNmOBWi5");
      clientMock.messages.add(message);
    }
    registry.bind("amazonSQSClient",clientMock);
    return registry;
  }
  @Override protected RouteBuilder createRouteBuilder() throws Exception {
    return new RouteBuilder(){
      @Override public void configure() throws Exception {
        from("aws-sqs://MyQueue?amazonSQSClient=#amazonSQSClient&delay=5000&maxMessagesPerPoll=5").to("mock:result");
      }
    }
;
  }
}
