/** 
 * Tests that the redelivery error handler will break out if CamelContext is shutting down.
 */
public class RedeliveryErrorHandlerBreakoutDuringShutdownTest extends ContextTestSupport {
  @Test public void testRedelivery() throws Exception {
    getMockEndpoint("mock:before").expectedMessageCount(1);
    getMockEndpoint("mock:after").expectedMessageCount(0);
    template.sendBody("seda:start","Hello World");
    assertMockEndpointsSatisfied();
    StopWatch watch=new StopWatch();
    context.getShutdownStrategy().setTimeout(1);
    context.stop();
    assertTrue("Should take less than 5 seconds, was {}",watch.taken() < 5000);
  }
  @Override protected RouteBuilder createRouteBuilder() throws Exception {
    return new RouteBuilder(){
      @Override public void configure() throws Exception {
        errorHandler(defaultErrorHandler().maximumRedeliveries(-1).redeliveryDelay(1000));
        from("seda:start").to("mock:before").process(new Processor(){
          public void process(          Exchange exchange) throws Exception {
            throw new IllegalArgumentException("Forced");
          }
        }
).to("mock:after");
      }
    }
;
  }
}
