public class RouteboxDirectTest extends RouteboxDemoTestSupport {
  private static final Logger LOG=LoggerFactory.getLogger(RouteboxDirectTest.class);
  private ProducerTemplate template;
  private String routeboxUri="routebox:multipleRoutes?innerContext=#ctx&dispatchStrategy=#strategy";
  @Override protected JndiRegistry createRegistry() throws Exception {
    JndiRegistry registry=new JndiRegistry(createJndiContext());
    registry.bind("ctx",createInnerContext());
    registry.bind("strategy",new SimpleRouteDispatchStrategy());
    return registry;
  }
  private CamelContext createInnerContext() throws Exception {
    JndiRegistry innerRegistry=new JndiRegistry(createJndiContext());
    BookCatalog catalogBean=new BookCatalog();
    innerRegistry.bind("library",catalogBean);
    CamelContext innerContext=new DefaultCamelContext(innerRegistry);
    innerContext.addRoutes(new SimpleRouteBuilder());
    return innerContext;
  }
  @Override public boolean isUseRouteBuilder(){
    return false;
  }
  @Test public void testRouteboxDirectAsyncRequests() throws Exception {
    template=new DefaultProducerTemplate(context);
    template.start();
    context.addRoutes(new RouteBuilder(){
      public void configure(){
        from(routeboxUri).to("log:Routes operation performed?showAll=true");
      }
    }
);
    context.start();
    LOG.debug("Beginning Test ---> testRouteboxDirectAsyncRequests()");
    Book book=new Book("Sir Arthur Conan Doyle","The Adventures of Sherlock Holmes");
    String response=sendAddToCatalogRequest(template,routeboxUri,"addToCatalog",book);
    assertEquals("Book with Author " + book.getAuthor() + " and title "+ book.getTitle()+ " added to Catalog",response);
    book=sendFindBookRequest(template,routeboxUri,"findBook","Sir Arthur Conan Doyle");
    LOG.debug("Received book with author {} and title {}",book.getAuthor(),book.getTitle());
    assertEquals("The Adventures of Sherlock Holmes",book.getTitle());
    LOG.debug("Completed Test ---> testRouteboxDirectAsyncRequests()");
    context.stop();
  }
}
