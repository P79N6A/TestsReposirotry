public class NettyDataFormatTest extends CamelTestSupport {
  private static int serverPort;
  private final int messageCount=1;
  private final String message="<165>Aug  4 05:34:00 mymachine myproc[10]: %% It's\n         time to make the do-nuts.  %%  Ingredients: Mix=OK, Jelly=OK #\n" + "         Devices: Mixer=OK, Jelly_Injector=OK, Frier=OK # Transport:\n" + "         Conveyer1=OK, Conveyer2=OK # %%";
  @BeforeClass public static void initPort(){
    serverPort=AvailablePortFinder.getNextAvailable();
  }
  @Test public void testSendingRawUDP() throws IOException, InterruptedException {
    MockEndpoint mock=getMockEndpoint("mock:syslogReceiver");
    MockEndpoint mock2=getMockEndpoint("mock:syslogReceiver2");
    mock.expectedMessageCount(1);
    mock2.expectedMessageCount(1);
    mock2.expectedBodiesReceived(message);
    DatagramSocket socket=new DatagramSocket();
    try {
      InetAddress address=InetAddress.getByName("127.0.0.1");
      for (int i=0; i < messageCount; i++) {
        byte[] data=message.getBytes();
        DatagramPacket packet=new DatagramPacket(data,data.length,address,serverPort);
        socket.send(packet);
        Thread.sleep(100);
      }
    }
  finally {
      socket.close();
    }
    assertMockEndpointsSatisfied();
  }
  @Test public void testSendingRawUDPFromNetty() throws IOException, InterruptedException {
    MockEndpoint mock=getMockEndpoint("mock:syslogReceiver");
    MockEndpoint mock2=getMockEndpoint("mock:syslogReceiver2");
    mock.expectedMessageCount(1);
    mock2.expectedMessageCount(1);
    mock2.expectedBodiesReceived(message);
    template.sendBody("netty4:udp://127.0.0.1:" + serverPort + "?sync=false&allowDefaultCodec=false&useByteBuf=true",message);
    assertMockEndpointsSatisfied();
  }
  @Override protected RouteBuilder createRouteBuilder() throws Exception {
    return new RouteBuilder(){
      public void configure() throws Exception {
        context.setTracing(true);
        DataFormat syslogDataFormat=new SyslogDataFormat();
        from("netty4:udp://127.0.0.1:" + serverPort + "?sync=false&allowDefaultCodec=false").unmarshal(syslogDataFormat).process(new Processor(){
          public void process(          Exchange ex){
            assertTrue(ex.getIn().getBody() instanceof SyslogMessage);
          }
        }
).to("mock:syslogReceiver").marshal(syslogDataFormat).to("mock:syslogReceiver2");
      }
    }
;
  }
}
