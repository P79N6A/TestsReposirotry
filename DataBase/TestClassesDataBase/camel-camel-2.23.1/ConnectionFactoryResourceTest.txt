public class ConnectionFactoryResourceTest {
  private ActiveMQConnectionFactory connectionFactory;
  @Before public void setup(){
    connectionFactory=new ActiveMQConnectionFactory("vm://broker?broker.persistent=false&broker.useJmx=false");
  }
  @After public void teardown(){
    connectionFactory=null;
  }
  @Test public void testCreateObject() throws Exception {
    ConnectionFactoryResource pool=new ConnectionFactoryResource(1,connectionFactory);
    pool.fillPool();
    assertNotNull(pool);
    ActiveMQConnection connection=(ActiveMQConnection)pool.makeObject();
    assertNotNull(connection);
    assertTrue(connection.isStarted());
    pool.drainPool();
  }
  @Test public void testDestroyObject() throws Exception {
    ConnectionFactoryResource pool=new ConnectionFactoryResource(1,connectionFactory);
    pool.fillPool();
    assertNotNull(pool);
    ActiveMQConnection connection=(ActiveMQConnection)pool.makeObject();
    assertNotNull(connection);
    assertTrue(connection.isStarted());
    pool.drainPool();
    assertTrue(pool.size() == 0);
  }
  @Test(expected=NoSuchElementException.class) public void testBorrowObject() throws Exception {
    ConnectionFactoryResource pool=new ConnectionFactoryResource(1,connectionFactory);
    pool.fillPool();
    assertNotNull(pool);
    ActiveMQConnection connection=(ActiveMQConnection)pool.borrowConnection();
    assertNotNull(connection);
    assertTrue(connection.isStarted());
    pool.borrowConnection();
  }
  @Test public void testReturnObject() throws Exception {
    ConnectionFactoryResource pool=new ConnectionFactoryResource(1,connectionFactory);
    pool.fillPool();
    assertNotNull(pool);
    ActiveMQConnection connection=(ActiveMQConnection)pool.borrowConnection();
    assertNotNull(connection);
    assertTrue(connection.isStarted());
    pool.returnConnection(connection);
    ActiveMQConnection connection2=(ActiveMQConnection)pool.borrowConnection();
    assertNotNull(connection2);
    pool.drainPool();
  }
  @Test public void testRoundRobbin() throws Exception {
    ConnectionFactoryResource pool=new ConnectionFactoryResource(2,connectionFactory);
    pool.fillPool();
    assertNotNull(pool);
    ActiveMQConnection connection=(ActiveMQConnection)pool.borrowConnection();
    assertNotNull(connection);
    assertTrue(connection.isStarted());
    pool.returnConnection(connection);
    ActiveMQConnection connection2=(ActiveMQConnection)pool.borrowConnection();
    assertNotNull(connection2);
    assertNotEquals(connection,connection2);
    pool.drainPool();
  }
}
