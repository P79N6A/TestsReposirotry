/** 
 * Unit testing for using a MinaProducer that it can shutdown properly (CAMEL-395) <p> Run this test from maven: mvn exec:java and see the output if there is a error.
 */
@Ignore public class MinaProducerShutdownTest extends TestSupport {
  private static final String URI="mina:tcp://localhost:6321?textline=true&sync=false";
  private long start;
  private CamelContext context;
  public static void main(  String[] args) throws Exception {
    MinaProducerShutdownTest me=new MinaProducerShutdownTest();
    me.testProducer();
  }
  @Test public void testProducer() throws Exception {
    Thread hook=new AssertShutdownHook();
    Runtime.getRuntime().addShutdownHook(hook);
    start=System.currentTimeMillis();
    context=new DefaultCamelContext();
    context.addRoutes(createRouteBuilder());
    context.start();
    sendMessage();
    context.stop();
  }
private class AssertShutdownHook extends Thread {
    public void run(){
      long diff=System.currentTimeMillis() - start;
      if (diff > 5000) {
        log.error("ERROR: MinaProducer should be able to shutdown within 5000 millis: time=" + diff);
      }
    }
  }
  private void sendMessage() throws Exception {
    Endpoint endpoint=context.getEndpoint(URI);
    Producer producer=endpoint.createProducer();
    Exchange exchange=endpoint.createExchange();
    exchange.getIn().setBody("Hello World");
    producer.start();
    producer.process(exchange);
    producer.stop();
  }
  private RouteBuilder createRouteBuilder(){
    return new RouteBuilder(){
      public void configure(){
        from(URI).to("mock:result");
      }
    }
;
  }
}
