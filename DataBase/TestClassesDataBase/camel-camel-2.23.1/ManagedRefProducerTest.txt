/** 
 * @version
 */
public class ManagedRefProducerTest extends ManagementTestSupport {
  private Map registry=new SimpleRegistry();
  @Override protected CamelContext createCamelContext() throws Exception {
    CamelContext context=new DefaultCamelContext((Registry)registry);
    registry.put("foo",new MockEndpoint("mock://foo"));
    return context;
  }
  @Test public void testProducer() throws Exception {
    if (isPlatform("aix")) {
      return;
    }
    getMockEndpoint("mock:result").expectedMessageCount(1);
    getMockEndpoint("foo").expectedMessageCount(1);
    template.sendBody("direct:start","Hello World");
    assertMockEndpointsSatisfied();
    MBeanServer mbeanServer=getMBeanServer();
    Set<ObjectName> set=mbeanServer.queryNames(new ObjectName("*:type=producers,*"),null);
    assertEquals(2,set.size());
    Iterator<ObjectName> it=set.iterator();
    for (int i=0; i < 2; i++) {
      ObjectName on=it.next();
      boolean registered=mbeanServer.isRegistered(on);
      assertEquals("Should be registered",true,registered);
      String uri=(String)mbeanServer.getAttribute(on,"EndpointUri");
      assertTrue(uri,uri.equals("mock://foo") || uri.equals("mock://result"));
      String state=(String)mbeanServer.getAttribute(on,"State");
      assertEquals("Should be started",ServiceStatus.Started.name(),state);
    }
    set=mbeanServer.queryNames(new ObjectName("*:type=endpoints,*"),null);
    assertEquals(4,set.size());
    it=set.iterator();
    for (int i=0; i < 4; i++) {
      ObjectName on=it.next();
      boolean registered=mbeanServer.isRegistered(on);
      assertEquals("Should be registered",true,registered);
      String uri=(String)mbeanServer.getAttribute(on,"EndpointUri");
      assertTrue(uri,uri.equals("direct://start") || uri.equals("ref://foo") || uri.equals("mock://foo")|| uri.equals("mock://result"));
    }
  }
  @Override protected RouteBuilder createRouteBuilder() throws Exception {
    return new RouteBuilder(){
      @Override public void configure() throws Exception {
        from("direct:start").routeId("foo").to("ref:foo").to("mock:result");
      }
    }
;
  }
}
