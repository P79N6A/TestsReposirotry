public class AhcProducerSessionTest extends BaseAhcTest {
  @Test public void testProducerNoSession() throws Exception {
    getMockEndpoint("mock:result").expectedBodiesReceived("New New World","New New World");
    template.sendBody("direct:start","World");
    template.sendBody("direct:start","World");
    assertMockEndpointsSatisfied();
  }
  @Test public void testProducerInstanceSession() throws Exception {
    getMockEndpoint("mock:result").expectedBodiesReceived("Old New World","Old Old World");
    template.sendBody("direct:instance","World");
    template.sendBody("direct:instance","World");
    assertMockEndpointsSatisfied();
  }
  @Test public void testProducerExchangeSession() throws Exception {
    getMockEndpoint("mock:result").expectedBodiesReceived("Old New World","Old New World");
    template.sendBody("direct:exchange","World");
    template.sendBody("direct:exchange","World");
    assertMockEndpointsSatisfied();
  }
  @Override protected JndiRegistry createRegistry() throws Exception {
    JndiRegistry jndiRegistry=super.createRegistry();
    jndiRegistry.bind("instanceCookieHandler",new InstanceCookieHandler());
    jndiRegistry.bind("exchangeCookieHandler",new ExchangeCookieHandler());
    return jndiRegistry;
  }
  private String getTestServerEndpointSessionUrl(){
    return getProtocol() + "://127.0.0.1:" + getPort()+ "/session";
  }
  private String getTestServerEndpointSessionUri(){
    return "jetty:" + getTestServerEndpointSessionUrl() + "?sessionSupport=true";
  }
  @Override protected RouteBuilder createRouteBuilder() throws Exception {
    return new RouteBuilder(){
      @Override public void configure() throws Exception {
        from("direct:start").to("ahc:" + getTestServerEndpointSessionUrl()).to("ahc:" + getTestServerEndpointSessionUrl()).to("mock:result");
        from("direct:instance").to("ahc:" + getTestServerEndpointSessionUrl() + "?cookieHandler=#instanceCookieHandler").to("ahc:" + getTestServerEndpointSessionUrl() + "?cookieHandler=#instanceCookieHandler").to("mock:result");
        from("direct:exchange").to("ahc:" + getTestServerEndpointSessionUrl() + "?cookieHandler=#exchangeCookieHandler").to("ahc:" + getTestServerEndpointSessionUrl() + "?cookieHandler=#exchangeCookieHandler").to("mock:result");
        from(getTestServerEndpointSessionUri()).process(new Processor(){
          @Override public void process(          Exchange exchange) throws Exception {
            HttpMessage message=exchange.getIn(HttpMessage.class);
            HttpSession session=message.getRequest().getSession();
            String body=message.getBody(String.class);
            if ("bar".equals(session.getAttribute("foo"))) {
              message.setBody("Old " + body);
            }
 else {
              session.setAttribute("foo","bar");
              message.setBody("New " + body);
            }
            message.getResponse().addCookie(new Cookie("othercookie","value"));
          }
        }
);
      }
    }
;
  }
}
