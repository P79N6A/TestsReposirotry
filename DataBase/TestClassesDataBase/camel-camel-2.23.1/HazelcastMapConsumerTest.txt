public class HazelcastMapConsumerTest extends HazelcastCamelTestSupport {
  @Mock private IMap<Object,Object> map;
  @Captor private ArgumentCaptor<MapEntryListener<Object,Object>> argument;
  @Override protected void trainHazelcastInstance(  HazelcastInstance hazelcastInstance){
    when(hazelcastInstance.getMap("foo")).thenReturn(map);
    when(map.addEntryListener(any(),eq(true))).thenReturn("foo");
  }
  @Override protected void verifyHazelcastInstance(  HazelcastInstance hazelcastInstance){
    verify(hazelcastInstance).getMap("foo");
    verify(map).addEntryListener(any(MapEntryListener.class),eq(true));
  }
  @Test public void testAdd() throws InterruptedException {
    MockEndpoint out=getMockEndpoint("mock:added");
    out.expectedMessageCount(1);
    verify(map).addEntryListener(argument.capture(),eq(true));
    EntryEvent<Object,Object> event=new EntryEvent<>("foo",null,EntryEventType.ADDED.getType(),"4711","my-foo");
    argument.getValue().entryAdded(event);
    assertMockEndpointsSatisfied(5000,TimeUnit.MILLISECONDS);
    this.checkHeaders(out.getExchanges().get(0).getIn().getHeaders(),HazelcastConstants.ADDED);
  }
  @Test public void testEnict() throws InterruptedException {
    MockEndpoint out=super.getMockEndpoint("mock:evicted");
    out.expectedMessageCount(1);
    verify(map).addEntryListener(argument.capture(),eq(true));
    EntryEvent<Object,Object> event=new EntryEvent<>("foo",null,EntryEventType.EVICTED.getType(),"4711","my-foo");
    argument.getValue().entryEvicted(event);
    assertMockEndpointsSatisfied(30000,TimeUnit.MILLISECONDS);
  }
  @Test public void testUpdate() throws InterruptedException {
    MockEndpoint out=getMockEndpoint("mock:updated");
    out.expectedMessageCount(1);
    verify(map).addEntryListener(argument.capture(),eq(true));
    EntryEvent<Object,Object> event=new EntryEvent<>("foo",null,EntryEventType.UPDATED.getType(),"4711","my-foo");
    argument.getValue().entryUpdated(event);
    assertMockEndpointsSatisfied(5000,TimeUnit.MILLISECONDS);
    this.checkHeaders(out.getExchanges().get(0).getIn().getHeaders(),HazelcastConstants.UPDATED);
  }
  @Test public void testEvict() throws InterruptedException {
    MockEndpoint out=getMockEndpoint("mock:evicted");
    out.expectedMessageCount(1);
    verify(map).addEntryListener(argument.capture(),eq(true));
    EntryEvent<Object,Object> event=new EntryEvent<>("foo",null,EntryEventType.EVICTED.getType(),"4711","my-foo");
    argument.getValue().entryEvicted(event);
    assertMockEndpointsSatisfied(5000,TimeUnit.MILLISECONDS);
    this.checkHeaders(out.getExchanges().get(0).getIn().getHeaders(),HazelcastConstants.EVICTED);
  }
  @Test public void testRemove() throws InterruptedException {
    MockEndpoint out=getMockEndpoint("mock:removed");
    out.expectedMessageCount(1);
    verify(map).addEntryListener(argument.capture(),eq(true));
    EntryEvent<Object,Object> event=new EntryEvent<>("foo",null,EntryEventType.REMOVED.getType(),"4711","my-foo");
    argument.getValue().entryRemoved(event);
    assertMockEndpointsSatisfied(5000,TimeUnit.MILLISECONDS);
    this.checkHeaders(out.getExchanges().get(0).getIn().getHeaders(),HazelcastConstants.REMOVED);
  }
  @Override protected RouteBuilder createRouteBuilder() throws Exception {
    return new RouteBuilder(){
      @Override public void configure() throws Exception {
        from(String.format("hazelcast-%sfoo",HazelcastConstants.MAP_PREFIX)).log("object...").choice().when(header(HazelcastConstants.LISTENER_ACTION).isEqualTo(HazelcastConstants.ADDED)).log("...added").to("mock:added").when(header(HazelcastConstants.LISTENER_ACTION).isEqualTo(HazelcastConstants.EVICTED)).log("...evicted").to("mock:evicted").when(header(HazelcastConstants.LISTENER_ACTION).isEqualTo(HazelcastConstants.UPDATED)).log("...updated").to("mock:updated").when(header(HazelcastConstants.LISTENER_ACTION).isEqualTo(HazelcastConstants.REMOVED)).log("...removed").to("mock:removed").otherwise().log("fail!");
      }
    }
;
  }
  private void checkHeaders(  Map<String,Object> headers,  String action){
    assertEquals(action,headers.get(HazelcastConstants.LISTENER_ACTION));
    assertEquals(HazelcastConstants.CACHE_LISTENER,headers.get(HazelcastConstants.LISTENER_TYPE));
    assertEquals("4711",headers.get(HazelcastConstants.OBJECT_ID));
    assertNotNull(headers.get(HazelcastConstants.LISTENER_TIME));
  }
}
