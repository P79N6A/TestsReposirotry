public class AtomixSetConsumerTest extends AtomixClientTestSupport {
  private static final String SET_NAME=UUID.randomUUID().toString();
  private DistributedSet<Object> set;
  @Override protected Map<String,Component> createComponents(){
    AtomixSetComponent component=new AtomixSetComponent();
    component.setNodes(Collections.singletonList(getReplicaAddress()));
    return Collections.singletonMap("atomix-set",component);
  }
  @Override protected void doPreSetup() throws Exception {
    super.doPreSetup();
    set=getClient().getSet(SET_NAME).join();
  }
  @Override @After public void tearDown() throws Exception {
    set.close();
    super.tearDown();
  }
  @Test public void testEvents() throws Exception {
    String val1=context().getUuidGenerator().generateUuid();
    String val2=context().getUuidGenerator().generateUuid();
    MockEndpoint mock=getMockEndpoint("mock:result");
    mock.expectedMessageCount(4);
    mock.message(0).body().isEqualTo(val1);
    mock.message(0).header(AtomixClientConstants.EVENT_TYPE).isEqualTo(DistributedSet.Events.ADD);
    mock.message(1).body().isEqualTo(val2);
    mock.message(1).header(AtomixClientConstants.EVENT_TYPE).isEqualTo(DistributedSet.Events.ADD);
    mock.message(2).body().isEqualTo(val2);
    mock.message(2).header(AtomixClientConstants.EVENT_TYPE).isEqualTo(DistributedSet.Events.REMOVE);
    mock.message(3).body().isEqualTo(val1);
    mock.message(3).header(AtomixClientConstants.EVENT_TYPE).isEqualTo(DistributedMap.Events.REMOVE);
    set.add(val1).join();
    set.add(val2).join();
    set.remove(val2).join();
    set.remove(val1).join();
    mock.assertIsSatisfied();
  }
  @Override protected RoutesBuilder createRouteBuilder() throws Exception {
    return new RouteBuilder(){
      public void configure(){
        fromF("atomix-set:%s",SET_NAME).to("mock:result");
      }
    }
;
  }
}
