public class OpenshiftBuildsProducerTest extends KubernetesTestSupport {
  @Rule public OpenShiftServer server=new OpenShiftServer();
  @Override protected JndiRegistry createRegistry() throws Exception {
    JndiRegistry registry=super.createRegistry();
    registry.bind("client",server.getKubernetesClient().adapt(OpenShiftClient.class));
    return registry;
  }
  @Test public void listTest() throws Exception {
    server.expect().withPath("/oapi/v1/builds").andReturn(200,new BuildListBuilder().addNewItem().and().addNewItem().and().build()).once();
    List<Build> result=template.requestBody("direct:list","",List.class);
    assertEquals(2,result.size());
  }
  @Test public void listByLabelsTest() throws Exception {
    server.expect().withPath("/oapi/v1/builds?labelSelector=" + toUrlEncoded("key1=value1,key2=value2")).andReturn(200,new BuildListBuilder().addNewItem().and().addNewItem().and().build()).once();
    Exchange ex=template.request("direct:listByLabels",new Processor(){
      @Override public void process(      Exchange exchange) throws Exception {
        Map<String,String> labels=new HashMap<>();
        labels.put("key1","value1");
        labels.put("key2","value2");
        exchange.getIn().setHeader(KubernetesConstants.KUBERNETES_BUILDS_LABELS,labels);
      }
    }
);
    List<Build> result=ex.getOut().getBody(List.class);
    assertEquals(2,result.size());
  }
  @Override protected RouteBuilder createRouteBuilder() throws Exception {
    return new RouteBuilder(){
      @Override public void configure() throws Exception {
        from("direct:list").to("openshift-builds:///?operation=listBuilds&kubernetesClient=#client");
        from("direct:listByLabels").to("openshift-builds:///?operation=listBuildsByLabels&kubernetesClient=#client");
      }
    }
;
  }
}
