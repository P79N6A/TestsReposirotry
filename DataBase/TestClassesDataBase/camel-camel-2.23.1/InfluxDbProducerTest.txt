public class InfluxDbProducerTest extends AbstractInfluxDbTest {
  @EndpointInject(uri="mock:test") MockEndpoint successEndpoint;
  @EndpointInject(uri="mock:error") MockEndpoint errorEndpoint;
  @Override protected RouteBuilder createRouteBuilder() throws Exception {
    return new RouteBuilder(){
      public void configure(){
        errorHandler(deadLetterChannel("mock:error").redeliveryDelay(0).maximumRedeliveries(0));
        from("direct:test").to("influxdb:influxDbBean?databaseName={{influxdb.testDb}}").to("mock:test");
      }
    }
;
  }
  @Before public void resetEndpoints(){
    errorEndpoint.reset();
    successEndpoint.reset();
  }
  @Test public void writePointFromMapAndStaticDbName() throws InterruptedException {
    errorEndpoint.expectedMessageCount(0);
    successEndpoint.expectedMessageCount(1);
    Map<String,Object> pointMap=createMapPoint();
    sendBody("direct:test",pointMap);
    errorEndpoint.assertIsSatisfied();
    successEndpoint.assertIsSatisfied();
  }
  @Test public void writePointFromMapAndDynamicDbName() throws InterruptedException {
    errorEndpoint.expectedMessageCount(0);
    successEndpoint.expectedMessageCount(1);
    Map<String,Object> pointMap=createMapPoint();
    Map<String,Object> header=createHeader();
    sendBody("direct:test",pointMap,header);
    errorEndpoint.assertIsSatisfied();
    successEndpoint.assertIsSatisfied();
  }
  @Test public void missingMeassurementNameFails() throws InterruptedException {
    errorEndpoint.expectedMessageCount(1);
    successEndpoint.expectedMessageCount(0);
    Map<String,Object> pointMap=new HashMap<>();
    pointMap.remove(InfluxDbConstants.MEASUREMENT_NAME);
    sendBody("direct:test",pointMap);
    errorEndpoint.assertIsSatisfied();
    successEndpoint.assertIsSatisfied();
  }
  private Map<String,Object> createHeader(){
    Map<String,Object> header=new HashMap<>();
    header.put(InfluxDbConstants.DBNAME_HEADER,"myOtherDatabase");
    return header;
  }
  private Map<String,Object> createMapPoint(){
    Map<String,Object> pointMap=new HashMap<>();
    pointMap.put(InfluxDbConstants.MEASUREMENT_NAME,"MyTestMeasurement");
    pointMap.put("CPU",1);
    return pointMap;
  }
}
