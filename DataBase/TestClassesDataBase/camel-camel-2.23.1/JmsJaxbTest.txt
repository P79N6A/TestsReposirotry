/** 
 * @version 
 */
public class JmsJaxbTest extends CamelTestSupport {
  @Test public void testOk() throws Exception {
    PurchaseOrder order=new PurchaseOrder();
    order.setName("Wine");
    order.setAmount(123.45);
    order.setPrice(2.22);
    MockEndpoint result=getMockEndpoint("mock:wine");
    result.expectedBodiesReceived(order);
    template.sendBody("jms:queue:in","<purchaseOrder name='Wine' amount='123.45' price='2.22'/>");
    assertMockEndpointsSatisfied();
  }
  @Test public void testUnmarshalError() throws Exception {
    MockEndpoint error=getMockEndpoint("mock:error");
    error.expectedBodiesReceived("<foo/>");
    getMockEndpoint("mock:invalid").expectedMessageCount(0);
    getMockEndpoint("mock:result").expectedMessageCount(0);
    template.sendBody("jms:queue:in","<foo/>");
    assertMockEndpointsSatisfied();
  }
  @Test public void testNotWine() throws Exception {
    PurchaseOrder order=new PurchaseOrder();
    order.setName("Beer");
    order.setAmount(2);
    order.setPrice(1.99);
    MockEndpoint error=getMockEndpoint("mock:invalid");
    error.expectedBodiesReceived(order);
    getMockEndpoint("mock:error").expectedMessageCount(0);
    getMockEndpoint("mock:result").expectedMessageCount(0);
    template.sendBody("jms:queue:in","<purchaseOrder name='Beer' amount='2.0' price='1.99'/>");
    assertMockEndpointsSatisfied();
  }
  @Override protected Context createJndiContext() throws Exception {
    JndiContext answer=new JndiContext();
    ConnectionFactory connectionFactory=CamelJmsTestHelper.createConnectionFactory();
    JmsComponent amq=jmsComponentAutoAcknowledge(connectionFactory);
    amq.setCamelContext(context);
    answer.bind("jms",amq);
    return answer;
  }
  @Override protected RouteBuilder createRouteBuilder() throws Exception {
    return new RouteBuilder(){
      @Override public void configure() throws Exception {
        errorHandler(deadLetterChannel("jms:queue:error").redeliveryDelay(0));
        onException(InvalidOrderException.class).maximumRedeliveries(0).handled(true).to("jms:queue:invalid");
        DataFormat jaxb=new JaxbDataFormat("org.apache.camel.itest.jms");
        from("jms:queue:in").unmarshal(jaxb).choice().when().method(JmsJaxbTest.class,"isWine").to("jms:queue:wine").otherwise().throwException(new InvalidOrderException("We only like wine")).end();
        from("jms:queue:wine").to("mock:wine");
        from("jms:queue:error").to("mock:error");
        from("jms:queue:invalid").to("mock:invalid");
      }
    }
;
  }
  public static boolean isWine(  PurchaseOrder order){
    return "Wine".equalsIgnoreCase(order.getName());
  }
}
