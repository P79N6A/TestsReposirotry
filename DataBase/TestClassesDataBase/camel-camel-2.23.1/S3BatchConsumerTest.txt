public class S3BatchConsumerTest extends CamelTestSupport {
  @EndpointInject(uri="mock:result") private MockEndpoint mock;
  @Test public void receiveBatch() throws Exception {
    mock.expectedMessageCount(5);
    assertMockEndpointsSatisfied();
    mock.message(0).exchangeProperty(Exchange.BATCH_INDEX).isEqualTo(0);
    mock.message(1).exchangeProperty(Exchange.BATCH_INDEX).isEqualTo(1);
    mock.message(2).exchangeProperty(Exchange.BATCH_INDEX).isEqualTo(2);
    mock.message(3).exchangeProperty(Exchange.BATCH_INDEX).isEqualTo(3);
    mock.message(4).exchangeProperty(Exchange.BATCH_INDEX).isEqualTo(4);
    mock.message(0).exchangeProperty(Exchange.BATCH_COMPLETE).isEqualTo(false);
    mock.message(1).exchangeProperty(Exchange.BATCH_COMPLETE).isEqualTo(false);
    mock.message(2).exchangeProperty(Exchange.BATCH_COMPLETE).isEqualTo(false);
    mock.message(3).exchangeProperty(Exchange.BATCH_COMPLETE).isEqualTo(false);
    mock.message(3).exchangeProperty(Exchange.BATCH_COMPLETE).isEqualTo(false);
    mock.message(4).exchangeProperty(Exchange.BATCH_COMPLETE).isEqualTo(true);
    mock.expectedPropertyReceived(Exchange.BATCH_SIZE,5);
  }
  @Override protected JndiRegistry createRegistry() throws Exception {
    JndiRegistry registry=super.createRegistry();
    AmazonS3ClientMock clientMock=new AmazonS3ClientMock();
    for (int counter=0; counter < 6; counter++) {
      S3Object s3Object=new S3Object();
      s3Object.setBucketName("mycamelbucket");
      s3Object.setKey("counter-" + counter);
      clientMock.objects.add(s3Object);
    }
    registry.bind("amazonS3Client",clientMock);
    return registry;
  }
  @Override protected RouteBuilder createRouteBuilder() throws Exception {
    return new RouteBuilder(){
      @Override public void configure() throws Exception {
        from("aws-s3://mycamelbucket?amazonS3Client=#amazonS3Client&region=us-west-1&delay=5000&maxMessagesPerPoll=5").to("mock:result");
      }
    }
;
  }
}
