/** 
 * Tests https://issues.apache.org/jira/browse/CAMEL-10409
 */
public class NettyRequestManagementTest extends BaseNettyTest {
  @Test public void testBufferManagement(){
    Exchange exchange=template.send("direct:start",e -> e.getIn().setBody("World"));
    Assert.assertEquals("Bye World",exchange.getIn().getBody(String.class));
    exchange.getProperty("buffer",ByteBuf.class).release();
  }
  private static void requestBuffer(  Exchange exchange){
    exchange.setProperty("buffer",PooledByteBufAllocator.DEFAULT.directBuffer());
  }
  @Override protected RouteBuilder createRouteBuilder() throws Exception {
    return new RouteBuilder(){
      @Override public void configure() throws Exception {
        from("netty4-http:http://0.0.0.0:{{port}}/foo").transform(body().prepend("Bye "));
        from("direct:start").to("netty4-http:http://localhost:{{port}}/foo?synchronous=true").process(NettyRequestManagementTest::requestBuffer);
      }
    }
;
  }
}
