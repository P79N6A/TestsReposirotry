/** 
 * @version 
 */
public class LoopTest extends ContextTestSupport {
  MockEndpoint resultEndpoint;
  @Test public void testCounterLoop() throws Exception {
    performLoopTest("direct:a",8);
  }
  @Test public void testExpressionLoop() throws Exception {
    performLoopTest("direct:b",6);
  }
  @Test public void testExpressionClauseLoop() throws Exception {
    performLoopTest("direct:c",4);
  }
  @Test public void testLoopAsBlock() throws Exception {
    MockEndpoint lastEndpoint=resolveMandatoryEndpoint("mock:last",MockEndpoint.class);
    lastEndpoint.expectedMessageCount(1);
    performLoopTest("direct:d",2);
    lastEndpoint.assertIsSatisfied();
  }
  @Test public void testLoopWithInvalidExpression() throws Exception {
    try {
      performLoopTest("direct:b",4,"invalid");
      fail("Exception expected for invalid expression");
    }
 catch (    RuntimeCamelException e) {
    }
  }
  @Test public void testLoopProperties() throws Exception {
    performLoopTest("direct:e",10);
  }
  private void performLoopTest(  String endpointUri,  int expectedIterations,  String header) throws InterruptedException {
    resultEndpoint.expectedMessageCount(expectedIterations);
    template.sendBodyAndHeader(endpointUri,"<hello times='4'>world!</hello>","loop",header);
    resultEndpoint.assertIsSatisfied();
  }
  private void performLoopTest(  String endpointUri,  int expectedIterations) throws InterruptedException {
    performLoopTest(endpointUri,expectedIterations,"6");
  }
  @Override @Before public void setUp() throws Exception {
    super.setUp();
    resultEndpoint=resolveMandatoryEndpoint("mock:result",MockEndpoint.class);
    resultEndpoint.reset();
  }
  protected RouteBuilder createRouteBuilder(){
    final Processor loopTest=new LoopTestProcessor(10);
    return new RouteBuilder(){
      public void configure(){
        from("direct:a").loop(8).to("mock:result");
        from("direct:b").loop(header("loop")).to("mock:result");
        from("direct:c").loop().xpath("/hello/@times").to("mock:result");
        from("direct:d").loop(2).to("mock:result").end().to("mock:last");
        from("direct:e").loop(10).process(loopTest).to("mock:result");
      }
    }
;
  }
}
