@ContextConfiguration public class BindySimpleCsvOneToManyMarshallTest extends AbstractJUnit4SpringContextTests {
  private List<Map<String,Object>> models=new ArrayList<>();
  private String result="Charles,Moulliard,Camel in Action 1,2010,43\r\n" + "Charles,Moulliard,Camel in Action 2,2012,43\r\n" + "Charles,Moulliard,Camel in Action 3,2013,43\r\n"+ "Charles,Moulliard,Camel in Action 4,,43\r\n";
  @Produce(uri="direct:start") private ProducerTemplate template;
  @EndpointInject(uri="mock:result") private MockEndpoint resultEndpoint;
  @Test public void testMarshallMessage() throws Exception {
    resultEndpoint.expectedBodiesReceived(result);
    template.sendBody(generateModel());
    resultEndpoint.assertIsSatisfied();
  }
  public List<Map<String,Object>> generateModel(){
    Author author;
    Book book;
    Map<String,Object> model=new HashMap<>();
    List<Book> books=new ArrayList<>();
    author=new Author();
    author.setFirstName("Charles");
    author.setLastName("Moulliard");
    author.setAge("43");
    book=new Book();
    book.setTitle("Camel in Action 1");
    book.setYear("2010");
    books.add(book);
    book=new Book();
    book.setTitle("Camel in Action 2");
    book.setYear("2012");
    books.add(book);
    book=new Book();
    book.setTitle("Camel in Action 3");
    book.setYear("2013");
    books.add(book);
    book=new Book();
    book.setTitle("Camel in Action 4");
    book.setYear(null);
    books.add(book);
    author.setBooks(books);
    model.put(author.getClass().getName(),author);
    models.add(model);
    return models;
  }
public static class ContextConfig extends RouteBuilder {
    BindyCsvDataFormat camelDataFormat=new BindyCsvDataFormat(org.apache.camel.dataformat.bindy.model.simple.onetomany.Author.class);
    public void configure(){
      from("direct:start").marshal(camelDataFormat).to("mock:result");
    }
  }
}
