/** 
 * @version 
 */
public class JmsDiscoveryTest extends CamelTestSupport {
  protected MyRegistry registry=new MyRegistry();
  @Test public void testDiscovery() throws Exception {
    MockEndpoint mock=getMockEndpoint("mock:result");
    mock.expectedMinimumMessageCount(1);
    mock.setResultWaitTime(5000);
    context.getShutdownStrategy().setTimeout(5);
    assertMockEndpointsSatisfied();
    Thread.sleep(1000);
    Map<String,Map<?,?>> map=new HashMap<>(registry.getServices());
    assertTrue("There should be 1 or more, was: " + map.size(),map.size() >= 1);
  }
  protected CamelContext createCamelContext() throws Exception {
    CamelContext camelContext=super.createCamelContext();
    ConnectionFactory connectionFactory=CamelJmsTestHelper.createConnectionFactory();
    camelContext.addComponent("activemq",jmsComponentAutoAcknowledge(connectionFactory));
    return camelContext;
  }
  @Override protected Context createJndiContext() throws Exception {
    Context context=super.createJndiContext();
    context.bind("service1",new MyService("service1"));
    context.bind("registry",registry);
    return context;
  }
  protected RouteBuilder createRouteBuilder() throws Exception {
    return new RouteBuilder(){
      public void configure() throws Exception {
        from("timer:heartbeats?delay=100").to("bean:service1?method=status").to("activemq:topic:registry.heartbeats");
        from("activemq:topic:registry.heartbeats").shutdownRoute(ShutdownRoute.Defer).to("bean:registry?method=onEvent","mock:result");
      }
    }
;
  }
}
