public class PreservePostFormUrlEncodedBodyTest extends BaseUndertowTest {
  @Test public void testSendToUndertow() throws Exception {
    Exchange exchange=template.request("http://localhost:{{port}}/myapp/myservice?query1=a&query2=b",new Processor(){
      public void process(      Exchange exchange) throws Exception {
        exchange.getIn().setBody("b1=x&b2=y");
        exchange.getIn().setHeader("content-type","application/x-www-form-urlencoded");
        exchange.getIn().setHeader(Exchange.HTTP_METHOD,HttpMethods.POST);
      }
    }
);
    String body=exchange.getOut().getBody(String.class);
    assertEquals("Request message is OK",body);
  }
  @Override protected RouteBuilder createRouteBuilder() throws Exception {
    return new RouteBuilder(){
      public void configure() throws Exception {
        from("undertow:http://localhost:{{port}}/myapp/myservice?map").process(new Processor(){
          public void process(          Exchange exchange) throws Exception {
            Map body=exchange.getIn().getBody(Map.class);
            assertNotNull(body);
            assertEquals("x",body.get("b1"));
            assertEquals("y",body.get("b2"));
            assertEquals("a",exchange.getIn().getHeader("query1"));
            assertEquals("b",exchange.getIn().getHeader("query2"));
            assertEquals("x",exchange.getIn().getHeader("b1"));
            assertEquals("y",exchange.getIn().getHeader("b2"));
            exchange.getOut().setBody("Request message is OK");
          }
        }
);
      }
    }
;
  }
}
