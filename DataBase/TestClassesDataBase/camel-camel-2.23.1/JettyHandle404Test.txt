/** 
 * Based on end user on forum how to get the 404 error code in his enrich aggregator
 * @version 
 */
public class JettyHandle404Test extends BaseJettyTest {
  public String getProducerUrl(){
    return "http://localhost:{{port}}/myserver?user=Camel";
  }
  @Test public void testSimulate404() throws Exception {
    MockEndpoint mock=getMockEndpoint("mock:result");
    mock.expectedBodiesReceived("Page not found");
    mock.expectedHeaderReceived(Exchange.HTTP_RESPONSE_CODE,404);
    template.sendBody("direct:start","Hello World");
    assertMockEndpointsSatisfied();
  }
  @Test public void testCustomerErrorHandler() throws Exception {
    String response=template.requestBody("http://localhost:{{port}}/myserver1?throwExceptionOnFailure=false",null,String.class);
    log.info("Response: {}",response);
    assertTrue("Get a wrong error message",response.indexOf("MyErrorHandler") > 0);
  }
  @Override protected RouteBuilder createRouteBuilder() throws Exception {
    return new RouteBuilder(){
      @Override public void configure() throws Exception {
        JettyHttpComponent jettyComponent=(JettyHttpComponent)context.getComponent("jetty");
        jettyComponent.setErrorHandler(new MyErrorHandler());
        errorHandler(noErrorHandler());
        from("direct:start").enrich("direct:tohttp",new AggregationStrategy(){
          public Exchange aggregate(          Exchange original,          Exchange resource){
            Integer code=resource.getIn().getHeader(Exchange.HTTP_RESPONSE_CODE,Integer.class);
            assertEquals(404,code.intValue());
            return resource;
          }
        }
).to("mock:result");
        from("direct:tohttp").doTry().to(getProducerUrl()).doCatch(HttpOperationFailedException.class).process(new Processor(){
          public void process(          Exchange exchange){
            HttpOperationFailedException cause=exchange.getProperty(Exchange.EXCEPTION_CAUGHT,HttpOperationFailedException.class);
            exchange.getOut().setHeader(Exchange.HTTP_RESPONSE_CODE,cause.getStatusCode());
            exchange.getOut().setBody(cause.getResponseBody());
          }
        }
).end();
        from("jetty://http://localhost:{{port}}/myserver").process(new Processor(){
          public void process(          Exchange exchange) throws Exception {
            exchange.getOut().setBody("Page not found");
            exchange.getOut().setHeader(Exchange.HTTP_RESPONSE_CODE,404);
          }
        }
);
      }
    }
;
  }
}
