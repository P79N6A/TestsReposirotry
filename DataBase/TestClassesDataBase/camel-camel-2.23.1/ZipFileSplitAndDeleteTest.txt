public class ZipFileSplitAndDeleteTest extends CamelTestSupport {
  @Override @Before public void setUp() throws Exception {
    deleteDirectory("target/testDeleteZipFileWhenUnmarshalWithDataFormat");
    deleteDirectory("target/testDeleteZipFileWhenUnmarshalWithSplitter");
    super.setUp();
  }
  @Test public void testDeleteZipFileWhenUnmarshalWithDataFormat() throws Exception {
    NotifyBuilder notify=new NotifyBuilder(context).from("file://target/" + "testDeleteZipFileWhenUnmarshalWithDataFormat").whenDone(1).create();
    getMockEndpoint("mock:end").expectedMessageCount(2);
    String zipFile=createZipFile("testDeleteZipFileWhenUnmarshalWithDataFormat");
    assertMockEndpointsSatisfied();
    notify.matchesMockWaitTime();
    assertFalse("File should been deleted",new File(zipFile).exists());
  }
  @Test public void testDeleteZipFileWhenUnmarshalWithSplitter() throws Exception {
    NotifyBuilder notify=new NotifyBuilder(context).from("file://target/" + "testDeleteZipFileWhenUnmarshalWithSplitter").whenDone(1).create();
    getMockEndpoint("mock:end").expectedMessageCount(2);
    String zipFile=createZipFile("testDeleteZipFileWhenUnmarshalWithSplitter");
    assertMockEndpointsSatisfied();
    notify.matchesMockWaitTime();
    assertFalse("File should been deleted",new File(zipFile).exists());
  }
  @Override protected RoutesBuilder createRouteBuilder() throws Exception {
    return new RouteBuilder(){
      @Override public void configure() throws Exception {
        ZipFileDataFormat dataFormat=new ZipFileDataFormat();
        dataFormat.setUsingIterator(true);
        from("file://target/testDeleteZipFileWhenUnmarshalWithDataFormat?delete=true").unmarshal(dataFormat).split(bodyAs(Iterator.class)).streaming().convertBodyTo(String.class).to("mock:end").end();
        from("file://target/testDeleteZipFileWhenUnmarshalWithSplitter?delete=true").split(new ZipSplitter()).streaming().convertBodyTo(String.class).to("mock:end").end();
      }
    }
;
  }
  private String createZipFile(  String folder) throws IOException {
    Path source=Paths.get("src/test/resources/data.zip");
    Path target=Paths.get("target" + File.separator + folder+ File.separator+ "data.zip");
    target.toFile().getParentFile().mkdirs();
    Path copy=Files.copy(source,target,StandardCopyOption.REPLACE_EXISTING);
    return copy.toAbsolutePath().toString();
  }
}
