@RunWith(SpringJUnit4ClassRunner.class) @ContextConfiguration(locations={"/org/apache/camel/component/netty4/http/SpringNettyHttpBasicAuthTest.xml"}) public class SpringNettyHttpBasicAuthTest extends Assert {
  @Produce private ProducerTemplate template;
  @EndpointInject(uri="mock:input") private MockEndpoint mockEndpoint;
  private Integer port;
  public Integer getPort(){
    return port;
  }
  @Resource(name="dynaPort") public void setPort(  Integer port){
    this.port=port;
  }
  @BeforeClass public static void setUpJaas() throws Exception {
    System.setProperty("java.security.auth.login.config","src/test/resources/myjaas.config");
  }
  @AfterClass public static void tearDownJaas() throws Exception {
    System.clearProperty("java.security.auth.login.config");
  }
  @Test public void testAdminAuth() throws Exception {
    mockEndpoint.reset();
    mockEndpoint.expectedBodiesReceived("Hello Public","Hello Foo","Hello Admin");
    String out=template.requestBody("netty4-http:http://localhost:" + port + "/foo/public/welcome","Hello Public",String.class);
    assertEquals("Bye /foo/public/welcome",out);
    String auth="Basic c2NvdHQ6c2VjcmV0";
    out=template.requestBodyAndHeader("netty4-http:http://localhost:" + port + "/foo","Hello Foo","Authorization",auth,String.class);
    assertEquals("Bye /foo",out);
    out=template.requestBodyAndHeader("netty4-http:http://localhost:" + port + "/foo/admin/users","Hello Admin","Authorization",auth,String.class);
    assertEquals("Bye /foo/admin/users",out);
    mockEndpoint.assertIsSatisfied();
    try {
      template.requestBody("netty4-http:http://localhost:" + port + "/foo","Hello Foo",String.class);
      fail("Should send back 401");
    }
 catch (    CamelExecutionException e) {
      NettyHttpOperationFailedException cause=(NettyHttpOperationFailedException)e.getCause();
      assertEquals(401,cause.getStatusCode());
    }
  }
  @Test public void testGuestAuth() throws Exception {
    String auth="Basic Z3Vlc3Q6c2VjcmV0";
    String out=template.requestBodyAndHeader("netty4-http:http://localhost:" + port + "/foo/guest/hello","Hello Guest","Authorization",auth,String.class);
    assertEquals("Bye /foo/guest/hello",out);
    out=template.requestBodyAndHeader("netty4-http:http://localhost:" + port + "/foo","Hello Foo","Authorization",auth,String.class);
    assertEquals("Bye /foo",out);
    try {
      template.requestBodyAndHeader("netty4-http:http://localhost:" + port + "/foo/admin/users","Hello Admin","Authorization",auth,String.class);
      fail("Should send back 401");
    }
 catch (    CamelExecutionException e) {
      NettyHttpOperationFailedException cause=(NettyHttpOperationFailedException)e.getCause();
      assertEquals(401,cause.getStatusCode());
    }
  }
}
