/** 
 * Unit testing FTP ant path matcher
 */
@ContextConfiguration public class SpringFileAntPathMatcherRemoteFileFilterTest extends AbstractJUnit4SpringContextTests {
  private static int ftpPort=AvailablePortFinder.getNextAvailable(20123);
static {
    System.setProperty("SpringFileAntPathMatcherRemoteFileFilterTest.ftpPort",Integer.toString(ftpPort));
  }
  protected FtpServer ftpServer;
  protected String expectedBody="Godday World";
  @Autowired protected ProducerTemplate template;
  @EndpointInject(ref="myFTPEndpoint") protected Endpoint inputFTP;
  @EndpointInject(uri="mock:result") protected MockEndpoint result;
  protected boolean canRunOnThisPlatform(){
    String os=System.getProperty("os.name");
    boolean aix=os.toLowerCase(Locale.ENGLISH).contains("aix");
    boolean windows=os.toLowerCase(Locale.ENGLISH).contains("windows");
    boolean solaris=os.toLowerCase(Locale.ENGLISH).contains("sunos");
    return !aix && !solaris && !windows;
  }
  @Test public void testAntPatchMatherFilter() throws Exception {
    if (!canRunOnThisPlatform()) {
      return;
    }
    result.expectedBodiesReceived(expectedBody);
    template.sendBodyAndHeader(inputFTP,"Hello World",Exchange.FILE_NAME,"hello.txt");
    template.sendBodyAndHeader(inputFTP,"Bye World",Exchange.FILE_NAME,"bye.xml");
    template.sendBodyAndHeader(inputFTP,"Bad world",Exchange.FILE_NAME,"subfolder/badday.txt");
    template.sendBodyAndHeader(inputFTP,"Day world",Exchange.FILE_NAME,"day.xml");
    template.sendBodyAndHeader(inputFTP,expectedBody,Exchange.FILE_NAME,"subfolder/foo/godday.txt");
    result.assertIsSatisfied();
  }
  @Before public void setUp() throws Exception {
    initFtpServer();
    ftpServer.start();
  }
  @After public void tearDown() throws Exception {
    ftpServer.stop();
    ftpServer=null;
  }
  protected void initFtpServer() throws Exception {
    FtpServerFactory serverFactory=new FtpServerFactory();
    File file=new File("src/test/resources/users.properties");
    UserManager uman=new PropertiesUserManager(new ClearTextPasswordEncryptor(),file,"admin");
    serverFactory.setUserManager(uman);
    NativeFileSystemFactory fsf=new NativeFileSystemFactory();
    fsf.setCreateHome(true);
    serverFactory.setFileSystem(fsf);
    ListenerFactory factory=new ListenerFactory();
    factory.setPort(ftpPort);
    serverFactory.addListener("default",factory.createListener());
    ftpServer=serverFactory.createServer();
  }
}
