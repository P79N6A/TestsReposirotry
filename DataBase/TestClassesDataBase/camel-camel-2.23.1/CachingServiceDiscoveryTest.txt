public class CachingServiceDiscoveryTest extends ContextTestSupport {
  @Test public void testCachingServiceDiscovery() throws Exception {
    StaticServiceDiscovery discovery=new StaticServiceDiscovery();
    CachingServiceDiscovery caching=CachingServiceDiscovery.wrap(discovery,50,TimeUnit.MILLISECONDS);
    discovery.addServer(new DefaultServiceDefinition("noname","localhost",1111));
    Assert.assertEquals(1,caching.getServices("noname").size());
    discovery.addServer(new DefaultServiceDefinition("noname","localhost",1112));
    Assert.assertEquals(1,caching.getServices("noname").size());
    Thread.sleep(100);
    Assert.assertEquals(2,caching.getServices("noname").size());
  }
  @Test public void testCachingServiceDiscoveryConfiguration() throws Exception {
    StaticServiceCallServiceDiscoveryConfiguration staticConf=new StaticServiceCallServiceDiscoveryConfiguration();
    staticConf.setServers(Arrays.asList("no-name@localhost:1111"));
    CachingServiceCallServiceDiscoveryConfiguration cachingConf=new CachingServiceCallServiceDiscoveryConfiguration();
    cachingConf.setServiceDiscoveryConfiguration(staticConf);
    cachingConf.setTimeout(50);
    cachingConf.setUnits(TimeUnit.MILLISECONDS);
    CachingServiceDiscovery caching=(CachingServiceDiscovery)cachingConf.newInstance(context);
    StaticServiceDiscovery delegate=(StaticServiceDiscovery)caching.getDelegate();
    Assert.assertEquals(1,caching.getServices("no-name").size());
    delegate.addServer("no-name@localhost:1112");
    Assert.assertEquals(1,caching.getServices("no-name").size());
    Thread.sleep(100);
    Assert.assertEquals(2,caching.getServices("no-name").size());
  }
}
