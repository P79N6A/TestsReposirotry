/** 
 * Unit test the cache when reloading .ftl files in the classpath
 */
public class FreemarkerContentCacheTest extends CamelTestSupport {
  @Override public boolean useJmx(){
    return true;
  }
  @Before public void setUp() throws Exception {
    super.setUp();
    template.sendBodyAndHeader("file://target/test-classes/org/apache/camel/component/freemarker?fileExist=Override","Hello ${headers.name}",Exchange.FILE_NAME,"hello.ftl");
  }
  @Test public void testNotCached() throws Exception {
    MockEndpoint mock=getMockEndpoint("mock:result");
    mock.expectedBodiesReceived("Hello London");
    template.sendBodyAndHeader("direct:a","Body","name","London");
    mock.assertIsSatisfied();
    template.sendBodyAndHeader("file://target/test-classes/org/apache/camel/component/freemarker?fileExist=Override","Bye ${headers.name}",Exchange.FILE_NAME,"hello.ftl");
    mock.reset();
    mock.expectedBodiesReceived("Bye Paris");
    template.sendBodyAndHeader("direct:a","Body","name","Paris");
    mock.assertIsSatisfied();
  }
  @Test public void testCached() throws Exception {
    MockEndpoint mock=getMockEndpoint("mock:result");
    mock.expectedBodiesReceived("Hello London");
    template.sendBodyAndHeader("direct:b","Body","name","London");
    mock.assertIsSatisfied();
    template.sendBodyAndHeader("file://target/test-classes/org/apache/camel/component/freemarker?fileExist=Override","Bye ${headers.name}",Exchange.FILE_NAME,"hello.ftl");
    mock.reset();
    mock.expectedBodiesReceived("Hello Paris");
    template.sendBodyAndHeader("direct:b","Body","name","Paris");
    mock.assertIsSatisfied();
  }
  @Test public void testTemplateUpdateDelay() throws Exception {
    MockEndpoint mock=getMockEndpoint("mock:result");
    mock.expectedBodiesReceived("Hello London");
    template.sendBodyAndHeader("direct:c","Body","name","London");
    mock.assertIsSatisfied();
    template.sendBodyAndHeader("file://target/test-classes/org/apache/camel/component/freemarker?fileExist=Override","Bye ${headers.name}",Exchange.FILE_NAME,"hello.ftl");
    mock.reset();
    mock.expectedBodiesReceived("Hello Paris");
    template.sendBodyAndHeader("direct:c","Body","name","Paris");
    mock.assertIsSatisfied();
    Thread.sleep(2000);
    template.sendBodyAndHeader("file://target/test-classes/org/apache/camel/component/freemarker?fileExist=Override","Bye ${headers.name}",Exchange.FILE_NAME,"hello.ftl");
    mock.reset();
    mock.expectedBodiesReceived("Bye Paris");
    template.sendBodyAndHeader("direct:c","Body","name","Paris");
    mock.assertIsSatisfied();
  }
  @Test public void testClearCacheViaJmx() throws Exception {
    MockEndpoint mock=getMockEndpoint("mock:result");
    mock.expectedBodiesReceived("Hello London");
    template.sendBodyAndHeader("direct:b","Body","name","London");
    mock.assertIsSatisfied();
    template.sendBodyAndHeader("file://target/test-classes/org/apache/camel/component/freemarker?fileExist=Override","Bye ${headers.name}",Exchange.FILE_NAME,"hello.ftl");
    mock.reset();
    mock.expectedBodiesReceived("Hello Paris");
    template.sendBodyAndHeader("direct:b","Body","name","Paris");
    mock.assertIsSatisfied();
    MBeanServer mbeanServer=context.getManagementStrategy().getManagementAgent().getMBeanServer();
    Set<ObjectName> objNameSet=mbeanServer.queryNames(new ObjectName("org.apache.camel:type=endpoints,name=\"freemarker:*contentCache=true*\",*"),null);
    ObjectName managedObjName=new ArrayList<>(objNameSet).get(0);
    mbeanServer.invoke(managedObjName,"clearContentCache",null,null);
    template.sendBodyAndHeader("file://target/test-classes/org/apache/camel/component/freemarker?fileExist=Override","Bye ${headers.name}",Exchange.FILE_NAME,"hello.ftl");
    mock.reset();
    mock.expectedBodiesReceived("Bye Paris");
    template.sendBodyAndHeader("direct:b","Body","name","Paris");
    mock.assertIsSatisfied();
    template.sendBodyAndHeader("file://target/test-classes/org/apache/camel/component/freemarker?fileExist=Override","Hello ${headers.name}",Exchange.FILE_NAME,"hello.ftl");
    mock.reset();
    mock.expectedBodiesReceived("Bye Paris");
    template.sendBodyAndHeader("direct:b","Body","name","Paris");
    mock.assertIsSatisfied();
  }
  protected RouteBuilder createRouteBuilder() throws Exception {
    return new RouteBuilder(){
      public void configure() throws Exception {
        from("direct:a").to("freemarker://org/apache/camel/component/freemarker/hello.ftl?contentCache=false").to("mock:result");
        from("direct:b").to("freemarker://org/apache/camel/component/freemarker/hello.ftl?contentCache=true").to("mock:result");
        from("direct:c").to("freemarker://org/apache/camel/component/freemarker/hello.ftl?contentCache=true&templateUpdateDelay=1").to("mock:result");
      }
    }
;
  }
}
