private static class IdentityConfigurer implements MockServerConfigurer, WebTestClientConfigurer {
  private final IdentityFilter filter;
  public IdentityConfigurer(  String userName){
    this.filter=new IdentityFilter(userName);
  }
  @Override public void beforeServerCreated(  WebHttpHandlerBuilder builder){
    builder.filters(filters -> filters.add(0,this.filter));
  }
  @Override public void afterConfigurerAdded(  WebTestClient.Builder builder,  @Nullable WebHttpHandlerBuilder httpHandlerBuilder,  @Nullable ClientHttpConnector connector){
    Assert.notNull(httpHandlerBuilder,"Not a mock server");
    httpHandlerBuilder.filters(filters -> {
      filters.removeIf(filter -> filter instanceof IdentityFilter);
      filters.add(0,this.filter);
    }
);
  }
}
