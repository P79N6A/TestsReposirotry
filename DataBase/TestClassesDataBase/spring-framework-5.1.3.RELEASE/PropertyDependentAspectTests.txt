/** 
 * Check that an aspect that depends on another bean, where the referenced bean itself is advised by the same aspect, works correctly.
 * @author Ramnivas Laddad
 * @author Juergen Hoeller
 * @author Chris Beams
 */
@SuppressWarnings("resource") public class PropertyDependentAspectTests {
  @Test public void propertyDependentAspectWithPropertyDeclaredBeforeAdvice() throws Exception {
    checkXmlAspect(getClass().getSimpleName() + "-before.xml");
  }
  @Test public void propertyDependentAspectWithPropertyDeclaredAfterAdvice() throws Exception {
    checkXmlAspect(getClass().getSimpleName() + "-after.xml");
  }
  @Test public void propertyDependentAtAspectJAspectWithPropertyDeclaredBeforeAdvice() throws Exception {
    checkAtAspectJAspect(getClass().getSimpleName() + "-atAspectJ-before.xml");
  }
  @Test public void propertyDependentAtAspectJAspectWithPropertyDeclaredAfterAdvice() throws Exception {
    checkAtAspectJAspect(getClass().getSimpleName() + "-atAspectJ-after.xml");
  }
  private void checkXmlAspect(  String appContextFile){
    ApplicationContext context=new ClassPathXmlApplicationContext(appContextFile,getClass());
    ICounter counter=(ICounter)context.getBean("counter");
    assertTrue("Proxy didn't get created",counter instanceof Advised);
    counter.increment();
    JoinPointMonitorAspect callCountingAspect=(JoinPointMonitorAspect)context.getBean("monitoringAspect");
    assertEquals("Advise didn't get executed",1,callCountingAspect.beforeExecutions);
    assertEquals("Advise didn't get executed",1,callCountingAspect.aroundExecutions);
  }
  private void checkAtAspectJAspect(  String appContextFile){
    ApplicationContext context=new ClassPathXmlApplicationContext(appContextFile,getClass());
    ICounter counter=(ICounter)context.getBean("counter");
    assertTrue("Proxy didn't get created",counter instanceof Advised);
    counter.increment();
    JoinPointMonitorAtAspectJAspect callCountingAspect=(JoinPointMonitorAtAspectJAspect)context.getBean("monitoringAspect");
    assertEquals("Advise didn't get executed",1,callCountingAspect.beforeExecutions);
    assertEquals("Advise didn't get executed",1,callCountingAspect.aroundExecutions);
  }
}
