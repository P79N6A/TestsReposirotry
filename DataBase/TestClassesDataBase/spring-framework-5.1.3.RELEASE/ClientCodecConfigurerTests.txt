/** 
 * Unit tests for  {@link ClientCodecConfigurer}.
 * @author Rossen Stoyanchev
 */
public class ClientCodecConfigurerTests {
  private final ClientCodecConfigurer configurer=new DefaultClientCodecConfigurer();
  private final AtomicInteger index=new AtomicInteger(0);
  @Test public void defaultReaders(){
    List<HttpMessageReader<?>> readers=this.configurer.getReaders();
    assertEquals(12,readers.size());
    assertEquals(ByteArrayDecoder.class,getNextDecoder(readers).getClass());
    assertEquals(ByteBufferDecoder.class,getNextDecoder(readers).getClass());
    assertEquals(DataBufferDecoder.class,getNextDecoder(readers).getClass());
    assertEquals(ResourceDecoder.class,getNextDecoder(readers).getClass());
    assertStringDecoder(getNextDecoder(readers),true);
    assertEquals(ProtobufDecoder.class,getNextDecoder(readers).getClass());
    assertEquals(FormHttpMessageReader.class,readers.get(this.index.getAndIncrement()).getClass());
    assertEquals(Jackson2JsonDecoder.class,getNextDecoder(readers).getClass());
    assertEquals(Jackson2SmileDecoder.class,getNextDecoder(readers).getClass());
    assertEquals(Jaxb2XmlDecoder.class,getNextDecoder(readers).getClass());
    assertSseReader(readers);
    assertStringDecoder(getNextDecoder(readers),false);
  }
  @Test public void defaultWriters(){
    List<HttpMessageWriter<?>> writers=this.configurer.getWriters();
    assertEquals(11,writers.size());
    assertEquals(ByteArrayEncoder.class,getNextEncoder(writers).getClass());
    assertEquals(ByteBufferEncoder.class,getNextEncoder(writers).getClass());
    assertEquals(DataBufferEncoder.class,getNextEncoder(writers).getClass());
    assertEquals(ResourceHttpMessageWriter.class,writers.get(index.getAndIncrement()).getClass());
    assertStringEncoder(getNextEncoder(writers),true);
    assertEquals(MultipartHttpMessageWriter.class,writers.get(this.index.getAndIncrement()).getClass());
    assertEquals(ProtobufHttpMessageWriter.class,writers.get(index.getAndIncrement()).getClass());
    assertEquals(Jackson2JsonEncoder.class,getNextEncoder(writers).getClass());
    assertEquals(Jackson2SmileEncoder.class,getNextEncoder(writers).getClass());
    assertEquals(Jaxb2XmlEncoder.class,getNextEncoder(writers).getClass());
    assertStringEncoder(getNextEncoder(writers),false);
  }
  @Test public void jackson2EncoderOverride(){
    Jackson2JsonDecoder decoder=new Jackson2JsonDecoder();
    this.configurer.defaultCodecs().jackson2JsonDecoder(decoder);
    assertSame(decoder,this.configurer.getReaders().stream().filter(reader -> ServerSentEventHttpMessageReader.class.equals(reader.getClass())).map(reader -> (ServerSentEventHttpMessageReader)reader).findFirst().map(ServerSentEventHttpMessageReader::getDecoder).filter(e -> e == decoder).orElse(null));
  }
  private Decoder<?> getNextDecoder(  List<HttpMessageReader<?>> readers){
    HttpMessageReader<?> reader=readers.get(this.index.getAndIncrement());
    assertEquals(DecoderHttpMessageReader.class,reader.getClass());
    return ((DecoderHttpMessageReader<?>)reader).getDecoder();
  }
  private Encoder<?> getNextEncoder(  List<HttpMessageWriter<?>> writers){
    HttpMessageWriter<?> writer=writers.get(this.index.getAndIncrement());
    assertEquals(EncoderHttpMessageWriter.class,writer.getClass());
    return ((EncoderHttpMessageWriter<?>)writer).getEncoder();
  }
  @SuppressWarnings("unchecked") private void assertStringDecoder(  Decoder<?> decoder,  boolean textOnly){
    assertEquals(StringDecoder.class,decoder.getClass());
    assertTrue(decoder.canDecode(forClass(String.class),MimeTypeUtils.TEXT_PLAIN));
    assertEquals(!textOnly,decoder.canDecode(forClass(String.class),MediaType.TEXT_EVENT_STREAM));
    Flux<String> decoded=(Flux<String>)decoder.decode(Flux.just(new DefaultDataBufferFactory().wrap("line1\nline2".getBytes(StandardCharsets.UTF_8))),ResolvableType.forClass(String.class),MimeTypeUtils.TEXT_PLAIN,Collections.emptyMap());
    assertEquals(Arrays.asList("line1","line2"),decoded.collectList().block(Duration.ZERO));
  }
  private void assertStringEncoder(  Encoder<?> encoder,  boolean textOnly){
    assertEquals(CharSequenceEncoder.class,encoder.getClass());
    assertTrue(encoder.canEncode(forClass(String.class),MimeTypeUtils.TEXT_PLAIN));
    assertEquals(!textOnly,encoder.canEncode(forClass(String.class),MediaType.TEXT_EVENT_STREAM));
  }
  private void assertSseReader(  List<HttpMessageReader<?>> readers){
    HttpMessageReader<?> reader=readers.get(this.index.getAndIncrement());
    assertEquals(ServerSentEventHttpMessageReader.class,reader.getClass());
    Decoder<?> decoder=((ServerSentEventHttpMessageReader)reader).getDecoder();
    assertNotNull(decoder);
    assertEquals(Jackson2JsonDecoder.class,decoder.getClass());
  }
}
