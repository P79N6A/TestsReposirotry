/** 
 * @author Rod Johnson
 * @author Juergen Hoeller
 * @author Chris Beams
 * @since 21.05.2003
 */
public class LocalStatelessSessionProxyFactoryBeanTests {
  @Test public void testInvokesMethod() throws Exception {
    final int value=11;
    final String jndiName="foo";
    MyEjb myEjb=mock(MyEjb.class);
    given(myEjb.getValue()).willReturn(value);
    final MyHome home=mock(MyHome.class);
    given(home.create()).willReturn(myEjb);
    JndiTemplate jt=new JndiTemplate(){
      @Override public Object lookup(      String name) throws NamingException {
        assertTrue(name.equals("java:comp/env/" + jndiName));
        return home;
      }
    }
;
    LocalStatelessSessionProxyFactoryBean fb=new LocalStatelessSessionProxyFactoryBean();
    fb.setJndiName(jndiName);
    fb.setResourceRef(true);
    fb.setBusinessInterface(MyBusinessMethods.class);
    fb.setJndiTemplate(jt);
    fb.afterPropertiesSet();
    MyBusinessMethods mbm=(MyBusinessMethods)fb.getObject();
    assertTrue(Proxy.isProxyClass(mbm.getClass()));
    assertTrue(mbm.getValue() == value);
    verify(myEjb).remove();
  }
  @Test public void testInvokesMethodOnEjb3StyleBean() throws Exception {
    final int value=11;
    final String jndiName="foo";
    final MyEjb myEjb=mock(MyEjb.class);
    given(myEjb.getValue()).willReturn(value);
    JndiTemplate jt=new JndiTemplate(){
      @Override public Object lookup(      String name) throws NamingException {
        assertTrue(name.equals("java:comp/env/" + jndiName));
        return myEjb;
      }
    }
;
    LocalStatelessSessionProxyFactoryBean fb=new LocalStatelessSessionProxyFactoryBean();
    fb.setJndiName(jndiName);
    fb.setResourceRef(true);
    fb.setBusinessInterface(MyBusinessMethods.class);
    fb.setJndiTemplate(jt);
    fb.afterPropertiesSet();
    MyBusinessMethods mbm=(MyBusinessMethods)fb.getObject();
    assertTrue(Proxy.isProxyClass(mbm.getClass()));
    assertTrue(mbm.getValue() == value);
  }
  @Test public void testCreateException() throws Exception {
    final String jndiName="foo";
    final CreateException cex=new CreateException();
    final MyHome home=mock(MyHome.class);
    given(home.create()).willThrow(cex);
    JndiTemplate jt=new JndiTemplate(){
      @Override public Object lookup(      String name) throws NamingException {
        assertTrue(name.equals(jndiName));
        return home;
      }
    }
;
    LocalStatelessSessionProxyFactoryBean fb=new LocalStatelessSessionProxyFactoryBean();
    fb.setJndiName(jndiName);
    fb.setResourceRef(false);
    fb.setBusinessInterface(MyBusinessMethods.class);
    assertEquals(fb.getBusinessInterface(),MyBusinessMethods.class);
    fb.setJndiTemplate(jt);
    fb.afterPropertiesSet();
    MyBusinessMethods mbm=(MyBusinessMethods)fb.getObject();
    assertTrue(Proxy.isProxyClass(mbm.getClass()));
    try {
      mbm.getValue();
      fail("Should have failed to create EJB");
    }
 catch (    EjbAccessException ex) {
      assertSame(cex,ex.getCause());
    }
  }
  @Test public void testNoBusinessInterfaceSpecified() throws Exception {
    final String jndiName="foo";
    final MyHome home=mock(MyHome.class);
    JndiTemplate jt=new JndiTemplate(){
      @Override public Object lookup(      String name) throws NamingException {
        assertTrue(name.equals("java:comp/env/" + jndiName));
        return home;
      }
    }
;
    LocalStatelessSessionProxyFactoryBean fb=new LocalStatelessSessionProxyFactoryBean();
    fb.setJndiName(jndiName);
    fb.setResourceRef(true);
    fb.setJndiTemplate(jt);
    assertTrue(fb.isSingleton());
    try {
      fb.afterPropertiesSet();
      fail("Should have failed to create EJB");
    }
 catch (    IllegalArgumentException ex) {
      assertTrue(ex.getMessage().indexOf("businessInterface") != 1);
    }
    verifyZeroInteractions(home);
  }
public interface MyHome extends EJBLocalHome {
    MyBusinessMethods create() throws CreateException ;
  }
public interface MyBusinessMethods {
    int getValue();
  }
public interface MyEjb extends EJBLocalObject, MyBusinessMethods {
  }
}
