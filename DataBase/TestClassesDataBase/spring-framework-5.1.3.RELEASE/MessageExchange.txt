/** 
 * Holds a message as well as expected and actual messages matched against expectations.
 */
private static class MessageExchange {
  private final Message<?> message;
  private final MessageMatcher[] expected;
  private final Message<?>[] actual;
  public MessageExchange(  Message<?> message,  MessageMatcher... expected){
    this.message=message;
    this.expected=expected;
    this.actual=new Message<?>[expected.length];
  }
  public boolean matchMessage(  Message<?> message){
    for (int i=0; i < this.expected.length; i++) {
      if (this.expected[i].match(message)) {
        this.actual[i]=message;
        return true;
      }
    }
    return false;
  }
  @Override public String toString(){
    return "Forwarded message:\n" + this.message + "\n"+ "Should receive back:\n"+ Arrays.toString(this.expected)+ "\n"+ "Actually received:\n"+ Arrays.toString(this.actual)+ "\n";
  }
}
