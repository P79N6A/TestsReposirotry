public class TestElephasImport extends BaseSparkTest {
  @Test public void testElephasSequentialImport() throws Exception {
    String modelPath="modelimport/elephas/elephas_sequential.h5";
    SparkDl4jMultiLayer model=importElephasSequential(sc,modelPath);
    assertTrue(model.getTrainingMaster() instanceof ParameterAveragingTrainingMaster);
  }
  @Test public void testElephasSequentialImportAsync() throws Exception {
    String modelPath="modelimport/elephas/elephas_sequential_async.h5";
    SparkDl4jMultiLayer model=importElephasSequential(sc,modelPath);
    assertTrue(model.getTrainingMaster() instanceof SharedTrainingMaster);
  }
  private SparkDl4jMultiLayer importElephasSequential(  JavaSparkContext sc,  String modelPath) throws Exception {
    ClassPathResource modelResource=new ClassPathResource(modelPath,TestElephasImport.class.getClassLoader());
    File modelFile=createTempFile("tempModel","h5");
    Files.copy(modelResource.getInputStream(),modelFile.toPath(),StandardCopyOption.REPLACE_EXISTING);
    SparkDl4jMultiLayer model=ElephasModelImport.importElephasSequentialModelAndWeights(sc,modelFile.getAbsolutePath());
    return model;
  }
  @Test public void testElephasModelImport() throws Exception {
    String modelPath="modelimport/elephas/elephas_model.h5";
    SparkComputationGraph model=importElephasModel(sc,modelPath);
    assertTrue(model.getTrainingMaster() instanceof ParameterAveragingTrainingMaster);
  }
  @Test public void testElephasJavaAveragingModelImport() throws Exception {
    String modelPath="modelimport/elephas/java_param_averaging_model.h5";
    SparkComputationGraph model=importElephasModel(sc,modelPath);
    assert model.getTrainingMaster() instanceof ParameterAveragingTrainingMaster;
  }
  @Test public void testElephasJavaSharingModelImport() throws Exception {
    String modelPath="modelimport/elephas/java_param_sharing_model.h5";
    SparkComputationGraph model=importElephasModel(sc,modelPath);
    assert model.getTrainingMaster() instanceof SharedTrainingMaster;
  }
  @Test public void testElephasModelImportAsync() throws Exception {
    String modelPath="modelimport/elephas/elephas_model_async.h5";
    SparkComputationGraph model=importElephasModel(sc,modelPath);
    assertTrue(model.getTrainingMaster() instanceof SharedTrainingMaster);
  }
  private SparkComputationGraph importElephasModel(  JavaSparkContext sc,  String modelPath) throws Exception {
    ClassPathResource modelResource=new ClassPathResource(modelPath,TestElephasImport.class.getClassLoader());
    File modelFile=createTempFile("tempModel","h5");
    Files.copy(modelResource.getInputStream(),modelFile.toPath(),StandardCopyOption.REPLACE_EXISTING);
    SparkComputationGraph model=ElephasModelImport.importElephasModelAndWeights(sc,modelFile.getAbsolutePath());
    return model;
  }
}
