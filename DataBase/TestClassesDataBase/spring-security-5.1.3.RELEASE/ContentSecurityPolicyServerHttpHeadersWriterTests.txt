/** 
 * Tests for  {@link ContentSecurityPolicyServerHttpHeadersWriter}.
 * @author Vedran Pavic
 */
public class ContentSecurityPolicyServerHttpHeadersWriterTests {
  private static final String DEFAULT_POLICY_DIRECTIVES="default-src 'self'";
  private ServerWebExchange exchange;
  private ContentSecurityPolicyServerHttpHeadersWriter writer;
  @Before public void setup(){
    this.exchange=MockServerWebExchange.from(MockServerHttpRequest.get("/"));
    this.writer=new ContentSecurityPolicyServerHttpHeadersWriter();
  }
  @Test public void writeHeadersWhenUsingDefaultsThenDoesNotWrite(){
    this.writer.writeHttpHeaders(this.exchange);
    HttpHeaders headers=this.exchange.getResponse().getHeaders();
    assertThat(headers).isEmpty();
  }
  @Test public void writeHeadersWhenUsingPolicyThenWritesPolicy(){
    this.writer.setPolicyDirectives(DEFAULT_POLICY_DIRECTIVES);
    this.writer.writeHttpHeaders(this.exchange);
    HttpHeaders headers=this.exchange.getResponse().getHeaders();
    assertThat(headers).hasSize(1);
    assertThat(headers.get(ContentSecurityPolicyServerHttpHeadersWriter.CONTENT_SECURITY_POLICY)).containsOnly(DEFAULT_POLICY_DIRECTIVES);
  }
  @Test public void writeHeadersWhenReportPolicyThenWritesReportPolicy(){
    this.writer.setPolicyDirectives(DEFAULT_POLICY_DIRECTIVES);
    this.writer.setReportOnly(true);
    this.writer.writeHttpHeaders(this.exchange);
    HttpHeaders headers=this.exchange.getResponse().getHeaders();
    assertThat(headers).hasSize(1);
    assertThat(headers.get(ContentSecurityPolicyServerHttpHeadersWriter.CONTENT_SECURITY_POLICY_REPORT_ONLY)).containsOnly(DEFAULT_POLICY_DIRECTIVES);
  }
  @Test public void writeHeadersWhenOnlyReportOnlySetThenDoesNotWrite(){
    this.writer.setReportOnly(true);
    this.writer.writeHttpHeaders(this.exchange);
    HttpHeaders headers=this.exchange.getResponse().getHeaders();
    assertThat(headers).isEmpty();
  }
  @Test public void writeHeadersWhenAlreadyWrittenThenWritesHeader(){
    String headerValue="default-src https: 'self'";
    this.exchange.getResponse().getHeaders().set(ContentSecurityPolicyServerHttpHeadersWriter.CONTENT_SECURITY_POLICY,headerValue);
    this.writer.writeHttpHeaders(this.exchange);
    HttpHeaders headers=this.exchange.getResponse().getHeaders();
    assertThat(headers).hasSize(1);
    assertThat(headers.get(ContentSecurityPolicyServerHttpHeadersWriter.CONTENT_SECURITY_POLICY)).containsOnly(headerValue);
  }
}
