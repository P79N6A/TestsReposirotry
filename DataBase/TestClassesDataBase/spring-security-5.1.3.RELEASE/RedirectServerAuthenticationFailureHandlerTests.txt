/** 
 * @author Rob Winch
 * @since 5.0
 */
@RunWith(MockitoJUnitRunner.class) public class RedirectServerAuthenticationFailureHandlerTests {
  private WebFilterExchange exchange;
  @Mock private ServerRedirectStrategy redirectStrategy;
  private String location="/login";
  private RedirectServerAuthenticationFailureHandler handler=new RedirectServerAuthenticationFailureHandler(this.location);
  private AuthenticationException exception=new AuthenticationCredentialsNotFoundException("Authentication Required");
  @Test(expected=IllegalArgumentException.class) public void constructorStringWhenNullLocationThenException(){
    new RedirectServerAuthenticationEntryPoint((String)null);
  }
  @Test public void commenceWhenNoSubscribersThenNoActions(){
    this.exchange=createExchange();
    this.handler.onAuthenticationFailure(this.exchange,this.exception);
    assertThat(this.exchange.getExchange().getResponse().getHeaders().getLocation()).isNull();
    assertThat(this.exchange.getExchange().getSession().block().isStarted()).isFalse();
  }
  @Test public void commenceWhenSubscribeThenStatusAndLocationSet(){
    this.exchange=createExchange();
    this.handler.onAuthenticationFailure(this.exchange,this.exception).block();
    assertThat(this.exchange.getExchange().getResponse().getStatusCode()).isEqualTo(HttpStatus.FOUND);
    assertThat(this.exchange.getExchange().getResponse().getHeaders().getLocation()).hasPath(this.location);
  }
  @Test public void commenceWhenCustomServerRedirectStrategyThenCustomServerRedirectStrategyUsed(){
    PublisherProbe<Void> redirectResult=PublisherProbe.empty();
    when(this.redirectStrategy.sendRedirect(any(),any())).thenReturn(redirectResult.mono());
    this.handler.setRedirectStrategy(this.redirectStrategy);
    this.exchange=createExchange();
    this.handler.onAuthenticationFailure(this.exchange,this.exception).block();
    redirectResult.assertWasSubscribed();
  }
  @Test(expected=IllegalArgumentException.class) public void setRedirectStrategyWhenNullThenException(){
    this.handler.setRedirectStrategy(null);
  }
  private WebFilterExchange createExchange(){
    return new WebFilterExchange(MockServerWebExchange.from(MockServerHttpRequest.get("/").build()),new DefaultWebFilterChain(e -> Mono.empty()));
  }
}
