/** 
 * @author Luke Taylor
 */
public class PasswordComparisonAuthenticatorMockTests {
  @Test public void ldapCompareOperationIsUsedWhenPasswordIsNotRetrieved() throws Exception {
    final DirContext dirCtx=mock(DirContext.class);
    final BaseLdapPathContextSource source=mock(BaseLdapPathContextSource.class);
    final BasicAttributes attrs=new BasicAttributes();
    attrs.put(new BasicAttribute("uid","bob"));
    PasswordComparisonAuthenticator authenticator=new PasswordComparisonAuthenticator(source);
    authenticator.setUserDnPatterns(new String[]{"cn={0},ou=people"});
    when(source.getReadOnlyContext()).thenReturn(dirCtx);
    when(dirCtx.getAttributes(eq("cn=Bob,ou=people"),any(String[].class))).thenReturn(attrs);
    when(dirCtx.getNameInNamespace()).thenReturn("dc=springframework,dc=org");
    final NamingEnumeration searchResults=new BasicAttributes("",null).getAll();
    when(dirCtx.search(eq("cn=Bob,ou=people"),eq("(userPassword={0})"),any(Object[].class),any(SearchControls.class))).thenReturn(searchResults);
    authenticator.authenticate(new UsernamePasswordAuthenticationToken("Bob","bobspassword"));
  }
}
