/** 
 * @author Rob Winch
 */
@RunWith(PowerMockRunner.class) @PrepareForTest({ReflectionUtils.class,Method.class}) @PowerMockIgnore({"org.w3c.dom.*","org.xml.sax.*","org.apache.xerces.*","javax.xml.parsers.*"}) public class SessionManagementConfigurerServlet31Tests {
  @Mock Method method;
  MockHttpServletRequest request;
  MockHttpServletResponse response;
  MockFilterChain chain;
  ConfigurableApplicationContext context;
  Filter springSecurityFilterChain;
  @Before public void setup(){
    request=new MockHttpServletRequest("GET","");
    response=new MockHttpServletResponse();
    chain=new MockFilterChain();
  }
  @After public void teardown(){
    if (context != null) {
      context.close();
    }
  }
  @Test public void changeSessionIdDefaultsInServlet31Plus() throws Exception {
    spy(ReflectionUtils.class);
    Method method=mock(Method.class);
    MockHttpServletRequest request=new MockHttpServletRequest("GET","");
    request.getSession();
    request.setServletPath("/login");
    request.setMethod("POST");
    request.setParameter("username","user");
    request.setParameter("password","password");
    HttpSessionCsrfTokenRepository repository=new HttpSessionCsrfTokenRepository();
    CsrfToken token=repository.generateToken(request);
    repository.saveToken(token,request,response);
    request.setParameter(token.getParameterName(),token.getToken());
    when(ReflectionUtils.findMethod(HttpServletRequest.class,"changeSessionId")).thenReturn(method);
    loadConfig(SessionManagementDefaultSessionFixationServlet31Config.class);
    springSecurityFilterChain.doFilter(request,response,chain);
    verifyStatic(ReflectionUtils.class);
    ReflectionUtils.invokeMethod(same(method),any(HttpServletRequest.class));
  }
@EnableWebSecurity static class SessionManagementDefaultSessionFixationServlet31Config extends WebSecurityConfigurerAdapter {
    @Override protected void configure(    HttpSecurity http) throws Exception {
      http.formLogin().and().sessionManagement();
    }
    @Override protected void configure(    AuthenticationManagerBuilder auth) throws Exception {
      auth.inMemoryAuthentication().withUser(PasswordEncodedUser.user());
    }
  }
  private void loadConfig(  Class<?>... classes){
    AnnotationConfigApplicationContext context=new AnnotationConfigApplicationContext();
    context.register(classes);
    context.refresh();
    this.context=context;
    this.springSecurityFilterChain=this.context.getBean("springSecurityFilterChain",Filter.class);
  }
  private void login(  Authentication auth){
    HttpSessionSecurityContextRepository repo=new HttpSessionSecurityContextRepository();
    HttpRequestResponseHolder requestResponseHolder=new HttpRequestResponseHolder(request,response);
    repo.loadContext(requestResponseHolder);
    SecurityContextImpl securityContextImpl=new SecurityContextImpl();
    securityContextImpl.setAuthentication(auth);
    repo.saveContext(securityContextImpl,requestResponseHolder.getRequest(),requestResponseHolder.getResponse());
  }
}
