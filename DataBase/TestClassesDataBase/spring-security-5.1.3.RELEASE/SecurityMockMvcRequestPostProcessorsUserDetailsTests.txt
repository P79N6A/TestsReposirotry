@RunWith(PowerMockRunner.class) @PrepareOnlyThisForTest(WebTestUtils.class) public class SecurityMockMvcRequestPostProcessorsUserDetailsTests {
  @Captor private ArgumentCaptor<SecurityContext> contextCaptor;
  @Mock private SecurityContextRepository repository;
  private MockHttpServletRequest request;
  @Mock private UserDetails userDetails;
  @Before public void setup(){
    request=new MockHttpServletRequest();
    mockWebTestUtils();
  }
  @After public void cleanup(){
    TestSecurityContextHolder.clearContext();
  }
  @Test public void userDetails(){
    user(userDetails).postProcessRequest(request);
    verify(repository).saveContext(contextCaptor.capture(),eq(request),any(HttpServletResponse.class));
    SecurityContext context=contextCaptor.getValue();
    assertThat(context.getAuthentication()).isInstanceOf(UsernamePasswordAuthenticationToken.class);
    assertThat(context.getAuthentication().getPrincipal()).isSameAs(userDetails);
  }
  private void mockWebTestUtils(){
    spy(WebTestUtils.class);
    when(WebTestUtils.getSecurityContextRepository(request)).thenReturn(repository);
  }
}
