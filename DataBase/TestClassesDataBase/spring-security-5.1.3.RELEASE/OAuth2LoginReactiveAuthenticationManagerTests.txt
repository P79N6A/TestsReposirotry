/** 
 * @author Rob Winch
 * @since 5.1
 */
@RunWith(MockitoJUnitRunner.class) public class OAuth2LoginReactiveAuthenticationManagerTests {
  @Mock private ReactiveOAuth2UserService<OAuth2UserRequest,OAuth2User> userService;
  @Mock private ReactiveOAuth2AccessTokenResponseClient<OAuth2AuthorizationCodeGrantRequest> accessTokenResponseClient;
  @Mock private ReactiveOAuth2AuthorizedClientService authorizedClientService;
  private ClientRegistration.Builder registration=TestClientRegistrations.clientRegistration();
  OAuth2AuthorizationResponse.Builder authorizationResponseBldr=OAuth2AuthorizationResponse.success("code").state("state");
  private OAuth2LoginReactiveAuthenticationManager manager;
  @Before public void setup(){
    this.manager=new OAuth2LoginReactiveAuthenticationManager(this.accessTokenResponseClient,this.userService);
  }
  @Test public void constructorWhenNullAccessTokenResponseClientThenIllegalArgumentException(){
    this.accessTokenResponseClient=null;
    assertThatThrownBy(() -> new OAuth2LoginReactiveAuthenticationManager(this.accessTokenResponseClient,this.userService)).isInstanceOf(IllegalArgumentException.class);
  }
  @Test public void constructorWhenNullUserServiceThenIllegalArgumentException(){
    this.userService=null;
    assertThatThrownBy(() -> new OAuth2LoginReactiveAuthenticationManager(this.accessTokenResponseClient,this.userService)).isInstanceOf(IllegalArgumentException.class);
  }
  @Test public void authenticateWhenNoSubscriptionThenDoesNothing(){
    TestingAuthenticationToken token=new TestingAuthenticationToken("a","b");
    assertThatCode(() -> this.manager.authenticate(token)).doesNotThrowAnyException();
    assertThatThrownBy(() -> this.manager.authenticate(token).block()).isInstanceOf(Throwable.class);
  }
  @Test @Ignore public void authenticationWhenOidcThenEmpty(){
    this.registration.scope("openid");
    assertThat(this.manager.authenticate(loginToken()).block()).isNull();
  }
  @Test public void authenticationWhenErrorThenOAuth2AuthenticationException(){
    this.authorizationResponseBldr=OAuth2AuthorizationResponse.error("error").state("state");
    assertThatThrownBy(() -> this.manager.authenticate(loginToken()).block()).isInstanceOf(OAuth2AuthenticationException.class);
  }
  @Test public void authenticationWhenStateDoesNotMatchThenOAuth2AuthenticationException(){
    this.authorizationResponseBldr.state("notmatch");
    assertThatThrownBy(() -> this.manager.authenticate(loginToken()).block()).isInstanceOf(OAuth2AuthenticationException.class);
  }
  @Test public void authenticationWhenOAuth2UserNotFoundThenEmpty(){
    OAuth2AccessTokenResponse accessTokenResponse=OAuth2AccessTokenResponse.withToken("foo").tokenType(OAuth2AccessToken.TokenType.BEARER).build();
    when(this.accessTokenResponseClient.getTokenResponse(any())).thenReturn(Mono.just(accessTokenResponse));
    when(this.userService.loadUser(any())).thenReturn(Mono.empty());
    assertThat(this.manager.authenticate(loginToken()).block()).isNull();
  }
  @Test public void authenticationWhenOAuth2UserFoundThenSuccess(){
    OAuth2AccessTokenResponse accessTokenResponse=OAuth2AccessTokenResponse.withToken("foo").tokenType(OAuth2AccessToken.TokenType.BEARER).build();
    when(this.accessTokenResponseClient.getTokenResponse(any())).thenReturn(Mono.just(accessTokenResponse));
    DefaultOAuth2User user=new DefaultOAuth2User(AuthorityUtils.createAuthorityList("ROLE_USER"),Collections.singletonMap("user","rob"),"user");
    when(this.userService.loadUser(any())).thenReturn(Mono.just(user));
    OAuth2LoginAuthenticationToken result=(OAuth2LoginAuthenticationToken)this.manager.authenticate(loginToken()).block();
    assertThat(result.getPrincipal()).isEqualTo(user);
    assertThat(result.getAuthorities()).containsOnlyElementsOf(user.getAuthorities());
    assertThat(result.isAuthenticated()).isTrue();
  }
  @Test public void authenticateWhenTokenSuccessResponseThenAdditionalParametersAddedToUserRequest(){
    Map<String,Object> additionalParameters=new HashMap<>();
    additionalParameters.put("param1","value1");
    additionalParameters.put("param2","value2");
    OAuth2AccessTokenResponse accessTokenResponse=OAuth2AccessTokenResponse.withToken("foo").tokenType(OAuth2AccessToken.TokenType.BEARER).additionalParameters(additionalParameters).build();
    when(this.accessTokenResponseClient.getTokenResponse(any())).thenReturn(Mono.just(accessTokenResponse));
    DefaultOAuth2User user=new DefaultOAuth2User(AuthorityUtils.createAuthorityList("ROLE_USER"),Collections.singletonMap("user","rob"),"user");
    ArgumentCaptor<OAuth2UserRequest> userRequestArgCaptor=ArgumentCaptor.forClass(OAuth2UserRequest.class);
    when(this.userService.loadUser(userRequestArgCaptor.capture())).thenReturn(Mono.just(user));
    this.manager.authenticate(loginToken()).block();
    assertThat(userRequestArgCaptor.getValue().getAdditionalParameters()).containsAllEntriesOf(accessTokenResponse.getAdditionalParameters());
  }
  private OAuth2AuthorizationCodeAuthenticationToken loginToken(){
    ClientRegistration clientRegistration=this.registration.build();
    OAuth2AuthorizationRequest authorizationRequest=OAuth2AuthorizationRequest.authorizationCode().state("state").clientId(clientRegistration.getClientId()).authorizationUri(clientRegistration.getProviderDetails().getAuthorizationUri()).redirectUri(clientRegistration.getRedirectUriTemplate()).scopes(clientRegistration.getScopes()).build();
    OAuth2AuthorizationResponse authorizationResponse=this.authorizationResponseBldr.redirectUri(clientRegistration.getRedirectUriTemplate()).build();
    OAuth2AuthorizationExchange authorizationExchange=new OAuth2AuthorizationExchange(authorizationRequest,authorizationResponse);
    return new OAuth2AuthorizationCodeAuthenticationToken(clientRegistration,authorizationExchange);
  }
}
