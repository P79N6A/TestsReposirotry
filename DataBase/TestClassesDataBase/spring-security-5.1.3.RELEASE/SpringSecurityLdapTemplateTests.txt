@RunWith(MockitoJUnitRunner.class) public class SpringSecurityLdapTemplateTests {
  @Mock private DirContext ctx;
  @Captor private ArgumentCaptor<SearchControls> searchControls;
  @Mock private NamingEnumeration<SearchResult> resultsEnum;
  @Mock private SearchResult searchResult;
  @Test public void searchForSingleEntryInternalAllowsReferrals() throws Exception {
    String base="";
    String filter="";
    String searchResultName="ldap://example.com/dc=springframework,dc=org";
    Object[] params=new Object[]{};
    DirContextAdapter searchResultObject=mock(DirContextAdapter.class);
    when(ctx.search(any(DistinguishedName.class),eq(filter),eq(params),searchControls.capture())).thenReturn(resultsEnum);
    when(resultsEnum.hasMore()).thenReturn(true,false);
    when(resultsEnum.next()).thenReturn(searchResult);
    when(searchResult.getObject()).thenReturn(searchResultObject);
    SpringSecurityLdapTemplate.searchForSingleEntryInternal(ctx,mock(SearchControls.class),base,filter,params);
    assertThat(searchControls.getValue().getReturningObjFlag()).isTrue();
  }
}
