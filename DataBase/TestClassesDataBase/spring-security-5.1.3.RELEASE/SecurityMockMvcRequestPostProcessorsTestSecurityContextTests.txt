@RunWith(PowerMockRunner.class) @PrepareOnlyThisForTest(WebTestUtils.class) public class SecurityMockMvcRequestPostProcessorsTestSecurityContextTests {
  @Mock private SecurityContext context;
  @Mock private SecurityContextRepository repository;
  private MockHttpServletRequest request;
  @Before public void setup(){
    request=new MockHttpServletRequest();
    mockWebTestUtils();
  }
  @After public void cleanup(){
    TestSecurityContextHolder.clearContext();
  }
  @Test public void testSecurityContextSaves(){
    TestSecurityContextHolder.setContext(context);
    testSecurityContext().postProcessRequest(request);
    verify(repository).saveContext(eq(context),eq(request),any(HttpServletResponse.class));
  }
  @Test public void testSecurityContextNoContext(){
    testSecurityContext().postProcessRequest(request);
    verify(repository,never()).saveContext(any(SecurityContext.class),eq(request),any(HttpServletResponse.class));
  }
  private void mockWebTestUtils(){
    spy(WebTestUtils.class);
    when(WebTestUtils.getSecurityContextRepository(request)).thenReturn(repository);
  }
}
