/** 
 * @author Rob Winch
 */
public class HttpSecurityAntMatchersTests {
  AnnotationConfigWebApplicationContext context;
  MockHttpServletRequest request;
  MockHttpServletResponse response;
  MockFilterChain chain;
  @Autowired FilterChainProxy springSecurityFilterChain;
  @Before public void setup(){
    request=new MockHttpServletRequest("GET","");
    response=new MockHttpServletResponse();
    chain=new MockFilterChain();
  }
  @After public void cleanup(){
    if (context != null) {
      context.close();
    }
  }
  @Test public void antMatchersMethodAndNoPatterns() throws Exception {
    loadConfig(AntMatchersNoPatternsConfig.class);
    request.setMethod("POST");
    springSecurityFilterChain.doFilter(request,response,chain);
    assertThat(response.getStatus()).isEqualTo(HttpServletResponse.SC_FORBIDDEN);
  }
@EnableWebSecurity @Configuration static class AntMatchersNoPatternsConfig extends WebSecurityConfigurerAdapter {
    protected void configure(    HttpSecurity http) throws Exception {
      http.requestMatchers().antMatchers(HttpMethod.POST).and().authorizeRequests().anyRequest().denyAll();
    }
    @Override protected void configure(    AuthenticationManagerBuilder auth) throws Exception {
      auth.inMemoryAuthentication();
    }
  }
  @Test public void antMatchersMethodAndEmptyPatterns() throws Exception {
    loadConfig(AntMatchersEmptyPatternsConfig.class);
    request.setMethod("POST");
    springSecurityFilterChain.doFilter(request,response,chain);
    assertThat(response.getStatus()).isEqualTo(HttpServletResponse.SC_OK);
  }
@EnableWebSecurity @Configuration static class AntMatchersEmptyPatternsConfig extends WebSecurityConfigurerAdapter {
    protected void configure(    HttpSecurity http) throws Exception {
      http.requestMatchers().antMatchers("/never/").antMatchers(HttpMethod.POST,new String[0]).and().authorizeRequests().anyRequest().denyAll();
    }
    @Override protected void configure(    AuthenticationManagerBuilder auth) throws Exception {
      auth.inMemoryAuthentication();
    }
  }
  public void loadConfig(  Class<?>... configs){
    context=new AnnotationConfigWebApplicationContext();
    context.register(configs);
    context.refresh();
    context.getAutowireCapableBeanFactory().autowireBean(this);
  }
}
