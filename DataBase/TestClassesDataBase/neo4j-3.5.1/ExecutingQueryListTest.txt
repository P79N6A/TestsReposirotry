public class ExecutingQueryListTest {
  @Test public void removingTheLastQueryReturnsAnEmptyList(){
    ExecutingQuery aQuery=createExecutingQuery(1,"query");
    ExecutingQueryList list=ExecutingQueryList.EMPTY.push(aQuery);
    ExecutingQueryList result=list.remove(aQuery);
    assertThat(result,equalTo(ExecutingQueryList.EMPTY));
  }
  @Test public void shouldNotChangeAListWhenRemovingAQueryThatIsNotInTheList(){
    ExecutingQuery query1=createExecutingQuery(1,"query1");
    ExecutingQuery query2=createExecutingQuery(2,"query2");
    ExecutingQueryList list=ExecutingQueryList.EMPTY.push(query1);
    ExecutingQueryList result=list.remove(query2);
    assertThat(result,equalTo(list));
  }
  @Test public void addingQueriesKeepsInsertOrder(){
    ExecutingQuery query1=createExecutingQuery(1,"query1");
    ExecutingQuery query2=createExecutingQuery(2,"query2");
    ExecutingQuery query3=createExecutingQuery(3,"query3");
    ExecutingQuery query4=createExecutingQuery(4,"query4");
    ExecutingQuery query5=createExecutingQuery(5,"query5");
    ExecutingQueryList list=ExecutingQueryList.EMPTY.push(query1).push(query2).push(query3).push(query4).push(query5);
    List<ExecutingQuery> result=list.queries().collect(Collectors.toList());
    assertThat(result,equalTo(asList(query5,query4,query3,query2,query1)));
  }
  @Test public void removingQueryInTheMiddleKeepsOrder(){
    ExecutingQuery query1=createExecutingQuery(1,"query1");
    ExecutingQuery query2=createExecutingQuery(2,"query2");
    ExecutingQuery query3=createExecutingQuery(3,"query3");
    ExecutingQuery query4=createExecutingQuery(4,"query4");
    ExecutingQuery query5=createExecutingQuery(5,"query5");
    ExecutingQueryList list=ExecutingQueryList.EMPTY.push(query1).push(query2).push(query3).push(query4).push(query5);
    List<ExecutingQuery> result=list.remove(query3).queries().collect(Collectors.toList());
    assertThat(result,equalTo(asList(query5,query4,query2,query1)));
  }
  private ExecutingQuery createExecutingQuery(  int queryId,  String query){
    return new ExecutingQuery(queryId,ClientConnectionInfo.EMBEDDED_CONNECTION,"me",query,EMPTY_MAP,Collections.emptyMap(),() -> 0,PageCursorTracer.NULL,Thread.currentThread().getId(),Thread.currentThread().getName(),Clocks.nanoClock(),CpuClock.CPU_CLOCK,HeapAllocation.HEAP_ALLOCATION);
  }
}
