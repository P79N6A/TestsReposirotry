@ExtendWith(TestDirectoryExtension.class) public class PointPropertiesRecordFormatIT {
  @Inject private TestDirectory testDirectory;
  @Test void failToCreatePointOnOldDatabase(){
    File storeDir=testDirectory.storeDir();
    GraphDatabaseService nonUpgradedStore=startNonUpgradableDatabaseWithFormat(storeDir,StandardV3_2.NAME);
    TransactionFailureException exception=assertThrows(TransactionFailureException.class,() -> {
      try (Transaction transaction=nonUpgradedStore.beginTx()){
        Node node=nonUpgradedStore.createNode();
        node.setProperty("a",pointValue(Cartesian,1.0,2.0));
        transaction.success();
      }
     }
);
    assertEquals("Current record format does not support POINT_PROPERTIES. Please upgrade your store to the format that support requested capability.",Exceptions.rootCause(exception).getMessage());
    nonUpgradedStore.shutdown();
    GraphDatabaseService restartedOldFormatDatabase=startNonUpgradableDatabaseWithFormat(storeDir,StandardV3_2.NAME);
    try (Transaction transaction=restartedOldFormatDatabase.beginTx()){
      Node node=restartedOldFormatDatabase.createNode();
      node.setProperty("c","d");
      transaction.success();
    }
     restartedOldFormatDatabase.shutdown();
  }
  @Test void failToCreatePointArrayOnOldDatabase(){
    File storeDir=testDirectory.storeDir();
    GraphDatabaseService nonUpgradedStore=startNonUpgradableDatabaseWithFormat(storeDir,StandardV3_2.NAME);
    PointValue point=pointValue(Cartesian,1.0,2.0);
    TransactionFailureException exception=assertThrows(TransactionFailureException.class,() -> {
      try (Transaction transaction=nonUpgradedStore.beginTx()){
        Node node=nonUpgradedStore.createNode();
        node.setProperty("a",new PointValue[]{point,point});
        transaction.success();
      }
     }
);
    assertEquals("Current record format does not support POINT_PROPERTIES. Please upgrade your store to the format that support requested capability.",Exceptions.rootCause(exception).getMessage());
    nonUpgradedStore.shutdown();
    GraphDatabaseService restartedOldFormatDatabase=startNonUpgradableDatabaseWithFormat(storeDir,StandardV3_2.NAME);
    try (Transaction transaction=restartedOldFormatDatabase.beginTx()){
      Node node=restartedOldFormatDatabase.createNode();
      node.setProperty("c","d");
      transaction.success();
    }
     restartedOldFormatDatabase.shutdown();
  }
  @Test void createPointPropertyOnLatestDatabase(){
    File storeDir=testDirectory.storeDir();
    Label pointNode=Label.label("PointNode");
    String propertyKey="a";
    PointValue pointValue=pointValue(Cartesian,1.0,2.0);
    GraphDatabaseService database=startDatabaseWithFormat(storeDir,Standard.LATEST_NAME);
    try (Transaction transaction=database.beginTx()){
      Node node=database.createNode(pointNode);
      node.setProperty(propertyKey,pointValue);
      transaction.success();
    }
     database.shutdown();
    GraphDatabaseService restartedDatabase=startDatabaseWithFormat(storeDir,Standard.LATEST_NAME);
    try (Transaction ignored=restartedDatabase.beginTx()){
      assertNotNull(restartedDatabase.findNode(pointNode,propertyKey,pointValue));
    }
     restartedDatabase.shutdown();
  }
  @Test void createPointArrayPropertyOnLatestDatabase(){
    File storeDir=testDirectory.storeDir();
    Label pointNode=Label.label("PointNode");
    String propertyKey="a";
    PointValue pointValue=pointValue(Cartesian,1.0,2.0);
    GraphDatabaseService database=startDatabaseWithFormat(storeDir,Standard.LATEST_NAME);
    try (Transaction transaction=database.beginTx()){
      Node node=database.createNode(pointNode);
      node.setProperty(propertyKey,new PointValue[]{pointValue,pointValue});
      transaction.success();
    }
     database.shutdown();
    GraphDatabaseService restartedDatabase=startDatabaseWithFormat(storeDir,Standard.LATEST_NAME);
    try (Transaction ignored=restartedDatabase.beginTx()){
      try (ResourceIterator<Node> nodes=restartedDatabase.findNodes(pointNode)){
        Node node=nodes.next();
        PointValue[] points=(PointValue[])node.getProperty(propertyKey);
        assertThat(points,arrayWithSize(2));
      }
     }
     restartedDatabase.shutdown();
  }
  @Test void failToOpenStoreWithPointPropertyUsingOldFormat(){
    File storeDir=testDirectory.storeDir();
    GraphDatabaseService database=startDatabaseWithFormat(storeDir,StandardV3_4.NAME);
    try (Transaction transaction=database.beginTx()){
      Node node=database.createNode();
      node.setProperty("a",pointValue(Cartesian,1.0,2.0));
      transaction.success();
    }
     database.shutdown();
    Throwable throwable=assertThrows(Throwable.class,() -> startDatabaseWithFormat(storeDir,StandardV3_2.NAME));
    assertSame(StoreUpgrader.AttemptedDowngradeException.class,Exceptions.rootCause(throwable).getClass());
  }
}
