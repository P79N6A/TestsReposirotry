public class IndexRuleTest extends SchemaRuleTestBase {
  @Test public void shouldCreateGeneralIndex(){
    IndexDescriptor descriptor=forLabel(LABEL_ID,PROPERTY_ID_1);
    StoreIndexDescriptor indexRule=descriptor.withId(RULE_ID);
    assertThat(indexRule.getId(),equalTo(RULE_ID));
    assertFalse(indexRule.canSupportUniqueConstraint());
    assertThat(indexRule.schema(),equalTo(descriptor.schema()));
    assertThat(indexRule,equalTo(descriptor));
    assertThat(indexRule.providerDescriptor(),equalTo(PROVIDER_DESCRIPTOR));
    assertException(indexRule::getOwningConstraint,IllegalStateException.class);
    assertException(() -> indexRule.withOwningConstraint(RULE_ID_2),IllegalStateException.class);
  }
  @Test public void shouldCreateUniqueIndex(){
    IndexDescriptor descriptor=uniqueForLabel(LABEL_ID,PROPERTY_ID_1);
    StoreIndexDescriptor indexRule=descriptor.withId(RULE_ID);
    assertThat(indexRule.getId(),equalTo(RULE_ID));
    assertTrue(indexRule.canSupportUniqueConstraint());
    assertThat(indexRule.schema(),equalTo(descriptor.schema()));
    assertThat(indexRule,equalTo(descriptor));
    assertThat(indexRule.providerDescriptor(),equalTo(PROVIDER_DESCRIPTOR));
    assertThat(indexRule.getOwningConstraint(),equalTo(null));
    StoreIndexDescriptor withConstraint=indexRule.withOwningConstraint(RULE_ID_2);
    assertThat(withConstraint.getOwningConstraint(),equalTo(RULE_ID_2));
    assertThat(indexRule.getOwningConstraint(),equalTo(null));
  }
  @Test public void indexRulesAreEqualBasedOnIndexDescriptor(){
    assertEqualityByDescriptor(forLabel(LABEL_ID,PROPERTY_ID_1));
    assertEqualityByDescriptor(uniqueForLabel(LABEL_ID,PROPERTY_ID_1));
    assertEqualityByDescriptor(forLabel(LABEL_ID,PROPERTY_ID_1,PROPERTY_ID_2));
    assertEqualityByDescriptor(uniqueForLabel(LABEL_ID,PROPERTY_ID_1,PROPERTY_ID_2));
  }
  @Test public void detectUniqueIndexWithoutOwningConstraint(){
    IndexDescriptor descriptor=uniqueForLabel(LABEL_ID,PROPERTY_ID_1);
    StoreIndexDescriptor indexRule=descriptor.withId(RULE_ID);
    assertTrue(indexRule.isIndexWithoutOwningConstraint());
  }
  private void assertEqualityByDescriptor(  IndexDescriptor descriptor){
    StoreIndexDescriptor rule1=descriptor.withId(RULE_ID);
    StoreIndexDescriptor rule2=descriptor.withId(RULE_ID_2);
    StoreIndexDescriptor rule3=(descriptor.type() == Type.GENERAL ? forSchema(descriptor.schema()) : uniqueForSchema(descriptor.schema())).withId(RULE_ID);
    assertEquality(rule1,rule2);
    assertEquality(rule1,rule3);
  }
}
