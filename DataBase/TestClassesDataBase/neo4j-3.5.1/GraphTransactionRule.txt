/** 
 * JUnit @Rule for running a transaction for the duration of a test. Requires an EmbeddedDatabaseRule with whose database the transaction will be executed.
 */
public class GraphTransactionRule extends ExternalResource {
  private final DatabaseRule database;
  private Transaction tx;
  public GraphTransactionRule(  DatabaseRule database){
    this.database=database;
  }
  @Override protected void before(){
    begin();
  }
  @Override protected void after(){
    success();
  }
  public Transaction current(){
    return tx;
  }
  public Transaction begin(){
    tx=database.getGraphDatabaseAPI().beginTx();
    return tx;
  }
  public void success(){
    try {
      if (tx != null) {
        tx.success();
        tx.close();
      }
    }
  finally {
      tx=null;
    }
  }
  public void failure(){
    try {
      if (tx != null) {
        tx.failure();
        tx.close();
      }
    }
  finally {
      tx=null;
    }
  }
}
