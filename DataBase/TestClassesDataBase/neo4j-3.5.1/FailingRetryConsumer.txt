private static class FailingRetryConsumer implements Consumer<Transaction> {
  private final int successAfter;
  private final RuntimeException fakeException;
  private int tries;
  private FailingRetryConsumer(  int successAfter,  RuntimeException fakeException){
    this.successAfter=successAfter;
    this.fakeException=fakeException;
  }
  @Override public void accept(  Transaction transaction){
    if (tries++ < successAfter) {
      throw fakeException;
    }
  }
}
