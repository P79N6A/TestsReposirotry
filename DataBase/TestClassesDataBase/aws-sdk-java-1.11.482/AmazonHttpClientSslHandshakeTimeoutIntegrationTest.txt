/** 
 * This test is to verify that the apache-httpclient library has fixed the bug where socket timeout configuration is incorrectly ignored during SSL handshake. This test is expected to hang (and fail after the junit timeout) if run against the problematic httpclient version (e.g. 4.3).
 * @link https://issues.apache.org/jira/browse/HTTPCLIENT-1478
 */
public class AmazonHttpClientSslHandshakeTimeoutIntegrationTest extends UnresponsiveMockServerTestBase {
  private static final int CLIENT_SOCKET_TO=1 * 1000;
  @Test(timeout=60 * 1000) public void testSslHandshakeTimeout(){
    AmazonHttpClient httpClient=new AmazonHttpClient(new ClientConfiguration().withSocketTimeout(CLIENT_SOCKET_TO).withMaxErrorRetry(0));
    System.out.println("Sending request to localhost...");
    try {
      httpClient.requestExecutionBuilder().request(new EmptyHttpRequest(server.getHttpsEndpoint(),HttpMethodName.GET)).execute();
      fail("Client-side socket read timeout is expected!");
    }
 catch (    AmazonClientException e) {
      Assert.assertTrue(e.getCause() instanceof ConnectTimeoutException);
      ConnectTimeoutException cte=(ConnectTimeoutException)e.getCause();
      Assert.assertThat(cte.getMessage(),org.hamcrest.Matchers.containsString("Read timed out"));
    }
  }
}
