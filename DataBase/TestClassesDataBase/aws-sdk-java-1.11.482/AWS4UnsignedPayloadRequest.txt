public class AWS4UnsignedPayloadRequest {
  private static final Date SIGNING_DATE=new Date(System.currentTimeMillis());
  private static final AWS4UnsignedPayloadSigner UNSIGNED_PAYLOAD_SIGNER=new AWS4UnsignedPayloadSigner(new SdkClock.MockClock(SIGNING_DATE));
  private static final AWSCredentials CREDENTIALS=new BasicAWSCredentials("akid","skid");
  @BeforeClass public static void setUp(){
    UNSIGNED_PAYLOAD_SIGNER.setOverrideDate(SIGNING_DATE);
    UNSIGNED_PAYLOAD_SIGNER.setServiceName("test-service");
    UNSIGNED_PAYLOAD_SIGNER.setRegionName("test-region");
  }
  @Test public void doesNotComputeContentHash_HTTPS() throws UnsupportedEncodingException {
    SignableRequest<?> request1=MockRequestBuilder.create().withEndpoint("https://test-service.example.com").withContent(new ByteArrayInputStream("CONTENT-1".getBytes("UTF-8"))).withHeader("headerName","headerValue").withParameter("parameterName","parameterValue").build();
    SignableRequest<?> request2=MockRequestBuilder.create().withEndpoint("https://test-service.example.com").withContent(new ByteArrayInputStream("CONTENT-2".getBytes("UTF-8"))).withHeader("headerName","headerValue").withParameter("parameterName","parameterValue").build();
    UNSIGNED_PAYLOAD_SIGNER.sign(request1,CREDENTIALS);
    UNSIGNED_PAYLOAD_SIGNER.sign(request2,CREDENTIALS);
    assertThat(request1.getHeaders().get("Authorization"),is(equalTo(request2.getHeaders().get("Authorization"))));
  }
  @Test public void computesContentHash_HTTP() throws UnsupportedEncodingException {
    SignableRequest<?> request=MockRequestBuilder.create().withEndpoint("http://test-service.example.com").withHeader("headerName","headerValue").withParameter("parameterName","parameterValue").withContent(new ByteArrayInputStream("".getBytes("UTF-8"))).build();
    UNSIGNED_PAYLOAD_SIGNER.sign(request,CREDENTIALS);
    assertThat(request.getHeaders().get(X_AMZ_CONTENT_SHA256),is(equalTo("e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855")));
  }
  @Test public void setsContentSha256Header() throws UnsupportedEncodingException {
    SignableRequest<?> request1=MockRequestBuilder.create().withEndpoint("https://test-service.example.com").withHeader("headerName","headerValue").withParameter("parameterName","parameterValue").withContent(new ByteArrayInputStream("content".getBytes("UTF-8"))).build();
    UNSIGNED_PAYLOAD_SIGNER.sign(request1,CREDENTIALS);
    assertThat(request1.getHeaders().get(X_AMZ_CONTENT_SHA256),is(equalTo("UNSIGNED-PAYLOAD")));
  }
}
