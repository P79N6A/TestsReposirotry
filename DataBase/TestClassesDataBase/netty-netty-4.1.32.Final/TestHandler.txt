private static final class TestHandler extends SimpleChannelInboundHandler<ByteBuf> {
  private final AtomicInteger bytesRead;
  private final boolean extraReadRequested;
  private final CountDownLatch latch;
  TestHandler(  AtomicInteger bytesRead,  boolean extraReadRequested,  CountDownLatch latch){
    this.bytesRead=bytesRead;
    this.extraReadRequested=extraReadRequested;
    this.latch=latch;
  }
  @Override protected void channelRead0(  ChannelHandlerContext ctx,  ByteBuf msg){
    bytesRead.addAndGet(msg.readableBytes());
    if (extraReadRequested) {
      ctx.read();
    }
  }
  @Override public void channelInactive(  ChannelHandlerContext ctx){
    latch.countDown();
    ctx.fireChannelInactive();
  }
}
