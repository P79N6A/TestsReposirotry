public class DefaultHttpDataFactoryTest {
  private static final HttpRequest req1=new DefaultHttpRequest(HTTP_1_1,POST,"/form");
  private static final HttpRequest req2=new DefaultHttpRequest(HTTP_1_1,POST,"/form");
  private DefaultHttpDataFactory factory;
  @BeforeClass public static void assertReq1EqualsReq2(){
    assertEquals(req1.hashCode(),req2.hashCode());
    assertTrue(req1.equals(req2));
  }
  @Before public void setupFactory(){
    factory=new DefaultHttpDataFactory();
  }
  @After public void cleanupFactory(){
    factory.cleanAllHttpData();
  }
  @Test public void cleanRequestHttpDataShouldIdentifiesRequestsByTheirIdentities() throws Exception {
    Attribute attribute1=factory.createAttribute(req1,"attribute1","value1");
    Attribute attribute2=factory.createAttribute(req2,"attribute2","value2");
    FileUpload file1=factory.createFileUpload(req1,"file1","file1.txt",DEFAULT_TEXT_CONTENT_TYPE,IDENTITY.toString(),UTF_8,123);
    FileUpload file2=factory.createFileUpload(req2,"file2","file2.txt",DEFAULT_TEXT_CONTENT_TYPE,IDENTITY.toString(),UTF_8,123);
    file1.setContent(Unpooled.copiedBuffer("file1 content",UTF_8));
    file2.setContent(Unpooled.copiedBuffer("file2 content",UTF_8));
    assertNotNull(attribute1.getByteBuf());
    assertNotNull(attribute2.getByteBuf());
    assertNotNull(file1.getByteBuf());
    assertNotNull(file2.getByteBuf());
    assertEquals(1,attribute1.refCnt());
    assertEquals(1,attribute2.refCnt());
    assertEquals(1,file1.refCnt());
    assertEquals(1,file2.refCnt());
    factory.cleanRequestHttpData(req1);
    assertNull(attribute1.getByteBuf());
    assertNull(file1.getByteBuf());
    assertEquals(0,attribute1.refCnt());
    assertEquals(0,file1.refCnt());
    assertNotNull(attribute2.getByteBuf());
    assertNotNull(file2.getByteBuf());
    assertEquals(1,attribute2.refCnt());
    assertEquals(1,file2.refCnt());
  }
  @Test public void removeHttpDataFromCleanShouldIdentifiesDataByTheirIdentities() throws Exception {
    Attribute attribute1=factory.createAttribute(req1,"attribute","value");
    Attribute attribute2=factory.createAttribute(req1,"attribute","value");
    FileUpload file1=factory.createFileUpload(req1,"file","file.txt",DEFAULT_TEXT_CONTENT_TYPE,IDENTITY.toString(),UTF_8,123);
    FileUpload file2=factory.createFileUpload(req1,"file","file.txt",DEFAULT_TEXT_CONTENT_TYPE,IDENTITY.toString(),UTF_8,123);
    file1.setContent(Unpooled.copiedBuffer("file content",UTF_8));
    file2.setContent(Unpooled.copiedBuffer("file content",UTF_8));
    assertEquals(attribute1.hashCode(),attribute2.hashCode());
    assertTrue(attribute1.equals(attribute2));
    assertEquals(file1.hashCode(),file2.hashCode());
    assertTrue(file1.equals(file2));
    factory.removeHttpDataFromClean(req1,attribute2);
    factory.removeHttpDataFromClean(req1,file2);
    factory.cleanRequestHttpData(req1);
    assertNull(attribute1.getByteBuf());
    assertNull(file1.getByteBuf());
    assertEquals(0,attribute1.refCnt());
    assertEquals(0,file1.refCnt());
    assertNotNull(attribute2.getByteBuf());
    assertNotNull(file2.getByteBuf());
    assertEquals(1,attribute2.refCnt());
    assertEquals(1,file2.refCnt());
    attribute2.release();
    file2.release();
    assertEquals(0,attribute2.refCnt());
    assertEquals(0,file2.refCnt());
  }
}
