private static final class ReadPendingReadHandler extends ChannelInboundHandlerAdapter {
  private final AtomicInteger count=new AtomicInteger();
  private final CountDownLatch latch=new CountDownLatch(1);
  private final CountDownLatch latch2=new CountDownLatch(2);
  @Override public void channelRead(  ChannelHandlerContext ctx,  Object msg) throws Exception {
    ReferenceCountUtil.release(msg);
    if (count.incrementAndGet() == 1) {
      ctx.read();
    }
  }
  @Override public void channelReadComplete(  ChannelHandlerContext ctx) throws Exception {
    latch.countDown();
    latch2.countDown();
  }
  void assertAllRead() throws InterruptedException {
    assertTrue(latch.await(5,TimeUnit.SECONDS));
    assertFalse(latch2.await(1,TimeUnit.SECONDS));
    assertEquals(2,count.get());
  }
}
