private final class Socks5IntermediaryHandler extends IntermediaryHandler {
  private boolean authenticated;
  private SocketAddress intermediaryDestination;
  @Override protected boolean handleProxyProtocol(  ChannelHandlerContext ctx,  Object msg) throws Exception {
    if (!authenticated) {
      authenticated=authenticate(ctx,msg);
      return false;
    }
    Socks5CommandRequest req=(Socks5CommandRequest)msg;
    assertThat(req.type(),is(Socks5CommandType.CONNECT));
    Socks5CommandResponse res=new DefaultSocks5CommandResponse(Socks5CommandStatus.SUCCESS,Socks5AddressType.IPv4);
    intermediaryDestination=SocketUtils.socketAddress(req.dstAddr(),req.dstPort());
    ctx.write(res);
    ctx.pipeline().remove(ENCODER);
    ctx.pipeline().remove(DECODER);
    return true;
  }
  @Override protected SocketAddress intermediaryDestination(){
    return intermediaryDestination;
  }
}
