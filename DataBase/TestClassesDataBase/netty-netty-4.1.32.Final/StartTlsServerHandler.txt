private static class StartTlsServerHandler extends SimpleChannelInboundHandler<String> {
  private final SslHandler sslHandler;
  private final boolean autoRead;
  volatile Channel channel;
  final AtomicReference<Throwable> exception=new AtomicReference<Throwable>();
  StartTlsServerHandler(  SSLEngine engine,  boolean autoRead){
    engine.setUseClientMode(false);
    sslHandler=new SslHandler(engine,true);
    this.autoRead=autoRead;
  }
  @Override public void channelActive(  ChannelHandlerContext ctx) throws Exception {
    channel=ctx.channel();
    if (!autoRead) {
      ctx.read();
    }
  }
  @Override public void channelRead0(  ChannelHandlerContext ctx,  String msg) throws Exception {
    if ("StartTlsRequest".equals(msg)) {
      ctx.pipeline().addAfter("logger","ssl",sslHandler);
      ctx.writeAndFlush("StartTlsResponse\n");
      return;
    }
    assertEquals("EncryptedRequest",msg);
    ctx.writeAndFlush("EncryptedResponse\n");
  }
  @Override public void channelReadComplete(  ChannelHandlerContext ctx) throws Exception {
    if (!autoRead) {
      ctx.read();
    }
  }
  @Override public void exceptionCaught(  ChannelHandlerContext ctx,  Throwable cause) throws Exception {
    if (logger.isWarnEnabled()) {
      logger.warn("Unexpected exception from the server side",cause);
    }
    exception.compareAndSet(null,cause);
    ctx.close();
  }
}
