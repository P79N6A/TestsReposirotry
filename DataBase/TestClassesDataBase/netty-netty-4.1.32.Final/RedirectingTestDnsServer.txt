private static class RedirectingTestDnsServer extends TestDnsServer {
  private final String dnsAddress;
  private final String domain;
  RedirectingTestDnsServer(  String domain,  String dnsAddress){
    super(Collections.singleton(domain));
    this.domain=domain;
    this.dnsAddress=dnsAddress;
  }
  @Override protected DnsMessage filterMessage(  DnsMessage message){
    message.getAnswerRecords().clear();
    message.getAuthorityRecords().clear();
    message.getAdditionalRecords().clear();
    String name=domain;
    for (int i=0; ; i++) {
      int idx=name.indexOf('.');
      if (idx <= 0) {
        break;
      }
      name=name.substring(idx + 1);
      String dnsName="dns" + idx + '.'+ domain;
      message.getAuthorityRecords().add(newNsRecord(name,dnsName));
      message.getAdditionalRecords().add(newARecord(dnsName,i == 0 ? dnsAddress : "1.2.3." + idx));
      message.getAuthorityRecords().add(newNsRecord(name,"unresolved." + dnsName));
    }
    return message;
  }
}
