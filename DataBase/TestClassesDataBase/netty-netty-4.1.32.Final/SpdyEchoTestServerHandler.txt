private static class SpdyEchoTestServerHandler extends ChannelInboundHandlerAdapter {
  private final boolean autoRead;
  final AtomicReference<Throwable> exception=new AtomicReference<Throwable>();
  SpdyEchoTestServerHandler(  boolean autoRead){
    this.autoRead=autoRead;
  }
  @Override public void channelActive(  ChannelHandlerContext ctx) throws Exception {
    if (!autoRead) {
      ctx.read();
    }
  }
  @Override public void channelRead(  ChannelHandlerContext ctx,  Object msg) throws Exception {
    ctx.write(msg);
  }
  @Override public void channelReadComplete(  ChannelHandlerContext ctx) throws Exception {
    try {
      ctx.flush();
    }
  finally {
      if (!autoRead) {
        ctx.read();
      }
    }
  }
  @Override public void exceptionCaught(  ChannelHandlerContext ctx,  Throwable cause) throws Exception {
    if (exception.compareAndSet(null,cause)) {
      ctx.close();
    }
  }
}
