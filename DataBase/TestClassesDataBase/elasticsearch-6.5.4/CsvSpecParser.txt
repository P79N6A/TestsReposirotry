private static class CsvSpecParser implements SpecBaseIntegrationTestCase.Parser {
  private static final String SCHEMA_PREFIX="schema::";
  private final StringBuilder earlySchema=new StringBuilder();
  private final StringBuilder query=new StringBuilder();
  private final StringBuilder data=new StringBuilder();
  private CsvTestCase testCase;
  @Override public Object parse(  String line){
    if (testCase == null) {
      if (line.startsWith(SCHEMA_PREFIX)) {
        assertThat("Early schema already declared " + earlySchema,earlySchema.length(),is(0));
        earlySchema.append(line.substring(SCHEMA_PREFIX.length()).trim());
      }
 else {
        if (line.endsWith(";")) {
          testCase=new CsvTestCase();
          query.append(line.substring(0,line.length() - 1).trim());
          testCase.query=query.toString();
          testCase.earlySchema=earlySchema.toString();
          earlySchema.setLength(0);
          query.setLength(0);
        }
 else {
          query.append(line);
          query.append("\r\n");
        }
      }
    }
 else {
      if (line.startsWith(";")) {
        testCase.expectedResults=data.toString();
        CsvTestCase result=testCase;
        testCase=null;
        data.setLength(0);
        return result;
      }
 else {
        data.append(line);
        data.append("\r\n");
      }
    }
    return null;
  }
}
