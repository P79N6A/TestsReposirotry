@SuppressWarnings("unchecked") public class FailbackClusterInvokerTest {
  List<Invoker<FailbackClusterInvokerTest>> invokers=new ArrayList<Invoker<FailbackClusterInvokerTest>>();
  URL url=URL.valueOf("test://test:11/test");
  Invoker<FailbackClusterInvokerTest> invoker=mock(Invoker.class);
  RpcInvocation invocation=new RpcInvocation();
  Directory<FailbackClusterInvokerTest> dic;
  Result result=new RpcResult();
  /** 
 * @throws java.lang.Exception
 */
  @Before public void setUp() throws Exception {
    dic=mock(Directory.class);
    given(dic.getUrl()).willReturn(url);
    given(dic.list(invocation)).willReturn(invokers);
    given(dic.getInterface()).willReturn(FailbackClusterInvokerTest.class);
    invocation.setMethodName("method1");
    invokers.add(invoker);
  }
  private void resetInvokerToException(){
    given(invoker.invoke(invocation)).willThrow(new RuntimeException());
    given(invoker.getUrl()).willReturn(url);
    given(invoker.getInterface()).willReturn(FailbackClusterInvokerTest.class);
  }
  private void resetInvokerToNoException(){
    given(invoker.invoke(invocation)).willReturn(result);
    given(invoker.getUrl()).willReturn(url);
    given(invoker.getInterface()).willReturn(FailbackClusterInvokerTest.class);
  }
  @Test public void testInvokeExceptoin(){
    resetInvokerToException();
    FailbackClusterInvoker<FailbackClusterInvokerTest> invoker=new FailbackClusterInvoker<FailbackClusterInvokerTest>(dic);
    invoker.invoke(invocation);
    Assert.assertNull(RpcContext.getContext().getInvoker());
  }
  @Test() public void testInvokeNoExceptoin(){
    resetInvokerToNoException();
    FailbackClusterInvoker<FailbackClusterInvokerTest> invoker=new FailbackClusterInvoker<FailbackClusterInvokerTest>(dic);
    Result ret=invoker.invoke(invocation);
    Assert.assertSame(result,ret);
  }
  @Test() public void testNoInvoke(){
    dic=mock(Directory.class);
    given(dic.getUrl()).willReturn(url);
    given(dic.list(invocation)).willReturn(null);
    given(dic.getInterface()).willReturn(FailbackClusterInvokerTest.class);
    invocation.setMethodName("method1");
    invokers.add(invoker);
    resetInvokerToNoException();
    FailbackClusterInvoker<FailbackClusterInvokerTest> invoker=new FailbackClusterInvoker<FailbackClusterInvokerTest>(dic);
    LogUtil.start();
    invoker.invoke(invocation);
    assertEquals(1,LogUtil.findMessage("Failback to invoke"));
    LogUtil.stop();
  }
  @Test() public void testRetryFailed(){
    resetInvokerToException();
    FailbackClusterInvoker<FailbackClusterInvokerTest> invoker=new FailbackClusterInvoker<FailbackClusterInvokerTest>(dic);
    invoker.invoke(invocation);
    Assert.assertNull(RpcContext.getContext().getInvoker());
    invoker.retryFailed();
  }
}
