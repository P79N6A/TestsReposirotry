private static class InjectingSocketFactory extends StandardSocketFactory {
  static final SocketFactory defaultFactory=SocketFactory.getDefault();
  static int portToInjectOn;
  @Override public Socket createSocket() throws IOException {
    Socket spy=Mockito.spy(defaultFactory.createSocket());
    Mockito.doReturn(null).when(spy).getChannel();
    Mockito.doThrow(new ConnectTimeoutException("injected")).when(spy).connect(Mockito.argThat(new MatchesPort()),Mockito.anyInt());
    return spy;
  }
private class MatchesPort extends BaseMatcher<SocketAddress> {
    @Override public boolean matches(    Object arg0){
      return ((InetSocketAddress)arg0).getPort() == portToInjectOn;
    }
    @Override public void describeTo(    Description desc){
      desc.appendText("matches port " + portToInjectOn);
    }
  }
}
