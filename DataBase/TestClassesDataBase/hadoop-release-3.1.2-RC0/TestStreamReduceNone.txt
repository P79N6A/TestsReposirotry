/** 
 * This class tests hadoopStreaming in MapReduce local mode. It tests the case where number of reducers is set to 0. In this case, the mappers are expected to write out outputs directly. No reducer/combiner will be activated.
 */
public class TestStreamReduceNone {
  protected File INPUT_FILE=new File("stream_reduce_none_input.txt");
  protected File OUTPUT_DIR=new File("stream_reduce_none_out");
  protected String input="roses.are.red\nviolets.are.blue\nbunnies.are.pink\n";
  protected String map=UtilTest.makeJavaCommand(TrApp.class,new String[]{".","\\n"});
  protected String outputExpect="roses\t\nare\t\nred\t\nviolets\t\nare\t\nblue\t\nbunnies\t\nare\t\npink\t\n";
  private StreamJob job;
  public TestStreamReduceNone() throws IOException {
    UtilTest utilTest=new UtilTest(getClass().getName());
    utilTest.checkUserDir();
    utilTest.redirectIfAntJunit();
  }
  protected void createInput() throws IOException {
    DataOutputStream out=new DataOutputStream(new FileOutputStream(INPUT_FILE.getAbsoluteFile()));
    out.write(input.getBytes("UTF-8"));
    out.close();
  }
  protected String[] genArgs(){
    return new String[]{"-input",INPUT_FILE.getAbsolutePath(),"-output",OUTPUT_DIR.getAbsolutePath(),"-mapper",map,"-reducer","org.apache.hadoop.mapred.lib.IdentityReducer","-numReduceTasks","0","-jobconf","mapreduce.task.files.preserve.failedtasks=true","-jobconf","mapreduce.job.maps=1","-jobconf","stream.tmpdir=" + System.getProperty("test.build.data","/tmp")};
  }
  @Test public void testCommandLine() throws Exception {
    String outFileName="part-00000";
    File outFile=null;
    try {
      try {
        FileUtil.fullyDelete(OUTPUT_DIR.getAbsoluteFile());
      }
 catch (      Exception e) {
      }
      createInput();
      boolean mayExit=false;
      job=new StreamJob(genArgs(),mayExit);
      job.go();
      outFile=new File(OUTPUT_DIR,outFileName).getAbsoluteFile();
      String output=StreamUtil.slurp(outFile);
      System.err.println("outEx1=" + outputExpect);
      System.err.println("  out1=" + output);
      assertEquals(outputExpect,output);
    }
  finally {
      INPUT_FILE.delete();
      FileUtil.fullyDelete(OUTPUT_DIR.getAbsoluteFile());
    }
  }
  public static void main(  String[] args) throws Exception {
    new TestStreamReduceNone().testCommandLine();
  }
}
