/** 
 * Testcase to make sure that we always set scanner id in ScanResponse. See HBASE-18000.
 */
@Category({RegionServerTests.class,MediumTests.class}) public class TestAlwaysSetScannerId {
  @ClassRule public static final HBaseClassTestRule CLASS_RULE=HBaseClassTestRule.forClass(TestAlwaysSetScannerId.class);
  private static final HBaseTestingUtility UTIL=new HBaseTestingUtility();
  private static final TableName TABLE_NAME=TableName.valueOf("test");
  private static final byte[] CF=Bytes.toBytes("cf");
  private static final byte[] CQ=Bytes.toBytes("cq");
  private static final int COUNT=10;
  private static HRegionInfo HRI;
  private static ClientProtos.ClientService.BlockingInterface STUB;
  @BeforeClass public static void setUp() throws Exception {
    UTIL.startMiniCluster(1);
    try (Table table=UTIL.createTable(TABLE_NAME,CF)){
      for (int i=0; i < COUNT; i++) {
        table.put(new Put(Bytes.toBytes(i)).addColumn(CF,CQ,Bytes.toBytes(i)));
      }
    }
     HRI=UTIL.getAdmin().getTableRegions(TABLE_NAME).get(0);
    STUB=((ConnectionImplementation)UTIL.getConnection()).getClient(UTIL.getHBaseCluster().getRegionServer(0).getServerName());
  }
  @AfterClass public static void tearDown() throws Exception {
    UTIL.shutdownMiniCluster();
  }
  @Test public void test() throws ServiceException, IOException {
    Scan scan=new Scan();
    ScanRequest req=RequestConverter.buildScanRequest(HRI.getRegionName(),scan,1,false);
    ScanResponse resp=STUB.scan(null,req);
    assertTrue(resp.hasScannerId());
    long scannerId=resp.getScannerId();
    int nextCallSeq=0;
    for (int i=0; i < COUNT / 2; i++) {
      req=RequestConverter.buildScanRequest(scannerId,1,false,nextCallSeq++,false,false,-1);
      resp=STUB.scan(null,req);
      assertTrue(resp.hasScannerId());
      assertEquals(scannerId,resp.getScannerId());
    }
    req=RequestConverter.buildScanRequest(scannerId,0,false,nextCallSeq++,false,true,-1);
    resp=STUB.scan(null,req);
    assertTrue(resp.hasScannerId());
    assertEquals(scannerId,resp.getScannerId());
    req=RequestConverter.buildScanRequest(scannerId,0,true,false);
    resp=STUB.scan(null,req);
    assertTrue(resp.hasScannerId());
    assertEquals(scannerId,resp.getScannerId());
  }
}
