@Category({MiscTests.class,SmallTests.class}) public class TestGlobalFilter extends HttpServerFunctionalTest {
  @ClassRule public static final HBaseClassTestRule CLASS_RULE=HBaseClassTestRule.forClass(TestGlobalFilter.class);
  private static final Logger LOG=LoggerFactory.getLogger(HttpServer.class);
  static final Set<String> RECORDS=new TreeSet<>();
  /** 
 * A very simple filter that records accessed uri's 
 */
static public class RecordingFilter implements Filter {
    private FilterConfig filterConfig=null;
    @Override public void init(    FilterConfig filterConfig){
      this.filterConfig=filterConfig;
    }
    @Override public void destroy(){
      this.filterConfig=null;
    }
    @Override public void doFilter(    ServletRequest request,    ServletResponse response,    FilterChain chain) throws IOException, ServletException {
      if (filterConfig == null)       return;
      String uri=((HttpServletRequest)request).getRequestURI();
      LOG.info("filtering " + uri);
      RECORDS.add(uri);
      chain.doFilter(request,response);
    }
    /** 
 * Configuration for RecordingFilter 
 */
static public class Initializer extends FilterInitializer {
      public Initializer(){
      }
      @Override public void initFilter(      FilterContainer container,      Configuration conf){
        container.addGlobalFilter("recording",RecordingFilter.class.getName(),null);
      }
    }
  }
  /** 
 * access a url, ignoring some IOException such as the page does not exist 
 */
  static void access(  String urlstring) throws IOException {
    LOG.warn("access " + urlstring);
    URL url=new URL(urlstring);
    URLConnection connection=url.openConnection();
    connection.connect();
    try {
      BufferedReader in=new BufferedReader(new InputStreamReader(connection.getInputStream()));
      try {
        for (; in.readLine() != null; )         ;
      }
  finally {
        in.close();
      }
    }
 catch (    IOException ioe) {
      LOG.warn("urlstring=" + urlstring,ioe);
    }
  }
  @Test public void testServletFilter() throws Exception {
    Configuration conf=new Configuration();
    conf.set(HttpServer.FILTER_INITIALIZERS_PROPERTY,RecordingFilter.Initializer.class.getName());
    HttpServer http=createTestServer(conf);
    http.start();
    final String fsckURL="/fsck";
    final String stacksURL="/stacks";
    final String ajspURL="/a.jsp";
    final String listPathsURL="/listPaths";
    final String dataURL="/data";
    final String streamFile="/streamFile";
    final String rootURL="/";
    final String allURL="/*";
    final String outURL="/static/a.out";
    final String logURL="/logs/a.log";
    final String[] urls={fsckURL,stacksURL,ajspURL,listPathsURL,dataURL,streamFile,rootURL,allURL,outURL,logURL};
    final String prefix="http://" + NetUtils.getHostPortString(http.getConnectorAddress(0));
    try {
      for (int i=0; i < urls.length; i++) {
        access(prefix + urls[i]);
      }
    }
  finally {
      http.stop();
    }
    LOG.info("RECORDS = " + RECORDS);
    for (int i=0; i < urls.length; i++) {
      assertTrue(RECORDS.remove(urls[i]));
    }
    assertTrue(RECORDS.isEmpty());
  }
}
