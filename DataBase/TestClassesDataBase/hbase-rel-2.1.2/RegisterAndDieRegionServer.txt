/** 
 * A RegionServer that reports for duty and then immediately dies if it is the first to receive the response to a reportForDuty. When it dies, it clears its ephemeral znode which the master notices and so removes the region from its set of online regionservers.
 */
static class RegisterAndDieRegionServer extends MiniHBaseCluster.MiniHBaseClusterRegionServer {
  public RegisterAndDieRegionServer(  Configuration conf) throws IOException, InterruptedException {
    super(conf);
  }
  @Override protected void handleReportForDutyResponse(  RegionServerStartupResponse c) throws IOException {
    if (killedRS.compareAndSet(null,getServerName())) {
      while (!masterActive.get()) {
        Threads.sleep(100);
      }
      super.kill();
    }
 else {
      super.handleReportForDutyResponse(c);
    }
  }
}
