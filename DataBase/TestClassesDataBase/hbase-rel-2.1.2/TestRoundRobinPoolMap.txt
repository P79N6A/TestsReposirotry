@Category({MiscTests.class,SmallTests.class}) public class TestRoundRobinPoolMap extends PoolMapTestBase {
  @ClassRule public static final HBaseClassTestRule CLASS_RULE=HBaseClassTestRule.forClass(TestRoundRobinPoolMap.class);
  @Override protected PoolType getPoolType(){
    return PoolType.RoundRobin;
  }
  @Test public void testSingleThreadedClient() throws InterruptedException, ExecutionException {
    Random rand=ThreadLocalRandom.current();
    String randomKey=String.valueOf(rand.nextInt());
    String randomValue=String.valueOf(rand.nextInt());
    runThread(randomKey,randomValue,null);
    assertEquals(1,poolMap.size(randomKey));
  }
  @Test public void testMultiThreadedClients() throws InterruptedException, ExecutionException {
    Random rand=ThreadLocalRandom.current();
    for (int i=0; i < POOL_SIZE; i++) {
      String randomKey=String.valueOf(rand.nextInt());
      String randomValue=String.valueOf(rand.nextInt());
      runThread(randomKey,randomValue,null);
      assertEquals(1,poolMap.size(randomKey));
    }
    poolMap.clear();
    String randomKey=String.valueOf(rand.nextInt());
    for (int i=0; i < POOL_SIZE - 1; i++) {
      String randomValue=String.valueOf(rand.nextInt());
      runThread(randomKey,randomValue,null);
      assertEquals(i + 1,poolMap.size(randomKey));
    }
    assertEquals(POOL_SIZE - 1,poolMap.size(randomKey));
  }
  @Test public void testPoolCap() throws InterruptedException, ExecutionException {
    Random rand=ThreadLocalRandom.current();
    String randomKey=String.valueOf(rand.nextInt());
    List<String> randomValues=new ArrayList<>();
    for (int i=0; i < POOL_SIZE * 2; i++) {
      String randomValue=String.valueOf(rand.nextInt());
      randomValues.add(randomValue);
      if (i < POOL_SIZE - 1) {
        runThread(randomKey,randomValue,null);
      }
 else {
        runThread(randomKey,randomValue,randomValues.get((i - POOL_SIZE + 1) % POOL_SIZE));
      }
    }
    assertEquals(POOL_SIZE,poolMap.size(randomKey));
  }
}
