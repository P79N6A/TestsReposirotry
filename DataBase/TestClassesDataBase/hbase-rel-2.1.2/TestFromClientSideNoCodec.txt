/** 
 * Do some ops and prove that client and server can work w/o codecs; that we can pb all the time. Good for third-party clients or simple scripts that want to talk direct to hbase.
 */
@Category({MediumTests.class,ClientTests.class}) public class TestFromClientSideNoCodec {
  @ClassRule public static final HBaseClassTestRule CLASS_RULE=HBaseClassTestRule.forClass(TestFromClientSideNoCodec.class);
  protected final static HBaseTestingUtility TEST_UTIL=new HBaseTestingUtility();
  @Rule public TestName name=new TestName();
  /** 
 * @throws java.lang.Exception
 */
  @BeforeClass public static void setUpBeforeClass() throws Exception {
    TEST_UTIL.getConfiguration().set("hbase.client.default.rpc.codec","");
    TEST_UTIL.startMiniCluster(1);
  }
  /** 
 * @throws java.lang.Exception
 */
  @AfterClass public static void tearDownAfterClass() throws Exception {
    TEST_UTIL.shutdownMiniCluster();
  }
  @Test public void testBasics() throws IOException {
    final TableName tableName=TableName.valueOf(name.getMethodName());
    final byte[][] fs=new byte[][]{Bytes.toBytes("cf1"),Bytes.toBytes("cf2"),Bytes.toBytes("cf3")};
    Table ht=TEST_UTIL.createTable(tableName,fs);
    final byte[] row=Bytes.toBytes("row");
    Put p=new Put(row);
    for (    byte[] f : fs) {
      p.addColumn(f,f,f);
    }
    ht.put(p);
    Result r=ht.get(new Get(row));
    int i=0;
    for (CellScanner cellScanner=r.cellScanner(); cellScanner.advance(); ) {
      Cell cell=cellScanner.current();
      byte[] f=fs[i++];
      assertTrue(Bytes.toString(f),Bytes.equals(cell.getValueArray(),cell.getValueOffset(),cell.getValueLength(),f,0,f.length));
    }
    byte[] f=fs[0];
    Get get=new Get(row);
    get.addFamily(f);
    r=ht.get(get);
    assertTrue(r.toString(),r.containsColumn(f,f));
    ResultScanner scanner=ht.getScanner(new Scan());
    int count=0;
    while ((r=scanner.next()) != null) {
      assertTrue(r.listCells().size() == 3);
      count++;
    }
    assertTrue(count == 1);
  }
  @Test public void testNoCodec(){
    Configuration c=new Configuration();
    c.set("hbase.client.default.rpc.codec","");
    String codec=AbstractRpcClient.getDefaultCodec(c);
    assertTrue(codec == null || codec.length() == 0);
  }
}
