public static class FailureInjectingReplicationEndpointForTest extends ReplicationEndpointForTest {
  private final AtomicBoolean failNext=new AtomicBoolean(false);
  @Override protected Callable<Integer> createReplicator(  List<Entry> entries,  int ordinal){
    return () -> {
      if (failNext.compareAndSet(false,true)) {
        int batchIndex=replicateEntries(entries,ordinal);
        entriesCount+=entries.size();
        int count=batchCount.incrementAndGet();
        LOG.info("Completed replicating batch " + System.identityHashCode(entries) + " count="+ count);
        return batchIndex;
      }
 else       if (failNext.compareAndSet(true,false)) {
        throw new ServiceException("Injected failure");
      }
      return ordinal;
    }
;
  }
}
