<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../jacoco-resources/report.gif" type="image/gif"/><title>VariableTest.java</title><link rel="stylesheet" href="../../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">commons-jxpath (Jan 19, 2019 5:24:34 PM)</a> &gt; <a href="../../index.html" class="el_group">commons-jxpath</a> &gt; <a href="../index.html" class="el_bundle">src/test</a> &gt; <a href="index.source.html" class="el_package">org.apache.commons.jxpath.ri.compiler</a> &gt; <span class="el_source">VariableTest.java</span></div><h1>VariableTest.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.apache.commons.jxpath.ri.compiler;

import org.apache.commons.jxpath.JXPathContext;
import org.apache.commons.jxpath.JXPathTestCase;
import org.apache.commons.jxpath.TestMixedModelBean;
import org.apache.commons.jxpath.Variables;

/**
 * Test basic functionality of JXPath - infoset types,
 * operations.
 *
 * @author Dmitri Plotnikov
 * @version $Revision$ $Date$
 */
<span class="fc" id="L31">public class VariableTest extends JXPathTestCase {</span>
    private JXPathContext context;

    public void setUp() {
<span class="pc bpc" id="L35" title="1 of 2 branches missed.">        if (context == null) {</span>
<span class="fc" id="L36">            context = JXPathContext.newContext(new TestMixedModelBean());</span>
<span class="fc" id="L37">            context.setFactory(new VariableFactory());</span>

<span class="fc" id="L39">            Variables vars = context.getVariables();</span>
<span class="fc" id="L40">            vars.declareVariable(&quot;a&quot;, new Double(1));</span>
<span class="fc" id="L41">            vars.declareVariable(&quot;b&quot;, new Double(1));</span>
<span class="fc" id="L42">            vars.declareVariable(&quot;c&quot;, null);</span>
<span class="fc" id="L43">            vars.declareVariable(&quot;d&quot;, new String[] { &quot;a&quot;, &quot;b&quot; });</span>
<span class="fc" id="L44">            vars.declareVariable(&quot;integer&quot;, new Integer(1));</span>
<span class="fc" id="L45">            vars.declareVariable(&quot;nan&quot;, new Double(Double.NaN));</span>
<span class="fc" id="L46">            vars.declareVariable(&quot;x&quot;, null);</span>
        }
<span class="fc" id="L48">    }</span>

    public void testVariables() {
        // Variables
<span class="fc" id="L52">        assertXPathValueAndPointer(context, &quot;$a&quot;, new Double(1), &quot;$a&quot;);</span>
<span class="fc" id="L53">    }</span>

    public void testVariablesInExpressions() {
<span class="fc" id="L56">        assertXPathValue(context, &quot;$a = $b&quot;, Boolean.TRUE);</span>

<span class="fc" id="L58">        assertXPathValue(context, &quot;$a = $nan&quot;, Boolean.FALSE);</span>

<span class="fc" id="L60">        assertXPathValue(context, &quot;$a + 1&quot;, new Double(2));</span>

<span class="fc" id="L62">        assertXPathValue(context, &quot;$c&quot;, null);</span>

<span class="fc" id="L64">        assertXPathValue(context, &quot;$d[2]&quot;, &quot;b&quot;);</span>
<span class="fc" id="L65">    }</span>

    public void testInvalidVariableName() {
<span class="fc" id="L68">        boolean exception = false;</span>
        try {
<span class="nc" id="L70">            context.getValue(&quot;$none&quot;);</span>
<span class="nc" id="L71">        }</span>
<span class="fc" id="L72">        catch (Exception ex) {</span>
<span class="fc" id="L73">            exception = true;</span>
        }
<span class="fc" id="L75">        assertTrue(</span>
<span class="fc" id="L76">            &quot;Evaluating '$none', expected exception - did not get it&quot;,</span>
<span class="fc" id="L77">            exception);</span>
        
<span class="fc" id="L79">        exception = false;</span>
        try {
<span class="nc" id="L81">            context.setValue(&quot;$none&quot;, new Integer(1));</span>
<span class="nc" id="L82">        }</span>
<span class="fc" id="L83">        catch (Exception ex) {</span>
<span class="fc" id="L84">            exception = true;</span>
        }
<span class="fc" id="L86">        assertTrue(</span>
<span class="fc" id="L87">            &quot;Setting '$none = 1', expected exception - did not get it&quot;,</span>
<span class="fc" id="L88">            exception);</span>
<span class="fc" id="L89">    }</span>

    public void testNestedContext() {
<span class="fc" id="L92">        JXPathContext nestedContext = JXPathContext.newContext(context, null);</span>

<span class="fc" id="L94">        assertXPathValue(nestedContext, &quot;$a&quot;, new Double(1));</span>
<span class="fc" id="L95">    }</span>

    public void testSetValue() {
<span class="fc" id="L98">        assertXPathSetValue(context, &quot;$x&quot;, new Integer(1));</span>
<span class="fc" id="L99">    }</span>

    public void testCreatePathDeclareVariable() {
        // Calls factory.declareVariable(&quot;string&quot;)
<span class="fc" id="L103">        assertXPathCreatePath(context, &quot;$string&quot;, null, &quot;$string&quot;);</span>
<span class="fc" id="L104">    }</span>

    public void testCreatePathAndSetValueDeclareVariable() {
        // Calls factory.declareVariable(&quot;string&quot;)
<span class="fc" id="L108">        assertXPathCreatePathAndSetValue(</span>
<span class="fc" id="L109">            context,</span>
<span class="fc" id="L110">            &quot;$string&quot;,</span>
<span class="fc" id="L111">            &quot;Value&quot;,</span>
<span class="fc" id="L112">            &quot;$string&quot;);</span>
<span class="fc" id="L113">    }</span>

    public void testCreatePathDeclareVariableSetCollectionElement() {
        // Calls factory.declareVariable(&quot;stringArray&quot;). 
        // The factory needs to create a collection
<span class="fc" id="L118">        assertXPathCreatePath(</span>
<span class="fc" id="L119">            context,</span>
<span class="fc" id="L120">            &quot;$stringArray[2]&quot;,</span>
<span class="fc" id="L121">            &quot;&quot;,</span>
<span class="fc" id="L122">            &quot;$stringArray[2]&quot;);</span>

        // See if the factory populated the first element as well
<span class="fc" id="L125">        assertEquals(</span>
<span class="fc" id="L126">            &quot;Created &lt;&quot; + &quot;$stringArray[1]&quot; + &quot;&gt;&quot;,</span>
<span class="fc" id="L127">            &quot;Value1&quot;,</span>
<span class="fc" id="L128">            context.getValue(&quot;$stringArray[1]&quot;));</span>
<span class="fc" id="L129">    }</span>

    public void testCreateAndSetValuePathDeclareVariableSetCollectionElement() {
        // Calls factory.declareVariable(&quot;stringArray&quot;). 
        // The factory needs to create a collection
<span class="fc" id="L134">        assertXPathCreatePathAndSetValue(</span>
<span class="fc" id="L135">            context,</span>
<span class="fc" id="L136">            &quot;$stringArray[2]&quot;,</span>
<span class="fc" id="L137">            &quot;Value2&quot;,</span>
<span class="fc" id="L138">            &quot;$stringArray[2]&quot;);</span>

        // See if the factory populated the first element as well
<span class="fc" id="L141">        assertEquals(</span>
<span class="fc" id="L142">            &quot;Created &lt;&quot; + &quot;$stringArray[1]&quot; + &quot;&gt;&quot;,</span>
<span class="fc" id="L143">            &quot;Value1&quot;,</span>
<span class="fc" id="L144">            context.getValue(&quot;$stringArray[1]&quot;));</span>
<span class="fc" id="L145">    }</span>

    public void testCreatePathExpandCollection() {
<span class="fc" id="L148">        context.getVariables().declareVariable(</span>
<span class="fc" id="L149">            &quot;array&quot;,</span>
<span class="fc" id="L150">            new String[] { &quot;Value1&quot; });</span>

        // Does not involve factory at all - just expands the collection
<span class="fc" id="L153">        assertXPathCreatePath(context, &quot;$array[2]&quot;, &quot;&quot;, &quot;$array[2]&quot;);</span>

        // Make sure it is still the same array
<span class="fc" id="L156">        assertEquals(</span>
<span class="fc" id="L157">            &quot;Created &lt;&quot; + &quot;$array[1]&quot; + &quot;&gt;&quot;,</span>
<span class="fc" id="L158">            &quot;Value1&quot;,</span>
<span class="fc" id="L159">            context.getValue(&quot;$array[1]&quot;));</span>
<span class="fc" id="L160">    }</span>

    public void testCreatePathAndSetValueExpandCollection() {
<span class="fc" id="L163">        context.getVariables().declareVariable(</span>
<span class="fc" id="L164">            &quot;array&quot;,</span>
<span class="fc" id="L165">            new String[] { &quot;Value1&quot; });</span>

        // Does not involve factory at all - just expands the collection
<span class="fc" id="L168">        assertXPathCreatePathAndSetValue(</span>
<span class="fc" id="L169">            context,</span>
<span class="fc" id="L170">            &quot;$array[2]&quot;,</span>
<span class="fc" id="L171">            &quot;Value2&quot;,</span>
<span class="fc" id="L172">            &quot;$array[2]&quot;);</span>

        // Make sure it is still the same array
<span class="fc" id="L175">        assertEquals(</span>
<span class="fc" id="L176">            &quot;Created &lt;&quot; + &quot;$array[1]&quot; + &quot;&gt;&quot;,</span>
<span class="fc" id="L177">            &quot;Value1&quot;,</span>
<span class="fc" id="L178">            context.getValue(&quot;$array[1]&quot;));</span>
<span class="fc" id="L179">    }</span>

    public void testCreatePathDeclareVariableSetProperty() {
        // Calls factory.declareVariable(&quot;test&quot;). 
        // The factory should create a TestBean
<span class="fc" id="L184">        assertXPathCreatePath(</span>
<span class="fc" id="L185">            context,</span>
<span class="fc" id="L186">            &quot;$test/boolean&quot;,</span>
<span class="fc" id="L187">            Boolean.FALSE,</span>
<span class="fc" id="L188">            &quot;$test/boolean&quot;);</span>

<span class="fc" id="L190">    }</span>

    public void testCreatePathAndSetValueDeclareVariableSetProperty() {
        // Calls factory.declareVariable(&quot;test&quot;). 
        // The factory should create a TestBean
<span class="fc" id="L195">        assertXPathCreatePathAndSetValue(</span>
<span class="fc" id="L196">            context,</span>
<span class="fc" id="L197">            &quot;$test/boolean&quot;,</span>
<span class="fc" id="L198">            Boolean.TRUE,</span>
<span class="fc" id="L199">            &quot;$test/boolean&quot;);</span>

<span class="fc" id="L201">    }</span>

    public void testCreatePathDeclareVariableSetCollectionElementProperty() {
        // Calls factory.declareVariable(&quot;testArray&quot;).
        // The factory should create a collection of TestBeans.
        // Then calls factory.createObject(..., collection, &quot;testArray&quot;, 1).
        // That one should produce an instance of TestBean and 
        // put it in the collection at index 1.
<span class="fc" id="L209">        assertXPathCreatePath(</span>
<span class="fc" id="L210">            context,</span>
<span class="fc" id="L211">            &quot;$testArray[2]/boolean&quot;,</span>
<span class="fc" id="L212">            Boolean.FALSE,</span>
<span class="fc" id="L213">            &quot;$testArray[2]/boolean&quot;);</span>
<span class="fc" id="L214">    }</span>

    public void testCreatePathAndSetValueDeclVarSetCollectionElementProperty() {
        // Calls factory.declareVariable(&quot;testArray&quot;).
        // The factory should create a collection of TestBeans.
        // Then calls factory.createObject(..., collection, &quot;testArray&quot;, 1).
        // That one should produce an instance of TestBean and 
        // put it in the collection at index 1.
<span class="fc" id="L222">        assertXPathCreatePathAndSetValue(</span>
<span class="fc" id="L223">            context,</span>
<span class="fc" id="L224">            &quot;$testArray[2]/boolean&quot;,</span>
<span class="fc" id="L225">            Boolean.TRUE,</span>
<span class="fc" id="L226">            &quot;$testArray[2]/boolean&quot;);</span>
<span class="fc" id="L227">    }</span>

    public void testRemovePathUndeclareVariable() {
        // Undeclare variable
<span class="fc" id="L231">        context.getVariables().declareVariable(&quot;temp&quot;, &quot;temp&quot;);</span>
<span class="fc" id="L232">        context.removePath(&quot;$temp&quot;);</span>
<span class="fc" id="L233">        assertTrue(</span>
<span class="fc" id="L234">            &quot;Undeclare variable&quot;,</span>
<span class="pc bpc" id="L235" title="1 of 2 branches missed.">            !context.getVariables().isDeclaredVariable(&quot;temp&quot;));</span>

<span class="fc" id="L237">    }</span>

    public void testRemovePathArrayElement() {
        // Remove array element - reassigns the new array to the var
<span class="fc" id="L241">        context.getVariables().declareVariable(</span>
<span class="fc" id="L242">            &quot;temp&quot;,</span>
<span class="fc" id="L243">            new String[] { &quot;temp1&quot;, &quot;temp2&quot; });</span>
<span class="fc" id="L244">        context.removePath(&quot;$temp[1]&quot;);</span>
<span class="fc" id="L245">        assertEquals(</span>
<span class="fc" id="L246">            &quot;Remove array element&quot;,</span>
<span class="fc" id="L247">            &quot;temp2&quot;,</span>
<span class="fc" id="L248">            context.getValue(&quot;$temp[1]&quot;));</span>
<span class="fc" id="L249">    }</span>

    public void testRemovePathCollectionElement() {
        // Remove list element - does not create a new list
<span class="fc" id="L253">        context.getVariables().declareVariable(&quot;temp&quot;, list(&quot;temp1&quot;, &quot;temp2&quot;));</span>
<span class="fc" id="L254">        context.removePath(&quot;$temp[1]&quot;);</span>
<span class="fc" id="L255">        assertEquals(</span>
<span class="fc" id="L256">            &quot;Remove collection element&quot;,</span>
<span class="fc" id="L257">            &quot;temp2&quot;,</span>
<span class="fc" id="L258">            context.getValue(&quot;$temp[1]&quot;));</span>
<span class="fc" id="L259">    }</span>
    
    public void testUnionOfVariableAndNode() throws Exception {
<span class="fc" id="L262">        assertXPathValue(context, &quot;count($a | /document/vendor/location)&quot;, new Double(3));</span>
<span class="fc" id="L263">        assertXPathValue(context, &quot;count($a | /list)&quot;, new Double(7)); //$o + list which contains six discrete values (one is duped, wrapped in a Container)</span>
<span class="fc" id="L264">    }</span>

    public void testIterateVariable() throws Exception {
<span class="fc" id="L267">        assertXPathValueIterator(context, &quot;$d&quot;, list(&quot;a&quot;, &quot;b&quot;));</span>
<span class="fc" id="L268">        assertXPathValue(context, &quot;$d = 'a'&quot;, Boolean.TRUE);</span>
<span class="fc" id="L269">        assertXPathValue(context, &quot;$d = 'b'&quot;, Boolean.TRUE);</span>
<span class="fc" id="L270">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span>commons-jxpath (Jan 19, 2019 5:24:34 PM)</div></body></html>