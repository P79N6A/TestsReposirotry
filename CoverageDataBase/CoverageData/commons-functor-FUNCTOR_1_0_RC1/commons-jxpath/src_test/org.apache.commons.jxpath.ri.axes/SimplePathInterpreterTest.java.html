<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../jacoco-resources/report.gif" type="image/gif"/><title>SimplePathInterpreterTest.java</title><link rel="stylesheet" href="../../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">commons-jxpath (Jan 19, 2019 5:24:34 PM)</a> &gt; <a href="../../index.html" class="el_group">commons-jxpath</a> &gt; <a href="../index.html" class="el_bundle">src/test</a> &gt; <a href="index.source.html" class="el_package">org.apache.commons.jxpath.ri.axes</a> &gt; <span class="el_source">SimplePathInterpreterTest.java</span></div><h1>SimplePathInterpreterTest.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.apache.commons.jxpath.ri.axes;

import java.util.HashMap;

import junit.framework.TestCase;

import org.apache.commons.jxpath.JXPathContext;
import org.apache.commons.jxpath.NestedTestBean;
import org.apache.commons.jxpath.Pointer;
import org.apache.commons.jxpath.TestNull;
import org.apache.commons.jxpath.ri.model.NodePointer;
import org.apache.commons.jxpath.ri.model.VariablePointer;
import org.apache.commons.jxpath.ri.model.beans.BeanPointer;
import org.apache.commons.jxpath.ri.model.beans.BeanPropertyPointer;
import org.apache.commons.jxpath.ri.model.beans.CollectionPointer;
import org.apache.commons.jxpath.ri.model.beans.NullElementPointer;
import org.apache.commons.jxpath.ri.model.beans.NullPointer;
import org.apache.commons.jxpath.ri.model.beans.NullPropertyPointer;
import org.apache.commons.jxpath.ri.model.beans.TestBeanFactory;
import org.apache.commons.jxpath.ri.model.dom.DOMNodePointer;
import org.apache.commons.jxpath.ri.model.dynamic.DynamicPointer;
import org.apache.commons.jxpath.ri.model.dynamic.DynamicPropertyPointer;

<span class="fc" id="L40">public class SimplePathInterpreterTest extends TestCase {</span>

    private TestBeanWithNode bean;
    private JXPathContext context;

    protected void setUp() throws Exception {
<span class="fc" id="L46">        bean = TestBeanWithNode.createTestBeanWithDOM();</span>
<span class="fc" id="L47">        HashMap submap = new HashMap();</span>
<span class="fc" id="L48">        submap.put(&quot;key&quot;, new NestedTestBean(&quot;Name 9&quot;));</span>
<span class="fc" id="L49">        submap.put(&quot;strings&quot;, bean.getNestedBean().getStrings());</span>
<span class="fc" id="L50">        bean.getList().add(new int[]{1, 2});</span>
<span class="fc" id="L51">        bean.getList().add(bean.getVendor());</span>
<span class="fc" id="L52">        bean.getMap().put(&quot;Key3&quot;,</span>
<span class="fc" id="L53">            new Object[]{</span>
<span class="fc" id="L54">                new NestedTestBean(&quot;some&quot;),</span>
<span class="fc" id="L55">                new Integer(2),</span>
<span class="fc" id="L56">                bean.getVendor(),</span>
<span class="fc" id="L57">                submap</span>
            }
        );
<span class="fc" id="L60">        bean.getMap().put(&quot;Key4&quot;, bean.getVendor());</span>
<span class="fc" id="L61">        bean.getMap().put(&quot;Key5&quot;, submap);</span>
<span class="fc" id="L62">        bean.getMap().put(&quot;Key6&quot;, new Object[0]);</span>
<span class="fc" id="L63">        context = JXPathContext.newContext(null, bean);</span>
<span class="fc" id="L64">        context.setLenient(true);</span>
<span class="fc" id="L65">        context.setFactory(new TestBeanFactory());</span>
<span class="fc" id="L66">    }</span>

    public void testDoStepNoPredicatesPropertyOwner() {
        // Existing scalar property
<span class="fc" id="L70">        assertValueAndPointer(&quot;/int&quot;,</span>
<span class="fc" id="L71">                new Integer(1),</span>
<span class="fc" id="L72">                &quot;/int&quot;,</span>
<span class="fc" id="L73">                &quot;Bb&quot;,</span>
<span class="fc" id="L74">                &quot;BbB&quot;);</span>

        // self::
<span class="fc" id="L77">        assertValueAndPointer(&quot;/./int&quot;,</span>
<span class="fc" id="L78">                new Integer(1),</span>
<span class="fc" id="L79">                &quot;/int&quot;,</span>
<span class="fc" id="L80">                &quot;Bb&quot;,</span>
<span class="fc" id="L81">                &quot;BbB&quot;);</span>

        // Missing property
<span class="fc" id="L84">        assertNullPointer(&quot;/foo&quot;,</span>
<span class="fc" id="L85">                &quot;/foo&quot;,</span>
<span class="fc" id="L86">                &quot;Bn&quot;);</span>

        // existingProperty/existingScalarProperty
<span class="fc" id="L89">        assertValueAndPointer(&quot;/nestedBean/int&quot;,</span>
<span class="fc" id="L90">                new Integer(1),</span>
<span class="fc" id="L91">                &quot;/nestedBean/int&quot;,</span>
<span class="fc" id="L92">                &quot;BbBb&quot;,</span>
<span class="fc" id="L93">                &quot;BbBbB&quot;);</span>

        // existingProperty/collectionProperty
<span class="fc" id="L96">        assertValueAndPointer(&quot;/nestedBean/strings&quot;,</span>
<span class="fc" id="L97">                bean.getNestedBean().getStrings(),</span>
<span class="fc" id="L98">                &quot;/nestedBean/strings&quot;,</span>
<span class="fc" id="L99">                &quot;BbBb&quot;,</span>
<span class="fc" id="L100">                &quot;BbBbC&quot;);</span>

        // existingProperty/missingProperty
<span class="fc" id="L103">        assertNullPointer(&quot;/nestedBean/foo&quot;,</span>
<span class="fc" id="L104">                &quot;/nestedBean/foo&quot;,</span>
<span class="fc" id="L105">                &quot;BbBn&quot;);</span>

        // map/missingProperty
<span class="fc" id="L108">        assertNullPointer(&quot;/map/foo&quot;,</span>
<span class="fc" id="L109">                &quot;/map[@name='foo']&quot;,</span>
<span class="fc" id="L110">                &quot;BbDd&quot;);</span>

        // Existing property by search in collection
<span class="fc" id="L113">        assertValueAndPointer(&quot;/list/int&quot;,</span>
<span class="fc" id="L114">                new Integer(1),</span>
<span class="fc" id="L115">                &quot;/list[3]/int&quot;,</span>
<span class="fc" id="L116">                &quot;BbBb&quot;,</span>
<span class="fc" id="L117">                &quot;BbBbB&quot;);</span>

        // Missing property by search in collection
<span class="fc" id="L120">        assertNullPointer(&quot;/list/foo&quot;,</span>
<span class="fc" id="L121">                &quot;/list[1]/foo&quot;,</span>
<span class="fc" id="L122">                &quot;BbBn&quot;);</span>

        // existingProperty/missingProperty/missingProperty
<span class="fc" id="L125">        assertNullPointer(&quot;/nestedBean/foo/bar&quot;,</span>
<span class="fc" id="L126">                &quot;/nestedBean/foo/bar&quot;,</span>
<span class="fc" id="L127">                &quot;BbBnNn&quot;);</span>

        // collection/existingProperty/missingProperty
<span class="fc" id="L130">        assertNullPointer(&quot;/list/int/bar&quot;,</span>
<span class="fc" id="L131">                &quot;/list[3]/int/bar&quot;,</span>
<span class="fc" id="L132">                &quot;BbBbBn&quot;);</span>

        // collectionProperty/missingProperty/missingProperty
<span class="fc" id="L135">        assertNullPointer(&quot;/list/foo/bar&quot;,</span>
<span class="fc" id="L136">                &quot;/list[1]/foo/bar&quot;,</span>
<span class="fc" id="L137">                &quot;BbBnNn&quot;);</span>

        // map/missingProperty/anotherStep
<span class="fc" id="L140">        assertNullPointer(&quot;/map/foo/bar&quot;,</span>
<span class="fc" id="L141">                &quot;/map[@name='foo']/bar&quot;,</span>
<span class="fc" id="L142">                &quot;BbDdNn&quot;);</span>

        // Existing dynamic property
<span class="fc" id="L145">        assertValueAndPointer(&quot;/map/Key1&quot;,</span>
<span class="fc" id="L146">                &quot;Value 1&quot;,</span>
<span class="fc" id="L147">                &quot;/map[@name='Key1']&quot;,</span>
<span class="fc" id="L148">                &quot;BbDd&quot;,</span>
<span class="fc" id="L149">                &quot;BbDdB&quot;);</span>

        // collectionProperty
<span class="fc" id="L152">        assertValueAndPointer(&quot;/integers&quot;,</span>
<span class="fc" id="L153">                bean.getIntegers(),</span>
<span class="fc" id="L154">                &quot;/integers&quot;,</span>
<span class="fc" id="L155">                &quot;Bb&quot;,</span>
<span class="fc" id="L156">                &quot;BbC&quot;);</span>
<span class="fc" id="L157">    }</span>

    public void testDoStepNoPredicatesStandard() {
        // Existing DOM node
<span class="fc" id="L161">        assertValueAndPointer(&quot;/vendor/location/address/city&quot;,</span>
<span class="fc" id="L162">                &quot;Fruit Market&quot;,</span>
<span class="fc" id="L163">                &quot;/vendor/location[2]/address[1]/city[1]&quot;,</span>
<span class="fc" id="L164">                &quot;BbMMMM&quot;);</span>

        // Missing DOM node
<span class="fc" id="L167">        assertNullPointer(&quot;/vendor/location/address/pity&quot;,</span>
<span class="fc" id="L168">                &quot;/vendor/location[1]/address[1]/pity&quot;,</span>
<span class="fc" id="L169">                &quot;BbMMMn&quot;);</span>

        // Missing DOM node inside a missing element
<span class="fc" id="L172">        assertNullPointer(&quot;/vendor/location/address/itty/bitty&quot;,</span>
<span class="fc" id="L173">                &quot;/vendor/location[1]/address[1]/itty/bitty&quot;,</span>
<span class="fc" id="L174">                &quot;BbMMMnNn&quot;);</span>

        // Missing DOM node by search for the best match
<span class="fc" id="L177">        assertNullPointer(&quot;/vendor/location/address/city/pretty&quot;,</span>
<span class="fc" id="L178">                &quot;/vendor/location[2]/address[1]/city[1]/pretty&quot;,</span>
<span class="fc" id="L179">                &quot;BbMMMMn&quot;);</span>
<span class="fc" id="L180">    }</span>

    public void testDoStepPredicatesPropertyOwner() {
        // missingProperty[@name=foo]
<span class="fc" id="L184">        assertNullPointer(&quot;/foo[@name='foo']&quot;,</span>
<span class="fc" id="L185">                &quot;/foo[@name='foo']&quot;,</span>
<span class="fc" id="L186">                &quot;BnNn&quot;);</span>

        // missingProperty[index]
<span class="fc" id="L189">        assertNullPointer(&quot;/foo[3]&quot;,</span>
<span class="fc" id="L190">                &quot;/foo[3]&quot;,</span>
<span class="fc" id="L191">                &quot;Bn&quot;);</span>
<span class="fc" id="L192">    }</span>

    public void testDoStepPredicatesStandard() {
        // Looking for an actual XML attribute called &quot;name&quot;
        // nodeProperty/name[@name=value]
<span class="fc" id="L197">        assertValueAndPointer(&quot;/vendor/contact[@name='jack']&quot;,</span>
<span class="fc" id="L198">                &quot;Jack&quot;,</span>
<span class="fc" id="L199">                &quot;/vendor/contact[2]&quot;,</span>
<span class="fc" id="L200">                &quot;BbMM&quot;);</span>

        // Indexing in XML
<span class="fc" id="L203">        assertValueAndPointer(&quot;/vendor/contact[2]&quot;,</span>
<span class="fc" id="L204">                &quot;Jack&quot;,</span>
<span class="fc" id="L205">                &quot;/vendor/contact[2]&quot;,</span>
<span class="fc" id="L206">                &quot;BbMM&quot;);</span>

        // Indexing in XML, no result
<span class="fc" id="L209">        assertNullPointer(&quot;/vendor/contact[5]&quot;,</span>
<span class="fc" id="L210">                &quot;/vendor/contact[5]&quot;,</span>
<span class="fc" id="L211">                &quot;BbMn&quot;);</span>

        // Combination of search by name and indexing in XML
<span class="fc" id="L214">        assertValueAndPointer(&quot;/vendor/contact[@name='jack'][2]&quot;,</span>
<span class="fc" id="L215">                &quot;Jack Black&quot;,</span>
<span class="fc" id="L216">                &quot;/vendor/contact[4]&quot;,</span>
<span class="fc" id="L217">                &quot;BbMM&quot;);</span>

        // Combination of search by name and indexing in XML
<span class="fc" id="L220">        assertValueAndPointer(&quot;/vendor/contact[@name='jack'][2]&quot;,</span>
<span class="fc" id="L221">                &quot;Jack Black&quot;,</span>
<span class="fc" id="L222">                &quot;/vendor/contact[4]&quot;,</span>
<span class="fc" id="L223">                &quot;BbMM&quot;);</span>
<span class="fc" id="L224">    }</span>

    public void testDoPredicateName() {
        // existingProperty[@name=existingProperty]
<span class="fc" id="L228">        assertValueAndPointer(&quot;/nestedBean[@name='int']&quot;,</span>
<span class="fc" id="L229">                new Integer(1),</span>
<span class="fc" id="L230">                &quot;/nestedBean/int&quot;,</span>
<span class="fc" id="L231">                &quot;BbBb&quot;,</span>
<span class="fc" id="L232">                &quot;BbBbB&quot;);</span>

        // /self::node()[@name=existingProperty]
<span class="fc" id="L235">        assertValueAndPointer(&quot;/.[@name='int']&quot;,</span>
<span class="fc" id="L236">                new Integer(1),</span>
<span class="fc" id="L237">                &quot;/int&quot;,</span>
<span class="fc" id="L238">                &quot;Bb&quot;,</span>
<span class="fc" id="L239">                &quot;BbB&quot;);</span>

        // dynamicProperty[@name=existingProperty]
<span class="fc" id="L242">        assertValueAndPointer(&quot;/map[@name='Key1']&quot;,</span>
<span class="fc" id="L243">                &quot;Value 1&quot;,</span>
<span class="fc" id="L244">                &quot;/map[@name='Key1']&quot;,</span>
<span class="fc" id="L245">                &quot;BbDd&quot;,</span>
<span class="fc" id="L246">                &quot;BbDdB&quot;);</span>

        // existingProperty[@name=collectionProperty]
<span class="fc" id="L249">        assertValueAndPointer(&quot;/nestedBean[@name='strings']&quot;,</span>
<span class="fc" id="L250">                bean.getNestedBean().getStrings(),</span>
<span class="fc" id="L251">                &quot;/nestedBean/strings&quot;,</span>
<span class="fc" id="L252">                &quot;BbBb&quot;,</span>
<span class="fc" id="L253">                &quot;BbBbC&quot;);</span>

        // existingProperty[@name=missingProperty]
<span class="fc" id="L256">        assertNullPointer(&quot;/nestedBean[@name='foo']&quot;,</span>
<span class="fc" id="L257">                &quot;/nestedBean[@name='foo']&quot;,</span>
<span class="fc" id="L258">                &quot;BbBn&quot;);</span>

        // map[@name=collectionProperty]
<span class="fc" id="L261">        assertValueAndPointer(&quot;/map[@name='Key3']&quot;,</span>
<span class="fc" id="L262">                bean.getMap().get(&quot;Key3&quot;),</span>
<span class="fc" id="L263">                &quot;/map[@name='Key3']&quot;,</span>
<span class="fc" id="L264">                &quot;BbDd&quot;,</span>
<span class="fc" id="L265">                &quot;BbDdC&quot;);</span>
                
        // map[@name=missingProperty]
<span class="fc" id="L268">        assertNullPointer(&quot;/map[@name='foo']&quot;,</span>
<span class="fc" id="L269">                &quot;/map[@name='foo']&quot;,</span>
<span class="fc" id="L270">                &quot;BbDd&quot;);</span>

        // collectionProperty[@name=...] (find node)
<span class="fc" id="L273">        assertValueAndPointer(&quot;/list[@name='fruitco']&quot;,</span>
<span class="fc" id="L274">                context.getValue(&quot;/vendor&quot;),</span>
<span class="fc" id="L275">                &quot;/list[5]&quot;,</span>
<span class="fc" id="L276">                &quot;BbCM&quot;);</span>

        // collectionProperty[@name=...] (find map entry)
<span class="fc" id="L279">        assertValueAndPointer(&quot;/map/Key3[@name='key']/name&quot;,</span>
<span class="fc" id="L280">                &quot;Name 9&quot;,</span>
<span class="fc" id="L281">                &quot;/map[@name='Key3'][4][@name='key']/name&quot;,</span>
<span class="fc" id="L282">                &quot;BbDdCDdBb&quot;,</span>
<span class="fc" id="L283">                &quot;BbDdCDdBbB&quot;);</span>

        // map/collectionProperty[@name...]
<span class="fc" id="L286">        assertValueAndPointer(&quot;map/Key3[@name='fruitco']&quot;,</span>
<span class="fc" id="L287">                context.getValue(&quot;/vendor&quot;),</span>
<span class="fc" id="L288">                &quot;/map[@name='Key3'][3]&quot;,</span>
<span class="fc" id="L289">                &quot;BbDdCM&quot;);</span>

        // Bean property -&gt; DOM Node, name match
<span class="fc" id="L292">        assertValueAndPointer(&quot;/vendor[@name='fruitco']&quot;,</span>
<span class="fc" id="L293">                context.getValue(&quot;/vendor&quot;),</span>
<span class="fc" id="L294">                &quot;/vendor&quot;,</span>
<span class="fc" id="L295">                &quot;BbM&quot;);</span>

        // Bean property -&gt; DOM Node, name mismatch
<span class="fc" id="L298">        assertNullPointer(&quot;/vendor[@name='foo']&quot;,</span>
<span class="fc" id="L299">                &quot;/vendor[@name='foo']&quot;,</span>
<span class="fc" id="L300">                &quot;BbMn&quot;);</span>

<span class="fc" id="L302">        assertNullPointer(&quot;/vendor[@name='foo'][3]&quot;,</span>
<span class="fc" id="L303">                &quot;/vendor[@name='foo'][3]&quot;,</span>
<span class="fc" id="L304">                &quot;BbMn&quot;);</span>

        // existingProperty(bean)[@name=missingProperty]/anotherStep
<span class="fc" id="L307">        assertNullPointer(&quot;/nestedBean[@name='foo']/bar&quot;,</span>
<span class="fc" id="L308">                &quot;/nestedBean[@name='foo']/bar&quot;,</span>
<span class="fc" id="L309">                &quot;BbBnNn&quot;);</span>

        // map[@name=missingProperty]/anotherStep
<span class="fc" id="L312">        assertNullPointer(&quot;/map[@name='foo']/bar&quot;,</span>
<span class="fc" id="L313">                &quot;/map[@name='foo']/bar&quot;,</span>
<span class="fc" id="L314">                &quot;BbDdNn&quot;);</span>

        // existingProperty(node)[@name=missingProperty]/anotherStep
<span class="fc" id="L317">        assertNullPointer(&quot;/vendor[@name='foo']/bar&quot;,</span>
<span class="fc" id="L318">                &quot;/vendor[@name='foo']/bar&quot;,</span>
<span class="fc" id="L319">                &quot;BbMnNn&quot;);</span>

        // existingProperty(node)[@name=missingProperty][index]/anotherStep
<span class="fc" id="L322">        assertNullPointer(&quot;/vendor[@name='foo'][3]/bar&quot;,</span>
<span class="fc" id="L323">                &quot;/vendor[@name='foo'][3]/bar&quot;,</span>
<span class="fc" id="L324">                &quot;BbMnNn&quot;);</span>

        // Existing dynamic property + existing property
<span class="fc" id="L327">        assertValueAndPointer(&quot;/map[@name='Key2'][@name='name']&quot;,</span>
<span class="fc" id="L328">                &quot;Name 6&quot;,</span>
<span class="fc" id="L329">                &quot;/map[@name='Key2']/name&quot;,</span>
<span class="fc" id="L330">                &quot;BbDdBb&quot;,</span>
<span class="fc" id="L331">                &quot;BbDdBbB&quot;);</span>

        // Existing dynamic property + existing property + index
<span class="fc" id="L334">        assertValueAndPointer(&quot;/map[@name='Key2'][@name='strings'][2]&quot;,</span>
<span class="fc" id="L335">                &quot;String 2&quot;,</span>
<span class="fc" id="L336">                &quot;/map[@name='Key2']/strings[2]&quot;,</span>
<span class="fc" id="L337">                &quot;BbDdBb&quot;,</span>
<span class="fc" id="L338">                &quot;BbDdBbB&quot;);</span>

        // bean/map/map/property
<span class="fc" id="L341">        assertValueAndPointer(&quot;map[@name='Key5'][@name='key']/name&quot;,</span>
<span class="fc" id="L342">                &quot;Name 9&quot;,</span>
<span class="fc" id="L343">                &quot;/map[@name='Key5'][@name='key']/name&quot;,</span>
<span class="fc" id="L344">                &quot;BbDdDdBb&quot;,</span>
<span class="fc" id="L345">                &quot;BbDdDdBbB&quot;);</span>

<span class="fc" id="L347">        assertNullPointer(&quot;map[@name='Key2'][@name='foo']&quot;,</span>
<span class="fc" id="L348">                &quot;/map[@name='Key2'][@name='foo']&quot;,</span>
<span class="fc" id="L349">                &quot;BbDdBn&quot;);</span>

<span class="fc" id="L351">        assertNullPointer(&quot;map[@name='Key2'][@name='foo'][@name='bar']&quot;,</span>
<span class="fc" id="L352">                &quot;/map[@name='Key2'][@name='foo'][@name='bar']&quot;,</span>
<span class="fc" id="L353">                &quot;BbDdBnNn&quot;);</span>

        // bean/map/node
<span class="fc" id="L356">        assertValueAndPointer(&quot;map[@name='Key4'][@name='fruitco']&quot;,</span>
<span class="fc" id="L357">                context.getValue(&quot;/vendor&quot;),</span>
<span class="fc" id="L358">                &quot;/map[@name='Key4']&quot;,</span>
<span class="fc" id="L359">                &quot;BbDdM&quot;);</span>
<span class="fc" id="L360">    }</span>

    public void testDoPredicatesStandard() {
        // bean/map/collection/node
<span class="fc" id="L364">        assertValueAndPointer(&quot;map[@name='Key3'][@name='fruitco']&quot;,</span>
<span class="fc" id="L365">                context.getValue(&quot;/vendor&quot;),</span>
<span class="fc" id="L366">                &quot;/map[@name='Key3'][3]&quot;,</span>
<span class="fc" id="L367">                &quot;BbDdCM&quot;);</span>

        // bean/map/collection/missingNode
<span class="fc" id="L370">        assertNullPointer(&quot;map[@name='Key3'][@name='foo']&quot;,</span>
<span class="fc" id="L371">                &quot;/map[@name='Key3'][4][@name='foo']&quot;,</span>
<span class="fc" id="L372">                &quot;BbDdCDd&quot;);</span>

        // bean/map/node
<span class="fc" id="L375">        assertValueAndPointer(&quot;map[@name='Key4'][@name='fruitco']&quot;,</span>
<span class="fc" id="L376">                context.getValue(&quot;/vendor&quot;),</span>
<span class="fc" id="L377">                &quot;/map[@name='Key4']&quot;,</span>
<span class="fc" id="L378">                &quot;BbDdM&quot;);</span>

        // bean/map/emptyCollection[@name=foo]
<span class="fc" id="L381">        assertNullPointer(&quot;map[@name='Key6'][@name='fruitco']&quot;,</span>
<span class="fc" id="L382">                &quot;/map[@name='Key6'][@name='fruitco']&quot;,</span>
<span class="fc" id="L383">                &quot;BbDdCn&quot;);</span>

        // bean/node[@name=foo][index]
<span class="fc" id="L386">        assertValueAndPointer(&quot;/vendor/contact[@name='jack'][2]&quot;,</span>
<span class="fc" id="L387">                &quot;Jack Black&quot;,</span>
<span class="fc" id="L388">                &quot;/vendor/contact[4]&quot;,</span>
<span class="fc" id="L389">                &quot;BbMM&quot;);</span>

        // bean/node[@name=foo][missingIndex]
<span class="fc" id="L392">        assertNullPointer(&quot;/vendor/contact[@name='jack'][5]&quot;,</span>
<span class="fc" id="L393">                &quot;/vendor/contact[@name='jack'][5]&quot;,</span>
<span class="fc" id="L394">                &quot;BbMnNn&quot;);</span>

        // bean/node/.[@name=foo][index]
<span class="fc" id="L397">        assertValueAndPointer(&quot;/vendor/contact/.[@name='jack']&quot;,</span>
<span class="fc" id="L398">                &quot;Jack&quot;,</span>
<span class="fc" id="L399">                &quot;/vendor/contact[2]&quot;,</span>
<span class="fc" id="L400">                &quot;BbMM&quot;);</span>
<span class="fc" id="L401">    }</span>

    public void testDoPredicateIndex() {
        // Existing dynamic property + existing property + index
<span class="fc" id="L405">        assertValueAndPointer(&quot;/map[@name='Key2'][@name='strings'][2]&quot;,</span>
<span class="fc" id="L406">                &quot;String 2&quot;,</span>
<span class="fc" id="L407">                &quot;/map[@name='Key2']/strings[2]&quot;,</span>
<span class="fc" id="L408">                &quot;BbDdBb&quot;,</span>
<span class="fc" id="L409">                &quot;BbDdBbB&quot;);</span>

        // existingProperty[@name=collectionProperty][index]
<span class="fc" id="L412">        assertValueAndPointer(&quot;/nestedBean[@name='strings'][2]&quot;,</span>
<span class="fc" id="L413">                bean.getNestedBean().getStrings()[1],</span>
<span class="fc" id="L414">                &quot;/nestedBean/strings[2]&quot;,</span>
<span class="fc" id="L415">                &quot;BbBb&quot;,</span>
<span class="fc" id="L416">                &quot;BbBbB&quot;);</span>

        // existingProperty[@name=missingProperty][index]
<span class="fc" id="L419">        assertNullPointer(&quot;/nestedBean[@name='foo'][3]&quot;,</span>
<span class="fc" id="L420">                &quot;/nestedBean[@name='foo'][3]&quot;,</span>
<span class="fc" id="L421">                &quot;BbBn&quot;);</span>

        // existingProperty[@name=collectionProperty][missingIndex]
<span class="fc" id="L424">        assertNullPointer(&quot;/nestedBean[@name='strings'][5]&quot;,</span>
<span class="fc" id="L425">                &quot;/nestedBean/strings[5]&quot;,</span>
<span class="fc" id="L426">                &quot;BbBbE&quot;);</span>

        // map[@name=collectionProperty][index]
<span class="fc" id="L429">        assertValueAndPointer(&quot;/map[@name='Key3'][2]&quot;,</span>
<span class="fc" id="L430">                new Integer(2),</span>
<span class="fc" id="L431">                &quot;/map[@name='Key3'][2]&quot;,</span>
<span class="fc" id="L432">                &quot;BbDd&quot;,</span>
<span class="fc" id="L433">                &quot;BbDdB&quot;);</span>

        // map[@name=collectionProperty][missingIndex]
<span class="fc" id="L436">        assertNullPointer(&quot;/map[@name='Key3'][5]&quot;,</span>
<span class="fc" id="L437">                &quot;/map[@name='Key3'][5]&quot;,</span>
<span class="fc" id="L438">                &quot;BbDdE&quot;);</span>

        // map[@name=collectionProperty][missingIndex]/property
<span class="fc" id="L441">        assertNullPointer(&quot;/map[@name='Key3'][5]/foo&quot;,</span>
<span class="fc" id="L442">                &quot;/map[@name='Key3'][5]/foo&quot;,</span>
<span class="fc" id="L443">                &quot;BbDdENn&quot;);</span>

        // map[@name=map][@name=collection][index]
<span class="fc" id="L446">        assertValueAndPointer(&quot;/map[@name='Key5'][@name='strings'][2]&quot;,</span>
<span class="fc" id="L447">                &quot;String 2&quot;,</span>
<span class="fc" id="L448">                &quot;/map[@name='Key5'][@name='strings'][2]&quot;,</span>
<span class="fc" id="L449">                &quot;BbDdDd&quot;,</span>
<span class="fc" id="L450">                &quot;BbDdDdB&quot;);</span>

        // map[@name=map][@name=collection][missingIndex]
<span class="fc" id="L453">        assertNullPointer(&quot;/map[@name='Key5'][@name='strings'][5]&quot;,</span>
<span class="fc" id="L454">                &quot;/map[@name='Key5'][@name='strings'][5]&quot;,</span>
<span class="fc" id="L455">                &quot;BbDdDdE&quot;);</span>

        // Existing dynamic property + indexing
<span class="fc" id="L458">        assertValueAndPointer(&quot;/map[@name='Key3'][2]&quot;,</span>
<span class="fc" id="L459">                new Integer(2),</span>
<span class="fc" id="L460">                &quot;/map[@name='Key3'][2]&quot;,</span>
<span class="fc" id="L461">                &quot;BbDd&quot;,</span>
<span class="fc" id="L462">                &quot;BbDdB&quot;);</span>

        // Existing dynamic property + indexing
<span class="fc" id="L465">        assertValueAndPointer(&quot;/map[@name='Key3'][1]/name&quot;,</span>
<span class="fc" id="L466">                &quot;some&quot;,</span>
<span class="fc" id="L467">                &quot;/map[@name='Key3'][1]/name&quot;,</span>
<span class="fc" id="L468">                &quot;BbDdBb&quot;,</span>
<span class="fc" id="L469">                &quot;BbDdBbB&quot;);</span>

        // map[@name=missingProperty][index]
<span class="fc" id="L472">        assertNullPointer(&quot;/map[@name='foo'][3]&quot;,</span>
<span class="fc" id="L473">                &quot;/map[@name='foo'][3]&quot;,</span>
<span class="fc" id="L474">                &quot;BbDdE&quot;);</span>

        // collectionProperty[index]
<span class="fc" id="L477">        assertValueAndPointer(&quot;/integers[2]&quot;,</span>
<span class="fc" id="L478">                new Integer(2),</span>
<span class="fc" id="L479">                &quot;/integers[2]&quot;,</span>
<span class="fc" id="L480">                &quot;Bb&quot;,</span>
<span class="fc" id="L481">                &quot;BbB&quot;);</span>

        // existingProperty/collectionProperty[index]
<span class="fc" id="L484">        assertValueAndPointer(&quot;/nestedBean/strings[2]&quot;,</span>
<span class="fc" id="L485">                bean.getNestedBean().getStrings()[1],</span>
<span class="fc" id="L486">                &quot;/nestedBean/strings[2]&quot;,</span>
<span class="fc" id="L487">                &quot;BbBb&quot;,</span>
<span class="fc" id="L488">                &quot;BbBbB&quot;);</span>

        // existingProperty[index]/existingProperty
<span class="fc" id="L491">        assertValueAndPointer(&quot;/list[3]/int&quot;,</span>
<span class="fc" id="L492">                new Integer(1),</span>
<span class="fc" id="L493">                &quot;/list[3]/int&quot;,</span>
<span class="fc" id="L494">                &quot;BbBb&quot;,</span>
<span class="fc" id="L495">                &quot;BbBbB&quot;);</span>

        // existingProperty[missingIndex]
<span class="fc" id="L498">        assertNullPointer(&quot;/list[6]&quot;,</span>
<span class="fc" id="L499">                &quot;/list[6]&quot;,</span>
<span class="fc" id="L500">                &quot;BbE&quot;);</span>

        // existingProperty/missingProperty[index]
<span class="fc" id="L503">        assertNullPointer(&quot;/nestedBean/foo[3]&quot;,</span>
<span class="fc" id="L504">                &quot;/nestedBean/foo[3]&quot;,</span>
<span class="fc" id="L505">                &quot;BbBn&quot;);</span>

        // map[@name=missingProperty][index]
<span class="fc" id="L508">        assertNullPointer(&quot;/map/foo[3]&quot;,</span>
<span class="fc" id="L509">                &quot;/map[@name='foo'][3]&quot;,</span>
<span class="fc" id="L510">                &quot;BbDdE&quot;);</span>

        // existingProperty/collectionProperty[missingIndex]
<span class="fc" id="L513">        assertNullPointer(&quot;/nestedBean/strings[5]&quot;,</span>
<span class="fc" id="L514">                &quot;/nestedBean/strings[5]&quot;,</span>
<span class="fc" id="L515">                &quot;BbBbE&quot;);</span>

        // map/collectionProperty[missingIndex]/property
<span class="fc" id="L518">        assertNullPointer(&quot;/map/Key3[5]/foo&quot;,</span>
<span class="fc" id="L519">                &quot;/map[@name='Key3'][5]/foo&quot;,</span>
<span class="fc" id="L520">                &quot;BbDdENn&quot;);</span>

        // map[@name=map]/collection[index]
<span class="fc" id="L523">        assertValueAndPointer(&quot;/map[@name='Key5']/strings[2]&quot;,</span>
<span class="fc" id="L524">                &quot;String 2&quot;,</span>
<span class="fc" id="L525">                &quot;/map[@name='Key5'][@name='strings'][2]&quot;,</span>
<span class="fc" id="L526">                &quot;BbDdDd&quot;,</span>
<span class="fc" id="L527">                &quot;BbDdDdB&quot;);</span>

        // map[@name=map]/collection[missingIndex]
<span class="fc" id="L530">        assertNullPointer(&quot;/map[@name='Key5']/strings[5]&quot;,</span>
<span class="fc" id="L531">                &quot;/map[@name='Key5'][@name='strings'][5]&quot;,</span>
<span class="fc" id="L532">                &quot;BbDdDdE&quot;);</span>

        // scalarPropertyAsCollection[index]
<span class="fc" id="L535">        assertValueAndPointer(&quot;/int[1]&quot;,</span>
<span class="fc" id="L536">                new Integer(1),</span>
<span class="fc" id="L537">                &quot;/int&quot;,</span>
<span class="fc" id="L538">                &quot;Bb&quot;,</span>
<span class="fc" id="L539">                &quot;BbB&quot;);</span>

        // scalarPropertyAsCollection[index]
<span class="fc" id="L542">        assertValueAndPointer(&quot;.[1]/int&quot;,</span>
<span class="fc" id="L543">                new Integer(1),</span>
<span class="fc" id="L544">                &quot;/int&quot;,</span>
<span class="fc" id="L545">                &quot;Bb&quot;,</span>
<span class="fc" id="L546">                &quot;BbB&quot;);</span>
<span class="fc" id="L547">    }</span>

    public void testInterpretExpressionPath() {
<span class="fc" id="L550">        context.getVariables().declareVariable(&quot;array&quot;, new String[]{&quot;Value1&quot;});</span>
<span class="fc" id="L551">        context.getVariables().declareVariable(&quot;testnull&quot;, new TestNull());</span>

<span class="fc" id="L553">        assertNullPointer(&quot;$testnull/nothing[2]&quot;,</span>
<span class="fc" id="L554">                &quot;$testnull/nothing[2]&quot;,</span>
<span class="fc" id="L555">                &quot;VBbE&quot;);</span>
<span class="fc" id="L556">    }</span>

    private void assertValueAndPointer(
            String path, Object expectedValue, String expectedPath,
            String expectedSignature)
    {
<span class="fc" id="L562">        assertValueAndPointer(</span>
<span class="fc" id="L563">            path,</span>
<span class="fc" id="L564">            expectedValue,</span>
<span class="fc" id="L565">            expectedPath,</span>
<span class="fc" id="L566">            expectedSignature,</span>
<span class="fc" id="L567">            expectedSignature);</span>
<span class="fc" id="L568">    }</span>
    
    private void assertValueAndPointer(
            String path, Object expectedValue, String expectedPath,
            String expectedSignature, String expectedValueSignature)
    {
<span class="fc" id="L574">        Object value = context.getValue(path);</span>
<span class="fc" id="L575">        assertEquals(&quot;Checking value: &quot; + path, expectedValue, value);</span>

<span class="fc" id="L577">        Pointer pointer = context.getPointer(path);</span>
<span class="fc" id="L578">        assertEquals(&quot;Checking pointer: &quot; + path,</span>
<span class="fc" id="L579">                expectedPath, pointer.toString());</span>

<span class="fc" id="L581">        assertEquals(&quot;Checking signature: &quot; + path,</span>
<span class="fc" id="L582">                expectedSignature, pointerSignature(pointer));</span>
        
<span class="fc" id="L584">        Pointer vPointer = ((NodePointer) pointer).getValuePointer();</span>
<span class="fc" id="L585">        assertEquals(&quot;Checking value pointer signature: &quot; + path,</span>
<span class="fc" id="L586">                expectedValueSignature, pointerSignature(vPointer));</span>
<span class="fc" id="L587">    }</span>

    private void assertNullPointer(String path, String expectedPath,
            String expectedSignature)
    {
<span class="fc" id="L592">        Pointer pointer = context.getPointer(path);</span>
<span class="fc" id="L593">        assertNotNull(&quot;Null path exists: &quot; + path,</span>
<span class="fc" id="L594">                    pointer);</span>
<span class="fc" id="L595">        assertEquals(&quot;Null path as path: &quot; + path,</span>
<span class="fc" id="L596">                    expectedPath, pointer.asPath());</span>
<span class="fc" id="L597">        assertEquals(&quot;Checking Signature: &quot; + path,</span>
<span class="fc" id="L598">                    expectedSignature, pointerSignature(pointer));</span>
                
<span class="fc" id="L600">        Pointer vPointer = ((NodePointer) pointer).getValuePointer();</span>
<span class="fc" id="L601">        assertTrue(&quot;Null path is null: &quot; + path,</span>
<span class="pc bpc" id="L602" title="1 of 2 branches missed.">                    !((NodePointer) vPointer).isActual());</span>
<span class="fc" id="L603">        assertEquals(&quot;Checking value pointer signature: &quot; + path,</span>
<span class="fc" id="L604">                    expectedSignature + &quot;N&quot;, pointerSignature(vPointer));</span>
<span class="fc" id="L605">    }</span>

    /**
     * Since we need to test the internal Signature of a pointer,
     * we will get a signature which will contain a single character
     * per pointer in the chain, representing that pointer's type.
     */
    private String pointerSignature(Pointer pointer) {
<span class="fc bfc" id="L613" title="All 2 branches covered.">        if (pointer == null) {</span>
<span class="fc" id="L614">            return &quot;&quot;;</span>
        }

<span class="fc" id="L617">        char type = '?';</span>
<span class="fc bfc" id="L618" title="All 2 branches covered.">        if (pointer instanceof NullPointer) {                 type = 'N'; }</span>
<span class="fc bfc" id="L619" title="All 2 branches covered.">        else if (pointer instanceof NullPropertyPointer) {    type = 'n'; }</span>
<span class="fc bfc" id="L620" title="All 2 branches covered.">        else if (pointer instanceof NullElementPointer) {     type = 'E'; }</span>
<span class="fc bfc" id="L621" title="All 2 branches covered.">        else if (pointer instanceof VariablePointer) {        type = 'V'; }</span>
<span class="fc bfc" id="L622" title="All 2 branches covered.">        else if (pointer instanceof CollectionPointer) {      type = 'C'; }</span>
<span class="fc bfc" id="L623" title="All 2 branches covered.">        else if (pointer instanceof BeanPointer) {            type = 'B'; }</span>
<span class="fc bfc" id="L624" title="All 2 branches covered.">        else if (pointer instanceof BeanPropertyPointer) {    type = 'b'; }</span>
<span class="fc bfc" id="L625" title="All 2 branches covered.">        else if (pointer instanceof DynamicPointer) {         type = 'D'; }</span>
<span class="fc bfc" id="L626" title="All 2 branches covered.">        else if (pointer instanceof DynamicPropertyPointer) { type = 'd'; }</span>
<span class="pc bpc" id="L627" title="1 of 2 branches missed.">        else if (pointer instanceof DOMNodePointer) {         type = 'M'; }</span>
        else {
<span class="nc" id="L629">            System.err.println(&quot;UNKNOWN TYPE: &quot; + pointer.getClass());</span>
        }
<span class="fc" id="L631">        NodePointer parent = </span>
<span class="fc" id="L632">            ((NodePointer) pointer).getImmediateParentPointer();</span>
<span class="fc" id="L633">        return pointerSignature(parent) + type;</span>
    }
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span>commons-jxpath (Jan 19, 2019 5:24:34 PM)</div></body></html>