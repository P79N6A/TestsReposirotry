<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../jacoco-resources/report.gif" type="image/gif"/><title>JXPathServletContextTest.java</title><link rel="stylesheet" href="../../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">commons-jxpath (Jan 19, 2019 5:24:34 PM)</a> &gt; <a href="../../index.html" class="el_group">commons-jxpath</a> &gt; <a href="../index.html" class="el_bundle">src/test</a> &gt; <a href="index.source.html" class="el_package">org.apache.commons.jxpath.servlet</a> &gt; <span class="el_source">JXPathServletContextTest.java</span></div><h1>JXPathServletContextTest.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.apache.commons.jxpath.servlet;

import java.util.Iterator;
import javax.servlet.ServletContext;

import org.apache.commons.jxpath.JXPathContext;
import org.apache.commons.jxpath.Pointer;
import org.apache.commons.jxpath.Variables;

import com.mockrunner.mock.web.MockHttpServletRequest;
import com.mockrunner.mock.web.MockHttpSession;
import com.mockrunner.mock.web.MockPageContext;
import com.mockrunner.mock.web.MockServletConfig;
import com.mockrunner.mock.web.MockServletContext;
import junit.framework.TestCase;

/**
 * @author Emmanuel Bourg
 * @version $Revision$, $Date$
 */
<span class="fc" id="L38">public class JXPathServletContextTest extends TestCase {</span>

    private ServletContext getServletContext() {
<span class="fc" id="L41">        MockServletContext context = new MockServletContext();</span>
<span class="fc" id="L42">        context.setAttribute(&quot;app&quot;, &quot;OK&quot;);</span>

<span class="fc" id="L44">        return context;</span>
    }
    
    public void testServletContext() {
<span class="fc" id="L48">        ServletContext context = getServletContext();</span>
<span class="fc" id="L49">        JXPathContext appContext = JXPathServletContexts.getApplicationContext(context);</span>

<span class="fc" id="L51">        assertSame(&quot;Cached context not property returned&quot;, appContext, JXPathServletContexts.getApplicationContext(context));</span>

<span class="fc" id="L53">        assertEquals(&quot;Application Context&quot;, &quot;OK&quot;, appContext.getValue(&quot;app&quot;));</span>

<span class="fc" id="L55">        checkPointerIterator(appContext);</span>

        // test setting a value in the context
<span class="fc" id="L58">        appContext.setValue(&quot;/foo&quot;, &quot;bar&quot;);</span>
<span class="fc" id="L59">        assertEquals(&quot;Context property&quot;, &quot;bar&quot;, appContext.getValue(&quot;/foo&quot;));</span>

        // test the variables
<span class="fc" id="L62">        Variables variables = appContext.getVariables();</span>
<span class="fc" id="L63">        assertNotNull(&quot;$application variable&quot;, variables.getVariable(&quot;application&quot;));</span>
<span class="fc" id="L64">        assertNull(&quot;$foo variable&quot;, variables.getVariable(&quot;$foo&quot;));</span>
<span class="fc" id="L65">    }</span>

    public void testServletRequest() {
<span class="fc" id="L68">        ServletContext context = getServletContext();</span>

<span class="fc" id="L70">        MockHttpSession session = new MockHttpSession();</span>
<span class="fc" id="L71">        session.setupServletContext(context);</span>
<span class="fc" id="L72">        session.setUpIsNew(true);</span>
<span class="fc" id="L73">        Integer count = new Integer(10);</span>
<span class="fc" id="L74">        session.setAttribute(&quot;count&quot;, count);</span>

<span class="fc" id="L76">        MockHttpServletRequest request = new MockHttpServletRequest();</span>
<span class="fc" id="L77">        request.setSession(session);</span>
<span class="fc" id="L78">        request.setAttribute(&quot;attr&quot;, &quot;OK&quot;);</span>
<span class="fc" id="L79">        request.setupAddParameter(&quot;parm&quot;, &quot;OK&quot;);</span>
<span class="fc" id="L80">        request.setupAddParameter(&quot;multiparam&quot;, new String[] { &quot;value1&quot;, &quot;value2&quot; });</span>
<span class="fc" id="L81">        request.setupAddParameter(&quot;emptyparam&quot;, new String[0]);</span>

<span class="fc" id="L83">        assertSame(&quot;Request session&quot;, session, request.getSession());</span>

<span class="fc" id="L85">        JXPathContext reqContext = JXPathServletContexts.getRequestContext(request, context);</span>

<span class="fc" id="L87">        assertSame(&quot;Cached context not property returned&quot;, reqContext, JXPathServletContexts.getRequestContext(request, context));</span>

<span class="fc" id="L89">        JXPathContext sessionContext = JXPathServletContexts.getSessionContext(session, context);</span>

<span class="fc" id="L91">        assertSame(&quot;Cached context not property returned&quot;, sessionContext, JXPathServletContexts.getSessionContext(session, context));</span>

<span class="fc" id="L93">        assertEquals(&quot;Request Context Attribute&quot;, &quot;OK&quot;, reqContext.getValue(&quot;attr&quot;));</span>

<span class="fc" id="L95">        assertEquals(&quot;Request Context Parameter&quot;, &quot;OK&quot;, reqContext.getValue(&quot;parm&quot;));</span>
<span class="fc" id="L96">        assertTrue(&quot;Request Context Parameter (Array)&quot;, reqContext.getValue(&quot;multiparam&quot;).getClass().isArray());</span>
<span class="fc" id="L97">        assertEquals(&quot;Request Context Parameter (Empty)&quot;, null, reqContext.getValue(&quot;emptyparam&quot;));</span>

<span class="fc" id="L99">        assertEquals(&quot;Session Context Parameter&quot;, count, sessionContext.getValue(&quot;count&quot;));</span>
<span class="fc" id="L100">        assertEquals(&quot;Application Context via Request Context&quot;, &quot;OK&quot;, reqContext.getValue(&quot;app&quot;));</span>
<span class="fc" id="L101">        assertEquals(&quot;Session Context via Request Context&quot;, count, reqContext.getValue(&quot;count&quot;));</span>
<span class="fc" id="L102">        assertEquals(&quot;Application Context via Session Context&quot;, &quot;OK&quot;, sessionContext.getValue(&quot;app&quot;));</span>

<span class="fc" id="L104">        checkPointerIterator(reqContext);</span>
<span class="fc" id="L105">        checkPointerIterator(sessionContext);</span>

        // test setting a value in the context
<span class="fc" id="L108">        reqContext.setValue(&quot;/foo1&quot;, &quot;bar1&quot;);</span>
<span class="fc" id="L109">        assertEquals(&quot;Context property&quot;, &quot;bar1&quot;, reqContext.getValue(&quot;/foo1&quot;));</span>

<span class="fc" id="L111">        sessionContext.setValue(&quot;/foo2&quot;, &quot;bar2&quot;);</span>
<span class="fc" id="L112">        assertEquals(&quot;Context property&quot;, &quot;bar2&quot;, sessionContext.getValue(&quot;/foo2&quot;));</span>
<span class="fc" id="L113">    }</span>

    public void testServletRequestWithoutSession() {
<span class="fc" id="L116">        ServletContext context = getServletContext();</span>

<span class="fc" id="L118">        MockHttpServletRequest request = new MockHttpServletRequest();</span>

<span class="fc" id="L120">        JXPathContext reqContext = JXPathServletContexts.getRequestContext(request, context);</span>

<span class="fc" id="L122">        assertEquals(&quot;Application Context via Request Context&quot;, &quot;OK&quot;, reqContext.getValue(&quot;app&quot;));</span>
<span class="fc" id="L123">    }</span>

    private void checkPointerIterator(JXPathContext context) {
<span class="fc" id="L126">        Iterator it = context.iteratePointers(&quot;/*&quot;);</span>
<span class="fc" id="L127">        assertTrue(&quot;Empty context&quot;, it.hasNext());</span>
<span class="fc bfc" id="L128" title="All 2 branches covered.">        while (it.hasNext())</span>
        {
<span class="fc" id="L130">            Pointer pointer = (Pointer) it.next();</span>
<span class="fc" id="L131">            assertNotNull(&quot;null pointer&quot;, pointer);</span>
<span class="fc" id="L132">            assertNotNull(&quot;null path&quot;, pointer.asPath());</span>
        }
<span class="fc" id="L134">    }</span>

    public void testPageContext() {
<span class="fc" id="L137">        MockServletContext servletContext = new MockServletContext();</span>
<span class="fc" id="L138">        servletContext.setAttribute(&quot;app&quot;, &quot;app&quot;);</span>

<span class="fc" id="L140">        MockServletConfig servletConfig = new MockServletConfig();</span>
<span class="fc" id="L141">        servletConfig.setServletContext(servletContext);</span>

<span class="fc" id="L143">        MockHttpSession session = new MockHttpSession();</span>
<span class="fc" id="L144">        session.setupServletContext(servletContext);</span>
<span class="fc" id="L145">        session.setAttribute(&quot;session&quot;, &quot;session&quot;);</span>

<span class="fc" id="L147">        MockHttpServletRequest request = new MockHttpServletRequest();</span>
<span class="fc" id="L148">        request.setAttribute(&quot;request&quot;, &quot;request&quot;);</span>
<span class="fc" id="L149">        request.setSession(session);</span>

<span class="fc" id="L151">        MockPageContext pageContext = new MockPageContext();</span>
<span class="fc" id="L152">        pageContext.setServletConfig(servletConfig);</span>
<span class="fc" id="L153">        pageContext.setServletRequest(request);</span>
<span class="fc" id="L154">        pageContext.setAttribute(&quot;page&quot;, &quot;page&quot;);</span>

<span class="fc" id="L156">        assertSame(&quot;Request session&quot;, session, request.getSession());</span>


<span class="fc" id="L159">        JXPathContext context = JXPathServletContexts.getPageContext(pageContext);</span>
<span class="fc" id="L160">        context.setLenient(true);</span>
        
<span class="fc" id="L162">        checkPointerIterator(context);</span>

<span class="fc" id="L164">        assertEquals(&quot;Page Scope&quot;, &quot;page&quot;, context.getValue(&quot;page&quot;));</span>
<span class="fc" id="L165">        assertEquals(&quot;Request Scope&quot;, &quot;request&quot;, context.getValue(&quot;request&quot;));</span>
<span class="fc" id="L166">        assertEquals(&quot;Session Scope&quot;, &quot;session&quot;, context.getValue(&quot;session&quot;));</span>
<span class="fc" id="L167">        assertEquals(&quot;Application Scope&quot;, &quot;app&quot;, context.getValue(&quot;app&quot;));</span>

<span class="fc" id="L169">        assertEquals(&quot;Explicit Page Scope&quot;, &quot;page&quot;, context.getValue(&quot;$page/page&quot;));</span>
<span class="fc" id="L170">        assertEquals(&quot;Explicit Request Scope&quot;, &quot;request&quot;, context.getValue(&quot;$request/request&quot;));</span>
<span class="fc" id="L171">        assertEquals(&quot;Explicit Session Scope&quot;, &quot;session&quot;, context.getValue(&quot;$session/session&quot;));</span>
<span class="fc" id="L172">        assertEquals(&quot;Explicit Application Scope&quot;, &quot;app&quot;, context.getValue(&quot;$application/app&quot;));</span>

        // iterate through the elements of page context only (two elements expected, 'page' and the context)
<span class="fc" id="L175">        Iterator it = context.iteratePointers(&quot;$page/*&quot;);</span>
<span class="fc" id="L176">        assertTrue(&quot;element not found&quot;, it.hasNext());</span>
<span class="fc" id="L177">        it.next();</span>
<span class="fc" id="L178">        it.next();</span>
<span class="fc" id="L179">        assertFalse(&quot;too many elements&quot;, it.hasNext());</span>

        // test setting a value in the context
<span class="fc" id="L182">        context.setValue(&quot;/foo1&quot;, &quot;bar1&quot;);</span>
<span class="fc" id="L183">        assertEquals(&quot;Context property&quot;, &quot;bar1&quot;, context.getValue(&quot;/foo1&quot;));</span>

<span class="fc" id="L185">        context.setValue(&quot;$page/foo2&quot;, &quot;bar2&quot;);</span>
<span class="fc" id="L186">        assertEquals(&quot;Context property&quot;, &quot;bar2&quot;, context.getValue(&quot;$page/foo2&quot;));</span>
<span class="fc" id="L187">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span>commons-jxpath (Jan 19, 2019 5:24:34 PM)</div></body></html>